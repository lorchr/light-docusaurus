<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-zh-cn/others/Prometheus-Grafana-System-Monitor" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">相关链接 | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/docs/zh-cn/others/Prometheus-Grafana-System-Monitor/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="相关链接 | Light Docusaurus"><meta data-rh="true" name="description" content="- Prometheus 官网文档"><meta data-rh="true" property="og:description" content="- Prometheus 官网文档"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/docs/zh-cn/others/Prometheus-Grafana-System-Monitor/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/docs/zh-cn/others/Prometheus-Grafana-System-Monitor/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/docs/zh-cn/others/Prometheus-Grafana-System-Monitor/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Light Docusaurus Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e8086d6f.css">
<script src="/assets/js/runtime~main.2519630d.js" defer="defer"></script>
<script src="/assets/js/main.a410c441.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/electron/">Electron</a><a class="navbar__item navbar__link" href="/postman/">Postman</a><a class="navbar__item navbar__link" href="/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/zh-cn/others/Prometheus-Grafana-System-Monitor/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/guide/">Guide</a><button aria-label="展开侧边栏分类 &#x27;Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/develop-environment/">Develop Environment</a><button aria-label="展开侧边栏分类 &#x27;Develop Environment&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-jvm/">Java (JVM)</a><button aria-label="展开侧边栏分类 &#x27;Java (JVM)&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-boot/">Spring Boot</a><button aria-label="展开侧边栏分类 &#x27;Spring Boot&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-cloud/">Spring Cloud</a><button aria-label="展开侧边栏分类 &#x27;Spring Cloud&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-security/">Spring Security</a><button aria-label="展开侧边栏分类 &#x27;Spring Security&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-authorization-server/">Spring Authorization Server</a><button aria-label="展开侧边栏分类 &#x27;Spring Authorization Server&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/active-directory/">Active Directory</a><button aria-label="展开侧边栏分类 &#x27;Active Directory&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/database/">Database</a><button aria-label="展开侧边栏分类 &#x27;Database&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/git/">Git</a><button aria-label="展开侧边栏分类 &#x27;Git&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/linux/">Linux</a><button aria-label="展开侧边栏分类 &#x27;Linux&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/docker/">Docker</a><button aria-label="展开侧边栏分类 &#x27;Docker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kubernetes/">Kubernetes</a><button aria-label="展开侧边栏分类 &#x27;Kubernetes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/test/">Test</a><button aria-label="展开侧边栏分类 &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/others/">Others</a><button aria-label="折叠侧边栏分类 &#x27;Others&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/others/Apply-EDU-Email/">Apply-EDU-Email</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/others/Product-Env-Error-Fix/">Product-Env-Error-Fix</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/others/Install-Program-As-Windows-Service/">Install-Program-As-Windows-Service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/others/LPG-Log-Collect/">LPG-Log-Collect</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/zh-cn/others/Prometheus-Grafana-System-Monitor/">相关链接</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect/">介绍</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/zh-cn/awesome-open-source/">Github Speed UP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/zh-cn/windows/">Windows</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/others/"><span itemprop="name">Others</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">相关链接</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>相关链接</h1></header>
<ul>
<li>
<p><a href="https://prometheus.io/docs/introduction/overview/" target="_blank" rel="noopener noreferrer">Prometheus 官网文档</a></p>
</li>
<li>
<p><a href="https://prometheus.io/download/" target="_blank" rel="noopener noreferrer">Prometheus   下载</a></p>
</li>
<li>
<p><a href="https://prometheus.io/docs/prometheus/latest/querying/examples/" target="_blank" rel="noopener noreferrer">PromQL 学习</a></p>
</li>
<li>
<p><a href="https://prometheus-operator.dev/" target="_blank" rel="noopener noreferrer">Prometheus Operator 文档</a></p>
</li>
<li>
<p><a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noopener noreferrer">Prometheus Operator Github</a></p>
</li>
<li>
<p><a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener noreferrer">Prometheus 社区Exporter组件</a></p>
</li>
<li></li>
<li>
<p><a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener noreferrer">Grafana官方监控面板</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/1860-node-exporter-full/" target="_blank" rel="noopener noreferrer">监控面板-服务器节点信息</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/6417-kubernetes-cluster-prometheus/" target="_blank" rel="noopener noreferrer">监控面板-K8s集群</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/8171-kubernetes-nodes/" target="_blank" rel="noopener noreferrer">监控面板-K8s节点</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/15759-kubernetes-views-nodes/" target="_blank" rel="noopener noreferrer">监控面板-节点视图的K8s集群</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/12856-jvm-micrometer/" target="_blank" rel="noopener noreferrer">监控面板-JVM监控大盘</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/10280-microservices-spring-boot-2-1/" target="_blank" rel="noopener noreferrer">监控面板-Spring Boot 2.x应用</a></p>
</li>
<li>
<p><a href="https://grafana.com/grafana/dashboards/19004-spring-boot-statistics/" target="_blank" rel="noopener noreferrer">监控面板-Spring Boot 3.x应用</a></p>
</li>
<li></li>
<li>
<p><a href="https://developer.aliyun.com/article/935461" target="_blank" rel="noopener noreferrer">使用 Docker 部署 Prometheus + Grafana 监控平台</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/yygabcd/article/details/147677521" target="_blank" rel="noopener noreferrer">【使用docker-compose方式部署Prometheus+Grafana】</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7354929098099146764" target="_blank" rel="noopener noreferrer">【Monitoring】Prometheus工作原理以及Prometheus架构介绍</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/ce1e90dbd5ba" target="_blank" rel="noopener noreferrer">【k8s学习】Kubernetes Operator简单介绍</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7356906581780742185" target="_blank" rel="noopener noreferrer">【Monitoring】使用Helm和Prometheus Operator在Kubernetes中安装Prometheus</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7357144204243976233" target="_blank" rel="noopener noreferrer">【Monitoring】在Kubernetes中Spring Boot集成Prometheus和Grafana</a></p>
</li>
<li>
<p><a href="https://developer.aliyun.com/article/836300" target="_blank" rel="noopener noreferrer">使用 Prometheus + Grafana 监控 k8s 上的 Spring Boot 应用</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/weixin_46619605/article/details/147603418" target="_blank" rel="noopener noreferrer">Spring Boot × K8s 监控实战-集成 Prometheus 与 Grafana</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7326355171901554723" target="_blank" rel="noopener noreferrer">如何使用 Helm 在 K8s 上集成 Prometheus 和 Grafana｜Part 3</a></p>
</li>
<li>
<p><a href="https://www.imooc.com/article/371443" target="_blank" rel="noopener noreferrer">Prometheus如何与Spring Boot集成实现监控、告警和日志功能</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/wxwbblog/p/18185045" target="_blank" rel="noopener noreferrer">部署Prometheus Operator完整流程及踩坑解决思路</a></p>
</li>
</ul>
<h1>整体架构</h1>
<p>Prometheus是一款用来做监控和预警的开  源的项目，最早是SoundCloud公司的项目，始于2012年。Prometheus不仅可以工作在传统的模式上（即部署在服务器），也可以工作在容器应用中，如Kubernetes。</p>
<p>下面是官方发布的系统架构图</p>
<p><img decoding="async" loading="lazy" alt="系统架构" src="/assets/images/architecture-07dae0368284dbd148521906c003ca15.svg" width="1351" height="811" class="img_ev3q"></p>
<p>从架构图可以看出，Prometheus Server主要由三个部分组成：</p>
<ul>
<li><strong>数据的拉取（Retrieval）</strong>：从应用中（或是其它目标服务器）拉取metrics数据，然后存入到它自己的数据库中。</li>
<li><strong>存储（Storage）</strong>：主要用来存储metrics（指标相关）数据，是基于时间序列的数据库(TSDB 即 Time Series DataBase)。</li>
<li><strong>Web服务（HTTP Server）</strong>：使用<code>PromQL</code>，从它自己的数据库中检索数据，入口可以是Promethous Web UI或是其它的UI展示平台如Grafana。</li>
</ul>
<p>过去几年，在容器端，Prometheus作为Monitoring工具尤其重要。原因是容器化的服务使得DevOps工作变得复杂，假设我们有很多很多个pod运行在多个Prod clusters上，那么这些pod的健康情况的监控就显得很重要，如：有没有出现响应延迟，负载过重，资源不足，出现了Error等等。</p>
<p>具体举例，如Prod上的某个pod的out of memory错误，间接的导致了数据库的两个pod出问题了，然后这两个db pod为用户登陆验证提供服务，那么从而使得用户在UI上无法登陆，在这种情况下，我们需要快速定位哪里出了问题？但问题的关键是如果我们有监控系统，那么就可以快速知道哪些pod是不健康的，甚至如果有某种预警系统，当某个pod快出现资源枯竭的问题时，就可以先发出警报（预警功能）。</p>
<h1>环境准备</h1>
<table><thead><tr><th>名称</th><th>IP</th><th>服务</th></tr></thead><tbody><tr><td>日志服务器</td><td>192.168.137.121</td><td>Grafana + Loki</td></tr><tr><td>应用服务器</td><td>192.168.137.122</td><td></td></tr><tr><td>应用服务器</td><td>192.168.137.123</td><td></td></tr><tr><td>应用服务器</td><td>192.168.137.131</td><td></td></tr><tr><td>应用服务器</td><td>192.168.137.132</td><td>Spring Boot Service + Nginx  + Promtail</td></tr><tr><td>应用服务器</td><td>192.168.137.133</td><td></td></tr></tbody></table>
<table><thead><tr><th>应用</th><th>版本</th></tr></thead><tbody><tr><td>Loki</td><td>3.5.1</td></tr><tr><td>Promtail</td><td>3.5.1</td></tr><tr><td>Grafana</td><td>12.0.1</td></tr><tr><td>Grafana-Enterprise</td><td>12.0.1</td></tr><tr><td>Prometheus</td><td>3.4.1</td></tr></tbody></table>
<h1>二进制安装</h1>
<ul>
<li><a href="https://prometheus.io/download/" target="_blank" rel="noopener noreferrer">Prometheus及组件下载地址</a>
更多组件可以查询<a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener noreferrer">Prometheus 社区Exporter组件</a>，所有的官方组件及部分高质量的社区组件都有罗列，基本可以涵盖主流的服务器、操作系统、中间件监控指标的采集推送</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="下载安装包">下载安装包<a href="#下载安装包" class="hash-link" aria-label="下载安装包的直接链接" title="下载安装包的直接链接">​</a></h2>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/prometheus/prometheus/releases/download/v3.4.1/prometheus-3.4.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/prometheus/alertmanager/releases/download/v0.28.1/alertmanager-0.28.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/prometheus/node_exporter/releases/download/v1.9.1/node_exporter-1.9.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-prometheus">安装 Prometheus<a href="#安装-prometheus" class="hash-link" aria-label="安装 Prometheus的直接链接" title="安装 Prometheus的直接链接">​</a></h2>
<ol>
<li>解压</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf prometheus-3.4.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd prometheus-3.4.1.linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./prometheus --config.file=&quot;prometheus.yml&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>配置文件 <code>prometheus.yml</code></li>
</ol>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># my global config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 15s </span><span class="token comment" style="color:#999988;font-style:italic"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">evaluation_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 15s </span><span class="token comment" style="color:#999988;font-style:italic"># Evaluate rules every 15 seconds. The default is every 1 minute.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># scrape_timeout is set to the global default (10s).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Alertmanager configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">alerting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">alertmanagers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># - alertmanager:9093</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rule_files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># - &quot;first_rules.yml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># - &quot;second_rules.yml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># A scrape configuration containing exactly one endpoint to scrape:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Here it&#x27;s Prometheus itself.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># metrics_path defaults to &#x27;/metrics&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># scheme defaults to &#x27;http&#x27;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;localhost:9090&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># The label name is added as a label `label_name=&lt;label_value&gt;` to any timeseries scraped from this config.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>启停脚本</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; startup.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup ./prometheus --config.file=&quot;prometheus.yml&quot; &gt;./prometheus.log 2&gt;&amp;1 &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;$!&quot; &gt; pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; shutdown.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `cat pid`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;关闭成功!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 脚本添加执行权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x startup.sh shutdown.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-alertmanager">安装 AlertManager<a href="#安装-alertmanager" class="hash-link" aria-label="安装 AlertManager的直接链接" title="安装 AlertManager的直接链接">​</a></h2>
<ol>
<li>解压</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf alertmanager-0.28.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd alertmanager-0.28.1.linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./alertmanager --config.file=&quot;alertmanager.yml&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>配置文件 <code>alertmanager.yml</code></li>
</ol>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">group_by</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;alertname&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">group_wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">group_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repeat_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">receiver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;web.hook&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">receivers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;web.hook&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">webhook_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:5001/&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">inhibit_rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">severity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;critical&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">target_match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">severity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;warning&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;alertname&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;dev&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;instance&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>启停脚本</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; startup.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup ./alertmanager --config.file=&quot;alertmanager.yml&quot; &gt;./alertmanager.log 2&gt;&amp;1 &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;$!&quot; &gt; pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; shutdown.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `cat pid`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;关闭成功!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 脚本添加执行权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x startup.sh shutdown.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-node-exporter">安装 Node Exporter<a href="#安装-node-exporter" class="hash-link" aria-label="安装 Node Exporter的直接链接" title="安装 Node Exporter的直接链接">​</a></h2>
<ol>
<li>解压</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 解  压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf node_exporter-1.9.1.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd node_exporter-1.9.1.linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./node_exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>启停脚本</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; startup.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup ./node_exporter &gt;./node_exporter.log 2&gt;&amp;1 &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;$!&quot; &gt; pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; shutdown.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `cat pid`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;关闭成功!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 脚本添加执行权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x startup.sh shutdown.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="访问测试">访问测试<a href="#访问测试" class="hash-link" aria-label="访问测试的直接链接" title="访问测试的直接链接">​</a></h2>
<ul>
<li>浏览器访问Prometheus监控指标页面<!-- -->
<ul>
<li>Prometheus 主界面 <code>http://192.168.137.122:9090</code></li>
<li>Prometheus 自身指标 <code>http://192.168.137.122:9090/metrics</code></li>
</ul>
</li>
<li>浏览器访问 NodeExporter 采集指标页面<!-- -->
<ul>
<li>NodeExporter 采集指标 <code>http://192.168.137.122:9100/metrics</code></li>
</ul>
</li>
</ul>
<h1>Docker安装</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="下载镜像">下载镜像<a href="#下载镜像" class="hash-link" aria-label="下载镜像的直接链接" title="下载镜像的直接链接">​</a></h2>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 拉取镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull prom/prometheus:v3.4.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull prom/alertmanager:v0.28.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull prom/node-exporter:v1.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导出镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save -o prom_prometheus_v3.4.1.tar prom/prometheus:v3.4.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save -o prom_alertmanager_v0.28.1.tar prom/alertmanager:v0.28.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save -o prom_node-exporter_v1.9.1.tar prom/node-exporter:v1.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导入镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker load -i prom_prometheus_v3.4.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker load -i prom_alertmanager_v0.28.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker load -i prom_node-exporter_v1.9.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="初始化配置">初始化配置<a href="#初始化配置" class="hash-link" aria-label="初始化配置的直接链接" title="初始化配置的直接链接">​</a></h2>
<p>可以在官方代码仓库找到一些配置示例文件 <a href="https://github.com/prometheus/prometheus/blob/main/documentation/examples/prometheus-docker.yml" target="_blank" rel="noopener noreferrer">prometheus documentation examples</a></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mkdir -p /etc/{prometheus,alertmanager}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prometheus文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo vim /etc/prometheus/prometheus.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 告警规则文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo vim /etc/prometheus/rules.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 告警配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo vim /etc/alertmanager/alertmanager.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询当前用户的uid gid，防止挂载目录时容器无权限写入某些目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id -u $USER  # 显示UID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id -g $USER  # 显示GID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Prometheus文件  <code>prometheus.yaml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 全局配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 15s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">evaluation_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 15s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># scrape_timeout is set to the global default (10s).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 告警配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">alerting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">alertmanagers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;alertmanager:9093&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载一次规则，并根据全局“评估间隔”定期评估它们。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rule_files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/etc/prometheus/rules.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 控制Prometheus监视哪些资源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 默认配置中，有一个名为prometheus的作业，它会收集Prometheus服务器公开的时间序列数据。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 作业名称将作为标签“job=&lt;job_name&gt;`添加到此配置中获取的任何数据。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prometheus&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;localhost:9090&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;node&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;localhost:9100&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;linux&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;192.168.137.122:9100&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>告警规则文件 <code>rules.yaml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Alert for any instance that is unreachable for &gt; 5 minutes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">alert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstanceDown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">expr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> up == 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">for</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serverity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> page</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">summary</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Instance {{ $labels.instance }} down&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>AlertManager告警配置文件 <code>alertmanager.yml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resolve_timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">smtp_smarthost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;smtp.qiye.aliyun.com:465&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">smtp_from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hliu@pisx.com&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">smtp_auth_username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hliu@pisx.com&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">smtp_auth_password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Liuhui1993&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">smtp_require_tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">group_by</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;alertname&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">group_wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">group_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repeat_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">receiver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test-mails&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">receivers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test-mails&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">email_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hliu@pisx.com&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署prometheus-grafana">部署Prometheus Grafana<a href="#部署prometheus-grafana" class="hash-link" aria-label="部署Prometheus Grafana的直接链接" title="部署Prometheus Grafana的直接链接">​</a></h2>
<p>Docker Compose文件 <code>docker-compose.yaml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># image: docker.io/prom/prometheus:v3.4.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/prometheus/prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v3.4.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./prometheus/config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./prometheus/data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--config.file=/etc/prometheus/prometheus.yaml&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--storage.tsdb.path=/prometheus&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--web.console.libraries=/usr/share/prometheus/console_libraries&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--web.console.templates=/usr/share/prometheus/consoles&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--web.external-url=http://192.168.137.122:9090/&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--web.enable-lifecycle&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9090</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 添加用户权限配置，替换为宿主机用户UID:GID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1000:1000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">alertmanager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># image: docker.io/prom/alertmanager:v0.28.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/prometheus/alertmanager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.28.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9093</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9093</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./alertmanager/config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./alertmanager/data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--config.file=/etc/alertmanager/alertmanager.yaml&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--storage.path=/alertmanager&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 添加用户权限配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1000:1000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">node-exporter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># image: docker.io/prom/node-exporter:v1.9.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/prometheus/node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v1.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9100</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /proc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/host/proc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /sys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/host/sys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">rslave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--path.rootfs=/host&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># node-exporter需要特殊权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privileged</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">grafana</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana/grafana</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">12.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 3000</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./grafana/provisioning</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/grafana/provisioning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./grafana/data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/var/lib/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> GF_INSTALL_PLUGINS=camptocamp</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alertmanager</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">datasource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 添加Grafana权限配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> GF_PATHS_PLUGINS=/var/lib/grafana/plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> GF_PATHS_DATA=/var/lib/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> GF_PATHS_LOGS=/var/log/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 添加用户权限配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1000:1000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启停指令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker compose -f docker-compose.yaml up -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker container ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker logs prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker compose -f docker-compose.yaml down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>浏览器访问Prometheus监控指标页面<!-- -->
<ul>
<li>Prometheus 主界面 <code>http://192.168.137.122:9090</code></li>
<li>Prometheus 自身指标 <code>http://192.168.137.122:9090/metrics</code></li>
</ul>
</li>
<li>浏览器访问 NodeExporter 采集指标页面<!-- -->
<ul>
<li>NodeExporter 采集指标 <code>http://192.168.137.122:9100/metrics</code></li>
</ul>
</li>
<li>浏览器访问Grafana页面<!-- -->
<ul>
<li>Grafana 主界面 <code>http://192.168.137.122:3000</code></li>
<li><code>admin</code> / <code>admin</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a href="#测试" class="hash-link" aria-label="测试的直接链接" title="测试的直接链接">​</a></h2>
<ol>
<li>
<p>打开 Prometheus 主界面 <code>http://192.168.137.122:9090</code>
<img decoding="async" loading="lazy" src="/assets/images/prometheusWebUI-d1e1b884aa7c472dbd5dee9b523ef215.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>打开 Prometheus 自身指标页面 <code>http://192.168.137.122:9090/metrics</code>
<img decoding="async" loading="lazy" src="/assets/images/prometheus自身指标-fa88bc5cfe41ab9f17b2e50256072c9a.png" width="1900" height="971" class="img_ev3q"></p>
</li>
<li>
<p>打开 NodeExporter 采集指标页面 <code>http://192.168.137.122:9100/metrics</code>
<img decoding="async" loading="lazy" src="/assets/images/服务器指标-9a929449b1d9ca812747eb39c2185596.png" width="1910" height="971" class="img_ev3q"></p>
</li>
<li>
<p>打开 Grafana 主界面 <code>http://192.168.137.122:3000</code>，在数据源中添加 Prometheus 和 AlertManager数据源
<img decoding="async" loading="lazy" src="/assets/images/Grafana添加Prometheus数据源-fd85a2b0b3b9095a473d497a28125877.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/Grafana添加AlertManager数据源-06ac937875cd895fd344f073e12277f3.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>从Grafana官方提供模板地址下载监控面板模板: <code>https://grafana.com/grafana/dashboards</code>
<img decoding="async" loading="lazy" src="/assets/images/官方提供的监控面板-828d24b3555b02ec089018e9f6ca720d.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/下载面板定义JSON-36508fd43b7ebd22b3d5d97f434b3417.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/导入下载的json文件-2d55b872d7c6bff3c45407029fec7071.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/导入时需要选择数据源-88716082c5947662fe78fb7f82a926c4.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>服务器监控效果展示
<img decoding="async" loading="lazy" src="/assets/images/服务器监控效果展示-8b94114c5b16f1ed2a173f4f6cfed6f5.png" width="1920" height="922" class="img_ev3q"></p>
</li>
</ol>
<h1>Kubernetes安装</h1>
<p>这里将采用 Helm chart 来安装 Prometheus Operator，因为Operator可以帮助我们布署、管理、恢复Prometheus（因为Prometheus是有状态的应用，不同于无状态的Java项目（Kubernetes可以自动化管理无状态应用），有状态的应用运维比较麻烦，所以需要特定的Operator来管理。具体可以看文章开头的前置文章。</p>
<ul>
<li><a href="https://juejin.cn/post/7356906581780742185" target="_blank" rel="noopener noreferrer">【Monitoring】使用Helm和Prometheus Operator在Kubernetes中安装Prometheus</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="添加prometheus-chart到helm">添加Prometheus Chart到Helm<a href="#添加prometheus-chart到helm" class="hash-link" aria-label="添加Prometheus Chart到Helm的直接链接" title="添加Prometheus Chart到Helm的直接链接">​</a></h2>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看helm版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果添加仓库失败可以添加代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export http_proxy=http://192.168.137.1:4780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export https_proxy=http://192.168.137.1:4780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 添加chart仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 更新chart仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看添加完成后的仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询prometheus的chart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm search repo prometheus-community/kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 拉取chart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm pull prometheus-community/kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 拉取较慢，可以直接从github下载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># wget https://github.com/prometheus-community/helm-charts/releases/download/kube-prometheus-stack-73.2.0/kube-prometheus-stack-73.2.0.tgz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时会有一个压缩包，默认下载的是最新版本，可能与Grafana版本不兼容，需要去github确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf kube-prometheus-stack-73.2.0.tgz -C ~/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 进入到解压后的文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ~/kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看默认的配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装prometheus-operator">安装Prometheus Operator<a href="#安装prometheus-operator" class="hash-link" aria-label="安装Prometheus Operator的直接链接" title="安装Prometheus Operator的直接链接">​</a></h2>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装时需要从docker仓库拉取镜像，可以提前准备好</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/prometheus/prometheus:v3.4.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/prometheus/alertmanager:v0.28.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/prometheus/node-exporter:v1.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/prometheus-operator/admission-webhook:v0.82.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/prometheus-operator/prometheus-operator:v0.82.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/prometheus-operator/prometheus-config-reloader:v0.82.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull quay.io/thanos/thanos:v0.38.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.5.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.15.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># registry.k8s.io 拉取失败，使用代理拉取，拉取成功后重新打tag即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull k8s.mirror.nju.edu.cn/ingress-nginx/kube-webhook-certgen:v1.5.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker tag  k8s.mirror.nju.edu.cn/ingress-nginx/kube-webhook-certgen:v1.5.3 registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.5.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull k8s.mirror.nju.edu.cn/kube-state-metrics/kube-state-metrics:v2.15.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker tag  k8s.mirror.nju.edu.cn/kube-state-metrics/kube-state-metrics:v2.15.0 registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.15.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 拉取镜像较慢，可以设置本地代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HTTP_PROXY=http://192.168.137.1:4780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HTTPS_PROXY=http://192.168.137.1:4780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装prometheus，从服务器下载 kube-prometheus-stack-73.2.0.tgz 安装包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果想要修改部分配置，可以新增一个配置文件 prometheus-values.yaml，在install时带上参数即可 -f prometheus-values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># helm install prometheus prometheus-community/kube-prometheus-stack --create-namespace --namespace monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装prometheus，在 kube-prometheus-stack-73.2.0.tgz 解压目录执行，如有需要可以带上 -f prometheus-values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ~/kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheus . --create-namespace --namespace monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 升级</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade prometheus prometheus-community/kube-prometheus-stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Helm部署的资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm ls --namespace monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>部署成功后输出的提示信息如下</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 kube-prometheus-stack]$ helm install prometheus . --create-namespace --namespace monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Thu Jun 12 14:50:19 2025</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-prometheus-stack has been installed. Check its status by running:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace monitoring get pods -l &quot;release=prometheus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Get Grafana &#x27;admin&#x27; user password by running:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace monitoring get secrets prometheus-grafana -o jsonpath=&quot;{.data.admin-password}&quot; | base64 -d ; echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access Grafana local instance:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export POD_NAME=$(kubectl --namespace monitoring get pod -l &quot;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=prometheus&quot; -oname)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace monitoring port-forward $POD_NAME 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create &amp; configure Alertmanager and Prometheus instances using the Operator.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="检查prometheus-operator状态">检查Prometheus Operator状态<a href="#检查prometheus-operator状态" class="hash-link" aria-label="检查Prometheus Operator状态的直接链接" title="检查Prometheus Operator状态的直接链接">​</a></h2>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看 pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n monitoring -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看服务端口信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看节点Pending原因</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod alertmanager-prometheus-kube-prometheus-alertmanager-0 -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod prometheus-kube-prometheus-operator-5cfd684899-hdqf8 -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod prometheus-kube-state-metrics-74b7dc4795-sx7bv -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod prometheus-prometheus-kube-prometheus-prometheus-0 -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 卸载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm uninstall prometheus --namespace monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过 <code>kubectl get pods -n monitoring -o wide</code> 的输出确定pod的状态，并通过 <code>kubectl describe pod &lt;pod-name&gt; -n monitoring</code> 定位具体的失败原因</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 kube-prometheus-stack]$ kubectl get pods -n monitoring -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                     READY   STATUS        RESTARTS   AGE     IP                NODE            NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running       0          3m20s   10.244.44.211     k8s-node-02     &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-grafana-76cd8bb66b-gwwp8                      3/3     Running       0          3m23s   10.244.151.143    k8s-master-01   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-operator-5cfd684899-hdqf8     1/1     Running       0          3m23s   10.244.151.144    k8s-master-01   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-state-metrics-74b7dc4795-sx7bv           1/1     Running       0          3m23s   10.244.44.208     k8s-node-02     &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running       0          3m19s   10.244.95.47      k8s-master-02   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-9chcv                0/1     Pending       0          3m23s   &lt;none&gt;            &lt;none&gt;          &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-c7lhf                0/1     Terminating   0          18m     &lt;none&gt;            k8s-node-03     &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-dt8n4                0/1     Terminating   0          18m     &lt;none&gt;            k8s-master-03   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-jql69                0/1     Terminating   0          18m     &lt;none&gt;            k8s-node-01     &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-mv5t4                1/1     Running       0          3m23s   192.168.137.132   k8s-node-02     &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-n2bv8                0/1     Pending       0          3m23s   &lt;none&gt;            &lt;none&gt;          &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-r9sgg                1/1     Running       0          3m23s   192.168.137.121   k8s-master-01   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-vt6sg                0/1     Pending       0          3m23s   &lt;none&gt;            &lt;none&gt;          &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter-zcmql                1/1     Running       0          3m23s   192.168.137.122   k8s-master-02   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="访问prometheus-和-grafana-dashboards">访问Prometheus 和 Grafana Dashboards<a href="#访问prometheus-和-grafana-dashboards" class="hash-link" aria-label="访问Prometheus 和 Grafana Dashboards的直接链接" title="访问Prometheus 和 Grafana Dashboards的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="临时方案k8s-端口转发">临时方案，K8s 端口转发<a href="#临时方案k8s-端口转发" class="hash-link" aria-label="临时方案，K8s 端口转发的直接链接" title="临时方案，K8s 端口转发的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 先查看service的端 点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get service -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 然后使用port-forward进行转发以便kubernetes群体外可以访问内部的service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup kubectl port-forward --address 0.0.0.0 service/prometheus-kube-prometheus-prometheus -n monitoring 39090:9090 &gt; portforward-9090.log 2&gt;&amp;1 &lt; /dev/null &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup kubectl port-forward --address 0.0.0.0 service/prometheus-grafana -n monitoring 33000:80 &gt; portforward-3000.log 2&gt;&amp;1 &lt; /dev/null &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看访问端点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc -n monitoring | grep -E &#x27;prometheus-kube-prometheus-prometheus|prometheus-grafana&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>浏览器访问Prometheus监控指标页面</p>
<ul>
<li>Prometheus 主界面 <code>http://192.168.137.121:9090</code></li>
<li>Prometheus 自身指标 <code>http://192.168.137.121:9090/metrics</code></li>
</ul>
</li>
<li>
<p>浏览器访问Grafana页面</p>
<ul>
<li>Grafana 主界面 <code>http://192.168.137.121:3000</code></li>
<li>账号 <code>admin</code> / <code>prom-operator</code></li>
<li>密码 使用安装后的指令获取 <code>kubectl --namespace monitoring get secrets prometheus-grafana -o jsonpath=&quot;{.data.admin-password}&quot; | base64 -d ; echo</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-nodeport-暴露服务">使用 NodePort 暴露服务<a href="#使用-nodeport-暴露服务" class="hash-link" aria-label="使用 NodePort 暴露服务的直接链接" title="使用 NodePort 暴露服务的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 修改 Prometheus 服务为 NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch svc prometheus-kube-prometheus-prometheus -n monitoring -p &#x27;{&quot;spec&quot;: {&quot;type&quot;: &quot;NodePort&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 修改 Grafana 服务为 NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch svc prometheus-grafana -n monitoring -p &#x27;{&quot;spec&quot;: {&quot;type&quot;: &quot;NodePort&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. 获取实际端口号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 kube-prometheus-stack]$ kubectl get svc -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                         AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-operated                     ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP      55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-grafana                        NodePort    10.101.166.78    &lt;none&gt;        80:31145/TCP                    55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-alertmanager   ClusterIP   10.96.67.209     &lt;none&gt;        9093/TCP,8080/TCP               55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-operator       ClusterIP   10.99.164.53     &lt;none&gt;        443/TCP                         55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-prometheus     NodePort    10.101.131.197   &lt;none&gt;        9090:30203/TCP,8080:31517/TCP   55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-state-metrics             ClusterIP   10.108.139.180   &lt;none&gt;        8080/TCP                        55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-operated                       ClusterIP   None             &lt;none&gt;        9090/TCP                        55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter       ClusterIP   10.100.224.184   &lt;none&gt;        9100/TCP                        55m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取Grafana密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 查看命名空间内所有Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secrets -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 查看Secret内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secret prometheus-grafana -n monitoring -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. 复制admin-user admin-password，用base64 decode下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;YWRtaW4=&quot; | base64 -d; echo               # 账号 admin-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;cHJvbS1vcGVyYXRvcg==&quot; | base64 -d; echo   # 密码 admin-password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 一条指令获取用户名密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --namespace monitoring get secrets prometheus-grafana -o jsonpath=&quot;{.data.admin-user}&quot; | base64 -d ; echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --namespace monitoring get secrets prometheus-grafana -o jsonpath=&quot;{.data.admin-password}&quot; | base64 -d ; echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>浏览器访问Prometheus监控指标页面<!-- -->
<ul>
<li>Prometheus 主界面 <code>http://192.168.137.121:30203</code></li>
<li>Prometheus 自身指标 <code>http://192.168.137.121:30203/metrics</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试-1">测试<a href="#测试-1" class="hash-link" aria-label="测试的直接链接" title="测试的直接链接">​</a></h2>
<ol>
<li>
<p>访问 Prometheus 主界面
<img decoding="async" loading="lazy" src="/assets/images/NodePort1-bd925894f82147ecacf86cc07c4ca2c3.png" width="1921" height="980" class="img_ev3q"></p>
</li>
<li>
<p>访问 Prometheus 自身指标页面
<img decoding="async" loading="lazy" src="/assets/images/NodePort2-35cb5b638df3afe48bf93e9215f5f8f7.png" width="1905" height="975" class="img_ev3q"></p>
</li>
<li>
<p>在 <code>Status &gt; Configuration</code> 页签查看当前的prometheus.yaml
<img decoding="async" loading="lazy" src="/assets/images/NodePort3-11cd4d2a95705cc91b1d01a5d8737037.png" width="1916" height="980" class="img_ev3q"></p>
</li>
<li>
<p>在 <code>Status &gt; Target Health</code> 页签查看当前的Targets，即从哪里抓取数据
<img decoding="async" loading="lazy" src="/assets/images/NodePort4-d9eeaeb62672c8f5c3f5ab60f89e02de.png" width="1911" height="979" class="img_ev3q"></p>
</li>
<li>
<p>在 <code>Status &gt; Rule Health</code> 页签查看当前配置的规则
<img decoding="async" loading="lazy" src="/assets/images/NodePort5-bd121e86c8b607b1870cfbda5c368dc6.png" width="1915" height="982" class="img_ev3q"></p>
</li>
<li>
<p>访问 Grafana 主界面 <code>http://192.168.137.121:31145</code></p>
</li>
</ol>
<ul>
<li>账号 <code>admin</code> / <code>prom-operator</code> （密码需要读Secret文件获取）</li>
</ul>
<ol start="7">
<li>
<p>在Datasource页面可以看到默认将 Prometheus 及 AlertManger 添加进来了
<img decoding="async" loading="lazy" src="/assets/images/NodePort6-986d43ddf3ce98527f1da03de497a710.png" width="1914" height="965" class="img_ev3q"></p>
</li>
<li>
<p>切换到Dashboards菜单，可以看到默认prometheus会抓取kubenetes components的metrics如Pod等
<img decoding="async" loading="lazy" src="/assets/images/NodePort7-87d45ca866417948b44d2c21e67200d7.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>在 <code>Node Exporter / Nodes</code> 面板中可以看到服务器的相关信息
<img decoding="async" loading="lazy" src="/assets/images/NodePort8-17423865f3633a51bd83aa50e2096db7.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p> 在<code>Kubernetes / Kubelet</code> 可以看到K8s集群的整体统计信息
<img decoding="async" loading="lazy" src="/assets/images/NodePort9-b1c855deacbe684d8ef7347cdea7f45b.png" width="1920" height="922" class="img_ev3q"></p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="相关服务-资源的解析">相关服务 资源的解析<a href="#相关服务-资源的解析" class="hash-link" aria-label="相关服务 资源的解析的直接链接" title="相关服务 资源的解析的直接链接">​</a></h2>
<p>列出命名空间下的所有资源，包括：Pod，Service，Deployment等：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get all -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 ~]$  kubectl get all -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                         READY   STATUS    RESTARTS       AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running   2 (19h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-grafana-76cd8bb66b-gwwp8                      3/3     Running   9 (17h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-kube-prometheus-operator-5cfd684899-hdqf8     1/1     Running   3 (17h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-kube-state-metrics-74b7dc4795-sx7bv           1/1     Running   16 (65m ago)   20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running   6 (17h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-node-exporter-9chcv                1/1     Running   0              20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-node-exporter-mv5t4                1/1     Running   1 (19h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-node-exporter-n2bv8                1/1     Running   0              20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-node-exporter-r9sgg                1/1     Running   3 (17h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-node-exporter-vt6sg                1/1     Running   0              20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/prometheus-prometheus-node-exporter-zcmql                1/1     Running   5 (17h ago)    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                         AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/alertmanager-operated                     ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-grafana                        NodePort    10.101.166.78    &lt;none&gt;        80:31145/TCP                    20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-kube-prometheus-alertmanager   ClusterIP   10.96.67.209     &lt;none&gt;        9093/TCP,8080/TCP               20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-kube-prometheus-operator       ClusterIP   10.99.164.53     &lt;none&gt;        443/TCP                         20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-kube-prometheus-prometheus     NodePort    10.101.131.197   &lt;none&gt;        9090:30203/TCP,8080:31517/TCP   20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-kube-state-metrics             ClusterIP   10.108.139.180   &lt;none&gt;        8080/TCP                        20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-operated                       ClusterIP   None             &lt;none&gt;        9090/TCP                        20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/prometheus-prometheus-node-exporter       ClusterIP   10.100.224.184   &lt;none&gt;        9100/TCP                        20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/prometheus-prometheus-node-exporter   6         6         4       6            4           kubernetes.io/os=linux   20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                  READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/prometheus-grafana                    1/1     1            1           20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/prometheus-kube-prometheus-operator   1/1     1            1           20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/prometheus-kube-state-metrics         1/1     1            1           20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                             DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/prometheus-grafana-76cd8bb66b                    1         1         1       20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/prometheus-kube-prometheus-operator-5cfd684899   1         1         1       20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/prometheus-kube-state-metrics-74b7dc4795         1         1         1       20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                                    READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps/alertmanager-prometheus-kube-prometheus-alertmanager   1/1     20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps/prometheus-prometheus-kube-prometheus-prometheus       1/1     20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            STATUS   COMPLETIONS   DURATION   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job.batch/loki-minio-post-job   Failed   0/1           63m        63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 ~]$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="statefulsetdeploymentdaemonset">statefulset，deployment，daemonset<a href="#statefulsetdeploymentdaemonset" class="hash-link" aria-label="statefulset，deployment，daemonset的直接链接" title="statefulset，deployment，daemonset的直接链接">​</a></h3>
<p>其中statefulset资源有两个：</p>
<ul>
<li><code>statefulset.apps/prometheus-prometheus-kube-prometheus-prometheus</code>，是Prometheus三个server（即Retrival，Storage，HTTP Server），名字中间有operator，表示这个prometheus归operator管理。</li>
<li><code>statefulset.apps/alertmanager-prometheus-kube-prometheus-alertmanager</code>，顾名思议是alert manager，也是归operator管理。</li>
</ul>
<p>deployment三个：</p>
<ul>
<li><code>deployment.apps/prometheus-kube-prometheus-operator</code> prometheus operator自己的安装清单，通过它创建了Prometheus和Alertmanager的statefulset（也就是上面两个statefulset）。</li>
<li><code>deployment.apps/prometheus-grafana</code> grafana相关的安装清单，</li>
<li><code>deployment.apps/prometheus-kube-state-metrics</code> 当前这个Helm chart相关的，它用来抓取k8s当前的cluster本身component相关的metrics，用来测检当前deployment, statefulset, pod的是否健康，这些metrics数据可以在prometheus中被展示出来。</li>
</ul>
<p>Daemonset会在每个kubernetes的Worker节点上运行。当前的这个prometheus daemenset的作用是会把Worker节点上的数据（比如cpu使用率等）转化为Prometheus的metrics格式的数据。</p>
<p><strong>注：</strong> 这个Daemonset还需要和<code>pod=pod/prometheus-prometheus-node-exporter-9chcv</code>合作进行工作。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configmap-secret">configmap, secret<a href="#configmap-secret" class="hash-link" aria-label="configmap, secret的直接链接" title="configmap, secret的直接链接">​</a></h3>
<p>除了上述的资源，还安装了一些configmap，这些配置有些是operator相关的，配置了默认的metrics连接等等。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get configmap -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 ~]$ kubectl get configmap -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                           DATA   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-root-ca.crt                                               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-grafana                                             1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-grafana-config-dashboards                           1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-alertmanager-overview               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-apiserver                           1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-cluster-total                       1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-controller-manager                  1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-etcd                                1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-grafana-datasource                  1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-grafana-overview                    1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-coredns                         1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-cluster               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-multicluster          1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-namespace             1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-node                  1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-pod                   1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-workload              1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-k8s-resources-workloads-namespace   1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-kubelet                             1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-namespace-by-pod                    1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-namespace-by-workload               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-node-cluster-rsrc-use               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-node-rsrc-use                       1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-nodes                               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-nodes-aix                           1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-nodes-darwin                        1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-persistentvolumesusage              1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-pod-total                           1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-prometheus                          1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-proxy                               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-scheduler                           1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-workload-total                      1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-kube-prometheus-prometheus-rulefiles-0   35     20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>secrets相关的资源，存放Grafana, Prometheus, Operator相关的敏感数据（username, password等）：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secret -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 ~]$ kubectl get secret -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                                                  TYPE                 DATA   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-kube-prometheus-alertmanager                                  Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-kube-prometheus-alertmanager-cluster-tls-config               Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-kube-prometheus-alertmanager-generated                        Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-kube-prometheus-alertmanager-tls-assets-0                     Opaque               0      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager-prometheus-kube-prometheus-alertmanager-web-config                       Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-grafana                                                                    Opaque               3      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-admission                                                  Opaque               3      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-kube-prometheus-prometheus                                      Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-kube-prometheus-prometheus-thanos-prometheus-http-client-file   Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-kube-prometheus-prometheus-tls-assets-0                         Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-kube-prometheus-prometheus-web-config                           Opaque               1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sh.helm.release.v1.prometheus.v1                                                      helm.sh/release.v1   1      20h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="crds">CRDs<a href="#crds" class="hash-link" aria-label="CRDs的直接链接" title="CRDs的直接链接">​</a></h3>
<p>可以看到还创建了不少的CRD：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get crd -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 ~]$ kubectl get crd -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                  CREATED AT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanagerconfigs.monitoring.coreos.com             2025-06-10T06:50:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanagers.monitoring.coreos.com                   2025-06-10T06:50:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bgpconfigurations.crd.projectcalico.org               2025-04-01T02:59:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bgppeers.crd.projectcalico.org                        2025-04-01T02:59:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockaffinities.crd.projectcalico.org                 2025-04-01T02:59:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">caliconodestatuses.crd.projectcalico.org              2025-04-01T02:59:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephblockpoolradosnamespaces.ceph.rook.io             2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephblockpools.ceph.rook.io                           2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephbucketnotifications.ceph.rook.io                  2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephbuckettopics.ceph.rook.io                         2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephclients.ceph.rook.io                              2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephclusters.ceph.rook.io                             2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephcosidrivers.ceph.rook.io                          2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephfilesystemmirrors.ceph.rook.io                    2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephfilesystems.ceph.rook.io                          2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephfilesystemsubvolumegroups.ceph.rook.io            2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephnfses.ceph.rook.io                                2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephobjectrealms.ceph.rook.io                         2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephobjectstores.ceph.rook.io                         2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephobjectstoreusers.ceph.rook.io                     2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephobjectzonegroups.ceph.rook.io                     2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephobjectzones.ceph.rook.io                          2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cephrbdmirrors.ceph.rook.io                           2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterinformations.crd.projectcalico.org             2025-04-01T02:59:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">felixconfigurations.crd.projectcalico.org             2025-04-01T02:59:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">globalnetworkpolicies.crd.projectcalico.org           2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">globalnetworksets.crd.projectcalico.org               2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostendpoints.crd.projectcalico.org                   2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingressclassparameterses.configuration.konghq.com     2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipamblocks.crd.projectcalico.org                      2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipamconfigs.crd.projectcalico.org                     2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipamhandles.crd.projectcalico.org                     2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ippools.crd.projectcalico.org                         2025-04-01T02:59:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipreservations.crd.projectcalico.org                  2025-04-01T02:59:54Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongclusterplugins.configuration.konghq.com           2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongconsumergroups.configuration.konghq.com           2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongconsumers.configuration.konghq.com                2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongingresses.configuration.konghq.com                2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">konglicenses.configuration.konghq.com                 2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongplugins.configuration.konghq.com                  2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongupstreampolicies.configuration.konghq.com         2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kongvaults.configuration.konghq.com                   2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubecontrollersconfigurations.crd.projectcalico.org   2025-04-01T02:59:54Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">networkpolicies.crd.projectcalico.org                 2025-04-01T02:59:54Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">networksets.crd.projectcalico.org                     2025-04-01T02:59:54Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectbucketclaims.objectbucket.io                    2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectbuckets.objectbucket.io                         2025-06-04T07:20:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">podmonitors.monitoring.coreos.com                     2025-06-10T06:50:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">probes.monitoring.coreos.com                          2025-06-10T06:50:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheusagents.monitoring.coreos.com                2025-06-10T06:50:23Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheuses.monitoring.coreos.com                    2025-06-10T06:50:23Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheusrules.monitoring.coreos.com                 2025-06-10T06:50:23Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scrapeconfigs.monitoring.coreos.com                   2025-06-10T06:50:24Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">servicemonitors.monitoring.coreos.com                 2025-06-10T06:50:24Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpingresses.configuration.konghq.com                 2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thanosrulers.monitoring.coreos.com                    2025-06-10T06:50:24Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">udpingresses.configuration.konghq.com                 2025-04-01T03:08:43Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中<code>prometheuses.monitoring.coreos.com</code>与是<code>ServiceMonitor</code>定义的API，与Target自动发现有关。比如我们需要与Spring Boot项目集成，就可能需要创建自己的ServiceMonitor。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="查看prometheus配置">查看Prometheus配置<a href="#查看prometheus配置" class="hash-link" aria-label="查看Prometheus配置的直接链接" title="查看Prometheus配置的直接链接">​</a></h2>
<p>导出上述的statefulset的具体描述以及operator deployment的描述：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe statefulset prometheus-prometheus-kube-prometheus-prometheus -n monitoring &gt; prometheus.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>先看statefulset为prometheus的配置，可以看到使用的是v3.4.1版本的prometheus，端口为9090。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      quay.io/prometheus/prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v3.4.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">       9090/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>另外还有一些mount目录，比如在rules目录下有一些规则的文件：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Mounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/certs from tls</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">assets (ro)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/config_out from config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">out (ro)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/rules/prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rulefiles</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">0 from prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rulefiles</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">0 (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/web_config/web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config.yaml from web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config (ro</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">path=&quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config.yaml&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /prometheus from prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">db (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果prometheus相关的配置有改动，config-reloader负责重新加载这些config，可以看到config通过pod内的目录文件<code>/etc/prometheus/config/prometheus.yaml</code>读取进来的：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">config-reloader</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      quay.io/prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator/prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">reloader</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.82.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">       8080/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Host Port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  0/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /bin/prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">reloader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listen</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">address=</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">reload</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">url=http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9090/</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">/reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">file=/etc/prometheus/config/prometheus.yaml.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">envsubst</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">file=/etc/prometheus/config_out/prometheus.env.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">watched</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dir=/etc/prometheus/rules/prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rulefiles</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至于<code>prometheus.yaml</code>是怎么被加载到prometheus pod内部目录<code>/etc/prometheus/config</code>的，可以查看config-reloader的Mounts配置：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Mounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/config from config (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/config_out from config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">out (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/prometheus/rules/prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rulefiles</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">0 from prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rulefiles</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">0 (rw)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到<code>/etc/prometheus/config</code>是从<code>volumn=config</code>加载来的。查看volumn配置，volumn <code>name=config</code>的，type是<code>secret</code>，<code>name=prometheus-prometheus-kube-prometheus-prometheus</code>：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        Secret (a volume populated by a Secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">SecretName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Optional</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过命令查看<code>secret=prometheus-prometheus-kube-prometheus-prometheus</code>，以yaml格式导出，可以查看该secret相关的配置：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secret prometheus-prometheus-kube-prometheus-prometheus -o yaml -n monitoring &gt; secret.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl --namespace monitoring get secrets prometheus-prometheus-kube-prometheus-prometheus -o jsonpath=&quot;{.data.prometheus.yaml.gz}&quot; | base64 -d ; echo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同样的，也可以对另外两个主要的配置进行导出查看：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe statefulset alertmanager-prometheus-kube-prometheus-alertmanager -n monitoring &gt; alertmanager.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe deployment prometheus-kube-prometheus-operator -n monitoring &gt; operator.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>项目监控实操</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装prometheus--grafana">安装Prometheus + Grafana<a href="#安装prometheus--grafana" class="hash-link" aria-label="安装Prometheus + Grafana的直接链接" title="安装Prometheus + Grafana的直接链接">​</a></h2>
<p>步骤省略，参考前面【Kubernetes安装】章节</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-boot项目修改">Spring Boot项目修改<a href="#spring-boot项目修改" class="hash-link" aria-label="Spring Boot项目修改的直接链接" title="Spring Boot项目修改的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加依赖">添加依赖<a href="#添加依赖" class="hash-link" aria-label="添加依赖的直接链接" title="添加依赖的直接链接">​</a></h3>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- 开启 Spring Boot Actuator --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-boot-starter-actuator</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- 将 Actuator 指标转换为 Prometheus 格式 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.micrometer</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">micrometer-registry-prometheus</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${micrometer.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修改-applicationyaml-中添加-spring-boot-actuator-相关配置">修改 <code>application.yaml</code> 中添加 Spring Boot Actuator 相关配置<a href="#修改-applicationyaml-中添加-spring-boot-actuator-相关配置" class="hash-link" aria-label="修改-applicationyaml-中添加-spring-boot-actuator-相关配置的直接链接" title="修改-applicationyaml-中添加-spring-boot-actuator-相关配置的直接链接">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzctm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 开放 Actuator 管理端点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">management</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">web</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">exposure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">include</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">health</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">show-details</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">export</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">spring.application.name</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="通过-actuatorprometheus-测试配置是否正确">通过 <code>/actuator/prometheus</code> 测试配置是否正确：<a href="#通过-actuatorprometheus-测试配置是否正确" class="hash-link" aria-label="通过-actuatorprometheus-测试配置是否正确的直接链接" title="通过-actuatorprometheus-测试配置是否正确的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X GET -i &#x27;http://localhost:31121/hzpublic/actuator/prometheus&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X GET -i &#x27;http://localhost:31122/hzctm/actuator/prometheus&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查询结果如下图所示，将所有暴露的端点数据都展示出来了
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot1-e97bff2befb2dfebae64dbee97149324.png" width="1631" height="917" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-部署配置文件修改主要是-service-和-deployment-中标签的对应">K8s 部署配置文件修改，主要是 <code>Service</code> 和 <code>Deployment</code> 中标签的对应<a href="#k8s-部署配置文件修改主要是-service-和-deployment-中标签的对应" class="hash-link" aria-label="k8s-部署配置文件修改主要是-service-和-deployment-中标签的对应的直接链接" title="k8s-部署配置文件修改主要是-service-和-deployment-中标签的对应的直接链接">​</a></h3>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: svc-dz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    job: hz-service-hzpublic-job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-      nodePort: 30121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      nodePort: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ apiVersion: monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kind: ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   name: svc-dz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   namespace: hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     release: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   jobLabel: job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     - interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+       path: /hzpublic/actuator/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+       port: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     any: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+     matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+       app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+       job: hz-service-hzpublic-job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: hz-dev-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  minReadySeconds: 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  revisionHistoryLimit: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strategy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rollingUpdate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      maxSurge: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      maxUnavailable: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version: &quot;1.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        version: &quot;1.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        promtail.io/scrape: &quot;true&quot; # promtail筛选标签，需要设置scrape为true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        promtail.io/path: &quot;/logs/pd-service-hzpublic-all.log&quot; # 日志文件的路径名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      imagePullSecrets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: pisxdocker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-          image: 192.168.1.210:5000/library/pd-service-hzpublic:1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-          imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+          image: 192.168.1.210:5000/library/pd-service-hzpublic:prom-1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+          imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - containerPort: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: logs-hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # 启动探针，检测系统是否启动成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          startupProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              path: /hzpublic/actuator/health/readiness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              port: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            periodSeconds: 10 # 探测时间间隔</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            timeoutSeconds: 5 # 超时时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            failureThreshold: 30 # 重试次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # 存活探针，检测系统是否存活</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          livenessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              path: /hzpublic/actuator/health/liveness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              port: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialDelaySeconds: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            periodSeconds: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            timeoutSeconds: 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            failureThreshold: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cpu: &quot;2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              memory: &quot;2048Mi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ephemeral-storage: &quot;2Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cpu: &quot;0.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              memory: &quot;1024Mi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: TZ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: &#x27;Asia/Shanghai&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: logs-hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: /data/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要注意 <code>spec.selector</code> 需要与 <code>Pod</code> 的标签对应。例如使用 <code>Deployment</code> 部署应用，则需要与 <code>Deployment</code> 的 <code>spec.template.metadata.labels</code> 对应，这样 <code>Service</code> 才能知道对应的 <code>Pod</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="构建容器镜像并部署到k8s">构建容器镜像并部署到K8s<a href="#构建容器镜像并部署到k8s" class="hash-link" aria-label="构建容器镜像并部署到K8s的直接链接" title="构建容器镜像并部署到K8s的直接链接">​</a></h3>
<p>构建Docker镜像的 <code>Dockerfile</code></p>
<div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM 192.168.1.210:5000/azul/zulu-openjdk-centos:17-jre-latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VOLUME /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD pd-service-hzpublic.jar /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV JAVA_OPTS=&quot;-Xms1g -Xmx1g -XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -Duser.timezone=Asia/Shanghai \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -Dfile.encoding=UTF-8 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -Dsun.jnu.encoding=UTF-8 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -Djava.awt.headless=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --add-modules java.se \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --add-opens java.base/java.lang=ALL-UNNAMED \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --add-opens java.base/sun.nio.ch=ALL-UNNAMED \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --add-opens java.management/sun.management=ALL-UNNAMED \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --add-exports java.base/jdk.internal.ref=ALL-UNNAMED&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT java ${JAVA_OPTS} -jar /pd-service-hzpublic.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>应用部署的 <code>k8s-dev.yaml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> svc</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">job</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31121</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31121</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31121</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> svc</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">release</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jobLabel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /hzpublic/actuator/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespaceSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">any</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">job</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dev</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minReadySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">revisionHistoryLimit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rollingUpdate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">maxSurge</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">maxUnavailable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.0.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.0.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">promtail.io/scrape</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># promtail筛选标签，需要设置scrape为true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">promtail.io/path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/logs/pd-service-hzpublic-all.log&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 日志文件的路径名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">imagePullSecrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pisxdocker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.1.210</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5000/library/pd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">prom</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31121</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 启动探针，检测系统是否启动成功</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">startupProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /hzpublic/actuator/health/readiness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31121</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 探测时间间隔</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">timeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">failureThreshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 重试次数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 存活探针，检测系统是否存活</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">livenessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /hzpublic/actuator/health/liveness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31121</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">timeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">failureThreshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2048Mi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">ephemeral-storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2Gi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1024Mi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TZ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Asia/Shanghai&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /data/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编译镜像并使用K8s部署应用</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 拉取基础镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull azul/zulu-openjdk-centos:17-jre-latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重新打tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker tag azul/zulu-openjdk-centos:17-jre-latest 192.168.1.210:5000/azul/zulu-openjdk-centos:17-jre-latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 构建镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t 192.168.1.210:5000/library/pd-service-hzpublic:prom-1.0.0 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导出镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save 192.168.1.210:5000/library/pd-service-hzpublic:prom-1.0.0 -o pd-service-hzpublic_prom-1.0.0.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发送到集群其他节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp zulu-openjdk-centos_17-jre-latest.tar diginn@192.168.137.122:/home/diginn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp pd-service-hzpublic_prom-1.0.0.tar diginn@192.168.137.122:/home/diginn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 在集 群其他节点导入镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker load -i zulu-openjdk-centos_17-jre-latest.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker load -i pd-service-hzpublic_prom-1.0.0.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建命名空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get namespace hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如有需要，先删除再部署服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete -f k8s-dev.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f k8s-dev.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n hz-dev-service -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询pod详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod hz-dev-service-hzpublic-85d4549b5f-w9vd2 -n hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs hz-dev-service-hzpublic-85d4549b5f-w9vd2 -n hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 进入命令行交互模式，查看日志文件的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -it hz-dev-service-hzpublic-85d4549b5f-w9vd2 -n hz-dev-service -- /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>测试调用prometheus端点 <code>/actuator/prometheus</code> 获取状态信息</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 获取服务的运行端口信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get services -n hz-dev-service -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 services]$ kubectl get services -n hz-dev-service -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE     SELECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svc-dz-service-hzpublic   NodePort   10.101.31.91   &lt;none&gt;        31121:31121/TCP   7m13s   app=hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 调用端点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X GET -i &#x27;http://192.168.137.121:31121/hzpublic/actuator/prometheus&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到和本地运行测试一致，获取到了开发的指标信息
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot2-b699d24489d739b6d82b8d7cad762393.png" width="1919" height="909" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus配置修改">Prometheus配置修改<a href="#prometheus配置修改" class="hash-link" aria-label="Prometheus配置修改的直接链接" title="Prometheus配置修改的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件修改针对手动映射配置到容器场景">配置文件修改（针对手动映射配置到容器场景）<a href="#配置文件修改针对手动映射配置到容器场景" class="hash-link" aria-label="配置文件修改（针对手动映射配置到容器场景）的直接链接" title="配置文件修改（针对手动映射配置到容器场景）的直接链接">​</a></h3>
<p>如果是手动映射本地配置文件到prometheus容器中，则直接修改本地的配置文件即可，在 <code>prometheus.yaml</code> 中添加上 Service 对应的任务</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pd-service-hzpublic&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Prometheus 任务名称，自定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/hzpublic/actuator/prometheus&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 指标获取路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5s </span><span class="token comment" style="color:#999988;font-style:italic"># 抓取指标的间隔时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;svc-dz-service-hzpublic:31121&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 指标访问入口，即 k8s 集群的 Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pd-service-hzctm&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Prometheus 任务名称，自定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/hzctm/actuator/prometheus&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 指标获取路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5s </span><span class="token comment" style="color:#999988;font-style:italic"># 抓取指标的间隔时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;192.168.137.132:31122&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 指标访问入口，本地服务的IP 端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="k8s部署文件修改针对prometheus-operator部署的场景">K8s部署文件修改（针对Prometheus Operator部署的场景）<a href="#k8s部署文件修改针对prometheus-operator部署的场景" class="hash-link" aria-label="K8s 部署文件修改（针对Prometheus Operator部署的场景）的直接链接" title="K8s部署文件修改（针对Prometheus Operator部署的场景）的直接链接">​</a></h3>
<ul>
<li><a href="https://blog.51cto.com/u_16213689/10372943" target="_blank" rel="noopener noreferrer">k8s prometheus 配置文件 修改 k8s prometheus operator</a></li>
</ul>
<p>使用Prometheus Operator部署时，数据采集是依赖于 <code>ServiceMonitor</code> 的，需要在服务部署信息中添加 <code>ServiceMonitor</code> 信息</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: svc-hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 用于匹配 ServiceMonitor spec.selector.matchLabels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    job: hz-service-hzpublic-job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nodePort: 31121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 定义 ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ apiVersion: monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kind: ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  # 元数据中 name 和 namespace 与 Service 中保持一致 metadata.name metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  name: svc-dz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  namespace: hz-dev-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    # 这里的label release 是固定的，取值见下方详细说明</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    release: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  jobLabel: job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  # 采集监控指标节点的配置： 采集间隔，采集端点，对应的服务端口名称(spec.port[*].name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    - interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      path: /hzpublic/actuator/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      port: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    any: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      # 这里匹配的是Service 的Metadata中的label，从Service中复制即可 metadata.labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      app: hz-service-hzpublic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      job: hz-service-hzpublic-job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 后方的不需要修改，保持原样即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在Dashboard中添加Dashboard<a href="https://grafana.com/grafana/dashboards/11378-justai-system-monitor/" target="_blank" rel="noopener noreferrer">Spring Boot 2.1 System Monitor</a>
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot7-f9501fcda0bdfe173b691f0f776dec2d.png" width="1920" height="922" class="img_ev3q">
打开查看效果
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot8-01d1c3c83cb6e9dc3c5600955d323b94.png" width="1920" height="922" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="servicemonitor中的-metadatalabelsrealease-prometheus-说明">ServiceMonitor中的 <code>metadata.labels.realease: prometheus</code> 说明<a href="#servicemonitor中的-metadatalabelsrealease-prometheus-说明" class="hash-link" aria-label="servicemonitor中的-metadatalabelsrealease-prometheus-说明的直接链接" title="servicemonitor中的-metadatalabelsrealease-prometheus-说明的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 一键查询 ServiceMonitor 下 metadata.labels 的 K-V值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get prometheuses.monitoring.coreos.com -n monitoring -o jsonpath=&quot;{.items[0].spec.serviceMonitorSelector.matchLabels}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 全量信息见</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get prometheuses.monitoring.coreos.com -n monitoring -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查看servicemonitor">查看ServiceMonitor<a href="#查看servicemonitor" class="hash-link" aria-label="查看ServiceMonitor的直接链接" title="查看ServiceMonitor的直接链接">​</a></h4>
<p>通地命令查看ServiceMonitor，是Kubernetes定制的Kubernetes component，正是以下这些ServiceMonitor产生了上述Prometheus的Targets：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get servicemonitor -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 services]$ kubectl get servicemonitor -n monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                 AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-grafana                                   25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-alertmanager              25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-apiserver                 25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-coredns                   25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-kube-controller-manager   25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-kube-etcd                 25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-kube-proxy                25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-kube-scheduler            25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-kubelet                   25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-operator                  25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-prometheus-prometheus                25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-kube-state-metrics                        25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-prometheus-node-exporter                  25h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查看servicemonitor详细信息">查看ServiceMonitor详细信息<a href="#查看servicemonitor详细信息" class="hash-link" aria-label="查看ServiceMonitor详细信息的直接链接" title="查看ServiceMonitor详细信息的直接链接">​</a></h4>
<p>我们查看其中一个servicemonitor，以yaml形式展示：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get servicemonitor prometheus-grafana -n monitoring -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 services]$ kubectl get servicemonitor prometheus-grafana -n monitoring -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    meta.helm.sh/release-name: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    meta.helm.sh/release-namespace: monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: &quot;2025-06-10T07:32:22Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  generation: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/instance: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/managed-by: Helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/name: grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/version: 12.0.0-security-01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    helm.sh/chart: grafana-9.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: prometheus-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceVersion: &quot;198613&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uid: 53d3048f-ca33-47bc-8387-acfc357b99ed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - honorLabels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path: /metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: http-web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheme: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scrapeTimeout: 30s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jobLabel: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchNames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/instance: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/name: grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到资源类型是<code>ServiceMonitor</code>，<code>endpoints</code>的端点是<code>/metrics</code>，其中一个<code>label</code>是<code>app.kubernetes.io/instance: prometheus</code>，这里的<code>label</code>为什么是<code>prometheus</code>呢？</p>
<p>其实是我们chart的name，我们在install prometheus的时候用的命令是<code>helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring</code>，那么这里的<code>release-name</code>就是prometheus，如果我们换成abc，这里的<code>release-name</code>也会是abc，只要<strong>和CRD中的matchLabels对应起来就可以了</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查看crd">查看CRD<a href="#查看crd" class="hash-link" aria-label="查看CRD的直接链接" title="查看CRD的直接链接">​</a></h4>
<p>要想看具体内部是怎么关联的，我们需要再查看CRD。上述ServiceMonitor的apiVersion为：<code>apiVersion: monitoring.coreos.com/v1</code>，我们查看下CRD，首先列出所有CRDs：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get crd -n monitoring | grep prometheuses.monitoring.coreos.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[diginn@k8s-master-01 services]$ kubectl get crd -n monitoring | grep prometheuses.monitoring.coreos.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheuses.monitoring.coreos.com                    2025-06-10T06:50:23Z</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查看crd详细信息">查看CRD详细信息<a href="#查看crd详细信息" class="hash-link" aria-label="查看CRD详细信息的直接链接" title="查看CRD详细信息的直接链接">​</a></h4>
<p>具体查看CRD=prometheuses.monitoring.coreos.com，以yaml格式展示：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get prometheuses.monitoring.coreos.com -n monitoring -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出结果，重点关注PodMonitor ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># PodMonitor 匹配的规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">podMonitorSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    release: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ServiceMonitor 匹配的规则，这里显示的label名称和值就是上面 ServiceMonitor需要添加的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceMonitorSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    release: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>资源定义很长，其中一段定义，所以我们创建的ServiceMonitor，需要加上这个Label，否则就不会被关联上并发现，如果我们chart name为其它名字，如abc，那么在安装生成CRD的时候这里的release就会是abc，而不是prometheus</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="本地部署-spring-boot-jar包">本地部署 Spring Boot Jar包<a href="#本地部署-spring-boot-jar包" class="hash-link" aria-label="本地部署 Spring Boot Jar包的直接链接" title="本地部署 Spring Boot Jar包的直接链接">​</a></h2>
<p>配置环境变量</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 配置环境变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; ~/.bashrc &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export JAVA_HOME=/home/diginn/jdk-17.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$JAVA_HOME/bin:$PATH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 加载环境变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.bashrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 运行jar包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java -jar pd-service-hzctm.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 日志位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/diginn/logs/pd-service-hzctm-all.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启停脚本</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; startup.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup java -jar pd-service-hzctm.jar &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;$!&quot; &gt; pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; shutdown.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kill -9 `cat pid`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;关闭成功!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 脚本添加执行权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x startup.sh shutdown.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动服务</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./startup.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用prometheus-operator配置采集本地服务指标">使用Prometheus Operator配置采集本地服务指标<a href="#使用prometheus-operator配置采集本地服务指标" class="hash-link" aria-label="使用Prometheus Operator配置采集本地服务指标的直接链接" title="使用Prometheus Operator配置采集本地服务指标的直接链接">​</a></h2>
<ul>
<li><a href="https://www.modb.pro/db/392899" target="_blank" rel="noopener noreferrer">使用Prometheus监控非K8S集群内机器</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建k8s部署资源文件">创建K8s部署资源文件<a href="#创建k8s部署资源文件" class="hash-link" aria-label="创建K8s部署资源文件的直接链接" title="创建K8s部署资源文件的直接链接">​</a></h3>
<p>首先我们新建一个<code>ServiceMonitor</code>，用来统一监控非k8s集群内的服务，名称就定为 <code>spring-boot-exporter</code>。
另外我们还需要定义一个被监控机器的<code>Service</code>和<code>Endpoint</code>。将endpoint中 的port设置为服务的运行端口。</p>
<p>以下是K8s资源部署文件的示例: <code>k8s-local.yaml</code></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spring</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">boot</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 这里的labels要和 ServiceMonitor 的 spec.selector.matchLabels 一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzctm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">job</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzctm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">clusterIP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spring</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">boot</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subsets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 这里IP端口为本地服务的IP 和端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">addresses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ip</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.137.132</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31122</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spring</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">boot</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzctm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 这个标签必须要有，key和value的取值见上面章节【ServiceMonitor中的 `metadata.labels.realease: prometheus` 说明】</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">release</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jobLabel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 指标采集的端点信息，端口引用上面Endpoints中定义的port，path为指标端点的访问地址，需要包含服务的contextpath</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">honorLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">scheme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /hzctm/actuator/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 这里的取值要和Service 的 metadata.labels 一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzctm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">job</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hzctm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="部署资源服务">部署资源服务<a href="#部署资源服务" class="hash-link" aria-label="部署资源服务的直接链接" title="部署资源服务的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 部署</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f k8s-local.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f k8s-local.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="访问页面">访问页面<a href="#访问页面" class="hash-link" aria-label="访问页面的直接链接" title="访问页面的直接链接">​</a></h3>
<p>部署完成后访问Prometheus 的服务发现页 <code>http://192.168.137.121:30203/service-discovery</code>
<img decoding="async" loading="lazy" src="/assets/images/Local1-063adfa69d6add7c712c8d636964479f.png" width="1906" height="976" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/Local2-5415c2438bc464d2cb397f5917f1b216.png" width="1920" height="922" class="img_ev3q">
可以看到Prometheus已经有了本地服务的信息，如果<code>Target labels</code>显示 <code>dropped due to relabeling rules</code> 表示服务的配置存在错误，参考常见问题来解决</p>
<p>访问Grafana 监控面板页面 <code>http://192.168.137.121:31145/dashboards</code> 打开 <code>Spring Boot 2.1 System Monitor</code>
<img decoding="async" loading="lazy" src="/assets/images/Local3-c543e56342e764fd7ea4f270e921288d.png" width="1920" height="922" class="img_ev3q">
在这里已经有了本地服务的信息</p>
<h1>常见问题</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus-service-discovery-中显示目标服务的检测指标数据 被删除-dropped-due-to-relabeling-rules">Prometheus Service Discovery 中显示目标服务的检测指标数据被删除 【dropped due to relabeling rules】<a href="#prometheus-service-discovery-中显示目标服务的检测指标数据被删除-dropped-due-to-relabeling-rules" class="hash-link" aria-label="Prometheus Service Discovery 中显示目标服务的检测指标数据被删除 【dropped due to relabeling rules】的直接链接" title="Prometheus Service Discovery 中显示目标服务的检测指标数据被删除 【dropped due to relabeling rules】的直接链接">​</a></h2>
<p>访问Prometheus 服务发现页面: <code>http://192.168.137.121:30203/service-discovery?search=svc-dz-service-hzpublic</code></p>
<ul>
<li><a href="https://stackoverflow.com/questions/67818375/prometheus-target-discovery-dropped-target-labels" target="_blank" rel="noopener noreferrer">Prometheus 中显示指标被删除</a></li>
<li><a href="https://relabeler.promlabs.com/" target="_blank" rel="noopener noreferrer">在线校验K8s服务labels与Prometheus Relabeling rules</a></li>
</ul>
<ol>
<li>
<p>错误信息
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot3-37358c833bc26a6a6f801d5e5226d34b.png" width="1921" height="971" class="img_ev3q"></p>
</li>
<li>
<p>异常原因</p>
</li>
</ol>
<ul>
<li>namespace错误，如ServiceMonitor 的 namespace 与service的不一致</li>
</ul>
<ol start="3">
<li>解决方案</li>
</ol>
<p>从 <code>Service Discovery</code> 复制 <code>Discovered labels</code> 与 <code>Configuraitons</code> 的指定job的 <code>relabel_configs</code> <a href="https://relabeler.promlabs.com/" target="_blank" rel="noopener noreferrer">比对校验</a>
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot4-1fff91456fef1617a0b102e2ae0293c1.png" width="1924" height="977" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot5-0133da56623bfdfbe83fb79e4986c4e9.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/SpringBoot6-1b67d45d7826580f96f3b786f60ccccc.png" width="1604" height="1005" class="img_ev3q"></p>
<p>确认匹配规则是在哪一步失败的，然后针对这一步比对的tag修改服务部署配置</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/others/5-Prometheus-Grafana-System-Monitor.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/zh-cn/others/LPG-Log-Collect/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">LPG-Log-Collect</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">介绍</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#下载安装包" class="table-of-contents__link toc-highlight">下载安装包</a></li><li><a href="#安装-prometheus" class="table-of-contents__link toc-highlight">安装 Prometheus</a></li><li><a href="#安装-alertmanager" class="table-of-contents__link toc-highlight">安装 AlertManager</a></li><li><a href="#安装-node-exporter" class="table-of-contents__link toc-highlight">安装 Node Exporter</a></li><li><a href="#访问测试" class="table-of-contents__link toc-highlight">访问测试</a></li><li><a href="#下载镜像" class="table-of-contents__link toc-highlight">下载镜像</a></li><li><a href="#初始化配置" class="table-of-contents__link toc-highlight">初始化配置</a></li><li><a href="#部署prometheus-grafana" class="table-of-contents__link toc-highlight">部署Prometheus Grafana</a></li><li><a href="#测试" class="table-of-contents__link toc-highlight">测试</a></li><li><a href="#添加prometheus-chart到helm" class="table-of-contents__link toc-highlight">添加Prometheus Chart到Helm</a></li><li><a href="#安装prometheus-operator" class="table-of-contents__link toc-highlight">安装Prometheus Operator</a></li><li><a href="#检查prometheus-operator状态" class="table-of-contents__link toc-highlight">检查Prometheus Operator状态</a></li><li><a href="#访问prometheus-和-grafana-dashboards" class="table-of-contents__link toc-highlight">访问Prometheus 和 Grafana Dashboards</a><ul><li><a href="#临时方案k8s-端口转发" class="table-of-contents__link toc-highlight">临时方案，K8s 端口转发</a></li><li><a href="#使用-nodeport-暴露服务" class="table-of-contents__link toc-highlight">使用 NodePort 暴露服务</a></li></ul></li><li><a href="#测试-1" class="table-of-contents__link toc-highlight">测试</a></li><li><a href="#相关服务-资源的解析" class="table-of-contents__link toc-highlight">相关服务 资源的解析</a><ul><li><a href="#statefulsetdeploymentdaemonset" class="table-of-contents__link toc-highlight">statefulset，deployment，daemonset</a></li><li><a href="#configmap-secret" class="table-of-contents__link toc-highlight">configmap, secret</a></li><li><a href="#crds" class="table-of-contents__link toc-highlight">CRDs</a></li></ul></li><li><a href="#查看prometheus配置" class="table-of-contents__link toc-highlight">查看Prometheus配置</a></li><li><a href="#安装prometheus--grafana" class="table-of-contents__link toc-highlight">安装Prometheus + Grafana</a></li><li><a href="#spring-boot项目修改" class="table-of-contents__link toc-highlight">Spring Boot项目修改</a><ul><li><a href="#添加依赖" class="table-of-contents__link toc-highlight">添加依赖</a></li><li><a href="#修改-applicationyaml-中添加-spring-boot-actuator-相关配置" class="table-of-contents__link toc-highlight">修改 <code>application.yaml</code> 中添加 Spring Boot Actuator 相关配置</a></li><li><a href="#通过-actuatorprometheus-测试配置是否正确" class="table-of-contents__link toc-highlight">通过 <code>/actuator/prometheus</code> 测试配置是否正确：</a></li><li><a href="#k8s-部署配置文件修改主要是-service-和-deployment-中标签的对应" class="table-of-contents__link toc-highlight">K8s 部署配置文件修改，主要是 <code>Service</code> 和 <code>Deployment</code> 中标签的对应</a></li><li><a href="#构建容器镜像并部署到k8s" class="table-of-contents__link toc-highlight">构建容器镜像并部署到K8s</a></li></ul></li><li><a href="#prometheus配置修改" class="table-of-contents__link toc-highlight">Prometheus配置修改</a><ul><li><a href="#配置文件修改针对手动映射配置到容器场景" class="table-of-contents__link toc-highlight">配置文件修改（针对手动映射配置到容器场景）</a></li><li><a href="#k8s部署文件修改针对prometheus-operator部署的场景" class="table-of-contents__link toc-highlight">K8s部署文件修改（针对Prometheus Operator部署的场景）</a></li><li><a href="#servicemonitor中的-metadatalabelsrealease-prometheus-说明" class="table-of-contents__link toc-highlight">ServiceMonitor中的 <code>metadata.labels.realease: prometheus</code> 说明</a></li></ul></li><li><a href="#本地部署-spring-boot-jar包" class="table-of-contents__link toc-highlight">本地部署 Spring Boot Jar包</a></li><li><a href="#使用prometheus-operator配置采集本地服务指标" class="table-of-contents__link toc-highlight">使用Prometheus Operator配置采集本地服务指标</a><ul><li><a href="#创建k8s部署资源文件" class="table-of-contents__link toc-highlight">创建K8s部署资源文件</a></li><li><a href="#部署资源服务" class="table-of-contents__link toc-highlight">部署资源服务</a></li><li><a href="#访问页面" class="table-of-contents__link toc-highlight">访问页面</a></li></ul></li><li><a href="#prometheus-service-discovery-中显示目标服务的检测指标数据被删除-dropped-due-to-relabeling-rules" class="table-of-contents__link toc-highlight">Prometheus Service Discovery 中显示目标服务的检测指标数据被删除 【dropped due to relabeling rules】</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>