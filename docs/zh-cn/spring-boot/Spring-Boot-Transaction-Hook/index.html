<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-zh-cn/spring-boot/Spring-Boot-Transaction-Hook" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">Spring-Boot-Transaction-Hook | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/docs/zh-cn/spring-boot/Spring-Boot-Transaction-Hook/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring-Boot-Transaction-Hook | Light Docusaurus"><meta data-rh="true" name="description" content="- Spring 事务的独门绝技：钩子函数的使用技巧"><meta data-rh="true" property="og:description" content="- Spring 事务的独门绝技：钩子函数的使用技巧"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/docs/zh-cn/spring-boot/Spring-Boot-Transaction-Hook/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/docs/zh-cn/spring-boot/Spring-Boot-Transaction-Hook/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/docs/zh-cn/spring-boot/Spring-Boot-Transaction-Hook/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.10a62360.css">
<script src="/assets/js/runtime~main.849e35c8.js" defer="defer"></script>
<script src="/assets/js/main.4af205e6.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/electron/">Electron</a><a class="navbar__item navbar__link" href="/postman/">Postman</a><a class="navbar__item navbar__link" href="/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/zh-cn/spring-boot/Spring-Boot-Transaction-Hook/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/guide/">Guide</a><button aria-label="展开侧边栏分类 &#x27;Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/develop-environment/">Develop Environment</a><button aria-label="展开侧边栏分类 &#x27;Develop Environment&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-jvm/">Java (JVM)</a><button aria-label="展开侧边栏分类 &#x27;Java (JVM)&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/spring-boot/">Spring Boot</a><button aria-label="折叠侧边栏分类 &#x27;Spring Boot&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Api-Specification/">Api-Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/SPI/">SPI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Common-Async-Data-Handle/">Common-Async-Data-Handle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Multi-Thread-Transaction/">Multi-Thread-Transaction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Obfuscate-Spring-Boot-Application-With-Classfinal/">Obfuscate-Spring-Boot-Application-With-Classfinal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Obfuscate-Spring-Boot-Application-With-Proguard/">Obfuscate-Spring-Boot-Application-With-Proguard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Endpoints/">Spring-Boot-Endpoints</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Ip-Address-Parse/">Spring-Boot-Ip-Address-Parse</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Ip-Ragion-Parse/">Spring-Boot-Ip-Ragion-Parse</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Json-Diff/">Spring-Boot-Json-Diff</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Native-Memory-Leak/">Spring-Boot-Native-Memory-Leak</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Unit-Test/">Spring-Boot-Unit-Test</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Core/">Spring-Core</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Rate-Limit/">Spring-Rate-Limit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Statemachine/">Spring-Statemachine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/SpringEvent/">SpringEvent</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Dynamic-Datasource/">Spring-Boot-Dynamic-Datasource</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-QrCode-Zxing/">Spring-Boot-QrCode-Zxing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-With-Enum-Type/">Spring-Boot-With-Enum-Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Actuator/">Spring-Boot-Actuator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Parameter-Validate/">Spring-Boot-Parameter-Validate</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Sql-Injection/">Sql-Injection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Enhance-Request-And-Response/">Enhance-Request-And-Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Integrate-SpringDoc-Aggregation/">Spring-Boot-Integrate-SpringDoc-Aggregation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Hotswap-Aop/">Spring-Boot-Hotswap-Aop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Customlize-Request-Trace/">Customlize-Request-Trace</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Integrate-Alipay/">Spring-Boot-Integrate-Alipay</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/ApiKey-design/">ApiKey-design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-RSA-AES-Encryption/">Spring-Boot-RSA-AES-Encryption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Slim-Spring-Boot-FatJar/">Slim-Spring-Boot-FatJar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-boot-Dynamic-Load-Dependency/">Spring-boot-Dynamic-Load-Dependency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Start-Sequence/">Spring-Boot-Start-Sequence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Transaction-Hook/">Spring-Boot-Transaction-Hook</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Naming-Validate/">Spring-Boot-Naming-Validate</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Launch-Speed-Up/">Spring-Boot-Launch-Speed-Up</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Insert-Annotation-Like-Lombok/">Insert-Annotation-Like-Lombok</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Encryption/">Spring-Boot-Encryption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Dynamic-Load-Jar/">Spring-Boot-Dynamic-Load-Jar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Auto-Switch-between-Schedule-And-XXL-Job/">Auto-Switch-between-Schedule-And-XXL-Job</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Plugable-Develop/">Spring-Boot-Plugable-Develop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/How-To-Write-Controller/">How-To-Write-Controller</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Dynamic-DataSource/">Spring-Boot-Dynamic-DataSource</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-Dynamic-Load-Plugin/">Spring-Boot-Dynamic-Load-Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/spring-boot/Spring-Boot-No-Stop-Update/">Spring-Boot-No-Stop-Update</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break/">file</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/file/">File</a><button aria-label="展开侧边栏分类 &#x27;File&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-cloud/">Spring Cloud</a><button aria-label="展开侧边栏分类 &#x27;Spring Cloud&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-security/">Spring Security</a><button aria-label="展开侧边栏分类 &#x27;Spring Security&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-authorization-server/">Spring Authorization Server</a><button aria-label="展开侧边栏分类 &#x27;Spring Authorization Server&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/active-directory/">Active Directory</a><button aria-label="展开侧边栏分类 &#x27;Active Directory&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/database/">Database</a><button aria-label="展开侧边栏分类 &#x27;Database&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/git/">Git</a><button aria-label="展开侧边栏分类 &#x27;Git&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/linux/">Linux</a><button aria-label="展开侧边栏分类 &#x27;Linux&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/docker/">Docker</a><button aria-label="展开侧边栏分类 &#x27;Docker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kubernetes/">Kubernetes</a><button aria-label="展开侧边栏分类 &#x27;Kubernetes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/test/">Test</a><button aria-label="展开侧边栏分类 &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/others/">Others</a><button aria-label="展开侧边栏分类 &#x27;Others&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/zh-cn/awesome-open-source/">Github Speed UP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/zh-cn/windows/">Windows</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/spring-boot/"><span itemprop="name">Spring Boot</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring-Boot-Transaction-Hook</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring-Boot-Transaction-Hook</h1></header><ul>
<li><a href="https://juejin.cn/post/6984574787511123999" target="_blank" rel="noopener noreferrer">Spring 事务的独门绝技：钩子函数的使用技巧</a></li>
<li><a href="https://mp.weixin.qq.com/s/P6ZoQHtLP3IEwKQJlWzvtg" target="_blank" rel="noopener noreferrer">SpringBoot + 事务钩子函数，打造高效支付系统！</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2>
<p>经过前面对Spring AOP、事务的总结，我们已经对它们有了一个比较感性的认知了。今天，我继续安利一个独门绝技：Spring 事务的钩子函数。单纯的讲技术可能比较枯燥乏味。接下来，我将以一个实际的案例来描述Spring事务钩子函数的正确使用姿势。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一案例背景">一、案例背景<a href="#一案例背景" class="hash-link" aria-label="一、案例背景的直接链接" title="一、案例背景的直接链接">​</a></h2>
<p>拿支付系统相关的业务来举例。在支付系统中，我们需要记录每个账户的资金流水（记录用户A因为哪个操作扣了钱，因为哪个操作加了钱），这样我们才能对每个账户的账做到心中有数，对于支付系统而言，资金流水的数据可谓是最重要的。因此，为了防止支付系统的老大徇私舞弊，CTO提了一个流水存档的需求：要求支付系统对每个账户的资金流水做一份存档，要求支付系统在写流水的时候，把流水相关的信息以消息的形式推送到kafka，由存档系统消费这个消息并落地到库里（这个库只有存档系统拥有写权限）。整个需求的流程如下所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/32-1-f6350bb825631f0bcbcad34ba99956cd.awebp" width="915" height="398" class="img_ev3q"></p>
<p>整个需求的流程还是比较简单的，考虑到后续会有其他事业部也要进行数据存档操作，CTO建议支付系统团队内部开发一个二方库，这个二方库的主要功能就是发送消息到kafka中去。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二确定方案">二、确定方案<a href="#二确定方案" class="hash-link" aria-label="二、确定方案的直接链接" title="二、确定方案的直接链接">​</a></h2>
<p>既然要求开发一个二方库，因此，我们需要考虑如下几件事情：</p>
<ol>
<li>技术栈使用的springboot，因此，这里最好以starter的方式提供</li>
<li>二方库需要发送消息给kafka，最好是二方库内部基于kafka生产者的api创建生产者，不要使用Spring自带的kafkaTemplate，因为集成方有可能已经使用了kafkaTemplate。不能与集成方造成冲突。</li>
<li>减少对接方的集成难度、学习成本，最好是提供一个简单实用的api，业务侧能简单上手。</li>
<li>发送消息这个操作需要支持事务，尽量不影响主业务</li>
</ol>
<p>在上述的几件事情中，最需要注意的应该就是第4点：<strong>发送消息这个操作需要支持事务，尽量不影响主业务</strong>。</p>
<p>这是什么意思呢？</p>
<p>首先，尽 量不影响主业务，这个最简单的方式就是使用<strong>异步</strong>机制。</p>
<p>其次，需要支持事务是指：<strong>假设我们的api是在事务方法内部调用的，那么我们需要保证事务提交后再执行这个api</strong>。那么，我们的流水落地api应该要有这样的功能：</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:;base64,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" width="363" height="297" class="img_ev3q"></p>
<p>内部可以判断当前是否存在事务，如果存在事务，则需要等事务提交后再异步发送消息给kafka。如果不存在事务则直接异步发送消息给kafka。而且这样的判断逻辑得放在二方库内部才行。那现在摆在我们面前的问题就是：<strong>我要如何判断当前是否存在事务，以及如何在事务提交后再触发我们自定义的逻辑呢？</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三transactionsynchronizationmanager显神威">三、TransactionSynchronizationManager显神威<a href="#三transactionsynchronizationmanager显神威" class="hash-link" aria-label="三、TransactionSynchronizationManager显神威的直接链接" title="三、TransactionSynchronizationManager显神威的直接链接">​</a></h2>
<p>这个类内部所有的变量、方法都是<code>static</code>修饰的，也就是说它其实是一个工具类。是一个<strong>事务同步器</strong>。下述是<strong>流水落地API</strong>的伪代码，这段代码就解决了我们上述提到的疑问：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private final ExecutorService executor = Executors.newSingleThreadExecutor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendLog() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断当前是否存在事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!TransactionSynchronizationManager.isSynchronizationActive()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 无事务，异步发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor.submit(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 记录异常信息，发邮件或者进入待处理列表，让开发人员感知异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 有事务，则添加一个事务同步器，并重写afterCompletion方法（此方法在事务提交后会做回调）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void afterCompletion(int status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (status == TransactionSynchronization.STATUS_COMMITTED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 事务提交后，再异步发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor.submit(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	                    // 发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	                // 记录异常信息，发邮件或者进入待处理列表，让开发人员感知异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码比较简单，其主要是<code>TransactionSynchronizationManager</code>的使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31判断是否存在事务transactionsynchronizationmanagerissynchronizationactive-方法显神威">3.1、判断是否存在事务？<code>TransactionSynchronizationManager.isSynchronizationActive()</code> 方法显神威<a href="#31判断是否存在事务transactionsynchronizationmanagerissynchronizationactive-方法显神威" class="hash-link" aria-label="31判断是否存在事务transactionsynchronizationmanagerissynchronizationactive-方法显神威的直接链接" title="31判断是否存在事务transactionsynchronizationmanagerissynchronizationactive-方法显神威的直接链接">​</a></h3>
<p>我们先看下这个方法的源码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// TransactionSynchronizationManager.java类内部的部分代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final ThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			new NamedThreadLocal&lt;&gt;(&quot;Transaction synchronizations&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean isSynchronizationActive() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (synchronizations.get() != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>很明显，<code>synchronizations</code>是一个线程变量（<code>ThreadLocal</code>）。那它是在什么时候set进去的呢？这里的话，可以参考下这个方法：<code>org.springframework.transaction.support.TransactionSynchronizationManager#initSynchronization</code>，其源码如下所示：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Activate transaction synchronization for the current thread.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Called by a transaction manager on transaction begin.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @throws IllegalStateException if synchronization is already active</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void initSynchronization() throws IllegalStateException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isSynchronizationActive()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;Cannot activate transaction synchronization - already active&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger.trace(&quot;Initializing transaction synchronization&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronizations.set(new LinkedHashSet&lt;&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由源码中的注释也可以知道，它是在事务管理器开启事务时调用的。换句话说，只要我们的程序执行到带有事务特性的方法时，就会在线程变量中放入一个LinkedHashSet，用来标识当前存在事务。只要<code>isSynchronizationActive</code>返回true，则代表当前有事务。因此，结合这两个方法我们是指能解决我们最开始提出的疑问：<strong>要如何判断当前是否存在事务</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32如何在事务提交后触发自定义逻辑transactionsynchronizationmanagerregistersynchronization方法显神威">3.2、如何在事务提交后触发自定义逻辑？<code>TransactionSynchronizationManager.registerSynchronization()</code>方法显神威<a href="#32如何在事务提交后触发自定义逻辑transactionsynchronizationmanagerregistersynchronization方法显神威" class="hash-link" aria-label="32如何在事务提交后触发自定义逻辑transactionsynchronizationmanagerregistersynchronization方法显神威的直接链接" title="32如何在事务提交后触发自定义逻辑transactionsynchronizationmanagerregistersynchronization方法显神威的直接链接">​</a></h3>
<p>我们来看下这个方法的源代码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Register a new transaction synchronization for the current thread.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Typically called by resource management code.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * &lt;p&gt;Note that synchronizations can implement the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * {@link org.springframework.core.Ordered} interface.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * They will be executed in an order according to their order value (if any).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @param synchronization the synchronization object to register</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @throws IllegalStateException if transaction synchronization is not active</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @see org.springframework.core.Ordered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void registerSynchronization(TransactionSynchronization synchronization)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws IllegalStateException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(synchronization, &quot;TransactionSynchronization must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!isSynchronizationActive()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;Transaction synchronization is not active&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronizations.get().add(synchronization);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里又使用到了<code>synchronizations</code>线程变量，我们在判断是否存在事务时，就是判断这个线程变量内部是否有值。那我们现在想在<strong>事务提交后触发自定义逻辑</strong>和这个有什么关系呢？我们在上面构建<strong>流水落地api</strong>的伪代码中有向<code>synchronizations</code>内部添加了一个<code>TransactionSynchronizationAdapter</code>，内部并重写了<code>afterCompletion</code>方法，其代码如下所示：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterCompletion(int status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (status == TransactionSynchronization.STATUS_COMMITTED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 事务提交后，再异步发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.submit(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	                    // 发送消息给kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	                // 记录异常信息，发邮件或者进入待处理列表，让开发人员感知异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们结合<code>registerSynchronization</code>的源码来看，其实这段代码主要就是向线程变量内部的LinkedHashSet添加了一个对象而已，但就是这么一个操作，让Spring在事务执行的过程中变得“有事情可做”。这是什么意思呢？是因为Spring在执行事务方法时，对于操作事务的每一个阶段都有一个回调操作，比如：trigger系列的回调</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/32-3-c2738289a80b531b635d8d562783fac6.awebp" width="567" height="191" class="img_ev3q"></p>
<p>invoke系列的回调</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/32-4-56f9a9fd055f199249421d307e2b8920.awebp" width="563" height="133" class="img_ev3q"></p>
<p>而我们现在的需求就是在事务提交后触发自定义的函数，那就是在<code>invokeAfterCommit</code>和<code>invokeAfterCompletion</code>这两个方法来选了。首先，这两个方法都会拿到所有<code>TransactionSynchronization</code>的集合（其中会包括我们上述添加的<code>TransactionSynchronizationAdapter</code>）。但是要注意一点：<code>invokeAfterCommit</code>只能拿到集合，<code>invokeAfterCompletion</code>除了集合还有一个int类型的参数，而这个int类型的参数其实是当前事务的一种状态。也就是说，如果我们重写了<code>invokeAfterCompletion</code>方法，我们除了能拿到集合外，还能拿到当前事务的状态。因此，此时我们可以根据这个状态来做不同的事情，比如：可以在事务提交时做自定义处理，也可以在事务回滚时做自定义处理等等。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四总结">四、总结<a href="#四总结" class="hash-link" aria-label="四、总结的直接链接" title="四、总结的直接链接">​</a></h2>
<p>上面有说到，我们<strong>判断当前是否存在事务、添加钩子函数</strong>都是依赖线程变量的。因此，我们在使用过程中，一定要<strong>避免切换线程</strong>。否则会出现<strong>不生效</strong>的情况。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-boot/32-Spring-Boot-Transaction-Hook.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/zh-cn/spring-boot/Spring-Boot-Start-Sequence/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Spring-Boot-Start-Sequence</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/zh-cn/spring-boot/Spring-Boot-Naming-Validate/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Spring-Boot-Naming-Validate</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#一案例背景" class="table-of-contents__link toc-highlight">一、案例背景</a></li><li><a href="#二确定方案" class="table-of-contents__link toc-highlight">二、确定方案</a></li><li><a href="#三transactionsynchronizationmanager显神威" class="table-of-contents__link toc-highlight">三、TransactionSynchronizationManager显神威</a><ul><li><a href="#31判断是否存在事务transactionsynchronizationmanagerissynchronizationactive-方法显神威" class="table-of-contents__link toc-highlight">3.1、判断是否存在事务？<code>TransactionSynchronizationManager.isSynchronizationActive()</code> 方法显神威</a></li><li><a href="#32如何在事务提交后触发自定义逻辑transactionsynchronizationmanagerregistersynchronization方法显神威" class="table-of-contents__link toc-highlight">3.2、如何在事务提交后触发自定义逻辑？<code>TransactionSynchronizationManager.registerSynchronization()</code>方法显神威</a></li></ul></li><li><a href="#四总结" class="table-of-contents__link toc-highlight">四、总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>