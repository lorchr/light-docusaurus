<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-zh-cn/spring-boot/file/SliceUpload" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">SliceUpload | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-boot/file/SliceUpload/"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SliceUpload | Light Docusaurus"><meta data-rh="true" name="description" content="- 大文件上传最全方案：秒传、断点续传、分片上传"><meta data-rh="true" property="og:description" content="- 大文件上传最全方案：秒传、断点续传、分片上传"><link data-rh="true" rel="icon" href="/light-docusaurus/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-boot/file/SliceUpload/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-boot/file/SliceUpload/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-boot/file/SliceUpload/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/light-docusaurus/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/light-docusaurus/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/light-docusaurus/opensearch.xml"><link rel="stylesheet" href="/light-docusaurus/assets/css/styles.418b352b.css">
<link rel="preload" href="/light-docusaurus/assets/js/runtime~main.9772a7ad.js" as="script">
<link rel="preload" href="/light-docusaurus/assets/js/main.8b8232fe.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/light-docusaurus/"><div class="navbar__logo"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/light-docusaurus/docs/zh-cn/">Torch</a><a class="navbar__item navbar__link" href="/light-docusaurus/blog/">Blog</a><a class="navbar__item navbar__link" href="/light-docusaurus/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/light-docusaurus/electron/">Electron</a><a class="navbar__item navbar__link" href="/light-docusaurus/postman/">Postman</a><a class="navbar__item navbar__link" href="/light-docusaurus/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/light-docusaurus/docs/zh-cn/spring-boot/file/SliceUpload/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>SliceUpload</h1></header><ul><li><a href="https://mp.weixin.qq.com/s/0WRZQHzoM1ffxD_eIrGHkg" target="_blank" rel="noopener noreferrer">大文件上传最全方案：秒传、断点续传、分片上传</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>文件上传是一个老生常谈的话题了，在文件相对比较小的情况下，可以直接把文件转化为字节流上传到服务器，但在文件比较大的情况下，用普通的方式进行上传，这可不是一个好的办法，毕竟很少有人会忍受，当文件上传到一半中断后，继续上传却只能重头开始上传，这种让人不爽的体验。那有没有比较好的上传体验呢，答案有的，就是下边要介绍的几种上传方式</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="详细教程">详细教程<a href="#详细教程" class="hash-link" aria-label="详细教程的直接链接" title="详细教程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="秒传">秒传<a href="#秒传" class="hash-link" aria-label="秒传的直接链接" title="秒传的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1什么是秒传">1、什么是秒传<a href="#1什么是秒传" class="hash-link" aria-label="1、什么是秒传的直接链接" title="1、什么是秒传的直接链接">​</a></h4><p>通俗的说，你把要上传的东西上传，服务器会先做MD5校验，如果服务器上有一样的东西，它就直接给你个新地址，其实你下载的都是服务器上的同一个文件，想要不秒传，其实只要让MD5改变，就是对文件本身做一下修改（改名字不行），例如一个文本文件，你多加几个字，MD5就变了，就不会秒传了.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2本文实现的秒传核心逻辑">2、本文实现的秒传核心逻辑<a href="#2本文实现的秒传核心逻辑" class="hash-link" aria-label="2、本文实现的秒传核心逻辑的直接链接" title="2、本文实现的秒传核心逻辑的直接链接">​</a></h4><ul><li>利用redis的set方法存放文件上传状态，其中key为文件上传的md5，value为是否上传完成的标志位，</li><li>当标志位true为上传已经完成，此时如果有相同文件上传，则进入秒传逻辑。如果标志位为false，则说明还没上传完成，此时需要在调用set的方法，保存块号文件记录的路径，其中key为上传文件md5加一个固定前缀，value为块号文件记录路径</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分片上传">分片上传<a href="#分片上传" class="hash-link" aria-label="分片上传的直接链接" title="分片上传的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-什么是分片上传">1. 什么是分片上传<a href="#1-什么是分片上传" class="hash-link" aria-label="1. 什么是分片上传的直接链接" title="1. 什么是分片上传的直接链接">​</a></h4><p>分片上传，就是将所要上传的文件，按照一定的大小，将整个文件分隔成多个数据块（我们称之为Part）来进行分别上传，上传完之后再由服务端对所有上传的文件进行汇总整合成原始的文件。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-分片上传的场景">2. 分片上传的场景<a href="#2-分片上传的场景" class="hash-link" aria-label="2. 分片上传的场景的直接链接" title="2. 分片上传的场景的直接链接">​</a></h4><ol><li>大文件上传</li><li>网络环境环境不好，存在需要重传风险的场景</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="断点续传">断点续传<a href="#断点续传" class="hash-link" aria-label="断点续传的直接链接" title="断点续传的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-什么是断点续传">1. 什么是断点续传<a href="#1-什么是断点续传" class="hash-link" aria-label="1. 什么是断点续传的直接链接" title="1. 什么是断点续传的直接链接">​</a></h4><p>断点续传是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传或者下载未完成的部分，而没有必要从头开始上传或者下载。本文的断点续传主要是针对断点上传场景。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-应用场景">2. 应用场景<a href="#2-应用场景" class="hash-link" aria-label="2. 应用场景的直接链接" title="2. 应用场景的直接链接">​</a></h4><p>断点续传可以看成是分片上传的一个衍生，因此可以使用分片上传的场景，都可以使用断点续传。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-实现断点续传的核心逻辑">3. 实现断点续传的核心逻辑<a href="#3-实现断点续传的核心逻辑" class="hash-link" aria-label="3. 实现断点续传的核心逻辑的直接链接" title="3. 实现断点续传的核心逻辑的直接链接">​</a></h4><p>在分片上传的过程中，如果因为系统崩溃或者网络中断等异常因素导致上传中断，这时候客户端需要记录上传的进度。在之后支持再次上传时，可以继续从上次上传中断的地方进行继续上传。</p><p>为了避免客户端在上传之后的进度数据被删除而导致重新开始从头上传的问题，服务端也可以提供相应的接口便于客户端对已经上传的分片数据进行查询，从而使客户端知道已经上传的分片数据，从而从下一个分片数据开始继续上传。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-实现流程步骤">4. 实现流程步骤<a href="#4-实现流程步骤" class="hash-link" aria-label="4. 实现流程步骤的直接链接" title="4. 实现流程步骤的直接链接">​</a></h4><ol><li><p>方案一，常规步骤</p><ul><li>将需要上传的文件按照一定的分割规则，分割成相同大小的数据块；</li><li>初始化一个分片上传任务，返回本次分片上传唯一标识；</li><li>按照一定的策略（串行或并行）发送各个分片数据块；</li><li>发送完成后，服务端根据判断数据上传是否完整，如果完整，则进行数据块合成得到原始文件。</li></ul></li></ol><ol start="2"><li>方案二、本文实现的步骤</li></ol><ul><li>前端（客户端）需要根据固定大小对文件进行分片，请求后端（服务端）时要带上分片序号和大小</li><li>服务端创建conf文件用来记录分块位置，conf文件长度为总分片数，每上传一个分块即向conf文件中写入一个127，那么没上传的位置就是默认的0,已上传的就是Byte.MAX_VALUE 127（这步是实现断点续传和秒传的核心步骤）</li><li>服务器按照请求数据中给的分片序号和每片分块大小（分片大小是固定且一样的）算出开始位置，与读取到的文件片段数据，写入文件。</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-分片上传断点上传代码实现">5. 分片上传/断点上传代码实现<a href="#5-分片上传断点上传代码实现" class="hash-link" aria-label="5. 分片上传/断点上传代码实现的直接链接" title="5. 分片上传/断点上传代码实现的直接链接">​</a></h4><ol><li>前端采用百度提供的<code>webuploader</code>的插件，进行分片。因本文主要介绍服务端代码实现，webuploader如何进行分片，具体实现可以查看如下链接:</li></ol><blockquote><p><a href="http://fex.baidu.com/webuploader/getting-started.html" target="_blank" rel="noopener noreferrer">http://fex.baidu.com/webuploader/getting-started.html</a></p></blockquote><ol start="2"><li>后端用两种方式实现文件写入，一种是用RandomAccessFile，如果对RandomAccessFile不熟悉的朋友，可以查看如下链接:</li></ol><blockquote><p><a href="https://blog.csdn.net/dimudan2015/article/details/81910690" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/dimudan2015/article/details/81910690</a></p></blockquote><p>另一种是使用MappedByteBuffer，对MappedByteBuffer不熟悉的朋友，可以查看如下链接进行了解:</p><blockquote><p><a href="https://www.jianshu.com/p/f90866dcbffc" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/f90866dcbffc</a></p></blockquote><p>后端进行写入操作的核心代码</p><ol><li>RandomAccessFile实现方式</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@UploadMode(mode = UploadModeEnum.RANDOM_ACCESS)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RandomAccessUploadStrategy extends SliceUploadTemplate {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private FilePathUtil filePathUtil;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Value(&quot;${upload.chunkSize}&quot;)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private long defaultChunkSize;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean upload(FileUploadRequestDTO param) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RandomAccessFile accessTmpFile = null;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String uploadDirPath = filePathUtil.getPath(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      File tmpFile = super.createTmpFile(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessTmpFile = new RandomAccessFile(tmpFile, &quot;rw&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //这个必须与前端设定的值一致  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      long chunkSize = Objects.isNull(param.getChunkSize()) ? defaultChunkSize * 1024 * 1024  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          : param.getChunkSize();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      long offset = chunkSize * param.getChunk();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //定位到该分片的偏移量  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessTmpFile.seek(offset);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //写入该分片数据  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessTmpFile.write(param.getFile().getBytes());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      boolean isOk = super.checkAndSetUploadProgress(param, uploadDirPath);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return isOk;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.error(e.getMessage(), e);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      FileUtil.close(accessTmpFile);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return false;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>MappedByteBuffer实现方式</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@UploadMode(mode = UploadModeEnum.MAPPED_BYTEBUFFER)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MappedByteBufferUploadStrategy extends SliceUploadTemplate {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private FilePathUtil filePathUtil;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Value(&quot;${upload.chunkSize}&quot;)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private long defaultChunkSize;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean upload(FileUploadRequestDTO param) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RandomAccessFile tempRaf = null;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FileChannel fileChannel = null;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MappedByteBuffer mappedByteBuffer = null;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String uploadDirPath = filePathUtil.getPath(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      File tmpFile = super.createTmpFile(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tempRaf = new RandomAccessFile(tmpFile, &quot;rw&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fileChannel = tempRaf.getChannel();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      long chunkSize = Objects.isNull(param.getChunkSize()) ? defaultChunkSize * 1024 * 1024  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          : param.getChunkSize();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //写入该分片数据  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      long offset = chunkSize * param.getChunk();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      byte[] fileData = param.getFile().getBytes();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mappedByteBuffer = fileChannel  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.map(FileChannel.MapMode.READ_WRITE, offset, fileData.length);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mappedByteBuffer.put(fileData);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      boolean isOk = super.checkAndSetUploadProgress(param, uploadDirPath);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return isOk;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.error(e.getMessage(), e);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      FileUtil.freedMappedByteBuffer(mappedByteBuffer);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      FileUtil.close(fileChannel);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      FileUtil.close(tempRaf);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3.文件操作核心模板类代码</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class SliceUploadTemplate implements SliceUploadStrategy {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public abstract boolean upload(FileUploadRequestDTO param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected File createTmpFile(FileUploadRequestDTO param) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FilePathUtil filePathUtil = SpringContextHolder.getBean(FilePathUtil.class);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    param.setPath(FileUtil.withoutHeadAndTailDiagonal(param.getPath()));  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = param.getFile().getOriginalFilename();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String uploadDirPath = filePathUtil.getPath(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String tempFileName = fileName + &quot;_tmp&quot;;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File tmpDir = new File(uploadDirPath);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File tmpFile = new File(uploadDirPath, tempFileName);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!tmpDir.exists()) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tmpDir.mkdirs();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return tmpFile;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public FileUploadDTO sliceUpload(FileUploadRequestDTO param) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isOk = this.upload(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isOk) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      File tmpFile = this.createTmpFile(param);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      FileUploadDTO fileUploadDTO = this.saveAndFileUploadDTO(param.getFile().getOriginalFilename(), tmpFile);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return fileUploadDTO;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String md5 = FileMD5Util.getFileMD5(param.getFile());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;Integer, String&gt; map = new HashMap&lt;&gt;();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map.put(param.getChunk(), md5);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return FileUploadDTO.builder().chunkMd5Info(map).build();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * 检查并修改文件上传进度  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean checkAndSetUploadProgress(FileUploadRequestDTO param, String uploadDirPath) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = param.getFile().getOriginalFilename();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File confFile = new File(uploadDirPath, fileName + &quot;.conf&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte isComplete = 0;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RandomAccessFile accessConfFile = null;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessConfFile = new RandomAccessFile(confFile, &quot;rw&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //把该分段标记为 true 表示完成  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      System.out.println(&quot;set part &quot; + param.getChunk() + &quot; complete&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //创建conf文件文件长度为总分片数，每上传一个分块即向conf文件中写入一个127，那么没上传的位置就是默认0,已上传的就是Byte.MAX_VALUE 127  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessConfFile.setLength(param.getChunks());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessConfFile.seek(param.getChunk());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessConfFile.write(Byte.MAX_VALUE);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //completeList 检查是否全部完成,如果数组里是否全部都是127(全部分片都成功上传)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      byte[] completeList = FileUtils.readFileToByteArray(confFile);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      isComplete = Byte.MAX_VALUE;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (int i = 0; i &lt; completeList.length &amp;&amp; isComplete == Byte.MAX_VALUE; i++) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //与运算, 如果有部分没有完成则 isComplete 不是 Byte.MAX_VALUE  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isComplete = (byte) (isComplete &amp; completeList[i]);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;check part &quot; + i + &quot; complete?:&quot; + completeList[i]);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.error(e.getMessage(), e);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      FileUtil.close(accessConfFile);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> boolean isOk = setUploadProgress2Redis(param, uploadDirPath, fileName, confFile, isComplete);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return isOk;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * 把上传进度信息存进redis  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private boolean setUploadProgress2Redis(FileUploadRequestDTO param, String uploadDirPath,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String fileName, File confFile, byte isComplete) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisUtil redisUtil = SpringContextHolder.getBean(RedisUtil.class);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isComplete == Byte.MAX_VALUE) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redisUtil.hset(FileConstant.FILE_UPLOAD_STATUS, param.getMd5(), &quot;true&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      redisUtil.del(FileConstant.FILE_MD5_KEY + param.getMd5());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      confFile.delete();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return true;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!redisUtil.hHasKey(FileConstant.FILE_UPLOAD_STATUS, param.getMd5())) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redisUtil.hset(FileConstant.FILE_UPLOAD_STATUS, param.getMd5(), &quot;false&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redisUtil.set(FileConstant.FILE_MD5_KEY + param.getMd5(),  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uploadDirPath + FileConstant.FILE_SEPARATORCHAR + fileName + &quot;.conf&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return false;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * 保存文件操作  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public FileUploadDTO saveAndFileUploadDTO(String fileName, File tmpFile) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FileUploadDTO fileUploadDTO = null;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fileUploadDTO = renameFile(tmpFile, fileName);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (fileUploadDTO.isUploadComplete()) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .println(&quot;upload complete !!&quot; + fileUploadDTO.isUploadComplete() + &quot; name=&quot; + fileName);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //TODO 保存文件信息到数据库  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.error(e.getMessage(), e);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fileUploadDTO;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * 文件重命名  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param toBeRenamed 将要修改名字的文件  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param toFileNewName 新的名字  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private FileUploadDTO renameFile(File toBeRenamed, String toFileNewName) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //检查要重命名的文件是否存在，是否是文件  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FileUploadDTO fileUploadDTO = new FileUploadDTO();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!toBeRenamed.exists() || toBeRenamed.isDirectory()) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;File does not exist: {}&quot;, toBeRenamed.getName());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fileUploadDTO.setUploadComplete(false);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return fileUploadDTO;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ext = FileUtil.getExtension(toFileNewName);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String p = toBeRenamed.getParent();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String filePath = p + FileConstant.FILE_SEPARATORCHAR + toFileNewName;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File newFile = new File(filePath);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //修改文件名  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean uploadFlag = toBeRenamed.renameTo(newFile);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileUploadDTO.setMtime(DateUtil.getCurrentTimeStamp());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileUploadDTO.setUploadComplete(uploadFlag);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileUploadDTO.setPath(filePath);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileUploadDTO.setSize(newFile.length());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileUploadDTO.setFileExt(ext);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileUploadDTO.setFileId(toFileNewName);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fileUploadDTO;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>在实现分片上传的过程，需要前端和后端配合，比如前后端的上传块号的文件大小，前后端必须得要一致，否则上传就会有问题。其次文件相关操作正常都是要搭建一个文件服务器的，比如使用fastdfs、hdfs等。</p><p>本示例代码在电脑配置为4核内存8G情况下，上传24G大小的文件，上传时间需要30多分钟，主要时间耗费在前端的md5值计算，后端写入的速度还是比较快。如果项目组觉得自建文件服务器太花费时间，且项目的需求仅仅只是上传下载，那么推荐使用阿里的oss服务器，其介绍可以查看官网:</p><blockquote><p><a href="https://help.aliyun.com/product/31815.html" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/product/31815.html</a></p></blockquote><p>阿里的oss它本质是一个对象存储服务器，而非文件服务器，因此如果有涉及到大量删除或者修改文件的需求，oss可能就不是一个好的选择。</p><p>文末提供一个oss表单上传的链接demo，通过oss表单上传，可以直接从前端把文件上传到oss服务器，把上传的压力都推给oss服务器:</p><blockquote><p><a href="https://www.cnblogs.com/ossteam/p/4942227.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/ossteam/p/4942227.html</a></p></blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-boot/file/SliceUpload.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#详细教程" class="table-of-contents__link toc-highlight">详细教程</a><ul><li><a href="#秒传" class="table-of-contents__link toc-highlight">秒传</a></li><li><a href="#分片上传" class="table-of-contents__link toc-highlight">分片上传</a></li><li><a href="#断点续传" class="table-of-contents__link toc-highlight">断点续传</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/docs/intro/">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/light-docusaurus/assets/js/runtime~main.9772a7ad.js"></script>
<script src="/light-docusaurus/assets/js/main.8b8232fe.js"></script>
</body>
</html>