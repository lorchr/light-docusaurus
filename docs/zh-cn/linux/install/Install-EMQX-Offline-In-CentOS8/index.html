<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Install-EMQX-Offline-In-CentOS8 | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/docs/zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Install-EMQX-Offline-In-CentOS8 | Light Docusaurus"><meta data-rh="true" name="description" content="一、相关链接"><meta data-rh="true" property="og:description" content="一、相关链接"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/docs/zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/docs/zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/docs/zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Light Docusaurus Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e8086d6f.css">
<script src="/assets/js/runtime~main.c1801180.js" defer="defer"></script>
<script src="/assets/js/main.0392788b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/electron/">Electron</a><a class="navbar__item navbar__link" href="/postman/">Postman</a><a class="navbar__item navbar__link" href="/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/guide/">Guide</a><button aria-label="展开侧边栏分类 &#x27;Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/develop-environment/">Develop Environment</a><button aria-label="展开侧边栏分类 &#x27;Develop Environment&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/java-jvm/">Java (JVM)</a><button aria-label="展开侧边栏分类 &#x27;Java (JVM)&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-boot/">Spring Boot</a><button aria-label="展开侧边栏分类 &#x27;Spring Boot&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-cloud/">Spring Cloud</a><button aria-label="展开侧边栏分类 &#x27;Spring Cloud&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-security/">Spring Security</a><button aria-label="展开侧边栏分类 &#x27;Spring Security&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/spring-authorization-server/">Spring Authorization Server</a><button aria-label="展开侧边栏分类 &#x27;Spring Authorization Server&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/active-directory/">Active Directory</a><button aria-label="展开侧边栏分类 &#x27;Active Directory&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/database/">Database</a><button aria-label="展开侧边栏分类 &#x27;Database&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/git/">Git</a><button aria-label="展开侧边栏分类 &#x27;Git&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/linux/">Linux</a><button aria-label="折叠侧边栏分类 &#x27;Linux&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/common/">Common</a><button aria-label="展开侧边栏分类 &#x27;Common&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/install/">Install</a><button aria-label="折叠侧边栏分类 &#x27;Install&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-JDK/">Install-JDK</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-NodeJS/">Install-NodeJS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Maven/">Install-Maven</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Gitea/">Install-Gitea</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Nexus3/">Install-Nexus3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Jenkins/">Install-Jenkins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Harbor/">Install-Harbor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Docker-Registry/">Install-Docker-Registry</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Ftp/">Install-Ftp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Zim/">Install-Zim</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Install-Zsh/">Install-Zsh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/zh-cn/linux/install/Install-EMQX-Offline-In-CentOS8/">Install-EMQX-Offline-In-CentOS8</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-cn/linux/install/Deploy-ZLMediaKit-And-WVP-GB28181-Pro-Offline/">Deploy-ZLMediaKit-And-WVP-GB28181-Pro-Offline</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/docker/">Docker</a><button aria-label="展开侧边栏分类 &#x27;Docker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kubernetes/">Kubernetes</a><button aria-label="展开侧边栏分类 &#x27;Kubernetes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/test/">Test</a><button aria-label="展开侧边栏分类 &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/others/">Others</a><button aria-label="展开侧边栏分类 &#x27;Others&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/zh-cn/awesome-open-source/">Github Speed UP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/zh-cn/windows/">Windows</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux/"><span itemprop="name">Linux</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/install/"><span itemprop="name">Install</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Install-EMQX-Offline-In-CentOS8</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Install-EMQX-Offline-In-CentOS8</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一相关链接">一、相关链接<a href="#一相关链接" class="hash-link" aria-label="一、相关链接的直接链接" title="一、相关链接的直接链接">​</a></h2>
<ul>
<li><a href="https://www.centos.org/" target="_blank" rel="noopener noreferrer">CentOS官网</a></li>
<li><a href="https://mirrors.aliyun.com/centos/" target="_blank" rel="noopener noreferrer">CentOS下载-阿里云镜像站</a></li>
<li><a href="https://rpmfind.net/" target="_blank" rel="noopener noreferrer">Linux依赖包查询 rpm find</a></li>
<li><a href="https://pkgs.org" target="_blank" rel="noopener noreferrer">Linux依赖包查询 pkgs</a></li>
<li><a href="https://mirrors.aliyun.com/centos/8.5.2111/BaseOS/x86_64/os/Packages/" target="_blank" rel="noopener noreferrer">Linux依赖包查询 aliyun</a></li>
<li></li>
<li><a href="https://www.emqx.com/zh/downloads-and-install/broker?os=RHEL" target="_blank" rel="noopener noreferrer">EMQX 开源版下载</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/" target="_blank" rel="noopener noreferrer">EMQX 使用指南</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/configuration/cluster.html" target="_blank" rel="noopener noreferrer">EMQX 集群配置</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/mria-introduction.html" target="_blank" rel="noopener noreferrer">EMQX 集群架构</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/v5.8.5/hocon/" target="_blank" rel="noopener noreferrer">EMQX 配置手册</a></li>
<li></li>
<li><a href="https://mqttx.app/zh/features" target="_blank" rel="noopener noreferrer">MQTTX 官网</a></li>
<li><a href="https://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">Nginx 官网</a></li>
<li><a href="https://www.haproxy.org/" target="_blank" rel="noopener noreferrer">HAProxy官网</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二环境介绍">二、环境介绍<a href="#二环境介绍" class="hash-link" aria-label="二、环境介绍的直接链接" title="二、环境介绍的直接链接">​</a></h2>
<table><thead><tr><th>名称</th><th>版本</th><th>备注</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS 8.5.2111</td><td><a href="https://mirrors.aliyun.com/centos/8.5.2111/isos/x86_64/" target="_blank" rel="noopener noreferrer">阿里云镜像站 CentOS 8.5</a></td></tr><tr><td>CentOS依赖</td><td>-</td><td><a href="https://mirrors.aliyun.com/centos/8/BaseOS/x86_64/os/Packages/" target="_blank" rel="noopener noreferrer">阿里云镜像站 BaseOS Packages</a></td></tr><tr><td>EMQX安装包</td><td>EMQX-v5.8.5</td><td><a href="https://www.emqx.com/zh/downloads-and-install/broker?os=RHEL" target="_blank" rel="noopener noreferrer">RHEL 8(CentOS 8) amd64 / tar.gz</a></td></tr><tr><td>集群网关</td><td>Nginx-1.26.3</td><td><a href="https://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx-1.26.3</a></td></tr><tr><td>集群网关</td><td>HAproxy-3.1.5</td><td><a href="https://www.haproxy.org/download/3.1/src" target="_blank" rel="noopener noreferrer">haproxy-3.1.5</a></td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三准备工作">三、准备工作<a href="#三准备工作" class="hash-link" aria-label="三、准备工作的直接链接" title="三、准备工作的直接链接">​</a></h2>
<p>由于生产服务器无法连接外网，可以先在本地搭建一套与生产版本一致的虚拟机，所有需要离线安装的软件包都预先在虚拟机中进行安装测试，保证兼容性及依赖包的完整性，避免到生产服务器出现不兼容或缺少依赖的请况。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-系统安装">1. 系统 安装<a href="#1-系统安装" class="hash-link" aria-label="1. 系统安装的直接链接" title="1. 系统安装的直接链接">​</a></h3>
<p>系统安装与CentOS7之前有较大区别，可以参考<a href="https://blog.csdn.net/wusam/article/details/142619996" target="_blank" rel="noopener noreferrer">这篇文章</a>
重点是在<code>安装信息摘要</code>页面，按照以下顺序设置</p>
<ol>
<li>Root用户密码</li>
<li>网络和主机名 此处的MAC地址需要和虚拟机<code>设置</code>-<code>网络</code>页面的MAC地址一致</li>
<li>安装目的地</li>
<li>安装源       <code>http://mirrors.aliyun.com/centos/8/BaseOS/x86_64/os/</code></li>
<li>软件选择     最小安装(yum ssh curl ping ip)</li>
</ol>
<p><img decoding="async" loading="lazy" src="/assets/images/系统安装1-f450521d35f9caafbb4e9a27f92d6bf4.png" width="1006" height="750" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/系统安装2-c486f3e414e470fcc3c970df692f7c59.png" width="1006" height="750" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/系统安装3-144c9763e2beb786db0315eb340ba50f.png" width="1006" height="750" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/系统安装4-ec101983ec048953c7ae430971ce92ce.png" width="1006" height="750" class="img_ev3q"></p>
<p>如果要设置固定IP，可以修改网络配置文件，手动设置IP、MAC地址、网关、子网掩码、DNS等信息</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看网络配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/sysconfig/network-scripts/ifcfg-enp0s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改网络配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/sysconfig/network-scripts/ifcfg-enp0s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOTPROTO=static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPADDR=192.168.137.101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># MACADDR=08:00:27:D7:88:87</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HWADDR=08:00:27:D7:88:87</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY=192.168.137.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK=255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS1=114.114.114.114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启网络服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart NetworkManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试与宿主机 公网的网络互通</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c4 192.168.137.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c4 jd.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-修改yum源">2. 修改yum源<a href="#2-修改yum源" class="hash-link" aria-label="2. 修改yum源的直接链接" title="2. 修改yum源的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Errors during downloading metadata for repository &#x27;appstream&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Curl error (6): Couldn&#x27;t resolve host name for http://mirrorlist.centos.org/?release=8&amp;arch=x86_64&amp;repo=AppStream&amp;infra=stock [Could not resolve host: mirrorlist.centos.org]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">错误：为仓库 &#x27;appstream&#x27; 下载元数据失败 : Cannot prepare internal mirrorlist: Curl error (6): Couldn&#x27;t resolve host name for http://mirrorlist.centos.org/?release=8&amp;arch=x86_64&amp;repo=AppStream&amp;infra=stock [Could not resolve host: mirrorlist.centos.org]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由于 CentOS 团队已于 2021 年 12 月 31 日对 CentOS Linux 8 停止更新和维护，并从官方镜像中移除 CentOS 8 的所有包，因此导致在使用 yum 源安装或更新会报上述错误，解决方案可参考<a href="https://blog.csdn.net/huchaoyang123/article/details/144608111" target="_blank" rel="noopener noreferrer">这篇文章</a>，下面直接用阿里云软件源替换</p>
<ol>
<li>备份软件源</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 进入仓库源文件目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /etc/yum.repos.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 备份</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-AppStream.repo             /etc/yum.repos.d/CentOS-Linux-AppStream.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-BaseOS.repo                /etc/yum.repos.d/CentOS-Linux-BaseOS.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-ContinuousRelease.repo     /etc/yum.repos.d/CentOS-Linux-ContinuousRelease.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-Debuginfo.repo             /etc/yum.repos.d/CentOS-Linux-Debuginfo.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-Devel.repo                 /etc/yum.repos.d/CentOS-Linux-Devel.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-Extras.repo                /etc/yum.repos.d/CentOS-Linux-Extras.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-FastTrack.repo             /etc/yum.repos.d/CentOS-Linux-FastTrack.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-HighAvailability.repo      /etc/yum.repos.d/CentOS-Linux-HighAvailability.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-Media.repo                 /etc/yum.repos.d/CentOS-Linux-Media.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-Plus.repo                  /etc/yum.repos.d/CentOS-Linux-Plus.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-PowerTools.repo            /etc/yum.repos.d/CentOS-Linux-PowerTools.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/yum.repos.d/CentOS-Linux-Sources.repo               /etc/yum.repos.d/CentOS-Linux-Sources.repo.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>使用阿里云软件源</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 如果没有wget，可以用curl下载 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># wget http://mirrors.aliyun.com/repo/Centos-8.repo -O /etc/yum.repos.d/CentOS-Linux-BaseOS.repo </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl http://mirrors.aliyun.com/repo/Centos-8.repo -o /etc/yum.repos.d/CentOS-Linux-BaseOS.repo </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>更新软件源</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 清空原有缓存并重新生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum clean all &amp;&amp; yum makecache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 更新软件包（可选）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum update -y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-查找依赖包">3. 查找依赖包<a href="#3-查找依赖包" class="hash-link" aria-label="3. 查找依赖包的直接链接" title="3. 查找依赖包的直接链接">​</a></h3>
<p>由于离线安装时无法在线安装依赖包，故需要提前准备好相关的依赖包，如何查询并安装依赖包可以参考<a href="https://www.cnblogs.com/zw-loser/p/17251908.html" target="_blank" rel="noopener noreferrer">这篇文章</a></p>
<ol>
<li>安装依赖</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 如果无法在线安装，可以在阿里云镜像站找到 https://mirrors.aliyun.com/centos/8.5.2111/BaseOS/x86_64/os/Packages/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install yum-utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试下载依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /root/lib/{tar,unzip,wget,vim,net-tools}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/tar tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/unzip unzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/wget wget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/vim vim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/net-tools net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>查看提供某个命令/value的rpm包</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum provides unzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>查看 rpm 包所需的全部依赖</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum deplist unzip-6.0-45.el8_4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四测试机安装emqx">四、测试机安装EMQX<a href="#四测试机安装emqx" class="hash-link" aria-label="四、测试机安装EMQX的直接链接" title="四、测试机安装EMQX的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-下载依赖包">1. 下载依赖包<a href="#1-下载依赖包" class="hash-link" aria-label="1. 下载依赖包的直接链接" title="1. 下载依赖包的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/tar tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/unzip unzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/wget wget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/vim vim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/net-tools net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/libatomic libatomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/chrony chrony</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果openssl版本低于1.1，需要进行升级 openssl version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/epel-release epel-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/openssl11 openssl11 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/openssl11-devel openssl11-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 打包为压缩包，方便下载到本地</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zcvf lib.tar.gz ./lib/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将依赖同步到其他服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -r /root/lib/* root@192.168.137.102:/root/lib/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 上传到服务器之后解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf lib.tar.gz -C ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-rpm-安装">2. rpm 安  装<a href="#2-rpm-安装" class="hash-link" aria-label="2. rpm 安装的直接链接" title="2. rpm 安装的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载 wget https://www.emqx.com/zh/downloads/broker/5.8.5/emqx-5.8.5-el8-amd64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://packages.emqx.net/emqx-ce/v5.8.5/emqx-5.8.5-el8-amd64.rpm -o emqx-5.8.5-el8-amd64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo yum install -y emqx-5.8.5-el8-amd64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动 停止命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl start emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl status emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl stop emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/emqx/emqx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查询安装的包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo rpm -qa | grep emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 卸载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo rpm -e emqx-5.8.5-1.el8.x86_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>安装完成后相关文件可以从下面位置找到</p>
<ul>
<li><code>/usr/lib/emqx</code> 安装文件路径</li>
<li><code>/usr/bin/emqx</code> 执行文件路径（软链接）</li>
<li><code>/etc/emqx/</code>    配置文件路径</li>
<li><code>/var/log/emqx</code> 日志文件路径</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-targz-安装">3. tar.gz 安装<a href="#3-targz-安装" class="hash-link" aria-label="3. tar.gz 安装的直接链接" title="3. tar.gz 安装的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载 wget https://www.emqx.com/zh/downloads/broker/5.8.5/emqx-5.8.5-el8-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://packages.emqx.net/emqx-ce/v5.8.5/emqx-5.8.5-el8-amd64.tar.gz -o emqx-5.8.5-el8-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装 tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh ./lib/tar-1.30-5.el8.x86_64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /opt/emqx &amp;&amp; tar -zxvf emqx-5.8.5-el8-amd64.tar.gz -C /opt/emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动 停止命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/emqx start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/emqx stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/emqx console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>安装完成后相关文件可以从下面位置找到</p>
<ul>
<li><code>/opt/emqx</code>       安装文件路径</li>
<li><code>/opt/emqx/bin</code>   执行文件路径</li>
<li><code>/opt/emqx/etc/</code>  配置文件路径</li>
<li><code>/opt/emqx/log</code>   日志文件路径</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-将emqx注册为系统服务">4. 将EMQX注册为系统服务<a href="#4-将emqx注册为系统服务" class="hash-link" aria-label="4. 将EMQX注册为系统服务的直接链接" title="4. 将EMQX注册为系统服务的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/systemd/system/emqx.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /etc/systemd/system/emqx.service &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=EMQX Broker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=syslog.target network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=forking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/opt/emqx/bin/emqx start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStop=/opt/emqx/bin/emqx stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecReload=/opt/emqx/bin/emqx restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestartSec=5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置开机自启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启停命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service emqx start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service emqx stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service emqx restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="五集群安装配置">五、集群安装配置<a href="#五集群安装配置" class="hash-link" aria-label="五、集群安装配置的直接链接" title="五、集群安装配置的直接链接">​</a></h2>
<p>假设现在有三台服务器，其主机名和ip分别如下</p>
<table><thead><tr><th>主机名</th><th>IP</th></tr></thead><tbody><tr><td>emqx-01</td><td>192.168.137.101</td></tr><tr><td>emqx-02</td><td>192.168.137.102</td></tr><tr><td>emqx-03</td><td>192.168.137.103</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-测试节点网络">1. 测试节点网络<a href="#1-测试节点网络" class="hash-link" aria-label="1. 测试节点网络的直接链接" title="1. 测试节点网络的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/mria-introduction.html#%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">网络与硬件配置</a></li>
</ul>
<p>修改hosts文件，确保通过域名（主机名）可以相互访问</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.137.101        emqx-01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.137.102        emqx-02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.137.103        emqx-03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴 板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>检查网络互通及延迟情况</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ping -c4 emqx-01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c4 emqx-02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ping -c4 emqx-03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>注意</strong> 官方文档要求各节点之间的延迟不高于10ms，过高的延迟可能造成服务不可用</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-开放服务器端口">2. 开放服务器端口<a href="#2-开放服务器端口" class="hash-link" aria-label="2. 开放服务器端口的直接链接" title="2. 开放服务器端口的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/create-cluster.html#%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83" target="_blank" rel="noopener noreferrer">配置网络环境</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/security.html#%E9%9B%86%E7%BE%A4%E5%86%85%E9%80%9A%E4%BF%A1%E7%AB%AF%E5%8F%A3" target="_blank" rel="noopener noreferrer">集群内通信端口</a></li>
</ul>
<p>为保证集群节点之间的通讯，需要开放以下端口</p>
<table><thead><tr><th>端口</th><th>描述</th></tr></thead><tbody><tr><td>1883</td><td>MQTT监听端口</td></tr><tr><td>8083</td><td>WebSocket监听端口</td></tr><tr><td>18083</td><td>Web控制台端口</td></tr><tr><td>4370</td><td>Erlang 分布式传输端口</td></tr><tr><td>5370</td><td>集群 RPC 端口，适用于物理机环境</td></tr><tr><td>5369</td><td>集群 RPC 端口，适用于 Docker 环境</td></tr></tbody></table>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1883/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=8083/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=18083/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=4370/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=5370/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=5369/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --list-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-时间同步配置">3. 时 间同步配置<a href="#3-时间同步配置" class="hash-link" aria-label="3. 时间同步配置的直接链接" title="3. 时间同步配置的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/mria-introduction.html#%E7%BD%91%E7%BB%9C" target="_blank" rel="noopener noreferrer">网络与硬件配置</a></li>
<li><a href="https://developer.baidu.com/article/details/3291671" target="_blank" rel="noopener noreferrer">CentOS 8时间同步配置详解</a></li>
<li><a href="https://support.ntp.org/" target="_blank" rel="noopener noreferrer">NTP官方网站</a></li>
<li><a href="https://blog.csdn.net/jiangzhehao520/article/details/144028523" target="_blank" rel="noopener noreferrer">国内常见时间服务器</a></li>
<li><a href="https://developer.aliyun.com/article/1547193" target="_blank" rel="noopener noreferrer">Centos7同步时间(阿里云NTP服务为例)</a></li>
</ul>
<p>由于EMQX集群对服务器的网络延迟有严格要求，所以必须保证各节点之间的时间同步正常且延迟低于10ms，如果服务器上没有时间同步配置，需要安装配置chrony，可以参考<a href="https://developer.baidu.com/article/details/3291671" target="_blank" rel="noopener noreferrer">这篇文章</a></p>
<ol>
<li>安装chrony服务</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 检查是否有 ntpd 或 chronyd 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status ntpd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装chrony</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/chrony/timedatex-0.5-3.el8.x86_64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/chrony/chrony-4.1-1.el8.x86_64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/chrony.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>启动并设置开机自启</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 开机自启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>配置chrony</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 修改配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/chrony.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 允许所有客户端同步时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allow all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 上游NTP服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server 210.72.145.44   iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server cn.pool.ntp.org iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server cn.ntp.org.cn   iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 阿里</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pool   ntp.aliyun.com  iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp1.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp2.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp3.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp4.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp5.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp6.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp7.aliyun.com iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/时间同步1-a6169438a2ab1349990aa9abc7db2cab.png" width="1676" height="917" class="img_ev3q"></p>
<ol start="4">
<li>状态检查</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 检查时区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">timedatectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改时区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">timedatectl set-timezone Asia/Shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看时间源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chronyc sources -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看当前时间状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chronyc tracking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 手动同步时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chronyc -a makestep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/时间同步2-afd260a2a94441a45eaacdddabd0da95.png" width="1676" height="916" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-检测时钟回拨">4. 检测时钟回拨<a href="#4-检测时钟回拨" class="hash-link" aria-label="4. 检测时钟回拨的直接链接" title="4. 检测时钟回拨的直接链接">​</a></h3>
<p>时钟回拨会导致Erlang虚拟机退出，在正式部署前可以先执行脚本检测以下，避免正式使用时出现这个问题</p>
<p>实测 <code>5.8.5</code> 版本在时钟回拨会退出程序，可以将EMQX版本退回到 <code>5.0.26</code>，这个版本不会因为时钟回拨而退出</p>
<ol>
<li>监测时钟回拨脚本</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 写入脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; timestamp.sh &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 基础配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR=&quot;$(dirname &quot;$0&quot;)/logs&quot;        # 日志存储目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RETENTION_DAYS=7                      # 日志保留天数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MONITOR_INTERVAL=600                  # 性能监控间隔(秒)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NTP_CHECK_INTERVAL=7200               # NTP检查间隔(秒)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 初始化目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p &quot;$LOG_DIR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 动态日志路径管理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">current_date=$(date +&quot;%Y-%m-%d&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time_log=&quot;${LOG_DIR}/time_info_${current_date}.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error_log=&quot;${LOG_DIR}/time_error_${current_date}.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">perf_log=&quot;${LOG_DIR}/performance_${current_date}.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 初始化跟踪变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_timestamp=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_ntp_check=$(date +%s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_perf_check=$(date +%s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 函数：日志切割检查</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_log_rotation() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local today=$(date +&quot;%Y-%m-%d&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ &quot;$today&quot; != &quot;$current_date&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        current_date=&quot;$today&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_log=&quot;${LOG_DIR}/time_info_${current_date}.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        error_log=&quot;${LOG_DIR}/time_error_${current_date}.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        perf_log=&quot;${LOG_DIR}/performance_${current_date}.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;[INFO] Rotated log files to ${current_date}&quot; &gt;&gt; &quot;$time_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 函数：性能监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">monitor_performance() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local timestamp=$(date +&quot;%Y-%m-%d %H:%M:%S&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local process_stats=$(ps -p $$ -o %cpu,%mem --no-headers | tr -d &#x27; &#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local loadavg=$(awk &#x27;{print $1,$2,$3}&#x27; /proc/loadavg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local mem_info=$(free -m | awk &#x27;/Mem/{printf &quot;%.2f%%&quot;, $3/$2*100}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[PERF] $timestamp | CPU: ${process_stats%%,*}% | MEM: ${process_stats##*,}% | Load: $loadavg | MemUsage: $mem_info&quot; &gt;&gt; &quot;$perf_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 函数：清理旧日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup_old_logs() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    find &quot;$LOG_DIR&quot; -maxdepth 1 -type f \( -name &quot;*.log&quot; \) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -mtime +$RETENTION_DAYS \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -exec rm -fv {} \; &gt;&gt; &quot;$time_log&quot; 2&gt;&amp;1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 函数：NTP状态检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_ntp_status() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 优先检查ntpstat命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if command -v ntpstat &gt;/dev/null 2&gt;&amp;1; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ! ntpstat &gt;/dev/null 2&gt;&amp;1; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            echo &quot;[WARNING] NTP sync abnormal (ntpstat check failed)&quot; &gt;&gt; &quot;$ERROR_LOG_FILE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 次选检查chrony服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    elif systemctl is-active chronyd &gt;/dev/null 2&gt;&amp;1; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ! chronyc tracking &gt;/dev/null 2&gt;&amp;1; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            echo &quot;[WARNING] Chrony sync abnormal (chronyc check failed)&quot; &gt;&gt; &quot;$ERROR_LOG_FILE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 最后检查ntpd服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    elif systemctl is-active ntpd &gt;/dev/null 2&gt;&amp;1; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ntpq -pn | grep -q &#x27;^+&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if [ $? -ne 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            echo &quot;[WARNING] NTPD sync abnormal (no reachable servers)&quot; &gt;&gt; &quot;$ERROR_LOG_FILE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;[WARNING] No NTP service found (chronyd/ntpd not running)&quot; &gt;&gt; &quot;$ERROR_LOG_FILE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 主监控循环</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while true; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now=$(date +%s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ========== 日志切割检查 ==========</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_log_rotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ========== 时间记录与回拨检测 ==========</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    current_time=$(date +&quot;%Y-%m-%d %H:%M:%S.%3N&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now_seconds=$(date +%s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now_millis=$(date +%3N | sed &#x27;s/^0*//&#x27;)  # 移除前导零</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 关键修复：显式声明十进制数值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    current_timestamp=$(( now_seconds * 1000 + 10#$now_millis ))  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[TIME] $current_time&quot; &gt;&gt; &quot;$time_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 时钟回拨检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $last_timestamp -gt 0 ] &amp;&amp; [ $current_timestamp -lt $last_timestamp ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        error_msg=&quot;[ERROR] Clock rollback - ${last_timestamp} - ${current_timestamp} ms | Details: $current_time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;$error_msg&quot; &gt;&gt; &quot;$error_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_timestamp=$current_timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ========== 定期任务调度 ==========</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 性能监控（每10分钟）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $((now - last_perf_check)) -ge $MONITOR_INTERVAL ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        monitor_performance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        last_perf_check=$now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # NTP检查（每2小时）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $((now - last_ntp_check)) -ge $NTP_CHECK_INTERVAL ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check_ntp_status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        last_ntp_check=$now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 修复点：使用字符串比较代替数值比较</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ &quot;$(date +&quot;%H%M&quot;)&quot; = &quot;0005&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cleanup_old_logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sleep 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sleep 0.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>运行脚本，检查日志</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 运行脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x ./timestamp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nohup ./timestamp.sh &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看打印记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -f ./logs/time_info_2025-03-13.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -f ./logs/time_error_2025-03-13.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -f ./logs/performance_2025-03-13.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-试运行emqx">5. 试运行EMQX<a href="#5-试运行emqx" class="hash-link" aria-label="5. 试运行EMQX的直接链接" title="5. 试运行EMQX的直接链接">​</a></h3>
<ol>
<li>下载运行EMQX</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载安装包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># curl https://packages.emqx.net/emqx-ce/v5.0.26/emqx-5.0.26-el8-amd64.rpm -o emqx-5.0.26-el8-amd64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://packages.emqx.net/emqx-ce/v5.0.26/emqx-5.0.26-el8-amd64.tar.gz -o emqx-5.0.26-el8-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /opt/emqx &amp;&amp; tar -zxvf emqx-5.0.26-el8-amd64.tar.gz -C /opt/emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 控制台启动验证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/emqx console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果报错缺少 libatomic.so.1，需要手动安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp /root/lib/libatomic/* root@192.168.137.102:/root/lib/libatomic/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/libatomic/libatomic-8.5.0-4.el8_5.x86_64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>查看EMQX状态</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动停止命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/emqx start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/emqx stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看服务运行状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps -ef | grep emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看集群状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./emqx/bin/emqx ctl cluster status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>将EMQX注册为系统服务</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/systemd/system/emqx.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /etc/systemd/system/emqx.service &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=EMQX Broker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=forking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/opt/emqx/bin/emqx start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStop=/opt/emqx/bin/emqx stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecReload=/opt/emqx/bin/emqx restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RestartSec=5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置开机自启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-集群配置">6. 集群配置<a href="#6-集群配置" class="hash-link" aria-label="6. 集群配置的直接链接" title="6. 集群配置的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/create-cluster.html#%E5%9F%BA%E4%BA%8E-static-%E8%8A%82%E7%82%B9%E5%88%97%E8%A1%A8%E8%87%AA%E5%8A%A8%E9%9B%86%E7%BE%A4" target="_blank" rel="noopener noreferrer">基于 static 节点列表自动集群</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/create-cluster.html#%E5%9F%BA%E4%BA%8E-dns-%E8%87%AA%E5%8A%A8%E9%9B%86%E7%BE%A4" target="_blank" rel="noopener noreferrer">基于 DNS 自动集群</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/v5.8.5/hocon/#V-cluster" target="_blank" rel="noopener noreferrer">配置手册-Cluster</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/lb.html#%E8%8E%B7%E5%8F%96%E7%9C%9F%E5%AE%9E-ip-%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF-tls-%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF" target="_blank" rel="noopener noreferrer">获取真实 IP 和客户端 TSL 证书信息</a>
由于<a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/mria-introduction.html#%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84" target="_blank" rel="noopener noreferrer">开源版本只能部署core集群</a>，所以三个节点 role 都定义为 core，
修改 <code>node.name</code> 为当前节点的ip，设置集群发现策略 <code>discovery_strategy</code> 为 <code>static</code> 以及 节点地址 <code>static.seeds</code></li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 备  份配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ./etc/emqx.conf ./etc/emqx.conf.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim ./etc/emqx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改以下内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;emqx@192.168.137.101&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  autoheal = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  discovery_strategy = static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seeds = [&quot;emqx@192.168.137.101&quot;, &quot;emqx@192.168.137.102&quot;, &quot;emqx@192.168.137.103&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listeners.tcp.default {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind = &quot;0.0.0.0:1883&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max_connections = 102400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_protocol = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /opt/emqx/etc/emqx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /opt/emqx/etc/emqx.conf &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## NOTE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## This config file overrides data/configs/cluster.hocon,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## and is merged with environment variables which start with &#x27;EMQX_&#x27; prefix.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Config changes made from EMQX dashboard UI, management HTTP API, or CLI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## are stored in data/configs/cluster.hocon.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## To avoid confusion, please do not store the same configs in both files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## See https://docs.emqx.com/en/enterprise/v5.0/configuration/configuration.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Configuration full example can be found in emqx.conf.example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;emqx@192.168.137.101&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cookie = &quot;emqxsecretcookie&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data_dir = &quot;data&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = emqxcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  autoheal = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  discovery_strategy = static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seeds = [&quot;emqx@192.168.137.101&quot;, &quot;emqx@192.168.137.102&quot;, &quot;emqx@192.168.137.103&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listeners.tcp.default {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind = &quot;0.0.0.0:1883&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max_connections = 102400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_protocol = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboard {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listeners {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.bind = 18083</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 5.0.26 不能有以下配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # https.bind = 18084</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # https {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #     ssl_options {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #         certfile = &quot;${EMQX_ETC_DIR}/certs/cert.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #         keyfile = &quot;${EMQX_ETC_DIR}/certs/key.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorization {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deny_action = ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  no_match = allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cache = { enable = true }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/集群配置1-0b60e84ec71ace2aeaf277279c2ef694.png" width="1615" height="945" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-启动emqx服务">7. 启动EMQX服务<a href="#7-启动emqx服务" class="hash-link" aria-label="7. 启动EMQX服务的直接链接" title="7. 启动EMQX服务的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/create-cluster.html#%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4" target="_blank" rel="noopener noreferrer">管理集群</a></li>
</ul>
<p>配置完成后启动服务</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y emqx-5.8.5-el8-amd64.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /etc/emqx/emqx.conf /etc/emqx/emqx.conf.bakup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv ./emqx/etc/emqx.conf /etc/emqx/emqx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/emqx/emqx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -f /var/log/emqx/emqx.log.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart emqx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/启动服务1-a7a03677f608b7540e64c0fb12e7b515.png" width="1615" height="945" class="img_ev3q"></p>
<p>访问 <a href="http://192.168.137.101:18083" target="_blank" rel="noopener noreferrer">Dashboard</a></p>
<ul>
<li>账号密码 admin /public
<img decoding="async" loading="lazy" src="/assets/images/启动服务2-52b2773d044da6fefc7da33469cdbac3.png" width="1920" height="922" class="img_ev3q"></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="六验证集群发布与订阅">六、验证集群发布与订阅<a href="#六验证集群发布与订阅" class="hash-link" aria-label="六、验证集群发布与订阅的直接链接" title="六、验证集群发布与订阅的直接链接">​</a></h2>
<ul>
<li><a href="https://blog.csdn.net/ITLWJ/article/details/123999219" target="_blank" rel="noopener noreferrer">中间件系列——EMQX 的集群搭建</a></li>
</ul>
<ol>
<li>
<p>打开MQTTX客户端，连接到集群的各个节点
<img decoding="async" loading="lazy" src="/assets/images/客户端1-6cb9b4202835e137a260d9b3b17c2731.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>每个节点订阅相同的Topic
<img decoding="async" loading="lazy" src="/assets/images/客户端2-60a483b755191efcbeee600a28fa723d.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/客户端3-4a34d479e67830cab2ac51e2b69b8575.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>从一个节点发出测试消息，可以看到三个节点都收到了订阅消息
<img decoding="async" loading="lazy" src="/assets/images/测试订阅1-fd8f22c8adfaa19106dba8b85033f5b3.png" width="1259" height="860" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/测试订阅2-50042eabe4ee2ef0cd37cece20ae72d1.png" width="1259" height="860" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/测试订阅3-96405fd5017999a7a0f0126ff8315921.png" width="1259" height="860" class="img_ev3q"></p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="七nginx网关负载均衡">七、Nginx网关负载均衡<a href="#七nginx网关负载均衡" class="hash-link" aria-label="七、Nginx网关负载均衡的直接链接" title="七、Nginx网关负载均衡的直接链接">​</a></h2>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/lb.html#%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" target="_blank" rel="noopener noreferrer">集群负载均衡</a></li>
<li><a href="https://www.nginx.com/solutions/load-balancing/" target="_blank" rel="noopener noreferrer">Nginx 负载均衡方案介绍</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/lb-nginx.html" target="_blank" rel="noopener noreferrer">Nginx 负载均衡EMQX集群</a></li>
</ul>
<p>负载均衡（Load Balancing）用于均衡多个网络组件的负载，从而优化资源的使用，避免由于组件过载造成故障。负载均衡虽然不是集群中的必备组件，但是能给集群带来一些非常有用的特性，例如当配置在 EMQX 集群中时，将能带来如下优势：</p>
<ul>
<li>均衡 EMQX 的负载，避免出现单节点过载的情况；</li>
<li>简化客户端配置，客户端只需连接到负载均衡器上，无需关心集群内部伸缩变化；</li>
<li>TLS/SSL 终结，减轻 EMQX 集群的负担；</li>
<li>提高安全性，有了负载均衡在集群前端，能够通过设置阻止不需要的流量，保护 EMQX 集群免受恶意攻击。</li>
</ul>
<p>本节我们选择用 Nginx 来作为 EMQX 集群的网关，最终搭建的效果如下所示：
<img decoding="async" loading="lazy" src="/assets/images/负载均衡1-ed819ffe1cccdc58ed1f3fcb14adbb98.png" width="685" height="261" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-环境准备">1. 环境准备<a href="#1-环境准备" class="hash-link" aria-label="1. 环境准备的直接链接" title="1. 环境准备的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-安装编译依赖库">1. 安装编译依赖库<a href="#1-安装编译依赖库" class="hash-link" aria-label="1. 安装编译依赖库的直接链接" title="1. 安装编译依赖库的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装nginx必备依赖库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y gcc glibc-devel pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载依赖包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/make make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/gcc gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/glibc-devel glibc-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/pcre pcre</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/pcre-devel pcre-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/zlib zlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/zlib-devel zlib-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/openssl openssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yumdownloader --resolve --destdir=/root/lib/nginx/openssl-devel openssl-devel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/make/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/gcc/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/glibc-devel/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/pcre/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/pcre-devel/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/zlib/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/zlib-devel/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/openssl/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh /root/lib/nginx/openssl-devel/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-开放代理所需端口">2. 开放代理所需端口<a href="#2-开放代理所需端口" class="hash-link" aria-label="2. 开放代理所需端口的直接链接" title="2. 开放代理所需端口的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=443/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1883/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=8883/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1080/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1443/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --list-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th>端口</th><th>描述</th></tr></thead><tbody><tr><td>80</td><td>Nginx HTTP端口</td></tr><tr><td>443</td><td>Nginx HTTPS端口</td></tr><tr><td>1883</td><td>反向代理 MQTT端口</td></tr><tr><td>8883</td><td>反向代理 MQTT SSL端口</td></tr><tr><td>1080</td><td>反向代理 MQTT WebSocket端口</td></tr><tr><td>1443</td><td>反向代理 MQTT WebSocket SSL端口</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-下载安装nginx">2. 下载安装Nginx<a href="#2-下载安装nginx" class="hash-link" aria-label="2. 下载安装Nginx的直接链接" title="2. 下载安装Nginx的直接链接">​</a></h3>
<ul>
<li><a href="https://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">Nginx官网下载</a></li>
<li><a href="https://blog.csdn.net/A_art_xiang/article/details/133012260" target="_blank" rel="noopener noreferrer">Nginx手动编译、安装超超详解</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-下载">1. 下载<a href="#1-下载" class="hash-link" aria-label="1. 下载的直接链接" title="1. 下载的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://nginx.org/download/nginx-1.26.3.tar.gz -o  nginx-1.26.3.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf nginx-1.26.3.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd nginx-1.26.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-编译配置">2. 编译配置<a href="#2-编译配置" class="hash-link" aria-label="2. 编译配置的直接链接" title="2. 编译配置的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看configure 支持的参数，其中包含指定某些路径、开启某些模块、编译中特殊参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure --help | more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编译配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-threads \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-http_stub_status_module \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-http_ssl_module \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-http_realip_module \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-stream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-stream_ssl_module \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --prefix=/usr/local/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出各种文件的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Configuration summary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + using threads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + using system PCRE2 library</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + using system OpenSSL library</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + using system zlib library</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx path prefix: &quot;/usr/local/nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx modules path: &quot;/usr/local/nginx/modules&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx http access log file: &quot;/usr/local/nginx/logs/access.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx http client request body temporary files: &quot;client_body_temp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx http proxy temporary files: &quot;proxy_temp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx http scgi temporary files: &quot;scgi_temp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>--with-http_ssl_module</code> 参数用于添加 SSL 功能支持，</li>
<li><code>--with-stream</code> 与 <code>--with-stream_ssl_module</code> 参数用于添加 TCP 反向代理支持</li>
<li><code>--prefix=/nginx</code> 指定安装目录</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-安装">3. 安装<a href="#3-安装" class="hash-link" aria-label="3. 安装的直接链接" title="3. 安装的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make install </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建 Nginx 用户和组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">groupadd -r nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">useradd -s /sbin/nologin -r -g nginx nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-将nginx注册为服务">4. 将Nginx注册为服务<a href="#4-将nginx注册为服务" class="hash-link" aria-label="4. 将Nginx注册为服务的直接链接" title="4. 将Nginx注册为服务的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /etc/systemd/system/nginx.service &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=The Nginx HTTP and reverse proxy server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=forking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecReload=/bin/kill -s HUP $MAINPID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStop=/bin/kill -s QUIT $MAINPID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PrivateTmp=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-启动服务并设置开机自启">5. 启动服务并设置开机自启<a href="#5-启动服务并设置开机自启" class="hash-link" aria-label="5. 启动服务并设置开机自启的直接链接" title="5. 启动服务并设置开机自启的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service nginx start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service nginx stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service nginx status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 开机自启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-前端页面访问">6. 前端页面访问<a href="#6-前端页面访问" class="hash-link" aria-label="6. 前端页面访问的直接链接" title="6. 前端页面访问的直接链接">​</a></h4>
<ol>
<li>
<p>浏览器打开网页 <code>http://192.168.137.110</code>
<img decoding="async" loading="lazy" src="/assets/images/Nginx1-21787d5f72085baf4294f816622b3ddc.png" width="1385" height="519" class="img_ev3q"></p>
</li>
<li>
<p>在 <code>nginx.conf</code> 中加入监控配置</p>
</li>
</ol>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># NGINX 状态监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location /stats {            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stub_status on;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  access_log off;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>浏览器打开网页 <code>http://192.168.137.110/stats</code>
<img decoding="async" loading="lazy" src="/assets/images/Nginx2-af57fbd750cec4740d276b2808aa38a8.png" width="1466" height="681" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-配置nginx">3. 配置Nginx<a href="#3-配置nginx" class="hash-link" aria-label="3. 配置Nginx的直接链接" title="3. 配置Nginx的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/lb-nginx.html#%E9%85%8D%E7%BD%AE-mqtt-%E7%B2%98%E6%80%A7-sticky-%E4%BC%9A%E8%AF%9D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" target="_blank" rel="noopener noreferrer">配置 MQTT 粘性（Sticky）会话负载均衡</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-创建配置文件夹生成ssl证书">1. 创建配置文件夹，生成SSL证书<a href="#1-创建配置文件夹生成ssl证书" class="hash-link" aria-label="1. 创建配置文件夹，生成SSL证书的直接链接" title="1. 创建配置文件夹，生成SSL证书的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /usr/local/nginx/{conf.d,stream,certs}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /usr/local/nginx/certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成私钥，需要输入密码 123456</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -des3 -out emqx.pass.key 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除私钥中的密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl rsa -in emqx.pass.key -out emqx.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -new -key emqx.key -out emqx.csr -subj &quot;/C=CN/ST=Shanghai/L=Shanghai/O=PISX/OU=Diginn/CN=*.example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -req -days 3650 -in emqx.csr -signkey emqx.key -out emqx.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-主配置文件-nginxconf">2. 主配置文件 <code>nginx.conf</code><a href="#2-主配置文件-nginxconf" class="hash-link" aria-label="2-主配置文件-nginxconf的直接链接" title="2-主配置文件-nginxconf的直接链接">​</a></h4>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#user  nobody;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_processes  1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#error_log  logs/error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#error_log  logs/error.log  notice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#error_log  logs/error.log  info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#pid        logs/nginx.pid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">events {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker_connections  1024;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">http {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include       mime.types;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_type  application/octet-stream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #access_log  logs/access.log  main;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sendfile        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #tcp_nopush     on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #keepalive_timeout  0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keepalive_timeout  65;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listen       80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server_name  localhost;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #charset koi8-r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #access_log  logs/host.access.log  main;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            root   html;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            index  index.html index.htm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # NGINX 状态监控</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location /stats {            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          stub_status on;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          access_log off;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #error_page  404              /404.html;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # redirect server error pages to the static page /50x.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        error_page   500 502 503 504  /50x.html;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location = /50x.html {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            root   html;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include /usr/local/nginx/conf.d/*.conf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_format  proxy &#x27;$remote_addr - [$time_local] &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 &#x27;$protocol $status $bytes_sent $bytes_received &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 &#x27;$session_time - &quot;$upstream_addr&quot; &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 &#x27;&quot;$upstream_bytes_sent&quot; &quot;$upstream_bytes_received&quot; &quot;$upstream_connect_time&quot;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  access_log  logs/tcp_access.log proxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  error_log   logs/tcp_error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 引入 stream 配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  include     /usr/local/nginx/stream.d/*.conf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-mqtt协议配置文件-usrlocalnginxstreammqttconf">3. MQTT协议配置文件 <code>/usr/local/nginx/stream/mqtt.conf</code><a href="#3-mqtt协议配置文件-usrlocalnginxstreammqttconf" class="hash-link" aria-label="3-mqtt协议配置文件-usrlocalnginxstreammqttconf的直接链接" title="3-mqtt协议配置文件-usrlocalnginxstreammqttconf的直接链接">​</a></h4>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">upstream emqx_servers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 192.168.137.101:1883;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 192.168.137.102:1883;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 192.168.137.103:1883;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  listen                1883;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_pass            emqx_servers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 启用此项时，对应后端监听器也需要启用 proxy_protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_protocol        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_connect_timeout 10s;   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 默认心跳时间为 10 分钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_timeout         60s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_buffer_size     3M;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcp_nodelay           on;       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  listen 8883 ssl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_session_cache     shared:TCPSSL:10m;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_session_timeout   10m;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_certificate       /usr/local/nginx/certs/emqx.pem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_certificate_key   /usr/local/nginx/certs/emqx.key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_verify_depth      2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_protocols         TLSv1 TLSv1.1 TLSv1.2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_ciphers           HIGH:!aNULL:!MD5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 添加 CA 证书及开启验证客户端证书参数即可启用双向认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ssl_client_certificate /usr/local/NGINX/certs/ca.pem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ssl_verify_client on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ssl_verify_depth 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_pass            emqx_servers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 启用此项时，对应后端监听器也需要启用 proxy_protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_protocol        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_connect_timeout 10s;   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 默认心跳时间为 10 分钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_timeout         1800s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_buffer_size     3M;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcp_nodelay           on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-websocket协议配置文件-usrlocalnginxconfdwebsocketconf">4. WebSocket协议配置文件 <code>/usr/local/nginx/conf.d/websocket.conf</code><a href="#4-websocket协议配置文件-usrlocalnginxconfdwebsocketconf" class="hash-link" aria-label="4-websocket协议配置文件-usrlocalnginxconfdwebsocketconf的直接链接" title="4-websocket协议配置文件-usrlocalnginxconfdwebsocketconf的直接链接">​</a></h4>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">upstream emqx_websocket_servers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 192.168.137.101:8083;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 192.168.137.102:8083;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 192.168.137.103:8083;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  listen                1080;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server_name           mqtt.example.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location /mqtt {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_pass            http://emqx_websocket_servers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_http_version    1.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      Upgrade $http_upgrade;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      Connection &quot;Upgrade&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 禁用缓存             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_buffering       off;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_connect_timeout 10s;        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # WebSocket 连接有效时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 在该时间内没有数据交互的话 WebSocket 连接会自动断开，默认为 60s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_send_timeout    3600s;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_read_timeout    3600s;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 反向代理真实 IP            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      Host $host;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      X-Real-IP $remote_addr;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      REMOTE-HOST $remote_addr;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  listen 1443           ssl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server_name           mqtt.example.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_session_cache     shared:SSL:10m;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_session_timeout   10m;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_certificate       /usr/local/nginx/certs/emqx.pem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_certificate_key   /usr/local/nginx/certs/emqx.key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_protocols         TLSv1 TLSv1.1 TLSv1.2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssl_ciphers           HIGH:!aNULL:!MD5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 添加 CA 证书及开启验证客户端证书参数即可启用双向认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ssl_client_certificate /usr/local/NGINX/certs/ca.pem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ssl_verify_client on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location /mqtt {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_pass            http://emqx_websocket_servers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_http_version    1.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      Upgrade $http_upgrade;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      Connection &quot;Upgrade&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 禁用缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_buffering       off;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_connect_timeout 10s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # WebSocket 连接有效时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 在该时间内没有数据交互的话 WebSocket 连接会自动断开，默认为 60s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_send_timeout    3600s;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_read_timeout    3600s;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 反向代理真实 IP            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      Host $host;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      X-Real-IP $remote_addr;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      REMOTE-HOST $remote_addr;            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-重启服务">5. 重启服务<a href="#5-重启服务" class="hash-link" aria-label="5. 重启服务的直接链接" title="5. 重启服务的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 检测配置文件是否正常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/nginx/sbin/nginx -t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启Nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service nginx restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-验证负载均衡">4. 验证负载均衡<a href="#4-验证负载均衡" class="hash-link" aria-label="4. 验证负载均衡的直接链接" title="4. 验证负载均衡的直接链接">​</a></h3>
<ol>
<li>
<p>使用MQTTX启动四个客户端，分别连接到 Nginx 1883 8883 1080 1443端口
<img decoding="async" loading="lazy" src="/assets/images/负载均衡2-314184c3aa087417ce6101129813a7cc.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡3-ae2d3239908e939be09cd43baa578c01.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡4-34864fd6936ce36e3e6a0e90642766a1.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡5-c2b357941fc077387c906f8a6432d273.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡6-65b805b4aca07b62b24cf7cb345e8a70.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>可以看到，四个连接分别路由到了 101 102 103
<img decoding="async" loading="lazy" src="/assets/images/负载均衡7-eedd5a9f99ff200cc8e5288f53e1e830.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡8-28ca90732e874b1c53220b43b5143850.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡9-008a8a300596d96ae06bbe3f71615953.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡10-75c8f397d79f4486449087a86292472b.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>订阅和Topic情况如下
<img decoding="async" loading="lazy" src="/assets/images/负载均衡11-fb8c42860020530cc9efc0138cc4459e.png" width="1920" height="922" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/负载均衡12-85359249832481966725273f3eb7e218.png" width="1920" height="922" class="img_ev3q"></p>
</li>
<li>
<p>发送一条测试消息，四个客户端都正常收到
<img decoding="async" loading="lazy" src="/assets/images/负载均衡13-6e84095a8d45b95d89dd5cb119502873.png" width="1264" height="865" class="img_ev3q"></p>
</li>
</ol>
<p><strong>注意</strong> 由于使用的是自签名证书，使用 <code>mqtts</code> <code>wss</code>连接时需要单独配置证书信息</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="八haproxy负载均衡">八、HAProxy负载均衡<a href="#八haproxy负载均衡" class="hash-link" aria-label="八、HAProxy负载均衡的直接链接" title="八、HAProxy负载均衡的直接链接">​</a></h2>
<ul>
<li><a href="https://blog.csdn.net/xjstddj/article/details/143100075" target="_blank" rel="noopener noreferrer">【部署篇】Haproxy-01安装部署（源码方式安装）</a></li>
<li><a href="https://blog.csdn.net/wjw465150/article/details/128948882" target="_blank" rel="noopener noreferrer">CentOS(7,8)上编译安装HaProxy2</a></li>
<li><a href="https://www.cnblogs.com/gmhappy/p/11864112.html" target="_blank" rel="noopener noreferrer">mqtt 分布集群搭建</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-环境准备-1">1. 环境准备<a href="#1-环境准备-1" class="hash-link" aria-label="1. 环境准备的直接链接" title="1. 环境准备的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-安装lua运行环境">1. 安装Lua运行环境<a href="#1-安装lua运行环境" class="hash-link" aria-label="1. 安装Lua运行环境的直接链接" title="1. 安装Lua运行环境的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://www.lua.org/ftp/lua-5.4.7.tar.gz -o lua-5.4.7.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf lua-5.4.7.tar.gz -C /usr/local/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /usr/local/lua-5.4.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make linux test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src/lua -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-修改系统配置">2. 修改系统配置<a href="#2-修改系统配置" class="hash-link" aria-label="2. 修改系统配置的直接链接" title="2. 修改系统配置的直接链接">​</a></h4>
<ol>
<li>修改进程句柄限制</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/security/limits.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 打开 /etc/security/limits.conf 文件，最后面追加:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*               soft    nofile  120000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*               hard    nofile  120000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*               soft    nproc   120000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*               hard    nproc   120000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>修改系统配置文件</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/sysctl.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 打开 /etc/sysctl.conf 文件，最后面追加:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_tw_reuse = 1    # 表示开启重用.允许将TIME-WAIT sockets重新用于新的TCP连接,默认为0,表示关闭;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_tw_recycle = 1  # 表示开启TCP连接中TIME-WAIT sockets的快速回收,默认为0,表示关闭.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_syncookies=1    # 表示开启SYN Cookies.当出现SYN等待队列溢出时,启用cookies来处理,可防范少量SYN攻击,默认为0,表示关闭;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.conf.all.rp_filter = 1  # 过滤反向路由不通的数据包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.ip_local_port_range = 1024 65535  # 表示用于向外连接的端口范围.缺省情况下很小:32768到61000,改为1024到65000.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_max_syn_backlog = 50000  # 记录的那些尚未收到客户端确认信息的连接请求的最大值,可以容纳更多等待连接的网络连接数. 对于有128M内存的系统而言,缺省值是1024,小内存的系统则是128.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_max_tw_buckets = 400000  #timewait的数量,默认是180000.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_max_orphans = 60000  # 系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上.如果超过这个数字,孤儿连接将即刻被复位并打印出警告信息.这个限制仅仅是为了防止简单的DoS攻击,不能过分依靠它或者人为地减小这个值,更应该增加这个值(如果增加了内存之后).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_synack_retries = 3  # 为了打开对端的连接,内核需要发送一个SYN并附带一个回应前面一个SYN的ACK.也就是所谓三次握手中的第二次握手.这个设置决定了内核放弃连接之前发送SYN+ACK包的数量.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.somaxconn = 50000     # web应用中listen函数的backlog默认会给我们内核参数的net.core.somaxconn限制到128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.rmem_max = 16777216  # 系统套接字缓冲区(读), 包含三个整数值，分别是：min，default，max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.wmem_max = 16777216  # 系统套接字缓冲区(写), 包含三个整数值，分别是：min，default，max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_rmem = 4096 87380 16777216  # TCP接收／发送缓冲区(读)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_wmem = 4096 65536 16777216  # TCP接收／发送缓冲区(写)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_no_metrics_save = 1  # 使metrics不保存每个单独的数据包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_moderate_rcvbuf = 1  # 表示打开了TCP内存自动调整功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.netdev_max_backlog = 50000 # 每个网络接口接收数据包的速率比内核处理这些包的速率快时,允许送到队列的数据包的最大数目.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fs.file-max=2048000  # 表示系统级别的能够打开的文件句柄①的数量.是对整个系统的限制,并不是针对用户  的.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>
<p>执行 <code>sysctl -p</code> 命令操作来使我们所做的变更生效.</p>
</li>
<li>
<p>开放端口</p>
</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=8888/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1883/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=8883/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1080/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --zone=public --add-port=1443/tcp --permanent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall-cmd --list-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th>端口</th><th>描述</th></tr></thead><tbody><tr><td>8888</td><td>HAProxy 监控端口</td></tr><tr><td>1883</td><td>反向代理 MQTT端口</td></tr><tr><td>8883</td><td>反向代理 MQTT SSL端口</td></tr><tr><td>1080</td><td>反向代理 MQTT WebSocket端口</td></tr><tr><td>1443</td><td>反向代理 MQTT WebSocket SSL端口</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-下载安装">2. 下载安装<a href="#2-下载安装" class="hash-link" aria-label="2. 下载安装的直接链接" title="2. 下载安装的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-下载解压">1. 下载解压<a href="#1-下载解压" class="hash-link" aria-label="1. 下载解压的直接链接" title="1. 下载解压的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://www.haproxy.org/download/3.1/src/haproxy-3.1.5.tar.gz -o haproxy-3.1.5.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -zxvf haproxy-3.1.5.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd haproxy-3.1.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看安装方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">less INSTALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">less Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-编译安装">2. 编译安装<a href="#2-编译安装" class="hash-link" aria-label="2. 编译安装的直接链接" title="2. 编译安装的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make clean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_CPU_AFFINITY=1 USE_LUA=1 LUA_INC=/usr/local/lua-5.4.7/src/ LUA_LIB=/usr/local/lua-5.4.7/src/ PREFIX=/usr/local/haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make install PREFIX=/usr/local/haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看目录结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tree /usr/local/haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/haproxy/sbin/haproxy -V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建配置目录 日志目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /usr/local/haproxy/{conf,conf.d,logs,certs}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将Nginx证书 key合成一个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /usr/local/nginx/certs/emqx.pem /usr/local/nginx/certs/emqx.key &gt; /usr/local/haproxy/certs/server.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-配置haproxy">3. 配置HAProxy<a href="#3-配置haproxy" class="hash-link" aria-label="3. 配置HAProxy的直接链接" title="3. 配置HAProxy的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-主配置文件">1. 主配置文件<a href="#1-主配置文件" class="hash-link" aria-label="1. 主配置文件的直接链接" title="1. 主配置文件的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /usr/local/haproxy/conf/haproxy.cfg &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">global  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log 127.0.0.1 local3 info </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  daemon  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  maxconn 10000  # FD limit = maxconn * 2 + 18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">defaults  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log global </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option tcplog </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #option dontlognull  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout connect 10000 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # timeout &gt; mqtt&#x27;s keepalive * 1.2  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout client 240s  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout server 240s </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  maxconn 20000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind *:8888               # 监控访问端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stats enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stats uri /stats          # 监控访问路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stats hide-version        # 隐藏版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stats refresh 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stats realm HAProxy Manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stats auth  admin:123456  # 设置管理员帐号和密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log 127.0.0.1 local3 err  # [err warning info debug]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-mqtt协议配置">2. mqtt协议配置<a href="#2-mqtt协议配置" class="hash-link" aria-label="2. mqtt协议配置的直接链接" title="2. mqtt协议配置的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /usr/local/haproxy/conf.d/mqtt.cfg &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend mqtt_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 创建粘性会话表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stick-table type string len 32 size 100k expire 30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 使用客户端 ID 作为键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stick on req.payload(0,0), mqtt_field_value(connect,client_identifier)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 增加 send-proxy 会把真实带给 EMQX，对应后端监听器需要启用 proxy_protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # server emqx1 emqx1-cluster.emqx.io:1883 check send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx1 192.168.137.101:1883 check send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx2 192.168.137.102:1883 check send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx3 192.168.137.103:1883 check send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend mqtt_frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind *:1883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 等待缓冲区填满，以便解析 MQTT 报文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcp-request inspect-delay 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 拒绝非 MQTT 连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcp-request content reject unless { req.payload(0,0), mqtt_is_valid }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_backend mqtt_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend mqtt_tls_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  balance roundrobin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # 增加 send-proxy 会把真实 IP 带给 EMQX，对应后端监听器需要启用 proxy_protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx1 192.168.137.101:1883 check-send-proxy send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx2 192.168.137.102:1883 check-send-proxy send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx3 192.168.137.103:1883 check-send-proxy send-proxy-v2-ssl-cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend mqtt_tls_frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind *:8883 ssl crt /usr/local/haproxy/certs/server.pem </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 双向认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # bind *:8883 ssl ca-file /etc/haproxy/certs/cacert.pem crt /etc/haproxy/certs/server.pem verify required</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_backend mqtt_tls_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-websocket协议配置">3. websocket协议配置<a href="#3-websocket协议配置" class="hash-link" aria-label="3. websocket协议配置的直接链接" title="3. websocket协议配置的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /usr/local/haproxy/conf.d/websocket.cfg &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend mqtt_ws_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  balance roundrobin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx1 192.168.137.101:8083 check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx2 192.168.137.102:8083 check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx3 192.168.137.103:8083 check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend mqtt_ws_frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind *:1080 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_backend mqtt_ws_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend mqtt_ws_tls_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  balance roundrobin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx1 192.168.137.101:8083 check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx2 192.168.137.102:8083 check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server emqx3 192.168.137.103:8083 check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend mqtt_ws_tls_frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind *:1443 ssl crt /usr/local/haproxy/certs/server.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode tcp </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_backend mqtt_ws_tls_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-注册运行">4. 注册运行<a href="#4-注册运行" class="hash-link" aria-label="4. 注册运行的直接链接" title="4. 注册运行的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-将haproxy注册为服务">1. 将HAProxy注册为服务<a href="#1-将haproxy注册为服务" class="hash-link" aria-label="1. 将HAProxy注册为服务的直接链接" title="1. 将HAProxy注册为服务的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /usr/lib/systemd/system/haproxy.service &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=HAProxy Load Balancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=syslog.target network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 支持多配置文件读取，类似于从侧面是实现配置文件的include功能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStartPre=/usr/local/haproxy/sbin/haproxy  -f /usr/local/haproxy/conf/haproxy.cfg -f /usr/local/haproxy/conf.d -c -q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/local/haproxy/sbin/haproxy -Ws -f /usr/local/haproxy/conf/haproxy.cfg -f /usr/local/haproxy/conf.d -p /usr/local/haproxy/logs/haproxy.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecReload=/bin/kill -USR2 $MAINPID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LimitNOFILE=100000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-运行">2. 运行<a href="#2-运行" class="hash-link" aria-label="2. 运行的直接链接" title="2. 运行的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">service haproxy start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service haproxy stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service haproxy status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable haproxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-访问">3. 访问<a href="#3-访问" class="hash-link" aria-label="3. 访问的直接链接" title="3. 访问的直接链接">​</a></h4>
<p>浏览器打开<a href="http://192.168.137.110:8888/stats" target="_blank" rel="noopener noreferrer">监控面板</a></p>
<ul>
<li>账号密码 admin / 123456</li>
</ul>
<p><img decoding="async" loading="lazy" src="/assets/images/HAProxy1-e631df78220cb4611276e9ccd3d9a330.png" width="1920" height="922" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="九集群网关对比">九、集群网关对比<a href="#九集群 网关对比" class="hash-link" aria-label="九、集群网关对比的直接链接" title="九、集群网关对比的直接链接">​</a></h2>
<ul>
<li><a href="https://developer.aliyun.com/article/1592511" target="_blank" rel="noopener noreferrer">HAProxy 与 NGINX：全面比较</a></li>
<li><a href="https://www.haproxy.com/documentation/haproxy-enterprise/administration/high-availability/active-standby/" target="_blank" rel="noopener noreferrer">HAProxy 高可用</a></li>
</ul>
<p>经过测试，两种网关都能实现EMQX集群节点断开后的自动重连；但是对于已订阅的Topic都不会重新订阅，需要在重连后重新订阅Topic，否则客户端无法收到消息。</p>
<p>Topic订阅属于客户端自身的行为，需要在客户端实现重连之后重新订阅Topic。</p>
<p>相对来说：</p>
<ul>
<li>Nginx 拥有更多的用户，更完善的社区文档，上手门槛更低，但是对于MQTT的支持较弱。</li>
<li>HAProxy 在性能以及高可用上更胜一筹，对MQTT的支持也更好，但是相对用户量少，门槛更高，运维成本高。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十其他问题">十、其他问题<a href="#十其他问题" class="hash-link" aria-label="十、其他问题的直接链接" title="十、其他问题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-共享订阅">1. 共享订阅<a href="#1-共享订阅" class="hash-link" aria-label="1. 共享订阅的直接链接" title="1. 共享订阅的直接链接">​</a></h3>
<ul>
<li><a href="https://www.emqx.com/zh/blog/introduction-to-mqtt5-protocol-shared-subscription" target="_blank" rel="noopener noreferrer">共享订阅 - MQTT 5.0 新特性</a></li>
<li><a href="https://www.emqx.io/docs/zh/v5.0/messaging/mqtt-concepts.html#%E5%85%B1%E4%BA%AB%E8%AE%A2%E9%98%85" target="_blank" rel="noopener noreferrer">MQTT核心概念-共享订阅</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/v5.0/mqtt/mqtt-shared-subscription.html" target="_blank" rel="noopener noreferrer">MQTT高级特性-共享订阅</a></li>
<li><a href="https://www.emqx.io/docs/en/v4.4/advanced/shared-subscriptions.html#shared-subscription" target="_blank" rel="noopener noreferrer">不带组别的共享订阅</a></li>
<li><a href="https://docs.emqx.com/zh/emqx/v5.0/configuration/configuration-manual.html#%E5%85%B1%E4%BA%AB%E8%AE%A2%E9%98%85" target="_blank" rel="noopener noreferrer">共享订阅配置参数</a></li>
</ul>
<p>在不使用共享订阅时，每个客户端都会收到全量的消息，造成消息的重复消费，同时也会导致客户端消息处理能力的下降。</p>
<p>MQTT在5.0之后新增了共享订阅特性，很好的避免了这个问题，使用共享订阅，可以实现在扩展客户端的同时，充分利用每个客户端的消息处理能力，同时也避免了消息的重复消费</p>
<p>共享订阅在EMQX中时默认开启的，只需要在订阅topic时添加对应的前缀即可实现，Web配置位置如下图所示
<img decoding="async" loading="lazy" src="/assets/images/共享订阅7-ae4bff63db011e28ba8dd9fcc5fdbfee.png" width="1920" height="922" class="img_ev3q"></p>
<table><thead><tr><th>示例</th><th>前缀</th><th>组别</th><th>topic</th></tr></thead><tbody><tr><td><code>$share/{ShareName}/{topic-name}</code></td><td><code>$share</code></td><td><code>{ShareName}</code></td><td><code>{topic-name}</code></td></tr><tr><td><code>$share/pisx/A2-F1/电压表</code></td><td><code>$share</code></td><td><code>lux</code></td><td><code>A2-F1/电压表</code></td></tr><tr><td><code>$share/yunyi/01_混配/1#罐流量计</code></td><td><code>$share</code></td><td><code>yunyi</code></td><td><code>01_混配/1#罐流量计</code></td></tr><tr><td><code>$queue/01_混配/1#罐流量计</code></td><td><code>$queue</code></td><td>-</td><td><code>01_混配/1#罐流量计</code></td></tr></tbody></table>
<p>Note: 除了使用<code>$share/&lt;group-name&gt;</code> 这种共享订阅方式之外，EMQX还提供了不带组别的共享订阅 <code>$queue</code>，详情见<a href="https://www.emqx.io/docs/en/v4.4/advanced/shared-subscriptions.html#shared-subscription" target="_blank" rel="noopener noreferrer">不带组别的共享订阅</a></p>
<ol>
<li>
<p>四个客户端连接到集群，分别采用相同的共享订阅前缀订阅 topic <code>testtopic</code>，带前缀的topic地址为 <code>$share/pisx/testtopic</code></p>
</li>
<li>
<p>其中一个客户端向 topic <code>testtopic</code> 发送消息，可以看到只有一个客户端收到消息
<img decoding="async" loading="lazy" src="/assets/images/共享订阅1-c290f66f15f427083c5b6715c78fd21a.png" width="1264" height="865" class="img_ev3q"></p>
</li>
<li>
<p>再次发送消息，仍然是一个客户端收到消息
<img decoding="async" loading="lazy" src="/assets/images/共享订阅2-d5fe741f3791718d83e0a8babee758a6.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/共享订阅3-e9ca07b1f166a6941a32084e737843d3.png" width="1264" height="865" class="img_ev3q"></p>
</li>
<li>
<p>继续发送，剩余的两个客户端也分别收到了消息
<img decoding="async" loading="lazy" src="/assets/images/共享订阅4-68adae45fc6ef53d25aa48438ab5b568.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/共享订阅5-e162da4453edefdda4019cac0b94fe79.png" width="1264" height="865" class="img_ev3q">
<img decoding="async" loading="lazy" src="/assets/images/共享订阅6-d4aa3e19964d9339f2c993f1f9df618e.png" width="1264" height="865" class="img_ev3q"></p>
</li>
</ol>
<p>共享订阅有多种策略，默认的策略为随机，具体配置项见<a href="https://docs.emqx.com/zh/emqx/v5.0/configuration/configuration-manual.html#%E5%85%B1%E4%BA%AB%E8%AE%A2%E9%98%85" target="_blank" rel="noopener noreferrer">共享订阅配置参数</a>
<img decoding="async" loading="lazy" src="/assets/images/共享订阅8-bd9a3c34cfb82937786d2a54e75b79ee.png" width="1920" height="922" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-客户端断开重连丢失已订阅topic">2. 客户端断开重连丢失已订阅Topic<a href="#2-客户端断开重连丢失已订阅topic" class="hash-link" aria-label="2. 客户端断开重连丢失已订阅Topic的直接链接" title="2. 客户端断开重连丢失已订阅Topic的直接链接">​</a></h3>
<p>搭建EMQX集群是为了实现EMQX服务的高可用，需要考虑部分服务端节点意外中断的场景，在此场景下，使用Nginx或者HAProxy可以实现客户端的自动重连，对服务端的切换无感，但是由于消息订阅属于客户端的行为，集群并不能保证连接到新的节点时自动订阅相同的Topic。</p>
<p>经测试，目前平台在订阅消息后缓存当前客户端所有的Topic，重连时继续重新订阅这些Topic可以达到此目的，无需额外的开发工作，注意配置即可</p>
<p>订阅断开时会抛出异常，在异常处理中执行重新连接逻辑
<img decoding="async" loading="lazy" src="/assets/images/断开重连1-8ad15b7430190a8599539a7a814c2c5d.png" width="1920" height="1030" class="img_ev3q"></p>
<p>重连成功后再次订阅之前缓存的Topic
<img decoding="async" loading="lazy" src="/assets/images/断开重连2-260897bf4fb9c2ca1bd6d77b067ee784.png" width="1920" height="1030" class="img_ev3q"></p>
<p>但是由于 断开 - 重连 - 重新订阅 这个过程会消耗一定的时间，在这个过程中可能会有部分点位数据的丢失，这个时间间隔大约为 15s。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十一常见问题">十一、常见问题<a href="#十一常见问题" class="hash-link" aria-label="十一、常见问题的直接链接" title="十一、常见问题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-服务启动失败">1. 服务启动失败<a href="#1-服务启动失败" class="hash-link" aria-label="1. 服务启动失败的直接链接" title="1. 服务启动失败的直接链接">​</a></h3>
<p>使用 <code>emqx console</code> 命令启动，可以看到命令行打印如下日志</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@emqx-01 emqx]# ./bin/emqx console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Default (insecure) Erlang cookie is in use.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Configure node.cookie in /opt/emqx/etc/emqx.conf or override from environment variable EMQX_NODE__COOKIE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: NOTE: Use the same cookie for all nodes in the cluster.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel pid terminated (application_controller) (&quot;{application_start_failure,kernel,{{shutdown,{failed_to_start_child,on_load,{on_load_function_failed,quicer_nif,{error,{load_failed,\&quot;Failed to load NIF library /opt/emqx/lib/quicer-0.1.11/priv/libquicer_nif: &#x27;libatomic.so.1: cannot open shared object file: No such file or directory&#x27;\&quot;}}}}},{kernel,start,[normal,[]]}}}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Crash dump is being written to: /opt/emqx/log/erl_crash.dump...done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方法">解决方法<a href="#解决方法" class="hash-link" aria-label="解决方法的直接链接" title="解决方法的直接链接">​</a></h4>
<p>关于此错误，可以参考<a href="https://askemq.com/t/topic/8606" target="_blank" rel="noopener noreferrer">这个问题</a></p>
<p>此类异常通常是缺少依赖包，此处是缺少 <code>libatomic</code>，安装后再次运行即可</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y libatomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-服务启动后过几分钟回自动停止">2. 服务启动后过几分钟回自动停止<a href="#2-服务启动后过几分钟回自动停止" class="hash-link" aria-label="2. 服务启动后过几分钟回自动停止的直接链接" title="2. 服务启动后过几分钟回自动停止的直接链接">​</a></h3>
<p>使用 <code>emqx console</code> 命令启动，可以看到命令行打印如下日志</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@emqx-01 emqx]# ./bin/emqx console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Default (insecure) Erlang cookie is in use.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Configure node.cookie in /opt/emqx/etc/emqx.conf or override from environment variable EMQX_NODE__COOKIE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: NOTE: Use the same cookie for all nodes in the cluster.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP 26 [erts-14.2.5.2] [emqx] [64-bit] [smp:4:4] [ds:4:4:8] [async-threads:4] [jit:ns]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listener tcp:default on 0.0.0.0:1883 started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listener ssl:default on 0.0.0.0:8883 started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listener ws:default on 0.0.0.0:8083 started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listener wss:default on 0.0.0.0:8084 started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listener http:dashboard on :18083 started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EMQX 5.8.5 is running now!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restricted Eshell V14.2.5.2 (press Ctrl+G to abort, type help(). for help)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v5.8.5(emqx@192.168.137.101)1&gt; OS monotonic time stepped backwards! Maybe add &#x27;+c false&#x27; in vm.args</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Previous time: 1019146450559</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current time:  1019146449647</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[os_mon] cpu supervisor port (cpu_sup): Erlang has closed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[os_mon] memory supervisor port (memsup): Erlang has closed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">已放弃 (核心已转储)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方法-1">解决方法<a href="#解决方法-1" class="hash-link" aria-label="解决方法的直接链接" title="解决方法的直接链接">​</a></h4>
<p>关于此错误，可以参考<a href="https://askemq.com/t/topic/9130" target="_blank" rel="noopener noreferrer">这个问题</a></p>
<p>对于部分版本的 EMQX，在 VirtualBox 中运行时会出现时钟回拨，导致 Erlang 虚拟机退出运行，从而导致 EMQX 退出，使用 <code>5.0.24</code> 版本重试</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-集群节点连接失败">3. 集群节点连接失败<a href="#3-集群节点连接失败" class="hash-link" aria-label="3. 集群节点连接失败的直接链接" title="3. 集群节点连接失败的直接链接">​</a></h3>
<ul>
<li><a href="https://docs.emqx.com/zh/emqx/latest/deploy/cluster/security.html#%E9%9B%86%E7%BE%A4%E5%86%85%E9%80%9A%E4%BF%A1%E7%AB%AF%E5%8F%A3" target="_blank" rel="noopener noreferrer">集群内通信端口</a></li>
</ul>
<p>使用 <code>emqx console</code> 命令启动，可以看到命令行打印如下日志</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-03-12T10:53:53.661061+08:00 [info] Ekka(AutoCluster): discovered nodes are not responding: [&#x27;emqx@192.168.137.101&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在排除服务原因和网络原因后，检查配置文件中 <code>node.name</code> 是否包含数组，如果包含数字，开放的端口需要将这个数字加上</p>
<p><strong>注意:</strong> 如果节点名称中有数字，则 <code>Erlang 传输端口</code>和 <code>RPC 端口</code>需要加上数字，例如: 节点名为 <code>emqx-01</code> 则需要开放 <code>4371</code> 和 <code>5371</code> 端口</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-haproxy-启动报错">4. HAProxy 启动报错<a href="#4-haproxy-启动报错" class="hash-link" aria-label="4. HAProxy 启动报错的直接链接" title="4. HAProxy 启动报错的直接链接">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[NOTICE]   (15572) : Initializing new worker (15574)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[NOTICE]   (15574) : haproxy version is 3.1.5-076df02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[NOTICE]   (15574) : path to executable is /usr/local/haproxy/sbin/haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ALERT]    (15574) : [haproxy.main()] Cannot raise FD limit to 2048043, limit is 1024.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[NOTICE]   (15572) : haproxy version is 3.1.5-076df02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[NOTICE]   (15572) : path to executable is /usr/local/haproxy/sbin/haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[WARNING]  (15572) : Failed to load worker!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方法-2">解决方法<a href="#解决方法-2" class="hash-link" aria-label="解决方法的直接链接" title="解决方法的直接链接">​</a></h4>
<p>系统里的能打开的文件描述符太小，程序里的比较大，需要调整程序的 <code>maxconn</code> 或系统的 <code>ulimit -n</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/linux/install/12-Install-EMQX-Offline-In-CentOS8.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/zh-cn/linux/install/Install-Zsh/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Install-Zsh</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/zh-cn/linux/install/Deploy-ZLMediaKit-And-WVP-GB28181-Pro-Offline/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Deploy-ZLMediaKit-And-WVP-GB28181-Pro-Offline</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一相关链接" class="table-of-contents__link toc-highlight">一、相关链接</a></li><li><a href="#二环境介绍" class="table-of-contents__link toc-highlight">二、环境介绍</a></li><li><a href="#三准备工作" class="table-of-contents__link toc-highlight">三、准备工作</a><ul><li><a href="#1-系统安装" class="table-of-contents__link toc-highlight">1. 系统安装</a></li><li><a href="#2-修改yum源" class="table-of-contents__link toc-highlight">2. 修改yum源</a></li><li><a href="#3-查找依赖包" class="table-of-contents__link toc-highlight">3. 查找依赖包</a></li></ul></li><li><a href="#四测试机安装emqx" class="table-of-contents__link toc-highlight">四、测试机安装EMQX</a><ul><li><a href="#1-下载依赖包" class="table-of-contents__link toc-highlight">1. 下载依赖包</a></li><li><a href="#2-rpm-安装" class="table-of-contents__link toc-highlight">2. rpm 安装</a></li><li><a href="#3-targz-安装" class="table-of-contents__link toc-highlight">3. tar.gz 安装</a></li><li><a href="#4-将emqx注册为系统服务" class="table-of-contents__link toc-highlight">4. 将EMQX注册为系统服务</a></li></ul></li><li><a href="#五集群安装配置" class="table-of-contents__link toc-highlight">五、集群安装配置</a><ul><li><a href="#1-测试节点网络" class="table-of-contents__link toc-highlight">1. 测试节点网络</a></li><li><a href="#2-开放服务器端口" class="table-of-contents__link toc-highlight">2. 开放服务器端口</a></li><li><a href="#3-时间同步配置" class="table-of-contents__link toc-highlight">3. 时间同步配置</a></li><li><a href="#4-检测时钟回拨" class="table-of-contents__link toc-highlight">4. 检测时钟回拨</a></li><li><a href="#5-试运行emqx" class="table-of-contents__link toc-highlight">5. 试运行EMQX</a></li><li><a href="#6-集群配置" class="table-of-contents__link toc-highlight">6. 集群配置</a></li><li><a href="#7-启动emqx服务" class="table-of-contents__link toc-highlight">7. 启动EMQX服务</a></li></ul></li><li><a href="#六验证集群发布与订阅" class="table-of-contents__link toc-highlight">六、验证集群发布与订阅</a></li><li><a href="#七nginx网关负载均衡" class="table-of-contents__link toc-highlight">七、Nginx网关负载均衡</a><ul><li><a href="#1-环境准备" class="table-of-contents__link toc-highlight">1. 环境准备</a></li><li><a href="#2-下载安装nginx" class="table-of-contents__link toc-highlight">2. 下载安装Nginx</a></li><li><a href="#3-配置nginx" class="table-of-contents__link toc-highlight">3. 配置Nginx</a></li><li><a href="#4-验证负载均衡" class="table-of-contents__link toc-highlight">4. 验证负载均衡</a></li></ul></li><li><a href="#八haproxy负载均衡" class="table-of-contents__link toc-highlight">八、HAProxy负载均衡</a><ul><li><a href="#1-环境准备-1" class="table-of-contents__link toc-highlight">1. 环境准备</a></li><li><a href="#2-下载安装" class="table-of-contents__link toc-highlight">2. 下载安装</a></li><li><a href="#3-配置haproxy" class="table-of-contents__link toc-highlight">3. 配置HAProxy</a></li><li><a href="#4-注册运行" class="table-of-contents__link toc-highlight">4. 注册运行</a></li></ul></li><li><a href="#九集群网关对比" class="table-of-contents__link toc-highlight">九、集群网关对比</a></li><li><a href="#十其他问题" class="table-of-contents__link toc-highlight">十、其他问题</a><ul><li><a href="#1-共享订阅" class="table-of-contents__link toc-highlight">1. 共享订阅</a></li><li><a href="#2-客户端断开重连丢失已订阅topic" class="table-of-contents__link toc-highlight">2. 客户端断开重连丢失已订阅Topic</a></li></ul></li><li><a href="#十一常见问题" class="table-of-contents__link toc-highlight">十一、常见问题</a><ul><li><a href="#1-服务启动失败" class="table-of-contents__link toc-highlight">1. 服务启动失败</a></li><li><a href="#2-服务启动后过几分钟回自动停止" class="table-of-contents__link toc-highlight">2. 服务启动后过几分钟回自动停止</a></li><li><a href="#3-集群节点连接失败" class="table-of-contents__link toc-highlight">3. 集群节点连接失败</a></li><li><a href="#4-haproxy-启动报错" class="table-of-contents__link toc-highlight">4. HAProxy 启动报错</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>