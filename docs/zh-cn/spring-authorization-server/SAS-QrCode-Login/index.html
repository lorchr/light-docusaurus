<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-zh-cn/spring-authorization-server/SAS-QrCode-Login" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">SAS-QrCode-Login | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SAS-QrCode-Login | Light Docusaurus"><meta data-rh="true" name="description" content="- Spring Authorization Server入门 (二十) 实现二维码扫码登录"><meta data-rh="true" property="og:description" content="- Spring Authorization Server入门 (二十) 实现二维码扫码登录"><link data-rh="true" rel="icon" href="/light-docusaurus/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/light-docusaurus/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/light-docusaurus/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/light-docusaurus/opensearch.xml"><link rel="stylesheet" href="/light-docusaurus/assets/css/styles.10a62360.css">
<script src="/light-docusaurus/assets/js/runtime~main.018e30f2.js" defer="defer"></script>
<script src="/light-docusaurus/assets/js/main.4b4e5c80.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/light-docusaurus/"><div class="navbar__logo"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/light-docusaurus/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/light-docusaurus/blog/">Blog</a><a class="navbar__item navbar__link" href="/light-docusaurus/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/light-docusaurus/electron/">Electron</a><a class="navbar__item navbar__link" href="/light-docusaurus/postman/">Postman</a><a class="navbar__item navbar__link" href="/light-docusaurus/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/guide/">Guide</a><button aria-label="展开侧边栏分类 &#x27;Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/develop-environment/">Develop Environment</a><button aria-label="展开侧边栏分类 &#x27;Develop Environment&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/java-jvm/">Java (JVM)</a><button aria-label="展开侧边栏分类 &#x27;Java (JVM)&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/spring-boot/">Spring Boot</a><button aria-label="展开侧边栏分类 &#x27;Spring Boot&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/spring-cloud/">Spring Cloud</a><button aria-label="展开侧边栏分类 &#x27;Spring Cloud&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/spring-security/">Spring Security</a><button aria-label="展开侧边栏分类 &#x27;Spring Security&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/light-docusaurus/docs/category/spring-authorization-server/">Spring Authorization Server</a><button aria-label="折叠侧边栏分类 &#x27;Spring Authorization Server&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Geting-Start-Index/">SAS-Geting-Start-Index</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-OAuth2.1-Protocol/">SAS-OAuth2.1-Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Spring-Boot-Authorization-Server/">SAS-Spring-Boot-Authorization-Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Spring-Boot-Authorization-Server-Addition/">SAS-Spring-Boot-Authorization-Server-Addition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Device-Authorization/">SAS-Device-Authorization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Customize-Exception-Configurer/">SAS-Customize-Exception-Configurer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Token-Enhancer-And-Parser/">SAS-Token-Enhancer-And-Parser</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Image-Captcha/">SAS-Image-Captcha</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-OAuth2-Client/">SAS-OAuth2-Client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-OAuth2-Resource-Server/">SAS-OAuth2-Resource-Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-SMS-Code-Login/">SAS-SMS-Code-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-OAuth2-Extension-Grant-Type/">SAS-OAuth2-Extension-Grant-Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Frontend-Backend-Separate/">SAS-Frontend-Backend-Separate</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Github-Gitee-Login/">SAS-Github-Gitee-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Wechat-Login/">SAS-Wechat-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Separate-Consent-And-Device-Authorize-Page/">SAS-Separate-Consent-And-Device-Authorize-Page</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Spring-Cloud-Gateway/">SAS-Spring-Cloud-Gateway</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Vue-Authorization-Code/">SAS-Vue-Authorization-Code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Vue-PKCE/">SAS-Vue-PKCE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Redis-Core-Service/">SAS-Redis-Core-Service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login/">SAS-QrCode-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/Opaque-Token-Resource-Server/">Opaque-Token-Resource-Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Wecom-DingTalk-Login/">SAS-Wecom-DingTalk-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/LDAP-Login/">LDAP-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/LDAP-Grant-Type/">LDAP-Grant-Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Saml2-Login-Grant/">SAS-Saml2-Login-Grant</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Build-GraalVM-Native-Image/">SAS-Build-GraalVM-Native-Image</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Getting-Start/">SAS-Getting-Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Opaque-Token/">SAS-Opaque-Token</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/Wecom-Login/">Wecom-Login</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Customlize-UserDetailService/">SAS-Optimize-Customlize-UserDetailService</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Add-Redis-Cache/">SAS-Optimize-Add-Redis-Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Persistance-JWKSource/">SAS-Optimize-Persistance-JWKSource</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Redis-Serializer-Add-Jackson-Mixin/">SAS-Optimize-Redis-Serializer-Add-Jackson-Mixin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-FAQ/">SAS-FAQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/active-directory/">Active Directory</a><button aria-label="展开侧边栏分类 &#x27;Active Directory&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/database/">Database</a><button aria-label="展开侧边栏分类 &#x27;Database&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/git/">Git</a><button aria-label="展开侧边栏分类 &#x27;Git&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/linux/">Linux</a><button aria-label="展开侧边栏分类 &#x27;Linux&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/docker/">Docker</a><button aria-label="展开侧边栏分类 &#x27;Docker&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/kubernetes/">Kubernetes</a><button aria-label="展开侧边栏分类 &#x27;Kubernetes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/test/">Test</a><button aria-label="展开侧边栏分类 &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/light-docusaurus/docs/category/others/">Others</a><button aria-label="展开侧边栏分类 &#x27;Others&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/light-docusaurus/docs/zh-cn/awesome-open-source/">Awesome open source</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/light-docusaurus/docs/zh-cn/windows/">Windows</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/light-docusaurus/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/light-docusaurus/docs/category/spring-authorization-server/"><span itemprop="name">Spring Authorization Server</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SAS-QrCode-Login</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>SAS-QrCode-Login</h1></header><ul>
<li><a href="https://juejin.cn/post/7326546769981603866" target="_blank" rel="noopener noreferrer">Spring Authorization Server入门 (二十) 实现二维码扫码登录</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="实现原理">实现原理<a href="#实现原理" class="hash-link" aria-label="实现原理的直接链接" title="实现原理的直接链接">​</a></h2>
<ul>
<li>打开网页，发起授权申请/未登录被重定向到登录页面</li>
<li>选择二维码登录，页面从后端请求二维码</li>
<li>页面渲染二维码图片，并轮询请求，获取二维码的状态</li>
<li>事先登录过APP的手机扫描二维码，然后APP请求服务器端的API接口，把用户认证信息传递到服务器中</li>
<li>后端收到APP的请求后更改二维码状态，并把用户认证信息写入session</li>
<li>页面得到扫码确认的响应，并跳转回之前未登录的地址</li>
</ul>
<p><a href="https://mermaid.js.org/syntax/sequenceDiagram.html" target="_blank" rel="noopener noreferrer">Sequence Diagram Syntax</a></p>
<!-- -->
<p>在这个流程中 <code>用户认证信息写入session</code> 后前端在重定向时能获取到认证信息是因为现在的认证服务引入了<code>spring session data redis</code>依赖，并且在<code>application.yml</code>中配置了<code>server.servlet.session.cookie.domain: cdhttp.cn</code>属性(演示环境域名)，这里是指定spring session的顶级域名，在该域名下的子域名服务共享session，如果你是在开发阶段可以配置为<code>server.servlet.session.cookie.domain: 127.0.0.1</code>，这时候前端访问使用<code>127.0.0.1:5173</code>，认证服务使用<code>127.0.0.1:8080</code>，端口可以不一样，但是认证服务和前端必须使用同一域名。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二代码实现">二、代码实现<a href="#二代码实现" class="hash-link" aria-label="二、代码实现的直接链接" title="二、代码实现的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-后端实现">1. 后端实现<a href="#1-后端实现" class="hash-link" aria-label="1. 后端实现的直接链接" title="1. 后端实现的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-引入二维码依赖">1. 引入二维码依赖<a href="#1-引入二维码依赖" class="hash-link" aria-label="1. 引入二维码依赖的直接链接" title="1. 引入二维码依赖的直接链接">​</a></h4>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.google.zxing</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">core</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.3.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.google.zxing</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">javase</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.3.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>hutool-captcha</code>改为<code>hutool-all</code></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">cn.hutool</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">hutool-all</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${hutool.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-添加二维码登录接口">2. 添加二维码登录接口<a href="#2-添加二维码登录接口" class="hash-link" aria-label="2. 添加二维码登录接口的直接链接" title="2. 添加二维码登录接口的直接链接">​</a></h4>
<p>提供四个接口，分别处理生成二维码、轮询、app扫码和app确认登录的逻辑。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.Result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.request.qrcode.QrCodeLoginConsentRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.request.qrcode.QrCodeLoginScanRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeGenerateResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeLoginFetchResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeLoginScanResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.service.IQrCodeLoginService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.GetMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.PathVariable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.PostMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RequestBody;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RequestMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RestController;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 二维码登录接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/qrCode&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeLoginController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final IQrCodeLoginService iQrCodeLoginService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/login/generateQrCode&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result&lt;QrCodeGenerateResponse&gt; generateQrCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 生成二维码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Result.success(iQrCodeLoginService.generateQrCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/login/fetch/{qrCodeId}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result&lt;QrCodeLoginFetchResponse&gt; fetch(@PathVariable String qrCodeId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 轮询二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Result.success(iQrCodeLoginService.fetch(qrCodeId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/scan&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result&lt;QrCodeLoginScanResponse&gt; scan(@RequestBody QrCodeLoginScanRequest loginScan) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app 扫码二维码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Result.success(iQrCodeLoginService.scan(loginScan));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/consent&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result&lt;String&gt; consent(@RequestBody QrCodeLoginConsentRequest loginConsent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app 确认登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        iQrCodeLoginService.consent(loginConsent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Result.success();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-yml中放行前端访问的接口">3. yml中放行前端访问的接口<a href="#3-yml中放行前端访问的接口" class="hash-link" aria-label="3. yml中放行前端访问的接口的直接链接" title="3. yml中放行前端访问的接口的直接链接">​</a></h4>
<p>添加匹配规则<code>/qrCode/login/**</code></p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">custom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 自定义认证配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">security</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 登录页面路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">login-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//k7fsqkhtbx.cdhttp.cn/login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 授权确认页面路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">consent-page-uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//k7fsqkhtbx.cdhttp.cn/consent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 设备码验证页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">device-activate-uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//k7fsqkhtbx.cdhttp.cn/activate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 设备码验证成功页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">device-activated-uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//k7fsqkhtbx.cdhttp.cn/activated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 不需要认证的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ignore-uri-list</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> assets/</span><span class="token important">**</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /webjars/</span><span class="token important">**</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /login</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /getCaptcha</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /getSmsCaptcha</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /oauth2/consent/parameters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /test03</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /favicon.ico</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /qrCode/login/</span><span class="token important">**</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-编写二维码登录服务接口">4. 编写二维码登录服务接口<a href="#4-编写二维码登录服务接口" class="hash-link" aria-label="4. 编写二维码登录服务接口的直接链接" title="4. 编写二维码登录服务接口的直接链接">​</a></h4>
<p>编写登录service接口</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.request.qrcode.QrCodeLoginConsentRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.request.qrcode.QrCodeLoginScanRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeGenerateResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeLoginFetchResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeLoginScanResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 二维码登录服务接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface IQrCodeLoginService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 生成二维码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 二维码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    QrCodeGenerateResponse generateQrCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫描二维码响应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param loginScan 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 二维码信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    QrCodeLoginScanResponse scan(QrCodeLoginScanRequest loginScan);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码登录确认入参</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param loginConsent 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void consent(QrCodeLoginConsentRequest loginConsent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * web端轮询二维码状态处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param qrCodeId 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 二维码信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    QrCodeLoginFetchResponse fetch(String qrCodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-编写生成二维码响应类">5. 编写生成二维码响应类<a href="#5-编写生成二维码响应类" class="hash-link" aria-label="5. 编写生成二维码响应类的直接链接" title="5. 编写生成二维码响应类的直接链接">​</a></h4>
<p>生成二维码图片时返回二维码id和图片</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.model.response.qrcode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 生成二维码响应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeGenerateResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String qrCodeId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码base64值(这里响应一个链接好一些)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String imageData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-编写web前端轮询二维码状态出参">6. 编写web前端轮询二维码状态出参<a href="#6-编写web前端轮询二维码状态出参" class="hash-link" aria-label="6. 编写web前端轮询二维码状态出参的直接链接" title="6. 编写web前端轮询二维码状态出参的直接链接">​</a></h4>
<p>前端根据二维码id轮询二维码状态时返回二维码状态，如果已扫描也会返回扫描者的头像、昵称。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.model.response.qrcode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * web前端轮询二维码状态出参</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeLoginFetchResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 0:待扫描，1:已扫描，2:已确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer qrCodeStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 是否已过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean expired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫描人头像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String avatarUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫描人昵称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 待确认scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Set&lt;String&gt; scopes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 跳转登录之前请求的接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String beforeLoginRequestUri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 跳转登录之前请求参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String beforeLoginQueryString;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-编写扫描二维码入参">7. 编写扫描二维码入参<a href="#7-编写扫描二维码入参" class="hash-link" aria-label="7. 编写扫描二维码入参的直接链接" title="7. 编写扫描二维码入参的直接链接">​</a></h4>
<p>app扫描二维码时传入二维码id</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.model.request.qrcode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 扫描二维码入参</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeLoginScanRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String qrCodeId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="8-编写二维码响应bean">8. 编写二维码响应bean<a href="#8-编写二维码响应bean" class="hash-link" aria-label="8. 编写二维码响应bean的直接链接" title="8. 编写二维码响应bean的直接链接">​</a></h4>
<p>扫描二维码时生成一个临时票据返回，同时返回scope和二维码状态。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.model.response.qrcode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 扫描二维码响应bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeLoginScanResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫描临时票据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String qrCodeTicket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer qrCodeStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 是否已过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean expired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 待确认scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Set&lt;String&gt; scopes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="9-编写二维码登录确认登录入参类">9. 编写二维码登录确认登录入参类<a href="#9-编写二维码登录确认登录入参类" class="hash-link" aria-label="9. 编写二维码登录确认登录入参类的直接链接" title="9. 编写二维码登录确认登录入参类的直接链接">​</a></h4>
<p>确认登录时传入二维码id和上一步生成的临时票据防篡改。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.model.request.qrcode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 二维码登录确认入参</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeLoginConsentRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String qrCodeId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫码二维码后产生的临时票据(仅一次有效)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String qrCodeTicket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10-编写二维码信息类">10. 编写二维码信息类<a href="#10-编写二维码信息类" class="hash-link" aria-label="10. 编写二维码信息类的直接链接" title="10. 编写二维码信息类的直接链接">​</a></h4>
<p>生成二维码时生成的数据bean，存入redis中，等到前端轮询或app端操作时使用。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.model.qrcode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.LocalDateTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 二维码信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String qrCodeId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 0:待扫描，1:已扫描，2:已确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer qrCodeStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码过期时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LocalDateTime expiresTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫描人头像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String avatarUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扫描人昵称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 待确认的scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Set&lt;String&gt; scopes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 跳转登录之前请求的接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String beforeLoginRequestUri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 跳转登录之前请求参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String beforeLoginQueryString;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="11-编写二维码登录接口实现">11. 编写二维码登录接口实现<a href="#11-编写二维码登录接口实现" class="hash-link" aria-label="11. 编写二维码登录接口实现的直接链接" title="11. 编写二维码登录接口实现的直接链接">​</a></h4>
<p>扫码登录实现，具体逻辑请看代码中的注释。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.service.impl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import cn.hutool.extra.qrcode.QrCodeUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import cn.hutool.extra.qrcode.QrConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.toolkit.IdWorker;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.entity.Oauth2BasicUser;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.qrcode.QrCodeInfo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.request.qrcode.QrCodeLoginConsentRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.request.qrcode.QrCodeLoginScanRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeGenerateResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeLoginFetchResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.model.response.qrcode.QrCodeLoginScanResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.property.CustomSecurityProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.service.IQrCodeLoginService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.support.RedisOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpSession;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.InsufficientAuthenticationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.Authentication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.context.SecurityContextHolder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.context.SecurityContextImpl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.oauth2.core.OAuth2AuthenticationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.oauth2.core.OAuth2Error;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.oauth2.core.OAuth2ErrorCodes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.oauth2.server.authorization.OAuth2Authorization;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.oauth2.server.authorization.OAuth2TokenType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.savedrequest.DefaultSavedRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.savedrequest.HttpSessionRequestCache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.savedrequest.RequestCache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.util.UrlUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.Assert;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.ObjectUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.request.RequestAttributes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.request.RequestContextHolder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.request.ServletRequestAttributes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.security.Principal;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.LocalDateTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Objects;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import static org.springframework.security.web.context.HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 二维码登录接口实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author vains</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QrCodeLoginServiceImpl implements IQrCodeLoginService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private final RedisOperator&lt;QrCodeInfo&gt; redisOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private final RedisOperator&lt;String&gt; stringRedisOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private final CustomSecurityProperties customSecurityProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private final RedisOAuth2AuthorizationService authorizationService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private final RedisOperator&lt;UsernamePasswordAuthenticationToken&gt; authenticationRedisOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 过期时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final long QR_CODE_INFO_TIMEOUT = 60 * 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 二维码信息前缀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String QR_CODE_PREV = &quot;login:qrcode:&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private final RequestCache requestCache = new HttpSessionRequestCache();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public QrCodeGenerateResponse generateQrCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 生成二维码唯一id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		String qrCodeId = IdWorker.getIdStr();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 生成二维码并转为base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		String pngQrCode = QrCodeUtil.generateAsBase64(qrCodeId, new QrConfig(), &quot;png&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		QrCodeInfo info = QrCodeInfo.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .qrCodeId(qrCodeId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 待扫描状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .qrCodeStatus(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1分钟后过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .expiresTime(LocalDateTime.now().plusMinutes(2L))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 获取当前request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (requestAttributes != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 获取当前session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			HttpServletResponse response = ((ServletRequestAttributes) requestAttributes).getResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			DefaultSavedRequest savedRequest = (DefaultSavedRequest) this.requestCache.getRequest(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if (savedRequest != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				if (!UrlUtils.isAbsoluteUrl(customSecurityProperties.getLoginUrl())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 获取查询参数与请求路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					String queryString = savedRequest.getQueryString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					String requestUri = savedRequest.getRequestURI();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 前后端不分离根据请求路径和请求参数跳转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					info.setBeforeLoginRequestUri(requestUri);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					info.setBeforeLoginQueryString(queryString);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				// 获取跳转登录之前访问url的query parameter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				String[] scopes = savedRequest.getParameterValues(&quot;scope&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				if (!ObjectUtils.isEmpty(scopes)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 不为空获取第一个并设置进二维码信息中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					info.setScopes(Set.of(scopes[0].split(&quot; &quot;)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				// 前端可以根据scope显示要获取的信息，或固定显示要获取的信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 因为上边设置的过期时间是2分钟，这里设置10分钟过期，可根据业务自行调整过期时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		redisOperator.set(QR_CODE_PREV + qrCodeId, info, QR_CODE_INFO_TIMEOUT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return new QrCodeGenerateResponse(qrCodeId, pngQrCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public QrCodeLoginScanResponse scan(QrCodeLoginScanRequest loginScan) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 应该用validation的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Assert.hasLength(loginScan.getQrCodeId(), &quot;二维码Id不能为空.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 校验二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		QrCodeInfo info = redisOperator.get(QR_CODE_PREV + loginScan.getQrCodeId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (info == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new RuntimeException(&quot;无效二维码.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 验证状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (!Objects.equals(info.getQrCodeStatus(), 0)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new RuntimeException(&quot;二维码已被其他人扫描，无法重复扫描.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 二维码是否过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		boolean qrCodeExpire = info.getExpiresTime().isBefore(LocalDateTime.now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (qrCodeExpire) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new RuntimeException(&quot;二维码已过期.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		QrCodeLoginScanResponse loginScanResponse = new QrCodeLoginScanResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 获取登录用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		OAuth2Authorization oAuth2Authorization = this.getOAuth2Authorization();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (oAuth2Authorization == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new OAuth2AuthenticationException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					new OAuth2Error(OAuth2ErrorCodes.INVALID_TOKEN, &quot;登录已过期.&quot;, null));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// app端使用密码模式、手机认证登录，不使用三方登录的情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                oAuth2Authorization.getAttribute(Principal.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (usernamePasswordAuthenticationToken.getPrincipal() instanceof Oauth2BasicUser basicUser) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 生成临时票据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			String qrCodeTicket = IdWorker.getIdStr();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 根据二维码id和临时票据存储，确认时根据临时票据认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			String redisQrCodeTicketKey = String.format(&quot;%s%s:%s&quot;, QR_CODE_PREV, loginScan.getQrCodeId(), qrCodeTicket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			stringRedisOperator.set(redisQrCodeTicketKey, qrCodeTicket, QR_CODE_INFO_TIMEOUT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 更新二维码信息的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			info.setQrCodeStatus(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			info.setName(basicUser.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			info.setAvatarUrl(basicUser.getAvatarUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			redisOperator.set(QR_CODE_PREV + loginScan.getQrCodeId(), info, QR_CODE_INFO_TIMEOUT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 封装响应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			loginScanResponse.setQrCodeTicket(qrCodeTicket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			loginScanResponse.setQrCodeStatus(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			loginScanResponse.setExpired(Boolean.FALSE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			loginScanResponse.setScopes(info.getScopes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 其它登录方式暂不处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return loginScanResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void consent(QrCodeLoginConsentRequest loginConsent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 应该用validation的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Assert.hasLength(loginConsent.getQrCodeId(), &quot;二维码Id不能为空.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 校验二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		QrCodeInfo info = redisOperator.get(QR_CODE_PREV + loginConsent.getQrCodeId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (info == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new RuntimeException(&quot;无效二维码或二维码已过期.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 验证临时票据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		String qrCodeTicketKey =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String.format(&quot;%s%s:%s&quot;, QR_CODE_PREV, loginConsent.getQrCodeId(), loginConsent.getQrCodeTicket());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		String redisQrCodeTicket = stringRedisOperator.get(qrCodeTicketKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (!Objects.equals(redisQrCodeTicket, loginConsent.getQrCodeTicket())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 临时票据有误、临时票据失效(超过redis存活时间后确认)、redis数据有误</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				log.debug(&quot;临时票据有误、临时票据  失效(超过redis存活时间后确认)、redis数据有误.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new RuntimeException(&quot;登录确认失败，请重新扫描.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 使用后删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stringRedisOperator.delete(qrCodeTicketKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 获取登录用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		OAuth2Authorization authorization = this.getOAuth2Authorization();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (authorization == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new OAuth2AuthenticationException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					new OAuth2Error(OAuth2ErrorCodes.INVALID_TOKEN, &quot;登录已过期.&quot;, null));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// app端使用密码模式、手机认证登录，不使用三方登录的情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		UsernamePasswordAuthenticationToken authenticationToken = authorization.getAttribute(Principal.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 根据二维码id存储用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		String redisUserinfoKey = String.format(&quot;%s%s:%s&quot;, QR_CODE_PREV, &quot;userinfo&quot;, loginConsent.getQrCodeId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 存储用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		authenticationRedisOperator.set(redisUserinfoKey, authenticationToken, QR_CODE_INFO_TIMEOUT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 更新二维码信息的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		info.setQrCodeStatus(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		redisOperator.set(QR_CODE_PREV + loginConsent.getQrCodeId(), info, QR_CODE_INFO_TIMEOUT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public QrCodeLoginFetchResponse fetch(String qrCodeId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 校验二维码状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		QrCodeInfo info = redisOperator.get(QR_CODE_PREV + qrCodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (info == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new RuntimeException(&quot;无效二维码或二维码已过期.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		QrCodeLoginFetchResponse loginFetchResponse = new QrCodeLoginFetchResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 设置二维码是否过期、状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		loginFetchResponse.setQrCodeStatus(info.getQrCodeStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		loginFetchResponse.setExpired(info.getExpiresTime().isBefore(LocalDateTime.now()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (!Objects.equals(info.getQrCodeStatus(), 0)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 如果是已扫描/已确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			loginFetchResponse.setName(info.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			loginFetchResponse.setAvatarUrl(info.getAvatarUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 如果是已确认，将之前扫码确认的用户信息放入当前session中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (Objects.equals(info.getQrCodeStatus(), 2)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 根据二维码id从redis获取用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			String redisUserinfoKey = String.format(&quot;%s%s:%s&quot;, QR_CODE_PREV, &quot;userinfo&quot;, qrCodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			UsernamePasswordAuthenticationToken authenticationToken = authenticationRedisOperator.get(redisUserinfoKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if (authenticationToken != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				// 获取当前request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				if (requestAttributes == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					throw new RuntimeException(&quot;获取当前Request失败.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				// 获取当前session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				HttpSession session = request.getSession(Boolean.FALSE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				if (session != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 获取到认证信息后将之前扫码确认的用户信息放入当前session中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					session.setAttribute(SPRING_SECURITY_CONTEXT_KEY, new SecurityContextImpl(authenticationToken));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 操作成功后移除缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					redisOperator.delete(QR_CODE_PREV + qrCodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 删除用户信息，防止其它人重放请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					authenticationRedisOperator.delete(redisUserinfoKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					// 填充二维码数据，设置跳转到登录之前的请求路径、查询参数和是否授权申请请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					loginFetchResponse.setBeforeLoginRequestUri(info.getBeforeLoginRequestUri());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					loginFetchResponse.setBeforeLoginQueryString(info.getBeforeLoginQueryString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				throw new RuntimeException(&quot;获取登录确认用户信息失败.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return loginFetchResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 获取当前使用token对应的认证信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return oauth2认证信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OAuth2Authorization getOAuth2Authorization() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// 校验登录状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (authentication == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throw new InsufficientAuthenticationException(&quot;未登录.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (authentication instanceof JwtAuthenticationToken jwtToken) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// jwt处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			String tokenValue = jwtToken.getToken().getTokenValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// 根据token获取授权登录时的认证信息(登录用户)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return authorizationService.findByToken(tokenValue, OAuth2TokenType.ACCESS_TOKEN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>到此后端部分就完成了，全局根据二维码id将整个流程串联起来，前端轮询、app端扫码和登录确认都是通过二维码id来的，中间借助redis来缓存二维码的信息，以确保每个端都可以获取到二维码信息，这样就算集群部署也不影响。</p>
<p>现在默认是将app端当做oauth2登录的，扫码和确认登录都是通过<code>access_token</code>来获取认证信息的，根据请求的token获取oauth2流程中&#x27;登录&#x27;生成的认证信息。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-前端实现">2. 前端实现<a href="#2-前端实现" class="hash-link" aria-label="2. 前端实现的直接链接" title="2. 前端实现的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-编写二维码登录请求api">1. 编写二维码登录请求api<a href="#1-编写二维码登录请求api" class="hash-link" aria-label="1. 编写二维码登录请求api的直接链接" title="1. 编写二维码登录请求api的直接链接">​</a></h4>
<p>编写<code>src/api/QrCodeLogin.ts</code>文件</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> loginRequest </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;../util/http/LoginRequest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * 生成二维码</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generateQrCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> loginRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">get</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">any</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/qrCode/login/generateQrCode&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * 获取二维码信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">qrCodeId</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qrCodeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> loginRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">get</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">any</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">/qrCode/login/fetch/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">qrCodeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-在登录页面添加二维码登录入口">2. 在登录页面添加二维码登录入口<a href="#2-在登录页面添加二维码登录入口" class="hash-link" aria-label="2. 在登录页面添加二维码登录入口的直接链接" title="2. 在登录页面添加二维码登录入口的直接链接">​</a></h4>
<p>前端页轮询时如果发现二维码状态变为确认登录则会重定向到之前被拦截后跳转到登录的地址，例如：访问<code>/a</code>发现未登录然后跳转到登录<code>/login</code>，之后扫码登录流程走完以后会重定向至<code>/a</code>。</p>
<div class="language-vue codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-vue codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;script setup lang=&quot;ts&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import { ref } from &#x27;vue&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import router from &#x27;../../router&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import { getQueryString } from &#x27;@/util/GlobalUtils&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import { generateQrCode, fetch } from &#x27;@/api/QrCodeLogin&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import { type CountdownProps, createDiscreteApi } from &#x27;naive-ui&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getImageCaptcha,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getSmsCaptchaByPhone,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loginSubmit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} from &#x27;@/api/Login&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const { message } = createDiscreteApi([&#x27;message&#x27;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 登录按钮加载状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const loading = ref(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 定义登录提交的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const loginModel = ref({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  code: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loginType: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  captchaId: &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 图形验证码的base64数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let captchaImage = ref(&#x27;&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 图形验证码的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let captchaCode = &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 是否开始倒计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const counterActive = ref(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 是否显示三方登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const showThirdLogin = ref(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 定义二维码信息的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const qrCodeInfo = ref({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  qrCodeStatus: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expired: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  avatarUrl: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scopes: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 生成二维码响应数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const getQrCodeInfo = ref({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  qrCodeId: &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  imageData: &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 是否自动提交授权确认(二维码登录自动提交)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const autoConsentKey: string = &#x27;autoConsent&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 获取图形验证码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const getCaptcha = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getImageCaptcha()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .then((result: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (result.success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        captchaCode = result.data.code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        captchaImage.value = result.data.imageData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loginModel.value.captchaId = result.data.captchaId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message.warning(result.message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .catch((e: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message.warning(`获取图形验证码失败：${e.message}`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 提交登录表单</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param type 登录类型，passwordLogin是密码模式，smsCaptcha短信登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const submitLogin = (type: string) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loading.value = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loginModel.value.loginType = type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loginSubmit(loginModel.value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .then((result: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (result.success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 移除自动提交缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        localStorage.removeItem(autoConsentKey)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // message.info(`登录成功`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let target = getQueryString(&#x27;target&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (target) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          window.location.href = target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 跳转到首页</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          router.push({ path: &#x27;/&#x27; })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message.warning(result.message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .catch((e: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message.warning(`登录失败：${e.message}`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .finally(() =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      loading.value = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 获取短信验证码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const getSmsCaptcha = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!loginModel.value.username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message.warning(&#x27;请先输入手机号.&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!loginModel.value.code) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message.warning(&#x27;请先输入验证码.&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (loginModel.value.code !== captchaCode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message.warning(&#x27;验证码错误.&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getSmsCaptchaByPhone({ phone: loginModel.value.username })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .then((result: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (result.success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message.info(`获取短信验证码成功，固定为：${result.data}`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        counterActive.value = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message.warning(result.message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .catch((e: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message.warning(`获取短信验证码失败：${e.message}`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 切换时更新验证码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param name tab的名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const handleUpdateValue = (name: string) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 二维码登录时隐藏三方登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  showThirdLogin.value = name !== &#x27;qrcode&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!showThirdLogin.value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    refreshQrCode()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    getCaptcha()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 生成二维码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const refreshQrCode = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  generateQrCode()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .then((r) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      getQrCodeInfo.value.qrCodeId = r.data.qrCodeId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      getQrCodeInfo.value.imageData = r.data.imageData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 开始轮询获取二维码信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fetchQrCodeInfo(r.data.qrCodeId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .catch((e: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message.warning(`生成二维码失败：${e.message}`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 根据二维码id轮询二维码信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param qrCodeId 二维码id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const fetchQrCodeInfo = (qrCodeId: string) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fetch(qrCodeId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .then((r: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (r.success) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        qrCodeInfo.value = r.data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (qrCodeInfo.value.qrCodeStatus !== 0 &amp;&amp; qrCodeInfo.value.avatarUrl) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 只要不是待扫描并且头像不为空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          getQrCodeInfo.value.imageData = qrCodeInfo.value.avatarUrl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (r.data.qrCodeStatus !== 2 &amp;&amp; !qrCodeInfo.value.expired) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (!showThirdLogin.value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 显示三方登录代表不是二维码登录，不轮询；否则继续轮询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1秒后重复调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            setTimeout(() =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fetchQrCodeInfo(qrCodeId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }, 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (qrCodeInfo.value.expired) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 二维码过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (qrCodeInfo.value.qrCodeStatus === 2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 已确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          let href = getQueryString(&#x27;target&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (href) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 确认后将地址重定向</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            window.location.href = href</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 跳转到首页</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            router.push({ path: &#x27;/&#x27; })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message.warning(r.message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .catch((e: any) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message.warning(`获取二维码信息失败：${e.message || e.statusText}`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 倒计时结束</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const onFinish = () =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  counterActive.value = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 倒计时显示内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const renderCountdown: CountdownProps[&#x27;render&#x27;] = ({ hours, minutes, seconds }) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return `${seconds}`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 根据类型发起OAuth2授权申请</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param type 三方OAuth2登录提供商类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const thirdLogin = (type: string) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  window.location.href = `${import.meta.env.VITE_OAUTH_ISSUER}/oauth2/authorization/${type}`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getCaptcha()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/script&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;template&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;header&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;img alt=&quot;Vue logo&quot; class=&quot;logo&quot; src=&quot;../../assets/logo.svg&quot; width=&quot;125&quot; height=&quot;125&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;div class=&quot;wrapper&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;HelloWorld msg=&quot;统一认证平台&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/header&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;main&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;n-card title=&quot;&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;n-tabs default-value=&quot;signin&quot; size=&quot;large&quot; justify-content=&quot;space-evenly&quot; @update:value=&quot;handleUpdateValue&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;n-tab-pane name=&quot;signin&quot; tab=&quot;账号登录&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;n-form&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-form-item-row label=&quot;用户名&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;n-input v-model:value=&quot;loginModel.username&quot; placeholder=&quot;手机号 / 邮箱&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/n-form-item-row&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-form-item-row label=&quot;密码&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;n-input v-model:value=&quot;loginModel.password&quot; type=&quot;password&quot; show-password-on=&quot;mousedown&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                placeholder=&quot;密码&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/n-form-item-row&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-form-item-row label=&quot;验证码&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;n-input-group&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;n-input v-model:value=&quot;loginModel.code&quot; placeholder=&quot;请输入验证码&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;n-image @click=&quot;getCaptcha&quot; width=&quot;130&quot; height=&quot;34&quot; :src=&quot;captchaImage&quot; preview-disabled /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;/n-input-group&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/n-form-item-row&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;/n-form&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;n-button type=&quot;info&quot; :loading=&quot;loading&quot; @click=&quot;submitLogin(&#x27;passwordLogin&#x27;)&quot; block strong&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;/n-button&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/n-tab-pane&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;n-tab-pane name=&quot;signup&quot; tab=&quot;短信登录&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;n-form&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-form-item-row label=&quot;手机号&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;n-input v-model:value=&quot;loginModel.username&quot; placeholder=&quot;手机号 / 邮箱&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/n-form-item-row&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-form-item-row label=&quot;验证码&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;n-input-group&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;n-input v-model:value=&quot;loginModel.code&quot; placeholder=&quot;请输入验证码&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;n-image @click=&quot;getCaptcha&quot; width=&quot;130&quot; height=&quot;34&quot; :src=&quot;captchaImage&quot; preview-disabled /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;/n-input-group&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/n-form-item-row&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-form-item-row label=&quot;验证码&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;n-input-group&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;n-input v-model:value=&quot;loginModel.password&quot; placeholder=&quot;请输入验证码&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;n-button type=&quot;info&quot; @click=&quot;getSmsCaptcha&quot; style=&quot;width: 130px&quot; :disabled=&quot;counterActive&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  获取验证码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &lt;span v-if=&quot;counterActive&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;n-countdown :render=&quot;renderCountdown&quot; :on-finish=&quot;onFinish&quot; :duration=&quot;59 * 1000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      :active=&quot;counterActive&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    )&lt;/span&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/n-button&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &lt;/n-input-group&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/n-form-item-row&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;/n-form&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;n-button type=&quot;info&quot; :loading=&quot;loading&quot; @click=&quot;submitLogin(&#x27;smsCaptcha&#x27;)&quot; block strong&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;/n-button&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/n-tab-pane&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;n-tab-pane name=&quot;qrcode&quot; tab=&quot;扫码登录&quot; style=&quot;text-align: center&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;div style=&quot;margin: 5.305px&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;n-image width=&quot;300&quot; :src=&quot;getQrCodeInfo.imageData&quot; preview-disabled /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/n-tab-pane&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;/n-tabs&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;n-divider style=&quot;font-size: 80%; color: #909399&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {{ showThirdLogin ? &#x27;其它登录方式&#x27; : &#x27;使用app扫描二维码登录&#x27; }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;/n-divider&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;div class=&quot;other_login_icon&quot; v-if=&quot;showThirdLogin&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;IconGitee :size=&quot;32&quot; @click=&quot;thirdLogin(&#x27;gitee&#x27;)&quot; class=&quot;icon_item&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;img width=&quot;36&quot; height=&quot;36&quot; @click=&quot;thirdLogin(&#x27;github&#x27;)&quot; src=&quot;../../assets/GitHub-Mark.png&quot; class=&quot;icon_item&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;img width=&quot;28&quot; height=&quot;28&quot; @click=&quot;thirdLogin(&#x27;wechat&#x27;)&quot; src=&quot;../../assets/wechat_login.png&quot; class=&quot;icon_item&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/n-card&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/main&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/template&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;style scoped&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.other_login_icon {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display: flex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  align-items: center;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  justify-content: center;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gap: 0 10px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  position: relative;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  margin-top: -5px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.icon_item {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cursor: pointer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  line-height: 1.5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.logo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display: block;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  margin: 0 auto 2rem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@media (min-width: 1024px) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  header {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display: flex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    place-items: center;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    padding-right: calc(var(--section-gap) / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .logo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    margin: 0 2rem 0 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  header .wrapper {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display: flex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    place-items: flex-start;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flex-wrap: wrap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/style&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>具体修改内容请看代码仓库<a href="https://gitee.com/vains-Sofia/authorization-example/tree/qrcode_login/" target="_blank" rel="noopener noreferrer">qrcode_login</a>分支的<a href="https://gitee.com/vains-Sofia/authorization-example/commit/8552c2c19d0040d8081b5da9fb0dfd31169c274b" target="_blank" rel="noopener noreferrer">二维码登录前端登录页面实现</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三效果">三、效果<a href="#三效果" class="hash-link" aria-label="三、效果的直接链接" title="三、效果的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="img" src="/light-docusaurus/assets/images/20-1-b75def94f65e061f7f0861192b67e9bc.awebp" width="1905" height="981" class="img_ev3q"></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. 先获取一个Token备用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. 浏览器访问登录页，切换到扫码登录页签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">http://127.0.0.1:5173/login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. F12 打开控制台复制二维码的ID 1760855300433031170</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. 携带二维码ID调用扫描二维码接口 (需携带Bearer Token)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># POST http://127.0.0.1:8080/qrCode/scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 5. 携带二维码ID和扫描返回的ticket调用确认登录接口 (需携带Bearer Token)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># POST http://127.0.0.1:8080/qrCode/consent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>扫码登录是使用【一台已经登录系统账号的设备】来扫描一个新的登录页面，所以需要提前准备一个Token，进行后面的操作</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四附录">四、附录<a href="#四附录" class="hash-link" aria-label="四、附录的直接链接" title="四、附录的直接链接">​</a></h2>
<p>代码仓库：<a href="https://gitee.com/vains-Sofia/authorization-example" target="_blank" rel="noopener noreferrer">Gitee</a>、<a href="https://github.com/vains-Sofia/authorization-example" target="_blank" rel="noopener noreferrer">Github</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="五参考资料">五、参考资料<a href="#五参考资料" class="hash-link" aria-label="五、参考资料的直接链接" title="五、参考资料的直接链接">​</a></h2>
<ul>
<li><a href="https://www.cnblogs.com/GoodHelper/p/8643071.html" target="_blank" rel="noopener noreferrer">SpringBoot二维码登录(中)</a></li>
<li><a href="https://blog.51cto.com/solarboy/2154188" target="_blank" rel="noopener noreferrer">反向工程解析QQ扫码登录的OAuth2流程</a></li>
<li><a href="https://juejin.cn/post/6844904111398191117" target="_blank" rel="noopener noreferrer">聊一聊二维码扫描登录原理</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-authorization-server/20-SAS-QrCode-Login.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Redis-Core-Service/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">SAS-Redis-Core-Service</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/light-docusaurus/docs/zh-cn/spring-authorization-server/Opaque-Token-Resource-Server/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Opaque-Token-Resource-Server</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#实现原理" class="table-of-contents__link toc-highlight">实现原理</a></li><li><a href="#二代码实现" class="table-of-contents__link toc-highlight">二、代码实现</a><ul><li><a href="#1-后端实现" class="table-of-contents__link toc-highlight">1. 后端实现</a></li><li><a href="#2-前端实现" class="table-of-contents__link toc-highlight">2. 前端实现</a></li></ul></li><li><a href="#三效果" class="table-of-contents__link toc-highlight">三、效果</a></li><li><a href="#四附录" class="table-of-contents__link toc-highlight">四、附录</a></li><li><a href="#五参考资料" class="table-of-contents__link toc-highlight">五、参考资料</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>