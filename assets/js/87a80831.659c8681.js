"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[65199],{69763:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>c,toc:()=>o});var l=s(74848),r=s(28453);const a={},t=void 0,c={id:"zh-cn/database/Mycat",title:"Mycat",description:"- Mycat1 Github",source:"@site/docs/zh-cn/database/9-Mycat.md",sourceDirName:"zh-cn/database",slug:"/zh-cn/database/Mycat",permalink:"/light-docusaurus/docs/zh-cn/database/Mycat",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/database/9-Mycat.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{},sidebar:"troch",previous:{title:"DataX-Data-Transfer",permalink:"/light-docusaurus/docs/zh-cn/database/DataX-Data-Transfer"},next:{title:"Mysql-Cluster-Install",permalink:"/light-docusaurus/docs/zh-cn/database/Mysql-Cluster-Install"}},i={},o=[{value:"Pgsql \u96c6\u7fa4\u5b89\u88c5 (Docker\u7248)",id:"pgsql-\u96c6\u7fa4\u5b89\u88c5-docker\u7248",level:2},{value:"1. \u90e8\u7f72\u5bb9\u5668IP",id:"1-\u90e8\u7f72\u5bb9\u5668ip",level:3},{value:"2. \u4e3b\u5e93\u914d\u7f6e\uff08Master\uff09",id:"2-\u4e3b\u5e93\u914d\u7f6emaster",level:3},{value:"1. \u521d\u59cb\u5316\u4e3b\u5e93",id:"1-\u521d\u59cb\u5316\u4e3b\u5e93",level:4},{value:"2. \u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e",id:"2-\u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e",level:4},{value:"3. \u4e3b\u5e93 <code>$PGDATA/pg_hba.conf</code> \u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236",id:"3-\u4e3b\u5e93-pgdatapg_hbaconf-\u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236",level:4},{value:"4. \u4e3b\u5e93 <code>$PGDATA/postgresql.conf</code> \u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570",id:"4-\u4e3b\u5e93-pgdatapostgresqlconf-\u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570",level:4},{value:"5. \u91cd\u542f\u4e3b\u5e93",id:"5-\u91cd\u542f\u4e3b\u5e93",level:4},{value:"3. \u4ece\u5e93\u914d\u7f6e (Slave Docker\u90e8\u7f72)",id:"3-\u4ece\u5e93\u914d\u7f6e-slave-docker\u90e8\u7f72",level:3},{value:"1. \u521d\u59cb\u5316\u4ece\u5e93",id:"1-\u521d\u59cb\u5316\u4ece\u5e93",level:4},{value:"2. \u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93",id:"2-\u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93",level:4},{value:"3. \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",id:"3-\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",level:4},{value:"4. \u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93",id:"4-\u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93",level:4},{value:"4. \u4ece\u5e93\u914d\u7f6e (Standby \u7269\u7406\u673a\u90e8\u7f72)",id:"4-\u4ece\u5e93\u914d\u7f6e-standby-\u7269\u7406\u673a\u90e8\u7f72",level:3},{value:"1. \u521d\u59cb\u5316\u4ece\u5e93",id:"1-\u521d\u59cb\u5316\u4ece\u5e93-1",level:4},{value:"2. \u505c\u6b62\u4ece\u5e93\uff0c\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\uff0c\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",id:"2-\u505c\u6b62\u4ece\u5e93\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",level:4},{value:"5. \u91cd\u542f\u4ece\u5e93",id:"5-\u91cd\u542f\u4ece\u5e93",level:4},{value:"5. \u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",id:"5-\u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",level:3},{value:"1. \u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f",id:"1-\u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f",level:4},{value:"2. \u67e5\u8be2\u8282\u70b9\u72b6\u6001",id:"2-\u67e5\u8be2\u8282\u70b9\u72b6\u6001",level:4},{value:"3. \u6570\u636e\u540c\u6b65\u6d4b\u8bd5",id:"3-\u6570\u636e\u540c\u6b65\u6d4b\u8bd5",level:4},{value:"6. \u521b\u5efa\u53ea\u8bfb\u8d26\u53f7",id:"6-\u521b\u5efa\u53ea\u8bfb\u8d26\u53f7",level:3},{value:"Mysql \u96c6\u7fa4\u5b89\u88c5\uff08Docker\u7248\uff09",id:"mysql-\u96c6\u7fa4\u5b89\u88c5docker\u7248",level:2},{value:"1. \u4e3b\u5e93\u914d\u7f6e\uff08Master\uff09",id:"1-\u4e3b\u5e93\u914d\u7f6emaster",level:3},{value:"1. \u521d\u59cb\u5316\u6570\u636e\u5e93",id:"1-\u521d\u59cb\u5316\u6570\u636e\u5e93",level:4},{value:"2. \u914d\u7f6e <code>/etc/mysql/conf.d/mysql.cnf</code>",id:"2-\u914d\u7f6e-etcmysqlconfdmysqlcnf",level:4},{value:"3. \u521b\u5efa\u540c\u6b65\u7528\u6237",id:"3-\u521b\u5efa\u540c\u6b65\u7528\u6237",level:4},{value:"4. \u91cd\u542f\u6570\u636e\u5e93",id:"4-\u91cd\u542f\u6570\u636e\u5e93",level:4},{value:"2. \u4ece\u5e93\u914d\u7f6e\uff08Slave\uff09",id:"2-\u4ece\u5e93\u914d\u7f6eslave",level:3},{value:"1. \u521d\u59cb\u5316\u6570\u636e\u5e93",id:"1-\u521d\u59cb\u5316\u6570\u636e\u5e93-1",level:4},{value:"2. \u914d\u7f6e <code>/etc/mysql/conf.d/mysql.cnf</code>",id:"2-\u914d\u7f6e-etcmysqlconfdmysqlcnf-1",level:4},{value:"3. \u91cd\u542f\u6570\u636e\u5e93",id:"3-\u91cd\u542f\u6570\u636e\u5e93",level:4},{value:"3. \u8fde\u63a5Master\u548cSlave",id:"3-\u8fde\u63a5master\u548cslave",level:3},{value:"1. \u4e3b\u5e93\u64cd\u4f5c",id:"1-\u4e3b\u5e93\u64cd\u4f5c",level:4},{value:"2. \u4ece\u5e93\u64cd\u4f5c",id:"2-\u4ece\u5e93\u64cd\u4f5c",level:4},{value:"4. \u5e38\u89c1\u9519\u8bef",id:"4-\u5e38\u89c1\u9519\u8bef",level:3},{value:"\u5b89\u88c5Mycat",id:"\u5b89\u88c5mycat",level:2},{value:"1. \u4e0b\u8f7d\u5b89\u88c5",id:"1-\u4e0b\u8f7d\u5b89\u88c5",level:3},{value:"2. \u73af\u5883\u914d\u7f6e",id:"2-\u73af\u5883\u914d\u7f6e",level:3},{value:"3. \u6570\u636e\u5e93\u9a71\u52a8",id:"3-\u6570\u636e\u5e93\u9a71\u52a8",level:3},{value:"\u914d\u7f6eMycat",id:"\u914d\u7f6emycat",level:2},{value:"1. \u5728master\u6570\u636e\u5e93\u4e2d\u6dfb\u52a0<code>user1</code>\uff08\u5199\uff09\u3001<code>user2</code>\uff08\u53ea\u8bfb\uff09\u4e24\u4e2a\u8d26\u6237\uff0c\u5e76\u914d\u7f6e\u6743\u9650\u3002",id:"1-\u5728master\u6570\u636e\u5e93\u4e2d\u6dfb\u52a0user1\u5199user2\u53ea\u8bfb\u4e24\u4e2a\u8d26\u6237\u5e76\u914d\u7f6e\u6743\u9650",level:3},{value:"2. \u914d\u7f6emycat\u7684<code>schema.xml</code>",id:"2-\u914d\u7f6emycat\u7684schemaxml",level:3},{value:"3. \u914d\u7f6emycat\u7684<code>server.xml</code>\uff0c\u589e\u52a0\u4e24\u4e2a\u7528\u6237",id:"3-\u914d\u7f6emycat\u7684serverxml\u589e\u52a0\u4e24\u4e2a\u7528\u6237",level:3},{value:"4. \u542f\u52a8MyCat",id:"4-\u542f\u52a8mycat",level:3},{value:"Navicat\u6d4b\u8bd5",id:"navicat\u6d4b\u8bd5",level:2},{value:"\u96c6\u6210 Spring Boot \u5b9e\u73b0\u8bfb\u5199\u5206\u79bb",id:"\u96c6\u6210-spring-boot-\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb",level:2},{value:"1. \u6dfb\u52a0\u4f9d\u8d56",id:"1-\u6dfb\u52a0\u4f9d\u8d56",level:3},{value:"2. \u521b\u5efa\u6570\u636e\u6e90",id:"2-\u521b\u5efa\u6570\u636e\u6e90",level:3},{value:"3. \u8bbe\u7f6e\u6570\u636e\u6e90",id:"3-\u8bbe\u7f6e\u6570\u636e\u6e90",level:3},{value:"4. \u8fd4\u56de\u6570\u636e\u6e90",id:"4-\u8fd4\u56de\u6570\u636e\u6e90",level:3},{value:"5. \u521b\u5efa\u5207\u9762\uff0c\u52a8\u6001\u8bbe\u7f6e\u6570\u636e\u6e90",id:"5-\u521b\u5efa\u5207\u9762\u52a8\u6001\u8bbe\u7f6e\u6570\u636e\u6e90",level:3},{value:"6. \u8f93\u51fa\u7ed3\u679c",id:"6-\u8f93\u51fa\u7ed3\u679c",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/MyCATApache/Mycat-Server",children:"Mycat1 Github"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/MyCATApache/Mycat2",children:"Mycat2 Github"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"http://www.mycat.org.cn/",children:"Mycat Document"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://blog.csdn.net/qq_42003636/article/details/129475274",children:"SpringBoot \u6574\u5408 MyCat \u5b9e\u73b0\u8bfb\u5199\u5206\u79bb"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.jianshu.com/p/460ab9c072be",children:"mycat\u7684\u4ecb\u7ecd\u53ca\u4f7f\u7528"})}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"pgsql-\u96c6\u7fa4\u5b89\u88c5-docker\u7248",children:"Pgsql \u96c6\u7fa4\u5b89\u88c5 (Docker\u7248)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://blog.csdn.net/pgdba/article/details/133820811",children:"\u8fdb\u9636\u6570\u636e\u5e93\u7cfb\u5217\uff08\u5341\u4e94\uff09\uff1aPostgreSQL \u4e3b\u4ece\u540c\u6b65\u539f\u7406\u4e0e\u5b9e\u8df5"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://blog.csdn.net/qq_33445829/article/details/130727228",children:"Centos7.6\u90e8\u7f72postgresql15\u4e3b\u4ece"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"http://www.postgres.cn/docs/12/warm-standby.html#STANDBY-SERVER-OPERATION",children:"26.2. \u65e5\u5fd7\u4f20\u9001\u540e\u5907\u670d\u52a1\u5668"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://pgtune.leopard.in.ua/",children:"PGTune - calculate configuration for PostgreSQL based on the maximum performance for a given hardware configuration"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://blog.csdn.net/m0_38129431/article/details/111316018",children:"ShardingSphere4.0.0-RC1\u5b9e\u73b0\u5206\u5e93\u5206\u8868+\u8bfb\u5199\u5206\u79bb"})}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"1-\u90e8\u7f72\u5bb9\u5668ip",children:"1. \u90e8\u7f72\u5bb9\u5668IP"}),"\n",(0,l.jsx)(n.p,{children:"\u4e3a\u4e86\u56fa\u5b9aIP\u53ef\u4ee5\u5355\u72ec\u521b\u5efa\u4e00\u4e2a\u7f51\u7edc"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e3b\u8282\u70b9 master: 172.18.0.2  \uff08Docker\u90e8\u7f72\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u4ece\u8282\u70b91 slave : 172.18.0.3 \uff08Docker\u90e8\u7f72\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u4ece\u8282\u70b92 standby: 172.18.0.1 \uff08\u7269\u7406\u673a\u90e8\u7f72\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u7f51\u7edc\ndocker network create --subnet=172.18.0.0/16 pgsql\n\n# \u5bb9\u5668\u521b\u5efa\u540e\u53ef\u4ee5\u4f7f\u7528\u6b64\u547d\u4ee4\u67e5\u770b\u5bb9\u5668IP\ndocker inspect pgsql-master | grep IPAddress \n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u4e3b\u5e93\u914d\u7f6emaster",children:"2. \u4e3b\u5e93\u914d\u7f6e\uff08Master\uff09"}),"\n",(0,l.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u4e3b\u5e93",children:"1. \u521d\u59cb\u5316\u4e3b\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u6587\u4ef6\u5939\nmkdir -p //d/docker/pgsql-master/{conf,data,logs}\n\n# \u8fd0\u884c\u5bb9\u5668\ndocker run -d \\\n  --publish 5433:5432 \\\n  --volume //d/docker/pgsql-master/data:/var/lib/postgresql/data \\\n  --env PGDATA=/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=postgres \\\n  --net pgsql \\\n  --ip 172.18.0.2 \\\n  --restart=no \\\n  --name postgres-master \\\n  postgres:15.3\n"})}),"\n",(0,l.jsx)(n.h4,{id:"2-\u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e",children:"2. \u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u8fdb\u5165\u5bb9\u5668\u547d\u4ee4\u884c\ndocker exec -it -u root postgres-master /bin/bash\n\n# \u521b\u5efa\u5f52\u6863\u65e5\u5fd7\u76ee\u5f55\nmkdir -p $PGDATA/pg_archive\n\n# \u521b\u5efa\u540c\u6b65\u8d26\u6237\npsql -h localhost -p 5432 -U postgres -W -d postgres\nCREATE ROLE replica login replication encrypted password 'replica';\n"})}),"\n",(0,l.jsxs)(n.h4,{id:"3-\u4e3b\u5e93-pgdatapg_hbaconf-\u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236",children:["3. \u4e3b\u5e93 ",(0,l.jsx)(n.code,{children:"$PGDATA/pg_hba.conf"})," \u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-conf",children:"# replica    \u4e0a\u9762\u521b\u5efa\u7684\u8d26\u6237\n# 172.18.0.3 \u4ece\u8282\u70b9\u7684IP\nhost    replication     replica         172.18.0.3/32           trust\nhost    replication     replica         172.18.0.1/32           trust\n"})}),"\n",(0,l.jsxs)(n.h4,{id:"4-\u4e3b\u5e93-pgdatapostgresqlconf-\u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570",children:["4. \u4e3b\u5e93 ",(0,l.jsx)(n.code,{children:"$PGDATA/postgresql.conf"})," \u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-conf",children:"# basic\nlisten_addresses = '*'                # \u76d1\u542c\u6240\u6709ip\nport = 5432                           # \u7aef\u53e3\nmax_connections = 1000                # \u6700\u5927\u8fde\u63a5\u6570\nsuperuser_reserved_connections = 10   # \u7ed9\u8d85\u7ea7\u7528\u6237\u9884\u7559\u7684\u8fde\u63a5\u6570\nshared_buffers = 1GB                  # \u5171\u4eab\u5185\u5b58\uff0c\u4e00\u822c\u8bbe\u7f6e\u4e3a\u5185\u5b58\u76841/4\nwork_mem = 16MB                       # \u8bbe\u7f6e\u5728\u5199\u5165\u4e34\u65f6\u78c1\u76d8\u6587\u4ef6\u4e4b\u524d\u67e5\u8be2\u64cd\u4f5c(\u4f8b\u5982\u6392\u5e8f\u6216\u54c8\u5e0c\u8868)\u53ef\u4f7f\u7528\u7684\u6700\u5927\u5185\u5b58\u5bb9\u91cf\nmaintenance_work_mem = 256MB          # \u5728\u7ef4\u62a4\u6027\u64cd\u4f5c\uff08\u4f8b\u5982VACUUM\u3001CREATE INDEX\u548cALTER TABLE ADD FOREIGN KEY\uff09\u4e2d\u4f7f\u7528\u7684 \u6700\u5927\u7684\u5185\u5b58\u91cf\ntimezone = 'Asia/Shanghai'            # \u7cfb\u7edf\u65f6\u533a\nhot_standby = on                      # \u6253\u5f00\u70ed\u5907\n\n# optimizer\ndefault_statistics_target = 500       # \u9ed8\u8ba4100\uff0cANALYZE\u5728pg_statistic\u4e2d\u5b58\u50a8\u7684\u4fe1\u606f\u91cf\uff0c\u589e\u5927\u8be5\u503c\uff0c\u4f1a\u589e\u52a0ANALYZE\u7684\u65f6\u95f4\uff0c\u4f46\u4f1a\u8ba9\u89e3\u91ca\u8ba1\u5212\u66f4\u7cbe\u51c6\n\n# wal\nmax_wal_size = 1GB                    # \u5efa\u8bae\u4e0eshared_buffers\u4fdd\u6301\u4e00\u81f4\nmin_wal_size = 80MB                   # \u5efa\u8baemax_wal_size/12.5\nwal_log_hints = on                    # \u63a7\u5236WAL\u65e5\u5fd7\u8bb0\u5f55\u7684\u65b9\u5f0f\uff0c\u5efa\u8bae\u6253\u5f00\nwal_level = replica                   # wal\u65e5\u5fd7\u5199\u5165\u7ea7\u522b\uff0c\u8981\u4f7f\u7528\u6d41\u590d\u5236\uff0c\u5fc5\u987b\u4f7f\u7528replica\u6216\u66f4\u9ad8\u7ea7\u522b\nwal_sender_timeout = 60s              # \u8bbe\u7f6eWAL\u53d1\u9001\u8005\u5728\u53d1\u9001WAL\u6570\u636e\u65f6\u7b49\u5f85\u4e3b\u670d\u52a1\u5668\u54cd\u5e94\u7684\u8d85\u65f6\u65f6\u95f4\nmax_wal_senders = 10                  # \nmax_replication_slots = 10            # \nsynchronous_standby_names = '*'       # \n\n# archive\narchive_mode = on                     # \narchive_command = 'gzip < %p > /var/lib/postgresql/data/pg_archive/%f.gz'\n\n# log \u8fd17\u5929\u8f6e\u8be2\nlog_destination = 'csvlog'            # \u65e5\u5fd7\u683c\u5f0f\nlogging_collector = on                # \u65e5\u5fd7\u6536\u96c6\u5668\nlog_directory = 'pg_log'              # \u65e5\u5fd7\u76ee\u5f55 $PGDATA/pg_log\nlog_filename = 'postgresql.%a'        # 7\u5929\u65e5\u5fd7\u8f6e\u8be2\nlog_file_mode = 0600                  # \u65e5\u5fd7\u6587\u4ef6\u7684\u6743\u9650\nlog_rotation_size = 0                 # \u65e5\u5fd7\u7684\u6700\u5927\u5c3a\u5bf8\uff0c\u8bbe\u7f6e\u4e3a\u96f6\u65f6\u5c06\u7981\u7528\u57fa\u4e8e\u5927\u5c0f\u521b\u5efa\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6\nlog_truncate_on_rotation = on         # \u8fd9\u4e2a\u53c2\u6570\u5c06\u5bfc\u81f4PostgreSQL\u622a\u65ad\uff08\u8986\u76d6\u800c\u4e0d\u662f\u8ffd\u52a0\uff09\u4efb\u4f55\u5df2\u6709\u7684\u540c\u540d\u65e5\u5fd7\u6587\u4ef6\nlog_min_duration_statement = 0        # \u5982\u679c\u8bed\u53e5\u8fd0\u884c\u81f3\u5c11\u6307\u5b9a\u7684\u65f6\u95f4\u91cf\uff0c\u5c06\u5bfc\u81f4\u8bb0\u5f55\u6bcf\u4e00\u4e2a\u8fd9\u79cd\u5b8c\u6210\u7684\u8bed\u53e5\u7684\u6301\u7eed\u65f6\u95f4\nlog_duration = on                     # \u6bcf\u4e00\u4e2a\u5b8c\u6210\u7684\u8bed\u53e5\u7684\u6301\u7eed\u65f6\u95f4\u88ab\u8bb0\u5f55\nlog_lock_waits = on                   # \u63a7\u5236\u5f53\u4e00\u4e2a\u4f1a\u8bdd\u4e3a\u83b7\u5f97\u4e00\u4e2a\u9501\u7b49\u5230\u8d85\u8fc7deadlock_timeout\u65f6\uff0c\u662f\u5426\u8981\u4ea7\u751f\u4e00\u4e2a\u65e5\u5fd7\u6d88\u606f\nlog_statement = 'mod'                 # \u63a7\u5236\u54ea\u4e9b SQL \u8bed\u53e5\u88ab\u8bb0\u5f55\u3002\u6709\u6548\u503c\u662f none (off)\u3001ddl\u3001mod\u548c all\uff08\u6240\u6709\u8bed\u53e5\uff09\u3002ddl\u8bb0\u5f55\u6240\u6709\u6570\u636e\u5b9a\u4e49\u8bed\u53e5\uff0c\u4f8b\u5982CREATE\u3001ALTER\u548c DROP\u8bed\u53e5\u3002mod\u8bb0\u5f55\u6240\u6709ddl\u8bed\u53e5\uff0c\u5916\u52a0\u6570\u636e\u4fee\u6539\u8bed\u53e5\u4f8b\u5982INSERT, UPDATE\u3001DELETE\u3001TRUNCATE, \u548cCOPY FROM\nlog_timezone = 'Asia/Shanghai'        # \u8bbe\u7f6e\u5728\u670d\u52a1\u5668\u65e5\u5fd7\u4e2d\u5199\u5165\u7684\u65f6\u95f4\u6233\u7684\u65f6\u533a\n\n# sql\nstatement_timeout = 300000            # \u8bed\u53e5\u6267\u884c\u8d85\u65f6\u65f6\u95f4 5\u5206\u949f\nidle_in_transaction_session_timeout = 300000   # \u4e8b\u52a1\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4 5\u5206\u949f\nidle_session_timeout = 1800000        # \u4f1a\u8bdd\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4 30\u5206\u949f\nlock_timeout = 60000                  # \u7b49\u9501\u8d85\u65f6\u65f6\u95f4 1\u5206\u949f\n"})}),"\n",(0,l.jsx)(n.h4,{id:"5-\u91cd\u542f\u4e3b\u5e93",children:"5. \u91cd\u542f\u4e3b\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker container restart postgres-master\n\npg_ctl restart -D $PGDATA -l $PGLOG\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u4ece\u5e93\u914d\u7f6e-slave-docker\u90e8\u7f72",children:"3. \u4ece\u5e93\u914d\u7f6e (Slave Docker\u90e8\u7f72)"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u6b64\u6b65\u9aa4\u9002\u7528\u4e8eDocker\u90e8\u7f72"]}),"\n",(0,l.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u4ece\u5e93",children:"1. \u521d\u59cb\u5316\u4ece\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u6587\u4ef6\u5939\nmkdir -p //d/docker/pgsql-slave/{conf,data,logs,temp}\n\n# \u8fd0\u884c\u5bb9\u5668 (\u6b64\u65f6\u6302\u8f7d\u7684\u6570\u636e\u76ee\u5f55\u662f temp)\ndocker run -d \\\n  --publish 5434:5432 \\\n  --volume //d/docker/pgsql-slave/temp:/var/lib/postgresql/data \\\n  --env PGDATA=/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=postgres \\\n  --net pgsql \\\n  --ip 172.18.0.3 \\\n  --restart=no \\\n  --name postgres-slave \\\n  postgres:15.3\n"})}),"\n",(0,l.jsx)(n.h4,{id:"2-\u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93",children:"2. \u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root postgres-slave /bin/bash\n\npsql -h 172.18.0.2 -p 5432 -U postgres -W -d postgres\n# \u53ef\u4ee5\u6b63\u5e38\u8f93\u5165\u5bc6\u7801\u767b\u5f55\u5373\u53ef\n"})}),"\n",(0,l.jsx)(n.h4,{id:"3-\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",children:"3. \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6\npg_basebackup -D /var/lib/postgresql/data/replica -h 172.18.0.2 -p 5432 -U replica -Fp -Xs -Pv -R\n\n\n"})}),"\n",(0,l.jsx)(n.h4,{id:"4-\u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93",children:"4. \u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u505c\u6b62\u5e76\u5220\u9664\u955c\u50cf\ndocker stop postgres-slave && docker container remove postgres-slave\n\n# \u5c06 //d/docker/pgsql-slave/temp/replica \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u590d\u5236\u5230 //d/docker/pgsql-slave/data \u4e0b\n\n# \u8fd0\u884c\u5bb9\u5668 (\u6b64\u65f6\u6302\u8f7d\u7684\u6570\u636e\u76ee\u5f55\u662f data)\ndocker run -d \\\n  --publish 5434:5432 \\\n  --volume //d/docker/pgsql-slave/data:/var/lib/postgresql/data \\\n  --env PGDATA=/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=postgres \\\n  --net pgsql \\\n  --ip 172.18.0.3 \\\n  --restart=no \\\n  --name postgres-slave \\\n  postgres:15.3\n"})}),"\n",(0,l.jsx)(n.h3,{id:"4-\u4ece\u5e93\u914d\u7f6e-standby-\u7269\u7406\u673a\u90e8\u7f72",children:"4. \u4ece\u5e93\u914d\u7f6e (Standby \u7269\u7406\u673a\u90e8\u7f72)"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u6b64\u6b65\u9aa4\u9002\u7528\u4e8e\u7269\u7406\u673a\u90e8\u7f72"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/download/linux/#generic",children:"PostgreSQL: Linux downloads"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.postgresql.org/ftp/source/",children:"PostgreSQL: File Browser"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.jianshu.com/p/685f946bd490",children:"Ubuntu 22.04.3 \u5b89\u88c5 PostgreSQL 15"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://blog.csdn.net/qq_33445829/article/details/130033182",children:"Centos7.6\u5b89\u88c5postgresql15"})}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u4ece\u5e93-1",children:"1. \u521d\u59cb\u5316\u4ece\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u5b89\u88c5\u4f9d\u8d56\nyum -y install tcl tcl-devel uuid-devel perl-ExtUtils-Embed readline-devel zlib-devel pam-devel libxml2-devel libxslt-devel openldap-devel python-devel gcc-c++ openssl-devel cmake gcc* readline-devel\n\n# \u4e0b\u8f7d\u6e90\u7801\u5305 \nwget https://ftp.postgresql.org/pub/source/v15.3/postgresql-15.3.tar.gz -O /usr/local/src/postgresql-15.3.tar.gz\n\n# \u89e3\u538b\u538b\u7f29\u5305\ncd /usr/local/src && tar -zxvf postgresql-15.3.tar.gz\n\n# \u68c0\u6d4b\u7cfb\u7edf\u4f9d\u8d56\ncd postgresql-15.3 && ./configure --prefix=/usr/local/pgsql\n\n# \u7f16\u8bd1\nmake clean; make\n\n# \u5b89\u88c5\nmake install\n\n# \u521b\u5efa\u6570\u636e\u76ee\u5f55\ncd /usr/local/pgsql\nmkdir data\n\n# \u6dfb\u52a0pgsql\u7528\u6237\nadduser postgres\n# passwd postgres\nchown -R postgres:postgres /usr/local/pgsql\nchmod 750 /usr/local/pgsql/data\n\n# \u914d\u7f6e\u73af\u5883\u53d8\u91cf\ncat >> /etc/profile << 'EOF'\n# Pgsql \u73af\u5883\u53d8\u91cf\nPGHOME=/usr/local/pgsql\nPGDATA=$PGHOME/data\nPATH=$PATH:$HOME/.local/bin:$HOME/bin:$PGHOME/bin\nexport PGHOME PGDATA PATH\n\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nsource /etc/profile\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6ce8\u610f"})," \u4e0d\u9700\u8981\u521d\u59cb\u5316\u548c\u542f\u52a8\u6570\u636e\u5e93"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521d\u59cb\u5316\u6570\u636e\u5e93\n${PGHOME}/bin/initdb -D ${PGDATA} --encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8 \n\n# \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\nvim ${PGDATA}/postgresql.conf\n\n# \u542f\u52a8\u6570\u636e\u5e93\npg_ctl start\n"})}),"\n",(0,l.jsx)(n.h4,{id:"2-\u505c\u6b62\u4ece\u5e93\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",children:"2. \u505c\u6b62\u4ece\u5e93\uff0c\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\uff0c\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u5207\u6362\u5230postgres\u7528\u6237\nsu - postgres\n\n# \u505c\u6b62pgsql (\u5982\u679c\u524d\u9762\u542f\u52a8\u4e86\u6570\u636e\u5e93\u5219\u9700\u8981\u505c\u6b62)\npg_ctl status\npg_ctl stop -D $PGDATA -l $PGLOG\n\n# \u6e05\u7a7a\u6570\u636e\u6587\u4ef6(\u5982\u679c\u524d\u9762\u542f\u52a8\u4e86\u6570\u636e\u5e93\u5219\u9700\u8981\u6e05\u9664\u6570\u636e\u76ee\u5f55)\nrm -rf  /usr/local/pgsql/data/*\n\n# \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6\npg_basebackup -D /usr/local/pgsql/data/ -h 172.18.0.2 -p 5432 -U replica -Fp -Xs -Pv -R -W\n"})}),"\n",(0,l.jsx)(n.h4,{id:"5-\u91cd\u542f\u4ece\u5e93",children:"5. \u91cd\u542f\u4ece\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"pg_ctl restart\n"})}),"\n",(0,l.jsx)(n.h3,{id:"5-\u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",children:"5. \u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65"}),"\n",(0,l.jsx)(n.h4,{id:"1-\u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f",children:"1. \u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u4e3b\u5e93\nsu - postgres\npsql postgres\nselect client_addr,sync_state from pg_stat_replication;\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u7ed3\u679c\u5982\u4e0b"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"client_addr"}),(0,l.jsx)(n.th,{children:"sync_state"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"172.18.0.3"}),(0,l.jsx)(n.td,{children:"sync"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"172.18.0.1"}),(0,l.jsx)(n.td,{children:"potential"})]})]})]}),"\n",(0,l.jsx)(n.h4,{id:"2-\u67e5\u8be2\u8282\u70b9\u72b6\u6001",children:"2. \u67e5\u8be2\u8282\u70b9\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u4e3b\u5e93\npg_controldata | grep 'Database cluster state'\n# \u8f93\u51fa\u5982\u4e0b\n# Database cluster state:               in production\n\n# \u4ece\u5e93\npg_controldata | grep 'Database cluster state'\n# \u8f93\u51fa\u5982\u4e0b\n# Database cluster state:               in archive recovery\n"})}),"\n",(0,l.jsx)(n.h4,{id:"3-\u6570\u636e\u540c\u6b65\u6d4b\u8bd5",children:"3. \u6570\u636e\u540c\u6b65\u6d4b\u8bd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u4e3b\u5e93\u6267\u884c\npsql -h localhost -p 5432 -U postgres -W -d postgres\nselect client_addr,usename,backend_start,application_name,sync_state,sync_priority FROM pg_stat_replication;\nCREATE DATABASE test;\n\\connect pgtest\nDROP DATABASE test;\n\n# \u4ece\u5e93\u6267\u884c\npsql -h localhost -p 5432 -U postgres -W -d postgres\nSELECT datname FROM pg_database;\n\\connect pgtest\n# \u4e3b\u5e93\u65b0\u5efa\u5220\u9664\u6570\u636e\u5e93\u65f6\uff0c\u4ece\u5e93\u4e5f\u5c06\u6570\u636e\u540c\u6b65\u8fc7\u6765\u4e86\n"})}),"\n",(0,l.jsx)(n.h3,{id:"6-\u521b\u5efa\u53ea\u8bfb\u8d26\u53f7",children:"6. \u521b\u5efa\u53ea\u8bfb\u8d26\u53f7"}),"\n",(0,l.jsx)(n.p,{children:"\u5728\u4e3b\u5e93\u6267\u884c\u5373\u53ef\uff0c\u8d26\u53f7\u4fe1\u606f\u4f1a\u540c\u6b65\u5230\u5176\u4ed6\u8282\u70b9"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# 1. \u521b\u5efa\u4e00\u4e2a\u7528\u6237\u540d\u4e3areadonly\u5bc6\u7801\u4e3aropass\u7684\u7528\u6237\nCREATE USER readonly WITH ENCRYPTED PASSWORD 'ropass';\n\n# 2. \u7528\u6237\u53ea\u8bfb\u4e8b\u52a1\nALTER USER readonly SET default_transaction_read_only=on;\n\n# 3. \u628a\u6240\u6709\u5e93\u7684\u8bed\u8a00\u7684USAGE\u6743\u9650\u7ed9\u5230readonly\nGRANT USAGE ON SCHEMA public TO readonly;\n\n# 4. \u6388\u4e88select\u6743\u9650(\u8fd9\u53e5\u8981\u8fdb\u5165\u5177\u4f53\u6570\u636e\u5e93\u64cd\u4f5c\u5728\u54ea\u4e2adb\u73af\u5883\u6267\u884c\u5c31\u6388\u4e88\u90a3\u4e2adb\u7684\u6743)\nGRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"mysql-\u96c6\u7fa4\u5b89\u88c5docker\u7248",children:"Mysql \u96c6\u7fa4\u5b89\u88c5\uff08Docker\u7248\uff09"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://www.cnblogs.com/songwenjie/p/9371422.html",children:"\u57fa\u4e8eDocker\u7684Mysql\u4e3b\u4ece\u590d\u5236\u642d\u5efa"})}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u4e3a\u4e86\u56fa\u5b9aIP\u53ef\u4ee5\u5355\u72ec\u521b\u5efa\u4e00\u4e2a\u7f51\u7edc"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"master: 172.18.0.2"}),"\n",(0,l.jsx)(n.li,{children:"slave: 172.18.0.3"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u7f51\u7edc\ndocker network create --subnet=172.18.0.0/16 mysql\n\n# \u5bb9\u5668\u521b\u5efa\u540e\u53ef\u4ee5\u4f7f\u7528\u6b64\u547d\u4ee4\u67e5\u770b\u5bb9\u5668IP\ndocker inspect mysql-master | grep IPAddress \n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6ce8\u610f:"})," \u5982\u679c\u5355\u72ec\u521b\u5efa\u7f51\u7edc\uff0c\u5176\u4ed6\u975e\u672c\u7f51\u7edc\u7684\u5bb9\u5668\u65e0\u6cd5\u8bbf\u95ee\u6b64\u7f51\u7edc"]}),"\n",(0,l.jsx)(n.h3,{id:"1-\u4e3b\u5e93\u914d\u7f6emaster",children:"1. \u4e3b\u5e93\u914d\u7f6e\uff08Master\uff09"}),"\n",(0,l.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u6570\u636e\u5e93",children:"1. \u521d\u59cb\u5316\u6570\u636e\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"\n# \u521b\u5efa\u6587\u4ef6\u5939\nmkdir -p //d/docker/mysql-master/{conf,data,logs}\n\n# \u8fd0\u884c\u5bb9\u5668\ndocker run -d \\\n  --publish 3316:3306 \\\n  --volume //d/docker/mysql-master/data:/var/lib/mysql \\\n  --volume //d/docker/mysql-master/conf:/etc/mysql/conf.d \\\n  --volume //d/docker/mysql-master/logs:/var/log/mysql \\\n  --env MYSQL_ROOT_PASSWORD=admin \\\n  --env MYSQL_DATABASE=test \\\n  --env MYSQL_USER=test \\\n  --env MYSQL_PASSWORD=test \\\n  --net mysql \\\n  --ip 172.18.0.2 \\\n  --restart=on-failure:3 \\\n  --name mysql-master \\\n  mysql:8.0\n\n"})}),"\n",(0,l.jsxs)(n.h4,{id:"2-\u914d\u7f6e-etcmysqlconfdmysqlcnf",children:["2. \u914d\u7f6e ",(0,l.jsx)(n.code,{children:"/etc/mysql/conf.d/mysql.cnf"})]}),"\n",(0,l.jsxs)(n.p,{children:["\u5728 ",(0,l.jsx)(n.code,{children:"//d/docker/mysql-master/conf"})," \u4e0b\u65b0\u5efa\u6587\u4ef6 ",(0,l.jsx)(n.code,{children:"mysql.cnf"})," \u5373\u53ef"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-conf",children:"[mysqld]\n# \u540c\u4e00\u5c40\u57df\u7f51\u5185\u6ce8\u610f\u8981\u552f\u4e00\nserver-id=100\n# \u5f00\u542f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u529f\u80fd\uff0c\u53ef\u4ee5\u968f\u4fbf\u53d6\uff08\u5173\u952e\uff09\nlog-bin=mysql-bin\n# \u751f\u6210\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u540d\u79f0\u683c\u5f0f\nlog-bin-index=mysql-bin.index\n# binary log \u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u7684\u683c\u5f0f\uff0c\u6709\u4e09\u79cd\uff08statement \uff0c row , mixed\uff09\uff0c\u53ef\u4ee5\u6839\u636e\u573a\u666f\u9009\u7528\uff0cmysql\u9ed8\u8ba4\u91c7\u7528statement\uff0c\u5efa\u8bae\u4f7f\u7528mixed\nbinlog_format=MIXED\n# \u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u5199\u5165\u78c1\u76d8\u5e76\u7acb\u5373\u6267\u884c\u5237\u65b0\u64cd\u4f5c\uff0c\u76f8\u5f53\u4e8e\u662f\u540c\u6b65\u5199\u5165\u78c1\u76d8\uff0c\u4e0d\u7ecf\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f13\u5b58\nsync_binlog=1\n# \u81ea\u52a8\u6e05\u9664\uff08purge\uff09\u8bbe\u5b9a\u5929\u6570\u524d\u751f\u6210\u7684binlog\u65e5\u5fd7\u6587\u4ef6\nexpire_logs_days=90\n# \u63d0\u4ea4\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u628a redo log \u4ece\u5185\u5b58\u5237\u5165\u5230\u78c1\u76d8\u6587\u4ef6\u91cc\u53bb\uff0c\u53ea\u8981\u4e8b\u52a1\u63d0\u4ea4\u6210\u529f\uff0c\u90a3\u4e48 redo log \u5c31\u5fc5\u7136\u5728\u78c1\u76d8\u91cc\u4e86\ninnodb_flush_log_at_trx_commit=1\n\n# \u9700\u8981\u540c\u6b65\u7684\u6570\u636e\u5e93\uff0c\u591a\u4e2a\u5e93\u5728slave\u7aef\u6307\u5b9a\n# binlog-do-db=test\n# \u5ffd\u7565\u7684\u6570\u636e\u5e93\n# binlog_ignore_db=mysql\n"})}),"\n",(0,l.jsx)(n.h4,{id:"3-\u521b\u5efa\u540c\u6b65\u7528\u6237",children:"3. \u521b\u5efa\u540c\u6b65\u7528\u6237"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root mysql-master /bin/bash\n\nmysql -u root -p\n\nSHOW DATABASES;\nUSE mysql;\nSELECT user, host, authentication_string, plugin FROM user;\nDROP USER 'slave'@'%';\nCREATE USER 'slave'@'%' IDENTIFIED BY 'slave';\nGRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';\nFLUSH PRIVILEGES;\n\ndocker container restart mysql-master\n"})}),"\n",(0,l.jsx)(n.h4,{id:"4-\u91cd\u542f\u6570\u636e\u5e93",children:"4. \u91cd\u542f\u6570\u636e\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker container restart mysql-master\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u4ece\u5e93\u914d\u7f6eslave",children:"2. \u4ece\u5e93\u914d\u7f6e\uff08Slave\uff09"}),"\n",(0,l.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u6570\u636e\u5e93-1",children:"1. \u521d\u59cb\u5316\u6570\u636e\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u6587\u4ef6\u5939\nmkdir -p //d/docker/mysql-slave/{conf,data,logs}\n\n# \u8fd0\u884c\u5bb9\u5668\ndocker run -d \\\n  --publish 3326:3306 \\\n  --volume //d/docker/mysql-slave/data:/var/lib/mysql \\\n  --volume //d/docker/mysql-slave/conf:/etc/mysql/conf.d \\\n  --volume //d/docker/mysql-slave/logs:/var/log/mysql \\\n  --env MYSQL_ROOT_PASSWORD=admin \\\n  --env MYSQL_DATABASE=test \\\n  --env MYSQL_USER=test \\\n  --env MYSQL_PASSWORD=test \\\n  --net mysql \\\n  --ip 172.18.0.3 \\\n  --restart=on-failure:3 \\\n  --name mysql-slave \\\n  mysql:8.0\n\n"})}),"\n",(0,l.jsxs)(n.h4,{id:"2-\u914d\u7f6e-etcmysqlconfdmysqlcnf-1",children:["2. \u914d\u7f6e ",(0,l.jsx)(n.code,{children:"/etc/mysql/conf.d/mysql.cnf"})]}),"\n",(0,l.jsxs)(n.p,{children:["\u5728 ",(0,l.jsx)(n.code,{children:"//d/docker/mysql-slave/conf"})," \u4e0b\u65b0\u5efa\u6587\u4ef6 ",(0,l.jsx)(n.code,{children:"mysql.cnf"})," \u5373\u53ef"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-conf",children:"[mysqld]\n## \u8bbe\u7f6eserver_id,\u6ce8\u610f\u8981\u552f\u4e00\nserver-id=101\n## \u5f00\u542f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u529f\u80fd\uff0c\u4ee5\u5907Slave\u4f5c\u4e3a\u5176\u5b83Slave\u7684Master\u65f6\u4f7f\u7528\nlog-bin=mysql-slave-bin\n## relay_log\u914d\u7f6e\u4e2d\u7ee7\u65e5\u5fd7\nrelay_log=mysqld-relay-bin\n# \u4e2d\u7ee7\u65e5\u5fd7\u6587\u4ef6\u7684\u547d\u540d\u683c\u5f0f\nrelay-log-index=mysqld-relay-bin.index\n\n# \u6307\u5b9a\u8981\u590d\u5236\u7684\u5e93\uff0c\u591a\u4e2a\u6dfb\u52a0\u591a\u884c\n# \u5728master\u7aef\u4e0d\u6307\u5b9a binlog-do-db \uff0c\u5728slave\u7aef\u7528 replicate-do-db \u6765\u8fc7\u6ee4\n# replicate-do-db=test1\n# replicate-do-db=test2\n# \u5ffd\u7565\u7684\u6570\u636e\u5e93\uff0c\u591a\u4e2a\u6570\u636e\u5e93\u5199\u591a\u6761\n# replicate-ignore-db=mysql\n"})}),"\n",(0,l.jsx)(n.h4,{id:"3-\u91cd\u542f\u6570\u636e\u5e93",children:"3. \u91cd\u542f\u6570\u636e\u5e93"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker container restart mysql-slave\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u8fde\u63a5master\u548cslave",children:"3. \u8fde\u63a5Master\u548cSlave"}),"\n",(0,l.jsx)(n.h4,{id:"1-\u4e3b\u5e93\u64cd\u4f5c",children:"1. \u4e3b\u5e93\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root mysql-master /bin/bash\n\nmysql -u root -p\n\n# \u67e5\u770blog_bin\u662f\u5426\u5f00\u542f\nshow variables like 'log_bin';\n\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| log_bin       | ON    |\n+---------------+-------+\n\n# \u67e5\u770bmaster\u8282\u70b9\u72b6\u6001\nshow master status;\n\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000001 |      157 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"File"}),"\u548c",(0,l.jsx)(n.code,{children:"Position"}),"\u5b57\u6bb5\u7684\u503c\u540e\u9762\u5c06\u4f1a\u7528\u5230\uff0c\u5728\u540e\u9762\u7684\u64cd\u4f5c\u5b8c\u6210\u4e4b\u524d\uff0c\u9700\u8981\u4fdd\u8bc1Master\u5e93\u4e0d\u80fd\u505a\u4efb\u4f55\u64cd\u4f5c\uff0c\u5426\u5219\u5c06\u4f1a\u5f15\u8d77\u72b6\u6001\u53d8\u5316\uff0cFile\u548cPosition\u5b57\u6bb5\u7684\u503c\u53d8\u5316\u3002"]}),"\n",(0,l.jsx)(n.h4,{id:"2-\u4ece\u5e93\u64cd\u4f5c",children:"2. \u4ece\u5e93\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root mysql-slave /bin/bash\n\nmysql -u root -p\n\n# \u540c\u6b65\u4e3b\u5e93 master_log_file \u53ca master_log_pos \u7684\u503c\u662f\u524d\u9762\u4e3b\u5e93\u8bb0\u5f55\u7684\u503c\nCHANGE MASTER TO master_host='172.18.0.2', master_port=3306, master_user='slave', master_password='slave', master_log_file='mysql-bin.000001', master_log_pos= 157, master_connect_retry=30, get_master_public_key=1;\n\n# \u67e5\u770b\u4e3b\u4ece\u540c\u6b65\u72b6\u6001\nshow slave status \\G;\n\n# \u5f00\u542f\u4e3b\u4ece\u590d\u5236\uff0c\u51fa\u73b0\u5f02\u5e38\u53ef\u4ee5\u505c\u6b62\u540c\u6b65\uff0c\u91cd\u7f6e\u4e2d\u7ee7\u65e5\u5fd7\uff0c\u4fee\u590d\u540e\u518d\u6b21\u5f00\u542f\nstart slave;\n# stop slave;\n# reset slave;\n\n# \u67e5\u770b\u4e3b\u4ece\u540c\u6b65\u72b6\u6001\nshow slave status \\G;\n\n# \u8f93\u51fa\u7ed3\u679c\uff1a\u5982\u679c\u4e0a\u9762\u4e24\u884c\u4e3a Yes \u8868\u793a\u5df2\u7ecf\u6b63\u5e38\u5f00\u542f\u4e3b\u4ece\u590d\u5236\uff0c\u5426\u5219\u6839\u636e\u9519\u8bef\u7801\u548c\u9519\u8bef\u4fe1\u606f\u6392\u67e5\u95ee\u9898\n Slave_IO_Running: Yes\nSlave_SQL_Running: Yes\n    Last_IO_Errno: \u9519\u8bef\u7801\n    Last_IO_Error: \u9519\u8bef\u4fe1\u606f\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u547d\u4ee4\u8bf4\u660e\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_host"})," : Master\u7684\u5730\u5740\uff0c\u6307\u7684\u662f\u5bb9\u5668\u7684\u72ec\u7acbip\uff0c\u53ef\u4ee5\u901a\u8fc7",(0,l.jsx)(n.code,{children:"docker inspect --format='{{.NetworkSettings.IPAddress}}' mysql-master"}),"  \u67e5\u8be2\u5bb9\u5668\u7684ip"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_port"})," : Master\u7684\u7aef\u53e3\u53f7\uff0c\u6307\u7684\u662f\u5bb9\u5668\u7684\u7aef\u53e3\u53f7"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_user"})," : \u7528\u4e8e\u6570\u636e\u540c\u6b65\u7684\u7528\u6237"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_password"})," : \u7528\u4e8e\u540c\u6b65\u7684\u7528\u6237\u7684\u5bc6\u7801"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_log_file"})," : \u6307\u5b9a Slave \u4ece\u54ea\u4e2a\u65e5\u5fd7\u6587\u4ef6\u5f00\u59cb\u590d\u5236\u6570\u636e\uff0c\u5373\u4e0a\u6587\u4e2d\u63d0\u5230\u7684 ",(0,l.jsx)(n.code,{children:"File"})," \u5b57\u6bb5\u7684\u503c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_log_pos"})," : \u4ece\u54ea\u4e2a ",(0,l.jsx)(n.code,{children:"Position"})," \u5f00\u59cb\u8bfb\uff0c\u5373\u4e0a\u6587\u4e2d\u63d0\u5230\u7684 ",(0,l.jsx)(n.code,{children:"Position"})," \u5b57\u6bb5\u7684\u503c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"master_connect_retry"})," : \u5982\u679c\u8fde\u63a5\u5931\u8d25\uff0c\u91cd\u8bd5\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u5355\u4f4d\u662f\u79d2\uff0c\u9ed8\u8ba4\u662f60\u79d2"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"get_master_public_key"})," : \u83b7\u53d6\u4e3b\u5e93\u5bc6\u94a5"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5728Slave \u4e2d\u7684mysql\u7ec8\u7aef\u6267\u884c ",(0,l.jsx)(n.code,{children:"show slave status \\G;"})," \u7528\u4e8e\u67e5\u770b\u4e3b\u4ece\u540c\u6b65\u72b6\u6001\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c",(0,l.jsx)(n.code,{children:"Slave_IO_Running"})," \u548c",(0,l.jsx)(n.code,{children:" Slave_SQL_Running"})," \u90fd\u662f",(0,l.jsx)(n.code,{children:"No"}),"\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5f00\u542f\u4e3b\u4ece\u590d\u5236\u8fc7\u7a0b\u3002\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"start slave;"})," \u5f00\u542f\u4e3b\u4ece\u590d\u5236\u8fc7\u7a0b\uff0c\u7136\u540e\u518d\u6b21\u67e5\u8be2\u4e3b\u4ece\u540c\u6b65\u72b6\u6001 ",(0,l.jsx)(n.code,{children:"show slave status \\G;"}),"\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Slave_IO_Running"})," \u548c ",(0,l.jsx)(n.code,{children:"Slave_SQL_Running"})," \u90fd\u662f",(0,l.jsx)(n.code,{children:"Yes"}),"\uff0c\u8bf4\u660e\u4e3b\u4ece\u590d\u5236\u5df2\u7ecf\u5f00\u542f\u3002\u6b64\u65f6\u53ef\u4ee5\u6d4b\u8bd5\u6570\u636e\u540c\u6b65\u662f\u5426\u6210\u529f\u3002"]}),"\n",(0,l.jsx)(n.h3,{id:"4-\u5e38\u89c1\u9519\u8bef",children:"4. \u5e38\u89c1\u9519\u8bef"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\u767b\u5f55\u51fa\u73b0 ",(0,l.jsx)(n.code,{children:"mysql: [Warning] World-writable config file '/etc/mysql/conf.d/mysql.cnf' is ignored."}),"\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u8fd9\u4e2a\u8b66\u544a\u51fa\u73b0\u7684\u539f\u56e0\u662f MySQL \u53d1\u73b0\u6302\u8f7d\u7684\u914d\u7f6e\u6587\u4ef6 ",(0,l.jsx)(n.code,{children:"/etc/mysql/conf.d/mysql.cnf"})," \u5177\u6709\u5168\u5c40\u53ef\u5199\u6743\u9650\uff0c\u56e0\u6b64\u5ffd\u7565\u4e86\u8be5\u6587\u4ef6\u3002MySQL \u5f15\u64ce\u975e\u5e38\u6ce8\u91cd\u5b89\u5168\u6027\u548c\u6570\u636e\u5b8c\u6574\u6027\u3002\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u5177\u6709\u5168\u5c40\u53ef\u5199\u6743\u9650\uff0c\u4efb\u4f55\u7528\u6237\u90fd\u53ef\u4ee5\u4fee\u6539\u8be5\u6587\u4ef6\uff0c\u5305\u62ec\u6076\u610f\u7528\u6237\u3002\u8fd9\u53ef\u80fd\u5bfc\u81f4\u6f5c\u5728\u7684\u5b89\u5168\u98ce\u9669\u548c\u6570\u636e\u635f\u574f\u3002\u4e3a\u4e86\u63d0\u9ad8\u5b89\u5168\u6027\uff0c\u5f53 MySQL \u68c0\u6d4b\u5230\u6302\u8f7d\u7684\u914d\u7f6e\u6587\u4ef6\u5177\u6709\u5168\u5c40\u53ef\u5199\u6743\u9650\u65f6\uff0c\u5b83\u4f1a\u53d1\u51fa\u8b66\u544a\u5e76\u5ffd\u7565\u8be5\u6587\u4ef6\u3002\u8fd9\u6837\u505a\u662f\u4e3a\u4e86\u786e\u4fdd\u53ea\u6709\u6388\u6743\u7684\u7528\u6237\u80fd\u591f\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5e76\u5bf9 MySQL \u8fdb\u884c\u66f4\u6539\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:'# \u5c06 dos \u6587\u4ef6\u8f6c\u4e3a unix \u6587\u4ef6\nawk \'{ sub("\\r$", ""); print }\' /etc/mysql/conf.d/mysql.cnf > /etc/mysql/conf.d/mysql.cnf\n\n# \u4fee\u6539\u6743\u9650\nchmod 644 /etc/mysql/conf.d/mysql.cnf\n'})}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"start slave;"})," \u5f00\u542f\u4e3b\u4ece\u540c\u6b65\u51fa\u73b0 ",(0,l.jsx)(n.code,{children:"Authentication plugin 'caching_sha2_password' reported error: Authentication requires secure connection."})]}),"\n"]}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"Last_IO_Error: Error connecting to source 'slave@172.18.0.2:3306'. This was attempt 1/86400, with a delay of 30 seconds between attempts. Message: Authentication plugin 'caching_sha2_password' reported error: Authentication requires secure connection."}),"\n"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/sha256-pluggable-authentication.html",children:"Section 6.4.1.3, \u201cSHA-256 Pluggable Authentication\u201d."})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password",children:"caching_sha2_password as the Preferred Authentication Plugin."})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/encrypted-connections.html",children:"Section 6.3, \u201cUsing Encrypted Connections\u201d"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html",children:"MySQL :: MySQL 8.0 Reference Manual :: 6.4.1.2 Caching SHA-2 Pluggable Authentication"})}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["Mysql 8.0 \u9ed8\u8ba4\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"caching_sha2_password"})," \u63d2\u4ef6\u5bf9\u767b\u5f55\u4fe1\u606f\u8fdb\u884c\u52a0\u5bc6\uff0c\u6b64\u65b9\u5f0f\u9700\u8981\u914d\u7f6e\u8ba4\u8bc1\u516c\u94a5\uff0c\u53ef\u4ee5\u6539\u4e3a ",(0,l.jsx)(n.code,{children:"mysql_native_password"})," \u63d2\u4ef6\u8ba4\u8bc1\u6216\u8005\u914d\u7f6e\u83b7\u53d6Master\u8282\u70b9\u7684\u516c\u94a5"]}),"\n",(0,l.jsxs)(n.p,{children:["\u65b9\u6848\u4e00: ",(0,l.jsx)(n.a,{href:"https://blog.csdn.net/qq_58645958/article/details/130272982",children:"\u4fee\u6539\u7528\u6237\u7684\u8ba4\u8bc1\u65b9\u5f0f"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root mysql-master /bin/bash\n\nmysql -u root -p\n\nUSE mysql;\nSELECT plugin FROM `user` WHERE user = 'slave';\n# \u5c06 caching_sha2_password \u6539\u4e3a mysql_native_password\nALTER USER 'slave'@'%' IDENTIFIED WITH mysql_native_password BY 'slave';\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u65b9\u6848\u4e8c: ",(0,l.jsx)(n.a,{href:"https://blog.csdn.net/weixin_55136824/article/details/131822062",children:"\u6dfb\u52a0\u8bfb\u53d6\u4e3b\u5e93\u516c\u94a5\u914d\u7f6e"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root mysql-slave /bin/bash\n\nmysql -u root -p\n\nCHANGE MASTER TO GET_MASTER_PUBLIC_KEY=1;\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"3",children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"ERROR 1872 (HY000): Replica failed to initialize applier metadata structure from the repository"})}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u56e0\u4e3a\u4ece\u6570\u636e\u5e93\u53ef\u80fd\u4ee5\u524d\u914d\u7f6e\u8fc7\uff0c\u751f\u6210\u8fc7 \u4e2d\u7ee7\u65e5\u5fd7\u6587\u4ef6\uff0c\u5bfc\u81f4 \u4ece\u6570\u636e\u5e93 slave \u4e2d\u8fd8\u8bb0\u5f55\u7740\u65e7\u6570\u636e\uff0c\u8fd9\u65f6\u53ef\u4ee5\u4f7f\u7528 \u547d\u4ee4 ",(0,l.jsx)(n.code,{children:"reset slave;"})]}),"\n",(0,l.jsx)(n.h2,{id:"\u5b89\u88c5mycat",children:"\u5b89\u88c5Mycat"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/MyCATApache/Mycat-Server/releases/download/Mycat-server-1675-release/Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz",children:"Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"http://www.manongjc.com/detail/52-btpqcqewaykjbuq.html",children:"Mycat\uff08\u5b9e\u8df5\u7bc7 - \u57fa\u4e8ePostgreSQL\u7684\u6c34\u5e73\u5207\u5206\u3001\u4e3b\u4ece\u590d\u5236\u3001\u8bfb\u5199\u5206\u79bb\uff09"})}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"1-\u4e0b\u8f7d\u5b89\u88c5",children:"1. \u4e0b\u8f7d\u5b89\u88c5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u4e0b\u8f7d\u89e3\u538b\nwget https://github.com/MyCATApache/Mycat-Server/releases/download/Mycat-server-1675-release/Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz\ntar -zxvf Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz  /usr/local/\n\n# \u521b\u5efa\u7528\u6237\ncd mycat\nsudo useradd mycat\nsudo passwd mycat\nsudo chown -R mycat:mycat /usr/local/mycat\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u73af\u5883\u914d\u7f6e",children:"2. \u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u914d\u7f6e\u73af\u5883\u53d8\u91cf \ncat >> /etc/profile << 'EOF'\n# MyCat \u73af\u5883\u53d8\u91cf \nMYCAT_HOME=/usr/local/mycat\nPATH=$MYCAT_HOME/bin:$PATH\nexport PATH\nEOF\n\n# \u4f7f\u914d\u7f6e\u751f\u6548\nsource /etc/profile\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u6570\u636e\u5e93\u9a71\u52a8",children:"3. \u6570\u636e\u5e93\u9a71\u52a8"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5bf9\u4e8eMysql MariaDB \u4e0d\u9700\u8981\u989d\u5916\u914d\u7f6e\u6570\u636e\u5e93\u9a71\u52a8"}),"\n",(0,l.jsxs)(n.li,{children:["\u5bf9\u4e8ePostgresql Oracle SqlServer\u9700\u8981\u63d0\u4f9bJDBC\u9a71\u52a8\u5230 ",(0,l.jsx)(n.code,{children:"/usr/local/mycat/lib/"})," \u76ee\u5f55\u4e0b"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u914d\u7f6emycat",children:"\u914d\u7f6eMycat"}),"\n",(0,l.jsxs)(n.h3,{id:"1-\u5728master\u6570\u636e\u5e93\u4e2d\u6dfb\u52a0user1\u5199user2\u53ea\u8bfb\u4e24\u4e2a\u8d26\u6237\u5e76\u914d\u7f6e\u6743\u9650",children:["1. \u5728master\u6570\u636e\u5e93\u4e2d\u6dfb\u52a0",(0,l.jsx)(n.code,{children:"user1"}),"\uff08\u5199\uff09\u3001",(0,l.jsx)(n.code,{children:"user2"}),"\uff08\u53ea\u8bfb\uff09\u4e24\u4e2a\u8d26\u6237\uff0c\u5e76\u914d\u7f6e\u6743\u9650\u3002"]}),"\n",(0,l.jsxs)(n.h3,{id:"2-\u914d\u7f6emycat\u7684schemaxml",children:["2. \u914d\u7f6emycat\u7684",(0,l.jsx)(n.code,{children:"schema.xml"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0"?>\n<!DOCTYPE mycat:schema SYSTEM "schema.dtd">\n<mycat:schema xmlns:mycat="http://io.mycat/">\n \n  <schema name="mes_technical" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">\n  </schema>\n\n  <dataNode name="dn1" dataHost="myhost1" database="mes_technical" />\n  <dataHost name="myhost1" maxCon="1000" minCon="10" balance="0"\n              writeType="0" dbType="postgresql" dbDriver="jdbc" switchType="1"  slaveThreshold="100">\n      <heartbeat>select user</heartbeat>\n      <writeHost host="hostM1" url="jdbc:postgresql://192.168.3.49:5433/mes_technical" user="postgres" password="postgres">\n        \x3c!-- \u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\u4ece\u5e93 --\x3e\n        <readHost host="hostS2" url="jdbc:postgresql://192.168.3.49:5434/mes_technical" user="readonly" password="ropass" />\n        <readHost host="hostS3" url="jdbc:postgresql://192.168.3.34:5432/mes_technical" user="readonly" password="ropass" />\n      </writeHost>\n  </dataHost>\n\n</mycat:schema>\n'})}),"\n",(0,l.jsxs)(n.h3,{id:"3-\u914d\u7f6emycat\u7684serverxml\u589e\u52a0\u4e24\u4e2a\u7528\u6237",children:["3. \u914d\u7f6emycat\u7684",(0,l.jsx)(n.code,{children:"server.xml"}),"\uff0c\u589e\u52a0\u4e24\u4e2a\u7528\u6237"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'<user name="postgres" defaultAccount="true">\n  <property name="password">postgres</property>\n  <property name="schemas">mes_technical</property>\n  <property name="defaultSchema">mes_technical</property>\n</user>\n \n<user name="readonly">\n  <property name="password">ropass</property>\n  <property name="schemas">mes_technical</property>\n  <property name="readOnly">true</property>\n  <property name="defaultSchema">mes_technical</property>\n</user>\n'})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u6ce8\u610f"})," \u9700\u8981\u5220\u9664\u9ed8\u8ba4\u7684\u7528\u6237\uff0c\u5426\u5219\u4f1a\u542f\u52a8\u62a5\u9519"]}),"\n",(0,l.jsx)(n.h3,{id:"4-\u542f\u52a8mycat",children:"4. \u542f\u52a8MyCat"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u65e5\u5fd7\u76ee\u5f55\nmkdir logs\n\n# \u542f\u52a8mycat\uff0c\u6574\u4e2a\u542f\u52a8\u6d41\u7a0b\u5927\u6982\u9700\u89811\u5206\u949f\nmycat start\n\n# \u67e5\u770b\u542f\u52a8\u65e5\u5fd7\ntail -f logs/wrapper.log\n\n# \u67e5\u770b\u8fd0\u884c\u65e5\u5fd7\ntail -f logs/mycat.log\n"})}),"\n",(0,l.jsx)(n.h2,{id:"navicat\u6d4b\u8bd5",children:"Navicat\u6d4b\u8bd5"}),"\n",(0,l.jsx)(n.p,{children:"Navicat\u65b0\u5efa\u6570\u636e\u5e93\u8fde\u63a5"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7c7b\u578b: Mysql"}),"\n",(0,l.jsx)(n.li,{children:"\u4e3b\u673a: 192.168.3.34 (Mycat\u670d\u52a1\u6240\u5728IP)"}),"\n",(0,l.jsx)(n.li,{children:"\u7aef\u53e3: 8066 (Mycat\u9ed8\u8ba4\u7aef\u53e3)"}),"\n",(0,l.jsx)(n.li,{children:"\u8d26\u53f7: postgres server.xml \u4e2d\u914d\u7f6e\u7684\u8d26\u53f7"}),"\n",(0,l.jsx)(n.li,{children:"\u5bc6\u7801: postgres server.xml \u4e2d\u914d\u7f6e\u7684\u5bc6\u7801"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u96c6\u6210-spring-boot-\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb",children:"\u96c6\u6210 Spring Boot \u5b9e\u73b0\u8bfb\u5199\u5206\u79bb"}),"\n",(0,l.jsx)(n.p,{children:"\u5176\u5b9e\u6574\u5408MyCat\u4e4b\u540e\uff0c\u5207\u6362\u6570\u636e\u6e90\u7684\u5de5\u4f5c\u53ef\u4ee5\u4ea4\u7ed9MyCat\uff0c\u4e0d\u9700\u8981\u4ee5\u4e0b\u64cd\u4f5c\uff0c\u624b\u52a8\u5207\u6362\u3002\u4ee5\u4e0b\u53ea\u662f\u4ecb\u7ecd\u600e\u4e48\u624b\u52a8\u5207\u6362\u6570\u636e\u6e90"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u9996\u5148\u9700\u8981\u914d\u7f6e\u597d\u6570\u636e\u5e93\u7684\u4e3b\u4ece\u5173\u7cfb\u3002"}),"\n",(0,l.jsx)(n.li,{children:"\u914d\u7f6e\u597dMyCat\u670d\u52a1\u3002"}),"\n",(0,l.jsx)(n.li,{children:"\u5b9e\u73b0MyCat\u4e0eMySQL\u8bfb\u5199\u5206\u79bb\u3002"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"1-\u6dfb\u52a0\u4f9d\u8d56",children:"1. \u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-aop</artifactId>\n</dependency>\n \n<dependency>\n    <groupId>com.alibaba</groupId>\n    <artifactId>druid</artifactId>\n    <version>1.0.23</version>\n</dependency>\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u521b\u5efa\u6570\u636e\u6e90",children:"2. \u521b\u5efa\u6570\u636e\u6e90"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package com.muycode.itoolsimple.datasource;\n \nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.boot.jdbc.DataSourceBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n \nimport javax.sql.DataSource;\n \n@Configuration\npublic class DataSourceConfig {\n \n    /**\n     * \u521b\u5efa\u53ef\u8bfb\u6570\u636e\u6e90\n     *\n     * @return\n     */\n    @Bean(name = "selectDataSource")\n    @ConfigurationProperties(prefix = "spring.datasource.select")\n    public DataSource dataSource1() {\n        return DataSourceBuilder.create().build();\n    }\n \n    /**\n     * \u521b\u5efa\u53ef\u5199\u6570\u636e\u6e90\n     *\n     * @return\n     */\n    @Bean(name = "updateDataSource")\n    @ConfigurationProperties(prefix = "spring.datasource.update")\n    public DataSource dataSource2() {\n        return DataSourceBuilder.create().build();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u8bbe\u7f6e\u6570\u636e\u6e90",children:"3. \u8bbe\u7f6e\u6570\u636e\u6e90"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"package com.muycode.itoolsimple.datasource;\n \nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.stereotype.Component;\n \n@Component\n@Lazy(false)\npublic class DataSourceContextHolder {\n    /**\n     * \u91c7\u7528ThreadLocal \u4fdd\u5b58\u672c\u5730\u591a\u6570\u636e\u6e90\n     */\n    private static final ThreadLocal<String> contextHolder = new ThreadLocal<>();\n \n    /**\n     * \u8bbe\u7f6e\u6570\u636e\u6e90\u7c7b\u578b\n     *\n     * @param dbType\n     */\n    public static void setDbType(String dbType) {\n        contextHolder.set(dbType);\n    }\n    /**\n     * \u83b7\u53d6\u6570\u636e\u6e90\u7c7b\u578b\n     */\n    public static String getDbType() {\n        return contextHolder.get();\n    }\n \n    public static void clearDbType() {\n        contextHolder.remove();\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"4-\u8fd4\u56de\u6570\u636e\u6e90",children:"4. \u8fd4\u56de\u6570\u636e\u6e90"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package com.muycode.itoolsimple.datasource;\n \nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\nimport org.springframework.stereotype.Component;\n \nimport javax.sql.DataSource;\nimport java.util.HashMap;\nimport java.util.Map;\n \n@Component\n@Primary\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n \n    @Autowired\n    @Qualifier("selectDataSource")\n    private DataSource selectDataSource;\n \n    @Autowired\n    @Qualifier("updateDataSource")\n    private DataSource updateDataSource;\n \n    /**\n     * \u8fd4\u56de\u751f\u6548\u7684\u6570\u636e\u6e90\u540d\u79f0\n     */\n    @Override\n    protected Object determineCurrentLookupKey() {\n        return DataSourceContextHolder.getDbType();\n    }\n    /**\n     * \u914d\u7f6e\u6570\u636e\u6e90\u4fe1\u606f\n     */\n    @Override\n    public void afterPropertiesSet() {\n        Map<Object, Object> map = new HashMap<>(16);\n        map.put("selectDataSource", selectDataSource);\n        map.put("updateDataSource", updateDataSource);\n        setTargetDataSources(map);\n        setDefaultTargetDataSource(updateDataSource);\n        super.afterPropertiesSet();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"5-\u521b\u5efa\u5207\u9762\u52a8\u6001\u8bbe\u7f6e\u6570\u636e\u6e90",children:"5. \u521b\u5efa\u5207\u9762\uff0c\u52a8\u6001\u8bbe\u7f6e\u6570\u636e\u6e90"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package com.muycode.itoolsimple.datasource;\n \nimport org.aspectj.lang.JoinPoint;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Before;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.core.annotation.Order;\nimport org.springframework.stereotype.Component;\n \n@Aspect\n@Component\n@Lazy(false)\n@Order(0) // Order\u8bbe\u5b9aAOP\u6267\u884c\u987a\u5e8f \u4f7f\u4e4b\u5728\u6570\u636e\u5e93\u4e8b\u52a1\u4e0a\u5148\u6267\u884c\npublic class DataSourceOptionAop {\n \n    /**\n     * \u53ef\u8bfb\u6570\u636e\u6e90\n     */\n    private final static String DATASOURCE_TYPE_SELECT = "selectDataSource";\n    /**\n     * \u53ef\u5199\u6570\u636e\u6e90\n     */\n    private final static String DATASOURCE_TYPE_UPDATE = "updateDataSource";\n    /**\n     * \u521b\u5efa\u5207\u9762\uff0c\u6839\u636e\u65b9\u6cd5\u7c7b\u578b\u9009\u62e9\u4e0d\u540c\u7684\u6570\u636e\u6e90\n     *\n     * @param joinPoint\n     * @author muycode\n     */\n    @Before("execution(* com.zdys.tcmmes.*.service.*.*(..))")\n    public void process(JoinPoint joinPoint) {\n        String methodName = joinPoint.getSignature().getName();\n        System.out.print("=========== " + methodName);\n        if (methodName.startsWith("save") || methodName.startsWith("update")\n                || methodName.startsWith("del") || methodName.startsWith("add") || methodName.startsWith("login")\n                || methodName.startsWith("logout") || methodName.startsWith("send")) {\n            DataSourceContextHolder.setDbType(DATASOURCE_TYPE_UPDATE);\n            System.out.println("-----------------\u4f7f\u7528updateDataSource\u6570\u636e\u6e90-------------------");\n        } else {\n            DataSourceContextHolder.setDbType(DATASOURCE_TYPE_SELECT);\n            System.out.println("-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------");\n        }\n    }\n \n    /**\n     * \u5728service\u670d\u52a1\u5c42\u4f7f\u7528\u5b8c\u4e4b\u540e\uff0c\u6e05\u7406\u7ed1\u5b9a\u7684\u6570\u636e\u6e90\n     *\n     * @author muycode\n     */\n    @After("execution(* com.zdys.tcmmes.*.service.*.*(..))")\n    public void after() {\n        DataSourceContextHolder.clearDbType();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"6-\u8f93\u51fa\u7ed3\u679c",children:"6. \u8f93\u51fa\u7ed3\u679c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"=========== getByUsername-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== getPermissionStringByUserId-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== getPermissionByUserId-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== getRolePermissionLinkByUserId-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== save-----------------\u4f7f\u7528updateDataSource\u6570\u636e\u6e90-------------------\n=========== queryByPage-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== save-----------------\u4f7f\u7528updateDataSource\u6570\u636e\u6e90-------------------\n=========== getPermissionAll-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== save-----------------\u4f7f\u7528updateDataSource\u6570\u636e\u6e90-------------------\n=========== getSysCodeAll-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n=========== save-----------------\u4f7f\u7528updateDataSource\u6570\u636e\u6e90-------------------\n=========== getByRid-----------------\u4f7f\u7528selectDataSource\u6570\u636e\u6e90-------------------\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>c});var l=s(96540);const r={},a=l.createContext(r);function t(e){const n=l.useContext(a);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),l.createElement(a.Provider,{value:n},e.children)}}}]);