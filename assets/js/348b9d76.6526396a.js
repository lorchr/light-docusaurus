"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[43372],{190:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/grafana6-1505a7be6f5d449081702bfaaf555490.png"},11034:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/grafana2-b9845fdc3c93cebb6b6a03f95494bdb0.png"},13136:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/\u6548\u679c\u5c55\u793a1-b5761a3c0ba97b604e739c3135c5592f.png"},26955:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/\u6548\u679c\u5c55\u793a2-b82c2e1f21bec47aafaa3134eadf4e23.png"},28453:(n,e,a)=>{a.d(e,{R:()=>r,x:()=>t});var l=a(96540);const s={},i=l.createContext(s);function r(n){const e=l.useContext(i);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),l.createElement(i.Provider,{value:e},n.children)}},28611:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/grafana3-850d8439774ee54fb4e013650f3296d4.png"},36450:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/\u6548\u679c\u5c55\u793a3-4e596ef345ac5d22ebdefd289fb3ce97.png"},39849:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/docker-grafana2-02ed555a2b9275080c1d0943040fbe43.png"},41201:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/grafana1-5573f11e25dbb000e807b5a955e36d0b.png"},57030:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"zh-cn/others/LPG-Log-Collect","title":"LPG-Log-Collect","description":"\u76f8\u5173\u94fe\u63a5","source":"@site/docs/zh-cn/others/4-LPG-Log-Collect.md","sourceDirName":"zh-cn/others","slug":"/zh-cn/others/LPG-Log-Collect","permalink":"/docs/zh-cn/others/LPG-Log-Collect","draft":false,"unlisted":false,"editUrl":"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/others/4-LPG-Log-Collect.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{},"sidebar":"troch","previous":{"title":"Install-Program-As-Windows-Service","permalink":"/docs/zh-cn/others/Install-Program-As-Windows-Service"},"next":{"title":"Github Speed UP","permalink":"/docs/zh-cn/awesome-open-source"}}');var s=a(74848),i=a(28453);const r={},t=void 0,o={},c=[{value:"\u76f8\u5173\u94fe\u63a5",id:"\u76f8\u5173\u94fe\u63a5",level:2},{value:"\u6574\u4f53\u67b6\u6784",id:"\u6574\u4f53\u67b6\u6784",level:2},{value:"\u73af\u5883\u51c6\u5907",id:"\u73af\u5883\u51c6\u5907",level:2},{value:"\u4e8c\u8fdb\u5236\u5b89\u88c5",id:"\u4e8c\u8fdb\u5236\u5b89\u88c5",level:2},{value:"1. \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6e90\u7801\u5305",id:"1-\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6e90\u7801\u5305",level:3},{value:"2. Loki\u5b89\u88c5",id:"2-loki\u5b89\u88c5",level:3},{value:"3. Promtail\u5b89\u88c5",id:"3-promtail\u5b89\u88c5",level:3},{value:"4. Grafana\u5b89\u88c5",id:"4-grafana\u5b89\u88c5",level:3},{value:"5. \u6d4b\u8bd5",id:"5-\u6d4b\u8bd5",level:3},{value:"Docker\u5b89\u88c5",id:"docker\u5b89\u88c5",level:2},{value:"1. \u62c9\u53d6Docker\u955c\u50cf",id:"1-\u62c9\u53d6docker\u955c\u50cf",level:3},{value:"2. \u4e0b\u8f7d\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6",id:"2-\u4e0b\u8f7d\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6",level:3},{value:"3. \u51c6\u5907\u914d\u7f6e\u6587\u4ef6",id:"3-\u51c6\u5907\u914d\u7f6e\u6587\u4ef6",level:3},{value:"4. Docker Compose\u6587\u4ef6",id:"4-docker-compose\u6587\u4ef6",level:3},{value:"5. \u542f\u52a8\u5bb9\u5668",id:"5-\u542f\u52a8\u5bb9\u5668",level:3},{value:"6. \u6d4b\u8bd5",id:"6-\u6d4b\u8bd5",level:3},{value:"Kubernetes\u5b89\u88c5",id:"kubernetes\u5b89\u88c5",level:2},{value:"1. Kubernetes\u5b89\u88c5Loki",id:"1-kubernetes\u5b89\u88c5loki",level:3},{value:"\u5355\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6 <code>loki-values.yaml</code>",id:"\u5355\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6-loki-valuesyaml",level:4},{value:"\u591a\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6 <code>loki-values.yaml</code>",id:"\u591a\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6-loki-valuesyaml",level:4},{value:"\u6dfb\u52a0Grafana Chart\u5230Helm",id:"\u6dfb\u52a0grafana-chart\u5230helm",level:4},{value:"\u5b89\u88c5Loki",id:"\u5b89\u88c5loki",level:4},{value:"\u68c0\u67e5Loki\u72b6\u6001",id:"\u68c0\u67e5loki\u72b6\u6001",level:4},{value:"2. \u5c06Promtail\u5b89\u88c5\u4e3aKubernetes Daemonset",id:"2-\u5c06promtail\u5b89\u88c5\u4e3akubernetes-daemonset",level:3},{value:"3. Kubernetes\u5b89\u88c5Grafana",id:"3-kubernetes\u5b89\u88c5grafana",level:3},{value:"\u9879\u76ee\u65e5\u5fd7\u6536\u96c6\u5b9e\u64cd",id:"\u9879\u76ee\u65e5\u5fd7\u6536\u96c6\u5b9e\u64cd",level:2},{value:"1. Docker Compose\u90e8\u7f72Loki + Grafana",id:"1-docker-compose\u90e8\u7f72loki--grafana",level:3},{value:"2. K8s DaemonSet\u90e8\u7f72Promtail",id:"2-k8s-daemonset\u90e8\u7f72promtail",level:3},{value:"3. K8s \u90e8\u7f72Spring Boot\u5e94\u7528",id:"3-k8s-\u90e8\u7f72spring-boot\u5e94\u7528",level:3},{value:"4. \u672c\u5730\u90e8\u7f72 Spring Boot Jar\u5305",id:"4-\u672c\u5730\u90e8\u7f72-spring-boot-jar\u5305",level:3},{value:"5. \u672c\u5730\u90e8\u7f72 Nginx",id:"5-\u672c\u5730\u90e8\u7f72-nginx",level:3},{value:"6. Promtail \u6536\u96c6\u672c\u5730\u65e5\u5fd7",id:"6-promtail-\u6536\u96c6\u672c\u5730\u65e5\u5fd7",level:3},{value:"7. \u6548\u679c\u5c55\u793a",id:"7-\u6548\u679c\u5c55\u793a",level:3},{value:"8. \u521b\u5efa\u76d1\u63a7\u9762\u677f",id:"8-\u521b\u5efa\u76d1\u63a7\u9762\u677f",level:3},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:2},{value:"1. \u4f7f\u7528\u5b98\u65b9\u6587\u6863\u63d0\u4f9b\u7684\u914d\u7f6e\u6587\u4ef6\u542f\u52a8Loki\u62a5\u9519",id:"1-\u4f7f\u7528\u5b98\u65b9\u6587\u6863\u63d0\u4f9b\u7684\u914d\u7f6e\u6587\u4ef6\u542f\u52a8loki\u62a5\u9519",level:3},{value:"2. \u4f7f\u7528K8s\u90e8\u7f72Loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25 <code>pod has unbound immediate PersistentVolumeClaims</code>",id:"2-\u4f7f\u7528k8s\u90e8\u7f72loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25-pod-has-unbound-immediate-persistentvolumeclaims",level:3},{value:"3. \u4f7f\u7528K8s\u90e8\u7f72Loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25 <code>Insufficient memory</code>",id:"3-\u4f7f\u7528k8s\u90e8\u7f72loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25-insufficient-memory",level:3}];function d(n){const e={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h2,{id:"\u76f8\u5173\u94fe\u63a5",children:"\u76f8\u5173\u94fe\u63a5"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/grafana/latest/#grafana-oss-and-enterprise",children:"Grafana \u6587\u6863"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/grafana/latest/setup-grafana/installation/",children:"Grafana \u5b89\u88c5"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/",children:"Loki \u6587\u6863"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/setup/install/?pg=get&plcmt=selfmanaged-box2-cta1",children:"Loki \u5b89\u88c5"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/",children:"Promtail \u6587\u6863"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/installation/",children:"Promtail \u5b89\u88c5"})}),"\n"]}),"\n",(0,s.jsx)(e.li,{}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://cloud.tencent.com/developer/article/1932107",children:"\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edfloki+promtail+Grafana \u90e8\u7f72"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://cloud.tencent.com/developer/article/2516108",children:"\u4f7f\u7528 Loki \u548c Grafana \u8fdb\u884c\u5b9e\u65f6\u65e5\u5fd7\u76d1\u63a7\u539f\u521b"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/weihaoyue/article/details/147096698",children:"Loki+promtail+Grafana\u53ef\u89c6\u5316\u65e5\u5fd7\u6536\u96c6"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/391302537",children:"\u518d\u89c1\u7b28\u91cd\u7684ELK\uff01\u8fd9\u5957\u8f7b\u91cf\u7ea7\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\u8981\u706b\uff01"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://my.oschina.net/emacs_9406799/blog/18506693",children:"\u63a2\u7d22 Loki\uff1a\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u65e5\u5fd7\u805a\u5408\u89e3\u51b3\u65b9\u6848"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/csdnyf/article/details/125723027",children:"LPG\uff08Loki+Promtail+Grafana\uff09 \u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u5b9e\u8df5\u548c\u8e29\u5751\u7ecf\u5386"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://cloud.tencent.com/developer/article/2345258",children:"\u73b0\u4ee3\u5316\u65e5\u5fd7\u89e3\u51b3\u65b9\u6848 PLG \uff08Promtail +Loki + Grafana \uff09"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://developer.aliyun.com/article/1353016",children:"\u73b0\u4ee3\u5316\u65e5\u5fd7\u89e3\u51b3\u65b9\u6848 PLG \uff08Promtail +Loki + Grafana \uff09"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/qq_20466211/article/details/140696271",children:"\u8fd0\u7ef4-6-\u91c7\u7528LPG\u642d\u5efa\u8f7b\u91cf\u7ea7\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/594332765",children:"\u642d\u5efa\u4e00\u4e2a Grafana \u5168\u5bb6\u6876\u96c6\u7fa4\uff08\u56db\uff09\uff1a\u65e5\u5fd7\u6536\u96c6"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/964849570",children:"\u8f7b\u91cf\u7ea7\u7684\u65e5\u5fd7\u805a\u5408\u548c\u53ef\u89c6\u5316\u67e5\u8be2\u5206\u6790\u7cfb\u7edfGrafana+Loki+Promtail"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/Sky_True/article/details/136570914",children:"Docker\u4e0a\u90e8\u7f72LPG\uff08loki+promtail+grafana\uff09\u8e29\u5751\u590d\u76d8"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/csdnYF/article/details/125723027",children:"LPG\uff08Loki+Promtail+Grafana\uff09 \u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u5b9e\u8df5\u548c\u8e29\u5751\u7ecf\u5386"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/639304209",children:"\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edfloki+promtail+Grafana\u90e8\u7f72"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"http://yunxue521.top/archives/lokipromtailgrafana-wan-cheng-fen-bu-shi-ri-zhi-shou-ji",children:"Loki + Promtail + Grafana\u5b8c\u6210\u5206\u5e03\u5f0f\u65e5\u5fd7\u6536\u96c6"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u6574\u4f53\u67b6\u6784",children:"\u6574\u4f53\u67b6\u6784"}),"\n",(0,s.jsx)(e.p,{children:"Loki\u662f\u53d7Prometheus\u542f\u53d1\u7531Grafana Labs\u56e2\u961f\u5f00\u6e90\u7684\u6c34\u5e73\u53ef\u6269\u5c55\uff0c\u9ad8\u5ea6\u53ef\u7528\u7684\u591a\u79df\u6237\u65e5\u5fd7\u805a\u5408\u7cfb\u7edf\u3002 \u5f00\u53d1\u8bed\u8a00: Google Go\u3002\u5b83\u7684\u8bbe\u8ba1\u5177\u6709\u5f88\u9ad8\u7684\u6210\u672c\u6548\u76ca\uff0c\u5e76\u4e14\u6613\u4e8e\u64cd\u4f5c\u3002\u4f7f\u7528\u6807\u7b7e\u6765\u4f5c\u4e3a\u7d22\u5f15\uff0c\u800c\u4e0d\u662f\u5bf9\u5168\u6587\u8fdb\u884c\u68c0\u7d22\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u901a\u8fc7\u8fd9\u4e9b\u6807\u7b7e\u65e2\u53ef\u4ee5\u67e5\u8be2\u65e5\u5fd7\u7684\u5185\u5bb9\u4e5f\u53ef\u4ee5\u67e5\u8be2\u5230\u76d1\u63a7\u7684\u6570\u636e\u7b7e\uff0c\u6781\u5927\u5730\u964d\u4f4e\u4e86\u65e5\u5fd7\u7d22\u5f15\u7684\u5b58\u50a8\u3002"}),"\n",(0,s.jsx)(e.p,{children:"Loki\u7cfb\u7edf\u67b6\u6784\u5341\u5206\u7b80\u5355\uff0c\u7531\u4ee5\u4e0b3\u4e2a\u90e8\u5206\u7ec4\u6210 \uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Promtail \u662f\u4ee3\u7406\uff0c\u8d1f\u8d23\u6536\u96c6\u65e5\u5fd7\u5e76\u5c06\u5176\u53d1\u9001\u7ed9 loki \u3002"}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Loki \u662f\u4e3b\u670d\u52a1\u5668\uff0c\u8d1f\u8d23\u5b58\u50a8\u65e5\u5fd7\u548c\u5904\u7406\u67e5\u8be2 \u3002"}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Grafana \u7528\u4e8e UI \u5c55\u793a\u3002"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"Loki\u6982\u89c8",src:a(74391).A+"",width:"1200",height:"372"})}),"\n",(0,s.jsx)(e.p,{children:"\u53ea\u8981\u5728\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\u4e0a\u5b89\u88c5promtail\u6765\u6536\u96c6\u65e5\u5fd7\u7136\u540e\u53d1\u9001\u7ed9Loki\u5b58\u50a8\uff0c\u5c31\u53ef\u4ee5\u5728Grafana UI\u754c\u9762\u901a\u8fc7\u6dfb\u52a0Loki\u4e3a\u6570\u636e\u6e90\u8fdb\u884c\u65e5\u5fd7\u67e5\u8be2\uff08\u5982\u679cLoki\u670d\u52a1\u5668\u6027\u80fd\u4e0d\u591f\uff0c\u53ef\u4ee5\u90e8\u7f72\u591a\u4e2aLoki\u8fdb\u884c\u5b58\u50a8\u53ca\u67e5\u8be2\uff09\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u4f5c\u4e3a\u4e00\u4e2a\u65e5\u5fd7\u7cfb\u7edf\u4e0d\u5149\u53ea\u6709\u67e5\u8be2\u5206\u6790\u65e5\u5fd7\u7684\u80fd\u529b\uff0c\u8fd8\u80fd\u5bf9\u65e5\u5fd7\u8fdb\u884c\u76d1\u63a7\u548c\u62a5\u8b66\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"Loki\u67b6\u6784\u56fe",src:a(72049).A+"",width:"960",height:"720"})}),"\n",(0,s.jsx)(e.h2,{id:"\u73af\u5883\u51c6\u5907",children:"\u73af\u5883\u51c6\u5907"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u540d\u79f0"}),(0,s.jsx)(e.th,{children:"IP"}),(0,s.jsx)(e.th,{children:"\u670d\u52a1"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u65e5\u5fd7\u670d\u52a1\u5668"}),(0,s.jsx)(e.td,{children:"192.168.137.121"}),(0,s.jsx)(e.td,{children:"Grafana + Loki"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u5e94\u7528\u670d\u52a1\u5668"}),(0,s.jsx)(e.td,{children:"192.168.137.132"}),(0,s.jsx)(e.td,{children:"Spring Boot Service + Promtail"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u5e94\u7528\u670d\u52a1\u5668"}),(0,s.jsx)(e.td,{children:"192.168.137.132"}),(0,s.jsx)(e.td,{children:"Nginx  + Promtail"})]})]})]}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u5e94\u7528"}),(0,s.jsx)(e.th,{children:"\u7248\u672c"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Loki"}),(0,s.jsx)(e.td,{children:"3.5.1"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Promtail"}),(0,s.jsx)(e.td,{children:"3.5.1"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Grafana"}),(0,s.jsx)(e.td,{children:"12.0.1"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Grafana-Enterprise"}),(0,s.jsx)(e.td,{children:"12.0.1"})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"\u4e8c\u8fdb\u5236\u5b89\u88c5",children:"\u4e8c\u8fdb\u5236\u5b89\u88c5"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.cnblogs.com/xiangpeng/p/18127120",children:"\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edfPLG\uff08Promtail+Loki+Grafana\uff09\u4ecb\u7ecd\u53ca\u90e8\u7f72"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/grafana/latest/setup-grafana/installation/redhat-rhel-fedora/#install-grafana-as-a-standalone-binary",children:"Grafana \u4e8c\u8fdb\u5236\u5b89\u88c5"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/setup/install/local/#install-manually",children:"Loki \u4e8c\u8fdb\u5236\u5b89\u88c5"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/installation/#install-the-binary",children:"Promtail \u4e8c\u8fdb\u5236\u5b89\u88c5"})}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"1-\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6e90\u7801\u5305",children:"1. \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6e90\u7801\u5305"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"mkdir -p /root/grafana && cd /root/grafana\n\n# \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u5305\nwget https://github.com/grafana/loki/releases/download/v3.5.1/loki-linux-amd64.zip          -O loki-linux-amd64.zip\nwget https://github.com/grafana/loki/releases/download/v3.5.1/promtail-linux-amd64.zip      -O promtail-linux-amd64.zip\nwget https://dl.grafana.com/enterprise/release/grafana-enterprise-12.0.1.linux-amd64.tar.gz -O grafana-enterprise-12.0.1.linux-amd64.tar.gz\n\n# \u4e0b\u8f7d\u914d\u7f6e\u6587\u4ef6\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/cmd/loki/loki-local-config.yaml -O loki-local-config.yaml\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/clients/cmd/promtail/promtail-local-config.yaml -O promtail-local-config.yaml\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"2-loki\u5b89\u88c5",children:"2. Loki\u5b89\u88c5"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b89\u88c5\u8fd0\u884c"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u521b\u5efa\u5b89\u88c5\u76ee\u5f55\u53ca\u6570\u636e\u76ee\u5f55\nmkdir -p /usr/local/loki\nmkdir -p /data/loki/{index,chunks,rules}\n\n# \u89e3\u538b\nunzip /root/grafana/loki-linux-amd64.zip -d /usr/local/loki\n\n# \u914d\u7f6e\u6587\u4ef6\ncp /root/grafana/loki-local-config.yaml /usr/local/loki/loki-config.yaml\n\n# \u6d4b\u8bd5\u8fd0\u884c\ncd /usr/local/loki\n./loki-linux-amd64 -config.file=loki-local-config.yaml\n\n# \u5b98\u65b9\u4ed3\u5e93\u4e2d v3.5.1 \u7684\u914d\u7f6e\u6587\u4ef6\u6709\u95ee\u9898\uff0c\u65e0\u6cd5\u8fd0\u884c\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsxs)(e.li,{children:["\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"loki-config.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"auth_enabled: false\n\nserver:\n  http_listen_port: 3100\n  grpc_listen_port: 9096\n  log_level: debug\n  grpc_server_max_concurrent_streams: 1000\n\ncommon:\n  instance_addr: 127.0.0.1\n  path_prefix: /tmp/loki\n  storage:\n    filesystem:\n      chunks_directory: /tmp/loki/chunks\n      rules_directory: /tmp/loki/rules\n  replication_factor: 1\n  ring:\n    kvstore:\n      store: inmemory\n\nquery_range:\n  results_cache:\n    cache:\n      embedded_cache:\n        enabled: true\n        max_size_mb: 100\n\nlimits_config:\n  metric_aggregation_enabled: true\n  enable_multi_variant_queries: true\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: tsdb\n      object_store: filesystem\n      schema: v13\n      index:\n        prefix: index_\n        period: 24h\n\npattern_ingester:\n  enabled: true\n  metric_aggregation:\n    loki_address: localhost:3100\n\nruler:\n  alertmanager_url: http://localhost:9093\n\nfrontend:\n  encoding: protobuf\n\n\n# By default, Loki will send anonymous, but uniquely-identifiable usage and configuration\n# analytics to Grafana Labs. These statistics are sent to https://stats.grafana.org/\n#\n# Statistics help us better understand how Loki is used, and they show us performance\n# levels for most users. This helps us prioritize features and documentation.\n# For more information on what's sent, look at\n# https://github.com/grafana/loki/blob/main/pkg/analytics/stats.go\n# Refer to the buildReport method to see what goes into a report.\n#\n# If you would like to disable reporting, uncomment the following lines:\n#analytics:\n#  reporting_enabled: false\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"\u542f\u505c\u811a\u672c"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup ./loki-linux-amd64 -config.file=./loki-config.yaml >./loki.log 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"4",children:["\n",(0,s.jsx)(e.li,{children:"\u53ef\u4ee5\u7528\u6d4f\u89c8\u5668\u6253\u5f00Loki\u6307\u6807\u9875\u9762"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"http://192.168.137.141:3100/metrics",children:"http://192.168.137.141:3100/metrics"})}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:a(71614).A+"",width:"1917",height:"981"})}),"\n",(0,s.jsx)(e.h3,{id:"3-promtail\u5b89\u88c5",children:"3. Promtail\u5b89\u88c5"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b89\u88c5\u8fd0\u884c"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u521b\u5efa\u5b89\u88c5\u76ee\u5f55\u53ca\u6570\u636e\u76ee\u5f55\nmkdir -p /usr/local/promtail\nmkdir -p /data/promtail/\n\n# \u89e3\u538b\nunzip /root/grafana/promtail-linux-amd64.zip -d /usr/local/promtail\n\n# \u914d\u7f6e\u6587\u4ef6\ncp /root/grafana/promtail-local-config.yaml /usr/local/promtail/promtail-config.yaml\n\n# \u8fd0\u884c\ncd /usr/local/promtail\n./promtail-linux-amd64 -config.file=promtail-config.yaml\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsxs)(e.li,{children:["\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"promtail-config.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://localhost:3100/loki/api/v1/push\n\nscrape_configs:\n- job_name: system\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: varlogs\n      __path__: /var/log/*log\n      stream: stdout\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"\u542f\u505c\u811a\u672c"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup ./promtail-linux-amd64 -config.file=promtail-config.yaml >./promtail.log 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"4-grafana\u5b89\u88c5",children:"4. Grafana\u5b89\u88c5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u521b\u5efa\u5b89\u88c5\u76ee\u5f55\u53ca\u6570\u636e\u76ee\u5f55\nmkdir -p /usr/local/grafana\nmkdir -p /data/grafana/\n\n# \u89e3\u538b\ntar -zxvf /root/grafana/grafana-enterprise-12.0.1.linux-amd64.tar.gz -C /usr/local/grafana\n\n# \u8fd0\u884c\ncd /usr/local/grafana/grafana-v12.0.1\n./bin/grafana server --config=./conf/defaults.ini --pidfile=./grafana.pid\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"conf/default.ini"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"\u542f\u505c\u811a\u672c"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup ./bin/grafana server --config=./conf/defaults.ini --pidfile=./grafana.pid >./grafana.log 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"4",children:["\n",(0,s.jsx)(e.li,{children:"\u53ef\u4ee5\u7528\u6d4f\u89c8\u5668\u6253\u5f00Grafana\u6307\u6807\u9875\u9762"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"http://192.168.137.141:3000",children:"http://192.168.137.141:3000"})}),"\n",(0,s.jsx)(e.li,{children:"admin / admin"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:a(41201).A+"",width:"1916",height:"977"})}),"\n",(0,s.jsx)(e.h3,{id:"5-\u6d4b\u8bd5",children:"5. \u6d4b\u8bd5"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["\u6dfb\u52a0 Loki \u6570\u636e\u6e90\uff0c\u914d\u7f6eLoki\u7684http\u5730\u5740\n",(0,s.jsx)(e.img,{src:a(11034).A+"",width:"1920",height:"922"}),"\n",(0,s.jsx)(e.img,{src:a(28611).A+"",width:"1920",height:"922"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["\u70b9\u51fb ",(0,s.jsx)(e.code,{children:"Save & test"})," \u6d4b\u8bd5\u8fde\u63a5\uff0c\u6309\u94ae\u4e0a\u65b9\u5f39\u51fa\u8fde\u63a5\u6210\u529f\u63d0\u793a\n",(0,s.jsx)(e.img,{src:a(98444).A+"",width:"1920",height:"922"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["\u6253\u5f00Explore\uff0c\u6d4b\u8bd5\u6570\u636e\u67e5\u8be2\n",(0,s.jsx)(e.img,{src:a(67541).A+"",width:"1920",height:"922"}),"\n",(0,s.jsx)(e.img,{src:a(190).A+"",width:"1920",height:"922"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"docker\u5b89\u88c5",children:"Docker\u5b89\u88c5"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/grafana/latest/setup-grafana/installation/docker/",children:"Grafana Docker\u5b89\u88c5"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/setup/install/docker/",children:"Loki Docker\u5b89\u88c5"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/installation/#install-using-docker",children:"Promtail Docker\u5b89\u88c5"})}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"1-\u62c9\u53d6docker\u955c\u50cf",children:"1. \u62c9\u53d6Docker\u955c\u50cf"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u62c9\u53d6\u955c\u50cf\ndocker pull grafana/loki:3.5.1\ndocker pull grafana/promtail:3.5.1\ndocker pull grafana/grafana:12.0.1\ndocker pull grafana/grafana-enterprise:12.0.1\n\n# \u5bfc\u51fa\u955c\u50cf\ndocker save grafana/loki:3.5.1      -o ./grafana_loki_3.5.1.tar\ndocker save grafana/promtail:3.5.1  -o ./grafana_promtail_3.5.1.tar\ndocker save grafana/grafana:12.0.1  -o ./grafana_grafana_12.0.1.tar\ndocker save grafana/grafana-enterprise:12.0.1 -o ./grafana_grafana-enterprise_12.0.1.tar\n\n# \u52a0\u8f7d\u955c\u50cf\ndocker load -i ./grafana_loki_3.5.1.tar\ndocker load -i ./grafana_promtail_3.5.1.tar\ndocker load -i ./grafana_grafana_12.0.1.tar\ndocker load -i ./grafana_grafana-enterprise_12.0.1.tar\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"2-\u4e0b\u8f7d\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6",children:"2. \u4e0b\u8f7d\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u4e0b\u8f7d\u914d\u7f6e\u6587\u4ef6\nmkdir -p /root/grafana && cd /root/grafana\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/cmd/loki/loki-local-config.yaml -O loki-local-config.yaml\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/clients/cmd/promtail/promtail-docker-config.yaml -O promtail-docker-config.yaml\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/production/docker-compose.yaml -O docker-compose.yaml\n\n# \u590d\u5236\u914d\u7f6e\u6587\u4ef6\u5230\u76ee\u6807\u8def\u5f84\nmkdir -p /etc/{loki,promtail,grafana}\ncp /root/grafana/loki-local-config.yaml       /etc/loki/local-config.yaml\ncp /root/grafana/promtail-docker-config.yaml  /etc/promtail/config.yaml\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"3-\u51c6\u5907\u914d\u7f6e\u6587\u4ef6",children:"3. \u51c6\u5907\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["Loki\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"/etc/loki/local-config.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"auth_enabled: false\n\nserver:\n  http_listen_port: 3100\n  grpc_listen_port: 9096\n  log_level: debug\n  grpc_server_max_concurrent_streams: 1000\n\ncommon:\n  instance_addr: 127.0.0.1\n  path_prefix: /tmp/loki\n  storage:\n    filesystem:\n      chunks_directory: /tmp/loki/chunks\n      rules_directory: /tmp/loki/rules\n  replication_factor: 1\n  ring:\n    kvstore:\n      store: inmemory\n\nquery_range:\n  results_cache:\n    cache:\n      embedded_cache:\n        enabled: true\n        max_size_mb: 100\n\nlimits_config:\n  metric_aggregation_enabled: true\n  enable_multi_variant_queries: true\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: tsdb\n      object_store: filesystem\n      schema: v13\n      index:\n        prefix: index_\n        period: 24h\n\npattern_ingester:\n  enabled: true\n  metric_aggregation:\n    loki_address: localhost:3100\n\nruler:\n  alertmanager_url: http://localhost:9093\n\nfrontend:\n  encoding: protobuf\n\n\n# By default, Loki will send anonymous, but uniquely-identifiable usage and configuration\n# analytics to Grafana Labs. These statistics are sent to https://stats.grafana.org/\n#\n# Statistics help us better understand how Loki is used, and they show us performance\n# levels for most users. This helps us prioritize features and documentation.\n# For more information on what's sent, look at\n# https://github.com/grafana/loki/blob/main/pkg/analytics/stats.go\n# Refer to the buildReport method to see what goes into a report.\n#\n# If you would like to disable reporting, uncomment the following lines:\n#analytics:\n#  reporting_enabled: false\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsxs)(e.li,{children:["Promtail\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"/etc/promtail/config.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://loki:3100/loki/api/v1/push\n\nscrape_configs:\n- job_name: system\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: varlogs\n      __path__: /var/log/*log\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"4-docker-compose\u6587\u4ef6",children:"4. Docker Compose\u6587\u4ef6"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'version: "3.3"\n\nnetworks:\n  loki:\n\nservices:\n  loki:\n    image: grafana/loki:3.5.1\n    ports:\n      - "3100:3100"\n    volumes:\n      - /etc/loki/local-config.yaml:/etc/loki/local-config.yaml\n    command: -config.file=/etc/loki/local-config.yaml\n    networks:\n      - loki\n\n  promtail:\n    image: grafana/promtail:3.5.1\n    volumes:\n      - /var/log:/var/log\n      - /etc/promtail/config.yml:/etc/promtail/config.yml\n    command: -config.file=/etc/promtail/config.yml\n    networks:\n      - loki\n\n  grafana:\n    environment:\n      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning\n      - GF_AUTH_ANONYMOUS_ENABLED=true\n      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin\n      - GF_FEATURE_TOGGLES_ENABLE=alertingSimplifiedRouting,alertingQueryAndExpressionsStepMode\n    entrypoint:\n      - sh\n      - -euc\n      - |\n        mkdir -p /etc/grafana/provisioning/datasources\n        cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml\n        apiVersion: 1\n        datasources:\n        - name: Loki\n          type: loki\n          access: proxy \n          orgId: 1\n          url: http://loki:3100\n          basicAuth: false\n          isDefault: true\n          version: 1\n          editable: false\n        EOF\n        /run.sh\n    image: grafana/grafana:12.0.1\n    ports:\n      - "3000:3000"\n    networks:\n      - loki\n\n'})}),"\n",(0,s.jsx)(e.h3,{id:"5-\u542f\u52a8\u5bb9\u5668",children:"5. \u542f\u52a8\u5bb9\u5668"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\ndocker compose -f docker-compose.yaml up -d \n\n# \u505c\u6b62\ndocker compose -f docker-compose.yaml down\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"6-\u6d4b\u8bd5",children:"6. \u6d4b\u8bd5"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u67e5\u770bLoki\u76d1\u63a7\u6307\u6807"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"http://192.168.137.142:3100/metrics",children:"http://192.168.137.142:3100/metrics"})}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:a(75695).A+"",width:"1920",height:"977"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsx)(e.li,{children:"\u67e5\u770bGrafana\u6570\u636e\u6e90"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"http://192.168.137.142:3000/",children:"http://192.168.137.142:3000/"})}),"\n",(0,s.jsxs)(e.li,{children:["admin / admin\n",(0,s.jsx)(e.img,{src:a(91058).A+"",width:"1915",height:"982"}),"\n",(0,s.jsx)(e.img,{src:a(39849).A+"",width:"1911",height:"976"})]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"kubernetes\u5b89\u88c5",children:"Kubernetes\u5b89\u88c5"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/a772304419/article/details/136977086",children:"Loki\u4f7f\u7528\u793a\u4f8b\uff1a\u9488\u5bf9\u90e8\u7f72\u5728K8s\u4e2d\u7684Java\u5e94\u7528\u7684\u65e5\u5fd7\u6355\u83b7Promtail\u914d\u7f6e\u793a\u4f8b"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/grafana/latest/setup-grafana/installation/kubernetes/",children:"Grafana Kubernetes\u5b89\u88c5"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/setup/install/helm/install-monolithic/",children:"Loki Helm\u5b89\u88c5"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/installation/#install-as-kubernetes-daemonset-recommended",children:"Promtail Kubernetes daemonSet \u5b89\u88c5"})}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"K8s\u5b89\u88c5Loki + Promtail + Grafana \u6240\u9700\u8d44\u6e90\u8f83\u591a(\u5bf9\u4e8e\u4e00\u4e2a3\u8282\u70b9\u7684K8s\u96c6\u7fa4\uff0c\u9700\u8981\u542f\u52a811\u4e2aLoki\u76f8\u5173Pod)\uff0c\u5bf9\u4e8e\u4f4e\u8d1f\u8f7d\u7684\u573a\u666f\uff0c\u5efa\u8bae\u76f4\u63a5\u4f7f\u7528Docker\u90e8\u7f72Loki\u548cGrafana\uff0c\u4ec5\u5c06Promtail\u90e8\u7f72\u5230K8s Daemonset\u3002"}),"\n",(0,s.jsx)(e.h3,{id:"1-kubernetes\u5b89\u88c5loki",children:"1. Kubernetes\u5b89\u88c5Loki"}),"\n",(0,s.jsx)(e.p,{children:"\u7531\u4e8e\u5fae\u670d\u52a1\u5f62\u5f0f(16\u8282\u70b9\u6216\u670d\u52a1)\u548c\u81ea\u52a8\u4f38\u7f29\u5f0f\uff0812\u4e2a\u8282\u70b9\u6216\u670d\u52a1\uff09\u7684\u6240\u9700Loki\u8282\u70b9\u8f83\u591a\uff0c\u6b64\u5904\u91c7\u7528\u5355\u7247\u6a21\u5f0f"}),"\n",(0,s.jsxs)(e.h4,{id:"\u5355\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6-loki-valuesyaml",children:["\u5355\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"loki-values.yaml"})]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Loki (1 replica)"}),"\n",(0,s.jsx)(e.li,{children:"Loki Canary (1 DaemonSet)"}),"\n",(0,s.jsx)(e.li,{children:"Loki Gateway (1 NGINX replica)"}),"\n",(0,s.jsx)(e.li,{children:"Loki Chunk and Result Cache (1 DaemonSet)"}),"\n",(0,s.jsxs)(e.li,{children:["Minio (optional, if ",(0,s.jsx)(e.code,{children:"minio.enabled=true"}),")"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'loki:\n  commonConfig:\n    replication_factor: 1\n  schemaConfig:\n    configs:\n      - from: "2024-04-01"\n        store: tsdb\n        object_store: s3\n        schema: v13\n        index:\n          prefix: loki_index_\n          period: 24h\n  pattern_ingester:\n      enabled: true\n  limits_config:\n    allow_structured_metadata: true\n    volume_enabled: true\n  ruler:\n    enable_api: true\n\nminio:\n  enabled: true\n      \ndeploymentMode: SingleBinary\n\nsingleBinary:\n  replicas: 1\n\n# Zero out replica counts of other deployment modes\nbackend:\n  replicas: 0\nread:\n  replicas: 0\nwrite:\n  replicas: 0\n\ningester:\n  replicas: 0\nquerier:\n  replicas: 0\nqueryFrontend:\n  replicas: 0\nqueryScheduler:\n  replicas: 0\ndistributor:\n  replicas: 0\ncompactor:\n  replicas: 0\nindexGateway:\n  replicas: 0\nbloomCompactor:\n  replicas: 0\nbloomGateway:\n  replicas: 0\n\n'})}),"\n",(0,s.jsxs)(e.h4,{id:"\u591a\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6-loki-valuesyaml",children:["\u591a\u526f\u672c\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"loki-values.yaml"})]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Loki (3 replicas)"}),"\n",(0,s.jsx)(e.li,{children:"Loki Canary (1 DaemonSet)"}),"\n",(0,s.jsx)(e.li,{children:"Loki Gateway (1 NGINX replica)"}),"\n",(0,s.jsx)(e.li,{children:"Loki Chunk and Result Cache (1 DaemonSet)"}),"\n",(0,s.jsxs)(e.li,{children:["Minio (optional, if ",(0,s.jsx)(e.code,{children:"minio.enabled=true"}),")"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'loki:\n  commonConfig:\n    replication_factor: 3\n  schemaConfig:\n    configs:\n      - from: "2024-04-01"\n        store: tsdb\n        object_store: s3\n        schema: v13\n        index:\n          prefix: loki_index_\n          period: 24h\n  pattern_ingester:\n      enabled: true\n  limits_config:\n    allow_structured_metadata: true\n    volume_enabled: true\n  ruler:\n    enable_api: true\n\nminio:\n  enabled: true\n\n# \u4fee\u6539 memcached \u7684\u5185\u5b58\uff0c\u907f\u514d\u56e0\u5185\u5b58\u4e0d\u8db3\u5bfc\u81f4\u542f\u52a8\u5931\u8d25\uff08values.yaml\u4e2d\u9ed8\u8ba4\u914d\u7f6e\u4e3a8192\uff09\nchunksCache:\n  allocatedMemory: 1024\n\ndeploymentMode: SingleBinary\n\nsingleBinary:\n  replicas: 3\n\n# Zero out replica counts of other deployment modes\nbackend:\n  replicas: 0\nread:\n  replicas: 0\nwrite:\n  replicas: 0\n\ningester:\n  replicas: 0\nquerier:\n  replicas: 0\nqueryFrontend:\n  replicas: 0\nqueryScheduler:\n  replicas: 0\ndistributor:\n  replicas: 0\ncompactor:\n  replicas: 0\nindexGateway:\n  replicas: 0\nbloomCompactor:\n  replicas: 0\nbloomGateway:\n  replicas: 0\n\n'})}),"\n",(0,s.jsx)(e.h4,{id:"\u6dfb\u52a0grafana-chart\u5230helm",children:"\u6dfb\u52a0Grafana Chart\u5230Helm"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u67e5\u770bhelm\u7248\u672c\nhelm version\n\n# \u5982\u679c\u6dfb\u52a0\u4ed3\u5e93\u5931\u8d25\u53ef\u4ee5\u6dfb\u52a0\u4ee3\u7406\nexport http_proxy=http://192.168.137.1:4780\nexport https_proxy=http://192.168.137.1:4780\n\n# \u6dfb\u52a0chart\u4ed3\u5e93\nhelm repo add grafana https://grafana.github.io/helm-charts\n\n# \u66f4\u65b0chart\u4ed3\u5e93\nhelm repo update\n\n# \u67e5\u770b\u6dfb\u52a0\u5b8c\u6210\u540e\u7684\u4ed3\u5e93\nhelm repo list\n\n# \u67e5\u8be2loki\u7684chart\nhelm search repo loki\n\n# \u65b0\u5efa\u6587\u4ef6\u5939\u7528\u4e8e\u4fdd\u5b58chart\nmkdir loki-chart && cd loki-chart\n\n# \u62c9\u53d6chart\nhelm pull grafana/loki\n# \u62c9\u53d6\u8f83\u6162\uff0c\u53ef\u4ee5\u76f4\u63a5\u4ecegithub\u4e0b\u8f7d\n# wget https://github.com/grafana/helm-charts/releases/download/helm-loki-6.30.1/loki-6.30.1.tgz\n# wget https://github.com/minio/minio/blob/master/helm-releases/minio-5.4.0.tgz\n\n# \u6b64\u65f6\u4f1a\u6709\u4e00\u4e2a\u538b\u7f29\u5305\uff0c\u9ed8\u8ba4\u4e0b\u8f7d\u7684\u662f\u6700\u65b0\u7248\u672c\uff0c\u53ef\u80fd\u4e0eGrafana\u7248\u672c\u4e0d\u517c\u5bb9\uff0c\u9700\u8981\u53bbgithub\u786e\u8ba4\ntar -zxvf loki-6.30.1.tgz -C ~/\n\n# \u8fdb\u5165\u5230\u89e3\u538b\u540e\u7684\u6587\u4ef6\u5939\ncd ~/loki\n\n# \u67e5\u770b\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\nvim values.yaml\n\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u5b89\u88c5loki",children:"\u5b89\u88c5Loki"}),"\n",(0,s.jsxs)(e.p,{children:["\u7531\u4e8e\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\u5c5e\u6027\u8f83\u591a\uff0c\u8fd9\u91cc\u5b89\u88c5\u65f6\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"loki-values.yaml"})," \u6765\u8986\u76d6\u90e8\u5206\u9ed8\u8ba4\u7684\u914d\u7f6e\u9879\uff0c\u5176\u4f59\u7684\u5c5e\u6027\u4f9d\u7136\u662f\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"values.yaml"})," \u4e2d\u7684"]}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u6ce8\u610f"}),"\n\u5982\u679c\u542f\u7528\u4e86minio\uff0c\u5219\u4f1a\u4ece ",(0,s.jsx)(e.code,{children:"https://github.com/minio/minio/blob/master/helm/minio/values.yaml"})," \u4ed3\u5e93\u52a0\u8f7dminio\u7684\u914d\u7f6e"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u5b89\u88c5\u65f6\u9700\u8981\u4ecedocker\u4ed3\u5e93\u62c9\u53d6\u955c\u50cf\uff0c\u53ef\u4ee5\u63d0\u524d\u51c6\u5907\u597d\ndocker pull grafana/loki:3.5.0\ndocker pull grafana/loki-canary:3.5.0\ndocker pull grafana/enterprise-logs:3.5.1\ndocker pull grafana/loki-helm-test:ewelch-distributed-helm-chart-17db5ee\ndocker pull nginxinc/nginx-unprivileged:1.28-alpine\ndocker pull quay.io/minio/minio:RELEASE.2024-12-18T13-15-44Z\ndocker pull memcached:1.6.38-alpine\ndocker pull prom/memcached-exporter:v0.15.2\ndocker pull kiwigrid/k8s-sidecar:1.30.3\n\n# \u62c9\u53d6\u955c\u50cf\u8f83\u6162\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u672c\u5730\u4ee3\u7406\nexport HTTP_PROXY=http://192.168.137.1:4780\nexport HTTPS_PROXY=http://192.168.137.1:4780\n\n# \u5b89\u88c5Loki\uff0c\u5728 loki-values.yaml \u6240\u5728\u76ee\u5f55\u6267\u884c\uff0c\u4ece\u670d\u52a1\u5668\u4e0b\u8f7d loki-6.30.1.tgz \u5b89\u88c5\u5305\n# helm install loki grafana/loki --create-namespace --namespace loki -f loki-values.yaml\n\n# \u5b89\u88c5Loki\uff0c\u5728 loki-6.30.1.tgz \u89e3\u538b\u76ee\u5f55\u6267\u884c\uff0c\u9700\u8981\u5c06 loki-values.yaml \u590d\u5236\u5230\u6539\u76ee\u5f55\nhelm install loki . --create-namespace --namespace loki -f loki-values.yaml\n\n# \u5347\u7ea7Loki\nhelm upgrade loki grafana/loki -f loki-values.yaml\n\n# \u67e5\u770bHelm\u90e8\u7f72\u7684\u8d44\u6e90\nhelm ls --namespace loki\n\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u68c0\u67e5loki\u72b6\u6001",children:"\u68c0\u67e5Loki\u72b6\u6001"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u67e5\u770bLoki pod\nkubectl get pods -n loki -o wide\n\n# \u67e5\u770b\u670d\u52a1\u7aef\u53e3\u4fe1\u606f\nkubectl get svc -n loki\n\n# \u67e5\u770b\u8282\u70b9Pending\u539f\u56e0\nkubectl describe pod loki-0 -n loki\nkubectl describe pod loki-minio-0 -n loki\nkubectl describe pod loki-chunks-cache-0 -n loki\n\n# \u5378\u8f7dLoki\nhelm uninstall loki --namespace loki\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"2-\u5c06promtail\u5b89\u88c5\u4e3akubernetes-daemonset",children:"2. \u5c06Promtail\u5b89\u88c5\u4e3aKubernetes Daemonset"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://www.51cto.com/article/782444.html",children:"\u4ec0\u4e48\u662fKubernetes DaemonSet\uff0c\u5982\u4f55\u4f7f\u7528\uff1f"}),"\n\u5c06Promtail\u5b89\u88c5\u4e3aKubernetes Daemonset\u5c06\u4f1a\u5728K8s\u96c6\u7fa4\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72 Promtail"]}),"\n"]}),"\n",(0,s.jsxs)(e.p,{children:["\u8fd9\u4e2aDaemonSet\u4f1a\u6536\u96c6K8s\u96c6\u7fa4\u4e2d\u6240\u6709\u5bb9\u5668\u7684\u65e5\u5fd7\uff0c\u8fd9\u662f\u5355\u79df\u6237\u6a21\u578b\u7684\u6700\u4f73\u89e3\u51b3\u65b9\u6848\u3002\u5c06\u5176\u4e2d\u7684 ",(0,s.jsx)(e.code,{children:"{YOUR_LOKI_ENDPOINT}"})," \u66ff\u6362\u4e3a\u4e0a\u9762\u90e8\u7f72\u7684Loki\u7aef\u70b9\u5730\u5740"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"--- # Daemonset.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: promtail-daemonset\nspec:\n  selector:\n    matchLabels:\n      name: promtail\n  template:\n    metadata:\n      labels:\n        name: promtail\n    spec:\n      serviceAccount: promtail-serviceaccount\n      containers:\n      - name: promtail-container\n        image: grafana/promtail\n        args:\n        - -config.file=/etc/promtail/promtail.yaml\n        env: \n        - name: 'HOSTNAME' # needed when using kubernetes_sd_configs\n          valueFrom:\n            fieldRef:\n              fieldPath: 'spec.nodeName'\n        volumeMounts:\n        - name: logs\n          mountPath: /var/log\n        - name: promtail-config\n          mountPath: /etc/promtail\n        - mountPath: /var/lib/docker/containers\n          name: varlibdockercontainers\n          readOnly: true\n      volumes:\n      - name: logs\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: promtail-config\n        configMap:\n          name: promtail-config\n--- # configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: promtail-config\ndata:\n  promtail.yaml: |\n    server:\n      http_listen_port: 9080\n      grpc_listen_port: 0\n\n    clients:\n    - url: https://{YOUR_LOKI_ENDPOINT}/loki/api/v1/push\n\n    positions:\n      filename: /tmp/positions.yaml\n    target_config:\n      sync_period: 10s\n    scrape_configs:\n    - job_name: pod-logs\n      kubernetes_sd_configs:\n        - role: pod\n      pipeline_stages:\n        - docker: {}\n      relabel_configs:\n        - source_labels:\n            - __meta_kubernetes_pod_node_name\n          target_label: __host__\n        - action: labelmap\n          regex: __meta_kubernetes_pod_label_(.+)\n        - action: replace\n          replacement: $1\n          separator: /\n          source_labels:\n            - __meta_kubernetes_namespace\n            - __meta_kubernetes_pod_name\n          target_label: job\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_namespace\n          target_label: namespace\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_pod_name\n          target_label: pod\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_pod_container_name\n          target_label: container\n        - replacement: /var/log/pods/*$1/$2/*.log # $1=pod_uid, $2=container_name\n          separator: /\n          source_labels:\n            - __meta_kubernetes_pod_uid\n            - __meta_kubernetes_pod_container_name\n          target_label: __path__\n\n--- # Clusterrole.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: promtail-clusterrole\nrules:\n  - apiGroups: [\"\"]\n    resources:\n    - nodes\n    - services\n    - pods\n    verbs:\n    - get\n    - watch\n    - list\n\n--- # ServiceAccount.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: promtail-serviceaccount\n\n--- # Rolebinding.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: promtail-clusterrolebinding\nsubjects:\n    - kind: ServiceAccount\n      name: promtail-serviceaccount\n      namespace: default\nroleRef:\n    kind: ClusterRole\n    name: promtail-clusterrole\n    apiGroup: rbac.authorization.k8s.io\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u90e8\u7f72\u548c\u67e5\u8be2Daemonset"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u90e8\u7f72 Promtail DaemonSet \nkubectl apply -f promtail-daemonset.yaml\n\n# \u67e5\u8be2\u51fa Pod \u4ee5\u53ca\u5b83\u4eec\u90e8\u7f72\u5230\u7684\u8282\u70b9\nkubectl get pods -l name=promtail -o wide\n\n# \u67e5\u8be2DaemonSet \u7684\u4fe1\u606f\nkubectl get daemonset\n\n# \u5220\u9664Daemonset\nkubectl delete daemonset/promtail-daemonset\n\n# \u67e5\u770bDaemonset\u72b6\u6001\u53ca\u5f02\u5e38\u539f\u56e0\nkubectl describe pod promtail-daemonset-8d5gv\n\n# \u67e5\u770b\u914d\u7f6e\u6587\u4ef6\nkubectl exec -it promtail-daemonset-8d5gv -n default -- cat /etc/promtail/promtail.yaml\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"3-kubernetes\u5b89\u88c5grafana",children:"3. Kubernetes\u5b89\u88c5Grafana"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u521b\u5efa\u547d\u540d\u7a7a\u95f4"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl create namespace grafana\n\n# \u67e5\u770b\nkubectl get namespace grafana\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsxs)(e.li,{children:["\u521b\u5efa\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"grafana.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: grafana-pvc\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: grafana\n  name: grafana\nspec:\n  selector:\n    matchLabels:\n      app: grafana\n  template:\n    metadata:\n      labels:\n        app: grafana\n    spec:\n      securityContext:\n        fsGroup: 472\n        supplementalGroups:\n          - 0\n      containers:\n        - name: grafana\n          image: grafana/grafana:latest\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 3000\n              name: http-grafana\n              protocol: TCP\n          readinessProbe:\n            failureThreshold: 3\n            httpGet:\n              path: /robots.txt\n              port: 3000\n              scheme: HTTP\n            initialDelaySeconds: 10\n            periodSeconds: 30\n            successThreshold: 1\n            timeoutSeconds: 2\n          livenessProbe:\n            failureThreshold: 3\n            initialDelaySeconds: 30\n            periodSeconds: 10\n            successThreshold: 1\n            tcpSocket:\n              port: 3000\n            timeoutSeconds: 1\n          resources:\n            requests:\n              cpu: 250m\n              memory: 750Mi\n          volumeMounts:\n            - mountPath: /var/lib/grafana\n              name: grafana-pv\n      volumes:\n        - name: grafana-pv\n          persistentVolumeClaim:\n            claimName: grafana-pvc\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\nspec:\n  ports:\n    - port: 3000\n      protocol: TCP\n      targetPort: http-grafana\n  selector:\n    app: grafana\n  sessionAffinity: None\n  type: LoadBalancer\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"\u90e8\u7f72\u670d\u52a1\uff0c\u521b\u5efaPVC Deployment Services"}),"\n"]}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Object"}),(0,s.jsx)(e.th,{children:"Description"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Persistent Volume Claim (PVC)"}),(0,s.jsx)(e.td,{children:"This object stores the data."})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Service"}),(0,s.jsx)(e.td,{children:"This object provides network access to the Pod defined in the deployment."})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Deployment"}),(0,s.jsx)(e.td,{children:"This object is responsible for creating the pods, ensuring they stay up to date, and managing Replicaset and Rolling updates."})]})]})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u90e8\u7f72\nkubectl apply -f grafana.yaml --namespace=grafana\n\n# \u67e5\u770b\nkubectl get pvc --namespace=grafana -o wide\nkubectl get deployments --namespace=grafana -o wide\nkubectl get svc --namespace=grafana -o wide\n\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u67e5\u770b\u670d\u52a1\u90e8\u7f72\u60c5\u51b5\uff0c\u8bb0\u5f55 EXTERNAL-IP\uff0c\u5373Grafana\u7684\u8bbf\u95ee\u5730\u5740\nkubectl get all --namespace=grafana\n\n# \u5982\u679c\u4e0d\u60f3\u4f7f\u7528 EXTERNAL-IP \uff0c\u6267\u884c\u4e0b\u9762\u547d\u4ee4\u5c06\u7aef\u53e3\u8f6c\u53d1\u5230\u8282\u70b9\u7aef\u53e3\u4e0a\nkubectl port-forward service/grafana 3000:3000 --namespace=grafana\n\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u9879\u76ee\u65e5\u5fd7\u6536\u96c6\u5b9e\u64cd",children:"\u9879\u76ee\u65e5\u5fd7\u6536\u96c6\u5b9e\u64cd"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"Docker Compose \u90e8\u7f72 Loki + Grafana"}),"\n",(0,s.jsx)(e.li,{children:"K8s DaemonSet \u90e8\u7f72 Promtail"}),"\n",(0,s.jsx)(e.li,{children:"K8s \u90e8\u7f72Spring Boot\u5e94\u7528"}),"\n",(0,s.jsx)(e.li,{children:"\u672c\u5730\u90e8\u7f72 Spring Boot Jar\u5305"}),"\n",(0,s.jsx)(e.li,{children:"\u672c\u5730\u90e8\u7f72 Nginx"}),"\n",(0,s.jsx)(e.li,{children:"Promtail \u6536\u96c6\u672c\u5730\u65e5\u5fd7"}),"\n",(0,s.jsx)(e.li,{children:"Grafana \u9762\u677f\u67e5\u770b\u65e5\u5fd7"}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"1-docker-compose\u90e8\u7f72loki--grafana",children:"1. Docker Compose\u90e8\u7f72Loki + Grafana"}),"\n",(0,s.jsxs)(e.p,{children:["Docker Compose\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"docker-compose.yaml"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'version: "3.3"\n\nnetworks:\n  loki:\n\nservices:\n  loki:\n    image: grafana/loki:3.5.1\n    ports:\n      - "3100:3100"\n    command: -config.file=/etc/loki/local-config.yaml\n    environment:\n      - TZ=Asia/Shanghai\n    networks:\n      - loki\n    \n#  promtail:\n#    image: grafana/promtail:3.5.1\n#    volumes:\n#      - /var/log:/var/log\n#    command: -config.file=/etc/promtail/config.yml\n#    networks:\n#      - loki\n\n  grafana:\n    environment:\n      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning\n      - GF_AUTH_ANONYMOUS_ENABLED=true\n      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin\n      - GF_FEATURE_TOGGLES_ENABLE=alertingSimplifiedRouting,alertingQueryAndExpressionsStepMode\n      - TZ=Asia/Shanghai\n    entrypoint:\n      - sh\n      - -euc\n      - |\n        mkdir -p /etc/grafana/provisioning/datasources\n        cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml\n        apiVersion: 1\n        datasources:\n        - name: Loki\n          type: loki\n          access: proxy \n          orgId: 1\n          url: http://loki:3100\n          basicAuth: false\n          isDefault: true\n          version: 1\n          editable: false\n        EOF\n        /run.sh\n    image: grafana/grafana:12.0.1\n    ports:\n      - "3000:3000"\n    networks:\n      - loki\n\n'})}),"\n",(0,s.jsx)(e.p,{children:"\u90e8\u7f72Loki Grafana"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\ndocker compose -f docker-compose.yaml up -d\n\n# \u505c\u6b62\ndocker compose -f docker-compose.yaml down\n\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u6d4f\u89c8\u5668\u8bbf\u95eeLoki\u76d1\u63a7\u6307\u6807\u9875\u9762","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"http://192.168.137.121:3100/metrics"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\u6d4f\u89c8\u5668\u8bbf\u95eeGrafana\u9875\u9762","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"http://192.168.137.121:3000"})}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"admin"})," / ",(0,s.jsx)(e.code,{children:"admin"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"2-k8s-daemonset\u90e8\u7f72promtail",children:"2. K8s DaemonSet\u90e8\u7f72Promtail"}),"\n",(0,s.jsxs)(e.p,{children:["Promtail DaemonSet\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"promtail-daemonset.yaml"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"--- # Daemonset.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: promtail-daemonset\nspec:\n  selector:\n    matchLabels:\n      name: promtail\n  template:\n    metadata:\n      labels:\n        name: promtail\n    spec:\n      serviceAccount: promtail-serviceaccount\n      containers:\n      - name: promtail-container\n        image: grafana/promtail\n        args:\n        - -config.file=/etc/promtail/promtail.yaml\n        env: \n        - name: 'HOSTNAME' # needed when using kubernetes_sd_configs\n          valueFrom:\n            fieldRef:\n              fieldPath: 'spec.nodeName'\n        volumeMounts:\n        - name: logs\n          mountPath: /var/log\n        - name: promtail-config\n          mountPath: /etc/promtail\n        - mountPath: /var/lib/docker/containers\n          name: varlibdockercontainers\n          readOnly: true\n      volumes:\n      - name: logs\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: promtail-config\n        configMap:\n          name: promtail-config\n--- # configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: promtail-config\ndata:\n  promtail.yaml: |\n    server:\n      http_listen_port: 9080\n      grpc_listen_port: 0\n\n    clients:\n    - url: http://192.168.137.121:3100/loki/api/v1/push  # \u6ce8\u610f\u8fd9\u91cc\u7684\u534f\u8bae\u4e3a HTTP\uff0cIP \u7aef\u53e3\u4e3aLoki\u6620\u5c04\u7684\u7269\u7406\u673aIP \u7aef\u53e3\n\n    positions:\n      filename: /tmp/positions.yaml\n    target_config:\n      sync_period: 10s\n    scrape_configs:\n    - job_name: pod-logs\n      kubernetes_sd_configs:\n        - role: pod\n      pipeline_stages:\n        - docker: {}\n      relabel_configs:\n        # \u68c0\u67e5\u662f\u5426\u6709\u6807\u6ce8\u4e3apromtail.io/scrape=true\u7684\u6ce8\u89e3\uff0c\u6ca1\u6709\u6ce8\u89e3\u7684pod\u4e0d\u91c7\u96c6\n        - source_labels: [__meta_kubernetes_pod_annotation_promtail_io_scrape]\n          action: keep\n          regex: true\n        - source_labels:\n            - __meta_kubernetes_pod_node_name\n          target_label: __host__\n        - action: labelmap\n          regex: __meta_kubernetes_pod_label_(.+)\n        - action: replace\n          replacement: $1\n          separator: /\n          source_labels:\n            - __meta_kubernetes_namespace\n            - __meta_kubernetes_pod_name\n          target_label: job\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_namespace\n          target_label: namespace\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_pod_name\n          target_label: pod\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_pod_container_name\n          target_label: container\n        - replacement: /var/log/pods/*$1/$2/*.log # $1=pod_uid, $2=container_name\n          separator: /\n          source_labels:\n            - __meta_kubernetes_pod_uid\n            - __meta_kubernetes_pod_container_name\n          target_label: __path__\n\n--- # Clusterrole.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: promtail-clusterrole\nrules:\n  - apiGroups: [\"\"]\n    resources:\n    - nodes\n    - services\n    - pods\n    verbs:\n    - get\n    - watch\n    - list\n\n--- # ServiceAccount.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: promtail-serviceaccount\n\n--- # Rolebinding.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: promtail-clusterrolebinding\nsubjects:\n    - kind: ServiceAccount\n      name: promtail-serviceaccount\n      namespace: default\nroleRef:\n    kind: ClusterRole\n    name: promtail-clusterrole\n    apiGroup: rbac.authorization.k8s.io\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"Promtail DaemonSet\u90e8\u7f72"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u90e8\u7f72 Promtail DaemonSet \nkubectl apply -f promtail-daemonset.yaml\n\n# \u67e5\u8be2\u51fa Pod \u4ee5\u53ca\u5b83\u4eec\u90e8\u7f72\u5230\u7684\u8282\u70b9\nkubectl get pods -l name=promtail -o wide\n\n# \u67e5\u8be2DaemonSet \u7684\u4fe1\u606f\nkubectl get daemonset\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"DaemonSet\u5176\u4ed6\u76f8\u5173\u547d\u4ee4"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u5220\u9664Daemonset\nkubectl delete daemonset/promtail-daemonset\n\n# \u67e5\u770bDaemonset\u72b6\u6001\u53ca\u5f02\u5e38\u539f\u56e0\nkubectl describe pod promtail-daemonset-99bhj\n\n# \u67e5\u770b\u914d\u7f6e\u6587\u4ef6\nkubectl exec -it promtail-daemonset-99bhj -- cat /etc/promtail/promtail.yaml\n\n\n# \u5217\u51fa\u6240\u6709\u7684 ConfigMap \nkubectl get cm\n\n# \u67e5\u770b ConfigMap \u914d\u7f6e\u8be6\u60c5\nkubectl describe cm promtail-config\n\n# \u5220\u9664 ConfigMap\nkubectl delete cm promtail-config\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"3-k8s-\u90e8\u7f72spring-boot\u5e94\u7528",children:"3. K8s \u90e8\u7f72Spring Boot\u5e94\u7528"}),"\n",(0,s.jsxs)(e.p,{children:["\u6784\u5efaDocker\u955c\u50cf\u7684 ",(0,s.jsx)(e.code,{children:"Dockerfile"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-Dockerfile",children:'FROM 192.168.1.210:5000/azul/zulu-openjdk-centos:17-jre-latest\nVOLUME /tmp\nADD pd-service-hzpublic.jar /\nENV JAVA_OPTS="-Xms1g -Xmx1g -XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m \\\n           -Duser.timezone=Asia/Shanghai \\\n           -Dfile.encoding=UTF-8 \\\n           -Dsun.jnu.encoding=UTF-8 \\\n           -Djava.awt.headless=true \\\n           --add-modules java.se \\\n           --add-opens java.base/java.lang=ALL-UNNAMED \\\n           --add-opens java.base/sun.nio.ch=ALL-UNNAMED \\\n           --add-opens java.management/sun.management=ALL-UNNAMED \\\n           --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED \\\n           --add-exports java.base/jdk.internal.ref=ALL-UNNAMED"\nENTRYPOINT java ${JAVA_OPTS} -jar /pd-service-hzpublic.jar\n\n'})}),"\n",(0,s.jsxs)(e.p,{children:["\u5e94\u7528\u90e8\u7f72\u7684 ",(0,s.jsx)(e.code,{children:"k8s-dev.yaml"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Service\nmetadata:\n  name: svc-dz-service-hzpublic\n  namespace: hz-dev-service\nspec:\n  type: NodePort\n  selector:\n    app: hz-service-hzpublic\n  ports:\n    - name: http\n      port: 31121\n      targetPort: 31121\n      nodePort: 30121\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hz-dev-service-hzpublic\n  namespace: hz-dev-service\nspec:\n  minReadySeconds: 50\n  revisionHistoryLimit: 3\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n  replicas: 1\n  selector:\n    matchLabels:\n      app: hz-service-hzpublic\n      version: "1.0.0"\n  template:\n    metadata:\n      labels:\n        app: hz-service-hzpublic\n        version: "1.0.0"\n      annotations:\n        promtail.io/scrape: "true" # promtail\u7b5b\u9009\u6807\u7b7e\uff0c\u9700\u8981\u8bbe\u7f6escrape\u4e3atrue\n        promtail.io/path: "/logs/pd-service-hzpublic-all.log" # \u65e5\u5fd7\u6587\u4ef6\u7684\u8def\u5f84\u540d\u79f0\n    spec:\n      imagePullSecrets:\n        - name: pisxdocker\n      containers:\n        - name: hz-service-hzpublic\n          image: 192.168.1.210:5000/library/pd-service-hzpublic:lpg-1.0.0\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 31121\n          volumeMounts:\n            - name: logs-hz-service-hzpublic\n              mountPath: /logs\n          # \u542f\u52a8\u63a2\u9488\uff0c\u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u542f\u52a8\u6210\u529f\n          startupProbe:\n            httpGet:\n              path: /hzpublic/actuator/health/readiness\n              port: 31121\n            periodSeconds: 10 # \u63a2\u6d4b\u65f6\u95f4\u95f4\u9694\n            timeoutSeconds: 5 # \u8d85\u65f6\u65f6\u95f4\n            failureThreshold: 30 # \u91cd\u8bd5\u6b21\u6570\n          # \u5b58\u6d3b\u63a2\u9488\uff0c\u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u5b58\u6d3b\n          livenessProbe:\n            httpGet:\n              path: /hzpublic/actuator/health/liveness\n              port: 31121\n            initialDelaySeconds: 30\n            periodSeconds: 10\n            timeoutSeconds: 20\n            failureThreshold: 5\n          resources:\n            limits:\n              cpu: "2"\n              memory: "2048Mi"\n              ephemeral-storage: "2Gi"\n            requests:\n              cpu: "0.2"\n              memory: "1024Mi"\n          env:\n            - name: TZ\n              value: \'Asia/Shanghai\'\n      volumes:\n        - name: logs-hz-service-hzpublic\n          hostPath:\n            path: /data/logs\n\n'})}),"\n",(0,s.jsx)(e.p,{children:"\u7f16\u8bd1\u955c\u50cf\u5e76\u4f7f\u7528K8s\u90e8\u7f72\u5e94\u7528"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u62c9\u53d6\u57fa\u7840\u955c\u50cf\ndocker pull azul/zulu-openjdk-centos:17-jre-latest\n\n# \u91cd\u65b0\u6253tag\ndocker tag azul/zulu-openjdk-centos:17-jre-latest 192.168.1.210:5000/azul/zulu-openjdk-centos:17-jre-latest\n\n# \u6784\u5efa\u955c\u50cf\ndocker build -t 192.168.1.210:5000/library/pd-service-hzpublic:lpg-1.0.0 .\n\n# \u5bfc\u51fa\u955c\u50cf\ndocker save 192.168.1.210:5000/library/pd-service-hzpublic:lpg-1.0.0 -o pd-service-hzpublic_lpg-1.0.0.tar\n\n# \u53d1\u9001\u5230\u96c6\u7fa4\u5176\u4ed6\u8282\u70b9\nscp zulu-openjdk-centos_17-jre-latest.tar diginn@192.168.137.122:/home/diginn\nscp pd-service-hzpublic_lpg-1.0.0.tar diginn@192.168.137.122:/home/diginn\n\n# \u5728\u96c6\u7fa4\u5176\u4ed6\u8282\u70b9\u5bfc\u5165\u955c\u50cf\ndocker load -i zulu-openjdk-centos_17-jre-latest.tar\ndocker load -i pd-service-hzpublic_lpg-1.0.0.tar\n\n# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl create namespace hz-dev-service\nkubectl get namespace hz-dev-service\n\n# \u5982\u6709\u9700\u8981\uff0c\u5148\u5220\u9664\u518d\u90e8\u7f72\u670d\u52a1\nkubectl delete -f k8s-dev.yaml\nkubectl apply -f k8s-dev.yaml\n\n# \u67e5\u8be2Pod\nkubectl get pods -n hz-dev-service -o wide\n\n# \u67e5\u8be2pod\u8be6\u7ec6\u4fe1\u606f\nkubectl describe pod hz-dev-service-hzpublic-78b6f468cd-x6zjb -n hz-dev-service\n\n# \u8fdb\u5165\u547d\u4ee4\u884c\u4ea4\u4e92\u6a21\u5f0f\uff0c\u67e5\u770b\u65e5\u5fd7\u6587\u4ef6\u7684\u4f4d\u7f6e\nkubectl exec -it hz-dev-service-hzpublic-78b6f468cd-x6zjb -n hz-dev-service -- /bin/bash\n\n"})}),"\n",(0,s.jsx)(e.h3,{id:"4-\u672c\u5730\u90e8\u7f72-spring-boot-jar\u5305",children:"4. \u672c\u5730\u90e8\u7f72 Spring Boot Jar\u5305"}),"\n",(0,s.jsx)(e.p,{children:"\u914d\u7f6e\u73af\u5883\u53d8\u91cf"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u914d\u7f6e\u73af\u5883\u53d8\u91cf\ncat >> ~/.bashrc << 'EOF'\nexport JAVA_HOME=/home/diginn/jdk-17.0.0.1\nexport PATH=$JAVA_HOME/bin:$PATH\n\nEOF\n\n# \u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nsource ~/.bashrc\njava --version\n\n# \u8fd0\u884cjar\u5305\nnohup java -jar pd-service-hzctm.jar > /dev/null 2>&1 &\n\n# \u65e5\u5fd7\u4f4d\u7f6e\n/home/diginn/logs/pd-service-hzctm-all.log\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u542f\u505c\u811a\u672c"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup java -jar pd-service-hzctm.jar > /dev/null 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u542f\u52a8\u670d\u52a1"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"./startup.sh\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u5982\u679c\u8981\u8f93\u51faJSON\u683c\u5f0f\u7684\u65e5\u5fd7\uff0c\u53ef\u53c2\u8003\u4e0b\u9762\u6587\u7ae0"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.baeldung.com/java-log-json-output",children:"Get Log Output in JSON"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://blog.csdn.net/qq_38046739/article/details/120324838",children:"springboot \u4e2d logback \u914d\u7f6e\u8f93\u51fa json\u683c\u5f0f \u7684\u65e5\u5fd7"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://logback.qos.ch/manual/layouts.html",children:"Logback\u8f93\u51fa\u65e5\u5fd7\u683c\u5f0f"})}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-xml",children:"<dependency>\n    <groupId>net.logstash.logback</groupId>\n    <artifactId>logstash-logback-encoder</artifactId>\n    <version>7.4</version>\n</dependency>\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u4fee\u6539logback\u914d\u7f6e:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-xml",children:'<appender name="console" class="ch.qos.logback.core.ConsoleAppender">\n    <encoder charset="UTF-8" class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">\n        <providers>\n            <pattern>\n                <pattern>\n                    {\n                    \x3c!--\u670d\u52a1\u540d\u79f0--\x3e\n                    "appName": "${appName}",\n                    \x3c!--\u6253\u5370\u65f6\u95f4--\x3e\n                    "time": "%date{yyyy-MM-dd HH:mm:ss.SSS}",\n                    \x3c!--\u65e5\u5fd7\u7ea7\u522b--\x3e\n                    "level": "%level",\n                    \x3c!--\u8fdb\u7a0bID--\x3e\n                    "pid": "${PID:-}",\n                    \x3c!--\u7ebf\u7a0b\u540d--\x3e\n                    "thread": "%thread",\n                    \x3c!--\u5168\u9650\u5b9a\u7c7b\u540d--\x3e\n                    "class": "%logger",\n                    \x3c!--\u7c7b\u4e2d\u7684\u54ea\u4e2a\u65b9\u6cd5--\x3e\n                    "method": "%method",\n                    \x3c!--\u7c7b\u4e2d\u7684\u7b2c\u51e0\u884c--\x3e\n                    "line": "%line",\n                    \x3c!--\u65e5\u5fd7\u6253\u5370\u7684\u4fe1\u606f--\x3e\n                    "message": "%message",\n                    \x3c!--\u5806\u6808\u5f02\u5e38\u4fe1\u606f--\x3e\n                    "statck_trace":"%xEx"\n                    }\n                </pattern>\n            </pattern>\n        </providers>\n    </encoder>\n</appender>\n\n'})}),"\n",(0,s.jsx)(e.h3,{id:"5-\u672c\u5730\u90e8\u7f72-nginx",children:"5. \u672c\u5730\u90e8\u7f72 Nginx"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u5728\u7ebf\u5b89\u88c5\u7f16\u8bd1\u4f9d\u8d56\n# sudo yum install gcc gcc-c++ make zlib zlib-devel pcre pcre-devel openssl openssl-devel\n\n# \u4e0b\u8f7d\u4f9d\u8d56\u5305\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/gcc gcc\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/gcc-c++ gcc-c++\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/make make\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/pcre pcre\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/pcre pcre-devel\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/zlib zlib\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/zlib zlib-devel\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/openssl openssl\ndnf download --archlist=x86_64,noarch --resolve --destdir=./lib/openssl openssl-devel\n\n# \u5b89\u88c5\u4f9d\u8d56\nsudo dnf install -y ./lib/gcc/*.rpm\nsudo dnf install -y ./lib/gcc-c++/*.rpm\nsudo dnf install -y ./lib/make/*.rpm\nsudo dnf install -y ./lib/pcre/*.rpm\nsudo dnf install -y ./lib/zlib/*.rpm\nsudo dnf install -y ./lib/openssl/*.rpm\n\n# \u4e0b\u8f7d\nwget https://nginx.org/download/nginx-1.28.0.tar.gz\n\n# \u89e3\u538b\ntar -zxvf nginx-1.28.0.tar.gz\ncd nginx-1.28.0\n\n# \u7f16\u8bd1\u914d\u7f6e\nsudo mkdir -p /var/temp/nginx\n\n./configure \\\n--prefix=/usr/local/nginx \\\n--conf-path=/usr/local/nginx/conf/nginx.conf \\\n--pid-path=/usr/local/nginx/conf/nginx.pid \\\n--lock-path=/var/lock/nginx.lock \\\n--error-log-path=/var/log/nginx/error.log \\\n--http-log-path=/var/log/nginx/access.log \\\n--with-http_gzip_static_module \\\n--http-client-body-temp-path=/var/temp/nginx/client \\\n--http-proxy-temp-path=/var/temp/nginx/proxy \\\n--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \\\n--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \\\n--http-scgi-temp-path=/var/temp/nginx/scgi\n\n# \u7f16\u8bd1\u5b89\u88c5\nsudo make\nsudo make install\n\n# \u542f\u52a8\nsudo /usr/local/nginx/sbin/nginx\n\n# \u6d4b\u8bd5\ncurl http://192.168.137.132\n\n# \u6ce8\u518c\u4e3a\u670d\u52a1\ncat >> /etc/systemd/system/nginx.service << EOF\n[Unit]\nDescription=The NGINX HTTP and reverse proxy server\nAfter=network-online.target remote-fs.target nss-lookup.target\nWants=network-online.target\n \n[Service]\nType=forking\nPIDFile=/usr/local/nginx/conf/nginx.pid\nExecStartPre=/usr/local/nginx/sbin/nginx -t -q -g 'daemon on; master_process on;'\nExecStart=/usr/local/nginx/sbin/nginx -g 'daemon on; master_process on;'\nExecReload=/usr/local/nginx/sbin/nginx -s reload\nKillMode=process\nRestart=on-failure\nRestartSec=5s\nPrivateTmp=true\n \n[Install]\nWantedBy=multi-user.target\n\nEOF\n\n# \u8bbe\u7f6e\u5f00\u673a\u8fd0\u884c\nsudo systemctl daemon-reload\nsudo systemctl start nginx.service\nsudo systemctl enable nginx.service  # \u4f7fNginx\u5728\u542f\u52a8\u65f6\u81ea\u52a8\u8fd0\u884c\nsudo systemctl status nginx.service\n\n# \u65e5\u5fd7\u4f4d\u7f6e\n/var/log/nginx/access.log\n/var/log/nginx/error.log\n\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u53ef\u4ee5\u5728nginx\u914d\u7f6e\u6587\u4ef6 ",(0,s.jsx)(e.code,{children:"/usr/local/nginx/conf/nginx.conf"})," \u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff0c\u5c06nginx\u65e5\u5fd7\u6539\u4e3ajson\u683c\u5f0f"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-conf",children:'    ##\n    # Logging Settings\n    ##\n    log_format access_json escape=json\n      \'{\'\n        \'"@timestamp":"$time_iso8601",\'\n        \'"host":"$server_addr",\'\n        \'"clientip":"$remote_addr",\'\n        \'"size":$body_bytes_sent,\'\n        \'"responsetime":$request_time,\'\n        \'"upstreamtime":"$upstream_response_time",\'\n        \'"upstreamhost":"$upstream_addr",\'\n        \'"request":"$request",\'\n        \'"uri":"$uri",\'\n        \'"domain":"$host",\'\n        \'"x_forwarded_for":"$http_x_forwarded_for",\'\n        \'"referer":"$http_referer",\'\n        \'"tcp_xff":"$proxy_protocol_addr",\'\n        \'"http_user_agent":"$http_user_agent",\'\n        \'"status":"$status"\'\n      \'}\';\n\n    access_log /var/log/nginx/access.log access_json;\n\n'})}),"\n",(0,s.jsx)(e.h3,{id:"6-promtail-\u6536\u96c6\u672c\u5730\u65e5\u5fd7",children:"6. Promtail \u6536\u96c6\u672c\u5730\u65e5\u5fd7"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/stages/json/",children:"Promtail\u914d\u7f6epipeline stage json"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/stages/timestamp/",children:"Promtail\u914d\u7f6epipeline stage timestamp"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://stackoverflow.com/questions/58564836/how-to-promtail-parse-json-to-label-and-timestamp",children:"promtail\u89e3\u6790json tag"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://blog.frognew.com/2023/05/loki-06-promtail-java-logs.html",children:"Grafana Loki\u7b14\u8bb006: \u4f7f\u7528Promtail\u6536\u96c6Java\u5e94\u7528\u65e5\u5fd7\u53d1\u9001\u7ed9Loki"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.a,{href:"https://www.oneearmouse.com/posts/loki-promtail-spring-log/",children:"Loki\u7cfb\u7edf\u4e2d\u4f7f\u7528Promtail\u5904\u7406\u89e3\u6790SpringBoot\u7684Log\u65e5\u5fd7"})}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u6536\u96c6\u672c\u5730\u65e5\u5fd7\u91c7\u7528\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u5b89\u88c5\uff0c\u6b65\u9aa4\u53c2\u8003\u4e0a\u9762\u7ae0\u8282"}),"\n",(0,s.jsxs)(e.p,{children:["\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u91c7\u96c6SpringBoot\u53caNginx\u65e5\u5fd7 ",(0,s.jsx)(e.code,{children:"promtail-local-config.yaml"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://192.168.137.121:3100/loki/api/v1/push\n\nscrape_configs:\n- job_name: nginx-json\n  # \u6293\u53d6\u672c\u5730Nginx\u65e5\u5fd7\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: nginx\n      __path__: /var/log/nginx/*.log\n  # \u7ed9\u6587\u4ef6\u6253\u6807\u7b7e\uff0c\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u4ef6\u91c7\u7528\u4e0d\u540c\u7684\u89e3\u6790\u7b56\u7565\n  relabel_configs:\n  - source_labels: [__path__]\n    regex: .*\n    action: replace\n    target_label: log_type\n    replacement: text  # \u9ed8\u8ba4\u7c7b\u578b\n  - source_labels: [__path__]\n    regex: .*(access).* # accesslog\u683c\u5f0f\u6539\u4e3ajson\u4e86\uff0c\u4f7f\u7528json\u89e3\u6790\n    replacement: json\n    target_label: log_type\n  pipeline_stages:\n  # \u89e3\u6790\u666e\u901a\u6587\u672c\n  - match:\n      selector: '{log_type=\"text\"}'\n      stages:\n        # - debug:\n        #   message: 'File: {{ .__path__ }} | Log type: {{ .log_type }} | __Log type__: {{ .__log_type__ }}' \n        - regex:\n            expression: '^(?P<timestamp>\\d{4}/\\d{2}/\\d{2} \\d{2}:\\d{2}:\\d{2}) \\[(?P<level>\\w+)\\] (?P<pid>\\d+)\\#(?P<tid>\\d+): \\*(?P<message>.*)$'\n        - json:\n            output: log\n            expressions:\n              timestamp: timestamp\n              level: level\n              process_id: pid\n              thread_id: tid\n              message: message\n        # 3. \u8bbe\u7f6e\u65e5\u5fd7\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006/01/02 15:04:05\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n          \n        # 4. \u5c06\u5173\u952e\u5b57\u6bb5\u8f6c\u4e3a\u6807\u7b7e\uff08\u4f4e\u57fa\u6570\u5b57\u6bb5\uff09\n        - labels:\n            level:\n          \n        # 5. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u9ad8\u57fa\u6570\u5b57\u6bb5\uff09\n        - structured_metadata:\n            process_id:\n            thread_id:\n  # \u89e3\u6790json\n  - match:\n      selector: '{log_type=\"json\"}'\n      stages:\n        - json:\n            expressions: \n              timestamp: '\"@timestamp\"'\n              host: host\n              clientip: clientip\n              size: size\n              responsetime: responsetime\n              upstreamtime: upstreamtime\n              upstreamhost: upstreamhost\n              request: request\n              uri: uri\n              domain: domain\n              x_forwarded_for: x_forwarded_for\n              referer: referer\n              tcp_xff: tcp_xff\n              http_user_agent: http_user_agent\n              status: status\n            max_depth: 3  # \u9632\u6b62\u6df1\u5c42\u5d4c\u5957\u6d88\u8017\u8d44\u6e90\n            drop_malformed: true  # \u4e22\u5f03\u65e0\u6548JSON\n        # 2. \u8bbe\u7f6e\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006-01-02 15:04:05.000\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n        # 3. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u4f7f\u5b57\u6bb5\u663e\u793a\u5728 Parsed Fields\uff09\n        - structured_metadata:\n            clientip:\n            x_forwarded_for:\n            request:\n            domain:\n            uri:\n            status:\n- job_name: pd-service\n  # \u6293\u53d6\u672c\u5730SpringBoot\u65e5\u5fd7\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: pd-service\n      __path__: /home/diginn/logs/*.log\n  # \u7ed9\u6587\u4ef6\u6253\u6807\u7b7e\uff0c\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u4ef6\u91c7\u7528\u4e0d\u540c\u7684\u89e3\u6790\u7b56\u7565\n  relabel_configs:\n  - source_labels: [__path__]\n    regex: .*\n    action: replace\n    target_label: log_type\n    replacement: text  # \u9ed8\u8ba4\u7c7b\u578b\n  - source_labels: [__path__]\n    regex: .*(json).* # json\u683c\u5f0f\u7684\u65e5\u5fd7\u540d\u79f0\u4e2d\u5305\u542b json\n    replacement: json\n    target_label: log_type\n  pipeline_stages:\n  # \u89e3\u6790\u666e\u901a\u6587\u672c\n  - match:\n      selector: '{log_type=\"text\"}'\n      stages:\n        # - debug:\n        #   message: 'File: {{ .__path__ }} | Log type: {{ .log_type }} | __Log type__: {{ .__log_type__ }}' \n        # 1. \u4f7f\u7528\u6b63\u5219\u63d0\u53d6\u6240\u6709\u5b57\u6bb5 %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{requestId}] [%-5level] %C.%M[%L line] - %m%n\n        - regex:\n            expression: '^(?P<timestamp>\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d{3}) \\[(?P<thread>[^\\]]*)\\] \\[(?P<request_id>[^\\]]*)\\] \\[(?P<level>\\w+)\\s*\\] (?P<class>\\w+(?:\\.\\w+)*)\\.(?P<method>\\w+)\\[(?P<line>\\d+) line\\] - (?P<message>.*)$'\n          \n        # 2. \u6e05\u7406 level \u5b57\u6bb5\u7684\u7a7a\u683c\uff08Log4j2 \u5de6\u5bf9\u9f50\u8865\u7a7a\u683c\uff09\n        - replace:\n            source: level\n            expression: '\\s+$'\n            replace: ''\n          \n        # 3. \u8bbe\u7f6e\u65e5\u5fd7\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006-01-02 15:04:05.000\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n          \n        # 4. \u5c06\u5173\u952e\u5b57\u6bb5\u8f6c\u4e3a\u6807\u7b7e\uff08\u4f4e\u57fa\u6570\u5b57\u6bb5\uff09\n        - labels:\n            level:\n            request_id:\n          \n        # 5. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u9ad8\u57fa\u6570\u5b57\u6bb5\uff09\n        - structured_metadata:\n            thread: thread  # \u5f15\u7528 regex \u63d0\u53d6\u7684\u5b57\u6bb5\n            class: class\n            method: method\n            line: line\n        # - template:\n        #     source: new_line\n        #     template: 'logger={{ .class }} threadName={{ .thread }} methodName={{ .method }} line={{ .line }} | {{ or .message .stack_trace }}'\n        # - output:\n        #     source: new_line\n  # \u89e3\u6790json\n  - match:\n      selector: '{log_type=\"json\"}'\n      stages:\n        # 1. \u89e3\u6790 JSON \u5e76\u63d0\u53d6\u5b57\u6bb5\n        - json:\n            expressions: \n              thread: thread\n              threadId: threadId\n              level: level\n              loggerName: loggerName\n              message: message\n              requestId: requestId\n              timestamp: timestamp\n            max_depth: 3  # \u9632\u6b62\u6df1\u5c42\u5d4c\u5957\u6d88\u8017\u8d44\u6e90\n            drop_malformed: true  # \u4e22\u5f03\u65e0\u6548JSON\n        # 2. \u8bbe\u7f6e\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006-01-02 15:04:05.000\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n        # 3. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u4f7f\u5b57\u6bb5\u663e\u793a\u5728 Parsed Fields\uff09\n        - structured_metadata:\n            thread:\n            threadId:\n            level:\n            loggerName:\n            requestId:\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u542f\u505c\u811a\u672c"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup ./promtail-linux-amd64 -config.file=promtail-local-config.yaml >./promtail.log 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u542f\u52a8Promtail"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"./startup.sh\n\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u6d4f\u89c8\u5668\u8bbf\u95ee ",(0,s.jsx)(e.code,{children:"http://192.168.137.132:9080/targets"})]}),"\n",(0,s.jsx)(e.h3,{id:"7-\u6548\u679c\u5c55\u793a",children:"7. \u6548\u679c\u5c55\u793a"}),"\n",(0,s.jsxs)(e.p,{children:["\u53ef\u4ee5\u4f7f\u7528 promtail job, service_name, filename \u7b49\u7ef4\u5ea6\u5bf9\u65e5\u5fd7\u8fdb\u884c\u7b5b\u9009\n",(0,s.jsx)(e.img,{src:a(13136).A+"",width:"1911",height:"961"}),"\n",(0,s.jsx)(e.img,{src:a(26955).A+"",width:"1911",height:"961"}),"\n",(0,s.jsx)(e.img,{src:a(36450).A+"",width:"1911",height:"961"})]}),"\n",(0,s.jsxs)(e.p,{children:["\u5bf9\u4e8eK8s\u90e8\u7f72\u7684\u670d\u52a1\uff0c\u8fd8\u80fd\u4f7f\u7528 pod\u540d\u79f0 namespace\uff0ccontainer\u7b49\u7ef4\u5ea6\u8fdb\u884c\u7b5b\u9009\n",(0,s.jsx)(e.img,{src:a(98173).A+"",width:"1911",height:"961"}),"\n",(0,s.jsx)(e.img,{src:a(77044).A+"",width:"1911",height:"961"}),"\n",(0,s.jsx)(e.img,{src:a(82159).A+"",width:"1911",height:"961"})]}),"\n",(0,s.jsx)(e.h3,{id:"8-\u521b\u5efa\u76d1\u63a7\u9762\u677f",children:"8. \u521b\u5efa\u76d1\u63a7\u9762\u677f"}),"\n",(0,s.jsx)(e.h2,{id:"\u5e38\u89c1\u95ee\u9898",children:"\u5e38\u89c1\u95ee\u9898"}),"\n",(0,s.jsx)(e.h3,{id:"1-\u4f7f\u7528\u5b98\u65b9\u6587\u6863\u63d0\u4f9b\u7684\u914d\u7f6e\u6587\u4ef6\u542f\u52a8loki\u62a5\u9519",children:"1. \u4f7f\u7528\u5b98\u65b9\u6587\u6863\u63d0\u4f9b\u7684\u914d\u7f6e\u6587\u4ef6\u542f\u52a8Loki\u62a5\u9519"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u62a5\u9519\u4fe1\u606f"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"failed parsing config: ./loki-local-config.yaml: yaml: unmarshal errors:\n  line 54: field enable_multi_variant_queries not found in type logql.EngineOpts. Use `-config.expand-env=true` flag if you want to expand environment variables in your config file\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsx)(e.li,{children:"\u5f02\u5e38\u539f\u56e0"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"https://github.com/grafana/loki/issues/16990",children:"Deprecated fields in loki-local-config causing unmarshal error"}),"\n\u5982Issue\u4e2d\u63cf\u8ff0\u7684\uff0c\u6700\u65b0\u7248\u672c\u4e2d ",(0,s.jsx)(e.code,{children:"enable_multi_variant_queries"})," \u914d\u7f6e\u4ece ",(0,s.jsx)(e.code,{children:"querier.engine"})," \u79fb\u52a8\u5230\u4e86 ",(0,s.jsx)(e.code,{children:"limits_config"})," \u4e0b\uff0c\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c"]}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"\u89e3\u51b3\u65b9\u6848"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-diff",children:"limits_config:\n   metric_aggregation_enabled: true\n# \u6dfb\u52a0\u4e0b\u9762\u884c \n+  enable_multi_variant_queries: true\n\n# \u5220\u9664\u4e0b\u9762\u884c\n-querier:\n-  engine:\n-    enable_multi_variant_queries: true\n"})}),"\n",(0,s.jsxs)(e.h3,{id:"2-\u4f7f\u7528k8s\u90e8\u7f72loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25-pod-has-unbound-immediate-persistentvolumeclaims",children:["2. \u4f7f\u7528K8s\u90e8\u7f72Loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25 ",(0,s.jsx)(e.code,{children:"pod has unbound immediate PersistentVolumeClaims"})]}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u62a5\u9519\u4fe1\u606f"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# Loki\u542f\u52a8\u5931\u8d25\nkubectl describe pod loki-0 -n loki\n# Minio\u542f\u52a8\u5931\u8d25\nkubectl describe pod loki-minio-0 -n loki\n\n# \u9519\u8bef\u4fe1\u606f\nType     Reason            Age                From               Message\n----     ------            ----               ----               -------\nWarning  FailedScheduling  11m (x4 over 22m)  default-scheduler  0/6 nodes are available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/6 nodes are available: 6 Preemption is not helpful for scheduling.\nWarning  FailedScheduling  85s (x5 over 10m)  default-scheduler  0/6 nodes are available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/6 nodes are available: 6 Preemption is not helpful for scheduling.\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsx)(e.li,{children:"\u9519\u8bef\u539f\u56e0"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u672a\u7ed1\u5b9a\u7684 PVC\uff1aPod \u4f9d\u8d56\u7684\u6301\u4e45\u5377\u58f0\u660e\u6ca1\u6709\u627e\u5230\u5339\u914d\u7684\u6301\u4e45\u5377"}),"\n",(0,s.jsx)(e.li,{children:"\u65e0\u6cd5\u62a2\u5360\uff1a\u8c03\u5ea6\u5668\u65e0\u6cd5\u901a\u8fc7\u9a71\u9010\u5176\u4ed6 Pod \u6765\u89e3\u51b3\u6b64\u95ee\u9898\uff08\u56e0\u4e3a\u5b58\u50a8\u95ee\u9898\u65e0\u6cd5\u901a\u8fc7\u62a2\u5360\u89e3\u51b3\uff09"}),"\n",(0,s.jsx)(e.li,{children:"\u6240\u6709\u8282\u70b9\u4e0d\u53ef\u7528\uff1a\u6240\u6709\u8282\u70b9\u90fd\u62a5\u544a\u6b64\u95ee\u9898\uff08\u4f46\u5b9e\u9645\u662f\u5b58\u50a8\u95ee\u9898\uff0c\u4e0d\u662f\u8282\u70b9\u95ee\u9898\uff09"}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"\u89e3\u51b3\u65b9\u6848"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u8bc6\u522b\u672a\u7ed1\u5b9a\u7684 PVC\nkubectl get pvc -n loki\n\n# \u68c0\u67e5 PVC \u8be6\u60c5\nkubectl describe pvc storage-loki-0 -n loki\n\n# \u68c0\u67e5 PV \u53ef\u7528\u6027\nkubectl get pv\n\n# \u68c0\u67e5 StorageClass\nkubectl get storageclass\nkubectl describe storageclass <sc-name>\n\n# \u4e0a\u9762  kubectl get pv \u548c kubectl get storageclass \u90fd\u65e0\u8fd4\u56de\u4fe1\u606f\n# \u9700\u8981\u5b89\u88c5\u6301\u4e45\u5316\u5b58\u50a8\u7cfb\u7edf\n\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"4",children:["\n",(0,s.jsx)(e.li,{children:"\u5b89\u88c5\u6301\u4e45\u5316\u5b58\u50a8\u7cfb\u7edf"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u6dfb\u52a0 Rook \u4ed3\u5e93\nhelm repo add rook-release https://charts.rook.io/release\n\n# \u62c9\u53d6chart\u5b89\u88c5\u5305\nhelm pull rook-release/rook-ceph\n\n# \u4e0b\u8f7dceph-chart\u6587\u4ef6\nwget https://raw.githubusercontent.com/rook/rook/master/deploy/examples/cluster.yaml rook-ceph-cluster.yaml\n\n# \u5b89\u88c5 Rook Ceph\nhelm install rook-ceph rook-release/rook-ceph --create-namespace --namespace rook-ceph\n\n# \u521b\u5efa Ceph \u96c6\u7fa4\nkubectl apply -f rook-ceph-cluster.yaml\n\n# \u67e5\u770bCeph Pod\nkubectl get pods -n rook-ceph -o wide\n\n# \u5378\u8f7d ceph\nhelm uninstall rook-ceph --namespace rook-ceph\n\n"})}),"\n",(0,s.jsxs)(e.h3,{id:"3-\u4f7f\u7528k8s\u90e8\u7f72loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25-insufficient-memory",children:["3. \u4f7f\u7528K8s\u90e8\u7f72Loki\u65f6\u90e8\u5206\u5bb9\u5668\u542f\u52a8\u5931\u8d25 ",(0,s.jsx)(e.code,{children:"Insufficient memory"})]}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u62a5\u9519\u4fe1\u606f"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-shell",children:"# \u5206\u7247\u7f13\u5b58\u542f\u52a8\u5931\u8d25\nkubectl describe pod loki-chunks-cache-0 -n loki\n\n# \u9519\u8bef\u4fe1\u606f\nType     Reason            Age                  From               Message\n----     ------            ----                 ----               -------\nWarning  FailedScheduling  7m24s (x7 over 18m)  default-scheduler  0/6 nodes are available: 6 Insufficient memory. preemption: 0/6 nodes are available: 6 No preemption victims found for incoming pod.\nWarning  FailedScheduling  2m (x2 over 7m)      default-scheduler  0/6 nodes are available: 6 Insufficient memory. preemption: 0/6 nodes are available: 6 No preemption victims found for incoming pod.\n"})}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsx)(e.li,{children:"\u9519\u8bef\u539f\u56e0"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6838\u5fc3\u95ee\u9898\uff1a\u6240\u6709 6 \u4e2a\u8282\u70b9\u90fd\u6ca1\u6709\u8db3\u591f\u5185\u5b58\u6765\u8fd0\u884c Pod"}),"\n",(0,s.jsx)(e.li,{children:'\u8c03\u5ea6\u5668\u5c1d\u8bd5\uff1aKubernetes \u8c03\u5ea6\u5668\u5c1d\u8bd5\u901a\u8fc7"\u62a2\u5360"(preemption)\u91ca\u653e\u8d44\u6e90\uff08\u9a71\u9010\u4f4e\u4f18\u5148\u7ea7 Pod\uff09\uff0c\u4f46\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u5019\u9009'}),"\n",(0,s.jsx)(e.li,{children:"\u6839\u672c\u539f\u56e0\uff1a\u8be5 Pod \u8bf7\u6c42\u7684\u5185\u5b58\u8d85\u8fc7\u4e86\u96c6\u7fa4\u4e2d\u4efb\u4f55\u8282\u70b9\u7684\u53ef\u7528\u5185\u5b58"}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"\u89e3\u51b3\u65b9\u6848"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"values.yaml"})," \u4e2d ",(0,s.jsx)(e.code,{children:"memcached"})," \u9ed8\u8ba4\u5185\u5b58\u8bbe\u7f6e\u4e3a ",(0,s.jsx)(e.code,{children:"chunksCache.allocatedMemory: 8192"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u5728 ",(0,s.jsx)(e.code,{children:"loki-values.yaml"})," \u4e2d\u914d\u7f6e ",(0,s.jsx)(e.code,{children:"chunksCache.allocatedMemory: 1024"})," \u6765\u8986\u76d6\u9ed8\u8ba4\u914d\u7f6e"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"chunksCache:\n  allocatedMemory: 8192\n\n# \u6539\u4e3a\nchunksCache:\n  allocatedMemory: 1024\n\n"})})]})}function h(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},67541:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/grafana5-003a14fbf62a9e3295f1b292ce1632ad.png"},71614:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/loki1-f96aee28c5aed7df8a8662a2bbce5835.png"},72049:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/loki_architecture_components-c857df56c1baad5c7261fc7129a57082.svg"},74391:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/loki-overview-8baabbdf565c3c9e62352104397588c4.png"},75695:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/docker-loki1-e63af4830f537caf9126fd1eb208133b.png"},77044:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/\u6548\u679c\u5c55\u793a5-c4280529c64a741f0ad1da6daad9313a.png"},82159:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/\u6548\u679c\u5c55\u793a6-9180cdf4d2bc6e6284fc3f49489ce631.png"},91058:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/docker-grafana1-8eb9b3cfe98a4747043577a33bb9d00a.png"},98173:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/\u6548\u679c\u5c55\u793a4-f0fe01209852adb8b7cf032fe2b32a33.png"},98444:(n,e,a)=>{a.d(e,{A:()=>l});const l=a.p+"assets/images/grafana4-39cd3b83bc5c7c8b886b77c3bee87ae4.png"}}]);