"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[9624],{15392:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var t=r(85893),i=r(11151);const o={},a=void 0,s={id:"zh-cn/spring-authorization-server/SAS-Spring-Cloud-Gateway",title:"SAS-Spring-Cloud-Gateway",description:"- Spring Authorization Server\u5165\u95e8 (\u5341\u516d) Spring Cloud Gateway\u5bf9\u63a5\u8ba4\u8bc1\u670d\u52a1",source:"@site/docs/zh-cn/spring-authorization-server/16-SAS-Spring-Cloud-Gateway.md",sourceDirName:"zh-cn/spring-authorization-server",slug:"/zh-cn/spring-authorization-server/SAS-Spring-Cloud-Gateway",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Spring-Cloud-Gateway",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-authorization-server/16-SAS-Spring-Cloud-Gateway.md",tags:[],version:"current",sidebarPosition:16,frontMatter:{},sidebar:"troch",previous:{title:"SAS-Separate-Consent-And-Device-Authorize-Page",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Separate-Consent-And-Device-Authorize-Page"},next:{title:"SAS-Vue-Authorization-Code",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Vue-Authorization-Code"}},c={},l=[{value:"\u4e00\u3001\u524d\u8a00",id:"\u4e00\u524d\u8a00",level:2},{value:"\u4e8c\u3001Gateway\u5bf9\u63a5\u8bf4\u660e",id:"\u4e8cgateway\u5bf9\u63a5\u8bf4\u660e",level:2},{value:"1. \u8eab\u4efd\u95ee\u9898",id:"1-\u8eab\u4efd\u95ee\u9898",level:3},{value:"2. \u6846\u67b6\u7248\u672c\u4e0e\u67b6\u6784\u8bf4\u660e",id:"2-\u6846\u67b6\u7248\u672c\u4e0e\u67b6\u6784\u8bf4\u660e",level:3},{value:"1.\u67b6\u6784\u56fe",id:"1\u67b6\u6784\u56fe",level:4},{value:"2. Spring Cloud\u4f9d\u8d56\u7248\u672c",id:"2-spring-cloud\u4f9d\u8d56\u7248\u672c",level:4},{value:"3. \u7f51\u5173\u96c6\u6210\u8ba4\u8bc1\u670d\u52a1\u8bf7\u6c42\u6d41\u7a0b\u56fe\u8bf4\u660e",id:"3-\u7f51\u5173\u96c6\u6210\u8ba4\u8bc1\u670d\u52a1\u8bf7\u6c42\u6d41\u7a0b\u56fe\u8bf4\u660e",level:3},{value:"\u4e09\u3001\u5f00\u59cb\u7f16\u7801",id:"\u4e09\u5f00\u59cb\u7f16\u7801",level:2},{value:"1. \u524d\u7f6e\u6761\u4ef6",id:"1-\u524d\u7f6e\u6761\u4ef6",level:3},{value:"2. \u9879\u76ee\u7ed3\u6784",id:"2-\u9879\u76ee\u7ed3\u6784",level:3},{value:"3. \u521b\u5efa\u4e00\u4e2a\u7a7a\u7684maven\u9879\u76ee",id:"3-\u521b\u5efa\u4e00\u4e2a\u7a7a\u7684maven\u9879\u76ee",level:3},{value:"4. \u521b\u5efa\u7f51\u5173gateway-client-example\u6a21\u5757",id:"4-\u521b\u5efa\u7f51\u5173gateway-client-example\u6a21\u5757",level:3},{value:"1. \u7f16\u5199\u5ba2\u6237\u7aef\u914d\u7f6e",id:"1-\u7f16\u5199\u5ba2\u6237\u7aef\u914d\u7f6e",level:4},{value:"2. \u7f16\u5199\u7f51\u5173\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",id:"2-\u7f16\u5199\u7f51\u5173\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",level:4},{value:"3. \u7f16\u5199application.yml\uff0c\u6dfb\u52a0nacos\u914d\u7f6e",id:"3-\u7f16\u5199applicationyml\u6dfb\u52a0nacos\u914d\u7f6e",level:4},{value:"4. \u5728nacos\u4e2d\u521b\u5efagateway.yml\u914d\u7f6e\u6587\u4ef6",id:"4-\u5728nacos\u4e2d\u521b\u5efagatewayyml\u914d\u7f6e\u6587\u4ef6",level:4},{value:"5. \u9879\u76ee\u7ed3\u6784",id:"5-\u9879\u76ee\u7ed3\u6784",level:4},{value:"5. \u521b\u5efawebmvc\u8d44\u6e90\u670d\u52a1\u6a21\u5757normal-resource-example",id:"5-\u521b\u5efawebmvc\u8d44\u6e90\u670d\u52a1\u6a21\u5757normal-resource-example",level:3},{value:"1. \u5728pom.xml\u4e2d\u6dfb\u52a0web\u4f9d\u8d56\uff0c\u5982\u4e0b",id:"1-\u5728pomxml\u4e2d\u6dfb\u52a0web\u4f9d\u8d56\u5982\u4e0b",level:4},{value:"2. \u521b\u5efa\u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\uff0c\u6dfb\u52a0\u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668",id:"2-\u521b\u5efa\u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\u6dfb\u52a0\u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668",level:4},{value:"3. \u7f16\u5199application.yml\u6dfb\u52a0nacos\u914d\u7f6e",id:"3-\u7f16\u5199applicationyml\u6dfb\u52a0nacos\u914d\u7f6e-1",level:4},{value:"4. \u5728nacos\u4e2d\u521b\u5efaresource.yml\u914d\u7f6e\u6587\u4ef6\uff0c\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",id:"4-\u5728nacos\u4e2d\u521b\u5efaresourceyml\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",level:4},{value:"5. \u6a21\u5757\u7ed3\u6784",id:"5-\u6a21\u5757\u7ed3\u6784",level:4},{value:"6. \u521b\u5efawebflux\u8d44\u6e90\u670d\u52a1\u6a21\u5757",id:"6-\u521b\u5efawebflux\u8d44\u6e90\u670d\u52a1\u6a21\u5757",level:3},{value:"1. pom.xml\u6dfb\u52a0webflux\u4f9d\u8d56\uff0c\u5982\u4e0b",id:"1-pomxml\u6dfb\u52a0webflux\u4f9d\u8d56\u5982\u4e0b",level:4},{value:"2. \u521b\u5efa\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\u5e76\u4e14\u6dfb\u52a0jwt\u89e3\u6790\u5668\u9002\u914d\u5668",id:"2-\u521b\u5efa\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\u5e76\u4e14\u6dfb\u52a0jwt\u89e3\u6790\u5668\u9002\u914d\u5668",level:4},{value:"3. \u7f16\u5199application.yml\u6dfb\u52a0nacos\u914d\u7f6e",id:"3-\u7f16\u5199applicationyml\u6dfb\u52a0nacos\u914d\u7f6e-2",level:4},{value:"4. nacos\u4e2d\u6dfb\u52a0webflux.yml\u914d\u7f6e\u6587\u4ef6\u5e76\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",id:"4-nacos\u4e2d\u6dfb\u52a0webfluxyml\u914d\u7f6e\u6587\u4ef6\u5e76\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",level:4},{value:"5. \u6a21\u5757\u7ed3\u6784",id:"5-\u6a21\u5757\u7ed3\u6784-1",level:4},{value:"7. \u5728\u4e09\u4e2a\u6a21\u5757\u4e2d\u6dfb\u52a0\u6d4b\u8bd5\u7c7b\uff0c\u4e00\u5f0f\u4e09\u4efd",id:"7-\u5728\u4e09\u4e2a\u6a21\u5757\u4e2d\u6dfb\u52a0\u6d4b\u8bd5\u7c7b\u4e00\u5f0f\u4e09\u4efd",level:3},{value:"1. webmvc\u6d4b\u8bd5\u63a5\u53e3",id:"1-webmvc\u6d4b\u8bd5\u63a5\u53e3",level:4},{value:"2. webflux\u6d4b\u8bd5\u63a5\u53e3",id:"2-webflux\u6d4b\u8bd5\u63a5\u53e3",level:4},{value:"\u56db\u3001\u6d4b\u8bd5",id:"\u56db\u6d4b\u8bd5",level:2},{value:"1. \u524d\u7f6e\u6761\u4ef6",id:"1-\u524d\u7f6e\u6761\u4ef6-1",level:3},{value:"2. \u542f\u52a8\u9879\u76ee",id:"2-\u542f\u52a8\u9879\u76ee",level:3},{value:"3. \u5728postman\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3",id:"3-\u5728postman\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3",level:3},{value:"4. \u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3",id:"4-\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3",level:3},{value:"1. \u8bbf\u95ee",id:"1-\u8bbf\u95ee",level:4},{value:"2. \u767b\u5f55\u540e\u63d0\u4ea4",id:"2-\u767b\u5f55\u540e\u63d0\u4ea4",level:4},{value:"3. \u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\u7684\u63a5\u53e3",id:"3-\u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\u7684\u63a5\u53e3",level:4},{value:"5. \u4f7f\u7528token\u8bbf\u95ee\u7f51\u5173",id:"5-\u4f7f\u7528token\u8bbf\u95ee\u7f51\u5173",level:3},{value:"1. \u8fc7\u671ftoken",id:"1-\u8fc7\u671ftoken",level:4},{value:"2. \u9519\u8beftoken",id:"2-\u9519\u8beftoken",level:4},{value:"3. \u6743\u9650\u4e0d\u8db3token",id:"3-\u6743\u9650\u4e0d\u8db3token",level:4},{value:"4. \u6b63\u5e38\u8bf7\u6c42",id:"4-\u6b63\u5e38\u8bf7\u6c42",level:4},{value:"\u4e94\u3001\u5199\u5728\u6700\u540e",id:"\u4e94\u5199\u5728\u6700\u540e",level:2},{value:"\u516d\u3001\u9644\u5f55",id:"\u516d\u9644\u5f55",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.ah)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://juejin.cn/post/7271496874942890024",children:"Spring Authorization Server\u5165\u95e8 (\u5341\u516d) Spring Cloud Gateway\u5bf9\u63a5\u8ba4\u8bc1\u670d\u52a1"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u4e00\u524d\u8a00",children:"\u4e00\u3001\u524d\u8a00"}),"\n",(0,t.jsx)(n.p,{children:"\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\u4e4b\u524d\u867d\u7136\u5355\u72ec\u8bb2\u8fc7Security Client\u548cResource Server\u7684\u5bf9\u63a5\uff0c\u4f46\u662f\u90fd\u662f\u57fa\u4e8eSpring webmvc\u7684\uff0cGateway\u8fd9\u79cd\u975e\u963b\u585e\u5f0f\u7684\u7f51\u5173\u662f\u57fa\u4e8ewebflux\u7684\uff0c\u5bf9\u4e8e\u96c6\u6210Security\u76f8\u5173\u5185\u5bb9\u7565\u6709\u4e0d\u540c\uff0c\u4e14\u6d89\u53ca\u5230\u4ee3\u7406\u5176\u5b83\u5fae\u670d\u52a1\uff0c\u6240\u4ee5\u4f1a\u7a0d\u5fae\u6bd4\u8f83\u9ebb\u70e6\u4e9b\uff0c\u4eca\u5929\u5c31\u5e26\u5927\u5bb6\u6765\u5b9e\u73b0Gateway\u7f51\u5173\u5bf9\u63a5OAuth2\u8ba4\u8bc1\u670d\u52a1\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u4e8cgateway\u5bf9\u63a5\u8bf4\u660e",children:"\u4e8c\u3001Gateway\u5bf9\u63a5\u8bf4\u660e"}),"\n",(0,t.jsx)(n.h3,{id:"1-\u8eab\u4efd\u95ee\u9898",children:"1. \u8eab\u4efd\u95ee\u9898"}),"\n",(0,t.jsx)(n.p,{children:"\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\u5728\u672c\u6b21\u793a\u4f8b\u4e2d\u7f51\u5173\u65e2\u662f\u5ba2\u6237\u7aef(OAuth2 Client Server)\u53c8\u662f\u8d44\u6e90\u670d\u52a1(OAuth2 Resource Server)\uff0cClient\u670d\u52a1\u8d1f\u8d23\u8ba4\u8bc1\uff0cResource\u8d1f\u8d23\u9274\u6743\uff0c\u8fd9\u6837\u5982\u679c\u6709\u5728\u6d4f\u89c8\u5668\u76f4\u63a5\u8bbf\u95ee\u7f51\u5173\u7684\u9700\u8981\u53ef\u4ee5\u76f4\u63a5\u5728\u6d4f\u89c8\u5668\u7531\u6846\u67b6\u5f15\u5bfc\u5b8c\u6210OAuth2\u8ba4\u8bc1\u8fc7\u7a0b\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"2-\u6846\u67b6\u7248\u672c\u4e0e\u67b6\u6784\u8bf4\u660e",children:"2. \u6846\u67b6\u7248\u672c\u4e0e\u67b6\u6784\u8bf4\u660e"}),"\n",(0,t.jsx)(n.h4,{id:"1\u67b6\u6784\u56fe",children:"1.\u67b6\u6784\u56fe"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(43803).Z+"",width:"1512",height:"1075"})}),"\n",(0,t.jsx)(n.h4,{id:"2-spring-cloud\u4f9d\u8d56\u7248\u672c",children:"2. Spring Cloud\u4f9d\u8d56\u7248\u672c"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u6846\u67b6"}),(0,t.jsx)(n.th,{children:"\u7248\u672c\u53f7"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Spring Boot"}),(0,t.jsx)(n.td,{children:"3.1.0"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Nacos Server"}),(0,t.jsx)(n.td,{children:"2.2.1"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Spring Cloud"}),(0,t.jsx)(n.td,{children:"2022.0.4"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Spring Cloud Alibaba"}),(0,t.jsx)(n.td,{children:"2022.0.0.0"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Spring Security"}),(0,t.jsx)(n.td,{children:"6.1.0"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Spring OAuth2 Client"}),(0,t.jsx)(n.td,{children:"6.1.0"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Spring OAuth2 Resource Server"}),(0,t.jsx)(n.td,{children:"6.1.0"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"\u8bfb\u8005\u53ef\u4ee5\u81ea\u9009\u7248\u672c\u4f7f\u7528\uff0c\u4f5c\u4e3a\u5bf9\u63a5\u65b9\u7248\u672c\u95ee\u9898\u4e0d\u5927\uff1b\u4e0d\u786e\u5b9aSpring Cloud Alibaba \u5728\u90e8\u7f72\u65f6\u4f1a\u4e0d\u4f1a\u6709Spring Boot\u7684\u7248\u672c\u9650\u5236\uff0c\u5982\u679c3.1.x\u65e0\u6cd5\u4f7f\u7528\u8bf7\u964d\u7ea7\u81f33.0.10\u7248\u672c\uff0c\u5f00\u53d1\u65f6\u6d4b\u8bd5\u90fd\u662f\u6ca1\u95ee\u9898\u7684\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"3-\u7f51\u5173\u96c6\u6210\u8ba4\u8bc1\u670d\u52a1\u8bf7\u6c42\u6d41\u7a0b\u56fe\u8bf4\u660e",children:"3. \u7f51\u5173\u96c6\u6210\u8ba4\u8bc1\u670d\u52a1\u8bf7\u6c42\u6d41\u7a0b\u56fe\u8bf4\u660e"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(28224).Z+"",width:"1184",height:"1612"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u7528\u6237\u8bf7\u6c42\u53d7\u9650\u8d44\u6e90"}),"\n",(0,t.jsxs)(n.li,{children:["\u7f51\u5173\u68c0\u6d4b\u6ca1\u6709\u8ba4\u8bc1\u4fe1\u606f\uff0c\u901a\u8fc7",(0,t.jsx)(n.code,{children:"RedirectServerAuthenticationEntryPoint"}),"\u5904\u7406\u5e76\u53d1\u8d77OAuth2\u767b\u5f55\u6388\u6743\u7533\u8bf7"]}),"\n",(0,t.jsx)(n.li,{children:"\u6388\u6743\u7533\u8bf7\u5230\u8fbe\u8ba4\u8bc1\u670d\u52a1\uff0c\u8ba4\u8bc1\u670d\u52a1\u68c0\u6d4b\u5230\u672a\u767b\u5f55\u91cd\u5b9a\u5411\u81f3\u767b\u5f55\u9875\u9762\u5e76\u5c55\u793a\u7ed9\u7528\u6237"}),"\n",(0,t.jsxs)(n.li,{children:["\u7528\u6237\u767b\u5f55\u6210\u529f\u540e\u8bf7\u6c42\u91cd\u5b9a\u5411\u81f3\u6388\u6743\u7533\u8bf7\u63a5\u53e3\uff0c\u901a\u8fc7\u6821\u9a8c\u540e\u643a\u5e26",(0,t.jsx)(n.code,{children:"Token"}),"\u91cd\u5b9a\u5411\u81f3\u56de\u8c03\u5730\u5740(",(0,t.jsx)(n.code,{children:"redirect_uri"}),")\uff0c\u6ce8\u610f\uff1a\u8fd9\u91cc\u56de\u8c03\u5730\u5740\u8981\u8bbe\u7f6e\u4e3a\u7f51\u5173\u7684\u5730\u5740\uff0c",(0,t.jsx)(n.code,{children:"htttp://{\u7f51\u5173ip}:{\u7f51\u5173port}/login/oauth2/code/{registrationId}"}),"\uff0c\u540e\u8fb9\u7684",(0,t.jsx)(n.code,{children:"/login/oauth2/code/{registrationId}"}),"\u8def\u5f84\u662f\u56fa\u5b9a\u7684\uff0c\u8fd9\u662f\u6846\u67b6(Security OAuth2 Client)\u81ea\u5e26\u7684\u7aef\u70b9"]}),"\n",(0,t.jsxs)(n.li,{children:["\u8bf7\u6c42\u5230\u8fbe\u7f51\u5173\uff0c\u7531",(0,t.jsx)(n.code,{children:"OAuth2LoginAuthenticationWebFilter"}),"\u62e6\u622a\u5e76\u8c03\u7528\u7236\u7c7b",(0,t.jsx)(n.code,{children:"AuthenticationWebFilter"}),"\u7684",(0,t.jsx)(n.code,{children:"filter"}),"\u65b9\u6cd5\u8fdb\u884c\u5904\u7406"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"AuthenticationWebFilter"}),"\u8c03\u7528",(0,t.jsx)(n.code,{children:"OidcAuthorizationCodeReactiveAuthenticationManager"}),"\u6216",(0,t.jsx)(n.code,{children:"OAuth2LoginReactiveAuthenticationManager"}),"\u7c7b\u5904\u7406(\u7531\u6388\u6743\u7533\u8bf7\u7684",(0,t.jsx)(n.code,{children:"scope"}),"\u51b3\u5b9a\uff0c\u5305\u542b",(0,t.jsx)(n.code,{children:"openid"}),"\u5c31\u8d70",(0,t.jsx)(n.code,{children:"OidcAuthorizationCodeReactiveAuthenticationManager"}),"\uff0c\u5426\u5219\u8d70\u53e6\u4e00\u4e2a)"]}),"\n",(0,t.jsxs)(n.li,{children:["\u5728\u83b7\u53d6",(0,t.jsx)(n.code,{children:"AccessToken"}),"\u6210\u529f\u4ee5\u540e\u8c03\u7528",(0,t.jsx)(n.code,{children:"ReactiveOAuth2UserService"}),"\u83b7\u53d6\u7528\u6237\u4fe1\u606f"]}),"\n",(0,t.jsxs)(n.li,{children:["\u83b7\u53d6\u5230\u7528\u6237\u4fe1\u606f\u540e\u4f1a\u89e3\u6790\u5e76\u5c06\u8ba4\u8bc1\u4fe1\u606f\u4fdd\u5b58\u81f3",(0,t.jsx)(n.code,{children:"ReactiveSecurityContextHolder"}),"\u4e2d"]}),"\n",(0,t.jsx)(n.li,{children:"\u5b8c\u6210\u8fd9\u4e00\u7cfb\u5217\u7684\u8ba4\u8bc1\u4e4b\u540e\u4f1a\u91cd\u5b9a\u5411\u81f3\u6700\u4e00\u5f00\u59cb\u8bf7\u6c42\u7684\u53d7\u9650\u8d44\u6e90\uff0c\u8fd9\u65f6\u5019\u5c31\u80fd\u83b7\u53d6\u5230\u8ba4\u8bc1\u4fe1\u606f\u4e86"}),"\n",(0,t.jsxs)(n.li,{children:["\u5982\u679c\u8bbf\u95ee\u7684\u662f\u88ab\u7f51\u5173\u4ee3\u7406\u7684\u670d\u52a1\u5219\u4f1a\u901a\u8fc7\u4ee4\u724c\u4e2d\u7ee7(",(0,t.jsx)(n.code,{children:"TokenRelay"}),")\u643a\u5e26",(0,t.jsx)(n.code,{children:"token"}),"\u8bbf\u95ee"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u5c31\u662f\u7f51\u5173\u901a\u8fc7\u8ba4\u8bc1\u670d\u52a1\u83b7\u53d6\u8ba4\u8bc1\u4fe1\u606f\u7684\u4e00\u4e2a\u6d41\u7a0b\uff0c\u57fa\u672c\u4e0a\u53ea\u9700\u8981\u6dfb\u52a0\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u7531\u6846\u67b6\u5f15\u5bfc\u8fdb\u884cOAuth2\u8ba4\u8bc1\u6d41\u7a0b\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u4e09\u5f00\u59cb\u7f16\u7801",children:"\u4e09\u3001\u5f00\u59cb\u7f16\u7801"}),"\n",(0,t.jsx)(n.h3,{id:"1-\u524d\u7f6e\u6761\u4ef6",children:"1. \u524d\u7f6e\u6761\u4ef6"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u642d\u5efa\u597d\u6807\u51c6OAuth2\u8ba4\u8bc1\u670d\u52a1"}),"\n",(0,t.jsx)(n.li,{children:"\u642d\u5efanacos\u670d\u52a1"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2-\u9879\u76ee\u7ed3\u6784",children:"2. \u9879\u76ee\u7ed3\u6784"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"gateway-example # \u7236\u6a21\u5757\n \u2502  \n \u251c\u2500gateway-client-example # \u7f51\u5173\n \u2502  \n \u251c\u2500normal-resource-example # webmvc\u8d44\u6e90\u670d\u52a1\n \u2502  \n \u251c\u2500webflux-resource-example # webflux\u8d44\u6e90\u670d\u52a1\n \u2502  \n \u2514\u2500pom.xml # \u516c\u5171\u4f9d\u8d56\uff0c\u4f9d\u8d56\u7ba1\u7406\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-\u521b\u5efa\u4e00\u4e2a\u7a7a\u7684maven\u9879\u76ee",children:"3. \u521b\u5efa\u4e00\u4e2a\u7a7a\u7684maven\u9879\u76ee"}),"\n",(0,t.jsx)(n.p,{children:"\u5f15\u5165Spring Boot\u3001Spring Cloud\u3001Spring Cloud Alibaba\uff0c\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>3.1.0</version>\n        <relativePath/> \x3c!-- lookup parent from repository --\x3e\n    </parent>\n    <groupId>com.example</groupId>\n    <artifactId>gateway-example</artifactId>\n    <version>0.0.1</version>\n    <packaging>pom</packaging>\n    <name>gateway-example</name>\n    <description>gateway-example</description>\n    <modules>\n        <module>gateway-client-example</module>\n        <module>normal-resource-example</module>\n        <module>webflux-resource-example</module>\n    </modules>\n\n    <properties>\n        <java.version>17</java.version>\n        \x3c!-- \u4fee\u590d\u6f0f\u6d1e --\x3e\n        <snakeyaml.version>2.0</snakeyaml.version>\n        \x3c!-- Spring Cloud\u7248\u672c\u53f7 --\x3e\n        <spring-cloud.version>2022.0.4</spring-cloud.version>\n        \x3c!-- Spring Cloud Alibaba\u7248\u672c\u53f7 --\x3e\n        <spring-cloud-alibaba.version>2022.0.0.0</spring-cloud-alibaba.version>\n    </properties>\n\n    <dependencies>\n        \x3c!-- Lombok --\x3e\n        <dependency>\n            <groupId>org.projectlombok</groupId>\n            <artifactId>lombok</artifactId>\n            <optional>true</optional>\n        </dependency>\n\n        \x3c!-- Spring Boot \u6d4b\u8bd5\u4f9d\u8d56 --\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        \x3c!-- \u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0 --\x3e\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n        </dependency>\n        \x3c!-- \u914d\u7f6e\u4e2d\u5fc3 --\x3e\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>\n        </dependency>\n\n        \x3c!-- \u8d44\u6e90\u670d\u52a1\u5668starter --\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>\n        </dependency>\n    </dependencies>\n\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-dependencies</artifactId>\n                <version>${spring-cloud.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n            <dependency>\n                <groupId>com.alibaba.cloud</groupId>\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\n                <version>${spring-cloud-alibaba.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n\n</project>\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u91cc\u8fb9\u7684modules\u6807\u7b7e\u662f\u5728\u65b0\u5efamodule\u65f6\u81ea\u52a8\u6dfb\u52a0\u7684"}),"\n",(0,t.jsx)(n.h3,{id:"4-\u521b\u5efa\u7f51\u5173gateway-client-example\u6a21\u5757",children:"4. \u521b\u5efa\u7f51\u5173gateway-client-example\u6a21\u5757"}),"\n",(0,t.jsx)(n.p,{children:"Spring Cloud \u76f8\u5173\u4f9d\u8d56\u5df2\u7ecf\u5728parent\u6a21\u5757\u4e2d\u5f15\u5165\uff0c\u6240\u4ee5\u8be5\u6a21\u5757\u53ea\u9700\u8981\u5f15\u5165Gateway\u3001Client\u4f9d\u8d56\uff0cpom\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>com.example</groupId>\n        <artifactId>gateway-example</artifactId>\n        <version>0.0.1</version>\n    </parent>\n\n    <artifactId>gateway-client-example</artifactId>\n    <name>gateway-client-example</name>\n    <description>gateway-client-example</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-oauth2-client</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-gateway</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>io.projectreactor</groupId>\n            <artifactId>reactor-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n\n        \x3c!-- \u8d1f\u8f7d\u5747\u8861\u4f9d\u8d56 --\x3e\n        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-loadbalancer</artifactId>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n                <configuration>\n                    <excludes>\n                        <exclude>\n                            <groupId>org.projectlombok</groupId>\n                            <artifactId>lombok</artifactId>\n                        </exclude>\n                    </excludes>\n                </configuration>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n'})}),"\n",(0,t.jsx)(n.h4,{id:"1-\u7f16\u5199\u5ba2\u6237\u7aef\u914d\u7f6e",children:"1. \u7f16\u5199\u5ba2\u6237\u7aef\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.example.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper;\nimport org.springframework.security.oauth2.core.user.OAuth2UserAuthority;\n\nimport java.util.Collection;\nimport java.util.HashSet;\nimport java.util.Set;\n\n/**\n * \u5ba2\u6237\u7aef\u914d\u7f6e\n *\n * @author vains\n */\n@Configuration\npublic class ClientServerConfig {\n\n    /**\n     * \u89e3\u6790\u7528\u6237\u6743\u9650\u4fe1\u606f\uff08\u5f53\u5728\u6d4f\u89c8\u5668\u4e2d\u76f4\u63a5\u8bbf\u95ee\u63a5\u53e3\uff0c\u6846\u67b6\u81ea\u52a8\u8c03\u7528OIDC\u6d41\u7a0b\u767b\u5f55\u65f6\u4f1a\u7528\u5230\u8be5\u914d\u7f6e\uff09\n     *\n     * @return GrantedAuthoritiesMapper\n     */\n    @Bean\n    public GrantedAuthoritiesMapper userAuthoritiesMapper() {\n        return (authorities) -> {\n            Set<GrantedAuthority> mappedAuthorities = new HashSet<>();\n\n            authorities.forEach(authority -> {\n                if (authority instanceof OAuth2UserAuthority oAuth2UserAuthority) {\n                    // \u4ece\u8ba4\u8bc1\u670d\u52a1\u83b7\u53d6\u7684\u7528\u6237\u4fe1\u606f\u4e2d\u63d0\u53d6\u6743\u9650\u4fe1\u606f\n                    Object userAuthorities = oAuth2UserAuthority.getAttributes().get("authorities");\n                    if (userAuthorities instanceof Collection<?> collection) {\n                        // \u8f6c\u4e3aSimpleGrantedAuthority\u7684\u5b9e\u4f8b\u5e76\u63d2\u5165mappedAuthorities\u4e2d\n                        collection.stream().filter(a -> a instanceof String)\n                                .map(String::valueOf)\n                                .map(SimpleGrantedAuthority::new)\n                                .forEach(mappedAuthorities::add);\n                    }\n                }\n            });\n\n            return mappedAuthorities;\n        };\n    }\n\n\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u8be5\u914d\u7f6e\u4f1a\u5728\u83b7\u53d6\u5230\u7528\u6237\u4fe1\u606f\u540e\u89e3\u6790\u7528\u6237\u7684\u6743\u9650\u4fe1\u606f\uff0c\u8be6\u89c1",(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/oauth2/login/advanced.html#webflux-oauth2-login-advanced-map-authorities-grantedauthoritiesmapper",children:"\u6587\u6863"})]}),"\n",(0,t.jsx)(n.h4,{id:"2-\u7f16\u5199\u7f51\u5173\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",children:"2. \u7f16\u5199\u7f51\u5173\u8d44\u6e90\u670d\u52a1\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.example.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.convert.converter.Converter;\nimport org.springframework.security.authentication.AbstractAuthenticationToken;\nimport org.springframework.security.config.Customizer;\nimport org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;\nimport org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;\nimport org.springframework.security.config.web.server.ServerHttpSecurity;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtGrantedAuthoritiesConverter;\nimport org.springframework.security.oauth2.server.resource.authentication.ReactiveJwtAuthenticationConverterAdapter;\nimport org.springframework.security.web.server.SecurityWebFilterChain;\nimport reactor.core.publisher.Mono;\n\n/**\n * \u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\n *\n * @author vains\n */\n@Configuration\n@EnableWebFluxSecurity\n@EnableReactiveMethodSecurity\npublic class ResourceServerConfig {\n\n    /**\n     * \u914d\u7f6e\u8ba4\u8bc1\u76f8\u5173\u7684\u8fc7\u6ee4\u5668\u94fe\n     *\n     * @param http Spring Security\u7684\u6838\u5fc3\u914d\u7f6e\u7c7b\n     * @return \u8fc7\u6ee4\u5668\u94fe\n     */\n    @Bean\n    public SecurityWebFilterChain defaultSecurityFilterChain(ServerHttpSecurity http) {\n        // \u7981\u7528csrf\u4e0ecors\n        http.csrf(ServerHttpSecurity.CsrfSpec::disable);\n        http.cors(ServerHttpSecurity.CorsSpec::disable);\n\n        // \u5f00\u542f\u5168\u5c40\u9a8c\u8bc1\n        http.authorizeExchange((authorize) -> authorize\n                //\u5168\u90e8\u9700\u8981\u8ba4\u8bc1\n                .anyExchange().authenticated()\n        );\n\n        // \u5f00\u542fOAuth2\u767b\u5f55\n        http.oauth2Login(Customizer.withDefaults());\n\n        // \u8bbe\u7f6e\u5f53\u524d\u670d\u52a1\u4e3a\u8d44\u6e90\u670d\u52a1\uff0c\u89e3\u6790\u8bf7\u6c42\u5934\u4e2d\u7684token\n        http.oauth2ResourceServer((resourceServer) -> resourceServer\n                        // \u4f7f\u7528jwt\n                        .jwt(jwt -> jwt\n                                // \u8bf7\u6c42\u4e2d\u643a\u5e26token\u8bbf\u95ee\u65f6\u4f1a\u89e6\u53d1\u8be5\u89e3\u6790\u5668\u9002\u914d\u5668\n                                .jwtAuthenticationConverter(grantedAuthoritiesExtractor())\n                        )\n                /*\n                // xhr\u8bf7\u6c42\u672a\u643a\u5e26Token\u5904\u7406\n                .authenticationEntryPoint(this::authenticationEntryPoint)\n                // \u6743\u9650\u4e0d\u8db3\u5904\u7406\n                .accessDeniedHandler(this::accessDeniedHandler)\n                // Token\u89e3\u6790\u5931\u8d25\u5904\u7406\n                .authenticationFailureHandler(this::failureHandler)\n                */\n        );\n\n        return http.build();\n    }\n\n    /**\n     * \u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668\uff0c\u8bbe\u7f6e\u89e3\u6790\u51fa\u6765\u7684\u6743\u9650\u4fe1\u606f\u7684\u524d\u7f00\u4e0e\u5728jwt\u4e2d\u7684key\n     *\n     * @return jwt\u89e3\u6790\u5668\u9002\u914d\u5668 ReactiveJwtAuthenticationConverterAdapter\n     */\n    public Converter<Jwt, Mono<AbstractAuthenticationToken>> grantedAuthoritiesExtractor() {\n        JwtGrantedAuthoritiesConverter grantedAuthoritiesConverter = new JwtGrantedAuthoritiesConverter();\n        // \u8bbe\u7f6e\u89e3\u6790\u6743\u9650\u4fe1\u606f\u7684\u524d\u7f00\uff0c\u8bbe\u7f6e\u4e3a\u7a7a\u662f\u53bb\u6389\u524d\u7f00\n        grantedAuthoritiesConverter.setAuthorityPrefix("");\n        // \u8bbe\u7f6e\u6743\u9650\u4fe1\u606f\u5728jwt claims\u4e2d\u7684key\n        grantedAuthoritiesConverter.setAuthoritiesClaimName("authorities");\n\n        JwtAuthenticationConverter jwtAuthenticationConverter = new JwtAuthenticationConverter();\n        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(grantedAuthoritiesConverter);\n        return new ReactiveJwtAuthenticationConverterAdapter(jwtAuthenticationConverter);\n    }\n\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u9700\u8981\u6ce8\u610f\u7684\u662f\u5f00\u542f\u65b9\u6cd5\u7ea7\u522b\u9274\u6743\u7684\u6ce8\u89e3\u53d8\u4e86\uff0cwebflux\u7684\u6ce8\u89e3\u548cwebmvc\u7684\u6ce8\u89e3\u4e0d\u4e00\u6837\uff0c\u5e76\u4e14\u8fc7\u6ee4\u5668\u94fe\u4e5f\u6362\u6210SecurityWebFilterChain\u4e86\uff1bjwt\u81ea\u5b9a\u4e49\u89e3\u6790\u5668\u7684\u65b9\u5f0f\u4e5f\u4e0d\u4e00\u81f4\uff0c\u5b9e\u73b0\u65b9\u5f0f\u89c1\u4e0a\u65b9\u4ee3\u7801\n\u8bf4\u660e\u6587\u6863\u5982\u4e0b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/authorization/method.html#jc-enable-reactive-method-security",children:"EnableReactiveMethodSecurity\u6ce8\u89e3\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/oauth2/resource-server/jwt.html#webflux-oauth2resourceserver-jwt-authorization-extraction",children:"Jwt\u89e3\u6790\u5668\u9002\u914d\u5668\u8be6\u89c1\u6587\u6863"})}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"3-\u7f16\u5199applicationyml\u6dfb\u52a0nacos\u914d\u7f6e",children:"3. \u7f16\u5199application.yml\uff0c\u6dfb\u52a0nacos\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  cloud:\n    nacos:\n      serverAddr: 127.0.0.1:8848\n  config:\n    import:\n      - nacos:gateway.yml?refresh=true\n  application:\n    name: gateway\n"})}),"\n",(0,t.jsx)(n.h4,{id:"4-\u5728nacos\u4e2d\u521b\u5efagatewayyml\u914d\u7f6e\u6587\u4ef6",children:"4. \u5728nacos\u4e2d\u521b\u5efagateway.yml\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,t.jsx)(n.p,{children:"\u6dfb\u52a0\u5ba2\u6237\u7aef\u4e0e\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\uff0c\u5e76\u6dfb\u52a0\u5176\u5b83\u8d44\u6e90\u670d\u52a1\u7684\u4ee3\u7406\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 7000\nspring:\n  security:\n    oauth2:\n      # \u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\n      resourceserver:\n        jwt:\n          # Jwt\u4e2dclaims\u7684iss\u5c5e\u6027\uff0c\u4e5f\u5c31\u662fjwt\u7684\u7b7e\u53d1\u5730\u5740\uff0c\u5373\u8ba4\u8bc1\u670d\u52a1\u5668\u7684\u6839\u8def\u5f84\n          # \u8d44\u6e90\u670d\u52a1\u5668\u4f1a\u8fdb\u4e00\u6b65\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u8be5\u5730\u5740\u83b7\u53d6\u516c\u94a5\u4ee5\u89e3\u6790jwt\n          issuer-uri: http://192.168.119.1:8080\n      client:\n        provider:\n          # \u8ba4\u8bc1\u63d0\u4f9b\u8005,\u81ea\u5b9a\u4e49\u540d\u79f0\n          custom-issuer:\n            # Token\u7b7e\u53d1\u5730\u5740(\u8ba4\u8bc1\u670d\u52a1\u5730\u5740)\n            issuer-uri: http://192.168.119.1:8080\n            # \u83b7\u53d6\u7528\u6237\u4fe1\u606f\u7684\u5730\u5740\uff0c\u9ed8\u8ba4\u7684/userinfo\u7aef\u70b9\u9700\u8981IdToken\u83b7\u53d6\uff0c\u4e3a\u907f\u514d\u9ebb\u70e6\u81ea\u5b9a\u4e00\u4e2a\u7528\u6237\u4fe1\u606f\u63a5\u53e3\n            user-info-uri: ${spring.security.oauth2.client.provider.custom-issuer.issuer-uri}/user\n            user-name-attribute: name\n        registration:\n          messaging-client-oidc:\n            # oauth\u8ba4\u8bc1\u63d0\u4f9b\u8005\u914d\u7f6e\uff0c\u548c\u4e0a\u8fb9\u914d\u7f6e\u7684\u8ba4\u8bc1\u63d0\u4f9b\u8005\u5173\u8054\u8d77\u6765\n            provider: custom-issuer\n            # \u5ba2\u6237\u7aef\u540d\u79f0\uff0c\u81ea\u5b9a\u4e49\n            client-name: gateway\n            # \u5ba2\u6237\u7aefid\uff0c\u4ece\u8ba4\u8bc1\u670d\u52a1\u7533\u8bf7\u7684\u5ba2\u6237\u7aefid\n            client-id: messaging-client\n            # \u5ba2\u6237\u7aef\u79d8\u94a5\n            client-secret: 123456\n            # \u5ba2\u6237\u7aef\u8ba4\u8bc1\u65b9\u5f0f\n            client-authentication-method: client_secret_basic\n            # \u83b7\u53d6Token\u4f7f\u7528\u7684\u6388\u6743\u6d41\u7a0b\n            authorization-grant-type: authorization_code\n            # \u56de\u8c03\u5730\u5740\uff0c\u8fd9\u91cc\u8bbe\u7f6e\u4e3aSpring Security Client\u9ed8\u8ba4\u5b9e\u73b0\u4f7f\u7528code\u6362\u53d6token\u7684\u63a5\u53e3\uff0c\u5f53\u524d\u670d\u52a1(gateway\u7f51\u5173)\u7684\u5730\u5740\n            redirect-uri: http://127.0.0.1:7000/login/oauth2/code/messaging-client-oidc\n            scope:\n              - message.read\n              - message.write\n              - openid\n              - profile\n\n  cloud:\n    gateway:\n      default-filters:\n        # \u4ee4\u724c\u4e2d\u7ee7\n        - TokenRelay=\n        # \u4ee3\u7406\u8def\u5f84\uff0c\u4ee3\u7406\u81f3\u670d\u52a1\u540e\u4f1a\u53bb\u9664\u7b2c\u4e00\u4e2a\u8def\u5f84\u7684\u5185\u5bb9\n        - StripPrefix=1\n      routes:\n        # \u8d44\u6e90\u670d\u52a1\u4ee3\u7406\u914d\u7f6e\n        - id: resource\n          uri: lb://resource\n          predicates:\n            - Path=/resource/**\n        # \u8d44\u6e90\u670d\u52a1\u4ee3\u7406\u914d\u7f6e\n        - id: webflux\n          uri: lb://webflux-resource\n          predicates:\n            - Path=/webflux/**\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u914d\u7f6e\u6587\u4ef6\u4e2d\u4ee4\u724c\u4e2d\u7ee7(TokenRelay)\u7684\u914d\u7f6e\u5c31\u662f\u6dfb\u52a0\u4e00\u4e2afilter\uff1aTokenRelay=; \u5f53\u7f51\u5173\u5f15\u5165spring-boot-starter-oauth2-client\u4f9d\u8d56\u5e76\u8bbe\u7f6espring.security.oauth2.client.*\u5c5e\u6027\u65f6\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2aTokenRelayGatewayFilterFactory\u8fc7\u6ee4\u5668\uff0c\u5b83\u4f1a\u4ece\u8ba4\u8bc1\u4fe1\u606f\u4e2d\u83b7\u53d6access token\uff0c\u5e76\u653e\u5165\u4e0b\u6e38\u8bf7\u6c42\u7684\u8bf7\u6c42\u5934\u4e2d\u3002 \u8be6\u89c1",(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-tokenrelay-gatewayfilter-factory",children:"Gateway\u5173\u4e8eTokenRelay\u7684\u6587\u6863"})]}),"\n",(0,t.jsx)(n.h4,{id:"5-\u9879\u76ee\u7ed3\u6784",children:"5. \u9879\u76ee\u7ed3\u6784"}),"\n",(0,t.jsx)(n.h3,{id:"5-\u521b\u5efawebmvc\u8d44\u6e90\u670d\u52a1\u6a21\u5757normal-resource-example",children:"5. \u521b\u5efawebmvc\u8d44\u6e90\u670d\u52a1\u6a21\u5757normal-resource-example"}),"\n",(0,t.jsx)(n.h4,{id:"1-\u5728pomxml\u4e2d\u6dfb\u52a0web\u4f9d\u8d56\u5982\u4e0b",children:"1. \u5728pom.xml\u4e2d\u6dfb\u52a0web\u4f9d\u8d56\uff0c\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>com.example</groupId>\n        <artifactId>gateway-example</artifactId>\n        <version>0.0.1</version>\n    </parent>\n\n    <artifactId>normal-resource-example</artifactId>\n    <name>normal-resource-example</name>\n    <description>normal-resource-example</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n                <configuration>\n                    <excludes>\n                        <exclude>\n                            <groupId>org.projectlombok</groupId>\n                            <artifactId>lombok</artifactId>\n                        </exclude>\n                    </excludes>\n                </configuration>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n'})}),"\n",(0,t.jsx)(n.h4,{id:"2-\u521b\u5efa\u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\u6dfb\u52a0\u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668",children:"2. \u521b\u5efa\u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\uff0c\u6dfb\u52a0\u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.example.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtGrantedAuthoritiesConverter;\n\n/**\n * \u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\n *\n * @author vains\n */\n@Configuration\n@EnableWebSecurity\n@EnableMethodSecurity(jsr250Enabled = true, securedEnabled = true)\npublic class ResourceServerConfig {\n\n    /**\n     * \u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668\uff0c\u8bbe\u7f6e\u89e3\u6790\u51fa\u6765\u7684\u6743\u9650\u4fe1\u606f\u7684\u524d\u7f00\u4e0e\u5728jwt\u4e2d\u7684key\n     *\n     * @return jwt\u89e3\u6790\u5668 JwtAuthenticationConverter\n     */\n    @Bean\n    public JwtAuthenticationConverter jwtAuthenticationConverter() {\n        JwtGrantedAuthoritiesConverter grantedAuthoritiesConverter = new JwtGrantedAuthoritiesConverter();\n        // \u8bbe\u7f6e\u89e3\u6790\u6743\u9650\u4fe1\u606f\u7684\u524d\u7f00\uff0c\u8bbe\u7f6e\u4e3a\u7a7a\u662f\u53bb\u6389\u524d\u7f00\n        grantedAuthoritiesConverter.setAuthorityPrefix("");\n        // \u8bbe\u7f6e\u6743\u9650\u4fe1\u606f\u5728jwt claims\u4e2d\u7684key\n        grantedAuthoritiesConverter.setAuthoritiesClaimName("authorities");\n\n        JwtAuthenticationConverter jwtAuthenticationConverter = new JwtAuthenticationConverter();\n        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(grantedAuthoritiesConverter);\n        return jwtAuthenticationConverter;\n    }\n\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"3-\u7f16\u5199applicationyml\u6dfb\u52a0nacos\u914d\u7f6e-1",children:"3. \u7f16\u5199application.yml\u6dfb\u52a0nacos\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  cloud:\n    nacos:\n      serverAddr: 127.0.0.1:8848\n  config:\n    import:\n      - nacos:resource.yml?refresh=true\n  application:\n    name: resource\n"})}),"\n",(0,t.jsx)(n.h4,{id:"4-\u5728nacos\u4e2d\u521b\u5efaresourceyml\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",children:"4. \u5728nacos\u4e2d\u521b\u5efaresource.yml\u914d\u7f6e\u6587\u4ef6\uff0c\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 7100\n\nspring:\n  security:\n    oauth2:\n      # \u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\n      resourceserver:\n        jwt:\n          # Jwt\u4e2dclaims\u7684iss\u5c5e\u6027\uff0c\u4e5f\u5c31\u662fjwt\u7684\u7b7e\u53d1\u5730\u5740\uff0c\u5373\u8ba4\u8bc1\u670d\u52a1\u5668\u7684\u6839\u8def\u5f84\n          # \u8d44\u6e90\u670d\u52a1\u5668\u4f1a\u8fdb\u4e00\u6b65\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u8be5\u5730\u5740\u83b7\u53d6\u516c\u94a5\u4ee5\u89e3\u6790jwt\n          issuer-uri: http://192.168.119.1:8080\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6ce8\u610f\u7aef\u53e3\uff0c\u4e0d\u80fd\u4e0e\u7f51\u5173\u548c\u8ba4\u8bc1\u670d\u52a1\u91cd\u590d"}),"\n",(0,t.jsx)(n.h4,{id:"5-\u6a21\u5757\u7ed3\u6784",children:"5. \u6a21\u5757\u7ed3\u6784"}),"\n",(0,t.jsx)(n.h3,{id:"6-\u521b\u5efawebflux\u8d44\u6e90\u670d\u52a1\u6a21\u5757",children:"6. \u521b\u5efawebflux\u8d44\u6e90\u670d\u52a1\u6a21\u5757"}),"\n",(0,t.jsx)(n.h4,{id:"1-pomxml\u6dfb\u52a0webflux\u4f9d\u8d56\u5982\u4e0b",children:"1. pom.xml\u6dfb\u52a0webflux\u4f9d\u8d56\uff0c\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>com.example</groupId>\n        <artifactId>gateway-example</artifactId>\n        <version>0.0.1</version>\n    </parent>\n\n    <artifactId>webflux-resource-example</artifactId>\n    <name>webflux-resource-example</name>\n    <description>webflux-resource-example</description>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-webflux</artifactId>\n        </dependency>\n    </dependencies>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n                <configuration>\n                    <excludes>\n                        <exclude>\n                            <groupId>org.projectlombok</groupId>\n                            <artifactId>lombok</artifactId>\n                        </exclude>\n                    </excludes>\n                </configuration>\n            </plugin>\n        </plugins>\n    </build>\n</project>\n'})}),"\n",(0,t.jsx)(n.h4,{id:"2-\u521b\u5efa\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\u5e76\u4e14\u6dfb\u52a0jwt\u89e3\u6790\u5668\u9002\u914d\u5668",children:"2. \u521b\u5efa\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\u5e76\u4e14\u6dfb\u52a0jwt\u89e3\u6790\u5668\u9002\u914d\u5668"}),"\n",(0,t.jsx)(n.p,{children:"\u8ddf\u7f51\u5173\u7684\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\u5dee\u4e0d\u591a\uff0c\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.example.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.convert.converter.Converter;\nimport org.springframework.security.authentication.AbstractAuthenticationToken;\nimport org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;\nimport org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;\nimport org.springframework.security.config.web.server.ServerHttpSecurity;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtGrantedAuthoritiesConverter;\nimport org.springframework.security.oauth2.server.resource.authentication.ReactiveJwtAuthenticationConverterAdapter;\nimport org.springframework.security.web.server.SecurityWebFilterChain;\nimport reactor.core.publisher.Mono;\n\n/**\n * \u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\n *\n * @author vains\n */\n@Configuration\n@EnableWebFluxSecurity\n@EnableReactiveMethodSecurity\npublic class ResourceServerConfig {\n\n    /**\n     * \u914d\u7f6e\u8ba4\u8bc1\u76f8\u5173\u7684\u8fc7\u6ee4\u5668\u94fe\n     *\n     * @param http Spring Security\u7684\u6838\u5fc3\u914d\u7f6e\u7c7b\n     * @return \u8fc7\u6ee4\u5668\u94fe\n     */\n    @Bean\n    public SecurityWebFilterChain defaultSecurityFilterChain(ServerHttpSecurity http) {\n        // \u7981\u7528csrf\u4e0ecors\n        http.csrf(ServerHttpSecurity.CsrfSpec::disable);\n        http.cors(ServerHttpSecurity.CorsSpec::disable);\n\n        // \u5f00\u542f\u5168\u5c40\u9a8c\u8bc1\n        http.authorizeExchange((authorize) -> authorize\n                //\u5168\u90e8\u9700\u8981\u8ba4\u8bc1\n                .anyExchange().authenticated()\n        );\n\n        // \u8bbe\u7f6e\u5f53\u524d\u670d\u52a1\u4e3a\u8d44\u6e90\u670d\u52a1\uff0c\u89e3\u6790\u8bf7\u6c42\u5934\u4e2d\u7684token\n        http.oauth2ResourceServer((resourceServer) -> resourceServer\n                // \u4f7f\u7528jwt\n                .jwt(jwtSpec -> jwtSpec\n                        // \u8bbe\u7f6ejwt\u89e3\u6790\u5668\u9002\u914d\u5668\n                        .jwtAuthenticationConverter(grantedAuthoritiesExtractor())\n                )\n        );\n        return http.build();\n    }\n\n    /**\n     * \u81ea\u5b9a\u4e49jwt\u89e3\u6790\u5668\uff0c\u8bbe\u7f6e\u89e3\u6790\u51fa\u6765\u7684\u6743\u9650\u4fe1\u606f\u7684\u524d\u7f00\u4e0e\u5728jwt\u4e2d\u7684key\n     *\n     * @return jwt\u89e3\u6790\u5668\u9002\u914d\u5668 ReactiveJwtAuthenticationConverterAdapter\n     */\n    public Converter<Jwt, Mono<AbstractAuthenticationToken>> grantedAuthoritiesExtractor() {\n        JwtGrantedAuthoritiesConverter grantedAuthoritiesConverter = new JwtGrantedAuthoritiesConverter();\n        // \u8bbe\u7f6e\u89e3\u6790\u6743\u9650\u4fe1\u606f\u7684\u524d\u7f00\uff0c\u8bbe\u7f6e\u4e3a\u7a7a\u662f\u53bb\u6389\u524d\u7f00\n        grantedAuthoritiesConverter.setAuthorityPrefix("");\n        // \u8bbe\u7f6e\u6743\u9650\u4fe1\u606f\u5728jwt claims\u4e2d\u7684key\n        grantedAuthoritiesConverter.setAuthoritiesClaimName("authorities");\n\n        JwtAuthenticationConverter jwtAuthenticationConverter = new JwtAuthenticationConverter();\n        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(grantedAuthoritiesConverter);\n        return new ReactiveJwtAuthenticationConverterAdapter(jwtAuthenticationConverter);\n    }\n\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"3-\u7f16\u5199applicationyml\u6dfb\u52a0nacos\u914d\u7f6e-2",children:"3. \u7f16\u5199application.yml\u6dfb\u52a0nacos\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  cloud:\n    nacos:\n      serverAddr: 127.0.0.1:8848\n  config:\n    import:\n      - nacos:webflux.yml?refresh=true\n  application:\n    name: webflux-resource\n"})}),"\n",(0,t.jsx)(n.h4,{id:"4-nacos\u4e2d\u6dfb\u52a0webfluxyml\u914d\u7f6e\u6587\u4ef6\u5e76\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e",children:"4. nacos\u4e2d\u6dfb\u52a0webflux.yml\u914d\u7f6e\u6587\u4ef6\u5e76\u6dfb\u52a0\u8d44\u6e90\u670d\u52a1\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 7200\n\nspring:\n  security:\n    oauth2:\n      # \u8d44\u6e90\u670d\u52a1\u5668\u914d\u7f6e\n      resourceserver:\n        jwt:\n          # Jwt\u4e2dclaims\u7684iss\u5c5e\u6027\uff0c\u4e5f\u5c31\u662fjwt\u7684\u7b7e\u53d1\u5730\u5740\uff0c\u5373\u8ba4\u8bc1\u670d\u52a1\u5668\u7684\u6839\u8def\u5f84\n          # \u8d44\u6e90\u670d\u52a1\u5668\u4f1a\u8fdb\u4e00\u6b65\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u8be5\u5730\u5740\u83b7\u53d6\u516c\u94a5\u4ee5\u89e3\u6790jwt\n          issuer-uri: http://192.168.119.1:8080\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4e0ewebmvc\u7684\u8d44\u6e90\u670d\u52a1\u7684\u914d\u7f6e\u662f\u4e00\u6837\u7684\uff0c\u6ce8\u610f\u7aef\u53e3\u4e0d\u80fd\u4e0e\u5176\u5b83\u670d\u52a1\u7aef\u53e3\u51b2\u7a81"}),"\n",(0,t.jsx)(n.h4,{id:"5-\u6a21\u5757\u7ed3\u6784-1",children:"5. \u6a21\u5757\u7ed3\u6784"}),"\n",(0,t.jsx)(n.h3,{id:"7-\u5728\u4e09\u4e2a\u6a21\u5757\u4e2d\u6dfb\u52a0\u6d4b\u8bd5\u7c7b\u4e00\u5f0f\u4e09\u4efd",children:"7. \u5728\u4e09\u4e2a\u6a21\u5757\u4e2d\u6dfb\u52a0\u6d4b\u8bd5\u7c7b\uff0c\u4e00\u5f0f\u4e09\u4efd"}),"\n",(0,t.jsx)(n.h4,{id:"1-webmvc\u6d4b\u8bd5\u63a5\u53e3",children:"1. webmvc\u6d4b\u8bd5\u63a5\u53e3"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.example.controller;\n\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n/**\n * \u6d4b\u8bd5\u63a5\u53e3\n *\n * @author vains\n */\n@RestController\npublic class TestController {\n\n    @GetMapping("/test01")\n    @PreAuthorize("hasAnyAuthority(\'message.write\')")\n    public String test01() {\n        return "test01";\n    }\n\n    @GetMapping("/test02")\n    @PreAuthorize("hasAnyAuthority(\'test02\')")\n    public String test02() {\n        return "test02";\n    }\n\n    @GetMapping("/app")\n    @PreAuthorize("hasAnyAuthority(\'app\')")\n    public String app() {\n        return "app";\n    }\n\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"2-webflux\u6d4b\u8bd5\u63a5\u53e3",children:"2. webflux\u6d4b\u8bd5\u63a5\u53e3"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.example.controller;\n\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport reactor.core.publisher.Mono;\n\n/**\n * \u6d4b\u8bd5\u63a5\u53e3\n *\n * @author vains\n */\n@RestController\npublic class TestController {\n\n    @GetMapping("/test01")\n    @PreAuthorize("hasAnyAuthority(\'message.write\')")\n    public Mono<String> test01() {\n        return Mono.just("test01");\n    }\n\n    @GetMapping("/test02")\n    @PreAuthorize("hasAnyAuthority(\'test02\')")\n    public Mono<String> test02() {\n        return Mono.just("test02");\n    }\n\n    @GetMapping("/app")\n    @PreAuthorize("hasAnyAuthority(\'app\')")\n    public Mono<String> app() {\n        return Mono.just("app");\n    }\n\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u56db\u6d4b\u8bd5",children:"\u56db\u3001\u6d4b\u8bd5"}),"\n",(0,t.jsx)(n.h3,{id:"1-\u524d\u7f6e\u6761\u4ef6-1",children:"1. \u524d\u7f6e\u6761\u4ef6"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u542f\u52a8\u8ba4\u8bc1\u670d\u52a1"}),"\n",(0,t.jsx)(n.li,{children:"\u542f\u52a8nacos"}),"\n",(0,t.jsx)(n.li,{children:"nacos\u4e2d\u90fd\u6709\u76f8\u5173\u914d\u7f6e"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2-\u542f\u52a8\u9879\u76ee",children:"2. \u542f\u52a8\u9879\u76ee"}),"\n",(0,t.jsx)(n.p,{children:"\u4f9d\u6b21\u542f\u52a8\u4e09\u4e2a\u670d\u52a1\uff0c\u987a\u5e8f\u65e0\u6240\u8c13"}),"\n",(0,t.jsx)(n.h3,{id:"3-\u5728postman\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3",children:"3. \u5728postman\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(35893).Z+"",width:"1383",height:"786"})}),"\n",(0,t.jsx)(n.p,{children:"\u88ab\u91cd\u5b9a\u5411\u81f3\u767b\u5f55\u4e86\uff0c\u643a\u5e26X-Requested-With\u8bf7\u6c42\u5934\u8bbf\u95ee\uff0c\u4ee3\u8868\u5f53\u524d\u662fxhr\u8bf7\u6c42"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(79459).Z+"",width:"1388",height:"718"})}),"\n",(0,t.jsx)(n.p,{children:"\u54cd\u5e94401\uff0c\u6846\u67b6\u6709\u533a\u5206\u662f\u6d4f\u89c8\u5668\u8bf7\u6c42\u8fd8\u662fxhr\u8bf7\u6c42\uff0c\u5bf9\u4e8e\u6d4f\u89c8\u5668\u8bf7\u6c42\u4f1a\u91cd\u5b9a\u5411\u5230\u9875\u9762\uff0c\u5bf9\u4e8exhr\u8bf7\u6c42\u9ed8\u8ba4\u4f1a\u54cd\u5e94401\u72b6\u6001\u7801\uff0c\u53ef\u81ea\u5df1\u5b9e\u73b0\u5f02\u5e38\u5904\u7406\uff0c\u8fd9\u91cc\u9519\u8bef\u4fe1\u606f\u5728\u8bf7\u6c42\u5934\u4e2d\u662f\u56e0\u4e3a\u6ca1\u6709\u91cd\u5199\u5f02\u5e38\u5904\u7406\uff0c\u7f51\u5173\u8d44\u6e90\u670d\u52a1\u914d\u7f6e\u4ee3\u7801\u4e2d\u6709\u6ce8\u91ca\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"4-\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3",children:"4. \u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u7f51\u5173\u63a5\u53e3\u6216\u4ee3\u7406\u7684\u670d\u52a1\u63a5\u53e3"}),"\n",(0,t.jsx)(n.h4,{id:"1-\u8bbf\u95ee",children:"1. \u8bbf\u95ee"}),"\n",(0,t.jsxs)(n.p,{children:["\u6d4f\u89c8\u5668\u6253\u5f00\u5730\u5740\uff1a",(0,t.jsx)(n.a,{href:"http://127.0.0.1:7000/resource/app",children:"http://127.0.0.1:7000/resource/app"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(69719).Z+"",width:"1512",height:"697"})}),"\n",(0,t.jsx)(n.p,{children:"\u8bf7\u6c42\u5230\u8fbe\u7f51\u5173\u540e\u68c0\u6d4b\u5230\u672a\u767b\u5f55\u4f1a\u5f15\u5bfc\u7528\u6237\u8fdb\u884cOAuth2\u8ba4\u8bc1\u6d41\u7a0b"}),"\n",(0,t.jsx)(n.h4,{id:"2-\u767b\u5f55\u540e\u63d0\u4ea4",children:"2. \u767b\u5f55\u540e\u63d0\u4ea4"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(35908).Z+"",width:"1512",height:"643"})}),"\n",(0,t.jsxs)(n.p,{children:["\u767b\u5f55\u63d0\u4ea4\u540e\u8ba4\u8bc1\u670d\u52a1\u91cd\u5b9a\u5411\u6388\u6743\u7533\u8bf7\u63a5\u53e3\uff0c\u6821\u9a8c\u901a\u8fc7\u540e\u4f1a\u751f\u6210code\u5e76\u643a\u5e26code\u91cd\u5b9a\u5411\u81f3\u56de\u8c03\u5730\u5740\uff0c\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684\u56de\u8c03\u5730\u5740\u662f\u7f51\u5173\u7684\u670d\u52a1\u5730\u5740\uff0c\u7531\u7f51\u5173\u4e2d\u7684",(0,t.jsx)(n.code,{children:"OAuth2 Client"}),"\u5904\u7406\uff0c\u5982\u56fe"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(72583).Z+"",width:"1512",height:"635"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7f51\u5173\u4f1a\u6839\u636ecode\u6362\u53d6token\uff0c\u83b7\u53d6token\u540e\u6839\u636etoken\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff0c\u5e76\u8c03\u7528\u7f51\u5173\u5ba2\u6237\u7aef\u914d\u7f6e\u4e2d\u81ea\u5b9a\u4e49\u7684",(0,t.jsx)(n.code,{children:"userAuthoritiesMapper"}),"\u89e3\u6790\u6743\u9650\u4fe1\u606f\u3002"]}),"\n",(0,t.jsx)(n.h4,{id:"3-\u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\u7684\u63a5\u53e3",children:"3. \u8bbf\u95ee\u6743\u9650\u4e0d\u8db3\u7684\u63a5\u53e3"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(38140).Z+"",width:"1512",height:"787"})}),"\n",(0,t.jsx)(n.p,{children:"\u54cd\u5e94403\uff0c\u5e76\u5c06\u9519\u8bef\u4fe1\u606f\u653e\u5165\u54cd\u5e94\u5934\u4e2d"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"http://127.0.0.1:7000/webmvc/test01\n\nhttp://127.0.0.1:7000/oauth2/authorization/messaging-client-oidc\n\nhttp://192.168.3.49:8080/oauth2/authorize?response_type=code&client_id=messaging-client&scope=message.read%20message.write%20openid%20profile&state=5RTz8WD7oMYLFc5WbACqWveYqmVnhf9KQCxZar5qA1g%3D&redirect_uri=http://127.0.0.1:7000/login/oauth2/code/messaging-client-oidc&nonce=EX6FpWaYeSApRo3jlLdXz6xV9iiNFyzFtDW2VUjfr2I\n\nhttp://192.168.3.49:8080/login\n\nhttp://192.168.3.49:8080/oauth2/authorize?response_type=code&client_id=messaging-client&scope=message.read%20message.write%20openid%20profile&state=5RTz8WD7oMYLFc5WbACqWveYqmVnhf9KQCxZar5qA1g%3D&redirect_uri=http://127.0.0.1:7000/login/oauth2/code/messaging-client-oidc&nonce=EX6FpWaYeSApRo3jlLdXz6xV9iiNFyzFtDW2VUjfr2I&continue\n\nhttp://192.168.3.49:8080/oauth2/consent?scope=openid%20profile%20message.read%20message.write&client_id=messaging-client&state=kCmXmm7B6Yf0e5EHV3bfcb8PxC0uPTVkrbl3gGeII-Q%3D\n\nhttp://192.168.3.49:8080/oauth2/authorize\n\nhttp://127.0.0.1:7000/login/oauth2/code/messaging-client-oidc?code=lJ59pJPQsVb5deKNwQiOvIWTxNH0aMGGfdwq6i4X1e0lDioUdR5ZLk4LD87yUpsiE6QCM0cZhnfbC2SWj6JTbtCQ9E-ib4pAY5n5oztvcP2Z0U1aJGLX75fOaNLcL0wx&state=5RTz8WD7oMYLFc5WbACqWveYqmVnhf9KQCxZar5qA1g%3D\n\nhttp://127.0.0.1:7000/webmvc/test01\n"})}),"\n",(0,t.jsx)(n.h3,{id:"5-\u4f7f\u7528token\u8bbf\u95ee\u7f51\u5173",children:"5. \u4f7f\u7528token\u8bbf\u95ee\u7f51\u5173"}),"\n",(0,t.jsx)(n.h4,{id:"1-\u8fc7\u671ftoken",children:"1. \u8fc7\u671ftoken"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(8785).Z+"",width:"1386",height:"638"})}),"\n",(0,t.jsx)(n.p,{children:"\u54cd\u5e94401\u5e76\u5728\u54cd\u5e94\u5934\u4e2d\u63d0\u793atoken\u5df2\u8fc7\u671f"}),"\n",(0,t.jsx)(n.h4,{id:"2-\u9519\u8beftoken",children:"2. \u9519\u8beftoken"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(79739).Z+"",width:"1386",height:"640"})}),"\n",(0,t.jsx)(n.p,{children:"\u54cd\u5e94401\u5e76\u5728\u54cd\u5e94\u5934\u4e2d\u63d0\u793atoken\u65e0\u6cd5\u89e3\u6790"}),"\n",(0,t.jsx)(n.h4,{id:"3-\u6743\u9650\u4e0d\u8db3token",children:"3. \u6743\u9650\u4e0d\u8db3token"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(13813).Z+"",width:"1389",height:"644"})}),"\n",(0,t.jsx)(n.p,{children:"\u54cd\u5e94403\u5e76\u63d0\u793a\u6743\u9650\u4e0d\u8db3"}),"\n",(0,t.jsx)(n.h4,{id:"4-\u6b63\u5e38\u8bf7\u6c42",children:"4. \u6b63\u5e38\u8bf7\u6c42"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:r(14264).Z+"",width:"1381",height:"574"})}),"\n",(0,t.jsx)(n.p,{children:"\u54cd\u5e94200\u5e76\u6b63\u786e\u54cd\u5e94\u63a5\u53e3\u4fe1\u606f"}),"\n",(0,t.jsx)(n.h2,{id:"\u4e94\u5199\u5728\u6700\u540e",children:"\u4e94\u3001\u5199\u5728\u6700\u540e"}),"\n",(0,t.jsx)(n.p,{children:"\u672c\u6587\u5e26\u5927\u5bb6\u7b80\u5355\u5b9e\u73b0\u4e86Spring Cloud Gateway\u5bf9\u63a5\u8ba4\u8bc1\u670d\u52a1\uff0cGateway\u4e2d\u6dfb\u52a0\u5ba2\u6237\u7aef\u4e3b\u8981\u662f\u4e3a\u4e86\u5982\u679c\u4ee3\u7406\u670d\u52a1\u6709\u9759\u6001\u8d44\u6e90(html\u3001css\u3001image)\u65f6\u53ef\u4ee5\u76f4\u63a5\u53d1\u8d77OAuth2\u6388\u6743\u6d41\u7a0b\uff0c\u5728\u6d4f\u89c8\u5668\u767b\u5f55\u540e\u76f4\u63a5\u8bbf\u95ee\uff0c\u540c\u65f6\u4e5f\u662f\u5f00\u542f\u4ee4\u724c\u4e2d\u7ee7\u7684\u5fc5\u8981\u4f9d\u8d56\uff1b\u5f15\u5165Resource Server\u4f9d\u8d56\u662f\u5f53\u9700\u8981\u5bf9\u7f51\u5173\u7684\u63a5\u53e3\u9274\u6743\u65f6\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u5982\u679c\u7f51\u5173\u53ea\u8d1f\u8d23\u8f6c\u53d1\u5e94\u8be5\u662f\u53ef\u4ee5\u53bb\u6389\u8d44\u6e90\u670d\u52a1\u76f8\u5173\u4f9d\u8d56\u548c\u914d\u7f6e\u7684\uff0c\u7531\u5404\u4e2a\u88ab\u4ee3\u7406\u7684\u5fae\u670d\u52a1\u5bf9\u81ea\u5df1\u7684\u63a5\u53e3\u8fdb\u884c\u9274\u6743\u3002\u8fd9\u4e9b\u4e1c\u897f\u5728\u4e4b\u524d\u57fa\u672c\u90fd\u662f\u8bb2\u8fc7\u7684\u5185\u5bb9\uff0c\u6240\u4ee5\u672c\u6587\u5f88\u591a\u5730\u65b9\u90fd\u662f\u4e00\u7b14\u5e26\u8fc7\u7684\uff0c\u5982\u679c\u67d0\u4e9b\u5730\u65b9\u4e0d\u6e05\u695a\u53ef\u4ee5\u9488\u5bf9\u6027\u7684\u7ffb\u7ffb\u4e4b\u524d\u7684\u6587\u7ae0\uff0c\u4e5f\u53ef\u4ee5\u5728\u8bc4\u8bba\u533a\u4e2d\u63d0\u51fa\u3002 \u5982\u679c\u6709\u4ec0\u4e48\u95ee\u9898\u6216\u8005\u9700\u8981\u8865\u5145\u7684\u8bf7\u5728\u8bc4\u8bba\u533a\u6307\u51fa\uff0c\u8c22\u8c22\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u516d\u9644\u5f55",children:"\u516d\u3001\u9644\u5f55"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://gitee.com/vains-Sofia/authorization-example",children:"Gitee\u4ed3\u5e93\u5730\u5740"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-tokenrelay-gatewayfilter-factory",children:"Gateway\u4ee4\u724c\u4e2d\u7ee7\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/oauth2/login/advanced.html#webflux-oauth2-login-advanced-map-authorities-grantedauthoritiesmapper",children:"OAuth2\u767b\u5f55\u540e\u7528\u6237\u6743\u9650\u89e3\u6790\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/authorization/method.html#jc-enable-reactive-method-security",children:"webflux\u5f00\u542f\u65b9\u6cd5\u9274\u6743EnableReactiveMethodSecurity\u6ce8\u89e3\u8bf4\u660e\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/oauth2/resource-server/jwt.html#webflux-oauth2resourceserver-jwt-authorization-extraction",children:"webflux\u7684Jwt\u89e3\u6790\u5668\u9002\u914d\u5668\u8bf4\u660e\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/oauth2/login/core.html",children:"webflux\u5bf9\u63a5OAuth2 Client\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/reactive/oauth2/resource-server/jwt.html",children:"webflux\u5bf9\u63a5OAuth2 Resource Server\u6587\u6863"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.ah)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},43803:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-1-8f494f66138231263ba811de56bb736a.awebp"},79739:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-10-e6894a299326559b839a38dafa0dd104.awebp"},13813:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-11-46efc9e1702599488a99d9ed1f226f45.awebp"},14264:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-12-92476f5f784c4ea0d26a453bb4906f59.awebp"},28224:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-2-c56cb86c439f678490d5f50158190833.awebp"},35893:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-3-ed298ef0efc32aac6a9e7b996223f56a.awebp"},79459:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-4-42ff9b6c62761b091947fbceef852a75.awebp"},69719:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-5-0a6038363ca14772b7a5b7d64cd2539a.awebp"},35908:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-6-63163243f7cde33b0a1d71c59d7872b1.awebp"},72583:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-7-1b657883b7e027ac4bc922503f836506.awebp"},38140:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-8-6645253699be32721a4a5ec951ad6168.awebp"},8785:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/16-9-ebab68e4b3e15827262369ad497a60db.awebp"},11151:(e,n,r)=>{r.d(n,{ah:()=>o});var t=r(67294);const i=t.createContext({});function o(e){const n=t.useContext(i);return t.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);