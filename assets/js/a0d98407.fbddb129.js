"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[22594],{63980:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>a});var r=t(74848),s=t(28453);const o={},i=void 0,c={id:"zh-cn/spring-authorization-server/SAS-Opaque-Token",title:"SAS-Opaque-Token",description:"- spring-security-oauth2-authorization-server\uff08\u4e00\uff09SpringBoot3.1.3\u6574\u5408",source:"@site/docs/zh-cn/spring-authorization-server/52-SAS-Opaque-Token.md",sourceDirName:"zh-cn/spring-authorization-server",slug:"/zh-cn/spring-authorization-server/SAS-Opaque-Token",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Opaque-Token",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-authorization-server/52-SAS-Opaque-Token.md",tags:[],version:"current",sidebarPosition:52,frontMatter:{},sidebar:"troch",previous:{title:"SAS-Getting-Start",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Getting-Start"},next:{title:"Wecom-Login",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/Wecom-Login"}},d={},a=[{value:"\u5199\u5728\u524d\u9762\u7684\u8bdd",id:"\u5199\u5728\u524d\u9762\u7684\u8bdd",level:2},{value:"Token\u7684\u751f\u6210\u7684\u5b98\u65b9\u63cf\u8ff0",id:"token\u7684\u751f\u6210\u7684\u5b98\u65b9\u63cf\u8ff0",level:2},{value:"1. <code>JWT Token</code>\uff08\u900f\u660e<code>Token</code>\uff09",id:"1-jwt-token\u900f\u660etoken",level:2},{value:"2. <code>Opaque Token</code>\uff08\u4e0d\u900f\u660e<code>Token</code>\uff09",id:"2-opaque-token\u4e0d\u900f\u660etoken",level:2},{value:"2.1 \u9ed8\u8ba4128\u4f4d\u5b57\u7b26\u7684<code>Opaque Token</code>",id:"21-\u9ed8\u8ba4128\u4f4d\u5b57\u7b26\u7684opaque-token",level:3},{value:"2.2 \u81ea\u5b9a\u4e49<code>Token</code>\u751f\u6210\u5668\uff0c\u751f\u6210\u4e00\u4e2a<code>UUID</code>\u7c7b\u578b\u7684<code>OpaqueToken</code>",id:"22-\u81ea\u5b9a\u4e49token\u751f\u6210\u5668\u751f\u6210\u4e00\u4e2auuid\u7c7b\u578b\u7684opaquetoken",level:3},{value:"\u9057\u7559\u601d\u8003\u7684\u95ee\u9898\uff1a",id:"\u9057\u7559\u601d\u8003\u7684\u95ee\u9898",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://blog.csdn.net/weixin_42229668/article/details/132912917",children:"spring-security-oauth2-authorization-server\uff08\u4e00\uff09SpringBoot3.1.3\u6574\u5408"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://blog.csdn.net/weixin_42229668/article/details/132925597",children:"spring-security-oauth2-authorization-server\uff08\u4e8c\uff09Token\u751f\u6210\u5206\u6790\u4e4bJWT Token\u548cOpaque Token"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5199\u5728\u524d\u9762\u7684\u8bdd",children:"\u5199\u5728\u524d\u9762\u7684\u8bdd"}),"\n",(0,r.jsxs)(n.p,{children:["\u56e0\u4e3a ",(0,r.jsx)(n.code,{children:"Spring Boot 3.x"})," \u662f\u76ee\u524d\u6700\u65b0\u7684\u7248\u672c\uff0c\u6574\u5408",(0,r.jsx)(n.code,{children:"spring-security-oauth2-authorization-server"}),"\u7684\u8d44\u6599\u5f88\u5c11\uff0c\u6240\u4ee5\u4ea7\u751f\u4e86\u8fd9\u7bc7\u6587\u7ae0\uff0c\u4e3b\u8981\u4e3a\u60f3\u5c1d\u8bd5",(0,r.jsx)(n.code,{children:"Spring Boot"}),"\u9ad8\u7248\u672c\uff0c\u60f3\u6574\u5408\u6700\u65b0\u7684",(0,r.jsx)(n.code,{children:"spring-security-oauth2-authorization-server"}),"\u7684\u521d\u5b66\u8005\uff0c\u65e8\u5728\u4e3a\u5927\u5bb6\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u4e0a\u624b\u7684\u53c2\u8003\uff0c\u5982\u679c\u54ea\u91cc\u5199\u5f97\u4e0d\u5bf9\u6216\u53ef\u4ee5\u4f18\u5316\u7684\u8fd8\u8bf7\u5927\u5bb6\u8e0a\u8dc3\u8bc4\u8bba\u6307\u6b63\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u524d\u9762\u4e00\u7bc7\u6587\u7ae0",(0,r.jsx)(n.a,{href:"https://blog.csdn.net/weixin_42229668/article/details/132912917",children:"\u300aspring-security-oauth2-authorization-server\uff08\u4e00\uff09SpringBoot3.1.3\u6574\u5408\u300b"}),"\u4e3b\u8981\u4ecb\u7ecd\u4e86\u5982\u4f55\u7b80\u5355\u642d\u5efa\u4e00\u4e2a\u8ba4\u8bc1\u670d\u52a1\u5668\uff0c\u8fd9\u4e00\u7bc7\u7b97\u756a\u5916\u7bc7\u4e3b\u8981\u7ed3\u5408\u5b98\u7f51\u7684\u63cf\u8ff0\u7b80\u5355\u5206\u6790\u4e00\u4e0b",(0,r.jsx)(n.code,{children:"Token"}),"\u7684\u51e0\u79cd\u751f\u6210\u7b56\u7565\uff0c\u4ee5\u53ca\u5982\u4f55\u81ea\u5b9a\u4e49",(0,r.jsx)(n.code,{children:"Token"}),"\u751f\u6210\u5668\u6765\u751f\u6210\u6211\u4eec\u5728",(0,r.jsx)(n.code,{children:"OAuth2.0"}),"\u4e2d\u5e38\u89c1\u7684\u5f62\u5982\u8fd9\u6837\uff1a",(0,r.jsx)(n.code,{children:"Bearer 237d224d-1bdc-4d48-855a-f6abb37e378f"}),"\u7684\u4e0d\u900f\u660e",(0,r.jsx)(n.code,{children:"OpaqueToken"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u6574\u4e2a\u9879\u76ee\u7684\u914d\u7f6e\u8fd8\u662f\u590d\u7528\u7684\u4e0a\u4e00\u7bc7\u3002"})}),"\n",(0,r.jsx)(n.h2,{id:"token\u7684\u751f\u6210\u7684\u5b98\u65b9\u63cf\u8ff0",children:"Token\u7684\u751f\u6210\u7684\u5b98\u65b9\u63cf\u8ff0"}),"\n",(0,r.jsx)(n.p,{children:"\u53d6\u81ea\u5b98\u65b9\u6587\u6863\uff1a"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"OAuth2TokenGenerator"}),"\u8d1f\u8d23\u4ece\u6240\u63d0\u4f9b\u7684",(0,r.jsx)(n.code,{children:"OAuth2TokenContext"}),"\u4e2d\u7684\u4fe1\u606f\u751f\u6210 ",(0,r.jsx)(n.code,{children:"OAuth2Token"}),"\uff0c\u751f\u6210\u7684 ",(0,r.jsx)(n.code,{children:"OAuth2Token"})," \u4e3b\u8981\u53d6\u51b3\u4e8e\u5728 ",(0,r.jsx)(n.code,{children:"OAuth2TokenContext"})," \u4e2d\u6307\u5b9a\u7684 ",(0,r.jsx)(n.code,{children:"OAuth2TokenType"}),"\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53 ",(0,r.jsx)(n.code,{children:"OAuth2TokenType"})," \u7684 ",(0,r.jsx)(n.code,{children:"value"})," \u4e3a\uff1a"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"code"}),"\uff0c\u5219\u751f\u6210 ",(0,r.jsx)(n.code,{children:"OAuth2AuthorizationCode"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"access_token"}),"\uff0c\u5219\u751f\u6210 ",(0,r.jsx)(n.code,{children:"OAuth2AccessToken"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"refresh_token"}),"\uff0c\u5219\u751f\u6210 ",(0,r.jsx)(n.code,{children:"OAuth2RefreshToken"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id_token"}),"\uff0c\u5219\u751f\u6210 ",(0,r.jsx)(n.code,{children:"OidcIdToken"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6240\u4ee5\u6211\u4eec\u7528\u5230\u7684\u6388\u6743\u7801\uff0c",(0,r.jsx)(n.code,{children:"access-token"}),"\uff0c",(0,r.jsx)(n.code,{children:"refresh-token"}),"\uff0c\u8bbe\u5907\u7801\u7b49\u90fd\u662f\u7531",(0,r.jsx)(n.code,{children:"OAuth2TokenGenerator"}),"\u7684\u5b50\u7c7b\u5b9e\u73b0\u7684\u3002"]}),"\n",(0,r.jsxs)(n.h2,{id:"1-jwt-token\u900f\u660etoken",children:["1. ",(0,r.jsx)(n.code,{children:"JWT Token"}),"\uff08\u900f\u660e",(0,r.jsx)(n.code,{children:"Token"}),"\uff09"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"spring-security-oauth2-authorization-server"}),"\u9ed8\u8ba4\u751f\u6210\u7684",(0,r.jsx)(n.code,{children:"Token"}),"\u662f",(0,r.jsx)(n.code,{children:"JWT"}),"\u7c7b\u578b\u7684\uff0c\u751f\u6210\u7684 ",(0,r.jsx)(n.code,{children:"OAuth2AccessToken"})," \u7684\u683c\u5f0f\u662f\u4e0d\u540c\u7684\uff0c\u53d6\u51b3\u4e8e\u4e3a ",(0,r.jsx)(n.code,{children:"RegisteredClient"})," \u914d\u7f6e\u7684 ",(0,r.jsx)(n.code,{children:"TokenSettings.getAccessTokenFormat()"}),"\u3002\u5982\u679c\u683c\u5f0f\u662f ",(0,r.jsx)(n.code,{children:"OAuth2TokenFormat.SELF_CONTAINED"}),"\uff08\u9ed8\u8ba4\uff09\uff0c\u90a3\u4e48\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"JWT"}),"\u3002\u5982\u679c\u683c\u5f0f\u662f ",(0,r.jsx)(n.code,{children:"OAuth2TokenFormat.REFERENCE"}),"\uff0c\u90a3\u4e48\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"opaque"}),"\u4e0d\u900f\u660e",(0,r.jsx)(n.code,{children:"Token"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u5b98\u7f51\u4e0a\u8fd8\u6709\u8fd9\u4e48\u4e00\u53e5\u8bdd\uff1a"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"OAuth2TokenGenerator"})," \u662f\u4e00\u4e2a\u53ef\u9009\u7684\u7ec4\u4ef6\uff0c\u9ed8\u8ba4\u4e3a\u7531 ",(0,r.jsx)(n.code,{children:"OAuth2AccessTokenGenerator"})," \u548c ",(0,r.jsx)(n.code,{children:"OAuth2RefreshTokenGenerator"})," \u7ec4\u6210\u7684 ",(0,r.jsx)(n.code,{children:"DelegatingOAuth2TokenGenerator"}),"\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u6ce8\u518c\u4e86 ",(0,r.jsx)(n.code,{children:"JwtEncoder"})," ",(0,r.jsx)(n.code,{children:"@Bean"})," \u6216 ",(0,r.jsx)(n.code,{children:"JWKSource"})," ",(0,r.jsx)(n.code,{children:"@Bean"}),"\uff0c\u90a3\u4e48\u5728 ",(0,r.jsx)(n.code,{children:"DelegatingOAuth2TokenGenerator"})," \u4e2d\u8fd8\u4f1a\u989d\u5916\u7ec4\u6210\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"JwtGenerator"}),"\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u4ee5\u5728\u6e90\u7801\u627e\u5230\u51fa\u5904\u3002\n",(0,r.jsx)(n.code,{children:"DelegatingOAuth2TokenGenerator"}),"\u5b9e\u4f8b\u5316\u7684\u65f6\u5019\u5c06",(0,r.jsx)(n.code,{children:"tokenGenerators"}),"\u585e\u8fdb\u53bb\u7684\uff0c\u90a3\u4e48\u518d\u5f80\u4e0a\u627e\u4f55\u5904\u5b9e\u4f8b\u5316\u7684"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(38036).A+"",width:"1717",height:"856"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(59503).A+"",width:"1772",height:"829"})}),"\n",(0,r.jsxs)(n.p,{children:["\u56e0\u4e3a\u6211\u4eec\u6ce8\u518c\u4e86\u76f8\u5e94\u7684",(0,r.jsx)(n.code,{children:"JWKSource"}),"\u3001",(0,r.jsx)(n.code,{children:"JwtEncoder"}),"\u7684",(0,r.jsx)(n.code,{children:"Bean"}),"\uff0c\u6240\u4ee5Token\u7684\u751f\u6210\u4f1a\u5b9e\u73b0\u5728",(0,r.jsx)(n.code,{children:"JwtGenerator"}),"\u4e0a\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u6211\u4eec\u4e0d\u6ce8\u518c",(0,r.jsx)(n.code,{children:"JWT"}),"\u76f8\u5173\u7684",(0,r.jsx)(n.code,{children:"Bean"}),"\u5c31\u662f\u5c06\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\u7684",(0,r.jsx)(n.code,{children:"3.3.5"}),"\u8282\u7684",(0,r.jsx)(n.code,{children:"JWT"}),"\u76f8\u5173",(0,r.jsx)(n.code,{children:"Bean"}),"\u5168\u90e8\u53bb\u6389\uff0cdebug\u4f1a\u53d1\u73b0\u8fd8\u662f\u9ed8\u8ba4\u52a0\u8fdb\u6765\u4e86",(0,r.jsx)(n.code,{children:"JwtGenerator"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(77958).A+"",width:"1824",height:"749"})}),"\n",(0,r.jsxs)(n.p,{children:["\u539f\u56e0\u5e94\u8be5\u662f\u5728\u6211\u4eec\u5728\u6ce8\u518c",(0,r.jsx)(n.code,{children:"RegisteredClientRepository"})," ",(0,r.jsx)(n.code,{children:"Bean"}),"\u65f6\u9ed8\u8ba4\u4e3a\u6211\u4eec\u6307\u5b9a\u4e86",(0,r.jsx)(n.code,{children:"tokenSettings"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(80377).A+"",width:"1717",height:"852"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6240\u4ee5",(0,r.jsx)(n.code,{children:"oauth2_registered_client"}),"\u8868\u7684",(0,r.jsx)(n.code,{children:"token_settings"}),"\u4e5f\u4f1a\u770b\u5230",(0,r.jsx)(n.code,{children:"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat"}),"\u7c7b\u578b\u4e3a",(0,r.jsx)(n.code,{children:"self-contained"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(74128).A+"",width:"931",height:"624"})}),"\n",(0,r.jsxs)(n.h2,{id:"2-opaque-token\u4e0d\u900f\u660etoken",children:["2. ",(0,r.jsx)(n.code,{children:"Opaque Token"}),"\uff08\u4e0d\u900f\u660e",(0,r.jsx)(n.code,{children:"Token"}),"\uff09"]}),"\n",(0,r.jsxs)(n.h3,{id:"21-\u9ed8\u8ba4128\u4f4d\u5b57\u7b26\u7684opaque-token",children:["2.1 \u9ed8\u8ba4128\u4f4d\u5b57\u7b26\u7684",(0,r.jsx)(n.code,{children:"Opaque Token"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u65e2\u7136\u5b98\u7f51\u90fd\u544a\u8bc9\u6211\u4eec",(0,r.jsx)(n.code,{children:"Token"}),"\u7684\u5f62\u5f0f\u662f\u53d6\u51b3\u4e8e\u4e3a ",(0,r.jsx)(n.code,{children:"RegisteredClient"})," \u914d\u7f6e\u7684 ",(0,r.jsx)(n.code,{children:"TokenSettings.getAccessTokenFormat()"}),"\uff0c\u90a3\u6211\u4eec\u6539\u6210",(0,r.jsx)(n.code,{children:"OAuth2TokenFormat.REFERENCE"})," \u5c31\u597d\u4e86\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u5148\u628a\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d3.3.5\u8282\u4e0eJWT\u76f8\u5173\u7684Bean\u5220\u6389"}),"\uff0c\u800c\u540e\u6dfb\u52a0\u5982\u4e0b\u4ee3\u7801"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:".tokenSettings(TokenSettings.builder()\n    .accessTokenFormat(OAuth2TokenFormat.REFERENCE)\n    .build())\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Bean\npublic RegisteredClientRepository registeredClientRepository(JdbcTemplate jdbcTemplate, PasswordEncoder passwordEncoder) {\n    RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())\n            .clientId("oauth2-client")\n            .clientSecret(passwordEncoder.encode("123456"))\n            // \u5ba2\u6237\u7aef\u8ba4\u8bc1\u57fa\u4e8e\u8bf7\u6c42\u5934\n            .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)\n            // \u914d\u7f6e\u6388\u6743\u7684\u652f\u6301\u65b9\u5f0f\n            .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)\n            .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)\n            .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)\n            .redirectUri("https://www.baidu.com")\n            .scope("user")\n            .scope("admin")\n            // \u5ba2\u6237\u7aef\u8bbe\u7f6e\uff0c\u8bbe\u7f6e\u7528\u6237\u9700\u8981\u786e\u8ba4\u6388\u6743\n            .clientSettings(ClientSettings.builder().requireAuthorizationConsent(true).build())\n            // \u6dfb\u52a0tokenSettings\uff0c\u5c06accessTokenFormat\u6539\u4e3aREFERENCE\u5373\u53ef\u83b7\u53d6Opaque Token\n            .tokenSettings(TokenSettings.builder().accessTokenFormat(OAuth2TokenFormat.REFERENCE).build())\n            .build();\n    JdbcRegisteredClientRepository registeredClientRepository = new JdbcRegisteredClientRepository(jdbcTemplate);\n    RegisteredClient repositoryByClientId = registeredClientRepository.findByClientId(registeredClient.getClientId());\n    if (repositoryByClientId == null) {\n        registeredClientRepository.save(registeredClient);\n    }\n    return registeredClientRepository;\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(87947).A+"",width:"2704",height:"1488"})}),"\n",(0,r.jsxs)(n.p,{children:["\u751f\u6210",(0,r.jsx)(n.code,{children:"Token"}),"\u7684\u5168\u7c7b\u540d\u5982\u4e0b\uff1a\n",(0,r.jsx)(n.code,{children:"org.springframework.security.oauth2.server.authorization.token.OAuth2AccessTokenGenerator#generate"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(97442).A+"",width:"3268",height:"1458"})}),"\n",(0,r.jsxs)(n.p,{children:["\u9ed8\u8ba4\u662f",(0,r.jsx)(n.code,{children:"Base64"}),"\u5c06\u4e00\u4e2a96\u4f4d\u957f\u5ea6\u7684\u968f\u673a\u4e32\u7f16\u7801\u540e\u751f\u6210\u7684128\u4f4d\u5b57\u7b26\u4e32"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(18821).A+"",width:"3298",height:"1150"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u4eec\u53d1\u73b0\u6b64\u65f6\u7684",(0,r.jsx)(n.code,{children:"Token"}),"\u662f\u4e00\u4e2a\u6781\u957f\u7684\u5b57\u7b26\u4e32\uff0c\u4e0e\u6211\u4eec\u5728",(0,r.jsx)(n.code,{children:"OAuth2.0"}),"\u751f\u6210",(0,r.jsx)(n.code,{children:"Bearer 237d224d-1bdc-4d48-855a-f6abb37e378f"}),"\u76f8\u5dee\u751a\u8fdc\u3002\n\u6211\u4eec\u53c8\u53d1\u73b0",(0,r.jsx)(n.code,{children:"accessTokenGenerator"}),"\u7684\u8bbe\u7f6e\u662f\u5199\u6b7b\u7684\uff0c\u6ca1\u6709\u63d0\u4f9b\u4e00\u4e2a\u65b9\u6cd5\u8ba9\u6211\u4eec\u91cd\u65b0\u8bbe\u7f6e\uff0c\u90a3\u4e48\u53ea\u80fd\u91cd\u5199\u4e00\u4e2a\u5b9e\u73b0\u3002"]}),"\n",(0,r.jsxs)(n.h3,{id:"22-\u81ea\u5b9a\u4e49token\u751f\u6210\u5668\u751f\u6210\u4e00\u4e2auuid\u7c7b\u578b\u7684opaquetoken",children:["2.2 \u81ea\u5b9a\u4e49",(0,r.jsx)(n.code,{children:"Token"}),"\u751f\u6210\u5668\uff0c\u751f\u6210\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"UUID"}),"\u7c7b\u578b\u7684",(0,r.jsx)(n.code,{children:"OpaqueToken"})]}),"\n",(0,r.jsx)(n.p,{children:"\u5b98\u65b9\u6587\u6863\u8bf4\uff1a"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"OAuth2TokenGenerator"})," \u63d0\u4f9b\u4e86\u6781\u5927\u7684\u7075\u6d3b\u6027\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u4e3a ",(0,r.jsx)(n.code,{children:"access_token"})," \u548c ",(0,r.jsx)(n.code,{children:"refresh_token"})," \u652f\u6301\u4efb\u4f55\u81ea\u5b9a\u4e49\u7684 ",(0,r.jsx)(n.code,{children:"token"})," \u683c\u5f0f\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u90a3\u6211\u4eec\u5c31\u81ea\u5b9a\u4e49\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"UUIDOAuth2TokenGenerator"}),"\uff0c\u7528",(0,r.jsx)(n.code,{children:"UUID"}),"\u751f\u6210\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"OpaqueToken"}),"\u3002\u5728\u6b64\u4e4b\u524d\u9700\u8981\u5148\u5b9a\u4e49\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"StringKeyGenerator"}),"\u7684\u5b9e\u73b0\uff0c\u56e0\u4e3aToken\u751f\u6210\u5668\u9700\u8981\u7528\u5230",(0,r.jsx)(n.code,{children:"this.accessTokenGenerator.generateKey()"}),"\u6765\u751f\u6210\u4e32\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"/**\n * @author roshine\n * @version 1.0.0\n */\npublic class UUIDKeyGenerator implements StringKeyGenerator {\n    @Override\n    public String generateKey() {\n        return UUID.randomUUID().toString().toLowerCase();\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u7531\u4e8e\u6211\u4eec\u53ea\u9700\u8981\u5c06",(0,r.jsx)(n.code,{children:"Token"}),"\u7684\u751f\u6210\u6539\u4e3a",(0,r.jsx)(n.code,{children:"UUID"}),"\u5176\u4ed6\u903b\u8f91\u4e0d\u53d8\uff0c\u6240\u4ee5\u5c06",(0,r.jsx)(n.code,{children:"org.springframework.security.oauth2.server.authorization.token.OAuth2AccessTokenGenerator#generate"}),"\n\u590d\u523b\u4e00\u4efd\uff0c\u628a\u591a\u4f59\u7684\u90e8\u5206\u53bb\u6389\uff0c\u6bd4\u5982\u5b9a\u5236\u5316\u5668",(0,r.jsx)(n.code,{children:"accessTokenCustomizer"}),"\uff0c\u5982\u4e0b\u6240\u793a\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"/**\n * @author roshine\n * @version 1.0.0\n */\npublic class UUIDOAuth2TokenGenerator implements OAuth2TokenGenerator<OAuth2AccessToken> {\n    private final StringKeyGenerator accessTokenGenerator = new UUIDKeyGenerator();\n\n    @Override\n    public OAuth2AccessToken generate(OAuth2TokenContext context) {\n        if (!OAuth2TokenType.ACCESS_TOKEN.equals(context.getTokenType()) ||\n                !OAuth2TokenFormat.REFERENCE.equals(context.getRegisteredClient().getTokenSettings().getAccessTokenFormat())) {\n            return null;\n        }\n        String issuer = null;\n        if (context.getAuthorizationServerContext() != null) {\n            issuer = context.getAuthorizationServerContext().getIssuer();\n        }\n        RegisteredClient registeredClient = context.getRegisteredClient();\n\n        Instant issuedAt = Instant.now();\n        Instant expiresAt = issuedAt.plus(registeredClient.getTokenSettings().getAccessTokenTimeToLive());\n\n        // @formatter:off\n        OAuth2TokenClaimsSet.Builder claimsBuilder = OAuth2TokenClaimsSet.builder();\n        if (StringUtils.hasText(issuer)) {\n            claimsBuilder.issuer(issuer);\n        }\n        claimsBuilder\n                .subject(context.getPrincipal().getName())\n                .audience(Collections.singletonList(registeredClient.getClientId()))\n                .issuedAt(issuedAt)\n                .expiresAt(expiresAt)\n                .notBefore(issuedAt)\n                .id(UUID.randomUUID().toString());\n        if (!CollectionUtils.isEmpty(context.getAuthorizedScopes())) {\n            claimsBuilder.claim(OAuth2ParameterNames.SCOPE, context.getAuthorizedScopes());\n        }\n        OAuth2TokenClaimsSet accessTokenClaimsSet = claimsBuilder.build();\n\n        return new OAuth2AccessTokenClaims(OAuth2AccessToken.TokenType.BEARER,\n                this.accessTokenGenerator.generateKey(), accessTokenClaimsSet.getIssuedAt(), accessTokenClaimsSet.getExpiresAt(),\n                context.getAuthorizedScopes(), accessTokenClaimsSet.getClaims());\n    }\n\n    private static final class OAuth2AccessTokenClaims extends OAuth2AccessToken implements ClaimAccessor {\n        private final Map<String, Object> claims;\n\n        private OAuth2AccessTokenClaims(TokenType tokenType, String tokenValue,\n                                        Instant issuedAt, Instant expiresAt, Set<String> scopes, Map<String, Object> claims) {\n            super(tokenType, tokenValue, issuedAt, expiresAt, scopes);\n            this.claims = claims;\n        }\n\n        @Override\n        public Map<String, Object> getClaims() {\n            return this.claims;\n        }\n\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u7136\u540e\u5728\u6211\u4eec\u7684",(0,r.jsx)(n.code,{children:"AuthorizationServerConfig"}),"\u6dfb\u52a0"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    /**\n     * \u81ea\u5b9a\u4e49Token\u751f\u6210\u5668\n     *\n     * @return OAuth2TokenGenerator\n     */\n    @Bean\n    public OAuth2TokenGenerator<?> tokenGenerator() {\n        UUIDOAuth2TokenGenerator uuidoAuth2TokenGenerator = new UUIDOAuth2TokenGenerator();\n        return new DelegatingOAuth2TokenGenerator(uuidoAuth2TokenGenerator);\n    }\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u83b7\u53d6token\u65f6\u62a5\u9519\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n"error_description": "The token generator failed to generate the refresh token.",\n"error": "server_error",\n"error_uri": "https://datatracker.ietf.org/doc/html/rfc6749#section-5.2"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u90a3\u6211\u4eec\u5c31\u518d\u5b9a\u4e49\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"UUIDOAuth2RefreshTokenGenerator"}),"\u6765\u751f\u6210 ",(0,r.jsx)(n.code,{children:"refresh-token"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"/**\n * @author roshine\n * @version 1.0.0\n * @date 2023-09-15 23:16\n */\npublic class UUIDOAuth2RefreshTokenGenerator implements OAuth2TokenGenerator<OAuth2RefreshToken> {\n\n    private final StringKeyGenerator refreshTokenGenerator = new UUIDKeyGenerator();\n\n    @Nullable\n    @Override\n    public OAuth2RefreshToken generate(OAuth2TokenContext context) {\n        if (!OAuth2TokenType.REFRESH_TOKEN.equals(context.getTokenType())) {\n            return null;\n        }\n        Instant issuedAt = Instant.now();\n        Instant expiresAt = issuedAt.plus(context.getRegisteredClient().getTokenSettings().getRefreshTokenTimeToLive());\n        return new OAuth2RefreshToken(this.refreshTokenGenerator.generateKey(), issuedAt, expiresAt);\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728",(0,r.jsx)(n.code,{children:"tokenGenerator()"}),"\u91cc\u6dfb\u52a0\u4e0a",(0,r.jsx)(n.code,{children:"UUIDOAuth2RefreshTokenGenerator"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"/**\n * \u81ea\u5b9a\u4e49Token\u751f\u6210\u5668\n *\n * @return OAuth2TokenGenerator\n */\n@Bean\npublic OAuth2TokenGenerator<?> tokenGenerator() {\n    UUIDOAuth2TokenGenerator uuidoAuth2TokenGenerator = new UUIDOAuth2TokenGenerator();\n    UUIDOAuth2RefreshTokenGenerator refreshTokenGenerator = new UUIDOAuth2RefreshTokenGenerator();\n    return new DelegatingOAuth2TokenGenerator(uuidoAuth2TokenGenerator, refreshTokenGenerator);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"img",src:t(66556).A+"",width:"2726",height:"1308"})}),"\n",(0,r.jsx)(n.p,{children:"\u7ec8\u4e8e\u5bf9\u5473\u513f\u4e86\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u4ee5\u4e0a\u5c31\u662f\u7b80\u5355\u7684\u5206\u6790\u4e86\u4e00\u4e0b",(0,r.jsx)(n.code,{children:"spring-security-oauth2-authorization-server"}),"\u751f\u6210",(0,r.jsx)(n.code,{children:"Token"}),"\u7684\u7b56\u7565\u4ee5\u53ca\u5982\u4f55\u81ea\u5b9a\u4e49",(0,r.jsx)(n.code,{children:"Token"}),"\u751f\u6210\u5668\u6765\u751f\u6210\u6211\u4eec\u5728",(0,r.jsx)(n.code,{children:"OAuth2.0"}),"\u4e2d\u719f\u6089\u7684\u5f62\u5982\uff1a",(0,r.jsx)(n.code,{children:"8f9e0b4b-6696-4424-aa2a-550398a0a685"}),"\u8fd9\u6837\u7684",(0,r.jsx)(n.code,{children:"Token"}),"\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u9057\u7559\u601d\u8003\u7684\u95ee\u9898",children:"\u9057\u7559\u601d\u8003\u7684\u95ee\u9898\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u751f\u6210\u4e86\u4e09\u5f20\u8868\uff0c\u53e6\u5916\u4e24\u5f20",(0,r.jsx)(n.code,{children:"oauth2_authorization"}),"\u3001",(0,r.jsx)(n.code,{children:"oauth2_authorization_consent"}),"\u4e00\u76f4\u6ca1\u6709\u6570\u636e\u4ec0\u4e48\u539f\u56e0\uff1f"]}),"\n",(0,r.jsxs)(n.li,{children:["\u4e3a\u4ec0\u4e48\u6bcf\u6b21\u8c03\u7528",(0,r.jsx)(n.code,{children:"/oauth2/authorize"}),"\u63a5\u53e3\u90fd\u9700\u8981\u91cd\u65b0\u6388\u6743\uff1f"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u4f55\u81ea\u5b9a\u4e49\u767b\u5f55\u9875\u9762\uff0c\u81ea\u5b9a\u4e49\u8868\u5355\u63d0\u4ea4\u8bf7\u6c42\u3001\u81ea\u5b9a\u4e49\u56de\u8c03\u5730\u5740\u7b49\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4f1a\u4e00\u4e00\u89e3\u7b54\u3002"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},38036:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-1-c6d606310f6d539ebb418bb14b73762b.png"},59503:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-2-45f87fbc7ae75f466040ab1720229559.png"},77958:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-3-23a009857d45698bfa9edc3173fe3feb.png"},80377:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-4-2df0d69be9ad7a6f0dea7db2244433f4.png"},74128:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-5-b31fead9d06f189ec05a29fc5151b0a1.png"},87947:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-6-6be99db96db429e1329fc2e0692aa844.png"},97442:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-7-820bfc0e0a5cf8d67d8aee952f47bbf0.png"},18821:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-8-04d4d7008f84fecc07b9d91a728c543f.png"},66556:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/52-9-bd49673e77363e61faeff7f2cfb26094.png"},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>c});var r=t(96540);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);