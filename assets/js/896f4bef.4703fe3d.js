"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[1320],{99978:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var t=a(85893),r=a(11151);const i={},s=void 0,l={id:"influxdb/Influxdb-DownSample",title:"Influxdb-DownSample",description:"\u964d\u91c7\u6837",source:"@site/middleware/influxdb/1-Influxdb-DownSample.md",sourceDirName:"influxdb",slug:"/influxdb/Influxdb-DownSample",permalink:"/light-docusaurus/middleware/influxdb/Influxdb-DownSample",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/middleware/influxdb/1-Influxdb-DownSample.md",tags:[],version:"current",lastUpdatedBy:"Lorchr",lastUpdatedAt:1705891060,formattedLastUpdatedAt:"2024\u5e741\u670822\u65e5",sidebarPosition:1,frontMatter:{},sidebar:"middleware",previous:{title:"InfluxDB",permalink:"/light-docusaurus/middleware/category/influxdb"},next:{title:"Influxdb-Retention-Policy",permalink:"/light-docusaurus/middleware/influxdb/Influxdb-Retention-Policy"}},o={},u=[{value:"\u964d\u91c7\u6837",id:"\u964d\u91c7\u6837",level:2},{value:"Retention Policy",id:"retention-policy",level:2},{value:"Continuous Query",id:"continuous-query",level:2},{value:"\u51c6\u5907\u5de5\u4f5c",id:"\u51c6\u5907\u5de5\u4f5c",level:2},{value:"\u4f7f\u7528Continuous Query\u964d\u91c7\u6837",id:"\u4f7f\u7528continuous-query\u964d\u91c7\u6837",level:2},{value:"\u6279\u91cf\u521b\u5efa\u964d\u91c7\u6837 RP CQ",id:"\u6279\u91cf\u521b\u5efa\u964d\u91c7\u6837-rp-cq",level:2},{value:"DownSampleParam",id:"downsampleparam",level:3},{value:"DownSampleController",id:"downsamplecontroller",level:3},{value:"DownSampleService",id:"downsampleservice",level:3},{value:"DownSampleServiceImpl",id:"downsampleserviceimpl",level:3},{value:"\u53c2\u6570\u793a\u4f8b",id:"\u53c2\u6570\u793a\u4f8b",level:3}];function m(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.ah)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"\u964d\u91c7\u6837",children:"\u964d\u91c7\u6837"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u964d\u91c7\u6837 ",(0,t.jsx)(n.a,{href:"https://docs.influxdata.com/influxdb/v1.8/guides/downsample_and_retain/",children:"https://docs.influxdata.com/influxdb/v1.8/guides/downsample_and_retain/"})]}),"\n",(0,t.jsxs)(n.li,{children:["RP: ",(0,t.jsx)(n.a,{href:"https://archive.docs.influxdata.com/influxdb/v1.2/query_language/database_management/#retention-policy-management",children:"https://archive.docs.influxdata.com/influxdb/v1.2/query_language/database_management/#retention-policy-management"})]}),"\n",(0,t.jsxs)(n.li,{children:["CQ: ",(0,t.jsx)(n.a,{href:"https://archive.docs.influxdata.com/influxdb/v1.2/query_language/continuous_queries/",children:"https://archive.docs.influxdata.com/influxdb/v1.2/query_language/continuous_queries/"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"retention-policy",children:"Retention Policy"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.influxdata.com/influxdb/v1.8/query_language/manage-database/#retention-policy-management",children:"https://docs.influxdata.com/influxdb/v1.8/query_language/manage-database/#retention-policy-management"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"continuous-query",children:"Continuous Query"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.influxdata.com/influxdb/v1.8/query_language/continuous_queries/",children:"https://docs.influxdata.com/influxdb/v1.8/query_language/continuous_queries/"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.influxdata.com/influxdb/v1.8/query_language/functions/",children:"https://docs.influxdata.com/influxdb/v1.8/query_language/functions/"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u51c6\u5907\u5de5\u4f5c",children:"\u51c6\u5907\u5de5\u4f5c"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'# \u521b\u5efa\u6570\u636e\u5e93\nCREATE DATABASE seconds_36;\n\n# \u5220\u9664MEASUREMENT\nDROP MEASUREMENT rq_36_test1;\n\n# \u4fee\u6539\u4fdd\u7559\u7b56\u7565\nALTER RETENTION POLICY default ON "pd" DURATION 52w REPLICATION 1 DEFAULT;\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u4f7f\u7528continuous-query\u964d\u91c7\u6837",children:"\u4f7f\u7528Continuous Query\u964d\u91c7\u6837"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:'# \u521b\u5efa\u4fdd\u7559\u7b56\u7565\nCREATE RETENTION POLICY "rp_36" ON "pd" DURATION 2w REPLICATION 1;\n\n# \u521b\u5efa\u8fde\u7eed\u67e5\u8be2 \n# EVERY 36s \u6bcf\u969436s\u6267\u884c\u4e00\u6b21\uff0c\n# FOR   36s \u7edf\u8ba136s\u4e4b\u5185\u7684\u6570\u636e\nCREATE CONTINUOUS QUERY "cq_36_test1" ON "pd"\nRESAMPLE EVERY 36s\nBEGIN \n    SELECT mean(*::field) INTO "rp_36"."cq_36_test1" FROM "test1" GROUP BY time(36s),* fill(0);\nEND;\n\n# \u67e5\u8be2\u8fde\u7eed\u67e5\u8be2\nSHOW CONTINUOUS QUERIES;\n\n# \u5220\u9664\u8fde\u7eed\u67e5\u8be2\nDROP CONTINUOUS QUERY "cq_36_test1" ON "pd";\n\n# \u67e5\u8be2\u539f\u59cb\u6570\u636e\nSELECT mean(*::field),min(*::field),max(*::field) FROM test1 GROUP BY time(36s),* fill(0);\n\n# \u67e5\u8be2\u91c7\u6837\u7ed3\u679c\nSELECT * FROM "rp_36"."rp_36_test1";\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6279\u91cf\u521b\u5efa\u964d\u91c7\u6837-rp-cq",children:"\u6279\u91cf\u521b\u5efa\u964d\u91c7\u6837 RP CQ"}),"\n",(0,t.jsx)(n.h3,{id:"downsampleparam",children:"DownSampleParam"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.light.cloud.downsample.param;\n\nimport io.swagger.annotations.ApiModelProperty;\nimport lombok.Data;\n\nimport java.io.Serializable;\nimport java.util.List;\n\n/**\n * \u521b\u5efaRP\n *\n * @author Hui Liu\n * @date 2023/6/10\n */\n@Data\npublic class DownSampleParam implements Serializable {\n\n    private static final long serialVersionUID = 1L;\n\n    @ApiModelProperty("\u6570\u636e\u5e93\u540d\u79f0 pd")\n    private String databaseName;\n\n    @ApiModelProperty("RP\u540d\u79f0 rp_36")\n    private String rpName;\n\n    @ApiModelProperty("RP\u5b58\u50a8\u65f6\u95f4 2w")\n    private String rpDuration;\n\n    @ApiModelProperty("CQ\u540d\u79f0\u524d\u7f00 cq_36")\n    private String cqPrefix;\n\n    @ApiModelProperty("\u6267\u884c\u65f6\u95f4\u95f4\u9694 36s")\n    private String execInterval;\n\n    @ApiModelProperty("GROUP BY\u65f6\u95f4\u95f4\u9694 36s")\n    private String groupInterval;\n\n    @ApiModelProperty("\u6570\u636e\u8868\u540d test2")\n    private List<String> measurements;\n\n    @ApiModelProperty("\u5bf9\u6240\u6709\u8868\u521b\u5efa\u964d\u91c7\u6837 0-\u5426\uff1b1-\u662f")\n    private Integer allMeasurements;\n\n    @ApiModelProperty("\u8986\u76d6\u5df2\u5b58\u5728\u7684CQ 0-\u5426\uff1b1-\u662f")\n    private Integer overrideCQ;\n\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"downsamplecontroller",children:"DownSampleController"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.light.cloud.downsample.controller;\n\nimport com.light.cloud.constant.config.Result;\nimport com.light.cloud.downsample.param.DownSampleParam;\nimport com.light.cloud.downsample.service.DownSampleService;\n\nimport io.swagger.annotations.Api;\nimport io.swagger.annotations.ApiOperation;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport javax.annotation.Resource;\nimport java.util.List;\n\n/**\n * \u964d\u91c7\u6837\u914d\u7f6e\u63a5\u53e3\n *\n * @author Hui Liu\n * @date 2023/6/10\n */\n@RestController\n@RequestMapping("/downsample")\n@Api(tags = "\u964d\u91c7\u6837")\n@Slf4j\npublic class DownSampleController {\n\n    @Resource\n    private DownSampleService downSampleService;\n\n    @ApiOperation("\u521d\u59cb\u5316\u964d\u91c7\u6837\u914d\u7f6e")\n    @PostMapping(value = "initSetting")\n    public Result<Boolean> initSetting(@RequestBody DownSampleParam param) {\n        downSampleService.initSetting(param);\n        return Result.OK(true);\n    }\n\n    @ApiOperation("\u521b\u5efaRP")\n    @PostMapping(value = "rp")\n    public Result<Boolean> createRP(@RequestBody DownSampleParam param) {\n        downSampleService.createRP(param);\n        return Result.OK(true);\n    }\n\n    @ApiOperation("\u521b\u5efaCQ")\n    @PostMapping(value = "cq")\n    public Result<Boolean> createCQ(@RequestBody DownSampleParam param) {\n        downSampleService.createCQ(param);\n        return Result.OK(true);\n    }\n\n    @ApiOperation("\u67e5\u8be2CQ")\n    @GetMapping(value = "queryCQ")\n    public Result<List<String>> queryCQ(String databaseName) {\n        List<String> cqs = downSampleService.queryCQ(databaseName);\n        return Result.OK(cqs);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"downsampleservice",children:"DownSampleService"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"package com.light.cloud.downsample.service;\n\nimport java.util.List;\n\n/**\n * \u964d\u91c7\u6837\u914d\u7f6e\u4e1a\u52a1\u7c7b\n *\n * @author Hui Liu\n * @date 2023/6/10\n */\npublic interface DownSampleService {\n\n    void initSetting(DownSampleParam param);\n\n    void createRP(DownSampleParam param);\n\n    void createCQ(DownSampleParam param);\n\n    List<String> queryCQ(String databaseName);\n}\n\n"})}),"\n",(0,t.jsx)(n.h3,{id:"downsampleserviceimpl",children:"DownSampleServiceImpl"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'package com.light.cloud.downsample.service;\n\nimport com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;\nimport com.baomidou.mybatisplus.core.toolkit.Wrappers;\n\nimport com.light.cloud.constant.enumerate.YesNoEnum;\nimport com.light.cloud.common.influxDb.TimingDbService;\nimport com.light.cloud.measurement.entity.Measurement;\nimport com.light.cloud.measurement.service.MeasurementService;\n\nimport org.apache.commons.collections4.CollectionUtils;\nimport org.influxdb.dto.QueryResult;\nimport org.springframework.stereotype.Service;\n\nimport javax.annotation.Resource;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.List;\nimport java.util.stream.Collectors;\n\n/**\n * \u964d\u91c7\u6837\u914d\u7f6e\u4e1a\u52a1\u7c7b\n *\n * @author Hui Liu\n * @date 2023/6/10\n */\n@Service\npublic class DownSampleServiceImpl implements DownSampleService {\n\n    // rpName  database  rpDuration\n    public static final String CREATE_RP = "CREATE RETENTION POLICY \\"%s\\" ON \\"%s\\" DURATION  %s REPLICATION 1";\n    // cqPrefix_measurement  database  execInterval  rpName  cqPrefix_measurement  measurement\n    public static final String CREATE_CQ = "CREATE CONTINUOUS QUERY \\"%s\\" ON \\"%s\\"\\n" +\n            "RESAMPLE EVERY %s\\n" +\n            "BEGIN \\n" +\n            "    SELECT mean(*::field), min(*::field), max(*::field) INTO \\"%s\\".\\"%s\\" FROM \\"%s\\" GROUP BY time(%s)\\n" +\n            "END";\n\n    public static final String QUERY_CQ = "SHOW CONTINUOUS QUERIES";\n    // cqName database\n    public static final String DELETE_CQ = "DROP CONTINUOUS QUERY \\"%s\\" ON \\"%s\\"";\n\n    @Resource\n    private MeasurementService measurementService;\n\n    @Resource\n    private TimingDbService timingDbService;\n\n    @Override\n    public void initSetting(DownSampleParam param) {\n        createRP(param);\n        if (YesNoEnum.YES.eqValue(param.getAllMeasurements())) {\n            LambdaQueryWrapper<Measurement> queryWrapper = Wrappers.lambdaQuery(Measurement.class)\n                    .select(Measurement::getName);\n            List<Measurement> measurements = measurementService.list(queryWrapper);\n            List<String> measurementNames = measurements.stream()\n                    .map(Measurement::getName).collect(Collectors.toList());\n            param.setMeasurements(measurementNames);\n        }\n        createCQ(param);\n    }\n\n    @Override\n    public void createRP(DownSampleParam param) {\n        String command = String.format(CREATE_RP, \n        param.getRpName(), \n        param.getDatabaseName(), \n        param.getRpDuration());\n        timingDbService.query(command);\n    }\n\n    @Override\n    public void createCQ(DownSampleParam param) {\n        QueryResult result = timingDbService.query(QUERY_CQ);\n        List<QueryResult.Result> results = result.getResults();\n        if (CollectionUtils.isEmpty(results) || CollectionUtils.isEmpty(results.get(0).getSeries())) {\n            return;\n        }\n        Boolean overrideCQ = YesNoEnum.YES.eqValue(param.getOverrideCQ());\n        String cqPrefix = param.getCqPrefix();\n        List<String> measurements = param.getMeasurements();\n        List<QueryResult.Series> seriesList = results.get(0).getSeries();\n        for (QueryResult.Series series : seriesList) {\n            if (series.getName().equals(param.getDatabaseName()) && CollectionUtils.isNotEmpty(series.getValues())) {\n                List<String> columns = series.getColumns();\n                List<List<Object>> valuesList = series.getValues();\n                int index = Collections.binarySearch(columns, "name");\n                for (List<Object> values : valuesList) {\n                    String cqName = (String) values.get(index);\n                    if (cqName.startsWith(cqPrefix + "_")) {\n                        // \u5220\u9664\u65e7\u7684 CQ\n                        if (overrideCQ) {\n                            overrideCQ(cqName, param.getDatabaseName());\n                        } else {\n                            // \u4fdd\u7559\u65e7\u7684CQ\n                            measurements.remove(cqName.substring(cqPrefix.length() + 1));\n                        }\n                    }\n                }\n\n            }\n        }\n\n        for (String measurement : measurements) {\n            String command = String.format(CREATE_CQ,\n                    cqPrefix + "_" + measurement,\n                    param.getDatabaseName(), param.getExecInterval(), param.getRpName(),\n                    cqPrefix + "_" + measurement,\n                    measurement, param.getGroupInterval());\n\n            timingDbService.query(command);\n        }\n    }\n\n    private void overrideCQ(String cqName, String databaseName) {\n        String command = String.format(DELETE_CQ, cqName, databaseName);\n        timingDbService.query(command);\n    }\n\n    @Override\n    public List<String> queryCQ(String databaseName) {\n        QueryResult result = timingDbService.query(QUERY_CQ);\n        List<QueryResult.Result> results = result.getResults();\n        if (CollectionUtils.isEmpty(results) || CollectionUtils.isEmpty(results.get(0).getSeries())) {\n            return Collections.emptyList();\n        }\n\n        List<String> resultList = new ArrayList<>();\n        List<QueryResult.Series> seriesList = results.get(0).getSeries();\n        for (QueryResult.Series series : seriesList) {\n            if (series.getName().equals(databaseName) && CollectionUtils.isNotEmpty(series.getValues())) {\n                List<String> columns = series.getColumns();\n                List<List<Object>> valuesList = series.getValues();\n                int index = Collections.binarySearch(columns, "name");\n                for (List<Object> values : valuesList) {\n                    String cqName = (String) values.get(index);\n                    resultList.add(cqName);\n                }\n            }\n        }\n        return resultList;\n    }\n\n}\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u53c2\u6570\u793a\u4f8b",children:"\u53c2\u6570\u793a\u4f8b"}),"\n",(0,t.jsxs)(n.p,{children:["\u8bf7\u6c42\u521d\u59cb\u5316\u63a5\u53e3 ",(0,t.jsx)(n.code,{children:"POST"})," ",(0,t.jsx)(n.code,{children:"/downsample/initSetting"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'// 8\u5c0f\u65f6\u7684\u6570\u636e  \u95f4\u96944s\n{\n  "databaseName": "pd",\n  "rpName": "rp_4",\n  "rpDuration": "1w",\n  "cqPrefix": "cq_4",\n  "execInterval": "4s",\n  "groupInterval": "4s",\n  "overrideCQ": 0,\n  "allMeasurements": 1\n}\n\n// 24\u5c0f\u65f6\u7684\u6570\u636e  \u95f4\u969412s\n{\n  "databaseName": "pd",\n  "rpName": "rp_12",\n  "rpDuration": "1w",\n  "cqPrefix": "cq_12",\n  "execInterval": "12s",\n  "groupInterval": "12s",\n  "overrideCQ": 0,\n  "allMeasurements": 1\n}\n\n// 72\u5c0f\u65f6\u7684\u6570\u636e  \u95f4\u969436s\n{\n  "databaseName": "pd",\n  "rpName": "rp_36",\n  "rpDuration": "2w",\n  "cqPrefix": "cq_36",\n  "execInterval": "36s",\n  "groupInterval": "36s",\n  "overrideCQ": 0,\n  "allMeasurements": 1\n}\n'})})]})}function c(e={}){const{wrapper:n}={...(0,r.ah)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(m,{...e})}):m(e)}},11151:(e,n,a)=>{a.d(n,{ah:()=>i});var t=a(67294);const r=t.createContext({});function i(e){const n=t.useContext(r);return t.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);