"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[33701],{54190:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var r=t(74848),o=t(28453);const i={},s=void 0,a={id:"zh-cn/spring-authorization-server/SAS-QrCode-Login",title:"SAS-QrCode-Login",description:"- Spring Authorization Server\u5165\u95e8 (\u4e8c\u5341) \u5b9e\u73b0\u4e8c\u7ef4\u7801\u626b\u7801\u767b\u5f55",source:"@site/docs/zh-cn/spring-authorization-server/20-SAS-QrCode-Login.md",sourceDirName:"zh-cn/spring-authorization-server",slug:"/zh-cn/spring-authorization-server/SAS-QrCode-Login",permalink:"/docs/zh-cn/spring-authorization-server/SAS-QrCode-Login",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-authorization-server/20-SAS-QrCode-Login.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{},sidebar:"troch",previous:{title:"SAS-Redis-Core-Service",permalink:"/docs/zh-cn/spring-authorization-server/SAS-Redis-Core-Service"},next:{title:"Opaque-Token-Resource-Server",permalink:"/docs/zh-cn/spring-authorization-server/Opaque-Token-Resource-Server"}},c={},l=[{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406",level:2},{value:"\u4e8c\u3001\u4ee3\u7801\u5b9e\u73b0",id:"\u4e8c\u4ee3\u7801\u5b9e\u73b0",level:2},{value:"1. \u540e\u7aef\u5b9e\u73b0",id:"1-\u540e\u7aef\u5b9e\u73b0",level:3},{value:"1. \u5f15\u5165\u4e8c\u7ef4\u7801\u4f9d\u8d56",id:"1-\u5f15\u5165\u4e8c\u7ef4\u7801\u4f9d\u8d56",level:4},{value:"2. \u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3",id:"2-\u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3",level:4},{value:"3. yml\u4e2d\u653e\u884c\u524d\u7aef\u8bbf\u95ee\u7684\u63a5\u53e3",id:"3-yml\u4e2d\u653e\u884c\u524d\u7aef\u8bbf\u95ee\u7684\u63a5\u53e3",level:4},{value:"4. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u670d\u52a1\u63a5\u53e3",id:"4-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u670d\u52a1\u63a5\u53e3",level:4},{value:"5. \u7f16\u5199\u751f\u6210\u4e8c\u7ef4\u7801\u54cd\u5e94\u7c7b",id:"5-\u7f16\u5199\u751f\u6210\u4e8c\u7ef4\u7801\u54cd\u5e94\u7c7b",level:4},{value:"6. \u7f16\u5199web\u524d\u7aef\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u51fa\u53c2",id:"6-\u7f16\u5199web\u524d\u7aef\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u51fa\u53c2",level:4},{value:"7. \u7f16\u5199\u626b\u63cf\u4e8c\u7ef4\u7801\u5165\u53c2",id:"7-\u7f16\u5199\u626b\u63cf\u4e8c\u7ef4\u7801\u5165\u53c2",level:4},{value:"8. \u7f16\u5199\u4e8c\u7ef4\u7801\u54cd\u5e94bean",id:"8-\u7f16\u5199\u4e8c\u7ef4\u7801\u54cd\u5e94bean",level:4},{value:"9. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u786e\u8ba4\u767b\u5f55\u5165\u53c2\u7c7b",id:"9-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u786e\u8ba4\u767b\u5f55\u5165\u53c2\u7c7b",level:4},{value:"10. \u7f16\u5199\u4e8c\u7ef4\u7801\u4fe1\u606f\u7c7b",id:"10-\u7f16\u5199\u4e8c\u7ef4\u7801\u4fe1\u606f\u7c7b",level:4},{value:"11. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0",id:"11-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0",level:4},{value:"2. \u524d\u7aef\u5b9e\u73b0",id:"2-\u524d\u7aef\u5b9e\u73b0",level:3},{value:"1. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u8bf7\u6c42api",id:"1-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u8bf7\u6c42api",level:4},{value:"2. \u5728\u767b\u5f55\u9875\u9762\u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u5165\u53e3",id:"2-\u5728\u767b\u5f55\u9875\u9762\u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u5165\u53e3",level:4},{value:"\u4e09\u3001\u6548\u679c",id:"\u4e09\u6548\u679c",level:2},{value:"\u56db\u3001\u9644\u5f55",id:"\u56db\u9644\u5f55",level:2},{value:"\u4e94\u3001\u53c2\u8003\u8d44\u6599",id:"\u4e94\u53c2\u8003\u8d44\u6599",level:2}];function d(n){const e={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://juejin.cn/post/7326546769981603866",children:"Spring Authorization Server\u5165\u95e8 (\u4e8c\u5341) \u5b9e\u73b0\u4e8c\u7ef4\u7801\u626b\u7801\u767b\u5f55"})}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u5b9e\u73b0\u539f\u7406",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u6253\u5f00\u7f51\u9875\uff0c\u53d1\u8d77\u6388\u6743\u7533\u8bf7/\u672a\u767b\u5f55\u88ab\u91cd\u5b9a\u5411\u5230\u767b\u5f55\u9875\u9762"}),"\n",(0,r.jsx)(e.li,{children:"\u9009\u62e9\u4e8c\u7ef4\u7801\u767b\u5f55\uff0c\u9875\u9762\u4ece\u540e\u7aef\u8bf7\u6c42\u4e8c\u7ef4\u7801"}),"\n",(0,r.jsx)(e.li,{children:"\u9875\u9762\u6e32\u67d3\u4e8c\u7ef4\u7801\u56fe\u7247\uff0c\u5e76\u8f6e\u8be2\u8bf7\u6c42\uff0c\u83b7\u53d6\u4e8c\u7ef4\u7801\u7684\u72b6\u6001"}),"\n",(0,r.jsx)(e.li,{children:"\u4e8b\u5148\u767b\u5f55\u8fc7APP\u7684\u624b\u673a\u626b\u63cf\u4e8c\u7ef4\u7801\uff0c\u7136\u540eAPP\u8bf7\u6c42\u670d\u52a1\u5668\u7aef\u7684API\u63a5\u53e3\uff0c\u628a\u7528\u6237\u8ba4\u8bc1\u4fe1\u606f\u4f20\u9012\u5230\u670d\u52a1\u5668\u4e2d"}),"\n",(0,r.jsx)(e.li,{children:"\u540e\u7aef\u6536\u5230APP\u7684\u8bf7\u6c42\u540e\u66f4\u6539\u4e8c\u7ef4\u7801\u72b6\u6001\uff0c\u5e76\u628a\u7528\u6237\u8ba4\u8bc1\u4fe1\u606f\u5199\u5165session"}),"\n",(0,r.jsx)(e.li,{children:"\u9875\u9762\u5f97\u5230\u626b\u7801\u786e\u8ba4\u7684\u54cd\u5e94\uff0c\u5e76\u8df3\u8f6c\u56de\u4e4b\u524d\u672a\u767b\u5f55\u7684\u5730\u5740"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.a,{href:"https://mermaid.js.org/syntax/sequenceDiagram.html",children:"Sequence Diagram Syntax"})}),"\n",(0,r.jsx)(e.mermaid,{value:"sequenceDiagram\n    actor       A as USER;\n    participant B as Browser            ;\n    participant C as AuthorizationServer;\n\n    A ->>+ B : \u8bbf\u95ee\u53d7\u9650\u8d44\u6e90\n    B ->>+ C : \u8bbf\u95ee\u53d7\u9650\u8d44\u6e90\n    C --\x3e> B : \u8fd4\u56de\u767b\u5f55\u9875\u9762\n    A ->>+ B : \u9009\u62e9\u4e8c\u7ef4\u7801\u767b\u5f55\n    B ->>+ C : \u8bf7\u6c42\u751f\u6210\u4e8c\u7ef4\u7801\n    C --\x3e> B : \u8fd4\u56de\u767b\u5f55\u9875\u9762\n    B --\x3e> B : \u6e32\u67d3\u56fe\u7247\n    B ->>+ C : \u8f6e\u8be2\u68c0\u6d4b\u4e8c\u7ef4\u7801\u72b6\u6001\n    B ->>+ C : \u8f6e\u8be2\u68c0\u6d4b\u4e8c\u7ef4\u7801\u72b6\u6001\n    B ->>+ C : \u8f6e\u8be2\u68c0\u6d4b\u4e8c\u7ef4\u7801\u72b6\u6001\n    C --\x3e> B : \u672a\u626b\u63cf\n    A ->>+ B : \u5df2\u767b\u5f55APP\u626b\u7801\u4e8c\u7ef4\u7801\n    A ->>+ C : \u83b7\u53d6\u4e8c\u7ef4\u7801\u5f53\u524d\u72b6\u6001\n    C --\x3e> A : \u4e8c\u7ef4\u7801\u72b6\u6001\n    B ->>+ C : \u8f6e\u8be2\u68c0\u6d4b\u4e8c\u7ef4\u7801\u72b6\u6001\n    C --\x3e> B : \u626b\u7801\u7528\u6237\u5934\u50cf\u3001\u5f85\u786e\u8ba4\n    B ->>+ C : \u8f6e\u8be2\u68c0\u6d4b\u4e8c\u7ef4\u7801\u72b6\u6001\n    A ->>+ C : \u786e\u8ba4\u767b\u5f55\n    C --\x3e> A : \u8ba4\u8bc1\u4fe1\u606f\u5199\u5165session\uff0c\u54cd\u5e94\u6210\u529f\n    B ->>+ C : \u8f6e\u8be2\u68c0\u6d4b\u4e8c\u7ef4\u7801\u72b6\u6001\n    C --\x3e> B : \u626b\u7801\u6210\u529f\uff0c\u7528\u6237\u786e\u8ba4\u767b\u5f55\n    B --\x3e> B : \u91cd\u5b9a\u5411\u81f3\u53d7\u9650\u8d44\u6e90\n    B --\x3e> A : \u8fd4\u56de\u53d7\u9650\u8d44\u6e90"}),"\n",(0,r.jsxs)(e.p,{children:["\u5728\u8fd9\u4e2a\u6d41\u7a0b\u4e2d ",(0,r.jsx)(e.code,{children:"\u7528\u6237\u8ba4\u8bc1\u4fe1\u606f\u5199\u5165session"})," \u540e\u524d\u7aef\u5728\u91cd\u5b9a\u5411\u65f6\u80fd\u83b7\u53d6\u5230\u8ba4\u8bc1\u4fe1\u606f\u662f\u56e0\u4e3a\u73b0\u5728\u7684\u8ba4\u8bc1\u670d\u52a1\u5f15\u5165\u4e86",(0,r.jsx)(e.code,{children:"spring session data redis"}),"\u4f9d\u8d56\uff0c\u5e76\u4e14\u5728",(0,r.jsx)(e.code,{children:"application.yml"}),"\u4e2d\u914d\u7f6e\u4e86",(0,r.jsx)(e.code,{children:"server.servlet.session.cookie.domain: cdhttp.cn"}),"\u5c5e\u6027(\u6f14\u793a\u73af\u5883\u57df\u540d)\uff0c\u8fd9\u91cc\u662f\u6307\u5b9aspring session\u7684\u9876\u7ea7\u57df\u540d\uff0c\u5728\u8be5\u57df\u540d\u4e0b\u7684\u5b50\u57df\u540d\u670d\u52a1\u5171\u4eabsession\uff0c\u5982\u679c\u4f60\u662f\u5728\u5f00\u53d1\u9636\u6bb5\u53ef\u4ee5\u914d\u7f6e\u4e3a",(0,r.jsx)(e.code,{children:"server.servlet.session.cookie.domain: 127.0.0.1"}),"\uff0c\u8fd9\u65f6\u5019\u524d\u7aef\u8bbf\u95ee\u4f7f\u7528",(0,r.jsx)(e.code,{children:"127.0.0.1:5173"}),"\uff0c\u8ba4\u8bc1\u670d\u52a1\u4f7f\u7528",(0,r.jsx)(e.code,{children:"127.0.0.1:8080"}),"\uff0c\u7aef\u53e3\u53ef\u4ee5\u4e0d\u4e00\u6837\uff0c\u4f46\u662f\u8ba4\u8bc1\u670d\u52a1\u548c\u524d\u7aef\u5fc5\u987b\u4f7f\u7528\u540c\u4e00\u57df\u540d\u3002"]}),"\n",(0,r.jsx)(e.h2,{id:"\u4e8c\u4ee3\u7801\u5b9e\u73b0",children:"\u4e8c\u3001\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u540e\u7aef\u5b9e\u73b0",children:"1. \u540e\u7aef\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.h4,{id:"1-\u5f15\u5165\u4e8c\u7ef4\u7801\u4f9d\u8d56",children:"1. \u5f15\u5165\u4e8c\u7ef4\u7801\u4f9d\u8d56"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-xml",children:"<dependency>\n    <groupId>com.google.zxing</groupId>\n    <artifactId>core</artifactId>\n    <version>3.3.0</version>\n</dependency>\n<dependency>\n    <groupId>com.google.zxing</groupId>\n    <artifactId>javase</artifactId>\n    <version>3.3.0</version>\n</dependency>\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"hutool-captcha"}),"\u6539\u4e3a",(0,r.jsx)(e.code,{children:"hutool-all"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-xml",children:"<dependency>\n    <groupId>cn.hutool</groupId>\n    <artifactId>hutool-all</artifactId>\n    <version>${hutool.version}</version>\n</dependency>\n"})}),"\n",(0,r.jsx)(e.h4,{id:"2-\u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3",children:"2. \u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3"}),"\n",(0,r.jsx)(e.p,{children:"\u63d0\u4f9b\u56db\u4e2a\u63a5\u53e3\uff0c\u5206\u522b\u5904\u7406\u751f\u6210\u4e8c\u7ef4\u7801\u3001\u8f6e\u8be2\u3001app\u626b\u7801\u548capp\u786e\u8ba4\u767b\u5f55\u7684\u903b\u8f91\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'package com.example.controller;\n\nimport com.example.model.Result;\nimport com.example.model.request.qrcode.QrCodeLoginConsentRequest;\nimport com.example.model.request.qrcode.QrCodeLoginScanRequest;\nimport com.example.model.response.qrcode.QrCodeGenerateResponse;\nimport com.example.model.response.qrcode.QrCodeLoginFetchResponse;\nimport com.example.model.response.qrcode.QrCodeLoginScanResponse;\nimport com.example.service.IQrCodeLoginService;\nimport lombok.AllArgsConstructor;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n/**\n * \u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3\n *\n * @author vains\n */\n@RestController\n@AllArgsConstructor\n@RequestMapping("/qrCode")\npublic class QrCodeLoginController {\n\n    private final IQrCodeLoginService iQrCodeLoginService;\n\n    @GetMapping("/login/generateQrCode")\n    public Result<QrCodeGenerateResponse> generateQrCode() {\n        // \u751f\u6210\u4e8c\u7ef4\u7801\n        return Result.success(iQrCodeLoginService.generateQrCode());\n    }\n\n    @GetMapping("/login/fetch/{qrCodeId}")\n    public Result<QrCodeLoginFetchResponse> fetch(@PathVariable String qrCodeId) {\n        // \u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\n        return Result.success(iQrCodeLoginService.fetch(qrCodeId));\n    }\n\n\n    @PostMapping("/scan")\n    public Result<QrCodeLoginScanResponse> scan(@RequestBody QrCodeLoginScanRequest loginScan) {\n        // app \u626b\u7801\u4e8c\u7ef4\u7801\n        return Result.success(iQrCodeLoginService.scan(loginScan));\n    }\n\n    @PostMapping("/consent")\n    public Result<String> consent(@RequestBody QrCodeLoginConsentRequest loginConsent) {\n\n        // app \u786e\u8ba4\u767b\u5f55\n        iQrCodeLoginService.consent(loginConsent);\n\n        return Result.success();\n    }\n\n}\n'})}),"\n",(0,r.jsx)(e.h4,{id:"3-yml\u4e2d\u653e\u884c\u524d\u7aef\u8bbf\u95ee\u7684\u63a5\u53e3",children:"3. yml\u4e2d\u653e\u884c\u524d\u7aef\u8bbf\u95ee\u7684\u63a5\u53e3"}),"\n",(0,r.jsxs)(e.p,{children:["\u6dfb\u52a0\u5339\u914d\u89c4\u5219",(0,r.jsx)(e.code,{children:"/qrCode/login/**"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yml",children:"custom:\n  # \u81ea\u5b9a\u4e49\u8ba4\u8bc1\u914d\u7f6e\n  security:\n    # \u767b\u5f55\u9875\u9762\u8def\u5f84\n    login-url: http://k7fsqkhtbx.cdhttp.cn/login\n    # \u6388\u6743\u786e\u8ba4\u9875\u9762\u8def\u5f84\n    consent-page-uri: http://k7fsqkhtbx.cdhttp.cn/consent\n    # \u8bbe\u5907\u7801\u9a8c\u8bc1\u9875\u9762\n    device-activate-uri: http://k7fsqkhtbx.cdhttp.cn/activate\n    # \u8bbe\u5907\u7801\u9a8c\u8bc1\u6210\u529f\u9875\u9762\n    device-activated-uri: http://k7fsqkhtbx.cdhttp.cn/activated\n    # \u4e0d\u9700\u8981\u8ba4\u8bc1\u7684\u5730\u5740\n    ignore-uri-list: assets/**, /webjars/**, /login, /getCaptcha, /getSmsCaptcha, /error, /oauth2/consent/parameters, /test03, /favicon.ico, /qrCode/login/**\n"})}),"\n",(0,r.jsx)(e.h4,{id:"4-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u670d\u52a1\u63a5\u53e3",children:"4. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u670d\u52a1\u63a5\u53e3"}),"\n",(0,r.jsx)(e.p,{children:"\u7f16\u5199\u767b\u5f55service\u63a5\u53e3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.service;\n\nimport com.example.model.request.qrcode.QrCodeLoginConsentRequest;\nimport com.example.model.request.qrcode.QrCodeLoginScanRequest;\nimport com.example.model.response.qrcode.QrCodeGenerateResponse;\nimport com.example.model.response.qrcode.QrCodeLoginFetchResponse;\nimport com.example.model.response.qrcode.QrCodeLoginScanResponse;\n\n/**\n * \u4e8c\u7ef4\u7801\u767b\u5f55\u670d\u52a1\u63a5\u53e3\n *\n * @author vains\n */\npublic interface IQrCodeLoginService {\n\n    /**\n     * \u751f\u6210\u4e8c\u7ef4\u7801\n     *\n     * @return \u4e8c\u7ef4\u7801\n     */\n    QrCodeGenerateResponse generateQrCode();\n\n    /**\n     * \u626b\u63cf\u4e8c\u7ef4\u7801\u54cd\u5e94\n     *\n     * @param loginScan \u4e8c\u7ef4\u7801id\n     * @return \u4e8c\u7ef4\u7801\u4fe1\u606f\n     */\n    QrCodeLoginScanResponse scan(QrCodeLoginScanRequest loginScan);\n\n    /**\n     * \u4e8c\u7ef4\u7801\u767b\u5f55\u786e\u8ba4\u5165\u53c2\n     *\n     * @param loginConsent \u4e8c\u7ef4\u7801id\n     */\n    void consent(QrCodeLoginConsentRequest loginConsent);\n\n    /**\n     * web\u7aef\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u5904\u7406\n     *\n     * @param qrCodeId \u4e8c\u7ef4\u7801id\n     * @return \u4e8c\u7ef4\u7801\u4fe1\u606f\n     */\n    QrCodeLoginFetchResponse fetch(String qrCodeId);\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"5-\u7f16\u5199\u751f\u6210\u4e8c\u7ef4\u7801\u54cd\u5e94\u7c7b",children:"5. \u7f16\u5199\u751f\u6210\u4e8c\u7ef4\u7801\u54cd\u5e94\u7c7b"}),"\n",(0,r.jsx)(e.p,{children:"\u751f\u6210\u4e8c\u7ef4\u7801\u56fe\u7247\u65f6\u8fd4\u56de\u4e8c\u7ef4\u7801id\u548c\u56fe\u7247"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.model.response.qrcode;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\n/**\n * \u751f\u6210\u4e8c\u7ef4\u7801\u54cd\u5e94\n *\n * @author vains\n */\n@Data\n@NoArgsConstructor\n@AllArgsConstructor\npublic class QrCodeGenerateResponse {\n\n    /**\n     * \u4e8c\u7ef4\u7801id\n     */\n    private String qrCodeId;\n\n    /**\n     * \u4e8c\u7ef4\u7801base64\u503c(\u8fd9\u91cc\u54cd\u5e94\u4e00\u4e2a\u94fe\u63a5\u597d\u4e00\u4e9b)\n     */\n    private String imageData;\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"6-\u7f16\u5199web\u524d\u7aef\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u51fa\u53c2",children:"6. \u7f16\u5199web\u524d\u7aef\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u51fa\u53c2"}),"\n",(0,r.jsx)(e.p,{children:"\u524d\u7aef\u6839\u636e\u4e8c\u7ef4\u7801id\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u65f6\u8fd4\u56de\u4e8c\u7ef4\u7801\u72b6\u6001\uff0c\u5982\u679c\u5df2\u626b\u63cf\u4e5f\u4f1a\u8fd4\u56de\u626b\u63cf\u8005\u7684\u5934\u50cf\u3001\u6635\u79f0\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.model.response.qrcode;\n\nimport lombok.Data;\n\nimport java.util.Set;\n\n/**\n * web\u524d\u7aef\u8f6e\u8be2\u4e8c\u7ef4\u7801\u72b6\u6001\u51fa\u53c2\n *\n * @author vains\n */\n@Data\npublic class QrCodeLoginFetchResponse {\n\n    /**\n     * \u4e8c\u7ef4\u7801\u72b6\u6001\n     * 0:\u5f85\u626b\u63cf\uff0c1:\u5df2\u626b\u63cf\uff0c2:\u5df2\u786e\u8ba4\n     */\n    private Integer qrCodeStatus;\n\n    /**\n     * \u662f\u5426\u5df2\u8fc7\u671f\n     */\n    private Boolean expired;\n\n    /**\n     * \u626b\u63cf\u4eba\u5934\u50cf\n     */\n    private String avatarUrl;\n\n    /**\n     * \u626b\u63cf\u4eba\u6635\u79f0\n     */\n    private String name;\n\n    /**\n     * \u5f85\u786e\u8ba4scope\n     */\n    private Set<String> scopes;\n\n    /**\n     * \u8df3\u8f6c\u767b\u5f55\u4e4b\u524d\u8bf7\u6c42\u7684\u63a5\u53e3\n     */\n    private String beforeLoginRequestUri;\n\n    /**\n     * \u8df3\u8f6c\u767b\u5f55\u4e4b\u524d\u8bf7\u6c42\u53c2\u6570\n     */\n    private String beforeLoginQueryString;\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"7-\u7f16\u5199\u626b\u63cf\u4e8c\u7ef4\u7801\u5165\u53c2",children:"7. \u7f16\u5199\u626b\u63cf\u4e8c\u7ef4\u7801\u5165\u53c2"}),"\n",(0,r.jsx)(e.p,{children:"app\u626b\u63cf\u4e8c\u7ef4\u7801\u65f6\u4f20\u5165\u4e8c\u7ef4\u7801id"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.model.request.qrcode;\n\nimport lombok.Data;\n\n/**\n * \u626b\u63cf\u4e8c\u7ef4\u7801\u5165\u53c2\n *\n * @author vains\n */\n@Data\npublic class QrCodeLoginScanRequest {\n\n    /**\n     * \u4e8c\u7ef4\u7801id\n     */\n    private String qrCodeId;\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"8-\u7f16\u5199\u4e8c\u7ef4\u7801\u54cd\u5e94bean",children:"8. \u7f16\u5199\u4e8c\u7ef4\u7801\u54cd\u5e94bean"}),"\n",(0,r.jsx)(e.p,{children:"\u626b\u63cf\u4e8c\u7ef4\u7801\u65f6\u751f\u6210\u4e00\u4e2a\u4e34\u65f6\u7968\u636e\u8fd4\u56de\uff0c\u540c\u65f6\u8fd4\u56descope\u548c\u4e8c\u7ef4\u7801\u72b6\u6001\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.model.response.qrcode;\n\nimport lombok.Data;\n\nimport java.util.Set;\n\n/**\n * \u626b\u63cf\u4e8c\u7ef4\u7801\u54cd\u5e94bean\n *\n * @author vains\n */\n@Data\npublic class QrCodeLoginScanResponse {\n\n    /**\n     * \u626b\u63cf\u4e34\u65f6\u7968\u636e\n     */\n    private String qrCodeTicket;\n\n    /**\n     * \u4e8c\u7ef4\u7801\u72b6\u6001\n     */\n    private Integer qrCodeStatus;\n\n    /**\n     * \u662f\u5426\u5df2\u8fc7\u671f\n     */\n    private Boolean expired;\n\n    /**\n     * \u5f85\u786e\u8ba4scope\n     */\n    private Set<String> scopes;\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"9-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u786e\u8ba4\u767b\u5f55\u5165\u53c2\u7c7b",children:"9. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u786e\u8ba4\u767b\u5f55\u5165\u53c2\u7c7b"}),"\n",(0,r.jsx)(e.p,{children:"\u786e\u8ba4\u767b\u5f55\u65f6\u4f20\u5165\u4e8c\u7ef4\u7801id\u548c\u4e0a\u4e00\u6b65\u751f\u6210\u7684\u4e34\u65f6\u7968\u636e\u9632\u7be1\u6539\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.model.request.qrcode;\n\nimport lombok.Data;\n\n/**\n * \u4e8c\u7ef4\u7801\u767b\u5f55\u786e\u8ba4\u5165\u53c2\n *\n * @author vains\n */\n@Data\npublic class QrCodeLoginConsentRequest {\n\n    /**\n     * \u4e8c\u7ef4\u7801id\n     */\n    private String qrCodeId;\n\n    /**\n     * \u626b\u7801\u4e8c\u7ef4\u7801\u540e\u4ea7\u751f\u7684\u4e34\u65f6\u7968\u636e(\u4ec5\u4e00\u6b21\u6709\u6548)\n     */\n    private String qrCodeTicket;\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"10-\u7f16\u5199\u4e8c\u7ef4\u7801\u4fe1\u606f\u7c7b",children:"10. \u7f16\u5199\u4e8c\u7ef4\u7801\u4fe1\u606f\u7c7b"}),"\n",(0,r.jsx)(e.p,{children:"\u751f\u6210\u4e8c\u7ef4\u7801\u65f6\u751f\u6210\u7684\u6570\u636ebean\uff0c\u5b58\u5165redis\u4e2d\uff0c\u7b49\u5230\u524d\u7aef\u8f6e\u8be2\u6216app\u7aef\u64cd\u4f5c\u65f6\u4f7f\u7528\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"package com.example.model.qrcode;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Builder;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\nimport java.time.LocalDateTime;\nimport java.util.Set;\n\n/**\n * \u4e8c\u7ef4\u7801\u4fe1\u606f\n *\n * @author vains\n */\n@Data\n@Builder\n@NoArgsConstructor\n@AllArgsConstructor\npublic class QrCodeInfo {\n\n    /**\n     * \u4e8c\u7ef4\u7801id\n     */\n    private String qrCodeId;\n\n    /**\n     * \u4e8c\u7ef4\u7801\u72b6\u6001\n     * 0:\u5f85\u626b\u63cf\uff0c1:\u5df2\u626b\u63cf\uff0c2:\u5df2\u786e\u8ba4\n     */\n    private Integer qrCodeStatus;\n\n    /**\n     * \u4e8c\u7ef4\u7801\u8fc7\u671f\u65f6\u95f4\n     */\n    private LocalDateTime expiresTime;\n\n    /**\n     * \u626b\u63cf\u4eba\u5934\u50cf\n     */\n    private String avatarUrl;\n\n    /**\n     * \u626b\u63cf\u4eba\u6635\u79f0\n     */\n    private String name;\n\n    /**\n     * \u5f85\u786e\u8ba4\u7684scope\n     */\n    private Set<String> scopes;\n\n    /**\n     * \u8df3\u8f6c\u767b\u5f55\u4e4b\u524d\u8bf7\u6c42\u7684\u63a5\u53e3\n     */\n    private String beforeLoginRequestUri;\n\n    /**\n     * \u8df3\u8f6c\u767b\u5f55\u4e4b\u524d\u8bf7\u6c42\u53c2\u6570\n     */\n    private String beforeLoginQueryString;\n\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"11-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0",children:"11. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.p,{children:"\u626b\u7801\u767b\u5f55\u5b9e\u73b0\uff0c\u5177\u4f53\u903b\u8f91\u8bf7\u770b\u4ee3\u7801\u4e2d\u7684\u6ce8\u91ca\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'package com.example.service.impl;\n\nimport cn.hutool.extra.qrcode.QrCodeUtil;\nimport cn.hutool.extra.qrcode.QrConfig;\nimport com.baomidou.mybatisplus.core.toolkit.IdWorker;\nimport com.example.entity.Oauth2BasicUser;\nimport com.example.model.qrcode.QrCodeInfo;\nimport com.example.model.request.qrcode.QrCodeLoginConsentRequest;\nimport com.example.model.request.qrcode.QrCodeLoginScanRequest;\nimport com.example.model.response.qrcode.QrCodeGenerateResponse;\nimport com.example.model.response.qrcode.QrCodeLoginFetchResponse;\nimport com.example.model.response.qrcode.QrCodeLoginScanResponse;\nimport com.example.property.CustomSecurityProperties;\nimport com.example.service.IQrCodeLoginService;\nimport com.example.support.RedisOperator;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.servlet.http.HttpSession;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.security.authentication.InsufficientAuthenticationException;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.core.context.SecurityContextImpl;\nimport org.springframework.security.oauth2.core.OAuth2AuthenticationException;\nimport org.springframework.security.oauth2.core.OAuth2Error;\nimport org.springframework.security.oauth2.core.OAuth2ErrorCodes;\nimport org.springframework.security.oauth2.server.authorization.OAuth2Authorization;\nimport org.springframework.security.oauth2.server.authorization.OAuth2TokenType;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\nimport org.springframework.security.web.savedrequest.DefaultSavedRequest;\nimport org.springframework.security.web.savedrequest.HttpSessionRequestCache;\nimport org.springframework.security.web.savedrequest.RequestCache;\nimport org.springframework.security.web.util.UrlUtils;\nimport org.springframework.stereotype.Service;\nimport org.springframework.util.Assert;\nimport org.springframework.util.ObjectUtils;\nimport org.springframework.web.context.request.RequestAttributes;\nimport org.springframework.web.context.request.RequestContextHolder;\nimport org.springframework.web.context.request.ServletRequestAttributes;\n\nimport java.security.Principal;\nimport java.time.LocalDateTime;\nimport java.util.Objects;\nimport java.util.Set;\n\nimport static org.springframework.security.web.context.HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY;\n\n/**\n * \u4e8c\u7ef4\u7801\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0\n *\n * @author vains\n */\n@Slf4j\n@Service\n@RequiredArgsConstructor\npublic class QrCodeLoginServiceImpl implements IQrCodeLoginService {\n\n\tprivate final RedisOperator<QrCodeInfo> redisOperator;\n\n\tprivate final RedisOperator<String> stringRedisOperator;\n\n\tprivate final CustomSecurityProperties customSecurityProperties;\n\n\tprivate final RedisOAuth2AuthorizationService authorizationService;\n\n\tprivate final RedisOperator<UsernamePasswordAuthenticationToken> authenticationRedisOperator;\n\n\t/**\n     * \u8fc7\u671f\u65f6\u95f4\n     */\n    private final long QR_CODE_INFO_TIMEOUT = 60 * 10;\n\n\t/**\n     * \u4e8c\u7ef4\u7801\u4fe1\u606f\u524d\u7f00\n     */\n    private final String QR_CODE_PREV = "login:qrcode:";\n\n\tprivate final RequestCache requestCache = new HttpSessionRequestCache();\n\n\t@Override\n    public QrCodeGenerateResponse generateQrCode() {\n\t\t// \u751f\u6210\u4e8c\u7ef4\u7801\u552f\u4e00id\n\t\tString qrCodeId = IdWorker.getIdStr();\n\t\t// \u751f\u6210\u4e8c\u7ef4\u7801\u5e76\u8f6c\u4e3abase64\n\t\tString pngQrCode = QrCodeUtil.generateAsBase64(qrCodeId, new QrConfig(), "png");\n\t\tQrCodeInfo info = QrCodeInfo.builder()\n                .qrCodeId(qrCodeId)\n                // \u5f85\u626b\u63cf\u72b6\u6001\n                .qrCodeStatus(0)\n                // 1\u5206\u949f\u540e\u8fc7\u671f\n                .expiresTime(LocalDateTime.now().plusMinutes(2L))\n                .build();\n\n\t\t// \u83b7\u53d6\u5f53\u524drequest\n\t\tRequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();\n\t\tif (requestAttributes != null) {\n\t\t\t// \u83b7\u53d6\u5f53\u524dsession\n\t\t\tHttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();\n\t\t\tHttpServletResponse response = ((ServletRequestAttributes) requestAttributes).getResponse();\n\t\t\tDefaultSavedRequest savedRequest = (DefaultSavedRequest) this.requestCache.getRequest(request, response);\n\t\t\tif (savedRequest != null) {\n\t\t\t\tif (!UrlUtils.isAbsoluteUrl(customSecurityProperties.getLoginUrl())) {\n\t\t\t\t\t// \u83b7\u53d6\u67e5\u8be2\u53c2\u6570\u4e0e\u8bf7\u6c42\u8def\u5f84\n\t\t\t\t\tString queryString = savedRequest.getQueryString();\n\t\t\t\t\tString requestUri = savedRequest.getRequestURI();\n\t\t\t\t\t// \u524d\u540e\u7aef\u4e0d\u5206\u79bb\u6839\u636e\u8bf7\u6c42\u8def\u5f84\u548c\u8bf7\u6c42\u53c2\u6570\u8df3\u8f6c\n\t\t\t\t\tinfo.setBeforeLoginRequestUri(requestUri);\n\t\t\t\t\tinfo.setBeforeLoginQueryString(queryString);\n\t\t\t\t}\n\n\t\t\t\t// \u83b7\u53d6\u8df3\u8f6c\u767b\u5f55\u4e4b\u524d\u8bbf\u95eeurl\u7684query parameter\n\t\t\t\tString[] scopes = savedRequest.getParameterValues("scope");\n\t\t\t\tif (!ObjectUtils.isEmpty(scopes)) {\n\t\t\t\t\t// \u4e0d\u4e3a\u7a7a\u83b7\u53d6\u7b2c\u4e00\u4e2a\u5e76\u8bbe\u7f6e\u8fdb\u4e8c\u7ef4\u7801\u4fe1\u606f\u4e2d\n\t\t\t\t\tinfo.setScopes(Set.of(scopes[0].split(" ")));\n\t\t\t\t}\n\t\t\t\t// \u524d\u7aef\u53ef\u4ee5\u6839\u636escope\u663e\u793a\u8981\u83b7\u53d6\u7684\u4fe1\u606f\uff0c\u6216\u56fa\u5b9a\u663e\u793a\u8981\u83b7\u53d6\u7684\u4fe1\u606f\n\t\t\t}\n\t\t}\n\n\t\t// \u56e0\u4e3a\u4e0a\u8fb9\u8bbe\u7f6e\u7684\u8fc7\u671f\u65f6\u95f4\u662f2\u5206\u949f\uff0c\u8fd9\u91cc\u8bbe\u7f6e10\u5206\u949f\u8fc7\u671f\uff0c\u53ef\u6839\u636e\u4e1a\u52a1\u81ea\u884c\u8c03\u6574\u8fc7\u671f\u65f6\u95f4\n\t\tredisOperator.set(QR_CODE_PREV + qrCodeId, info, QR_CODE_INFO_TIMEOUT);\n\t\treturn new QrCodeGenerateResponse(qrCodeId, pngQrCode);\n\t}\n\n\t@Override\n    public QrCodeLoginScanResponse scan(QrCodeLoginScanRequest loginScan) {\n\t\t// \u5e94\u8be5\u7528validation\u7684\n\t\tAssert.hasLength(loginScan.getQrCodeId(), "\u4e8c\u7ef4\u7801Id\u4e0d\u80fd\u4e3a\u7a7a.");\n\n\t\t// \u6821\u9a8c\u4e8c\u7ef4\u7801\u72b6\u6001\n\t\tQrCodeInfo info = redisOperator.get(QR_CODE_PREV + loginScan.getQrCodeId());\n\t\tif (info == null) {\n\n\t\t\tthrow new RuntimeException("\u65e0\u6548\u4e8c\u7ef4\u7801.");\n\t\t}\n\n\t\t// \u9a8c\u8bc1\u72b6\u6001\n\t\tif (!Objects.equals(info.getQrCodeStatus(), 0)) {\n\n\t\t\tthrow new RuntimeException("\u4e8c\u7ef4\u7801\u5df2\u88ab\u5176\u4ed6\u4eba\u626b\u63cf\uff0c\u65e0\u6cd5\u91cd\u590d\u626b\u63cf.");\n\t\t}\n\n\t\t// \u4e8c\u7ef4\u7801\u662f\u5426\u8fc7\u671f\n\t\tboolean qrCodeExpire = info.getExpiresTime().isBefore(LocalDateTime.now());\n\t\tif (qrCodeExpire) {\n\t\t\tthrow new RuntimeException("\u4e8c\u7ef4\u7801\u5df2\u8fc7\u671f.");\n\t\t}\n\n\t\tQrCodeLoginScanResponse loginScanResponse = new QrCodeLoginScanResponse();\n\n\t\t// \u83b7\u53d6\u767b\u5f55\u7528\u6237\u4fe1\u606f\n\t\tOAuth2Authorization oAuth2Authorization = this.getOAuth2Authorization();\n\t\tif (oAuth2Authorization == null) {\n\t\t\tthrow new OAuth2AuthenticationException(\n\t\t\t\t\tnew OAuth2Error(OAuth2ErrorCodes.INVALID_TOKEN, "\u767b\u5f55\u5df2\u8fc7\u671f.", null));\n\t\t}\n\t\t// app\u7aef\u4f7f\u7528\u5bc6\u7801\u6a21\u5f0f\u3001\u624b\u673a\u8ba4\u8bc1\u767b\u5f55\uff0c\u4e0d\u4f7f\u7528\u4e09\u65b9\u767b\u5f55\u7684\u60c5\u51b5\n\t\tUsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken =\n                oAuth2Authorization.getAttribute(Principal.class.getName());\n\t\tif (usernamePasswordAuthenticationToken.getPrincipal() instanceof Oauth2BasicUser basicUser) {\n\t\t\t// \u751f\u6210\u4e34\u65f6\u7968\u636e\n\t\t\tString qrCodeTicket = IdWorker.getIdStr();\n\t\t\t// \u6839\u636e\u4e8c\u7ef4\u7801id\u548c\u4e34\u65f6\u7968\u636e\u5b58\u50a8\uff0c\u786e\u8ba4\u65f6\u6839\u636e\u4e34\u65f6\u7968\u636e\u8ba4\u8bc1\n\t\t\tString redisQrCodeTicketKey = String.format("%s%s:%s", QR_CODE_PREV, loginScan.getQrCodeId(), qrCodeTicket);\n\t\t\tstringRedisOperator.set(redisQrCodeTicketKey, qrCodeTicket, QR_CODE_INFO_TIMEOUT);\n\n\t\t\t// \u66f4\u65b0\u4e8c\u7ef4\u7801\u4fe1\u606f\u7684\u72b6\u6001\n\t\t\tinfo.setQrCodeStatus(1);\n\t\t\tinfo.setName(basicUser.getName());\n\t\t\tinfo.setAvatarUrl(basicUser.getAvatarUrl());\n\t\t\tredisOperator.set(QR_CODE_PREV + loginScan.getQrCodeId(), info, QR_CODE_INFO_TIMEOUT);\n\n\t\t\t// \u5c01\u88c5\u54cd\u5e94\n\t\t\tloginScanResponse.setQrCodeTicket(qrCodeTicket);\n\t\t\tloginScanResponse.setQrCodeStatus(0);\n\t\t\tloginScanResponse.setExpired(Boolean.FALSE);\n\t\t\tloginScanResponse.setScopes(info.getScopes());\n\t\t}\n\n\t\t// \u5176\u5b83\u767b\u5f55\u65b9\u5f0f\u6682\u4e0d\u5904\u7406\n\t\treturn loginScanResponse;\n\t}\n\n\t@Override\n    public void consent(QrCodeLoginConsentRequest loginConsent) {\n\t\t// \u5e94\u8be5\u7528validation\u7684\n\t\tAssert.hasLength(loginConsent.getQrCodeId(), "\u4e8c\u7ef4\u7801Id\u4e0d\u80fd\u4e3a\u7a7a.");\n\n\t\t// \u6821\u9a8c\u4e8c\u7ef4\u7801\u72b6\u6001\n\t\tQrCodeInfo info = redisOperator.get(QR_CODE_PREV + loginConsent.getQrCodeId());\n\t\tif (info == null) {\n\t\t\tthrow new RuntimeException("\u65e0\u6548\u4e8c\u7ef4\u7801\u6216\u4e8c\u7ef4\u7801\u5df2\u8fc7\u671f.");\n\t\t}\n\n\t\t// \u9a8c\u8bc1\u4e34\u65f6\u7968\u636e\n\t\tString qrCodeTicketKey =\n                String.format("%s%s:%s", QR_CODE_PREV, loginConsent.getQrCodeId(), loginConsent.getQrCodeTicket());\n\t\tString redisQrCodeTicket = stringRedisOperator.get(qrCodeTicketKey);\n\t\tif (!Objects.equals(redisQrCodeTicket, loginConsent.getQrCodeTicket())) {\n\t\t\t// \u4e34\u65f6\u7968\u636e\u6709\u8bef\u3001\u4e34\u65f6\u7968\u636e\u5931\u6548(\u8d85\u8fc7redis\u5b58\u6d3b\u65f6\u95f4\u540e\u786e\u8ba4)\u3001redis\u6570\u636e\u6709\u8bef\n\t\t\tif (log.isDebugEnabled()) {\n\t\t\t\tlog.debug("\u4e34\u65f6\u7968\u636e\u6709\u8bef\u3001\u4e34\u65f6\u7968\u636e\u5931\u6548(\u8d85\u8fc7redis\u5b58\u6d3b\u65f6\u95f4\u540e\u786e\u8ba4)\u3001redis\u6570\u636e\u6709\u8bef.");\n\t\t\t}\n\t\t\tthrow new RuntimeException("\u767b\u5f55\u786e\u8ba4\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u626b\u63cf.");\n\t\t}\n\t\t// \u4f7f\u7528\u540e\u5220\u9664\n\t\tstringRedisOperator.delete(qrCodeTicketKey);\n\n\t\t// \u83b7\u53d6\u767b\u5f55\u7528\u6237\u4fe1\u606f\n\t\tOAuth2Authorization authorization = this.getOAuth2Authorization();\n\t\tif (authorization == null) {\n\t\t\tthrow new OAuth2AuthenticationException(\n\t\t\t\t\tnew OAuth2Error(OAuth2ErrorCodes.INVALID_TOKEN, "\u767b\u5f55\u5df2\u8fc7\u671f.", null));\n\t\t}\n\n\t\t// app\u7aef\u4f7f\u7528\u5bc6\u7801\u6a21\u5f0f\u3001\u624b\u673a\u8ba4\u8bc1\u767b\u5f55\uff0c\u4e0d\u4f7f\u7528\u4e09\u65b9\u767b\u5f55\u7684\u60c5\u51b5\n\t\tUsernamePasswordAuthenticationToken authenticationToken = authorization.getAttribute(Principal.class.getName());\n\n\t\t// \u6839\u636e\u4e8c\u7ef4\u7801id\u5b58\u50a8\u7528\u6237\u4fe1\u606f\n\t\tString redisUserinfoKey = String.format("%s%s:%s", QR_CODE_PREV, "userinfo", loginConsent.getQrCodeId());\n\t\t// \u5b58\u50a8\u7528\u6237\u4fe1\u606f\n\t\tauthenticationRedisOperator.set(redisUserinfoKey, authenticationToken, QR_CODE_INFO_TIMEOUT);\n\n\t\t// \u66f4\u65b0\u4e8c\u7ef4\u7801\u4fe1\u606f\u7684\u72b6\u6001\n\t\tinfo.setQrCodeStatus(2);\n\t\tredisOperator.set(QR_CODE_PREV + loginConsent.getQrCodeId(), info, QR_CODE_INFO_TIMEOUT);\n\t}\n\n\t@Override\n    public QrCodeLoginFetchResponse fetch(String qrCodeId) {\n\t\t// \u6821\u9a8c\u4e8c\u7ef4\u7801\u72b6\u6001\n\t\tQrCodeInfo info = redisOperator.get(QR_CODE_PREV + qrCodeId);\n\t\tif (info == null) {\n\t\t\tthrow new RuntimeException("\u65e0\u6548\u4e8c\u7ef4\u7801\u6216\u4e8c\u7ef4\u7801\u5df2\u8fc7\u671f.");\n\t\t}\n\n\t\tQrCodeLoginFetchResponse loginFetchResponse = new QrCodeLoginFetchResponse();\n\t\t// \u8bbe\u7f6e\u4e8c\u7ef4\u7801\u662f\u5426\u8fc7\u671f\u3001\u72b6\u6001\n\t\tloginFetchResponse.setQrCodeStatus(info.getQrCodeStatus());\n\t\tloginFetchResponse.setExpired(info.getExpiresTime().isBefore(LocalDateTime.now()));\n\n\t\tif (!Objects.equals(info.getQrCodeStatus(), 0)) {\n\t\t\t// \u5982\u679c\u662f\u5df2\u626b\u63cf/\u5df2\u786e\u8ba4\n\t\t\tloginFetchResponse.setName(info.getName());\n\t\t\tloginFetchResponse.setAvatarUrl(info.getAvatarUrl());\n\t\t}\n\n\t\t// \u5982\u679c\u662f\u5df2\u786e\u8ba4\uff0c\u5c06\u4e4b\u524d\u626b\u7801\u786e\u8ba4\u7684\u7528\u6237\u4fe1\u606f\u653e\u5165\u5f53\u524dsession\u4e2d\n\t\tif (Objects.equals(info.getQrCodeStatus(), 2)) {\n\n\t\t\t// \u6839\u636e\u4e8c\u7ef4\u7801id\u4eceredis\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n\t\t\tString redisUserinfoKey = String.format("%s%s:%s", QR_CODE_PREV, "userinfo", qrCodeId);\n\t\t\tUsernamePasswordAuthenticationToken authenticationToken = authenticationRedisOperator.get(redisUserinfoKey);\n\t\t\tif (authenticationToken != null) {\n\t\t\t\t// \u83b7\u53d6\u5f53\u524drequest\n\t\t\t\tRequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();\n\t\t\t\tif (requestAttributes == null) {\n\t\t\t\t\tthrow new RuntimeException("\u83b7\u53d6\u5f53\u524dRequest\u5931\u8d25.");\n\t\t\t\t}\n\t\t\t\t// \u83b7\u53d6\u5f53\u524dsession\n\t\t\t\tHttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();\n\t\t\t\tHttpSession session = request.getSession(Boolean.FALSE);\n\t\t\t\tif (session != null) {\n\t\t\t\t\t// \u83b7\u53d6\u5230\u8ba4\u8bc1\u4fe1\u606f\u540e\u5c06\u4e4b\u524d\u626b\u7801\u786e\u8ba4\u7684\u7528\u6237\u4fe1\u606f\u653e\u5165\u5f53\u524dsession\u4e2d\u3002\n\t\t\t\t\tsession.setAttribute(SPRING_SECURITY_CONTEXT_KEY, new SecurityContextImpl(authenticationToken));\n\n\t\t\t\t\t// \u64cd\u4f5c\u6210\u529f\u540e\u79fb\u9664\u7f13\u5b58\n\t\t\t\t\tredisOperator.delete(QR_CODE_PREV + qrCodeId);\n\t\t\t\t\t// \u5220\u9664\u7528\u6237\u4fe1\u606f\uff0c\u9632\u6b62\u5176\u5b83\u4eba\u91cd\u653e\u8bf7\u6c42\n\t\t\t\t\tauthenticationRedisOperator.delete(redisUserinfoKey);\n\n\t\t\t\t\t// \u586b\u5145\u4e8c\u7ef4\u7801\u6570\u636e\uff0c\u8bbe\u7f6e\u8df3\u8f6c\u5230\u767b\u5f55\u4e4b\u524d\u7684\u8bf7\u6c42\u8def\u5f84\u3001\u67e5\u8be2\u53c2\u6570\u548c\u662f\u5426\u6388\u6743\u7533\u8bf7\u8bf7\u6c42\n\t\t\t\t\tloginFetchResponse.setBeforeLoginRequestUri(info.getBeforeLoginRequestUri());\n\t\t\t\t\tloginFetchResponse.setBeforeLoginQueryString(info.getBeforeLoginQueryString());\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new RuntimeException("\u83b7\u53d6\u767b\u5f55\u786e\u8ba4\u7528\u6237\u4fe1\u606f\u5931\u8d25.");\n\t\t\t}\n\t\t}\n\n\t\treturn loginFetchResponse;\n\t}\n\n\t/**\n     * \u83b7\u53d6\u5f53\u524d\u4f7f\u7528token\u5bf9\u5e94\u7684\u8ba4\u8bc1\u4fe1\u606f\n     *\n     * @return oauth2\u8ba4\u8bc1\u4fe1\u606f\n     */\n    private OAuth2Authorization getOAuth2Authorization() {\n\t\t// \u6821\u9a8c\u767b\u5f55\u72b6\u6001\n\t\tAuthentication authentication = SecurityContextHolder.getContext().getAuthentication();\n\t\tif (authentication == null) {\n\t\t\tthrow new InsufficientAuthenticationException("\u672a\u767b\u5f55.");\n\t\t}\n\t\tif (authentication instanceof JwtAuthenticationToken jwtToken) {\n\t\t\t// jwt\u5904\u7406\n\t\t\tString tokenValue = jwtToken.getToken().getTokenValue();\n\t\t\t// \u6839\u636etoken\u83b7\u53d6\u6388\u6743\u767b\u5f55\u65f6\u7684\u8ba4\u8bc1\u4fe1\u606f(\u767b\u5f55\u7528\u6237)\n\t\t\treturn authorizationService.findByToken(tokenValue, OAuth2TokenType.ACCESS_TOKEN);\n\t\t}\n\t\treturn null;\n\t}\n\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5230\u6b64\u540e\u7aef\u90e8\u5206\u5c31\u5b8c\u6210\u4e86\uff0c\u5168\u5c40\u6839\u636e\u4e8c\u7ef4\u7801id\u5c06\u6574\u4e2a\u6d41\u7a0b\u4e32\u8054\u8d77\u6765\uff0c\u524d\u7aef\u8f6e\u8be2\u3001app\u7aef\u626b\u7801\u548c\u767b\u5f55\u786e\u8ba4\u90fd\u662f\u901a\u8fc7\u4e8c\u7ef4\u7801id\u6765\u7684\uff0c\u4e2d\u95f4\u501f\u52a9redis\u6765\u7f13\u5b58\u4e8c\u7ef4\u7801\u7684\u4fe1\u606f\uff0c\u4ee5\u786e\u4fdd\u6bcf\u4e2a\u7aef\u90fd\u53ef\u4ee5\u83b7\u53d6\u5230\u4e8c\u7ef4\u7801\u4fe1\u606f\uff0c\u8fd9\u6837\u5c31\u7b97\u96c6\u7fa4\u90e8\u7f72\u4e5f\u4e0d\u5f71\u54cd\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["\u73b0\u5728\u9ed8\u8ba4\u662f\u5c06app\u7aef\u5f53\u505aoauth2\u767b\u5f55\u7684\uff0c\u626b\u7801\u548c\u786e\u8ba4\u767b\u5f55\u90fd\u662f\u901a\u8fc7",(0,r.jsx)(e.code,{children:"access_token"}),"\u6765\u83b7\u53d6\u8ba4\u8bc1\u4fe1\u606f\u7684\uff0c\u6839\u636e\u8bf7\u6c42\u7684token\u83b7\u53d6oauth2\u6d41\u7a0b\u4e2d'\u767b\u5f55'\u751f\u6210\u7684\u8ba4\u8bc1\u4fe1\u606f\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"2-\u524d\u7aef\u5b9e\u73b0",children:"2. \u524d\u7aef\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.h4,{id:"1-\u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u8bf7\u6c42api",children:"1. \u7f16\u5199\u4e8c\u7ef4\u7801\u767b\u5f55\u8bf7\u6c42api"}),"\n",(0,r.jsxs)(e.p,{children:["\u7f16\u5199",(0,r.jsx)(e.code,{children:"src/api/QrCodeLogin.ts"}),"\u6587\u4ef6"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ts",children:"import loginRequest from '../util/http/LoginRequest'\n\n/**\n * \u751f\u6210\u4e8c\u7ef4\u7801\n */\nexport function generateQrCode() {\n    return loginRequest.get<any>({\n        url: '/qrCode/login/generateQrCode'\n    })\n}\n\n/**\n * \u83b7\u53d6\u4e8c\u7ef4\u7801\u4fe1\u606f\n * @param qrCodeId \u4e8c\u7ef4\u7801id\n */\nexport function fetch(qrCodeId: string) {\n    return loginRequest.get<any>({\n        url: `/qrCode/login/fetch/${qrCodeId}`\n    })\n}\n"})}),"\n",(0,r.jsx)(e.h4,{id:"2-\u5728\u767b\u5f55\u9875\u9762\u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u5165\u53e3",children:"2. \u5728\u767b\u5f55\u9875\u9762\u6dfb\u52a0\u4e8c\u7ef4\u7801\u767b\u5f55\u5165\u53e3"}),"\n",(0,r.jsxs)(e.p,{children:["\u524d\u7aef\u9875\u8f6e\u8be2\u65f6\u5982\u679c\u53d1\u73b0\u4e8c\u7ef4\u7801\u72b6\u6001\u53d8\u4e3a\u786e\u8ba4\u767b\u5f55\u5219\u4f1a\u91cd\u5b9a\u5411\u5230\u4e4b\u524d\u88ab\u62e6\u622a\u540e\u8df3\u8f6c\u5230\u767b\u5f55\u7684\u5730\u5740\uff0c\u4f8b\u5982\uff1a\u8bbf\u95ee",(0,r.jsx)(e.code,{children:"/a"}),"\u53d1\u73b0\u672a\u767b\u5f55\u7136\u540e\u8df3\u8f6c\u5230\u767b\u5f55",(0,r.jsx)(e.code,{children:"/login"}),"\uff0c\u4e4b\u540e\u626b\u7801\u767b\u5f55\u6d41\u7a0b\u8d70\u5b8c\u4ee5\u540e\u4f1a\u91cd\u5b9a\u5411\u81f3",(0,r.jsx)(e.code,{children:"/a"}),"\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-vue",children:'<script setup lang="ts">\nimport { ref } from \'vue\'\nimport router from \'../../router\'\nimport { getQueryString } from \'@/util/GlobalUtils\'\nimport { generateQrCode, fetch } from \'@/api/QrCodeLogin\'\nimport { type CountdownProps, createDiscreteApi } from \'naive-ui\'\nimport {\n  getImageCaptcha,\n  getSmsCaptchaByPhone,\n  loginSubmit\n} from \'@/api/Login\'\n\nconst { message } = createDiscreteApi([\'message\'])\n\n// \u767b\u5f55\u6309\u94ae\u52a0\u8f7d\u72b6\u6001\nconst loading = ref(false)\n\n// \u5b9a\u4e49\u767b\u5f55\u63d0\u4ea4\u7684\u5bf9\u8c61\nconst loginModel = ref({\n  code: \'\',\n  username: \'\',\n  password: \'\',\n  loginType: \'\',\n  captchaId: \'\'\n})\n\n// \u56fe\u5f62\u9a8c\u8bc1\u7801\u7684base64\u6570\u636e\nlet captchaImage = ref(\'\')\n// \u56fe\u5f62\u9a8c\u8bc1\u7801\u7684\u503c\nlet captchaCode = \'\'\n// \u662f\u5426\u5f00\u59cb\u5012\u8ba1\u65f6\nconst counterActive = ref(false)\n// \u662f\u5426\u663e\u793a\u4e09\u65b9\u767b\u5f55\nconst showThirdLogin = ref(true)\n\n// \u5b9a\u4e49\u4e8c\u7ef4\u7801\u4fe1\u606f\u7684\u5bf9\u8c61\nconst qrCodeInfo = ref({\n  qrCodeStatus: 0,\n  expired: false,\n  avatarUrl: \'\',\n  name: \'\',\n  scopes: []\n})\n\n// \u751f\u6210\u4e8c\u7ef4\u7801\u54cd\u5e94\u6570\u636e\nconst getQrCodeInfo = ref({\n  qrCodeId: \'\',\n  imageData: \'\'\n})\n\n// \u662f\u5426\u81ea\u52a8\u63d0\u4ea4\u6388\u6743\u786e\u8ba4(\u4e8c\u7ef4\u7801\u767b\u5f55\u81ea\u52a8\u63d0\u4ea4)\nconst autoConsentKey: string = \'autoConsent\'\n\n/**\n * \u83b7\u53d6\u56fe\u5f62\u9a8c\u8bc1\u7801\n */\nconst getCaptcha = () => {\n  getImageCaptcha()\n    .then((result: any) => {\n      if (result.success) {\n        captchaCode = result.data.code\n        captchaImage.value = result.data.imageData\n        loginModel.value.captchaId = result.data.captchaId\n      } else {\n        message.warning(result.message)\n      }\n    })\n    .catch((e: any) => {\n      message.warning(`\u83b7\u53d6\u56fe\u5f62\u9a8c\u8bc1\u7801\u5931\u8d25\uff1a${e.message}`)\n    })\n}\n\n/**\n * \u63d0\u4ea4\u767b\u5f55\u8868\u5355\n * @param type \u767b\u5f55\u7c7b\u578b\uff0cpasswordLogin\u662f\u5bc6\u7801\u6a21\u5f0f\uff0csmsCaptcha\u77ed\u4fe1\u767b\u5f55\n */\nconst submitLogin = (type: string) => {\n  loading.value = true\n  loginModel.value.loginType = type\n  loginSubmit(loginModel.value)\n    .then((result: any) => {\n      if (result.success) {\n        // \u79fb\u9664\u81ea\u52a8\u63d0\u4ea4\u7f13\u5b58\n        localStorage.removeItem(autoConsentKey)\n        // message.info(`\u767b\u5f55\u6210\u529f`)\n        let target = getQueryString(\'target\')\n        if (target) {\n          window.location.href = target\n        } else {\n          // \u8df3\u8f6c\u5230\u9996\u9875\n          router.push({ path: \'/\' })\n        }\n      } else {\n        message.warning(result.message)\n      }\n    })\n    .catch((e: any) => {\n      message.warning(`\u767b\u5f55\u5931\u8d25\uff1a${e.message}`)\n    })\n    .finally(() => {\n      loading.value = false\n    })\n}\n\n/**\n * \u83b7\u53d6\u77ed\u4fe1\u9a8c\u8bc1\u7801\n */\nconst getSmsCaptcha = () => {\n  if (!loginModel.value.username) {\n    message.warning(\'\u8bf7\u5148\u8f93\u5165\u624b\u673a\u53f7.\')\n    return\n  }\n  if (!loginModel.value.code) {\n    message.warning(\'\u8bf7\u5148\u8f93\u5165\u9a8c\u8bc1\u7801.\')\n    return\n  }\n  if (loginModel.value.code !== captchaCode) {\n    message.warning(\'\u9a8c\u8bc1\u7801\u9519\u8bef.\')\n    return\n  }\n  getSmsCaptchaByPhone({ phone: loginModel.value.username })\n    .then((result: any) => {\n      if (result.success) {\n        message.info(`\u83b7\u53d6\u77ed\u4fe1\u9a8c\u8bc1\u7801\u6210\u529f\uff0c\u56fa\u5b9a\u4e3a\uff1a${result.data}`)\n        counterActive.value = true\n      } else {\n        message.warning(result.message)\n      }\n    })\n    .catch((e: any) => {\n      message.warning(`\u83b7\u53d6\u77ed\u4fe1\u9a8c\u8bc1\u7801\u5931\u8d25\uff1a${e.message}`)\n    })\n}\n\n/**\n * \u5207\u6362\u65f6\u66f4\u65b0\u9a8c\u8bc1\u7801\n * @param name tab\u7684\u540d\u5b57\n */\nconst handleUpdateValue = (name: string) => {\n  // \u4e8c\u7ef4\u7801\u767b\u5f55\u65f6\u9690\u85cf\u4e09\u65b9\u767b\u5f55\n  showThirdLogin.value = name !== \'qrcode\'\n  if (!showThirdLogin.value) {\n    refreshQrCode()\n  } else {\n    getCaptcha()\n  }\n}\n\n/**\n * \u751f\u6210\u4e8c\u7ef4\u7801\n */\nconst refreshQrCode = () => {\n  generateQrCode()\n    .then((r) => {\n      getQrCodeInfo.value.qrCodeId = r.data.qrCodeId\n      getQrCodeInfo.value.imageData = r.data.imageData\n      // \u5f00\u59cb\u8f6e\u8be2\u83b7\u53d6\u4e8c\u7ef4\u7801\u4fe1\u606f\n      fetchQrCodeInfo(r.data.qrCodeId);\n    })\n    .catch((e: any) => {\n      message.warning(`\u751f\u6210\u4e8c\u7ef4\u7801\u5931\u8d25\uff1a${e.message}`)\n    })\n}\n\n/**\n * \u6839\u636e\u4e8c\u7ef4\u7801id\u8f6e\u8be2\u4e8c\u7ef4\u7801\u4fe1\u606f\n * @param qrCodeId \u4e8c\u7ef4\u7801id\n */\nconst fetchQrCodeInfo = (qrCodeId: string) => {\n  fetch(qrCodeId)\n    .then((r: any) => {\n      if (r.success) {\n        qrCodeInfo.value = r.data\n        if (qrCodeInfo.value.qrCodeStatus !== 0 && qrCodeInfo.value.avatarUrl) {\n          // \u53ea\u8981\u4e0d\u662f\u5f85\u626b\u63cf\u5e76\u4e14\u5934\u50cf\u4e0d\u4e3a\u7a7a\n          getQrCodeInfo.value.imageData = qrCodeInfo.value.avatarUrl\n        }\n\n        if (r.data.qrCodeStatus !== 2 && !qrCodeInfo.value.expired) {\n          if (!showThirdLogin.value) {\n            // \u663e\u793a\u4e09\u65b9\u767b\u5f55\u4ee3\u8868\u4e0d\u662f\u4e8c\u7ef4\u7801\u767b\u5f55\uff0c\u4e0d\u8f6e\u8be2\uff1b\u5426\u5219\u7ee7\u7eed\u8f6e\u8be2\n            // 1\u79d2\u540e\u91cd\u590d\u8c03\u7528\n            setTimeout(() => {\n              fetchQrCodeInfo(qrCodeId)\n            }, 1000);\n          }\n          return\n        }\n        if (qrCodeInfo.value.expired) {\n          // \u4e8c\u7ef4\u7801\u8fc7\u671f\n          return\n        }\n        if (qrCodeInfo.value.qrCodeStatus === 2) {\n          // \u5df2\u786e\u8ba4\n          let href = getQueryString(\'target\')\n          if (href) {\n            // \u786e\u8ba4\u540e\u5c06\u5730\u5740\u91cd\u5b9a\u5411\n            window.location.href = href\n          } else {\n            // \u8df3\u8f6c\u5230\u9996\u9875\n            router.push({ path: \'/\' })\n          }\n        }\n      } else {\n        message.warning(r.message)\n      }\n    })\n    .catch((e: any) => {\n      message.warning(`\u83b7\u53d6\u4e8c\u7ef4\u7801\u4fe1\u606f\u5931\u8d25\uff1a${e.message || e.statusText}`)\n    })\n}\n\n/**\n * \u5012\u8ba1\u65f6\u7ed3\u675f\n */\nconst onFinish = () => {\n  counterActive.value = false\n}\n\n/**\n * \u5012\u8ba1\u65f6\u663e\u793a\u5185\u5bb9\n */\nconst renderCountdown: CountdownProps[\'render\'] = ({ hours, minutes, seconds }) => {\n  return `${seconds}`\n}\n\n/**\n * \u6839\u636e\u7c7b\u578b\u53d1\u8d77OAuth2\u6388\u6743\u7533\u8bf7\n * @param type \u4e09\u65b9OAuth2\u767b\u5f55\u63d0\u4f9b\u5546\u7c7b\u578b\n */\nconst thirdLogin = (type: string) => {\n  window.location.href = `${import.meta.env.VITE_OAUTH_ISSUER}/oauth2/authorization/${type}`\n}\n\ngetCaptcha()\n<\/script>\n\n<template>\n  <header>\n    <img alt="Vue logo" class="logo" src="../../assets/logo.svg" width="125" height="125" />\n\n    <div class="wrapper">\n      <HelloWorld msg="\u7edf\u4e00\u8ba4\u8bc1\u5e73\u53f0" />\n    </div>\n  </header>\n\n  <main>\n    <n-card title="">\n      <n-tabs default-value="signin" size="large" justify-content="space-evenly" @update:value="handleUpdateValue">\n        <n-tab-pane name="signin" tab="\u8d26\u53f7\u767b\u5f55">\n          <n-form>\n            <n-form-item-row label="\u7528\u6237\u540d">\n              <n-input v-model:value="loginModel.username" placeholder="\u624b\u673a\u53f7 / \u90ae\u7bb1" />\n            </n-form-item-row>\n            <n-form-item-row label="\u5bc6\u7801">\n              <n-input v-model:value="loginModel.password" type="password" show-password-on="mousedown"\n                placeholder="\u5bc6\u7801" />\n            </n-form-item-row>\n            <n-form-item-row label="\u9a8c\u8bc1\u7801">\n              <n-input-group>\n                <n-input v-model:value="loginModel.code" placeholder="\u8bf7\u8f93\u5165\u9a8c\u8bc1\u7801" />\n                <n-image @click="getCaptcha" width="130" height="34" :src="captchaImage" preview-disabled />\n              </n-input-group>\n            </n-form-item-row>\n          </n-form>\n          <n-button type="info" :loading="loading" @click="submitLogin(\'passwordLogin\')" block strong>\n            \u767b\u5f55\n          </n-button>\n        </n-tab-pane>\n        <n-tab-pane name="signup" tab="\u77ed\u4fe1\u767b\u5f55">\n          <n-form>\n            <n-form-item-row label="\u624b\u673a\u53f7">\n              <n-input v-model:value="loginModel.username" placeholder="\u624b\u673a\u53f7 / \u90ae\u7bb1" />\n            </n-form-item-row>\n            <n-form-item-row label="\u9a8c\u8bc1\u7801">\n              <n-input-group>\n                <n-input v-model:value="loginModel.code" placeholder="\u8bf7\u8f93\u5165\u9a8c\u8bc1\u7801" />\n                <n-image @click="getCaptcha" width="130" height="34" :src="captchaImage" preview-disabled />\n              </n-input-group>\n            </n-form-item-row>\n            <n-form-item-row label="\u9a8c\u8bc1\u7801">\n              <n-input-group>\n                <n-input v-model:value="loginModel.password" placeholder="\u8bf7\u8f93\u5165\u9a8c\u8bc1\u7801" />\n                <n-button type="info" @click="getSmsCaptcha" style="width: 130px" :disabled="counterActive">\n                  \u83b7\u53d6\u9a8c\u8bc1\u7801\n                  <span v-if="counterActive">\n                    (\n                    <n-countdown :render="renderCountdown" :on-finish="onFinish" :duration="59 * 1000"\n                      :active="counterActive" />\n                    )</span>\n                </n-button>\n              </n-input-group>\n            </n-form-item-row>\n          </n-form>\n          <n-button type="info" :loading="loading" @click="submitLogin(\'smsCaptcha\')" block strong>\n            \u767b\u5f55\n          </n-button>\n        </n-tab-pane>\n        <n-tab-pane name="qrcode" tab="\u626b\u7801\u767b\u5f55" style="text-align: center">\n          <div style="margin: 5.305px">\n            <n-image width="300" :src="getQrCodeInfo.imageData" preview-disabled />\n          </div>\n        </n-tab-pane>\n      </n-tabs>\n      <n-divider style="font-size: 80%; color: #909399">\n        {{ showThirdLogin ? \'\u5176\u5b83\u767b\u5f55\u65b9\u5f0f\' : \'\u4f7f\u7528app\u626b\u63cf\u4e8c\u7ef4\u7801\u767b\u5f55\' }}\n      </n-divider>\n      <div class="other_login_icon" v-if="showThirdLogin">\n        <IconGitee :size="32" @click="thirdLogin(\'gitee\')" class="icon_item" />\n        <img width="36" height="36" @click="thirdLogin(\'github\')" src="../../assets/GitHub-Mark.png" class="icon_item" />\n        <img width="28" height="28" @click="thirdLogin(\'wechat\')" src="../../assets/wechat_login.png" class="icon_item" />\n      </div>\n    </n-card>\n  </main>\n</template>\n\n<style scoped>\n.other_login_icon {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 0 10px;\n  position: relative;\n  margin-top: -5px;\n}\n\n.icon_item {\n  cursor: pointer;\n}\n\nheader {\n  line-height: 1.5;\n}\n\n.logo {\n  display: block;\n  margin: 0 auto 2rem;\n}\n\n@media (min-width: 1024px) {\n  header {\n    display: flex;\n    place-items: center;\n    padding-right: calc(var(--section-gap) / 2);\n  }\n\n  .logo {\n    margin: 0 2rem 0 0;\n  }\n\n  header .wrapper {\n    display: flex;\n    place-items: flex-start;\n    flex-wrap: wrap;\n  }\n}\n</style>\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u5177\u4f53\u4fee\u6539\u5185\u5bb9\u8bf7\u770b\u4ee3\u7801\u4ed3\u5e93",(0,r.jsx)(e.a,{href:"https://gitee.com/vains-Sofia/authorization-example/tree/qrcode_login/",children:"qrcode_login"}),"\u5206\u652f\u7684",(0,r.jsx)(e.a,{href:"https://gitee.com/vains-Sofia/authorization-example/commit/8552c2c19d0040d8081b5da9fb0dfd31169c274b",children:"\u4e8c\u7ef4\u7801\u767b\u5f55\u524d\u7aef\u767b\u5f55\u9875\u9762\u5b9e\u73b0"}),"\u3002"]}),"\n",(0,r.jsx)(e.h2,{id:"\u4e09\u6548\u679c",children:"\u4e09\u3001\u6548\u679c"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{alt:"img",src:t(33240).A+"",width:"1905",height:"981"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-shell",children:"# 1. \u5148\u83b7\u53d6\u4e00\u4e2aToken\u5907\u7528\n\n# 2. \u6d4f\u89c8\u5668\u8bbf\u95ee\u767b\u5f55\u9875\uff0c\u5207\u6362\u5230\u626b\u7801\u767b\u5f55\u9875\u7b7e\nhttp://127.0.0.1:5173/login\n\n# 3. F12 \u6253\u5f00\u63a7\u5236\u53f0\u590d\u5236\u4e8c\u7ef4\u7801\u7684ID 1760855300433031170\n\n# 4. \u643a\u5e26\u4e8c\u7ef4\u7801ID\u8c03\u7528\u626b\u63cf\u4e8c\u7ef4\u7801\u63a5\u53e3 (\u9700\u643a\u5e26Bearer Token)\n# POST http://127.0.0.1:8080/qrCode/scan\n\n# 5. \u643a\u5e26\u4e8c\u7ef4\u7801ID\u548c\u626b\u63cf\u8fd4\u56de\u7684ticket\u8c03\u7528\u786e\u8ba4\u767b\u5f55\u63a5\u53e3 (\u9700\u643a\u5e26Bearer Token)\n# POST http://127.0.0.1:8080/qrCode/consent\n\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u626b\u7801\u767b\u5f55\u662f\u4f7f\u7528\u3010\u4e00\u53f0\u5df2\u7ecf\u767b\u5f55\u7cfb\u7edf\u8d26\u53f7\u7684\u8bbe\u5907\u3011\u6765\u626b\u63cf\u4e00\u4e2a\u65b0\u7684\u767b\u5f55\u9875\u9762\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u524d\u51c6\u5907\u4e00\u4e2aToken\uff0c\u8fdb\u884c\u540e\u9762\u7684\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.h2,{id:"\u56db\u9644\u5f55",children:"\u56db\u3001\u9644\u5f55"}),"\n",(0,r.jsxs)(e.p,{children:["\u4ee3\u7801\u4ed3\u5e93\uff1a",(0,r.jsx)(e.a,{href:"https://gitee.com/vains-Sofia/authorization-example",children:"Gitee"}),"\u3001",(0,r.jsx)(e.a,{href:"https://github.com/vains-Sofia/authorization-example",children:"Github"})]}),"\n",(0,r.jsx)(e.h2,{id:"\u4e94\u53c2\u8003\u8d44\u6599",children:"\u4e94\u3001\u53c2\u8003\u8d44\u6599"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.cnblogs.com/GoodHelper/p/8643071.html",children:"SpringBoot\u4e8c\u7ef4\u7801\u767b\u5f55(\u4e2d)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://blog.51cto.com/solarboy/2154188",children:"\u53cd\u5411\u5de5\u7a0b\u89e3\u6790QQ\u626b\u7801\u767b\u5f55\u7684OAuth2\u6d41\u7a0b"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://juejin.cn/post/6844904111398191117",children:"\u804a\u4e00\u804a\u4e8c\u7ef4\u7801\u626b\u63cf\u767b\u5f55\u539f\u7406"})}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},33240:(n,e,t)=>{t.d(e,{A:()=>r});const r=t.p+"assets/images/20-1-b75def94f65e061f7f0861192b67e9bc.awebp"},28453:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>a});var r=t(96540);const o={},i=r.createContext(o);function s(n){const e=r.useContext(i);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:s(n.components),r.createElement(i.Provider,{value:e},n.children)}}}]);