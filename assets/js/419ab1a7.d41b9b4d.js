"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[5140],{3905:(t,e,n)=>{n.d(e,{Zo:()=>s,kt:()=>g});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function p(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},l=Object.keys(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var u=a.createContext({}),o=function(t){var e=a.useContext(u),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},s=function(t){var e=o(t.components);return a.createElement(u.Provider,{value:e},t.children)},d="mdxType",m={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},k=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,l=t.originalType,u=t.parentName,s=p(t,["components","mdxType","originalType","parentName"]),d=o(n),k=r,g=d["".concat(u,".").concat(k)]||d[k]||m[k]||l;return n?a.createElement(g,i(i({ref:e},s),{},{components:n})):a.createElement(g,i({ref:e},s))}));function g(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=n.length,i=new Array(l);i[0]=k;var p={};for(var u in e)hasOwnProperty.call(e,u)&&(p[u]=e[u]);p.originalType=t,p[d]="string"==typeof t?t:r,i[1]=p;for(var o=2;o<l;o++)i[o]=n[o];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},7108:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>u,contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>p,toc:()=>o});var a=n(87462),r=(n(67294),n(3905));const l={},i=void 0,p={unversionedId:"zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break-With-MinIO",id:"zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break-With-MinIO",title:"File-Upload-Split-Continue-on-Break-With-MinIO",description:"- SpringBoot \u6574\u5408 MinIO \u5b9e\u73b0\u89c6\u9891\u7684\u5206\u7247\u4e0a\u4f20/\u65ad\u70b9\u7eed\u4f20",source:"@site/docs/zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break-With-MinIO.md",sourceDirName:"zh-cn/spring-boot/file",slug:"/zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break-With-MinIO",permalink:"/light-docusaurus/docs/zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break-With-MinIO",draft:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break-With-MinIO.md",tags:[],version:"current",frontMatter:{},sidebar:"troch",previous:{title:"File-Upload-Split-Continue-on-Break",permalink:"/light-docusaurus/docs/zh-cn/spring-boot/file/File-Upload-Split-Continue-on-Break"},next:{title:"Spring Cloud",permalink:"/light-docusaurus/docs/category/spring-cloud"}},u={},o=[{value:"1\u3001\u524d\u8a00",id:"1\u524d\u8a00",level:2},{value:"2\u3001\u6570\u636e\u5e93\u7ed3\u6784",id:"2\u6570\u636e\u5e93\u7ed3\u6784",level:2},{value:"3\u3001\u540e\u7aef\u5b9e\u73b0",id:"3\u540e\u7aef\u5b9e\u73b0",level:2},{value:"3.1\u3001\u6839\u636eMD5\u83b7\u53d6\u662f\u5426\u5b58\u5728\u76f8\u540c\u6587\u4ef6",id:"31\u6839\u636emd5\u83b7\u53d6\u662f\u5426\u5b58\u5728\u76f8\u540c\u6587\u4ef6",level:3},{value:"3.2\u3001\u521d\u59cb\u5316\u4e00\u4e2a\u4e0a\u4f20\u4efb\u52a1",id:"32\u521d\u59cb\u5316\u4e00\u4e2a\u4e0a\u4f20\u4efb\u52a1",level:3},{value:"3.3\u3001\u83b7\u53d6\u6bcf\u4e2a\u5206\u7247\u7684\u9884\u7b7e\u540d\u4e0a\u4f20\u5730\u5740",id:"33\u83b7\u53d6\u6bcf\u4e2a\u5206\u7247\u7684\u9884\u7b7e\u540d\u4e0a\u4f20\u5730\u5740",level:3},{value:"3.4\u3001\u5408\u5e76\u5206\u7247",id:"34\u5408\u5e76\u5206\u7247",level:3},{value:"4\u3001\u5206\u7247\u6587\u4ef6\u6e05\u7406\u95ee\u9898",id:"4\u5206\u7247\u6587\u4ef6\u6e05\u7406\u95ee\u9898",level:2}],s={toc:o},d="wrapper";function m(t){let{components:e,...l}=t;return(0,r.kt)(d,(0,a.Z)({},s,l,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://mp.weixin.qq.com/s/Vy9pG4CncXpgxg_-YkGuwg"},"SpringBoot \u6574\u5408 MinIO \u5b9e\u73b0\u89c6\u9891\u7684\u5206\u7247\u4e0a\u4f20/\u65ad\u70b9\u7eed\u4f20")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.csdn.net/weixin_44153131/article/details/129249169"},"SpringBoot \u6574\u5408 MinIO \u5b9e\u73b0\u89c6\u9891\u7684\u5206\u7247\u4e0a\u4f20/\u65ad\u70b9\u7eed\u4f20"))),(0,r.kt)("h2",{id:"1\u524d\u8a00"},"1\u3001\u524d\u8a00"),(0,r.kt)("p",null,"\u4e4b\u524d\u505a\u4e86\u4e00\u4e2a\u6155\u8bfe\u7f51\u4e0a\u7684\u4eff\u77ed\u89c6\u9891\u5f00\u53d1\uff0c\u91cc\u9762\u6709\u5f88\u591a\u6bd4\u8f83\u7c97\u7cd9\u7684\u5b9e\u73b0\uff0c\u6bd4\u5982\u89c6\u9891\u4e0a\u4f20\u90e8\u5206\u662f\u76f4\u63a5\u7531\u524d\u7aef\u4e0a\u4f20\u4e91\u670d\u52a1\uff0c\u6ca1\u8003\u8651\u5230\u5ba2\u6237\u7684\u7f51\u7edc\u73af\u5883\u8d28\u91cf\u7b49\u95ee\u9898\uff0c\u5982\u679c\u4e00\u4e2a\u89c6\u9891\u5feb\u4e0a\u4f20\u5b8c\u4e86\uff0c\u4f46\u662f\u7f51\u65ad\u4e86\u6ca1\u6709\u4e0a\u4f20\u5b8c\u6210\u9700\u8981\u5ba2\u6237\u91cd\u65b0\u4e0a\u4f20\uff0c\u8fd9\u5bf9\u4e8e\u7528\u6237\u4f53\u9a8c\u662f\u6781\u5dee\u7684\u3002"),(0,r.kt)("p",null,"\u90a3\u4e48\u6211\u4eec\u5bf9\u4e8e\u89c6\u9891\u6587\u4ef6\u7684\u4e0a\u4f20\u53ef\u4ee5\u91c7\u53d6\u65ad\u70b9\u7eed\u4f20\uff0c\u4e0a\u4f20\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u51fa\u73b0\u7f51\u7edc\u5f02\u5e38\u6216\u7a0b\u5e8f\u5d29\u6e83\u5bfc\u81f4\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25\u65f6\uff0c\u5c06\u4ece\u65ad\u70b9\u8bb0\u5f55\u5904\u7ee7\u7eed\u4e0a\u4f20\u672a\u4e0a\u4f20\u5b8c\u6210\u7684\u90e8\u5206\uff0c\u65ad\u70b9\u7eed\u4f20\u4f9d\u8d56\u4e8eMD5\u548c\u5206\u7247\u4e0a\u4f20\uff0c\u5bf9\u4e8e\u672cdemo\u5206\u7247\u4e0a\u4f20\u7684\u6d41\u7a0b\u5982\u56fe"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"img",src:n(76264).Z,width:"1080",height:"1166"})),(0,r.kt)("p",null,"\u901a\u8fc7\u6587\u4ef6\u552f\u4e00\u6807\u8bc6MD5\uff0c\u5728\u6570\u636e\u5e93\u4e2d\u67e5\u8be2\u6b64\u524d\u662f\u5426\u521b\u5efa\u8fc7\u8be5SysUploadTask\uff0c\u5982\u679c\u5b58\u5728\uff0c\u76f4\u63a5\u8fd4\u56deTaskInfo\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u901a\u8fc7amazonS3\u83b7\u53d6\u5230UploadId\u5e76\u65b0\u5efa\u4e00\u4e2aSysUploadTask\u8fd4\u56de\u3002"),(0,r.kt)("p",null,"\u524d\u7aef\u5c06\u6587\u4ef6\u5206\u597d\u7247\u540e\uff0c\u901a\u8fc7\u670d\u52a1\u5668\u5f97\u5230\u6bcf\u4e00\u7247\u7684\u4e00\u4e2a\u9884\u5730\u5740\uff0c\u7136\u540e\u7531\u524d\u7aef\u76f4\u63a5\u5411minio\u670d\u52a1\u5668\u53d1\u8d77\u771f\u6b63\u7684\u4e0a\u4f20\u8bf7\u6c42\uff0c\u907f\u514d\u4e0a\u4f20\u65f6\u5360\u7528\u5e94\u7528\u670d\u52a1\u5668\u7684\u5e26\u5bbd\uff0c\u5f71\u54cd\u7cfb\u7edf\u7a33\u5b9a\u3002\u6700\u540e\u518d\u5411\u540e\u7aef\u670d\u52a1\u5668\u53d1\u8d77\u5408\u5e76\u8bf7\u6c42\u3002"),(0,r.kt)("h2",{id:"2\u6570\u636e\u5e93\u7ed3\u6784"},"2\u3001\u6570\u636e\u5e93\u7ed3\u6784"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"\u5217\u540d"),(0,r.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,r.kt)("th",{parentName:"tr",align:null},"\u957f\u5ea6"),(0,r.kt)("th",{parentName:"tr",align:null},"\u53ef\u5426\u4e3aNULL"),(0,r.kt)("th",{parentName:"tr",align:null},"\u662f\u5426\u4e3b\u952e"),(0,r.kt)("th",{parentName:"tr",align:null},"\u6ce8\u91ca"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"id"),(0,r.kt)("td",{parentName:"tr",align:null},"BIGINT"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"TRUE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u4e3b\u952e")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"upload_id"),(0,r.kt)("td",{parentName:"tr",align:null},"VARCHAR"),(0,r.kt)("td",{parentName:"tr",align:null},"255"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5206\u7247\u4e0a\u4f20\u7684UploadId")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"file_identifier"),(0,r.kt)("td",{parentName:"tr",align:null},"VARCHAR"),(0,r.kt)("td",{parentName:"tr",align:null},"500"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6587\u4ef6\u552f\u4e00\u6807\u8bc6 (MD5)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"file_name"),(0,r.kt)("td",{parentName:"tr",align:null},"VARCHAR"),(0,r.kt)("td",{parentName:"tr",align:null},"500"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6587\u4ef6\u540d")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"bucket_name"),(0,r.kt)("td",{parentName:"tr",align:null},"VARCHAR"),(0,r.kt)("td",{parentName:"tr",align:null},"255"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6240\u5c5e\u6876\u540d")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"object_key"),(0,r.kt)("td",{parentName:"tr",align:null},"VARCHAR"),(0,r.kt)("td",{parentName:"tr",align:null},"500"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6587\u4ef6\u7684key")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"total_size"),(0,r.kt)("td",{parentName:"tr",align:null},"BIGINT"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6587\u4ef6\u5927\u5c0f (byte)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"chunk_size"),(0,r.kt)("td",{parentName:"tr",align:null},"BIGINT"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5206\u7247\u5927\u5c0f (byte)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"chunk_num"),(0,r.kt)("td",{parentName:"tr",align:null},"INT"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"FALSE"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5206\u7247\u6570\u91cf")))),(0,r.kt)("h2",{id:"3\u540e\u7aef\u5b9e\u73b0"},"3\u3001\u540e\u7aef\u5b9e\u73b0"),(0,r.kt)("h3",{id:"31\u6839\u636emd5\u83b7\u53d6\u662f\u5426\u5b58\u5728\u76f8\u540c\u6587\u4ef6"},"3.1\u3001\u6839\u636eMD5\u83b7\u53d6\u662f\u5426\u5b58\u5728\u76f8\u540c\u6587\u4ef6"),(0,r.kt)("p",null,"Controller\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u67e5\u8be2\u662f\u5426\u4e0a\u4f20\u8fc7\uff0c\u82e5\u5b58\u5728\uff0c\u8fd4\u56deTaskInfoDTO\n * @param identifier \u6587\u4ef6md5\n * @return\n */\n@GetMapping("/{identifier}")\npublic GraceJSONResult taskInfo (@PathVariable("identifier") String identifier) {\n    return GraceJSONResult.ok(sysUploadTaskService.getTaskInfo(identifier));\n}\n')),(0,r.kt)("p",null,"Service\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u67e5\u8be2\u662f\u5426\u4e0a\u4f20\u8fc7\uff0c\u82e5\u5b58\u5728\uff0c\u8fd4\u56deTaskInfoDTO\n * @param identifier\n * @return\n */\npublic TaskInfoDTO getTaskInfo(String identifier) {\n    SysUploadTask task = getByIdentifier(identifier);\n    if (task == null) {\n        return null;\n    }\n    TaskInfoDTO result = new TaskInfoDTO().setFinished(true).setTaskRecord(TaskRecordDTO.convertFromEntity(task)).setPath(getPath(task.getBucketName(), task.getObjectKey()));\n\n    boolean doesObjectExist = amazonS3.doesObjectExist(task.getBucketName(), task.getObjectKey());\n    if (!doesObjectExist) {\n        // \u672a\u4e0a\u4f20\u5b8c\uff0c\u8fd4\u56de\u5df2\u4e0a\u4f20\u7684\u5206\u7247\n        ListPartsRequest listPartsRequest = new ListPartsRequest(task.getBucketName(), task.getObjectKey(), task.getUploadId());\n        PartListing partListing = amazonS3.listParts(listPartsRequest);\n        result.setFinished(false).getTaskRecord().setExitPartList(partListing.getParts());\n    }\n    return result;\n}\n")),(0,r.kt)("h3",{id:"32\u521d\u59cb\u5316\u4e00\u4e2a\u4e0a\u4f20\u4efb\u52a1"},"3.2\u3001\u521d\u59cb\u5316\u4e00\u4e2a\u4e0a\u4f20\u4efb\u52a1"),(0,r.kt)("p",null,"Controller\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u521b\u5efa\u4e00\u4e2a\u4e0a\u4f20\u4efb\u52a1\n * @return\n */\n@PostMapping\npublic GraceJSONResult initTask (@Valid @RequestBody InitTaskParam param) {\n    return GraceJSONResult.ok(sysUploadTaskService.initTask(param));\n}\n")),(0,r.kt)("p",null,"Service\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u521d\u59cb\u5316\u4e00\u4e2a\u4efb\u52a1\n */\npublic TaskInfoDTO initTask(InitTaskParam param) {\n\n    Date currentDate = new Date();\n    String bucketName = minioProperties.getBucketName();\n    String fileName = param.getFileName();\n    String suffix = fileName.substring(fileName.lastIndexOf(".")+1, fileName.length());\n    String key = StrUtil.format("{}/{}.{}", DateUtil.format(currentDate, "YYYY-MM-dd"), IdUtil.randomUUID(), suffix);\n    String contentType = MediaTypeFactory.getMediaType(key).orElse(MediaType.APPLICATION_OCTET_STREAM).toString();\n    ObjectMetadata objectMetadata = new ObjectMetadata();\n    objectMetadata.setContentType(contentType);\n    InitiateMultipartUploadResult initiateMultipartUploadResult = amazonS3\n            .initiateMultipartUpload(new InitiateMultipartUploadRequest(bucketName, key).withObjectMetadata(objectMetadata));\n    String uploadId = initiateMultipartUploadResult.getUploadId();\n\n    SysUploadTask task = new SysUploadTask();\n    int chunkNum = (int) Math.ceil(param.getTotalSize() * 1.0 / param.getChunkSize());\n    task.setBucketName(minioProperties.getBucketName())\n            .setChunkNum(chunkNum)\n            .setChunkSize(param.getChunkSize())\n            .setTotalSize(param.getTotalSize())\n            .setFileIdentifier(param.getIdentifier())\n            .setFileName(fileName)\n            .setObjectKey(key)\n            .setUploadId(uploadId);\n    sysUploadTaskMapper.insert(task);\n    return new TaskInfoDTO().setFinished(false).setTaskRecord(TaskRecordDTO.convertFromEntity(task)).setPath(getPath(bucketName, key));\n}\n')),(0,r.kt)("h3",{id:"33\u83b7\u53d6\u6bcf\u4e2a\u5206\u7247\u7684\u9884\u7b7e\u540d\u4e0a\u4f20\u5730\u5740"},"3.3\u3001\u83b7\u53d6\u6bcf\u4e2a\u5206\u7247\u7684\u9884\u7b7e\u540d\u4e0a\u4f20\u5730\u5740"),(0,r.kt)("p",null,"Controller\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u83b7\u53d6\u6bcf\u4e2a\u5206\u7247\u7684\u9884\u7b7e\u540d\u4e0a\u4f20\u5730\u5740\n * @param identifier\n * @param partNumber\n * @return\n */\n@GetMapping("/{identifier}/{partNumber}")\npublic GraceJSONResult preSignUploadUrl (@PathVariable("identifier") String identifier, @PathVariable("partNumber") Integer partNumber) {\n    SysUploadTask task = sysUploadTaskService.getByIdentifier(identifier);\n    if (task == null) {\n        return GraceJSONResult.error("\u5206\u7247\u4efb\u52a1\u4e0d\u5b58\u5728");\n    }\n    Map<String, String> params = new HashMap<>();\n    params.put("partNumber", partNumber.toString());\n    params.put("uploadId", task.getUploadId());\n    return GraceJSONResult.ok(sysUploadTaskService.genPreSignUploadUrl(task.getBucketName(), task.getObjectKey(), params));\n}\n')),(0,r.kt)("p",null,"Service\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u751f\u6210\u9884\u7b7e\u540d\u4e0a\u4f20url\n * @param bucket \u6876\u540d\n * @param objectKey \u5bf9\u8c61\u7684key\n * @param params \u989d\u5916\u7684\u53c2\u6570\n * @return\n */\npublic String genPreSignUploadUrl(String bucket, String objectKey, Map<String, String> params) {\n    Date currentDate = new Date();\n    Date expireDate = DateUtil.offsetMillisecond(currentDate, PRE_SIGN_URL_EXPIRE.intValue());\n    GeneratePresignedUrlRequest request = new GeneratePresignedUrlRequest(bucket, objectKey)\n            .withExpiration(expireDate).withMethod(HttpMethod.PUT);\n    if (params != null) {\n        params.forEach((key, val) -> request.addRequestParameter(key, val));\n    }\n    URL preSignedUrl = amazonS3.generatePresignedUrl(request);\n    return preSignedUrl.toString();\n}\n")),(0,r.kt)("h3",{id:"34\u5408\u5e76\u5206\u7247"},"3.4\u3001\u5408\u5e76\u5206\u7247"),(0,r.kt)("p",null,"Controller\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u5408\u5e76\u5206\u7247\n * @param identifier\n * @return\n */\n@PostMapping("/merge/{identifier}")\npublic GraceJSONResult merge (@PathVariable("identifier") String identifier) {\n    sysUploadTaskService.merge(identifier);\n    return GraceJSONResult.ok();\n}\n')),(0,r.kt)("p",null,"Service\u5c42"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u5408\u5e76\u5206\u7247\n * @param identifier\n */\npublic void merge(String identifier) {\n    SysUploadTask task = getByIdentifier(identifier);\n    if (task == null) {\n        throw new RuntimeException("\u5206\u7247\u4efb\u52a1\u4e0d\u5b58");\n    }\n\n    ListPartsRequest listPartsRequest = new ListPartsRequest(task.getBucketName(), task.getObjectKey(), task.getUploadId());\n    PartListing partListing = amazonS3.listParts(listPartsRequest);\n    List<PartSummary> parts = partListing.getParts();\n    if (!task.getChunkNum().equals(parts.size())) {\n        // \u5df2\u4e0a\u4f20\u5206\u5757\u6570\u91cf\u4e0e\u8bb0\u5f55\u4e2d\u7684\u6570\u91cf\u4e0d\u5bf9\u5e94\uff0c\u4e0d\u80fd\u5408\u5e76\u5206\u5757\n        throw new RuntimeException("\u5206\u7247\u7f3a\u5931\uff0c\u8bf7\u91cd\u65b0\u4e0a\u4f20");\n    }\n    CompleteMultipartUploadRequest completeMultipartUploadRequest = new CompleteMultipartUploadRequest()\n            .withUploadId(task.getUploadId())\n            .withKey(task.getObjectKey())\n            .withBucketName(task.getBucketName())\n            .withPartETags(parts.stream().map(partSummary -> new PartETag(partSummary.getPartNumber(), partSummary.getETag())).collect(Collectors.toList()));\n    CompleteMultipartUploadResult result = amazonS3.completeMultipartUpload(completeMultipartUploadRequest);\n}\n')),(0,r.kt)("h2",{id:"4\u5206\u7247\u6587\u4ef6\u6e05\u7406\u95ee\u9898"},"4\u3001\u5206\u7247\u6587\u4ef6\u6e05\u7406\u95ee\u9898"),(0,r.kt)("p",null,"\u89c6\u9891\u4e0a\u4f20\u4e00\u534a\u4e0d\u4e0a\u4f20\u4e86\uff0c\u600e\u4e48\u6e05\u7406\u788e\u7247\u5206\u7247\u3002"),(0,r.kt)("p",null,"\u53ef\u4ee5\u8003\u8651\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"sys_upload_task"),"\u8868\u4e2d\u65b0\u52a0\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"status"),"\u5b57\u6bb5\uff0c\u8868\u793a\u662f\u5426\u5408\u5e76\u5206\u7247\uff0c\u9ed8\u8ba4\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"false"),"\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"merge"),"\u8bf7\u6c42\u7ed3\u675f\u540e\u53d8\u66f4\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"true"),"\uff0c\u901a\u8fc7\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u5b9a\u671f\u6e05\u7406\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"status"),"\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"false"),"\u7684\u8bb0\u5f55\u3002\u53e6\u5916MinIO\u81ea\u8eab\u5bf9\u4e8e\u4e34\u65f6\u4e0a\u4f20\u7684\u5206\u7247\uff0c\u4f1a\u5b9e\u65bd\u5b9a\u65f6\u6e05\u7406\u3002"),(0,r.kt)("p",null,"Demo\u5730\u5740"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("a",{parentName:"p",href:"https://github.com/robinsyn/MinIO_Demo"},"https://github.com/robinsyn/MinIO_Demo"))))}m.isMDXComponent=!0},76264:(t,e,n)=>{n.d(e,{Z:()=>a});const a=n.p+"assets/images/file-upload-timeserial-9aaae6d441b5b33af2fe8fb1a869e30c.png"}}]);