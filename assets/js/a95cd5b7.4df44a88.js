"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[97709],{28453:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>p});var r=t(96540);const i={},o=r.createContext(i);function s(n){const e=r.useContext(o);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function p(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:s(n.components),r.createElement(o.Provider,{value:e},n.children)}},80476:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>p,default:()=>d,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"zh-cn/spring-boot/Spring-Boot-Ip-Ragion-Parse","title":"Spring-Boot-Ip-Ragion-Parse","description":"SpringBoot \u5feb\u901f\u5b9e\u73b0 IP \u5730\u5740\u89e3\u6790","source":"@site/docs/zh-cn/spring-boot/8-Spring-Boot-Ip-Ragion-Parse.md","sourceDirName":"zh-cn/spring-boot","slug":"/zh-cn/spring-boot/Spring-Boot-Ip-Ragion-Parse","permalink":"/docs/zh-cn/spring-boot/Spring-Boot-Ip-Ragion-Parse","draft":false,"unlisted":false,"editUrl":"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-boot/8-Spring-Boot-Ip-Ragion-Parse.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{},"sidebar":"troch","previous":{"title":"Spring-Boot-Ip-Address-Parse","permalink":"/docs/zh-cn/spring-boot/Spring-Boot-Ip-Address-Parse"},"next":{"title":"Spring-Boot-Json-Diff","permalink":"/docs/zh-cn/spring-boot/Spring-Boot-Json-Diff"}}');var i=t(74848),o=t(28453);const s={},p=void 0,l={},c=[{value:"\u5f15\u5165",id:"\u5f15\u5165",level:2},{value:"\u5f00\u53d1",id:"\u5f00\u53d1",level:2},{value:"\u5728\u7ebf\u89e3\u6790",id:"\u5728\u7ebf\u89e3\u6790",level:2},{value:"\u573a\u666f",id:"\u573a\u666f",level:2}];function a(n){const e={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.a,{href:"https://mp.weixin.qq.com/s/WTzN2RqgT4nP1xp9osdXrQ",children:"SpringBoot \u5feb\u901f\u5b9e\u73b0 IP \u5730\u5740\u89e3\u6790"}),"\n",(0,i.jsx)(e.a,{href:"https://juejin.cn/post/7130544273421762573",children:"Spring Boot(\u516b) \u5feb\u901f\u5b9e\u73b0 IP\u5730\u5740\u89e3\u6790"})]}),"\n",(0,i.jsx)(e.p,{children:"\u672c\u7bc7\u5e26\u5927\u5bb6\u5b9e\u8df5\u5728spring boot \u9879\u76ee\u4e2d\u83b7\u53d6\u8bf7\u6c42\u7684ip\u4e0e\u8be6\u7ec6\u5730\u5740\uff0c\u6211\u4eec\u7684\u5f88\u591a\u7f51\u7ad9app \u4e2d\u90fd\u5df2\u7ecf\u65b0\u589e\u4e86ip \u5730\u5740\u663e\u793a\uff0c\u5927\u5bb6\u4e5f\u53ef\u4ee5\u7528\u5728\u81ea\u5df1\u7684\u5f00\u53d1\u4e2d\uff0c\u663e\u5f97\u66f4\u9ad8\u7ea7\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u5f15\u5165",children:"\u5f15\u5165"}),"\n",(0,i.jsx)(e.p,{children:"\u5982\u679c\u4f7f\u7528\u672c\u5730ip \u89e3\u6790\u7684\u8bdd\uff0c\u6211\u4eec\u5c06\u4f1a\u501f\u52a9ip2region\uff0c\u8be5\u9879\u76ee\u7ef4\u62a4\u4e86\u4e00\u4efd\u8f83\u4e3a\u8be6\u7ec6\u7684\u672c\u5730ip \u5730\u5740\u5bf9\u5e94\u8868\uff0c\u5982\u679c\u4e3a\u4e86\u79bb\u7ebf\u73af\u5883\u7684\u4f7f\u7528\uff0c\u9700\u8981\u5bfc\u5165\u8be5\u9879\u76ee\u4f9d\u8d56\uff0c\u5e76\u6307\u5b9a\u7248\u672c\uff0c\u4e0d\u540c\u7248\u672c\u7684\u65b9\u6cd5\u53ef\u80fd\u5b58\u5728\u5dee\u5f02\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-xml",children:"\x3c!--    ip\u5e93--\x3e\n<dependency>\n <groupId>org.lionsoul</groupId>\n <artifactId>ip2region</artifactId>\n <version>2.6.3</version>\n</dependency>\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5b98\u65b9gitee\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.a,{href:"https://gitee.com/lionsoul/ip2region.git",children:"https://gitee.com/lionsoul/ip2region.git"})}),"\n",(0,i.jsx)(e.h2,{id:"\u5f00\u53d1",children:"\u5f00\u53d1"}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u4f7f\u7528\u65f6\u9700\u8981\u5c06 xdb \u6587\u4ef6\u4e0b\u8f7d\u5230\u5de5\u7a0b\u6587\u4ef6\u76ee\u5f55\u4e0b\uff0c\u4f7f\u7528ip2region\u5373\u4f7f\u662f\u5b8c\u5168\u57fa\u4e8e xdb \u6587\u4ef6\u7684\u67e5\u8be2\uff0c\u5355\u6b21\u67e5\u8be2\u54cd\u5e94\u65f6\u95f4\u5728\u5341\u5fae\u79d2\u7ea7\u522b\uff0c\u53ef\u901a\u8fc7\u5982\u4e0b\u4e24\u79cd\u65b9\u5f0f\u5f00\u542f\u5185\u5b58\u52a0\u901f\u67e5\u8be2\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"vIndex \u7d22\u5f15\u7f13\u5b58\uff1a \u4f7f\u7528\u56fa\u5b9a\u7684 512KiB \u7684\u5185\u5b58\u7a7a\u95f4\u7f13\u5b58 vector index \u6570\u636e\uff0c\u51cf\u5c11\u4e00\u6b21 IO \u78c1\u76d8\u64cd\u4f5c\uff0c\u4fdd\u6301\u5e73\u5747\u67e5\u8be2\u6548\u7387\u7a33\u5b9a\u572810-20\u5fae\u79d2\u4e4b\u95f4\u3002"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"xdb \u6574\u4e2a\u6587\u4ef6\u7f13\u5b58\uff1a \u5c06\u6574\u4e2a xdb \u6587\u4ef6\u5168\u90e8\u52a0\u8f7d\u5230\u5185\u5b58\uff0c\u5185\u5b58\u5360\u7528\u7b49\u540c\u4e8e xdb \u6587\u4ef6\u5927\u5c0f\uff0c\u65e0\u78c1\u76d8 IO \u64cd\u4f5c\uff0c\u4fdd\u6301\u5fae\u79d2\u7ea7\u522b\u7684\u67e5\u8be2\u6548\u7387\u3002"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'/**\n * ip\u67e5\u8be2\n */\n@Slf4j\npublic class IPUtil {\n\n    private static final String UNKNOWN = "unknown";\n\n    protected IPUtil(){ }\n\n    /**\n     * \u83b7\u53d6 IP\u5730\u5740\n     * \u4f7f\u7528 Nginx\u7b49\u53cd\u5411\u4ee3\u7406\u8f6f\u4ef6\uff0c \u5219\u4e0d\u80fd\u901a\u8fc7 request.getRemoteAddr()\u83b7\u53d6 IP\u5730\u5740\n     * \u5982\u679c\u4f7f\u7528\u4e86\u591a\u7ea7\u53cd\u5411\u4ee3\u7406\u7684\u8bdd\uff0cX-Forwarded-For\u7684\u503c\u5e76\u4e0d\u6b62\u4e00\u4e2a\uff0c\u800c\u662f\u4e00\u4e32IP\u5730\u5740\uff0c\n     * X-Forwarded-For\u4e2d\u7b2c\u4e00\u4e2a\u975e unknown\u7684\u6709\u6548IP\u5b57\u7b26\u4e32\uff0c\u5219\u4e3a\u771f\u5b9eIP\u5730\u5740\n     */\n    public static String getIpAddr(HttpServletRequest request) {\n        String ip = request.getHeader("x-forwarded-for");\n        if (ip == null || ip.length() == 0 || UNKNOWN.equalsIgnoreCase(ip)) {\n            ip = request.getHeader("Proxy-Client-IP");\n        }\n        if (ip == null || ip.length() == 0 || UNKNOWN.equalsIgnoreCase(ip)) {\n            ip = request.getHeader("WL-Proxy-Client-IP");\n        }\n        if (ip == null || ip.length() == 0 || UNKNOWN.equalsIgnoreCase(ip)) {\n            ip = request.getRemoteAddr();\n        }\n        return "0:0:0:0:0:0:0:1".equals(ip) ? "127.0.0.1" : ip;\n    }\n\n    public static  String getAddr(String ip){\n        String dbPath = "src/main/resources/ip2region/ip2region.xdb";\n        // 1\u3001\u4ece dbPath \u52a0\u8f7d\u6574\u4e2a xdb \u5230\u5185\u5b58\u3002\n        byte[] cBuff;\n        try {\n            cBuff = Searcher.loadContentFromFile(dbPath);\n        } catch (Exception e) {\n            log.info("failed to load content from `%s`: %s\\n", dbPath, e);\n            return null;\n        }\n\n        // 2\u3001\u4f7f\u7528\u4e0a\u8ff0\u7684 cBuff \u521b\u5efa\u4e00\u4e2a\u5b8c\u5168\u57fa\u4e8e\u5185\u5b58\u7684\u67e5\u8be2\u5bf9\u8c61\u3002\n        Searcher searcher;\n        try {\n            searcher = Searcher.newWithBuffer(cBuff);\n        } catch (Exception e) {\n           log.info("failed to create content cached searcher: %s\\n", e);\n            return null;\n        }\n        // 3\u3001\u67e5\u8be2\n        try {\n            String region = searcher.searchByStr(ip);\n            return region;\n        } catch (Exception e) {\n            log.info("failed to search(%s): %s\\n", ip, e);\n        }\n        return null;\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u91cc\u6211\u4eec\u5c06ip \u89e3\u6790\u5c01\u88c5\u6210\u4e00\u4e2a\u5de5\u5177\u7c7b\uff0c\u5305\u542b\u83b7\u53d6IP\u548cip \u5730\u5740\u89e3\u6790\u4e24\u4e2a\u65b9\u6cd5\uff0cip \u7684\u89e3\u6790\u53ef\u4ee5\u5728\u8bf7\u6c42\u4e2d\u83b7\u53d6\u3002\u83b7\u53d6\u5230ip\u540e\uff0c\u9700\u8981\u6839\u636eip \uff0c\u5728xdb \u4e2d\u67e5\u627e\u5bf9\u5e94\u7684IP\u5730\u5740\u7684\u89e3\u6790\uff0c\u7531\u4e8e\u662f\u672c\u5730\u6570\u636e\u5e93\u53ef\u80fd\u5b58\u5728\u4e00\u5b9a\u7684\u7f3a\u5931\uff0c\u90e8\u5206ip \u5b58\u5728\u65e0\u6cd5\u89e3\u6790\u7684\u60c5\u51b5\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u5728\u7ebf\u89e3\u6790",children:"\u5728\u7ebf\u89e3\u6790"}),"\n",(0,i.jsxs)(e.p,{children:["\u5982\u679c\u60f3\u8981\u83b7\u53d6\u66f4\u52a0\u5168\u9762\u7684ip \u5730\u5740\u4fe1\u606f\uff0c\u53ef\u4f7f\u7528\u5728\u7ebf\u6570\u636e\u5e93\uff0c\u8fd9\u91cc\u63d0\u4f9b\u7684\u662f ",(0,i.jsx)(e.code,{children:"whois.pconline.com"}),"  \u7684IP\u89e3\u6790\uff0c\u8be5IP\u89e3\u6790\u5728\u6211\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u8868\u73b0\u975e\u5e38\u6d41\u7545\uff0c\u800c\u4e14\u53ea\u6709\u5c11\u6570\u7684ip \u5b58\u5728\u65e0\u6cd5\u89e3\u6790\u7684\u60c5\u51b5\u3002"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'@Slf4j\npublic class AddressUtils {\n    // IP\u5730\u5740\u67e5\u8be2\n    public static final String IP_URL = "http://whois.pconline.com.cn/ipJson.jsp";\n\n    // \u672a\u77e5\u5730\u5740\n    public static final String UNKNOWN = "XX XX";\n\n    public static String getRealAddressByIP(String ip) {\n        String address = UNKNOWN;\n        // \u5185\u7f51\u4e0d\u67e5\u8be2\n        if (IpUtils.internalIp(ip)) {\n            return "\u5185\u7f51IP";\n        }\n        if (true) {\n            try {\n                String rspStr = sendGet(IP_URL, "ip=" + ip + "&json=true" ,"GBK");\n                if (StrUtil.isEmpty(rspStr)) {\n                    log.error("\u83b7\u53d6\u5730\u7406\u4f4d\u7f6e\u5f02\u5e38 {}" , ip);\n                    return UNKNOWN;\n                }\n                JSONObject obj = JSONObject.parseObject(rspStr);\n                String region = obj.getString("pro");\n                String city = obj.getString("city");\n                return String.format("%s %s" , region, city);\n            } catch (Exception e) {\n                log.error("\u83b7\u53d6\u5730\u7406\u4f4d\u7f6e\u5f02\u5e38 {}" , ip);\n            }\n        }\n        return address;\n    }\n\n    public static String sendGet(String url, String param, String contentType) {\n        StringBuilder result = new StringBuilder();\n        BufferedReader in = null;\n        try {\n            String urlNameString = url + "?" + param;\n            log.info("sendGet - {}" , urlNameString);\n            URL realUrl = new URL(urlNameString);\n            URLConnection connection = realUrl.openConnection();\n            connection.setRequestProperty("accept" , "*/*");\n            connection.setRequestProperty("connection" , "Keep-Alive");\n            connection.setRequestProperty("user-agent" , "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)");\n            connection.connect();\n            in = new BufferedReader(new InputStreamReader(connection.getInputStream(), contentType));\n            String line;\n            while ((line = in.readLine()) != null) {\n                result.append(line);\n            }\n            log.info("recv - {}" , result);\n        } catch (ConnectException e) {\n            log.error("\u8c03\u7528HttpUtils.sendGet ConnectException, url=" + url + ",param=" + param, e);\n        } catch (SocketTimeoutException e) {\n            log.error("\u8c03\u7528HttpUtils.sendGet SocketTimeoutException, url=" + url + ",param=" + param, e);\n        } catch (IOException e) {\n            log.error("\u8c03\u7528HttpUtils.sendGet IOException, url=" + url + ",param=" + param, e);\n        } catch (Exception e) {\n            log.error("\u8c03\u7528HttpsUtil.sendGet Exception, url=" + url + ",param=" + param, e);\n        } finally {\n            try {\n                if (in != null) {\n                    in.close();\n                }\n            } catch (Exception ex) {\n                log.error("\u8c03\u7528in.close Exception, url=" + url + ",param=" + param, ex);\n            }\n        }\n        return result.toString();\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u573a\u666f",children:"\u573a\u666f"}),"\n",(0,i.jsx)(e.p,{children:"\u90a3\u4e48\u5728\u5f00\u53d1\u7684\u4ec0\u4e48\u6d41\u7a0b\u83b7\u53d6ip \u5730\u5740\u662f\u6bd4\u8f83\u5408\u9002\u7684\uff0c\u8fd9\u91cc\u5c31\u8981\u7528\u5230\u6211\u4eec\u7684\u62e6\u622a\u5668\u4e86\u3002\u62e6\u622a\u8fdb\u5165\u670d\u52a1\u7684\u6bcf\u4e2a\u8bf7\u6c42\uff0c\u8fdb\u884c\u524d\u7f6e\u64cd\u4f5c\uff0c\u5728\u8fdb\u5165\u65f6\u5c31\u5b8c\u6210\u8bf7\u6c42\u5934\u7684\u89e3\u6790\uff0cip \u83b7\u53d6\u4ee5\u53caip \u5730\u5740\u89e3\u6790\uff0c\u8fd9\u6837\u5728\u540e\u7eed\u6d41\u7a0b\u7684\u5168\u73af\u8282\uff0c\u90fd\u53ef\u4ee5\u590d\u7528ip \u5730\u5740\u7b49\u4fe1\u606f\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'/**\n * \u5bf9ip \u8fdb\u884c\u9650\u5236\uff0c\u9632\u6b62IP\u5927\u91cf\u8bf7\u6c42\n */\n@Slf4j\n@Configuration\npublic class IpUrlLimitInterceptor implements HandlerInterceptor{\n\n    @Override\n    public boolean preHandle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o) {\n\n        //\u66f4\u65b0\u5168\u5c40\u53d8\u91cf\n        Constant.IP = IPUtil.getIpAddr(httpServletRequest);\n        Constant.IP_ADDR = AddressUtils.getRealAddressByIP(Constant.IP);\n        Constant.URL = httpServletRequest.getRequestURI();\n        return true;\n    }\n\n    @Override\n    public void postHandle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView) {\n        //\u901a\u8fc7\u672c\u5730\u83b7\u53d6\n//        \u83b7\u5f97ip\n//        String ip = IPUtil.getIpAddr(httpServletRequest);\n        //\u89e3\u6790\u5177\u4f53\u5730\u5740\n//        String addr = IPUtil.getAddr(ip);\n\n        //\u901a\u8fc7\u5728\u7ebf\u5e93\u83b7\u53d6\n//        String ip = IpUtils.getIpAddr(httpServletRequest);\n//        String ipaddr = AddressUtils.getRealAddressByIP(ipAddr);\n//        log.info("IP >> {},Address >> {}",ip,ipaddr);\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e) {\n\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u5982\u679c\u60f3\u8981\u6267\u884c\u6211\u4eec\u7684ip \u89e3\u6790\u62e6\u622a\u5668\uff0c\u9700\u8981\u5728spring boot\u7684\u89c6\u56fe\u5c42\u8fdb\u884c\u62e6\u622a\u624d\u4f1a\u89e6\u53d1\u6211\u4eec\u7684\u62e6\u622a\u5668\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'@Configuration\npublic class WebConfig implements WebMvcConfigurer {\n    @Autowired\n    IpUrlLimitInterceptor ipUrlLimitInterceptor;\n \n     //\u6267\u884cip\u62e6\u622a\u5668\n    @Override\n    public void addInterceptors(InterceptorRegistry registry){\n        registry.addInterceptor(ipUrlLimitInterceptor)\n                // \u62e6\u622a\u6240\u6709\u8bf7\u6c42\n                .addPathPatterns("/**");\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u8fc7\u8fd9\u6837\u7684\u4e00\u5957\u6d41\u7a0b\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u80fd\u5b9e\u73b0\u5bf9\u6bcf\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u884cip \u83b7\u53d6\u3001ip\u89e3\u6790\uff0c\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5e26\u4e0a\u5177\u4f53ip\u5730\u5740\u7684\u5c0f\u5c3e\u5df4\u3002"})]})}function d(n={}){const{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(a,{...n})}):a(n)}}}]);