"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[48332],{28453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>s});var t=r(96540);const a={},o=t.createContext(a);function l(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),t.createElement(o.Provider,{value:n},e.children)}},76900:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>p,frontMatter:()=>l,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect","title":"\u4ecb\u7ecd","description":"\u8fd9\u7bc7\u6587\u7ae0\u4ecb\u7ecd\u4e86\u4f7f\u7528K8s\u642d\u5efaPrometheus + Grafana\u7684\u670d\u52a1\u76d1\u63a7\u7cfb\u7edf\uff0c\u540c\u65f6\u5c06Loki + Promtail \u96c6\u6210\u8fdb\u6765\u7684\u5b9e\u64cd\u6b65\u9aa4\uff0c","source":"@site/docs/zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect.md","sourceDirName":"zh-cn/others","slug":"/zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect","permalink":"/docs/zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect","draft":false,"unlisted":false,"editUrl":"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/others/Loki-Promtail-Prometheus-Grafana-Implement-System-Monitor-And-log-Collect.md","tags":[],"version":"current","frontMatter":{},"sidebar":"troch","previous":{"title":"\u76f8\u5173\u94fe\u63a5","permalink":"/docs/zh-cn/others/Prometheus-Grafana-System-Monitor"},"next":{"title":"Github Speed UP","permalink":"/docs/zh-cn/awesome-open-source"}}');var a=r(74848),o=r(28453);const l={},s="\u4ecb\u7ecd",i={},c=[{value:"Helm \u90e8\u7f72 Prometheus Operator",id:"helm-\u90e8\u7f72-prometheus-operator",level:2},{value:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3",id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3",level:2},{value:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762",id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762",level:2},{value:"k8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49",id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49",level:2},{value:"\u90e8\u7f72\u8d44\u6e90",id:"\u90e8\u7f72\u8d44\u6e90",level:2},{value:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3",id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3-1",level:2},{value:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762",id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762-1",level:2},{value:"k8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49",id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49-1",level:2},{value:"\u90e8\u7f72\u8d44\u6e90",id:"\u90e8\u7f72\u8d44\u6e90-1",level:2},{value:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3",id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3-2",level:2},{value:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762",id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762-2",level:2},{value:"\u670d\u52a1\u6539\u9020",id:"\u670d\u52a1\u6539\u9020",level:2},{value:"\u6784\u5efa\u955c\u50cf",id:"\u6784\u5efa\u955c\u50cf",level:2},{value:"K8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49",id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49-2",level:2},{value:"\u90e8\u7f72\u8d44\u6e90",id:"\u90e8\u7f72\u8d44\u6e90-2",level:2},{value:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3",id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3-3",level:2},{value:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9",id:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9",level:2},{value:"\u542f\u52a8\u670d\u52a1",id:"\u542f\u52a8\u670d\u52a1",level:2},{value:"K8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49",id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49-3",level:2},{value:"\u90e8\u7f72\u8d44\u6e90",id:"\u90e8\u7f72\u8d44\u6e90-3",level:2},{value:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9",id:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9-1",level:2},{value:"\u5b89\u88c5Promtail",id:"\u5b89\u88c5promtail",level:2},{value:"\u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e\u6587\u4ef6",level:2},{value:"\u542f\u52a8\u670d\u52a1",id:"\u542f\u52a8\u670d\u52a1-1",level:2},{value:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762",id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762-3",level:2},{value:"\u672c\u5730\u90e8\u7f72Node-Exporter",id:"\u672c\u5730\u90e8\u7f72node-exporter",level:2},{value:"\u542f\u52a8\u670d\u52a1",id:"\u542f\u52a8\u670d\u52a1-2",level:2},{value:"K8s \u8d44\u6e90\u6587\u4ef6\u7684\u5b9a\u4e49",id:"k8s-\u8d44\u6e90\u6587\u4ef6\u7684\u5b9a\u4e49",level:2},{value:"\u90e8\u7f72\u8d44\u6e90",id:"\u90e8\u7f72\u8d44\u6e90-4",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"\u4ecb\u7ecd",children:"\u4ecb\u7ecd"})}),"\n",(0,a.jsxs)(n.p,{children:["\u8fd9\u7bc7\u6587\u7ae0\u4ecb\u7ecd\u4e86\u4f7f\u7528K8s\u642d\u5efaPrometheus + Grafana\u7684\u670d\u52a1\u76d1\u63a7\u7cfb\u7edf\uff0c\u540c\u65f6\u5c06Loki + Promtail \u96c6\u6210\u8fdb\u6765\u7684\u5b9e\u64cd\u6b65\u9aa4\uff0c\n\u96c6\u5408\u4e86",(0,a.jsx)(n.a,{href:"/docs/zh-cn/others/LPG-Log-Collect",children:"Prometheus\u670d\u52a1\u76d1\u63a7"})," \u548c ",(0,a.jsx)(n.a,{href:"/docs/zh-cn/others/Prometheus-Grafana-System-Monitor",children:"LPG\u65e5\u5fd7\u6536\u96c6\u65b9\u6848"})," \u4e24\u7bc7\u6587\u7ae0\u5185\u5bb9\uff0c\u5bf9\u4e8e\u7ec6\u8282\u8bf7\u53c2\u8003\u539f\u6587\u7ae0\u3002"]}),"\n",(0,a.jsx)(n.h1,{id:"\u524d\u7f6e\u8981\u6c42",children:"\u524d\u7f6e\u8981\u6c42"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"\u5b89\u88c5Docker"}),"\n",(0,a.jsx)(n.li,{children:"\u5b89\u88c5Kubernetes"}),"\n",(0,a.jsx)(n.li,{children:"\u5b89\u88c5JDK"}),"\n"]}),"\n",(0,a.jsx)(n.h1,{id:"\u51c6\u5907\u5de5\u4f5c",children:"\u51c6\u5907\u5de5\u4f5c"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# Spring Boot\u670d\u52a1\u6253\u5305\u57fa\u7840\u955c\u50cf\ndocker pull azul/zulu-openjdk-centos:17-jre-latest\n\n# Loki + Promtail + Grafana\ndocker pull grafana/loki:3.5.1\ndocker pull grafana/promtail:3.5.1\ndocker pull grafana/grafana:12.0.1\n\n# Prometheus Operator\ndocker pull quay.io/prometheus/prometheus:v3.4.1\ndocker pull quay.io/prometheus/alertmanager:v0.28.1\ndocker pull quay.io/prometheus/node-exporter:v1.9.1\ndocker pull quay.io/prometheus-operator/admission-webhook:v0.82.2\ndocker pull quay.io/prometheus-operator/prometheus-operator:v0.82.2\ndocker pull quay.io/prometheus-operator/prometheus-config-reloader:v0.82.2\ndocker pull quay.io/thanos/thanos:v0.38.0\ndocker pull registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.5.3\ndocker pull registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.15.0\n\n# registry.k8s.io \u62c9\u53d6\u5931\u8d25\uff0c\u4f7f\u7528\u4ee3\u7406\u62c9\u53d6\uff0c\u62c9\u53d6\u6210\u529f\u540e\u91cd\u65b0\u6253tag\u5373\u53ef\ndocker pull k8s.mirror.nju.edu.cn/ingress-nginx/kube-webhook-certgen:v1.5.3\ndocker tag  k8s.mirror.nju.edu.cn/ingress-nginx/kube-webhook-certgen:v1.5.3 registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.5.3\ndocker pull k8s.mirror.nju.edu.cn/kube-state-metrics/kube-state-metrics:v2.15.0\ndocker tag  k8s.mirror.nju.edu.cn/kube-state-metrics/kube-state-metrics:v2.15.0 registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.15.0\n\n# Prometheus Operator \u7684 Helm Chart \nwget https://github.com/prometheus-community/helm-charts/releases/download/kube-prometheus-stack-73.2.0/kube-prometheus-stack-73.2.0.tgz\n\n# Promtail \u5b89\u88c5\u5305\u3001\u914d\u7f6e\u6587\u4ef6\nwget https://github.com/grafana/loki/releases/download/v3.5.1/promtail-linux-amd64.zip\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/clients/cmd/promtail/promtail-local-config.yaml\n\n# Prometheus node-exporter\nwget https://github.com/prometheus/node_exporter/releases/download/v1.9.1/node_exporter-1.9.1.linux-amd64.tar.gz\n\n"})}),"\n",(0,a.jsx)(n.h1,{id:"k8s-\u90e8\u7f72-prometheus--grafana",children:"K8s \u90e8\u7f72 Prometheus + Grafana"}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u91cc\u4f7f\u7528Helm Chart\u90e8\u7f72 Prometheus Operator\uff0c\u5176\u4e2d\u5305\u542b\u4e86Grafana\u7684\u90e8\u7f72"}),"\n",(0,a.jsx)(n.h2,{id:"helm-\u90e8\u7f72-prometheus-operator",children:"Helm \u90e8\u7f72 Prometheus Operator"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'# \u6dfb\u52a0chart\u4ed3\u5e93\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\n\n# \u66f4\u65b0chart\u4ed3\u5e93\nhelm repo update\n\n# \u4e0b\u8f7dchart\u5b89\u88c5\u5305\nhelm pull prometheus-community/kube-prometheus-stack --version 73.2.0\n\n# \u89e3\u538b\ntar -zxvf kube-prometheus-stack-73.2.0.tgz -C ~/\ncd ~/kube-prometheus-stack\n\n# \u67e5\u770b\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\nvim values.yaml\n\n# \u90e8\u7f72\nhelm install prometheus . --create-namespace --namespace monitoring\n\n# \u4fee\u6539 Prometheus Grafana \u670d\u52a1\u4e3a NodePort\uff0c\u5426\u5219\u5916\u90e8\u65e0\u6cd5\u8bbf\u95ee\nkubectl patch svc prometheus-kube-prometheus-prometheus -n monitoring -p \'{"spec": {"type": "NodePort"}}\'\nkubectl patch svc prometheus-grafana -n monitoring -p \'{"spec": {"type": "NodePort"}}\'\n\n# \u83b7\u53d6Grafana\u7684\u9ed8\u8ba4\u8d26\u53f7\u5bc6\u7801 admin / prom-operator\nkubectl --namespace monitoring get secrets prometheus-grafana -o jsonpath="{.data.admin-user}" | base64 -d ; echo\nkubectl --namespace monitoring get secrets prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 -d ; echo\n\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3",children:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u770b pod\nkubectl get pods -n monitoring -o wide\n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get pods -n monitoring -o wide\nNAME                                                     READY   STATUS        RESTARTS      AGE   IP                NODE            NOMINATED NODE   READINESS GATES\nalertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running       2 (19m ago)   51m   10.244.151.185    k8s-master-01   <none>           <none>\nprometheus-grafana-76cd8bb66b-4ttx5                      3/3     Running       0             51m   10.244.95.28      k8s-master-02   <none>           <none>\nprometheus-kube-prometheus-operator-5cfd684899-rd877     1/1     Running       1 (19m ago)   51m   10.244.151.184    k8s-master-01   <none>           <none>\nprometheus-kube-state-metrics-74b7dc4795-tmgdj           1/1     Running       0             51m   10.244.44.194     k8s-node-02     <none>           <none>\nprometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running       2 (19m ago)   51m   10.244.151.182    k8s-master-01   <none>           <none>\nprometheus-prometheus-node-exporter-26xmn                0/1     Pending       0             51m   <none>            k8s-master-03   <none>           <none>\nprometheus-prometheus-node-exporter-2crj7                1/1     Running       1 (19m ago)   51m   192.168.137.121   k8s-master-01   <none>           <none>\nprometheus-prometheus-node-exporter-bktcd                1/1     Running       0             51m   192.168.137.122   k8s-master-02   <none>           <none>\nprometheus-prometheus-node-exporter-h6bh6                0/1     Pending       0             51m   <none>            k8s-node-01     <none>           <none>\nprometheus-prometheus-node-exporter-jqvkv                0/1     Pending       0             51m   <none>            k8s-node-03     <none>           <none>\nprometheus-prometheus-node-exporter-vdtzd                1/1     Running       0             51m   192.168.137.132   k8s-node-02     <none>           <none>\n\n\n# \u67e5\u770b\u670d\u52a1\u7aef\u53e3\u4fe1\u606f\nkubectl get svc -n monitoring -o wide\n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get svc -n monitoring -o wide\nNAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                         AGE   SELECTOR\nalertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP      52m   app.kubernetes.io/name=alertmanager\nprometheus-grafana                        NodePort    10.111.36.16     <none>        80:30182/TCP                    52m   app.kubernetes.io/instance=prometheus,app.kubernetes.io/name=grafana\nprometheus-kube-prometheus-alertmanager   ClusterIP   10.101.24.100    <none>        9093/TCP,8080/TCP               52m   alertmanager=prometheus-kube-prometheus-alertmanager,app.kubernetes.io/name=alertmanager\nprometheus-kube-prometheus-operator       ClusterIP   10.110.144.229   <none>        443/TCP                         52m   app=kube-prometheus-stack-operator,release=prometheus\nprometheus-kube-prometheus-prometheus     NodePort    10.100.104.204   <none>        9090:31694/TCP,8080:31199/TCP   52m   app.kubernetes.io/name=prometheus,operator.prometheus.io/name=prometheus-kube-prometheus-prometheus\nprometheus-kube-state-metrics             ClusterIP   10.103.22.102    <none>        8080/TCP                        52m   app.kubernetes.io/instance=prometheus,app.kubernetes.io/name=kube-state-metrics\nprometheus-operated                       ClusterIP   None             <none>        9090/TCP                        52m   app.kubernetes.io/name=prometheus\nprometheus-prometheus-node-exporter       ClusterIP   10.100.244.250   <none>        9100/TCP                        52m   app.kubernetes.io/instance=prometheus,app.kubernetes.io/name=prometheus-node-exporter\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762",children:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u6ce8\uff1a"})," \u670d\u52a1\u7684\u7aef\u53e3\u89c1\u4e0a\u65b9 ",(0,a.jsx)(n.code,{children:"kubectl get svc -n monitoring -o wide"})," \u8f93\u51fa\u7684 ",(0,a.jsx)(n.code,{children:"PORT(S)"})]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Prometheus \u4e3b\u754c\u9762 ",(0,a.jsx)(n.code,{children:"http://192.168.137.121:31694"})]}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"URL"}),(0,a.jsx)(n.th,{children:"\u4ecb\u7ecd"}),(0,a.jsx)(n.th,{children:"\u5907\u6ce8"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/"}),(0,a.jsx)(n.td,{children:"\u4e3b\u754c\u9762"}),(0,a.jsx)(n.td,{})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/metrics"}),(0,a.jsx)(n.td,{children:"\u81ea\u8eab\u6307\u6807"}),(0,a.jsx)(n.td,{children:"\u91c7\u96c6\u5230\u7684\u6307\u6807\u4fe1\u606f"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/config"}),(0,a.jsx)(n.td,{children:"\u914d\u7f6e\u9875\u9762"}),(0,a.jsx)(n.td,{children:"\u8fd0\u884c\u65f6\u7684\u914d\u7f6e\uff0c\u5982\u679c\u53d1\u73b0\u76ee\u6807\u670d\u52a1\u7684\u6307\u6807\u5728Grafan\u641c\u7d22\u4e0d\u5230\uff0c\u9700\u8981\u6bd4\u5bf9\u8fd9\u91cc\u7684\u914d\u7f6e\u53caRelabel Rule"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/service-discovery"}),(0,a.jsx)(n.td,{children:"\u670d\u52a1\u53d1\u73b0"}),(0,a.jsx)(n.td,{children:"\u8bb0\u5f55\u4e86\u6240\u6709\u670d\u52a1\u7684\u539f\u59cb\u6807\u7b7e\u53ca\u7ecf\u89c4\u5219\u8fc7\u6ee4\u540e\u7684\u6807\u7b7e\u4fe1\u606f\uff0c\u914d\u5408 /config \u9875\u9762\u7684\u914d\u7f6e\u6bd4\u5bf9"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/targets"}),(0,a.jsx)(n.td,{children:"\u91c7\u96c6\u5bf9\u8c61\u7684\u72b6\u6001"}),(0,a.jsx)(n.td,{children:"\u91c7\u96c6\u5bf9\u8c61\u7684\u72b6\u6001\u4fe1\u606f\uff0c\u53ef\u4ee5\u7b80\u5355\u6392\u9664\u670d\u52a1\u95ee\u9898"})]})]})]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Grafana \u4e3b\u754c\u9762 ",(0,a.jsx)(n.code,{children:"http://192.168.137.121:30182"})]}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"URL"}),(0,a.jsx)(n.th,{children:"\u4ecb\u7ecd"}),(0,a.jsx)(n.th,{children:"\u5907\u6ce8"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/"}),(0,a.jsx)(n.td,{children:"\u4e3b\u754c\u9762"}),(0,a.jsx)(n.td,{})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/connections/datasources"}),(0,a.jsx)(n.td,{children:"\u6570\u636e\u6e90"}),(0,a.jsx)(n.td,{children:"\u8fde\u63a5\u6570\u636e\u6e90 \u5982 Prometheus AlertManager Loki\u7b49"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/explore"}),(0,a.jsx)(n.td,{children:"\u641c\u7d22\u9875"}),(0,a.jsx)(n.td,{children:"\u5728\u8fd9\u4e2a\u9875\u9762\u4f7f\u7528GrafaQL\u641c\u7d22\u67e5\u770b\u4e0a\u62a5\u7684\u539f\u59cb\u6570\u636e\uff08\u4e3b\u8981\u662f\u65e5\u5fd7\uff09"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/dashboards"}),(0,a.jsx)(n.td,{children:"\u76d1\u63a7\u9762\u677f"}),(0,a.jsx)(n.td,{children:"\u670d\u52a1\u72b6\u6001\u76d1\u63a7\u5927\u5c4f"})]})]})]}),"\n",(0,a.jsx)(n.h1,{id:"k8s-\u90e8\u7f72-loki",children:"K8s \u90e8\u7f72 Loki"}),"\n",(0,a.jsx)(n.p,{children:"\u7531\u4e8e\u4e0a\u9762\u90e8\u7f72Prometheus Operator\u5df2\u7ecf\u5305\u542b\u4e86Grafana\uff0c\u8fd9\u91cc\u5c31\u4e0d\u9700\u8981\u518d\u90e8\u7f72Grafana\u4e86"}),"\n",(0,a.jsx)(n.p,{children:"\u5b98\u65b9\u7684\u90e8\u7f72\u65b9\u6848\u592a\u6d88\u8017\u670d\u52a1\u5668\u8d44\u6e90\uff08Pod\u657010+ \u4e14\u968f\u96c6\u7fa4\u8282\u70b9\u6570\u589e\u52a0\u800c\u589e\u52a0\uff09\uff0c\u8fd9\u91cc\u4ec5\u90e8\u7f72\u4e00\u4e2a\u8282\u70b9"}),"\n",(0,a.jsx)(n.h2,{id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49",children:"k8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49"}),"\n",(0,a.jsxs)(n.p,{children:["Loki\u90e8\u7f72\u8d44\u6e90\u6587\u4ef6: ",(0,a.jsx)(n.code,{children:"lpg-loki.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'# Loki \u8d26\u53f7\u5b9a\u4e49\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: loki\n  namespace: lpg\n---\n\n# Loki \u89d2\u8272\u5b9a\u4e49\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: loki\n  namespace: lpg\nrules:\n- apiGroups: ["extensions"]\n  resources: ["podsecuritypolicies"]\n  verbs: ["use"]\n  resourceNames: [loki]\n---\n\n# Loki \u89d2\u8272\u7ed1\u5b9a\u5b9a\u4e49\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: loki\n  namespace: lpg\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: loki\nsubjects:\n- kind: ServiceAccount\n  name: loki\n---\n\n# Loki\u914d\u7f6e\u6587\u4ef6\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: loki\n  namespace: lpg\n  labels:\n    app: loki\ndata:\n  loki.yaml: |\n    auth_enabled: false\n\n    server:\n      http_listen_port: 3100\n\n    common:\n      instance_addr: 127.0.0.1\n      path_prefix: /data/loki\n      storage:\n        filesystem:\n          chunks_directory: /data/loki/chunks\n          rules_directory: /data/loki/rules\n      replication_factor: 1\n      ring:\n        kvstore:\n          store: inmemory\n\n    schema_config:\n      configs:\n        - from: 2020-10-24\n          store: tsdb\n          object_store: filesystem\n          schema: v13\n          index:\n            prefix: index_\n            period: 24h\n\n    ruler:\n      alertmanager_url: http://localhost:9093\n\n---\n\n# Loki \u670d\u52a1\u5b9a\u4e49\napiVersion: v1\nkind: Service\nmetadata:\n  name: loki\n  namespace: lpg\n  labels:\n    app: loki\nspec:\n  type: NodePort\n  ports:\n    - port: 3100\n      protocol: TCP\n      name: http-metrics\n      targetPort: http-metrics\n      nodePort: 30310\n  selector:\n    app: loki\n---\n\n# Loki StatefulSet\u5b9a\u4e49\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: loki\n  namespace: lpg\n  labels:\n    app: loki\nspec:\n  podManagementPolicy: OrderedReady\n  replicas: 1\n  selector:\n    matchLabels:\n      app: loki\n  serviceName: loki\n  updateStrategy:\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: loki\n    spec:\n      serviceAccountName: loki\n      initContainers:\n      - name: chmod-data\n        image: busybox:1.28.4\n        imagePullPolicy: IfNotPresent\n        command: ["chmod","-R","777","/loki/data"]\n        volumeMounts:\n        - name: storage\n          mountPath: /loki/data\n      containers:\n        - name: loki\n          image: grafana/loki:3.5.1\n          imagePullPolicy: IfNotPresent\n          args:\n            - -config.file=/etc/loki/loki.yaml\n          ports:\n            - name: http-metrics\n              containerPort: 3100\n              protocol: TCP\n          # \u6dfb\u52a0\u5b89\u5168\u4e0a\u4e0b\u6587 id\n          securityContext:\n            runAsUser: 1000\n            runAsGroup: 1000\n          livenessProbe:\n            httpGet: \n              path: /ready\n              port: http-metrics\n              scheme: HTTP\n            initialDelaySeconds: 45\n          readinessProbe:\n            httpGet: \n              path: /ready\n              port: http-metrics\n              scheme: HTTP\n            initialDelaySeconds: 45\n          volumeMounts:\n            - name: config\n              mountPath: /etc/loki\n            - name: storage\n              mountPath: /data\n      terminationGracePeriodSeconds: 4800\n      volumes:\n        - name: config\n          configMap:\n            name: loki\n        - name: storage\n          hostPath:\n            path: /home/diginn/lpg/loki\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u5982\u6709\u9700\u8981\uff0c\u4fee\u6539\u4e0b\u9762\u7684\u51e0\u4e2a\u5c5e\u6027:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"*.namespace: lpg"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"loki.hostPath.path: /home/diginn/lpg/loki"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"loki.ports[*].port.nodePort: 30310"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u8d44\u6e90",children:"\u90e8\u7f72\u8d44\u6e90"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl get namespace lpg\nkubectl create namespace lpg\n\n# \u90e8\u7f72\nkubectl apply -f lpg-loki.yaml\n\n# \u5220\u9664\nkubectl delete -f lpg-loki.yaml\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3-1",children:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u770b Pod\nkubectl get pods -n lpg -o wide\n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get pods -n lpg -o wide\nNAME     READY   STATUS    RESTARTS      AGE    IP              NODE          NOMINATED NODE   READINESS GATES\nloki-0   1/1     Running   1 (99m ago)   112m   10.244.44.249   k8s-node-02   <none>           <none>\n\n\n# \u67e5\u770b\u670d\u52a1\u7aef\u53e3\u4fe1\u606f\nkubectl get services -n lpg -o wide \n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get services -n lpg -o wide\nNAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE    SELECTOR\nloki      NodePort   10.96.77.123     <none>        3100:30310/TCP   113m   app=loki\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762-1",children:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u6ce8\uff1a"})," \u670d\u52a1\u7684\u7aef\u53e3\u89c1\u4e0a\u65b9 ",(0,a.jsx)(n.code,{children:"kubectl get services -n lpg -o wide"})," \u8f93\u51fa\u7684 ",(0,a.jsx)(n.code,{children:"PORT(S)"})]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Loki \u6307\u6807\u9875\u9762 ",(0,a.jsx)(n.code,{children:"http://192.168.137.121:30310/metrics"})]}),"\n"]}),"\n",(0,a.jsx)(n.h1,{id:"k8s-\u90e8\u7f72-promtail",children:"K8s \u90e8\u7f72 Promtail"}),"\n",(0,a.jsx)(n.p,{children:"Promtail\u5c06\u88ab\u90e8\u7f72\u4e3aKubernetes DaemonSet\uff0c\u96c6\u7fa4\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u4f1a\u8fd0\u884c\u4e00\u4e2aPromtail Pod\uff0c\u6765\u6536\u96c6\u5f53\u524d\u8282\u70b9\u4e0a\u7684\u65e5\u5fd7\u4fe1\u606f"}),"\n",(0,a.jsx)(n.h2,{id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49-1",children:"k8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49"}),"\n",(0,a.jsxs)(n.p,{children:["Promtail DaemonSet\u914d\u7f6e\u6587\u4ef6 ",(0,a.jsx)(n.code,{children:"promtail-daemonset.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"--- # DaemonSet.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: promtail-daemonset\nspec:\n  selector:\n    matchLabels:\n      name: promtail\n  template:\n    metadata:\n      labels:\n        name: promtail\n    spec:\n      serviceAccount: promtail-serviceaccount\n      containers:\n      - name: promtail-container\n        image: grafana/promtail\n        args:\n        - -config.file=/etc/promtail/promtail.yaml\n        env: \n        - name: 'HOSTNAME' # needed when using kubernetes_sd_configs\n          valueFrom:\n            fieldRef:\n              fieldPath: 'spec.nodeName'\n        volumeMounts:\n        - name: logs\n          mountPath: /var/log\n        - name: promtail-config\n          mountPath: /etc/promtail\n        - mountPath: /var/lib/docker/containers\n          name: varlibdockercontainers\n          readOnly: true\n      volumes:\n      - name: logs\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: promtail-config\n        configMap:\n          name: promtail-config\n--- # configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: promtail-config\ndata:\n  promtail.yaml: |\n    server:\n      http_listen_port: 9080\n      grpc_listen_port: 0\n\n    clients:\n    # - url: http://192.168.137.121:3100/loki/api/v1/push  # \u6ce8\u610f\u8fd9\u91cc\u7684\u534f\u8bae\u4e3a HTTP\uff0cIP \u7aef\u53e3\u4e3aLoki\u6620\u5c04\u7684\u7269\u7406\u673aIP \u7aef\u53e3\n    - url: http://loki.lpg:3100/loki/api/v1/push  # \u5982\u679c\u662f\u5728\u540c\u4e00\u4e2aK8s\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528 <\u670d\u52a1\u540d.\u547d\u540d\u7a7a\u95f4> \u4f8b\u5982: loki.lpg\n\n    positions:\n      filename: /tmp/positions.yaml\n    target_config:\n      sync_period: 10s\n    scrape_configs:\n    - job_name: pod-logs\n      kubernetes_sd_configs:\n        - role: pod\n      pipeline_stages:\n        - docker: {}\n      relabel_configs:\n        # \u68c0\u67e5\u662f\u5426\u6709\u6807\u6ce8\u4e3apromtail.io/scrape=true\u7684\u6ce8\u89e3\uff0c\u6ca1\u6709\u6ce8\u89e3\u7684pod\u4e0d\u91c7\u96c6\n        - source_labels: [__meta_kubernetes_pod_annotation_promtail_io_scrape]\n          action: keep\n          regex: true\n        - source_labels:\n            - __meta_kubernetes_pod_node_name\n          target_label: __host__\n        - action: labelmap\n          regex: __meta_kubernetes_pod_label_(.+)\n        - action: replace\n          replacement: $1\n          separator: /\n          source_labels:\n            - __meta_kubernetes_namespace\n            - __meta_kubernetes_pod_name\n          target_label: job\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_namespace\n          target_label: namespace\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_pod_name\n          target_label: pod\n        - action: replace\n          source_labels:\n            - __meta_kubernetes_pod_container_name\n          target_label: container\n        - replacement: /var/log/pods/*$1/$2/*.log # $1=pod_uid, $2=container_name\n          separator: /\n          source_labels:\n            - __meta_kubernetes_pod_uid\n            - __meta_kubernetes_pod_container_name\n          target_label: __path__\n\n--- # Clusterrole.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: promtail-clusterrole\nrules:\n  - apiGroups: [\"\"]\n    resources:\n    - nodes\n    - services\n    - pods\n    verbs:\n    - get\n    - watch\n    - list\n\n--- # ServiceAccount.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: promtail-serviceaccount\n\n--- # Rolebinding.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: promtail-clusterrolebinding\nsubjects:\n    - kind: ServiceAccount\n      name: promtail-serviceaccount\n      namespace: default\nroleRef:\n    kind: ClusterRole\n    name: promtail-clusterrole\n    apiGroup: rbac.authorization.k8s.io\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u91cd\u70b9\u5173\u6ce8 ",(0,a.jsx)(n.code,{children:"ConfigMap"})," \u90e8\u5206\u7684 ",(0,a.jsx)(n.code,{children:"clients.url"}),"\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86\u65e5\u5fd7\u53d1\u9001\u76ee\u6807Loki\u7684\u5730\u5740\uff0c\u8fd9\u91cc\u63a8\u8350\u91c7\u7528\u7b2c\u4e8c\u79cd\u5199\u6cd5 \u5373\uff1a ",(0,a.jsx)(n.code,{children:"<\u670d\u52a1\u540d.\u547d\u540d\u7a7a\u95f4>"})," \u5982 ",(0,a.jsx)(n.code,{children:"loki.lpg"})]}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u8d44\u6e90-1",children:"\u90e8\u7f72\u8d44\u6e90"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u90e8\u7f72\nkubectl apply -f promtail-daemonset.yaml\n\n# \u5220\u9664\nkubectl delete -f promtail-daemonset.yaml\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3-2",children:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u8be2\u51fa Pod \u4ee5\u53ca\u5b83\u4eec\u90e8\u7f72\u5230\u7684\u8282\u70b9\nkubectl get pods -l name=promtail -o wide\n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get pods -l name=promtail -o wide\nNAME                       READY   STATUS        RESTARTS      AGE     IP               NODE            NOMINATED NODE   READINESS GATES\npromtail-daemonset-52cbx   0/1     Terminating   0             46h     <none>           k8s-node-01     <none>           <none>\npromtail-daemonset-8rrkv   0/1     Terminating   2             6d23h   <none>           k8s-master-03   <none>           <none>\npromtail-daemonset-bcl54   1/1     Running       1 (57m ago)   66m     10.244.151.186   k8s-master-01   <none>           <none>\npromtail-daemonset-bht72   1/1     Running       1 (20m ago)   66m     10.244.95.33     k8s-master-02   <none>           <none>\npromtail-daemonset-fgkg6   0/1     Terminating   0             46h     <none>           k8s-node-03     <none>           <none>\npromtail-daemonset-ml97l   1/1     Running       1 (54m ago)   66m     10.244.44.206    k8s-node-02     <none>           <none>\n\n# \u67e5\u8be2DaemonSet \u7684\u4fe1\u606f\nkubectl get daemonset\n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get daemonset\nNAME                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\npromtail-daemonset   3         3         3       3            3           <none>          66m\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762-2",children:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u6ce8"})," \u8fd9\u91ccK8s\u8fd0\u884c\u5e76\u6ca1\u6709\u66b4\u9732\u7aef\u53e3\u51fa\u6765\uff0c\u5916\u90e8\u65e0\u6cd5\u8bbf\u95ee\u5230\u8fd9\u4e9b\u9875\u9762\uff0c\u540e\u9762\u4f7f\u7528\u4e8c\u8fdb\u5236\u90e8\u7f72\u6536\u96c6\u672c\u5730\u65e5\u5fd7\u65f6\u53ef\u4ee5\u6253\u5f00"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Promtail \u4e3b\u754c\u9762 ",(0,a.jsx)(n.code,{children:"http://192.168.137.132:9080"})]}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"URL"}),(0,a.jsx)(n.th,{children:"\u4ecb\u7ecd"}),(0,a.jsx)(n.th,{children:"\u5907\u6ce8"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/"}),(0,a.jsx)(n.td,{children:"\u4e3b\u754c\u9762"}),(0,a.jsx)(n.td,{children:"\u4e3b\u754c\u9762\u9ed8\u8ba4\u8df3\u8f6c\u5230 /targets"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/service-discovery"}),(0,a.jsx)(n.td,{children:"\u670d\u52a1\u53d1\u73b0\u9875"}),(0,a.jsx)(n.td,{children:"\u8bb0\u5f55\u6536\u96c6\u65e5\u5fd7\u7684job\u540d\u79f0\u53ca\u6807\u7b7e\u4fe1\u606f"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/config"}),(0,a.jsx)(n.td,{children:"\u914d\u7f6e\u9875"}),(0,a.jsx)(n.td,{children:"Promtail\u7684\u914d\u7f6e\u4fe1\u606f"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/targets"}),(0,a.jsx)(n.td,{children:"\u6536\u96c6\u76ee\u6807"}),(0,a.jsx)(n.td,{children:"\u65e5\u5fd7\u6587\u4ef6\u6240\u5c5e\u7684job\uff0c\u6807\u7b7e\uff0c\u8def\u5f84\uff0c\u8bfb\u53d6\u4f4d\u7f6e\u7b49\u4fe1\u606f"})]})]})]}),"\n",(0,a.jsx)(n.h1,{id:"k8s-\u90e8\u7f72-spring-boot",children:"K8s \u90e8\u7f72 Spring Boot"}),"\n",(0,a.jsx)(n.h2,{id:"\u670d\u52a1\u6539\u9020",children:"\u670d\u52a1\u6539\u9020"}),"\n",(0,a.jsxs)(n.p,{children:["\u6dfb\u52a0Prometheus\u4f9d\u8d56 ",(0,a.jsx)(n.code,{children:"pom.xml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"\x3c!-- \u5f00\u542f Spring Boot Actuator --\x3e\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-actuator</artifactId>\n</dependency>\n\x3c!-- \u5c06 Actuator \u6307\u6807\u8f6c\u6362\u4e3a Prometheus \u683c\u5f0f --\x3e\n<dependency>\n  <groupId>io.micrometer</groupId>\n  <artifactId>micrometer-registry-prometheus</artifactId>\n  <version>${micrometer.version}</version>\n</dependency>\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5f00\u653eActuator\u7aef\u70b9 ",(0,a.jsx)(n.code,{children:"application.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'# \u5f00\u653e Actuator \u7ba1\u7406\u7aef\u70b9\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: "*"\n    health:\n      show-details: always\n  metrics:\n    export:\n      prometheus:\n        enable: true\n    tags:\n      application: ${spring.application.name}\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u65e5\u5fd7\u914d\u7f6e\u4fee\u6539\uff08\u53ef\u9009\u914d\u7f6e\uff0c\u5c06\u65e5\u5fd7\u8f93\u51fa\u4e3ajson\u683c\u5f0f\uff09"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n\x3c!--\u65e5\u5fd7\u7ea7\u522b\u4ee5\u53ca\u4f18\u5148\u7ea7\u6392\u5e8f: OFF > FATAL > ERROR > WARN > INFO > DEBUG > TRACE > ALL --\x3e\n\x3c!--status\u7528\u4e8e\u8bbe\u7f6elog4j2\u81ea\u8eab\u5185\u90e8\u7684\u4fe1\u606f\u8f93\u51fa,\u53ef\u4ee5\u4e0d\u8bbe\u7f6e,\u5f53\u8bbe\u7f6e\u6210trace\u65f6,\u4f60\u4f1a\u770b\u5230log4j2\u5185\u90e8\u5404\u79cd\u8be6\u7ec6\u8f93\u51fa--\x3e\n\x3c!--monitorInterval\uff1aLog4j\u80fd\u591f\u81ea\u52a8\u68c0\u6d4b\u4fee\u6539\u914d\u7f6e \u6587\u4ef6\u548c\u91cd\u65b0\u914d\u7f6e\u672c\u8eab,\u8bbe\u7f6e\u95f4\u9694\u79d2\u6570--\x3e\n<configuration status="WARN" monitorInterval="60">\n    <Properties>\n        <Property name="log.timeZone">Asia/Shanghai</Property>\n        \x3c!-- \u516c\u5171\u914d\u7f6e --\x3e\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u5b58\u653e\u7684\u4f4d\u7f6e,\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u9879\u76ee\u6839\u8def\u5f84\u4e0b,\u4e5f\u53ef\u6307\u5b9a\u7edd\u5bf9\u8def\u5f84 --\x3e\n        \x3c!-- \u5b58\u653e\u8def\u5f84\u4e00:\u901a\u7528\u8def\u5f84,window\u5e73\u53f0 --\x3e\n        <property name="basePath">../logs</property>\n        \x3c!-- \u5b58\u653e\u8def\u5f84\u4e8c:web\u5de5\u7a0b\u4e13\u7528,java\u9879\u76ee\u6ca1\u6709\u8fd9\u4e2a\u53d8\u91cf,\u9700\u8981\u5220\u6389,\u5426\u5219\u4f1a\u62a5\u5f02\u5e38,\u8fd9\u91cc\u628a\u65e5\u5fd7\u653e\u5728web\u9879\u76ee\u7684\u6839\u76ee\u5f55\u4e0b --\x3e\n        \x3c!-- <property name="basePath">${web:rootDir}/${logFileName}</property> --\x3e\n        \x3c!-- \u5b58\u653e\u8def\u5f84\u4e09:web\u5de5\u7a0b\u4e13\u7528,java\u9879\u76ee\u6ca1\u6709\u8fd9\u4e2a\u53d8\u91cf,\u9700\u8981\u5220\u6389,\u5426\u5219\u4f1a\u62a5\u5f02\u5e38,\u8fd9\u91cc\u628a\u65e5\u5fd7\u653e\u5728tocmat\u7684logs\u76ee\u5f55\u4e0b --\x3e\n        \x3c!--<property name="basePath">${sys:catalina.home}/logs/${logFileName}</property>--\x3e\n\n        \x3c!-- \u63a7\u5236\u53f0\u9ed8\u8ba4\u8f93\u51fa\u683c\u5f0f,"%-5level":\u65e5\u5fd7\u7ea7\u522b,"%l":\u8f93\u51fa\u5b8c\u6574\u7684\u9519\u8bef\u4f4d\u7f6e,\u662f\u5c0f\u5199\u7684L,\u56e0\u4e3a\u6709\u884c\u53f7\u663e\u793a,\u6240\u4ee5\u5f71\u54cd\u65e5\u5fd7\u8f93\u51fa\u7684\u6027\u80fd --\x3e\n        \x3c!--<property name="console_log_pattern">%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%-5level] %l - %m%n</property>--\x3e\n        <property name="console_log_pattern">%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight{%-5level}{ERROR=Bright RED, WARN=Bright Yellow, INFO=Bright Green, DEBUG=Bright Cyan, TRACE=Bright White} %style{[%t]}{bright,magenta} %style{%c{1.}.%M(%L)}{cyan}: %msg%n</property>\n        \x3c!-- \u65e5\u5fd7\u6587\u4ef6\u9ed8\u8ba4\u8f93\u51fa\u683c\u5f0f,\u4e0d\u5e26\u884c\u53f7\u8f93\u51fa(\u884c\u53f7\u663e\u793a\u4f1a\u5f71\u54cd\u65e5\u5fd7\u8f93\u51fa\u6027\u80fd);%C:\u5927\u5199,\u7c7b\u540d;%M:\u65b9\u6cd5\u540d;%m:\u9519\u8bef\u4fe1\u606f;%n:\u6362\u884c --\x3e\n        \x3c!-- <property name="log_pattern">%d{yyyy-MM-dd HH:mm:ss.SSS} [%-5level] %C.%M - %m%n</property> --\x3e\n        \x3c!-- \u65e5\u5fd7\u6587\u4ef6\u9ed8\u8ba4\u8f93\u51fa\u683c\u5f0f,\u53e6\u7c7b\u5e26\u884c\u53f7\u8f93\u51fa(\u5bf9\u65e5\u5fd7\u8f93\u51fa\u6027\u80fd\u672a\u77e5);%C:\u5927\u5199,\u7c7b\u540d;%M:\u65b9\u6cd5\u540d;%L:\u884c\u53f7;%m:\u9519\u8bef\u4fe1\u606f;%n:\u6362\u884c --\x3e\n        <property name="log_pattern">%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%-5level] %C.%M[%L line] - %m%n</property>\n\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u5207\u5272\u7684\u6700\u5c0f\u5355\u4f4d --\x3e\n        <property name="every_file_size">50MB</property>\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u8f93\u51fa\u7ea7\u522b --\x3e\n        <property name="output_log_level">DEBUG</property>\n\n        \x3c!-- \u6240\u6709\u7ea7\u522b\u65e5\u5fd7\u914d\u7f6e --\x3e\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u5b58\u653e\u8def\u5f84(\u6240\u6709\u7ea7\u522b\u65e5\u5fd7) --\x3e\n        <property name="rolling_fileName">${basePath}/${spring:spring.application.name}-all.log</property>\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u538b\u7f29\u8def\u5f84,\u5c06\u8d85\u8fc7\u6307\u5b9a\u6587\u4ef6\u5927\u5c0f\u7684\u65e5\u5fd7,\u81ea\u52a8\u5b58\u5165\u6309"\u5e74\u6708"\u5efa\u7acb\u7684\u6587\u4ef6\u5939\u4e0b\u9762\u5e76\u8fdb\u884c\u538b\u7f29,\u4f5c\u4e3a\u5b58\u6863 --\x3e\n        <property name="rolling_filePattern">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-all-%d{yyyy-MM-dd-HH}-%i.log.zip</property>\n        <property name="rolling_fileName_json">${basePath}/${spring:spring.application.name}-all-json.log</property>\n        <property name="rolling_filePattern_json">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-all-json-%d{yyyy-MM-dd-HH}-%i.log.zip</property>\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u540c\u7c7b\u578b\u65e5\u5fd7,\u540c\u4e00\u6587\u4ef6\u5939\u4e0b\u53ef\u4ee5\u5b58\u653e\u7684\u6570\u91cf,\u4e0d\u8bbe\u7f6e\u6b64\u5c5e\u6027\u5219\u9ed8\u8ba4\u4e3a7\u4e2a,filePattern\u6700\u540e\u8981\u5e26%i\u624d\u4f1a\u751f\u6548 --\x3e\n        <property name="rolling_max">14</property>\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u540c\u7c7b\u578b\u65e5\u5fd7,\u591a\u4e45\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6,\u8fd9\u4e2a\u914d\u7f6e\u9700\u8981\u548cfilePattern\u7ed3\u5408\u4f7f\u7528;\n                \u5982\u679c\u8bbe\u7f6e\u4e3a1,filePattern\u662f%d{yyyy-MM-dd}\u5230\u5929\u7684\u683c\u5f0f,\u5219\u95f4\u9694\u4e00\u5929\u751f\u6210\u4e00\u4e2a\u6587\u4ef6\n                \u5982\u679c\u8bbe\u7f6e\u4e3a12,filePattern\u662f%d{yyyy-MM-dd-HH}\u5230\u5c0f\u65f6\u7684\u683c\u5f0f,\u5219\u95f4\u969412\u5c0f\u65f6\u751f\u6210\u4e00\u4e2a\u6587\u4ef6 --\x3e\n        <property name="rolling_timeInterval">24</property>\n        \x3c!-- \u65e5\u5fd7\u9ed8\u8ba4\u540c\u7c7b\u578b\u65e5\u5fd7,\u662f\u5426\u5bf9\u5c01\u5b58\u65f6\u95f4\u8fdb\u884c\u8c03\u5236,\u82e5\u4e3atrue,\u5219\u5c01\u5b58\u65f6\u95f4\u5c06\u4ee50\u70b9\u4e3a\u8fb9\u754c\u8fdb\u884c\u8c03\u6574,\n                \u5982:\u73b0\u5728\u662f\u65e9\u4e0a3am,interval\u662f4,\u90a3\u4e48\u7b2c\u4e00\u6b21\u6eda\u52a8\u662f\u57284am,\u63a5\u7740\u662f8am,12am...\u800c\u4e0d\u662f7am --\x3e\n        <property name="rolling_timeModulate">true</property>\n\n        \x3c!-- Info\u7ea7\u522b\u65e5\u5fd7 --\x3e\n        <property name="info_fileName">${basePath}/${spring:spring.application.name}-info.log</property>\n        <property name="info_filePattern">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-info-%d{yyyy-MM-dd}-%i.log.zip</property>\n        <property name="info_max">14</property>\n        <property name="info_timeInterval">1</property>\n        <property name="info_timeModulate">true</property>\n\n        \x3c!-- Warn\u7ea7\u522b\u65e5\u5fd7 --\x3e\n        <property name="warn_fileName">${basePath}/${spring:spring.application.name}-warn.log</property>\n        <property name="warn_filePattern">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-warn-%d{yyyy-MM-dd}-%i.log.zip</property>\n        <property name="warn_max">14</property>\n        <property name="warn_timeInterval">1</property>\n        <property name="warn_timeModulate">true</property>\n\n        \x3c!-- Error\u7ea7\u522b\u65e5\u5fd7 --\x3e\n        <property name="error_fileName">${basePath}/${spring:spring.application.name}-error.log</property>\n        <property name="error_filePattern">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-error-%d{yyyy-MM-dd}-%i.log.zip</property>\n        <property name="error_max">14</property>\n        <property name="error_timeInterval">1</property>\n        <property name="error_timeModulate">true</property>\n\n        \x3c!-- druid sql\u65e5\u5fd7\u914d\u7f6e --\x3e\n        <property name="sql_fileName">${basePath}/${spring:spring.application.name}-sql.log</property>\n        <property name="sql_filePattern">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-sql-%d{yyyy-MM-dd}-%i.log.zip</property>\n        <property name="sql_max">7</property>\n        <property name="sql_timeInterval">1</property>\n        <property name="sql_timeModulate">true</property>\n\n        \x3c!-- message statistic\u65e5\u5fd7\u914d\u7f6e --\x3e\n        <property name="msg_statistic_fileName">${basePath}/${spring:spring.application.name}-msg.log</property>\n        <property name="msg_filePattern">${basePath}/%d{yyyy-MM}/${spring:spring.application.name}-msg-%d{yyyy-MM-dd}-%i.log.zip</property>\n        <property name="msg_max">7</property>\n        <property name="msg_timeInterval">1</property>\n        <property name="msg_timeModulate">true</property>\n\n        \x3c!-- \u63a7\u5236\u53f0\u663e\u793a\u63a7\u5236,\u63a7\u5236\u53f0\u663e\u793a\u7684\u65e5\u5fd7\u6700\u4f4e\u7ea7\u522b\uff0c\u751f\u4ea7\u73af\u5883\u4e0d\u7528\u6253\u5370sql\u8bed\u53e5 --\x3e\n        <property name="console_print_level_prod">DEBUG</property>\n        \x3c!-- \u63a7\u5236\u53f0\u663e\u793a\u63a7\u5236,\u63a7\u5236\u53f0\u663e\u793a\u7684\u65e5\u5fd7\u6700\u4f4e\u7ea7\u522b\uff0c\u5f00\u53d1\u73af\u5883\u4f7f\u7528\u53ef\u4ee5\u6253\u5370sql\u8bed\u53e5 --\x3e\n        <property name="console_print_level_dev">TRACE</property>\n    </Properties>\n\n    \x3c!--\u5b9a\u4e49appender --\x3e\n    <appenders>\n        \x3c!-- \u7528\u6765\u5b9a\u4e49\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u7684\u914d\u7f6e --\x3e\n        <Console name="console" target="SYSTEM_OUT">\n            <Filters>\n                \x3c!-- \u8bbe\u7f6e\u63a7\u5236\u53f0\u53ea\u8f93\u51falevel\u53ca\u4ee5\u4e0a\u7ea7\u522b\u7684\u4fe1\u606f(onMatch),\u5176\u4ed6\u7684\u76f4\u63a5\u62d2\u7edd(onMismatch)--\x3e\n                <ThresholdFilter level="${console_print_level_prod}" onMatch="NEUTRAL" onMismatch="DENY"/>\n                <Log4jWebFrontFilter/>\n            </Filters>\n            \x3c!-- \u8bbe\u7f6e\u8f93\u51fa\u683c\u5f0f,\u4e0d\u8bbe\u7f6e\u9ed8\u8ba4\u4e3a:%m%n --\x3e\n            <PatternLayout pattern="${console_log_pattern}" disableAnsi="false" noConsoleNoAnsi="false"/>\n        </Console>\n\n        \x3c!-- \u8f93\u51faroot\u4e2d\u6307\u5b9a\u7684level\u7ea7\u522b\u4ee5\u4e0a\u7684\u6240\u6709\u65e5\u5fd7\u5230\u6587\u4ef6 --\x3e\n        <RollingFile name="allLogFile" fileName="${rolling_fileName}" filePattern="${rolling_filePattern}">\n            <PatternLayout pattern="${log_pattern}"/>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${rolling_timeInterval}" modulate="${warn_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            \x3c!-- \u8bbe\u7f6e\u540c\u7c7b\u578b\u65e5\u5fd7,\u540c\u4e00\u6587\u4ef6\u5939\u4e0b\u53ef\u4ee5\u5b58\u653e\u7684\u6570\u91cf --\x3e\n            <DefaultRolloverStrategy max="${rolling_max}"/>\n        </RollingFile>\n\n        <RollingFile name="allLogFile_json" fileName="${rolling_fileName_json}" filePattern="${rolling_filePattern_json}">\n            \x3c!--\n             locationInfo - \u5982\u679c\u4e3a\u201ctrue\u201d\uff0c\u5219\u5728\u751f\u6210\u7684 JSON \u4e2d\u5305\u542b\u4f4d\u7f6e\u4fe1\u606f\u3002\n             complete - \u5982\u679c\u4e3a\u201ctrue\u201d\uff0c\u5219\u5305\u62ec JSON \u9875\u7709\u548c\u9875\u811a\uff0c\u4ee5\u53ca\u8bb0\u5f55\u4e4b\u95f4\u7684\u9017\u53f7\u3002\n             compact - \u5982\u679c\u4e3a\u201ctrue\u201d\uff0c\u5219\u4e0d\u4f7f\u7528\u884c\u5c3e\u548c\u7f29\u8fdb\uff0c\u9ed8\u8ba4\u4e3a\u201cfalse\u201d\u3002\n             eventEol - \u5982\u679c\u4e3a\u201ctrue\u201d\uff0c\u5219\u5728\u6bcf\u4e2a\u65e5\u5fd7\u4e8b\u4ef6\u540e\u5f3a\u5236\u6267\u884c EOL\uff08\u5373\u4f7fcompact\u4e3a\u201ctrue\u201d\uff09\uff0c\u9ed8\u8ba4\u4e3a\u201cfalse\u201d\u3002\u5373\u4f7f\u5728\u7d27\u51d1\u6a21\u5f0f\u4e0b\uff0c\u8fd9\u4e5f\u5141\u8bb8\u4e00\u884c\u751a\u81f3\u6bcf\u4e00\u884c\u3002\n             --\x3e\n            <JsonLayout compact="true" locationInfo="true" complete="false" eventEol="true" properties="true">\n                \x3c!--\n                    \u65e5\u5fd7\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u5c5e\u6027\uff0c\u76f4\u63a5\u4f7f\u7528 ${propertyName} \u8bfb\u53d6\n                    ThreadContext.put("requestId", generate()); \u5c5e\u6027\u4f7f\u7528 $${ctx:propertyName}\n                --\x3e\n                <KeyValuePair key="timestamp" value="${date:yyyy-MM-dd\' \'HH:mm:ss.SSS}" />\n                <KeyValuePair key="requestId" value="$${ctx:requestId}" />\n\n                \x3c!-- docker id  docker\u90e8\u7f72\u4f7f\u7528--\x3e\n                \x3c!--\n                <KeyValuePair key="containerId" value="${docker:containerId}"/>\n                <KeyValuePair key="containerName" value="${docker:containerName}"/>\n                <KeyValuePair key="imageName" value="${docker:imageName}"/>\n                --\x3e\n            </JsonLayout>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${rolling_timeInterval}" modulate="${warn_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            \x3c!-- \u8bbe\u7f6e\u540c\u7c7b\u578b\u65e5\u5fd7,\u540c\u4e00\u6587\u4ef6\u5939\u4e0b\u53ef\u4ee5\u5b58\u653e\u7684\u6570\u91cf --\x3e\n            <DefaultRolloverStrategy max="${rolling_max}"/>\n        </RollingFile>\n\n        \x3c!-- \u8f93\u51faINFO\u7ea7\u522b\u7684\u65e5\u5fd7\u5230\u6587\u4ef6 --\x3e\n        <RollingFile name="infoLogFile" fileName="${info_fileName}" filePattern="${info_filePattern}">\n            <PatternLayout pattern="${log_pattern}"/>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${info_timeInterval}" modulate="${info_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            <DefaultRolloverStrategy max="${info_max}"/>\n            <Filters>\n                \x3c!--\u53ea\u8f93\u51fainfo\u7ea7\u522b\u7684\u65e5\u5fd7--\x3e\n                <ThresholdFilter level="WARN" onMatch="DENY" onMismatch="NEUTRAL"/>\n                <ThresholdFilter level="INFO" onMatch="ACCEPT" onMismatch="DENY"/>\n            </Filters>\n        </RollingFile>\n\n        \x3c!-- \u8f93\u51faWARN\u7ea7\u522b\u7684\u65e5\u5fd7\u5230\u6587\u4ef6 --\x3e\n        <RollingFile name="warnLogFile" fileName="${warn_fileName}" filePattern="${warn_filePattern}">\n            <PatternLayout pattern="${log_pattern}"/>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${warn_timeInterval}" modulate="${warn_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            <DefaultRolloverStrategy max="${warn_max}"/>\n            <Filters>\n                \x3c!--\u53ea\u8f93\u51fawarn\u7ea7\u522b\u7684\u65e5\u5fd7--\x3e\n                <ThresholdFilter level="ERROR" onMatch="DENY" onMismatch="NEUTRAL"/>\n                <ThresholdFilter level="WARN" onMatch="ACCEPT" onMismatch="DENY"/>\n            </Filters>\n        </RollingFile>\n\n        \x3c!-- \u8f93\u51faERROR\u7ea7\u522b\u7684\u65e5\u5fd7\u5230\u6587\u4ef6 --\x3e\n        <RollingFile name="errorLogFile" fileName="${error_fileName}" filePattern="${error_filePattern}">\n            <PatternLayout pattern="${log_pattern}"/>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${error_timeInterval}" modulate="${error_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            <DefaultRolloverStrategy max="${error_max}"/>\n            <Filters>\n                \x3c!--\u53ea\u8f93\u51faerror\u7ea7\u522b\u7684\u65e5\u5fd7--\x3e\n                <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY"/>\n            </Filters>\n        </RollingFile>\n\n        \x3c!--\u8bb0\u5f55druid\u7684sql\u8bed\u53e5--\x3e\n        <RollingFile name="druidSqlLogFile" fileName="${sql_fileName}"\n                     filePattern="${sql_filePattern}">\n            <PatternLayout pattern="${log_pattern}"/>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${sql_timeInterval}" modulate="${sql_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            <DefaultRolloverStrategy max="${sql_max}"/>\n        </RollingFile>\n\n        \x3c!--\u7edf\u8ba1message\u6d88\u8d39\u7684\u5168\u90e8\u6d88\u606f--\x3e\n        <RollingFile name="msgStatisticLogfile" fileName="${msg_statistic_fileName}"\n                     filePattern="${msg_filePattern}">\n            <PatternLayout pattern="${log_pattern}"/>\n            <Policies>\n                <TimeBasedTriggeringPolicy interval="${msg_timeInterval}" modulate="${msg_timeModulate}"/>\n                <SizeBasedTriggeringPolicy size="${every_file_size}"/>\n            </Policies>\n            <DefaultRolloverStrategy max="${msg_max}"/>\n        </RollingFile>\n\n        \x3c!-- \u914d\u7f6e\u91cd\u5199\u65e5\u5fd7 --\x3e\n        <Rewrite name="console_rewrite">\n            <DataMaskingRewritePolicy/>\n            <AppenderRef ref="console"/>\n        </Rewrite>\n\n        <Rewrite name="allLogFile_rewrite">\n            <DataMaskingRewritePolicy/>\n            <AppenderRef ref="allLogFile"/>\n        </Rewrite>\n\n        <Rewrite name="allLogFile_rewrite_json">\n            <DataMaskingRewritePolicy/>\n            <AppenderRef ref="allLogFile_json"/>\n        </Rewrite>\n\n        <Rewrite name="infoLogFile_rewrite">\n            <DataMaskingRewritePolicy/>\n            <AppenderRef ref="infoLogFile"/>\n        </Rewrite>\n\n        <Rewrite name="warnLogFile_rewrite">\n            <DataMaskingRewritePolicy/>\n            <AppenderRef ref="warnLogFile"/>\n        </Rewrite>\n\n        <Rewrite name="errorLogFile_rewrite">\n            <DataMaskingRewritePolicy/>\n            <AppenderRef ref="errorLogFile"/>\n        </Rewrite>\n    </appenders>\n\n    \x3c!--\u5b9a\u4e49logger,\u53ea\u6709\u5b9a\u4e49\u4e86logger\u5e76\u5f15\u5165\u4e86appender,appender\u624d\u4f1a\u751f\u6548--\x3e\n    <loggers>\n        \x3c!--\u8bb0\u5f55druid-sql\u7684\u8bb0\u5f55--\x3e\n        <Logger name="druid.sql.Statement" level="DEBUG" additivity="false">\n            <appender-ref ref="druidSqlLogFile"/>\n        </Logger>\n\n        \x3c!--\u8bb0\u5f55message\u6d88\u8d39\u65e5\u5fd7\u7684\u8bb0\u5f55--\x3e\n        <Logger name="msg.statistic.Log" level="DEBUG" additivity="false">\n            <appender-ref ref="msgStatisticLogfile"/>\n        </Logger>\n\n        \x3c!-- sql\u8bed\u53e5\u8f93\u51fa\u914d\u7f6e --\x3e\n        <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>\n        <logger name="org.hibernate.type.descriptor.sql.BasicExtractor" level="DEBUG"/>\n        <logger name="org.hibernate.SQL" level="DEBUG"/>\n        <logger name="org.hibernate.type" level="TRACE"/>\n        <logger name="org.hibernate.engine.QueryParameters" level="DEBUG"/>\n        <logger name="org.hibernate.engine.query.HQLQueryPlan" level="DEBUG"/>\n        <logger name="org.camunda" level="DEBUG"/>\n        <logger name="com.pisx.pd.datasource.lib.mybatis.interceptor" level="info"/>\n        <logger name="com.pisx.pd" level="debug"/>\n        <logger name="com.pisx.pd.dme.mybatis.MomQueryInterceptor" level="info"/>\n        \x3c!--<logger name="com.pisx" level="DEBUG" additivity="false">--\x3e\n        \x3c!--    <appender-ref ref="console_rewrite"/>--\x3e\n        \x3c!--</logger>--\x3e\n        \x3c!-- \u5c4f\u853d\u6389opcda\u65e5\u5fd7\u6253\u5370 --\x3e\n        <logger name="org.jinterop" level="WARN"/>\n        \x3c!--\u5efa\u7acb\u4e00\u4e2a\u9ed8\u8ba4\u7684root\u7684logger--\x3e\n        <root level="info">\n            <appender-ref ref="console_rewrite"/>\n            <appender-ref ref="allLogFile_rewrite"/>\n            \x3c!-- <appender-ref ref="allLogFile_rewrite_json"/> --\x3e\n            <appender-ref ref="infoLogFile_rewrite"/>\n            <appender-ref ref="warnLogFile_rewrite"/>\n            <appender-ref ref="errorLogFile_rewrite"/>\n        </root>\n    </loggers>\n</configuration>\n\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u8fd9\u91cc\u53ea\u589e\u52a0\u4e86\u4e00\u4e2a\u8f93\u51fa ",(0,a.jsx)(n.code,{children:"allLogFile_json"}),"\uff0c\u5c06\u4f1a\u751f\u6210\u4e00\u4e2a",(0,a.jsx)(n.code,{children:"{spring.application.name}-all-json.log"}),"\u7684\u6587\u4ef6\uff0c\u5176\u4f59\u90e8\u5206\u6ca1\u6709\u505a\u4fee\u6539"]}),"\n",(0,a.jsx)(n.h2,{id:"\u6784\u5efa\u955c\u50cf",children:"\u6784\u5efa\u955c\u50cf"}),"\n",(0,a.jsxs)(n.p,{children:["\u670d\u52a1\u6253\u5305",(0,a.jsx)(n.code,{children:"mvn clean package"}),"\u53ca\u4e0a\u4f20\u5230K8s\u6240\u5728\u670d\u52a1\u5668\u6b65\u9aa4\u7701\u7565"]}),"\n",(0,a.jsxs)(n.p,{children:["\u6784\u5efaDocker\u955c\u50cf\u7684 ",(0,a.jsx)(n.code,{children:"Dockerfile"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-Dockerfile",children:'FROM 192.168.1.210:5000/azul/zulu-openjdk-centos:17-jre-latest\nVOLUME /tmp\nADD pd-service-hzpublic.jar /\nENV JAVA_OPTS="-Xms1g -Xmx1g -XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m \\\n           -Duser.timezone=Asia/Shanghai \\\n           -Dfile.encoding=UTF-8 \\\n           -Dsun.jnu.encoding=UTF-8 \\\n           -Djava.awt.headless=true \\\n           --add-modules java.se \\\n           --add-opens java.base/java.lang=ALL-UNNAMED \\\n           --add-opens java.base/sun.nio.ch=ALL-UNNAMED \\\n           --add-opens java.management/sun.management=ALL-UNNAMED \\\n           --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED \\\n           --add-exports java.base/jdk.internal.ref=ALL-UNNAMED"\nENTRYPOINT java ${JAVA_OPTS} -jar /pd-service-hzpublic.jar\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u6309\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u6784\u5efa\u955c\u50cf\uff0c\u955c\u50cf\u7684tag\u4fdd\u6301\u4e00\u81f4\u5373\u53ef\uff0c\u524d\u9762\u7684\u4ed3\u5e93\u540d\u79f0\u53ef\u4ee5\u5220\u9664\u6216\u4fee\u6539"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u91cd\u65b0\u6253tag\ndocker tag azul/zulu-openjdk-centos:17-jre-latest 192.168.1.210:5000/azul/zulu-openjdk-centos:17-jre-latest\n\n# \u6784\u5efa\u955c\u50cf\ndocker build -t 192.168.1.210:5000/library/pd-service-hzpublic:prom-1.0.0 .\n\n# \u5bfc\u51fa\u955c\u50cf\ndocker save 192.168.1.210:5000/library/pd-service-hzpublic:prom-1.0.0 -o pd-service-hzpublic_prom-1.0.0.tar\n\n# \u53d1\u9001\u5230\u96c6\u7fa4\u5176\u4ed6\u8282\u70b9\nscp pd-service-hzpublic_prom-1.0.0.tar diginn@192.168.137.122:/home/diginn\n\n# \u5728\u96c6\u7fa4\u5176\u4ed6\u8282\u70b9\u5bfc\u5165\u955c\u50cf\ndocker load -i pd-service-hzpublic_prom-1.0.0.tar\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u91cc\u9700\u8981\u5c06\u6253\u5305\u540e\u7684\u955c\u50cf\u540c\u6b65\u5230\u96c6\u7fa4\u7684\u5176\u4ed6\u8282\u70b9\u4e0a\uff0c\u6216\u8005\u63a8\u9001\u5230\u81ea\u6258\u7ba1\u7684\u955c\u50cf\u4ed3\u5e93\uff0c\u4ee5\u514d\u670d\u52a1\u90e8\u7f72\u5230\u5176\u4ed6\u8282\u70b9\u65f6\u62c9\u53d6\u955c\u50cf\u5931\u8d25"}),"\n",(0,a.jsx)(n.h2,{id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49-2",children:"K8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49"}),"\n",(0,a.jsxs)(n.p,{children:["\u5e94\u7528\u90e8\u7f72\u7684\u5b9a\u4e49 ",(0,a.jsx)(n.code,{children:"k8s-dev.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Service\nmetadata:\n  name: svc-hz-service-hzpublic\n  namespace: hz-dev-service\n  labels:\n    app: hz-service-hzpublic\n    job: hz-service-hzpublic-job\nspec:\n  type: NodePort\n  selector:\n    app: hz-service-hzpublic\n  ports:\n    - name: http\n      port: 31121\n      targetPort: 31121\n      nodePort: 31121\n\n---\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: svc-dz-service-hzpublic\n  namespace: hz-dev-service\n  labels:\n    app: hz-service-hzpublic\n    # Prometheus\u6536\u96c6\u65e5\u5fd7\u7684\u6838\u5fc3\u6807\u8bc6\n    release: prometheus\nspec:\n  jobLabel: job\n  endpoints:\n    - interval: 5s\n      path: /hzpublic/actuator/prometheus\n      port: http\n  namespaceSelector:\n    any: true\n  selector:\n    matchLabels:\n      app: hz-service-hzpublic\n      job: hz-service-hzpublic-job\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hz-dev-service-hzpublic\n  namespace: hz-dev-service\nspec:\n  minReadySeconds: 50\n  revisionHistoryLimit: 3\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n  replicas: 1\n  selector:\n    matchLabels:\n      app: hz-service-hzpublic\n      version: "1.0.0"\n  template:\n    metadata:\n      labels:\n        app: hz-service-hzpublic\n        version: "1.0.0"\n      annotations:\n        # promtail \u6536\u96c6\u65e5\u5fd7\u7684\u6838\u5fc3\u914d\u7f6e\n        promtail.io/scrape: "true" # promtail\u7b5b\u9009\u6807\u7b7e\uff0c\u9700\u8981\u8bbe\u7f6escrape\u4e3atrue\n        promtail.io/path: "/logs/pd-service-hzpublic-all.log" # \u65e5\u5fd7\u6587\u4ef6\u7684\u8def\u5f84\u540d\u79f0\n    spec:\n      imagePullSecrets:\n        - name: pisxdocker\n      containers:\n        - name: hz-service-hzpublic\n          image: 192.168.1.210:5000/library/pd-service-hzpublic:prom-1.0.0\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 31121\n          volumeMounts:\n            - name: logs-hz-service-hzpublic\n              mountPath: /logs\n          # \u542f\u52a8\u63a2\u9488\uff0c\u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u542f\u52a8\u6210\u529f\n          startupProbe:\n            httpGet:\n              path: /hzpublic/actuator/health/readiness\n              port: 31121\n            periodSeconds: 10 # \u63a2\u6d4b\u65f6\u95f4\u95f4\u9694\n            timeoutSeconds: 5 # \u8d85\u65f6\u65f6\u95f4\n            failureThreshold: 30 # \u91cd\u8bd5\u6b21\u6570\n          # \u5b58\u6d3b\u63a2\u9488\uff0c\u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u5b58\u6d3b\n          livenessProbe:\n            httpGet:\n              path: /hzpublic/actuator/health/liveness\n              port: 31121\n            initialDelaySeconds: 30\n            periodSeconds: 10\n            timeoutSeconds: 20\n            failureThreshold: 5\n          resources:\n            limits:\n              cpu: "2"\n              memory: "2048Mi"\n              ephemeral-storage: "2Gi"\n            requests:\n              cpu: "0.2"\n              memory: "1024Mi"\n          env:\n            - name: TZ\n              value: \'Asia/Shanghai\'\n      volumes:\n        - name: logs-hz-service-hzpublic\n          hostPath:\n            path: /data/logs\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u91cd\u70b9\u5173\u6ce8\u4ee5\u4e0b\u4e24\u5757\u914d\u7f6e:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Prometheus\u6307\u6807\u91c7\u96c6\u7684\u6807\u8bc6: ",(0,a.jsx)(n.code,{children:"ServiceMonitor"})," \u4e0b\u7684 ",(0,a.jsx)(n.code,{children:"metadata.labels"})]}),"\n",(0,a.jsxs)(n.li,{children:["Promtail\u65e5\u5fd7\u6536\u96c6\u7684\u6807\u8bc6: ",(0,a.jsx)(n.code,{children:"Deployment"})," \u4e0b\u7684 ",(0,a.jsx)(n.code,{children:"spec.template.metadata.annotations"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u8d44\u6e90-2",children:"\u90e8\u7f72\u8d44\u6e90"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl create namespace hz-dev-service\nkubectl get namespace hz-dev-service\n\n# \u5982\u6709\u9700\u8981\uff0c\u5148\u5220\u9664\u518d\u90e8\u7f72\u670d\u52a1\nkubectl delete -f k8s-dev.yaml\n\nkubectl apply -f k8s-dev.yaml\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3-3",children:"\u90e8\u7f72\u5b8c\u6210\u540e\u83b7\u53d6\u670d\u52a1\u7684\u72b6\u6001\u53ca\u7aef\u53e3"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u770b Pod\nkubectl get pods -n hz-dev-service -o wide\n\n# \u8f93\u51fa\u7ed3\u679c\nNAME                                       READY   STATUS    RESTARTS      AGE   IP             NODE            NOMINATED NODE   READINESS GATES\nhz-dev-service-hzpublic-85d4549b5f-2f4v4   1/1     Running   2 (15m ago)   95m   10.244.95.36   k8s-master-02   <none>           <none>\n\n# \u67e5\u770b\u670d\u52a1\u7aef\u53e3\u4fe1\u606f\nkubectl get services -n hz-dev-service -o wide\n\n# \u8f93\u51fa\u7ed3\u679c\n[diginn@k8s-master-01 ~]$ kubectl get services -n hz-dev-service -o wide\nNAME                      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)           AGE   SELECTOR\nsvc-hz-service-hzpublic   NodePort   10.106.162.19   <none>        31121:31121/TCP   23h   app=hz-service-hzpublic\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9",children:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u8c03\u7528\u7aef\u70b9\ncurl -X GET -i 'http://192.168.137.121:31121/hzpublic/actuator/prometheus'\n\n"})}),"\n",(0,a.jsx)(n.h1,{id:"\u672c\u5730\u90e8\u7f72-spring-boot",children:"\u672c\u5730\u90e8\u7f72 Spring Boot"}),"\n",(0,a.jsx)(n.p,{children:"\u670d\u52a1\u6539\u9020\u6b65\u9aa4\u540c\u4e0a\u9762\u3010K8s\u90e8\u7f72SpringBoot\u3011\u7684\u3010\u670d\u52a1\u6539\u9020\u7ae0\u8282\u3011\uff0c\u8fd9\u91cc\u4e0d\u518d\u91cd\u590d\u3002"}),"\n",(0,a.jsx)(n.p,{children:"JVM\u90e8\u7f72\u53ca\u73af\u5883\u904d\u5386\u7684\u914d\u7f6e\u6b65\u9aa4\u4e5f\u7701\u7565\uff0c\u53ef\u4ee5\u53c2\u8003\u524d\u7f6e\u7684\u4e24\u7bc7\u6587\u7ae0\u6216\u7f51\u7edc\u4e0a\u641c\u7d22\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"\u542f\u52a8\u670d\u52a1",children:"\u542f\u52a8\u670d\u52a1"}),"\n",(0,a.jsxs)(n.p,{children:["\u8fd9\u91cc\u4ee5 ",(0,a.jsx)(n.code,{children:"pd-service-hzctm.jar"})," \u4e3a\u4f8b\uff0c\u521b\u5efa\u542f\u52a8\u548c\u505c\u6b62\u811a\u672c"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup java -jar pd-service-hzctm.jar > /dev/null 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u76f4\u63a5\u542f\u52a8\u670d\u52a1\u5373\u53ef"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"./startup.sh\n\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["*",(0,a.jsx)(n.strong,{children:"\u6ce8:"})," \u8f93\u51fa\u65e5\u5fd7\u6587\u4ef6\u7684\u8def\u5f84\u4e0d\u540c\u4f1a\u5f71\u54cdPromtail\u7684\u914d\u7f6e\uff0c\u8bf7\u6839\u636e\u5b9e\u9645\u8fdb\u884c\u4fee\u6539"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\u793a\u4f8b\u4e2d\u7684jar\u5305\u53ca\u811a\u672c\u8def\u5f84\u4e3a ",(0,a.jsx)(n.code,{children:"/home/diginn/lpg"})]}),"\n",(0,a.jsxs)(n.li,{children:["\u65e5\u5fd7\u7684\u8f93\u51fa\u8def\u5f84\u4e3a         ",(0,a.jsx)(n.code,{children:"/home/diginn/logs"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"k8s-\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49-3",children:"K8s \u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49"}),"\n",(0,a.jsxs)(n.p,{children:["\u7531\u4e8ePrometheus Operator\u7684\u6570\u636e\u91c7\u96c6\u4f9d\u8d56\u4e8e ",(0,a.jsx)(n.code,{children:"ServiceMonitor"}),"\uff0c\u8fd9\u91cc\u90e8\u7f72",(0,a.jsx)(n.code,{children:"Service"})," ",(0,a.jsx)(n.code,{children:"Endpoint"})," ",(0,a.jsx)(n.code,{children:"ServiceMonitor"})," \u5c06\u672c\u5730\u7684\u670d\u52a1\u4fe1\u606f\u6ce8\u518c\u5230K8s\u4e0a"]}),"\n",(0,a.jsxs)(n.p,{children:["K8s \u8d44\u6e90\u6587\u4ef6 ",(0,a.jsx)(n.code,{children:"k8s-local-boot.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: spring-boot-exporter\n  namespace: k8s-local-boot\n  # \u8fd9\u91cc\u7684labels\u8981\u548c ServiceMonitor \u7684 spec.selector.matchLabels \u4e00\u81f4\n  labels:\n    app: hz-service-hzctm\n    job: hz-service-hzctm-job\nspec:\n clusterIP: None\n type: ClusterIP\n\n---\n\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: spring-boot-exporter\n  namespace: k8s-local-boot\nsubsets:\n  # \u8fd9\u91ccIP\u7aef\u53e3\u4e3a\u672c\u5730\u670d\u52a1\u7684IP \u548c\u7aef\u53e3\n  - addresses:\n      - ip: 192.168.137.132\n    ports:\n      - name: http-metrics\n        port: 31122\n        protocol: TCP\n\n---\n\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: spring-boot-exporter\n  namespace: k8s-local-boot\n  labels:\n    app: hz-service-hzctm\n    # \u8fd9\u4e2a\u6807\u7b7e\u5fc5\u987b\u8981\u6709\uff0ckey\u548cvalue\u7684\u53d6\u503c\u89c1\u4e0a\u9762\u7ae0\u8282\u3010ServiceMonitor\u4e2d\u7684 `metadata.labels.realease: prometheus` \u8bf4\u660e\u3011\n    release: prometheus\nspec:\n  jobLabel: job\n  endpoints:\n    # \u6307\u6807\u91c7\u96c6\u7684\u7aef\u70b9\u4fe1\u606f\uff0c\u7aef\u53e3\u5f15\u7528\u4e0a\u9762Endpoints\u4e2d\u5b9a\u4e49\u7684port\uff0cpath\u4e3a\u6307\u6807\u7aef\u70b9\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u9700\u8981\u5305\u542b\u670d\u52a1\u7684contextpath\n    - port: http-metrics\n      interval: 5s\n      honorLabels: true\n      scheme: http\n      path: /hzctm/actuator/prometheus\n  selector:\n    # \u8fd9\u91cc\u7684\u53d6\u503c\u8981\u548cService \u7684 metadata.labels \u4e00\u81f4\n    matchLabels:\n      app: hz-service-hzctm\n      job: hz-service-hzctm-job\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u8d44\u6e90-3",children:"\u90e8\u7f72\u8d44\u6e90"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl get namespace k8s-local-boot\nkubectl create namespace k8s-local-boot\n\n# \u90e8\u7f72\nkubectl apply -f k8s-local-boot.yaml\n\n# \u5220\u9664\nkubectl apply -f k8s-local-boot.yaml\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9-1",children:"\u6d4b\u8bd5\u8c03\u7528\u6307\u6807\u91c7\u96c6\u7aef\u70b9"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u8c03\u7528\u7aef\u70b9\ncurl -X GET -i 'http://192.168.137.132:31122/hzctm/actuator/prometheus'\n\n"})}),"\n",(0,a.jsx)(n.h1,{id:"\u672c\u5730\u90e8\u7f72-nginx",children:"\u672c\u5730\u90e8\u7f72 Nginx"}),"\n",(0,a.jsxs)(n.p,{children:["Nginx\u7684\u6309\u7167\u90e8\u7f72\u6b65\u9aa4\u7701\u7565\uff0c\u8fd9\u91cc\u4e3b\u8981\u65f6\u4fee\u6539Nginx\u914d\u7f6e\uff0c\u8f93\u51fajson\u683c\u5f0f\u7684 ",(0,a.jsx)(n.code,{children:"access_log"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-conf",children:'    ##\n    # Logging Settings\n    ##\n    log_format access_json escape=json\n      \'{\'\n        \'"@timestamp":"$time_iso8601",\'\n        \'"host":"$server_addr",\'\n        \'"clientip":"$remote_addr",\'\n        \'"size":$body_bytes_sent,\'\n        \'"responsetime":$request_time,\'\n        \'"upstreamtime":"$upstream_response_time",\'\n        \'"upstreamhost":"$upstream_addr",\'\n        \'"request":"$request",\'\n        \'"uri":"$uri",\'\n        \'"domain":"$host",\'\n        \'"x_forwarded_for":"$http_x_forwarded_for",\'\n        \'"referer":"$http_referer",\'\n        \'"tcp_xff":"$proxy_protocol_addr",\'\n        \'"http_user_agent":"$http_user_agent",\'\n        \'"status":"$status"\'\n      \'}\';\n\n    access_log /var/log/nginx/access.log access_json;\n\n'})}),"\n",(0,a.jsx)(n.h1,{id:"\u672c\u5730\u90e8\u7f72-promtail",children:"\u672c\u5730\u90e8\u7f72 Promtail"}),"\n",(0,a.jsx)(n.p,{children:"\u867d\u7136\u5728K8s\u4e2d\u90e8\u7f72\u4e86Promtail\uff0c\u4f46\u662f\u53ea\u80fd\u91c7\u96c6\u5bb9\u5668\u7684\u65e5\u5fd7\uff0c\u672c\u5730\u90e8\u7f72\u7684Nginx\u53caSpring Boot\u5e94\u7528\u65e5\u5fd7\u4ecd\u7136\u9700\u8981\u672c\u5730\u90e8\u7f72Promtail\u6765\u91c7\u96c6"}),"\n",(0,a.jsx)(n.h2,{id:"\u5b89\u88c5promtail",children:"\u5b89\u88c5Promtail"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u4e0b\u8f7d\u5b89\u88c5\u5305\nwget https://github.com/grafana/loki/releases/download/v3.5.1/promtail-linux-amd64.zip      -O promtail-linux-amd64.zip\n\n# \u4e0b\u8f7d\u914d\u7f6e\u6587\u4ef6\nwget https://raw.githubusercontent.com/grafana/loki/v3.5.1/clients/cmd/promtail/promtail-local-config.yaml -O promtail-local-config.yaml\n\n# \u89e3\u538b\nunzip promtail-linux-amd64.zip -d /usr/local/promtail/\n\n# \u914d\u7f6e\u6587\u4ef6\ncp promtail-local-config.yaml /usr/local/promtail/\n\n# \u8fd0\u884c\ncd /usr/local/promtail\n./promtail-linux-amd64 -config.file=promtail-local-config.yaml\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u914d\u7f6e\u6587\u4ef6",children:"\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,a.jsxs)(n.p,{children:["\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u91c7\u96c6Spring Boot\u53caNginx\u65e5\u5fd7 ",(0,a.jsx)(n.code,{children:"promtail-local-config.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://192.168.137.121:30310/loki/api/v1/push\n\nscrape_configs:\n- job_name: nginx-log\n  # \u6293\u53d6\u672c\u5730Nginx\u65e5\u5fd7\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: nginx-log\n      __path__: /var/log/nginx/*.log\n  # \u7ed9\u6587\u4ef6\u6253\u6807\u7b7e\uff0c\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u4ef6\u91c7\u7528\u4e0d\u540c\u7684\u89e3\u6790\u7b56\u7565\n  relabel_configs:\n  - source_labels: [__path__]\n    regex: .*\n    action: replace\n    target_label: log_type\n    replacement: text  # \u9ed8\u8ba4\u7c7b\u578b\n  - source_labels: [__path__]\n    regex: .*(access).* # accesslog\u683c\u5f0f\u6539\u4e3ajson\u4e86\uff0c\u4f7f\u7528json\u89e3\u6790\n    replacement: json\n    target_label: log_type\n  pipeline_stages:\n  # \u89e3\u6790\u666e\u901a\u6587\u672c\n  - match:\n      selector: '{log_type=\"text\"}'\n      stages:\n        # - debug:\n        #   message: 'File: {{ .__path__ }} | Log type: {{ .log_type }} | __Log type__: {{ .__log_type__ }}' \n        - regex:\n            expression: '^(?P<timestamp>\\d{4}/\\d{2}/\\d{2} \\d{2}:\\d{2}:\\d{2}) \\[(?P<level>\\w+)\\] (?P<pid>\\d+)\\#(?P<tid>\\d+): \\*(?P<message>.*)$'\n        - json:\n            output: log\n            expressions:\n              timestamp: timestamp\n              level: level\n              process_id: pid\n              thread_id: tid\n              message: message\n        # 3. \u8bbe\u7f6e\u65e5\u5fd7\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006/01/02 15:04:05\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n          \n        # 4. \u5c06\u5173\u952e\u5b57\u6bb5\u8f6c\u4e3a\u6807\u7b7e\uff08\u4f4e\u57fa\u6570\u5b57\u6bb5\uff09\n        - labels:\n            level:\n          \n        # 5. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u9ad8\u57fa\u6570\u5b57\u6bb5\uff09\n        - structured_metadata:\n            process_id:\n            thread_id:\n  # \u89e3\u6790json\n  - match:\n      selector: '{log_type=\"json\"}'\n      stages:\n        - json:\n            expressions: \n              timestamp: '\"@timestamp\"'\n              host: host\n              clientip: clientip\n              size: size\n              responsetime: responsetime\n              upstreamtime: upstreamtime\n              upstreamhost: upstreamhost\n              request: request\n              uri: uri\n              domain: domain\n              x_forwarded_for: x_forwarded_for\n              referer: referer\n              tcp_xff: tcp_xff\n              http_user_agent: http_user_agent\n              status: status\n            max_depth: 3  # \u9632\u6b62\u6df1\u5c42\u5d4c\u5957\u6d88\u8017\u8d44\u6e90\n            drop_malformed: true  # \u4e22\u5f03\u65e0\u6548JSON\n        # 2. \u8bbe\u7f6e\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006-01-02 15:04:05.000\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n        # 3. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u4f7f\u5b57\u6bb5\u663e\u793a\u5728 Parsed Fields\uff09\n        - structured_metadata:\n            clientip:\n            x_forwarded_for:\n            request:\n            domain:\n            uri:\n            status:\n- job_name: pd-service\n  # \u6293\u53d6\u672c\u5730SpringBoot\u65e5\u5fd7\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: pd-service\n      __path__: /home/diginn/logs/*.log\n  # \u7ed9\u6587\u4ef6\u6253\u6807\u7b7e\uff0c\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u4ef6\u91c7\u7528\u4e0d\u540c\u7684\u89e3\u6790\u7b56\u7565\n  relabel_configs:\n  - source_labels: [__path__]\n    regex: .*\n    action: replace\n    target_label: log_type\n    replacement: text  # \u9ed8\u8ba4\u7c7b\u578b\n  - source_labels: [__path__]\n    regex: .*(json).* # json\u683c\u5f0f\u7684\u65e5\u5fd7\u540d\u79f0\u4e2d\u5305\u542b json\n    replacement: json\n    target_label: log_type\n  pipeline_stages:\n  # \u89e3\u6790\u666e\u901a\u6587\u672c\n  - match:\n      selector: '{log_type=\"text\"}'\n      stages:\n        # - debug:\n        #   message: 'File: {{ .__path__ }} | Log type: {{ .log_type }} | __Log type__: {{ .__log_type__ }}' \n        # 1. \u4f7f\u7528\u6b63\u5219\u63d0\u53d6\u6240\u6709\u5b57\u6bb5 %d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{requestId}] [%-5level] %C.%M[%L line] - %m%n\n        - regex:\n            expression: '^(?P<timestamp>\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d{3}) \\[(?P<thread>[^\\]]*)\\] \\[(?P<request_id>[^\\]]*)\\] \\[(?P<level>\\w+)\\s*\\] (?P<class>\\w+(?:\\.\\w+)*)\\.(?P<method>\\w+)\\[(?P<line>\\d+) line\\] - (?P<message>.*)$'\n          \n        # 2. \u6e05\u7406 level \u5b57\u6bb5\u7684\u7a7a\u683c\uff08Log4j2 \u5de6\u5bf9\u9f50\u8865\u7a7a\u683c\uff09\n        - replace:\n            source: level\n            expression: '\\s+$'\n            replace: ''\n          \n        # 3. \u8bbe\u7f6e\u65e5\u5fd7\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006-01-02 15:04:05.000\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n          \n        # 4. \u5c06\u5173\u952e\u5b57\u6bb5\u8f6c\u4e3a\u6807\u7b7e\uff08\u4f4e\u57fa\u6570\u5b57\u6bb5\uff09\n        - labels:\n            level:\n            request_id:\n          \n        # 5. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u9ad8\u57fa\u6570\u5b57\u6bb5\uff09\n        - structured_metadata:\n            thread: thread  # \u5f15\u7528 regex \u63d0\u53d6\u7684\u5b57\u6bb5\n            class: class\n            method: method\n            line: line\n        # - template:\n        #     source: new_line\n        #     template: 'logger={{ .class }} threadName={{ .thread }} methodName={{ .method }} line={{ .line }} | {{ or .message .stack_trace }}'\n        # - output:\n        #     source: new_line\n  # \u89e3\u6790json\n  - match:\n      selector: '{log_type=\"json\"}'\n      stages:\n        # 1. \u89e3\u6790 JSON \u5e76\u63d0\u53d6\u5b57\u6bb5\n        - json:\n            expressions: \n              thread: thread\n              threadId: threadId\n              level: level\n              loggerName: loggerName\n              message: message\n              requestId: requestId\n              timestamp: timestamp\n            max_depth: 3  # \u9632\u6b62\u6df1\u5c42\u5d4c\u5957\u6d88\u8017\u8d44\u6e90\n            drop_malformed: true  # \u4e22\u5f03\u65e0\u6548JSON\n        # 2. \u8bbe\u7f6e\u65f6\u95f4\u6233\n        - timestamp:\n            source: timestamp\n            format: \"2006-01-02 15:04:05.000\"\n            location: Asia/Shanghai   # \u5982\u679c\u65e5\u5fd7\u65f6\u95f4\u5b57\u7b26\u4e32\u662f\u5317\u4eac\u65f6\u95f4\uff08UTC+8\uff09\n        # 3. \u6dfb\u52a0\u7ed3\u6784\u5316\u5143\u6570\u636e\uff08\u4f7f\u5b57\u6bb5\u663e\u793a\u5728 Parsed Fields\uff09\n        - structured_metadata:\n            thread:\n            threadId:\n            level:\n            loggerName:\n            requestId:\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u91cd\u70b9\u5173\u6ce8\u4ee5\u4e0b\u51e0\u4e2a\u5c5e\u6027"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"clients.url"}),": Loki \u670d\u52a1\u7684\u5730\u5740\u4e3a ",(0,a.jsx)(n.code,{children:"http://192.168.137.121:30310/loki/api/v1/push"})]}),"\n",(0,a.jsxs)(n.li,{children:["pd-service ",(0,a.jsx)(n.code,{children:"static_configs.labels.__path__"}),": Spring Boot\u65e5\u5fd7\u8def\u5f84 ",(0,a.jsx)(n.code,{children:"/home/diginn/logs/*.log"})]}),"\n",(0,a.jsxs)(n.li,{children:["nginx-log ",(0,a.jsx)(n.code,{children:"static_configs.labels.__path__"}),": Nginx \u65e5\u5fd7\u8def\u5f84 ",(0,a.jsx)(n.code,{children:"/var/log/nginx/*.log"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u542f\u52a8\u670d\u52a1-1",children:"\u542f\u52a8\u670d\u52a1"}),"\n",(0,a.jsx)(n.p,{children:"\u542f\u505c\u811a\u672c"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup ./promtail-linux-amd64 -config.file=promtail-local-config.yaml >./promtail.log 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u542f\u52a8Promtail"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"./startup.sh\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684web\u9875\u9762-3",children:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u670d\u52a1\u7684Web\u9875\u9762"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Promtail \u4e3b\u754c\u9762 ",(0,a.jsx)(n.code,{children:"http://192.168.137.132:9080"})]}),"\n"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"URL"}),(0,a.jsx)(n.th,{children:"\u4ecb\u7ecd"}),(0,a.jsx)(n.th,{children:"\u5907\u6ce8"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/"}),(0,a.jsx)(n.td,{children:"\u4e3b\u754c\u9762"}),(0,a.jsx)(n.td,{children:"\u4e3b\u754c\u9762\u9ed8\u8ba4\u8df3\u8f6c\u5230 /targets"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/service-discovery"}),(0,a.jsx)(n.td,{children:"\u670d\u52a1\u53d1\u73b0\u9875"}),(0,a.jsx)(n.td,{children:"\u8bb0\u5f55\u6536\u96c6\u65e5\u5fd7\u7684job\u540d\u79f0\u53ca\u6807\u7b7e\u4fe1\u606f"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/config"}),(0,a.jsx)(n.td,{children:"\u914d\u7f6e\u9875"}),(0,a.jsx)(n.td,{children:"Promtail\u7684\u914d\u7f6e\u4fe1\u606f"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"/targets"}),(0,a.jsx)(n.td,{children:"\u6536\u96c6\u76ee\u6807"}),(0,a.jsx)(n.td,{children:"\u65e5\u5fd7\u6587\u4ef6\u6240\u5c5e\u7684job\uff0c\u6807\u7b7e\uff0c\u8def\u5f84\uff0c\u8bfb\u53d6\u4f4d\u7f6e\u7b49\u4fe1\u606f"})]})]})]}),"\n",(0,a.jsx)(n.h1,{id:"\u672c\u5730\u90e8\u7f72-prometheus-exporter",children:"\u672c\u5730\u90e8\u7f72 Prometheus Exporter"}),"\n",(0,a.jsx)(n.p,{children:"\u6b64\u5904\u4ee5Node-Exporter\u4e3a\u91cc\uff0c\u7528\u4e8e\u76d1\u63a7\u975eK8s\u96c6\u7fa4\u8282\u70b9\u7684\u670d\u52a1\u5668\u72b6\u6001\u4fe1\u606f\uff0c\u7406\u8bba\u4e0a\u6765\u8bf4\u9002\u7528\u4e8e\u6240\u6709\u975eK8s\u7684\u4fe1\u606f\u91c7\u96c6"}),"\n",(0,a.jsx)(n.h2,{id:"\u672c\u5730\u90e8\u7f72node-exporter",children:"\u672c\u5730\u90e8\u7f72Node-Exporter"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/prometheus/exporter-toolkit/blob/master/docs/web-configuration.md",children:"Node-Exporter\u914d\u7f6e\u6587\u4ef6\u8bf4\u660e"})}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'# \u4e0b\u8f7d\nwget https://github.com/prometheus/node_exporter/releases/download/v1.9.1/node_exporter-1.9.1.linux-amd64.tar.gz\n\n# \u89e3\u538b\ntar -zxvf node_exporter-1.9.1.linux-amd64.tar.gz\n\n# \u8fd0\u884c\ncd node_exporter-1.9.1.linux-amd64/\n./node_exporter --web.listen-address=:9100 --web.config.file="web-config.yaml"\n\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u542f\u52a8\u670d\u52a1-2",children:"\u542f\u52a8\u670d\u52a1"}),"\n",(0,a.jsx)(n.p,{children:"\u542f\u505c\u811a\u672c"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u542f\u52a8\u811a\u672c\ncat > startup.sh << 'EOF'\n#!/bin/bash\nnohup ./node_exporter --web.listen-address=:9100 >./node-exporter.log 2>&1 &\necho \"$!\" > pid\nEOF\n\n# \u505c\u6b62\u811a\u672c\ncat > shutdown.sh << 'EOF'\n#!/bin/bash\nkill -9 `cat pid`\necho \"\u5173\u95ed\u6210\u529f!\"\nEOF\n\n# \u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x startup.sh shutdown.sh\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u542f\u52a8NodeExporter"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"./startup.sh\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"k8s-\u8d44\u6e90\u6587\u4ef6\u7684\u5b9a\u4e49",children:"K8s \u8d44\u6e90\u6587\u4ef6\u7684\u5b9a\u4e49"}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u90e8\u5206\u540c\u3010\u672c\u5730\u90e8\u7f72 Spring Boot\u3011\u7684\u3010K8s \u8d44\u6e90\u6587\u4ef6\u7684\u5b9a\u4e49\u3011\u7ae0\u8282\uff0c\u53ea\u9700\u8981\u505a\u5c11\u8bb8\u7684\u4fee\u6539\u5373\u53ef"}),"\n",(0,a.jsxs)(n.p,{children:["K8s \u8d44\u6e90\u6587\u4ef6 ",(0,a.jsx)(n.code,{children:"k8s-local-node.yaml"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: local-node-exporter\n  namespace: k8s-local-node\n  # \u8fd9\u91cc\u7684labels\u8981\u548c ServiceMonitor \u7684 spec.selector.matchLabels \u4e00\u81f4\n  labels:\n    app: node-exporter\n    job: node-exporter-job\nspec:\n clusterIP: None\n type: ClusterIP\n\n---\n\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: local-node-exporter\n  namespace: k8s-local-node\nsubsets:\n  # \u8fd9\u91ccIP\u7aef\u53e3\u4e3a\u672c\u5730\u670d\u52a1\u7684IP \u548c\u7aef\u53e3\n  - addresses:\n      - ip: 192.168.137.132\n    ports:\n      - name: http-metrics\n        port: 9100\n        protocol: TCP\n\n---\n\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: local-node-exporter\n  namespace: k8s-local-node\n  labels:\n    app: node-exporter\n    # \u8fd9\u4e2a\u6807\u7b7e\u5fc5\u987b\u8981\u6709\uff0ckey\u548cvalue\u7684\u53d6\u503c\u89c1\u4e0a\u9762\u7ae0\u8282\u3010ServiceMonitor\u4e2d\u7684 `metadata.labels.realease: prometheus` \u8bf4\u660e\u3011\n    release: prometheus\nspec:\n  jobLabel: job\n  endpoints:\n    # \u6307\u6807\u91c7\u96c6\u7684\u7aef\u70b9\u4fe1\u606f\uff0c\u7aef\u53e3\u5f15\u7528\u4e0a\u9762Endpoints\u4e2d\u5b9a\u4e49\u7684port\uff0cpath\u4e3a\u6307\u6807\u7aef\u70b9\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u9700\u8981\u5305\u542b\u670d\u52a1\u7684contextpath\n    - port: http-metrics\n      interval: 5s\n      honorLabels: true\n      scheme: http\n      path: /\n  selector:\n    # \u8fd9\u91cc\u7684\u53d6\u503c\u8981\u548cService \u7684 metadata.labels \u4e00\u81f4\n    matchLabels:\n      app: node-exporter\n      job: node-exporter-job\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72\u8d44\u6e90-4",children:"\u90e8\u7f72\u8d44\u6e90"}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u90e8\u5206\u540c\u3010\u672c\u5730\u90e8\u7f72 Spring Boot\u3011\u7684\u3010\u90e8\u7f72\u8d44\u6e90\u3011\u7ae0\u8282"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl get namespace k8s-local-node\nkubectl create namespace k8s-local-node\n\n# \u90e8\u7f72\nkubectl apply -f k8s-local-node.yaml\n\n# \u5220\u9664\nkubectl apply -f k8s-local-node.yaml\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u8bbf\u95eeNode-Exporter\u670d\u52a1Web\u9875\u9762: ",(0,a.jsx)(n.a,{href:"http://192.168.137.132:9100/",children:"http://192.168.137.132:9100/"})]}),"\n",(0,a.jsx)(n.h1,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,a.jsx)(n.p,{children:"\u6309\u7167\u4e0a\u9762\u7684\u6b65\u9aa4\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5f97\u5230\u4e86\u4e0b\u9762\u7684\u8fd9\u4e9b\u670d\u52a1"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"K8s \u90e8\u7f72\u6709\u72b6\u6001\u7684 Promtetheus \u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"K8s \u90e8\u7f72\u6709\u72b6\u6001\u7684 Loki \u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"K8s \u7ba1\u7406\u7684 Grafana \u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"K8s DaemonSet \u8fd0\u884c\u7684 Promtail \u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"K8s \u90e8\u7f72 Spring Boot \u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"\u672c\u5730\u90e8\u7f72 Spring Boot\u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"\u672c\u5730\u90e8\u7f72 Nginx \u670d\u52a1"}),"\n",(0,a.jsx)(n.li,{children:"\u672c\u5730\u90e8\u7f72 Promtail \u670d\u52a1"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"\u53ef\u4ee5\u5b9e\u73b0\u4ee5\u4e0b\u7684\u529f\u80fd"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"K8s \u96c6\u7fa4\u7684\u76d1\u63a7(\u670d\u52a1\u5668\u3001K8s)"}),"\n",(0,a.jsx)(n.li,{children:"K8s \u90e8\u7f72\u670d\u52a1\u7684\u76d1\u63a7\uff08JVM\u3001Spring Boot\uff09"}),"\n",(0,a.jsx)(n.li,{children:"\u672c\u5730\u90e8\u7f72\u670d\u52a1\u7684\u76d1\u63a7\uff08\u670d\u52a1\u5668\u3001Spring Boot\uff09"}),"\n",(0,a.jsx)(n.li,{children:"K8s \u670d\u52a1\u65e5\u5fd7\u7684\u6536\u96c6"}),"\n",(0,a.jsx)(n.li,{children:"\u672c\u5730\u670d\u52a1\u65e5\u5fd7\u7684\u6536\u96c6\uff08Nginx\u3001Spring Boot\uff09"}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);