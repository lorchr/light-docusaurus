"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[75554],{20902:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>p,frontMatter:()=>t,metadata:()=>l,toc:()=>i});const l=JSON.parse('{"id":"zh-cn/database/Pgsql-Cluster-Install","title":"Pgsql-Cluster-Install","description":"Pgsql \u96c6\u7fa4\u5b89\u88c5 (Docker\u7248)","source":"@site/docs/zh-cn/database/11-Pgsql-Cluster-Install.md","sourceDirName":"zh-cn/database","slug":"/zh-cn/database/Pgsql-Cluster-Install","permalink":"/docs/zh-cn/database/Pgsql-Cluster-Install","draft":false,"unlisted":false,"editUrl":"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/database/11-Pgsql-Cluster-Install.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{},"sidebar":"troch","previous":{"title":"Mysql-Cluster-Install","permalink":"/docs/zh-cn/database/Mysql-Cluster-Install"},"next":{"title":"Hikari-Dynamic-Change-Password","permalink":"/docs/zh-cn/database/Hikari-Dynamic-Change-Password"}}');var a=s(74848),r=s(28453);const t={},d=void 0,c={},i=[{value:"Pgsql \u96c6\u7fa4\u5b89\u88c5 (Docker\u7248)",id:"pgsql-\u96c6\u7fa4\u5b89\u88c5-docker\u7248",level:2},{value:"1. \u90e8\u7f72\u5bb9\u5668IP",id:"1-\u90e8\u7f72\u5bb9\u5668ip",level:3},{value:"2. \u4e3b\u5e93\u914d\u7f6e\uff08Master\uff09",id:"2-\u4e3b\u5e93\u914d\u7f6emaster",level:3},{value:"1. \u521d\u59cb\u5316\u4e3b\u5e93",id:"1-\u521d\u59cb\u5316\u4e3b\u5e93",level:4},{value:"2. \u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e",id:"2-\u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e",level:4},{value:"3. \u4e3b\u5e93 <code>$PGDATA/pg_hba.conf</code> \u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236",id:"3-\u4e3b\u5e93-pgdatapg_hbaconf-\u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236",level:4},{value:"4. \u4e3b\u5e93 <code>$PGDATA/postgresql.conf</code> \u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570",id:"4-\u4e3b\u5e93-pgdatapostgresqlconf-\u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570",level:4},{value:"5. \u91cd\u542f\u4e3b\u5e93",id:"5-\u91cd\u542f\u4e3b\u5e93",level:4},{value:"3. \u4ece\u5e93\u914d\u7f6e (Slave Docker\u90e8\u7f72)",id:"3-\u4ece\u5e93\u914d\u7f6e-slave-docker\u90e8\u7f72",level:3},{value:"1. \u521d\u59cb\u5316\u4ece\u5e93",id:"1-\u521d\u59cb\u5316\u4ece\u5e93",level:4},{value:"2. \u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93",id:"2-\u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93",level:4},{value:"3. \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",id:"3-\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",level:4},{value:"4. \u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93",id:"4-\u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93",level:4},{value:"4. \u4ece\u5e93\u914d\u7f6e (Standby \u7269\u7406\u673a\u90e8\u7f72)",id:"4-\u4ece\u5e93\u914d\u7f6e-standby-\u7269\u7406\u673a\u90e8\u7f72",level:3},{value:"1. \u521d\u59cb\u5316\u4ece\u5e93",id:"1-\u521d\u59cb\u5316\u4ece\u5e93-1",level:4},{value:"2. \u505c\u6b62\u4ece\u5e93\uff0c\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\uff0c\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",id:"2-\u505c\u6b62\u4ece\u5e93\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",level:4},{value:"5. \u91cd\u542f\u4ece\u5e93",id:"5-\u91cd\u542f\u4ece\u5e93",level:4},{value:"5. \u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",id:"5-\u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",level:3},{value:"1. \u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f",id:"1-\u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f",level:4},{value:"2. \u67e5\u8be2\u8282\u70b9\u72b6\u6001",id:"2-\u67e5\u8be2\u8282\u70b9\u72b6\u6001",level:4},{value:"3. \u6570\u636e\u540c\u6b65\u6d4b\u8bd5",id:"3-\u6570\u636e\u540c\u6b65\u6d4b\u8bd5",level:4},{value:"4. \u79fb\u9664\u8282\u70b9",id:"4-\u79fb\u9664\u8282\u70b9",level:4},{value:"6. \u521b\u5efa\u53ea\u8bfb\u8d26\u53f7",id:"6-\u521b\u5efa\u53ea\u8bfb\u8d26\u53f7",level:3}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"pgsql-\u96c6\u7fa4\u5b89\u88c5-docker\u7248",children:"Pgsql \u96c6\u7fa4\u5b89\u88c5 (Docker\u7248)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://blog.csdn.net/pgdba/article/details/133820811",children:"\u8fdb\u9636\u6570\u636e\u5e93\u7cfb\u5217\uff08\u5341\u4e94\uff09\uff1aPostgreSQL \u4e3b\u4ece\u540c\u6b65\u539f\u7406\u4e0e\u5b9e\u8df5"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://blog.csdn.net/qq_33445829/article/details/130727228",children:"Centos7.6\u90e8\u7f72postgresql15\u4e3b\u4ece"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"http://www.postgres.cn/docs/12/warm-standby.html#STANDBY-SERVER-OPERATION",children:"26.2. \u65e5\u5fd7\u4f20\u9001\u540e\u5907\u670d\u52a1\u5668"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://pgtune.leopard.in.ua/",children:"PGTune - calculate configuration for PostgreSQL based on the maximum performance for a given hardware configuration"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://blog.csdn.net/m0_38129431/article/details/111316018",children:"ShardingSphere4.0.0-RC1\u5b9e\u73b0\u5206\u5e93\u5206\u8868+\u8bfb\u5199\u5206\u79bb"})}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"1-\u90e8\u7f72\u5bb9\u5668ip",children:"1. \u90e8\u7f72\u5bb9\u5668IP"}),"\n",(0,a.jsx)(n.p,{children:"\u4e3a\u4e86\u56fa\u5b9aIP\u53ef\u4ee5\u5355\u72ec\u521b\u5efa\u4e00\u4e2a\u7f51\u7edc"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u4e3b\u8282\u70b9 master: 172.18.0.2  \uff08Docker\u90e8\u7f72\uff09"}),"\n",(0,a.jsx)(n.li,{children:"\u4ece\u8282\u70b91 slave : 172.18.0.3 \uff08Docker\u90e8\u7f72\uff09"}),"\n",(0,a.jsx)(n.li,{children:"\u4ece\u8282\u70b92 standby: 172.18.0.1 \uff08\u7269\u7406\u673a\u90e8\u7f72\uff09"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u7f51\u7edc\ndocker network create --subnet=172.18.0.0/16 dev\n\n# \u5bb9\u5668\u521b\u5efa\u540e\u53ef\u4ee5\u4f7f\u7528\u6b64\u547d\u4ee4\u67e5\u770b\u5bb9\u5668IP\ndocker inspect pgsql-master | grep IPAddress \n"})}),"\n",(0,a.jsx)(n.h3,{id:"2-\u4e3b\u5e93\u914d\u7f6emaster",children:"2. \u4e3b\u5e93\u914d\u7f6e\uff08Master\uff09"}),"\n",(0,a.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u4e3b\u5e93",children:"1. \u521d\u59cb\u5316\u4e3b\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u6587\u4ef6\u5939\nmkdir -p //d/docker/pgsql-master/{conf,data,logs}\n\n# \u8fd0\u884c\u5bb9\u5668\ndocker run -d \\\n  --publish 5433:5432 \\\n  --volume //d/docker/pgsql-master/data:/var/lib/postgresql/data \\\n  --env PGDATA=/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=postgres \\\n  --net dev \\\n  --ip 172.18.0.2 \\\n  --restart=no \\\n  --name postgres-master \\\n  postgres:15.3\n"})}),"\n",(0,a.jsx)(n.h4,{id:"2-\u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e",children:"2. \u4e3b\u5e93\u521b\u5efa\u8d26\u53f7\u540c\u6b65\u6570\u636e"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u8fdb\u5165\u5bb9\u5668\u547d\u4ee4\u884c\ndocker exec -it -u root postgres-master /bin/bash\n\n# \u521b\u5efa\u5f52\u6863\u65e5\u5fd7\u76ee\u5f55\nmkdir -p $PGDATA/pg_archive\n\n# \u521b\u5efa\u540c\u6b65\u8d26\u6237\npsql -h localhost -p 5432 -U postgres -W -d postgres\nCREATE ROLE replica login replication encrypted password 'replica';\n"})}),"\n",(0,a.jsxs)(n.h4,{id:"3-\u4e3b\u5e93-pgdatapg_hbaconf-\u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236",children:["3. \u4e3b\u5e93 ",(0,a.jsx)(n.code,{children:"$PGDATA/pg_hba.conf"})," \u6587\u4ef6\u589e\u52a0\u5907\u5e93\u8bbf\u95ee\u63a7\u5236"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-conf",children:"# replica    \u4e0a\u9762\u521b\u5efa\u7684\u8d26\u6237\n# 172.18.0.3 \u4ece\u8282\u70b9\u7684IP\nhost    replication     replica         172.18.0.3/32           trust\nhost    replication     replica         172.18.0.1/32           trust\n"})}),"\n",(0,a.jsxs)(n.h4,{id:"4-\u4e3b\u5e93-pgdatapostgresqlconf-\u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570",children:["4. \u4e3b\u5e93 ",(0,a.jsx)(n.code,{children:"$PGDATA/postgresql.conf"})," \u6587\u4ef6\u6dfb\u52a0\u4e3b\u4ece\u540c\u6b65\u53c2\u6570"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-conf",children:"# basic\nlisten_addresses = '*'                # \u76d1\u542c\u6240\u6709ip\nport = 5432                           # \u7aef\u53e3\nmax_connections = 1000                # \u6700\u5927\u8fde\u63a5\u6570\nsuperuser_reserved_connections = 10   # \u7ed9\u8d85\u7ea7\u7528\u6237\u9884\u7559\u7684\u8fde\u63a5\u6570\nshared_buffers = 1GB                  # \u5171\u4eab\u5185\u5b58\uff0c\u4e00\u822c\u8bbe\u7f6e\u4e3a\u5185\u5b58\u76841/4\nwork_mem = 16MB                       # \u8bbe\u7f6e\u5728\u5199\u5165\u4e34\u65f6\u78c1\u76d8\u6587\u4ef6\u4e4b\u524d\u67e5\u8be2\u64cd\u4f5c(\u4f8b\u5982\u6392\u5e8f\u6216\u54c8\u5e0c\u8868)\u53ef\u4f7f\u7528\u7684\u6700\u5927\u5185\u5b58\u5bb9\u91cf\nmaintenance_work_mem = 256MB          # \u5728\u7ef4\u62a4\u6027\u64cd\u4f5c\uff08\u4f8b\u5982VACUUM\u3001CREATE INDEX\u548cALTER TABLE ADD FOREIGN KEY\uff09\u4e2d\u4f7f\u7528\u7684 \u6700\u5927\u7684\u5185\u5b58\u91cf\ntimezone = 'Asia/Shanghai'            # \u7cfb\u7edf\u65f6\u533a\nhot_standby = on                      # \u6253\u5f00\u70ed\u5907\n\n# optimizer\ndefault_statistics_target = 500       # \u9ed8\u8ba4100\uff0cANALYZE\u5728pg_statistic\u4e2d\u5b58\u50a8\u7684\u4fe1\u606f\u91cf\uff0c\u589e\u5927\u8be5\u503c\uff0c\u4f1a\u589e\u52a0ANALYZE\u7684\u65f6\u95f4\uff0c\u4f46\u4f1a\u8ba9\u89e3\u91ca\u8ba1\u5212\u66f4\u7cbe\u51c6\n\n# wal\nmax_wal_size = 1GB                    # \u5efa\u8bae\u4e0eshared_buffers\u4fdd\u6301\u4e00\u81f4\nmin_wal_size = 80MB                   # \u5efa\u8baemax_wal_size/12.5\nwal_log_hints = on                    # \u63a7\u5236WAL\u65e5\u5fd7\u8bb0\u5f55\u7684\u65b9\u5f0f\uff0c\u5efa\u8bae\u6253\u5f00\nwal_level = replica                   # wal\u65e5\u5fd7\u5199\u5165\u7ea7\u522b\uff0c\u8981\u4f7f\u7528\u6d41\u590d\u5236\uff0c\u5fc5\u987b\u4f7f\u7528replica\u6216\u66f4\u9ad8\u7ea7\u522b\nwal_sender_timeout = 60s              # \u8bbe\u7f6eWAL\u53d1\u9001\u8005\u5728\u53d1\u9001WAL\u6570\u636e\u65f6\u7b49\u5f85\u4e3b\u670d\u52a1\u5668\u54cd\u5e94\u7684\u8d85\u65f6\u65f6\u95f4\nmax_wal_senders = 10                  # \nmax_replication_slots = 10            # \nsynchronous_standby_names = '*'       # \n\n# archive\narchive_mode = on                     # \narchive_command = 'gzip < %p > /var/lib/postgresql/data/pg_archive/%f.gz'\n\n# log \u8fd17\u5929\u8f6e\u8be2\nlog_destination = 'csvlog'            # \u65e5\u5fd7\u683c\u5f0f\nlogging_collector = on                # \u65e5\u5fd7\u6536\u96c6\u5668\nlog_directory = 'pg_log'              # \u65e5\u5fd7\u76ee\u5f55 $PGDATA/pg_log\nlog_filename = 'postgresql.%a'        # 7\u5929\u65e5\u5fd7\u8f6e\u8be2\nlog_file_mode = 0600                  # \u65e5\u5fd7\u6587\u4ef6\u7684\u6743\u9650\nlog_rotation_size = 0                 # \u65e5\u5fd7\u7684\u6700\u5927\u5c3a\u5bf8\uff0c\u8bbe\u7f6e\u4e3a\u96f6\u65f6\u5c06\u7981\u7528\u57fa\u4e8e\u5927\u5c0f\u521b\u5efa\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6\nlog_truncate_on_rotation = on         # \u8fd9\u4e2a\u53c2\u6570\u5c06\u5bfc\u81f4PostgreSQL\u622a\u65ad\uff08\u8986\u76d6\u800c\u4e0d\u662f\u8ffd\u52a0\uff09\u4efb\u4f55\u5df2\u6709\u7684\u540c\u540d\u65e5\u5fd7\u6587\u4ef6\nlog_min_duration_statement = 0        # \u5982\u679c\u8bed\u53e5\u8fd0\u884c\u81f3\u5c11\u6307\u5b9a\u7684\u65f6\u95f4\u91cf\uff0c\u5c06\u5bfc\u81f4\u8bb0\u5f55\u6bcf\u4e00\u4e2a\u8fd9\u79cd\u5b8c\u6210\u7684\u8bed\u53e5\u7684\u6301\u7eed\u65f6\u95f4\nlog_duration = on                     # \u6bcf\u4e00\u4e2a\u5b8c\u6210\u7684\u8bed\u53e5\u7684\u6301\u7eed\u65f6\u95f4\u88ab\u8bb0\u5f55\nlog_lock_waits = on                   # \u63a7\u5236\u5f53\u4e00\u4e2a\u4f1a\u8bdd\u4e3a\u83b7\u5f97\u4e00\u4e2a\u9501\u7b49\u5230\u8d85\u8fc7deadlock_timeout\u65f6\uff0c\u662f\u5426\u8981\u4ea7\u751f\u4e00\u4e2a\u65e5\u5fd7\u6d88\u606f\nlog_statement = 'mod'                 # \u63a7\u5236\u54ea\u4e9b SQL \u8bed\u53e5\u88ab\u8bb0\u5f55\u3002\u6709\u6548\u503c\u662f none (off)\u3001ddl\u3001mod\u548c all\uff08\u6240\u6709\u8bed\u53e5\uff09\u3002ddl\u8bb0\u5f55\u6240\u6709\u6570\u636e\u5b9a\u4e49\u8bed\u53e5\uff0c\u4f8b\u5982CREATE\u3001ALTER\u548c DROP\u8bed\u53e5\u3002mod\u8bb0\u5f55\u6240\u6709ddl\u8bed\u53e5\uff0c\u5916\u52a0\u6570\u636e\u4fee\u6539\u8bed\u53e5\u4f8b\u5982INSERT, UPDATE\u3001DELETE\u3001TRUNCATE, \u548cCOPY FROM\nlog_timezone = 'Asia/Shanghai'        # \u8bbe\u7f6e\u5728\u670d\u52a1\u5668\u65e5\u5fd7\u4e2d\u5199\u5165\u7684\u65f6\u95f4\u6233\u7684\u65f6\u533a\n\n# sql\nstatement_timeout = 300000            # \u8bed\u53e5\u6267\u884c\u8d85\u65f6\u65f6\u95f4 5\u5206\u949f\nidle_in_transaction_session_timeout = 300000   # \u4e8b\u52a1\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4 5\u5206\u949f\nidle_session_timeout = 1800000        # \u4f1a\u8bdd\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4 30\u5206\u949f\nlock_timeout = 60000                  # \u7b49\u9501\u8d85\u65f6\u65f6\u95f4 1\u5206\u949f\n"})}),"\n",(0,a.jsx)(n.h4,{id:"5-\u91cd\u542f\u4e3b\u5e93",children:"5. \u91cd\u542f\u4e3b\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"docker container restart postgres-master\n\npg_ctl restart -D $PGDATA -l $PGLOG\n"})}),"\n",(0,a.jsx)(n.h3,{id:"3-\u4ece\u5e93\u914d\u7f6e-slave-docker\u90e8\u7f72",children:"3. \u4ece\u5e93\u914d\u7f6e (Slave Docker\u90e8\u7f72)"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u6b64\u6b65\u9aa4\u9002\u7528\u4e8eDocker\u90e8\u7f72"]}),"\n",(0,a.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u4ece\u5e93",children:"1. \u521d\u59cb\u5316\u4ece\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u6587\u4ef6\u5939\nmkdir -p //d/docker/pgsql-slave/{conf,data,logs,temp}\n\n# \u8fd0\u884c\u5bb9\u5668 (\u6b64\u65f6\u6302\u8f7d\u7684\u6570\u636e\u76ee\u5f55\u662f temp)\ndocker run -d \\\n  --publish 5434:5432 \\\n  --volume //d/docker/pgsql-slave/temp:/var/lib/postgresql/data \\\n  --env PGDATA=/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=postgres \\\n  --net dev \\\n  --ip 172.18.0.3 \\\n  --restart=no \\\n  --name postgres-slave \\\n  postgres:15.3\n"})}),"\n",(0,a.jsx)(n.h4,{id:"2-\u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93",children:"2. \u9a8c\u8bc1\u4ece\u5e93\u8bbf\u95ee\u4e3b\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"docker exec -it -u root postgres-slave /bin/bash\n\npsql -h 172.18.0.2 -p 5432 -U postgres -W -d postgres\n# \u53ef\u4ee5\u6b63\u5e38\u8f93\u5165\u5bc6\u7801\u767b\u5f55\u5373\u53ef\n"})}),"\n",(0,a.jsx)(n.h4,{id:"3-\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",children:"3. \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6\npg_basebackup -D /var/lib/postgresql/data/replica -h 172.18.0.2 -p 5432 -U replica -Fp -Xs -Pv -R\n\n\n"})}),"\n",(0,a.jsx)(n.h4,{id:"4-\u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93",children:"4. \u4f7f\u7528\u540c\u6b65\u7684\u4e3b\u5e93\u6570\u636e\u6587\u4ef6\u91cd\u5efa\u4ece\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u505c\u6b62\u5e76\u5220\u9664\u955c\u50cf\ndocker stop postgres-slave && docker container remove postgres-slave\n\n# \u5c06 //d/docker/pgsql-slave/temp/replica \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u590d\u5236\u5230 //d/docker/pgsql-slave/data \u4e0b\n\n# \u8fd0\u884c\u5bb9\u5668 (\u6b64\u65f6\u6302\u8f7d\u7684\u6570\u636e\u76ee\u5f55\u662f data)\ndocker run -d \\\n  --publish 5434:5432 \\\n  --volume //d/docker/pgsql-slave/data:/var/lib/postgresql/data \\\n  --env PGDATA=/var/lib/postgresql/data \\\n  --env POSTGRES_PASSWORD=postgres \\\n  --net dev \\\n  --ip 172.18.0.3 \\\n  --restart=no \\\n  --name postgres-slave \\\n  postgres:15.3\n"})}),"\n",(0,a.jsx)(n.h3,{id:"4-\u4ece\u5e93\u914d\u7f6e-standby-\u7269\u7406\u673a\u90e8\u7f72",children:"4. \u4ece\u5e93\u914d\u7f6e (Standby \u7269\u7406\u673a\u90e8\u7f72)"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u6b64\u6b65\u9aa4\u9002\u7528\u4e8e\u7269\u7406\u673a\u90e8\u7f72"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.postgresql.org/download/linux/#generic",children:"PostgreSQL: Linux downloads"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.postgresql.org/ftp/source/",children:"PostgreSQL: File Browser"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.jianshu.com/p/685f946bd490",children:"Ubuntu 22.04.3 \u5b89\u88c5 PostgreSQL 15"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://blog.csdn.net/qq_33445829/article/details/130033182",children:"Centos7.6\u5b89\u88c5postgresql15"})}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"1-\u521d\u59cb\u5316\u4ece\u5e93-1",children:"1. \u521d\u59cb\u5316\u4ece\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u5b89\u88c5\u4f9d\u8d56\nyum -y install tcl tcl-devel uuid-devel perl-ExtUtils-Embed readline-devel zlib-devel pam-devel libxml2-devel libxslt-devel openldap-devel python-devel gcc-c++ openssl-devel cmake gcc* readline-devel\n\n# \u4e0b\u8f7d\u6e90\u7801\u5305 \nwget https://ftp.postgresql.org/pub/source/v15.3/postgresql-15.3.tar.gz -O /usr/local/src/postgresql-15.3.tar.gz\n\n# \u89e3\u538b\u538b\u7f29\u5305\ncd /usr/local/src && tar -zxvf postgresql-15.3.tar.gz\n\n# \u68c0\u6d4b\u7cfb\u7edf\u4f9d\u8d56\ncd postgresql-15.3 && ./configure --prefix=/usr/local/pgsql\n\n# \u7f16\u8bd1\nmake clean; make\n\n# \u5b89\u88c5\nmake install\n\n# \u521b\u5efa\u6570\u636e\u76ee\u5f55\ncd /usr/local/pgsql\nmkdir data\n\n# \u6dfb\u52a0pgsql\u7528\u6237\nadduser postgres\n# passwd postgres\nchown -R postgres:postgres /usr/local/pgsql\nchmod 750 /usr/local/pgsql/data\n\n# \u914d\u7f6e\u73af\u5883\u53d8\u91cf\ncat >> /etc/profile << 'EOF'\n# Pgsql \u73af\u5883\u53d8\u91cf\nPGHOME=/usr/local/pgsql\nPGDATA=$PGHOME/data\nPATH=$PATH:$HOME/.local/bin:$HOME/bin:$PGHOME/bin\nexport PGHOME PGDATA PATH\n\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nsource /etc/profile\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u6ce8\u610f"})," \u4e0d\u9700\u8981\u521d\u59cb\u5316\u548c\u542f\u52a8\u6570\u636e\u5e93"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u521d\u59cb\u5316\u6570\u636e\u5e93\n${PGHOME}/bin/initdb -D ${PGDATA} --encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8 \n\n# \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\nvim ${PGDATA}/postgresql.conf\n\n# \u542f\u52a8\u6570\u636e\u5e93\npg_ctl start -D ${PGDATA}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"2-\u505c\u6b62\u4ece\u5e93\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6",children:"2. \u505c\u6b62\u4ece\u5e93\uff0c\u6e05\u7a7a\u4ece\u5e93\u6570\u636e\u6587\u4ef6\uff0c\u540c\u6b65\u4e3b\u5e93\u6587\u4ef6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u5207\u6362\u5230postgres\u7528\u6237\nsu - postgres\n\n# \u505c\u6b62pgsql (\u5982\u679c\u524d\u9762\u542f\u52a8\u4e86\u6570\u636e\u5e93\u5219\u9700\u8981\u505c\u6b62)\npg_ctl status\npg_ctl stop -D $PGDATA -l $PGLOG\n\n# \u6e05\u7a7a\u6570\u636e\u6587\u4ef6(\u5982\u679c\u524d\u9762\u542f\u52a8\u4e86\u6570\u636e\u5e93\u5219\u9700\u8981\u6e05\u9664\u6570\u636e\u76ee\u5f55)\nrm -rf  /usr/local/pgsql/data/*\n\n# \u540c\u6b65\u4e3b\u5e93\u6587\u4ef6\npg_basebackup -D /usr/local/pgsql/data/ -h 172.18.0.2 -p 5432 -U replica -Fp -Xs -Pv -R -W\n"})}),"\n",(0,a.jsx)(n.h4,{id:"5-\u91cd\u542f\u4ece\u5e93",children:"5. \u91cd\u542f\u4ece\u5e93"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"pg_ctl restart\n"})}),"\n",(0,a.jsx)(n.h3,{id:"5-\u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65",children:"5. \u9a8c\u8bc1\u4e3b\u4ece\u540c\u6b65"}),"\n",(0,a.jsx)(n.h4,{id:"1-\u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f",children:"1. \u68c0\u67e5\u4ece\u5e93\u662f\u5426\u914d\u7f6e\u6210\u529f"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u4e3b\u5e93\nsu - postgres\npsql postgres\nselect pid,client_addr,sync_state from pg_stat_replication;\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u7ed3\u679c\u5982\u4e0b"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"client_addr"}),(0,a.jsx)(n.th,{children:"sync_state"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"172.18.0.3"}),(0,a.jsx)(n.td,{children:"sync"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"172.18.0.1"}),(0,a.jsx)(n.td,{children:"potential"})]})]})]}),"\n",(0,a.jsx)(n.h4,{id:"2-\u67e5\u8be2\u8282\u70b9\u72b6\u6001",children:"2. \u67e5\u8be2\u8282\u70b9\u72b6\u6001"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u4e3b\u5e93\npg_controldata | grep 'Database cluster state'\n# \u8f93\u51fa\u5982\u4e0b\n# Database cluster state:               in production\n\n# \u4ece\u5e93\npg_controldata | grep 'Database cluster state'\n# \u8f93\u51fa\u5982\u4e0b\n# Database cluster state:               in archive recovery\n"})}),"\n",(0,a.jsx)(n.h4,{id:"3-\u6570\u636e\u540c\u6b65\u6d4b\u8bd5",children:"3. \u6570\u636e\u540c\u6b65\u6d4b\u8bd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u4e3b\u5e93\u6267\u884c\npsql -h localhost -p 5432 -U postgres -W -d postgres\nselect client_addr,usename,backend_start,application_name,sync_state,sync_priority FROM pg_stat_replication;\nCREATE DATABASE test;\n\\connect pgtest\nDROP DATABASE test;\n\n# \u4ece\u5e93\u6267\u884c\npsql -h localhost -p 5432 -U postgres -W -d postgres\nSELECT datname FROM pg_database;\n\\connect pgtest\n# \u4e3b\u5e93\u65b0\u5efa\u5220\u9664\u6570\u636e\u5e93\u65f6\uff0c\u4ece\u5e93\u4e5f\u5c06\u6570\u636e\u540c\u6b65\u8fc7\u6765\u4e86\n"})}),"\n",(0,a.jsx)(n.h4,{id:"4-\u79fb\u9664\u8282\u70b9",children:"4. \u79fb\u9664\u8282\u70b9"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# \u5207\u6362\u5230postgres\u7528\u6237\nsu - postgres\n\n# \u505c\u6b62pgsql\npg_ctl status\npg_ctl stop -D $PGDATA -l $PGLOG\n\n# \u6e05\u7a7a\u6570\u636e\u6587\u4ef6\nrm -rf  /usr/local/pgsql/data/*\n\n# \u91cd\u65b0\u521d\u59cb\u5316\u6570\u636e\u5e93\n${PGHOME}/bin/initdb -D ${PGDATA} --encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8 \n\n# \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\nvim ${PGDATA}/postgresql.conf\n\n# \u542f\u52a8\u6570\u636e\u5e93\npg_ctl start -D ${PGDATA}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"6-\u521b\u5efa\u53ea\u8bfb\u8d26\u53f7",children:"6. \u521b\u5efa\u53ea\u8bfb\u8d26\u53f7"}),"\n",(0,a.jsx)(n.p,{children:"\u5728\u4e3b\u5e93\u6267\u884c\u5373\u53ef\uff0c\u8d26\u53f7\u4fe1\u606f\u4f1a\u540c\u6b65\u5230\u5176\u4ed6\u8282\u70b9"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"# 1. \u521b\u5efa\u4e00\u4e2a\u7528\u6237\u540d\u4e3areadonly\u5bc6\u7801\u4e3aropass\u7684\u7528\u6237\nCREATE USER readonly WITH ENCRYPTED PASSWORD 'ropass';\n\n# 2. \u7528\u6237\u53ea\u8bfb\u4e8b\u52a1\nALTER USER readonly SET default_transaction_read_only=on;\n\n# 3. \u628a\u6240\u6709\u5e93\u7684\u8bed\u8a00\u7684USAGE\u6743\u9650\u7ed9\u5230readonly\nGRANT USAGE ON SCHEMA public TO readonly;\n\n# 4. \u6388\u4e88select\u6743\u9650(\u8fd9\u53e5\u8981\u8fdb\u5165\u5177\u4f53\u6570\u636e\u5e93\u64cd\u4f5c\u5728\u54ea\u4e2adb\u73af\u5883\u6267\u884c\u5c31\u6388\u4e88\u90a3\u4e2adb\u7684\u6743)\nGRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>d});var l=s(96540);const a={},r=l.createContext(a);function t(e){const n=l.useContext(r);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);