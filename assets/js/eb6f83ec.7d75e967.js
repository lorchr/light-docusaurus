"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[29661],{75012:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>a});var s=i(74848),r=i(28453);const t={},c=void 0,o={id:"zh-cn/spring-authorization-server/SAS-Optimize-Persistance-JWKSource",title:"SAS-Optimize-Persistance-JWKSource",description:"- Spring Authorization Server\u4f18\u5316\u7bc7\uff1a\u6301\u4e45\u5316JWKSource\uff0c\u89e3\u51b3\u91cd\u542f\u540e\u65e0\u6cd5\u89e3\u6790AccessToken\u95ee\u9898",source:"@site/docs/zh-cn/spring-authorization-server/102-SAS-Optimize-Persistance-JWKSource.md",sourceDirName:"zh-cn/spring-authorization-server",slug:"/zh-cn/spring-authorization-server/SAS-Optimize-Persistance-JWKSource",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Persistance-JWKSource",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-authorization-server/102-SAS-Optimize-Persistance-JWKSource.md",tags:[],version:"current",sidebarPosition:102,frontMatter:{},sidebar:"troch",previous:{title:"SAS-Optimize-Add-Redis-Cache",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Add-Redis-Cache"},next:{title:"SAS-Optimize-Redis-Serializer-Add-Jackson-Mixin",permalink:"/light-docusaurus/docs/zh-cn/spring-authorization-server/SAS-Optimize-Redis-Serializer-Add-Jackson-Mixin"}},d={},a=[{value:"\u4e00\u3001\u95ee\u9898\u63cf\u8ff0",id:"\u4e00\u95ee\u9898\u63cf\u8ff0",level:2},{value:"\u4e8c\u3001\u89e3\u51b3\u65b9\u6848\u5206\u6790",id:"\u4e8c\u89e3\u51b3\u65b9\u6848\u5206\u6790",level:2},{value:"1. <code>JWKSet</code>\u4e2d\u7684<code>toString</code>\u65b9\u6cd5",id:"1-jwkset\u4e2d\u7684tostring\u65b9\u6cd5",level:3},{value:"2. <code>JWKSet</code>\u4e2d\u7684<code>parse</code>\u65b9\u6cd5",id:"2-jwkset\u4e2d\u7684parse\u65b9\u6cd5",level:3},{value:"\u4e09\u3001\u7f16\u7801\u89e3\u51b3\u95ee\u9898",id:"\u4e09\u7f16\u7801\u89e3\u51b3\u95ee\u9898",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://juejin.cn/post/7254836247290216503",children:"Spring Authorization Server\u4f18\u5316\u7bc7\uff1a\u6301\u4e45\u5316JWKSource\uff0c\u89e3\u51b3\u91cd\u542f\u540e\u65e0\u6cd5\u89e3\u6790AccessToken\u95ee\u9898"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u4e00\u95ee\u9898\u63cf\u8ff0",children:"\u4e00\u3001\u95ee\u9898\u63cf\u8ff0"}),"\n",(0,s.jsx)(n.p,{children:"\u81ea\u4ece\u7b2c\u4e8c\u7ae0\u5c06\u8ba4\u8bc1\u670d\u52a1\u642d\u5efa\u8d77\u6765\u4ee5\u540e\u5c31\u5f88\u5c11\u66f4\u6539\u57fa\u7840\u914d\u7f6e\u4e86\uff0c\u76f4\u5230\u4eca\u5929\u6709\u4f4d\u8bfb\u8005\u63d0\u4e86\u4e00\u4e2a\u95ee\u9898\uff0c\u5bf9\u6211\u53d1\u51fa\u4e86\u7075\u9b42\u62f7\u95ee\uff1a**\u91cd\u542f\u540ejwks\u7684\u914d\u7f6e\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u65e0\u6cd5\u6b63\u786e\u89e3\u6790token\uff0c\u90a3Auth\u670d\u52a1\u91cd\u542f\u540e\u6709\u529e\u6cd5\u89c4\u907f\u8fd9\u79cd\u60c5\u51b5\u5417\uff1f**\u5047\u5982\u751f\u4ea7\u73af\u5883\u8fd9\u6837\uff0c\u670d\u52a1\u91cd\u65b0\u90e8\u7f72\u540e\u4e4b\u524d\u6240\u6709\u767b\u5f55\u7684\u7528\u6237\u5fc5\u987b\u91cd\u65b0\u767b\u9646\u3002\u539f\u95ee\u9898\u89c1\u4e0b\u65b9\u9644\u56fe"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img",src:i(97437).A+"",width:"980",height:"380"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4e8c\u89e3\u51b3\u65b9\u6848\u5206\u6790",children:"\u4e8c\u3001\u89e3\u51b3\u65b9\u6848\u5206\u6790"}),"\n",(0,s.jsxs)(n.p,{children:["\u5f53\u65f6\u672c\u4eba\u60f3\u5230\u7684\u662f\u5c06\u751f\u6210\u7684",(0,s.jsx)(n.code,{children:"JWKSource"}),"\u4fdd\u5b58\u81f3redis\uff0c\u6bcf\u6b21\u91cd\u542f\u4eceredis\u4e2d\u83b7\u53d6\uff0c\u8fd9\u6837\u4e0d\u7ba1\u91cd\u4e0d\u91cd\u542f\u751f\u6210\u7684\u90fd\u662f\u540c\u4e00\u4e2a\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u51fa\u73b0\u670d\u52a1\u91cd\u542f\u540e\u65e0\u6cd5\u89e3\u6790\u5728\u6709\u6548\u671f\u5185\u7684",(0,s.jsx)(n.code,{children:"AccessToken"}),"\u95ee\u9898\u4e86\uff0c\u4f46\u662f\u53c8\u6015\u4e0d\u80fd\u5e8f\u5217\u5316\uff0c\u5c31\u53bb\u67e5\u770b\u4ee3\u7801\u4e86\uff0c\u6700\u7ec8\u529f\u592b\u4e0d\u8d1f\u6709\u5fc3\u4eba\uff0c\u7ecf\u8fc7\u4e00\u756a\u67e5\u627e\u540e\u53d1\u73b0\u6700\u4e3b\u8981\u7684\u914d\u7f6e\u662f\u6765\u81ea",(0,s.jsx)(n.code,{children:"JWKSet"}),"\u7684\u5b9e\u4f8b\uff0c\u5728",(0,s.jsx)(n.code,{children:"JWKSet"}),"\u627e\u5230\u4e86",(0,s.jsx)(n.code,{children:"toString"}),"\u65b9\u6cd5\u548c\u5bf9\u5e94\u7684",(0,s.jsx)(n.code,{children:"parse"}),"\u65b9\u6cd5\uff0c",(0,s.jsx)(n.code,{children:"toString"}),"\u65b9\u6cd5\u662f\u5c06",(0,s.jsx)(n.code,{children:"jwks"}),"\u7684\u4fe1\u606f\u8f6c\u4e3ajson\u5b57\u7b26\u4e32\uff0c\u800cparse\u5c31\u662f\u8bfb\u53d6\u5e76\u89e3\u6790json\u5b57\u7b26\u4e32\uff0c\u5c06\u5176\u8f6c\u4e3a",(0,s.jsx)(n.code,{children:"JWKSet"}),"\u5b9e\u4f8b"]}),"\n",(0,s.jsxs)(n.h3,{id:"1-jwkset\u4e2d\u7684tostring\u65b9\u6cd5",children:["1. ",(0,s.jsx)(n.code,{children:"JWKSet"}),"\u4e2d\u7684",(0,s.jsx)(n.code,{children:"toString"}),"\u65b9\u6cd5"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img",src:i(3184).A+"",width:"1396",height:"938"})}),"\n",(0,s.jsxs)(n.p,{children:["\u65b9\u6cd5\u5185\u90e8\u5c06",(0,s.jsx)(n.code,{children:"jwks"}),"\u8f6c\u4e3a\u4e00\u4e2ajson\u5b57\u7b26\u4e32\u8fd4\u56de"]}),"\n",(0,s.jsxs)(n.h3,{id:"2-jwkset\u4e2d\u7684parse\u65b9\u6cd5",children:["2. ",(0,s.jsx)(n.code,{children:"JWKSet"}),"\u4e2d\u7684",(0,s.jsx)(n.code,{children:"parse"}),"\u65b9\u6cd5"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img",src:i(25395).A+"",width:"1010",height:"809"})}),"\n",(0,s.jsxs)(n.p,{children:["\u65b9\u6cd5\u5185\u90e8\u6839\u636e\u7ed9\u5b9a\u7684\u5b57\u7b26\u4e32\u89e3\u6790\u5e76\u8fd4\u56de\u4e00\u4e2a",(0,s.jsx)(n.code,{children:"JWKSet"}),"\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"\u4e09\u7f16\u7801\u89e3\u51b3\u95ee\u9898",children:"\u4e09\u3001\u7f16\u7801\u89e3\u51b3\u95ee\u9898"}),"\n",(0,s.jsxs)(n.p,{children:["\u6839\u636e\u4e0a\u8fb9\u7684\u5206\u6790\u5f97\u51fa\u89e3\u51b3\u65b9\u6848\uff0c\u5728\u914d\u7f6e",(0,s.jsx)(n.code,{children:"JWKSource"}),"\u4e4b\u524d\u5148\u4eceredis\u4e2d\u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e0b\uff0c\u83b7\u53d6\u4e0d\u5230\u5c31\u751f\u6210\u5e76\u5b58\u5165redis\uff1b\u83b7\u53d6\u5230\u76f4\u63a5\u89e3\u6790\u5e76\u751f\u6210\u4e00\u4e2a",(0,s.jsx)(n.code,{children:"JWKSet"}),"\uff1b\u4fee\u6539",(0,s.jsx)(n.code,{children:"AuthorizationConfig"}),"\u7c7b\u4e2d\u7684",(0,s.jsx)(n.code,{children:"JWKSource"}),"\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"/**\n * \u914d\u7f6ejwk\u6e90\uff0c\u4f7f\u7528\u975e\u5bf9\u79f0\u52a0\u5bc6\uff0c\u516c\u5f00\u7528\u4e8e\u68c0\u7d22\u5339\u914d\u6307\u5b9a\u9009\u62e9\u5668\u7684JWK\u7684\u65b9\u6cd5\n *\n * @return JWKSource\n */\n@Bean\n@SneakyThrows\npublic JWKSource<SecurityContext> jwkSource() {\n    // \u5148\u4eceredis\u83b7\u53d6\n    String jwkSetCache = redisOperator.get(RedisConstants.AUTHORIZATION_JWS_PREFIX_KEY);\n    if (ObjectUtils.isEmpty(jwkSetCache)) {\n        KeyPair keyPair = generateRsaKey();\n        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();\n        RSAPrivateKey privateKey = (RSAPrivateKey) keyPair.getPrivate();\n        RSAKey rsaKey = new RSAKey.Builder(publicKey)\n                .privateKey(privateKey)\n                .keyID(UUID.randomUUID().toString())\n                .build();\n        // \u751f\u6210jws\n        JWKSet jwkSet = new JWKSet(rsaKey);\n        // \u8f6c\u4e3ajson\u5b57\u7b26\u4e32\n        String jwkSetString = jwkSet.toString(Boolean.FALSE);\n        // \u5b58\u5165redis\n        redisOperator.set(RedisConstants.AUTHORIZATION_JWS_PREFIX_KEY, jwkSetString);\n        return new ImmutableJWKSet<>(jwkSet);\n    }\n    // \u89e3\u6790\u5b58\u50a8\u7684jws\n    JWKSet jwkSet = JWKSet.parse(jwkSetCache);\n    return new ImmutableJWKSet<>(jwkSet);\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u9644\u4e00\u4e0b",(0,s.jsx)(n.code,{children:"RedisConstants"}),"\u7c7b\u4e2d\u7684",(0,s.jsx)(n.code,{children:"AUTHORIZATION_JWS_PREFIX_KEY"}),"\u5e38\u91cf"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'/**\n * jwk set\u7f13\u5b58\u524d\u7f00\n */\npublic static final String AUTHORIZATION_JWS_PREFIX_KEY = "authorization_jws";\n'})}),"\n",(0,s.jsxs)(n.p,{children:["\u4fee\u6539\u914d\u7f6e\u540e\u542f\u52a8\u8ba4\u8bc1\u670d\u52a1\uff0c\u4f7f\u7528oauth2\u7684\u51e0\u79cd\u65b9\u5f0f\u83b7\u53d6\u4e00\u4e0btoken\uff0c\u7136\u540e\u91cd\u542f\u670d\u52a1\u643a\u5e26token\u8bf7\u6c42\u4e00\u4e0b\u770b\u770b\u8ba4\u8bc1\u670d\u52a1\u80fd\u5426\u89e3\u6790",(0,s.jsx)(n.code,{children:"AccessToken"}),"\uff0c\u5982\u679c\u6709\u4ec0\u4e48\u95ee\u9898\u53ef\u4ee5\u5728\u8bc4\u8bba\u533a\u4e2d\u63d0\u51fa\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee3\u7801\u5df2\u63d0\u4ea4\u81f3",(0,s.jsx)(n.a,{href:"https://gitee.com/vains-Sofia/authorization-example",children:"Gitee"})]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},97437:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/102-1-589a22e39ebbb197ac7b1c784565a9df.webp"},3184:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/102-2-08e2b491211295ddda121cf01765f296.webp"},25395:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/102-3-6129380d7e165b4836495703d5a29deb.webp"},28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>o});var s=i(96540);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);