"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[1116],{50131:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var r=s(85893),t=s(11151);const i={},l=void 0,a={id:"zh-cn/k8s/Build-K8s-Offline-With-RKE2",title:"Build-K8s-Offline-With-RKE2",description:"- RKE2\u79bb\u7ebf\u5b89\u88c5",source:"@site/docs/zh-cn/k8s/3-Build-K8s-Offline-With-RKE2.md",sourceDirName:"zh-cn/k8s",slug:"/zh-cn/k8s/Build-K8s-Offline-With-RKE2",permalink:"/light-docusaurus/docs/zh-cn/k8s/Build-K8s-Offline-With-RKE2",draft:!1,unlisted:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/k8s/3-Build-K8s-Offline-With-RKE2.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"troch",previous:{title:"Build-K8s-Cluster-With-Rancher",permalink:"/light-docusaurus/docs/zh-cn/k8s/Build-K8s-Cluster-With-Rancher"},next:{title:"K8s-Commands",permalink:"/light-docusaurus/docs/zh-cn/k8s/K8s-Commands"}},o={},d=[{value:"\u4e00\u3001\u57fa\u4e8eRKE2\u7684K8s\u90e8\u7f72",id:"\u4e00\u57fa\u4e8erke2\u7684k8s\u90e8\u7f72",level:2},{value:"1\u3001\u7981\u7528 SELinux\u3001Firewalld \u3001Swap",id:"1\u7981\u7528-selinuxfirewalld-swap",level:3},{value:"2\u3001\u8bbe\u7f6e\u65f6\u95f4\u540c\u6b65",id:"2\u8bbe\u7f6e\u65f6\u95f4\u540c\u6b65",level:3},{value:"3\u3001\u4e0b\u8f7d\u5b89\u88c5\u5305\u4ee5\u53ca\u955c\u50cf\u6587\u4ef6",id:"3\u4e0b\u8f7d\u5b89\u88c5\u5305\u4ee5\u53ca\u955c\u50cf\u6587\u4ef6",level:3},{value:"4\u3001\u90e8\u7f72 server \u8282\u70b9(master)",id:"4\u90e8\u7f72-server-\u8282\u70b9master",level:3},{value:"5\u3001\u90e8\u7f72 agent \u8282\u70b9(worker)",id:"5\u90e8\u7f72-agent-\u8282\u70b9worker",level:3},{value:"6\u3001\u5220\u9664\u8282\u70b9",id:"6\u5220\u9664\u8282\u70b9",level:3},{value:"7\u3001\u96c6\u7fa4\u91cd\u7f6e",id:"7\u96c6\u7fa4\u91cd\u7f6e",level:3},{value:"\u4e8c\u3001\u5b89\u88c5Pgsql 15.4",id:"\u4e8c\u5b89\u88c5pgsql-154",level:2},{value:"1\u3001\u672c\u5730\u7f16\u8bd1\u6e90\u7801",id:"1\u672c\u5730\u7f16\u8bd1\u6e90\u7801",level:3},{value:"2\u3001\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305",id:"2\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305",level:3},{value:"3\u3001\u521d\u59cb\u5316\u6570\u636e\u5e93",id:"3\u521d\u59cb\u5316\u6570\u636e\u5e93",level:3},{value:"4\u3001\u8fdc\u7a0b\u8fde\u63a5",id:"4\u8fdc\u7a0b\u8fde\u63a5",level:3},{value:"5\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",id:"5\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",level:3},{value:"\u4e09\u3001\u5b89\u88c5Influxdb 1.8.4",id:"\u4e09\u5b89\u88c5influxdb-184",level:2},{value:"1\u3001\u4e0b\u8f7d rpm \u5b89\u88c5\u5305",id:"1\u4e0b\u8f7d-rpm-\u5b89\u88c5\u5305",level:3},{value:"2\u3001\u5b89\u88c5",id:"2\u5b89\u88c5",level:3},{value:"3\u3001\u521b\u5efa\u65b0\u7528\u6237",id:"3\u521b\u5efa\u65b0\u7528\u6237",level:3},{value:"4\u3001\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u542f\u52a8\u6743\u9650\u9a8c\u8bc1",id:"4\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u542f\u52a8\u6743\u9650\u9a8c\u8bc1",level:3},{value:"\u56db\u3001\u5b89\u88c5Minio RELEASE.2023-09-16T01-01-47Z",id:"\u56db\u5b89\u88c5minio-release2023-09-16t01-01-47z",level:2},{value:"1\u3001\u4e0b\u8f7d rpm \u5b89\u88c5\u5305",id:"1\u4e0b\u8f7d-rpm-\u5b89\u88c5\u5305-1",level:3},{value:"2\u3001\u7f16\u5199\u914d\u7f6e\u6587\u4ef6\u3001\u542f\u52a8\u811a\u672c",id:"2\u7f16\u5199\u914d\u7f6e\u6587\u4ef6\u542f\u52a8\u811a\u672c",level:3},{value:"3\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",id:"3\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",level:3},{value:"\u4e94\u3001\u5b89\u88c5Nginx 1.22.1",id:"\u4e94\u5b89\u88c5nginx-1221",level:2},{value:"1\u3001\u672c\u5730\u7f16\u8bd1\u6e90\u7801",id:"1\u672c\u5730\u7f16\u8bd1\u6e90\u7801-1",level:3},{value:"2\u3001\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305",id:"2\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305-1",level:3},{value:"3\u3001\u542f\u52a8nginx",id:"3\u542f\u52a8nginx",level:3},{value:"4\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",id:"4\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",level:3},{value:"\u516d\u3001\u5b89\u88c5EMQX 5.2.0",id:"\u516d\u5b89\u88c5emqx-520",level:2},{value:"1\u3001\u4e0b\u8f7d\u5b89\u88c5\u5305",id:"1\u4e0b\u8f7d\u5b89\u88c5\u5305",level:3},{value:"2\u3001\u8fd0\u884c",id:"2\u8fd0\u884c",level:3},{value:"3\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",id:"3\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f-1",level:3},{value:"\u4e03\u3001\u5b89\u88c5Redis Cluster 7.0.12",id:"\u4e03\u5b89\u88c5redis-cluster-7012",level:2},{value:"1\u3001\u672c\u5730\u7f16\u8bd1\u6e90\u7801",id:"1\u672c\u5730\u7f16\u8bd1\u6e90\u7801-2",level:3},{value:"2\u3001\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305",id:"2\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305-2",level:3},{value:"3\u3001\u4fee\u6539\u914d\u7f6e\u6587\u4ef6",id:"3\u4fee\u6539\u914d\u7f6e\u6587\u4ef6",level:3},{value:"4\u3001\u914d\u7f6e/etc/sysctl.conf",id:"4\u914d\u7f6eetcsysctlconf",level:3},{value:"5\u3001\u542f\u52a8\u5404Redis \u8282\u70b9",id:"5\u542f\u52a8\u5404redis-\u8282\u70b9",level:3},{value:"7\u3001\u5355\u8282\u70b9\u5b89\u88c5",id:"7\u5355\u8282\u70b9\u5b89\u88c5",level:3},{value:"\u516b\u3001\u670d\u52a1\u90e8\u7f72",id:"\u516b\u670d\u52a1\u90e8\u7f72",level:2},{value:"1\u3001\u524d\u7aef\u914d\u7f6e\u6587\u4ef6",id:"1\u524d\u7aef\u914d\u7f6e\u6587\u4ef6",level:3},{value:"2\u3001\u524d\u7aef\u90e8\u7f72",id:"2\u524d\u7aef\u90e8\u7f72",level:3},{value:"3\u3001\u540e\u7aef\u914d\u7f6e\u6587\u4ef6",id:"3\u540e\u7aef\u914d\u7f6e\u6587\u4ef6",level:3},{value:"4\u3001\u540e\u7aef\u670d\u52a1\u90e8\u7f72",id:"4\u540e\u7aef\u670d\u52a1\u90e8\u7f72",level:3},{value:"\u4e5d\u3001\u5b89\u88c5\u95ee\u9898",id:"\u4e5d\u5b89\u88c5\u95ee\u9898",level:2},{value:"1\u3001k8s\u62c9\u53d6\u955c\u50cf\u62a5\u9519",id:"1k8s\u62c9\u53d6\u955c\u50cf\u62a5\u9519",level:3}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.ah)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.rke2.io/zh/install/airgap",children:"RKE2\u79bb\u7ebf\u5b89\u88c5"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u4e00\u57fa\u4e8erke2\u7684k8s\u90e8\u7f72",children:"\u4e00\u3001\u57fa\u4e8eRKE2\u7684K8s\u90e8\u7f72"}),"\n",(0,r.jsx)(n.h3,{id:"1\u7981\u7528-selinuxfirewalld-swap",children:"1\u3001\u7981\u7528 SELinux\u3001Firewalld \u3001Swap"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u7981\u7528 SELinux\nsed -i 's/enforcing/disabled/' /etc/selinux/config && setenforce 0\n\n# \u5173\u95ed firewalld\nsystemctl stop firewalld && systemctl disable firewalld\n\n# \u7981\u7528swap\u5206\u533a\nswapoff -a && sed -ri 's/.*swap.*/#&/' /etc/fstab\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u8bbe\u7f6e\u65f6\u95f4\u540c\u6b65",children:"2\u3001\u8bbe\u7f6e\u65f6\u95f4\u540c\u6b65"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'# \u8bbe\u7f6e\u7cfb\u7edf\u65f6\u533a\u4e3a \u4e2d\u56fd/\u4e0a\u6d77 \ntimedatectl set-timezone "Asia/Shanghai"\n\n# \u5c06\u5f53\u524d\u7684 UTC \u65f6\u95f4\u5199\u5165\u786c\u4ef6\u65f6\u949f\ntimedatectl set-local-rtc 0\n\n# \u91cd\u542f\u4f9d\u8d56\u4e8e\u7cfb\u7edf\u65f6\u95f4\u7684\u670d\u52a1\nsystemctl restart rsyslog\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3\u4e0b\u8f7d\u5b89\u88c5\u5305\u4ee5\u53ca\u955c\u50cf\u6587\u4ef6",children:"3\u3001\u4e0b\u8f7d\u5b89\u88c5\u5305\u4ee5\u53ca\u955c\u50cf\u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u955c\u50cf\u4e0b\u8f7d\nwget https://github.com/rancher/rke2/releases/download/v1.24.7%2Brke2r1/rke2-images.linux-amd64.tar.gz\n\n# \u5b89\u88c5\u5305\u4e0b\u8f7d\nwget https://github.com/rancher/rke2/releases/download/v1.24.7%2Brke2r1/rke2.linux-amd64.tar.gz\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u4e0a\u8ff0\u6240\u6709\u670d\u52a1\u5668\u5747\u9700\u6267\u884c\uff01"}),"\n",(0,r.jsx)(n.h3,{id:"4\u90e8\u7f72-server-\u8282\u70b9master",children:"4\u3001\u90e8\u7f72 server \u8282\u70b9(master)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u8bbe\u7f6e\u670d\u52a1\u5668\u540d\u79f0\nhostnamectl set-hostname k8s-master\n\n# \u89e3\u538b\u5b89\u88c5\u5305\u6587\u4ef6\ntar -xzvf rke2.linux-amd64.tar.gz\n\n# \u590d\u5236\u53ef\u6267\u884c\u6587\u4ef6\u5230 /usr/local/bin/\ncp bin/* /usr/local/bin/\n\n# \u590d\u5236\u542f\u52a8\u9879\u6587\u4ef6\u5230 /usr/lib/systemd/system/\n# \u6ce8\u610f\uff1a\u542f\u52a8\u9879\u6709 server \u548c agent \uff0c\u8fd9\u91cc\u662f\u590d\u5236 server \u7684\ncp lib/systemd/system/rke2-server.service /usr/lib/systemd/system/\n\n# \u590d\u5236\u955c\u50cf\u6587\u4ef6\u5230 rke2 \u6307\u5b9a\u7684\u9ed8\u8ba4\u4f4d\u7f6e\n# \u521b\u5efa\u76ee\u5f55\nmkdir -p /var/lib/rancher/rke2/agent/images/\n# \u590d\u5236\u955c\u50cf\u6587\u4ef6\u5230\u8be5\u76ee\u5f55\ncp rke2-images.linux-amd64.tar.gz /var/lib/rancher/rke2/agent/images/\n\n# \u8bbe\u7f6e\u5f00\u673a\u542f\u52a8\u5e76\u542f\u52a8\nsystemctl enable rke2-server && systemctl start rke2-server\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u4ee5\u4e0b\u64cd\u4f5c\u5728 ",(0,r.jsx)(n.code,{children:"rke2-server"})," \u542f\u52a8\u518d\u64cd\u4f5c"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u590d\u5236 kubectl \u5230 /usr/lobal/bin\ncp /var/lib/rancher/rke2/bin/kubectl /usr/local/bin/\ncp /var/lib/rancher/rke2/bin/crictl /usr/local/bin/\ncp /var/lib/rancher/rke2/bin/ctr /usr/local/bin/\n\n# \u8bbe\u7f6e kubeconfig\ncat >> ~/.bashrc <<EOF\nexport KUBECONFIG=/etc/rancher/rke2/rke2.yaml\nalias crictl='crictl --runtime-endpoint unix:///run/k3s/containerd/containerd.sock'\nalias ctr='ctr --address /run/k3s/containerd/containerd.sock'\nEOF\n\nsource ~/.bashrc\n\n# \u7b49\u542f\u52a8\u540e\u67e5\u770b node \u4ee5\u53ca pod\n# nodes\nkubectl get nodes\n# pods\nkubectl get pods -A\n"})}),"\n",(0,r.jsx)(n.h3,{id:"5\u90e8\u7f72-agent-\u8282\u70b9worker",children:"5\u3001\u90e8\u7f72 agent \u8282\u70b9(worker)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"agent"})," \u8282\u70b9\u7684\u5b89\u88c5\u540c\u6837\u8981\u4e0b\u8f7d\u5b89\u88c5\u5305\u4ee5\u53ca\u955c\u50cf\u6587\u4ef6\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u8bbe\u7f6e\u670d\u52a1\u5668\u540d\u79f0\nhostnamectl set-hostname k8s-node-1\n\n# \u52a0\u5165\u8282\u70b9\u9700\u8981\u8ba4\u8bc1,\u8ba4\u8bc1\u6587\u4ef6\u5728 server \u8282\u70b9\u4e0a\ncat /var/lib/rancher/rke2/server/token\n# \u83b7\u53d6token\u793a\u4f8b\u5982\u4e0b\uff1a\n# K10c5203928ea0e95fcddd9f64d07a4eda1536718ac3ebb35503900dd096523df46::server:880d72c3a7c8a55728aac3fc28de59f1\n\n# \u521b\u5efa\u76ee\u5f55\nmkdir -p /etc/rancher/rke2\n\n# \u521b\u5efa\u914d\u7f6e\u6587\u4ef6\n# \u6ce8\u610f\uff1aserver \u4e3a\u9996\u4e2a\u8282\u70b9\u7684\u5730\u5740\uff1btoken \u5c31\u662f server \u8282\u70b9\u4e0a\u751f\u6210\u7684 \ncat > /etc/rancher/rke2/config.yaml <<EOF\nserver: https://192.168.0.22:9345\ntoken:\tK10c5203928ea0e95fcddd9f64d07a4eda1536718ac3ebb35503900dd096523df46::server:880d72c3a7c8a55728aac3fc28de59f1\nEOF\n\n# \u89e3\u538b\u5b89\u88c5\u5305\u6587\u4ef6\ntar -xzvf rke2.linux-amd64.tar.gz\n\n# \u590d\u5236\u53ef\u6267\u884c\u6587\u4ef6\u5230 /usr/local/bin/\ncp bin/* /usr/local/bin/\n\n# \u590d\u5236\u542f\u52a8\u9879\u6587\u4ef6\u5230 /usr/lib/systemd/system/\n# \u6ce8\u610f\uff1a\u542f\u52a8\u9879\u6709 server \u548c agent \uff0c\u8fd9\u91cc\u662f\u590d\u5236 agent \u7684\ncp lib/systemd/system/rke2-agent.service /usr/lib/systemd/system/\n\n# \u590d\u5236\u955c\u50cf\u6587\u4ef6\u5230 rke2 \u6307\u5b9a\u7684\u9ed8\u8ba4\u4f4d\u7f6e\n# \u521b\u5efa\u76ee\u5f55\nmkdir -p /var/lib/rancher/rke2/agent/images/\n# \u590d\u5236\u955c\u50cf\u6587\u4ef6\u5230\u8be5\u76ee\u5f55\ncp rke2-images.linux-amd64.tar.gz /var/lib/rancher/rke2/agent/images/\n\n# \u8bbe\u7f6e\u5f00\u673a\u542f\u52a8\u5e76\u542f\u52a8\nsystemctl enable rke2-agent && systemctl start rke2-agent\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u542f\u52a8\u540e\u5230 ",(0,r.jsx)(n.code,{children:"server"})," \u8282\u70b9\u5c31\u53ef\u4ee5\u770b\u5230\u52a0\u5165\u7684\u8282\u70b9\u4e86"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u542f\u52a8\u6210\u529f\u540e\u8bbe\u7f6e"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u8bbe\u7f6e\u547d\u4ee4\u94fe\u63a5\ncp /var/lib/rancher/rke2/bin/crictl /usr/local/bin/ \ncp /var/lib/rancher/rke2/bin/ctr /usr/local/bin/\n\ncat >> ~/.bashrc <<EOF\nalias crictl='crictl --runtime-endpoint unix:///run/k3s/containerd/containerd.sock'\nalias ctr='ctr --address /run/k3s/containerd/containerd.sock'\nEOF\n\nsource ~/.bashrc\n"})}),"\n",(0,r.jsx)(n.h3,{id:"6\u5220\u9664\u8282\u70b9",children:"6\u3001\u5220\u9664\u8282\u70b9"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u5148\u67e5\u770b\u4e00\u4e0b\u8fd9\u4e2anode\u8282\u70b9\u4e0a\u7684nodes\u4fe1\u606f\nkubectl get nodes\n\n# \u9a71\u9010\u6b64node\u8282\u70b9\u4e0a\u7684pod\nkubectl drain k8s-node-1 --delete-local-data --force --ignore-daemonsets\n\n# \u5220\u9664\u8fd9\u4e2anode\u8282\u70b9\nkubectl delete nodes k8s-node-1\n\n# \u5378\u8f7drke2\n/usr/local/bin/rke2-uninstall.sh\n"})}),"\n",(0,r.jsx)(n.h3,{id:"7\u96c6\u7fa4\u91cd\u7f6e",children:"7\u3001\u96c6\u7fa4\u91cd\u7f6e"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.rke2.io/zh/backup_restore",children:"\u96c6\u7fa4\u91cd\u7f6e"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["RKE2 \u542f\u7528\u4e86\u4e00\u9879\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f20\u9012 ",(0,r.jsx)(n.code,{children:"--cluster-reset"})," \u6807\u5fd7\u5c06\u96c6\u7fa4\u91cd\u7f6e\u4e3a\u4e00\u4e2a\u6210\u5458\u96c6\u7fa4\u3002\u5c06\u6b64\u6807\u5fd7\u4f20\u9012\u7ed9 RKE2 server \u65f6\uff0c\u5b83\u5c06\u4f7f\u7528\u76f8\u540c\u7684\u6570\u636e\u76ee\u5f55\u91cd\u7f6e\u96c6\u7fa4\uff0c\u6570\u636e etcd \u7684\u76ee\u5f55\u5b58\u5728\u4e8e ",(0,r.jsx)(n.code,{children:"/var/lib/rancher/rke2/server/db/etcd"})," \u4e2d\uff0c\u8fd9\u4e2a\u6807\u5fd7\u53ef\u4ee5\u5728\u96c6\u7fa4\u4e22\u5931\u4ef2\u88c1\u65f6\u4f20\u9012\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u8981\u4f20\u9012\u91cd\u7f6e\u6807\u5fd7\uff0c\u9996\u5148\u4f60\u9700\u8981\u505c\u6b62 RKE2 \u670d\u52a1\uff08\u5982\u679c RKE2 \u662f\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"systemd"})," \u542f\u7528\u7684\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"systemctl stop rke2-server\nrke2 server --cluster-reset\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u7ed3\u679c\uff1a"})," \u65e5\u5fd7\u4e2d\u7684\u4e00\u6761\u6d88\u606f\u8868\u793a RKE2 \u53ef\u4ee5\u5728\u6ca1\u6709\u6807\u5fd7\u7684\u60c5\u51b5\u4e0b\u91cd\u65b0\u542f\u52a8\u3002\u518d\u6b21\u542f\u52a8 RKE2\uff0c\u5b83\u5e94\u8be5\u5c06 RKE2 \u4f5c\u4e3a\u4e00\u4e2a\u6210\u5458\u96c6\u7fa4\u542f\u52a8\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"INFO[0088] Managed etcd cluster membership has been reset, restart without --cluster-reset flag now. Backup and delete ${datadir}/server/db on each peer etcd server and rejoin the nodes \n\n# \u3010master\u8282\u70b9\u3011\u91cd\u542fRKE2\nsystemctl restart rke2-server\n\n# \u3010worker\u8282\u70b9\u3011\u4fee\u6539server\u5730\u5740\nvim /etc/rancher/rke2/config.yaml\n# \u3010worker\u8282\u70b9\u3011\u91cd\u542fRKE2\nsystemctl restart rke2-agent\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e8c\u5b89\u88c5pgsql-154",children:"\u4e8c\u3001\u5b89\u88c5Pgsql 15.4"}),"\n",(0,r.jsx)(n.h3,{id:"1\u672c\u5730\u7f16\u8bd1\u6e90\u7801",children:"1\u3001\u672c\u5730\u7f16\u8bd1\u6e90\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u5b89\u88c5\u4f9d\u8d56\u9879\nyum install -y gcc make readline-devel zlib-devel\n# apt install -y gcc make libreadline-dev zlib1g zlib1g.dev\n\n# \u521b\u5efa\u76ee\u5f55\nmkdir -p /home/light/pgsql/build\n\n# \u4e0b\u8f7d\u6e90\u7801\u5305\nwget https://ftp.postgresql.org/pub/source/v15.4/postgresql-15.4.tar.gz\n\n# \u89e3\u538b\ntar -zxvf postgresql-15.4.tar.gz -C /home/light/pgsql\n\n# \u7f16\u8bd1\n/home/light/pgsql/postgresql-15.4/configure --prefix /home/light/pgsql/build\nmake\n\n# \u5b89\u88c5\nmake install\n\n# \u6253\u5305\ncd /home/light/pgsql/build\ntar -zcvf pgsql-15.4.tar.gz ./bin ./include ./lib ./share\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305",children:"2\u3001\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u89e3\u538bpgsql-15.4.tar.gz\u5230/data/local\ntar -xzvf pgsql-15.4.tar.gz -C /data/local\n\n# \u521b\u5efaPG\u7528\u6237\nuseradd postgres\n\n# \u521d\u59cb\u5316\u76ee\u5f55\nmkdir -p /data/local/postgresql/data\nmkdir -p /data/local/postgresql/log\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\u521d\u59cb\u5316\u6570\u636e\u5e93",children:"3\u3001\u521d\u59cb\u5316\u6570\u636e\u5e93"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u7ed9postgres\u76ee\u5f55\u6743\u9650\nchown -R postgres:postgres /data/local/postgresql/\n\n# \u5207\u6362postgres\u7528\u6237\nsu postgres\n\n# \u521d\u59cb\u5316\u6570\u636e\u5e93\n/data/local/postgresql/bin/initdb -D /data/local/postgresql/data/ -E UTF8 --locale=en_US.UTF-8\n\n# \u81ea\u5b9a\u4e49\u53ef\u8bbf\u95eeIP\u53ca\u7aef\u53e3\nvim /data/local/postgresql/data/postgresql.conf\nlisten_addresses = '*'\nport = 5432\nmax_connections = 1000\n\n# \u4fee\u6539\u6570\u636e\u5e93\u8bbf\u95ee\u7b56\u7565\nvim /data/local/postgresql/data/pg_hba.conf\n# IPv4 local connections:\nhost    all             all             192.168.0.0/24            trust\nhost    all             all             0.0.0.0/0                 md5\n\n# \u542f\u52a8\u6570\u636e\u5e93\n/data/local/postgresql/bin/pg_ctl -D /data/local/postgresql/data/ -l logfile start\n# \u4fee\u6539postgres\u7528\u6237\u5bc6\u7801\n/data/local/postgresql/bin/psql -U postgres -h localhost -c \"ALTER USER postgres WITH PASSWORD '2#w4a8BV6qHP3LG#';\"\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4\u8fdc\u7a0b\u8fde\u63a5",children:"4\u3001\u8fdc\u7a0b\u8fde\u63a5"}),"\n",(0,r.jsx)(n.p,{children:"\u5173\u95ed\u9632\u706b\u5899\u6216\u8005\u6253\u5f005432\u7aef\u53e3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u68c0\u67e5\u9632\u706b\u5899\u72b6\u6001\nsudo firewall-cmd --state\n\n# \u6dfb\u52a0\u5165\u7ad9\u89c4\u5219\nsudo firewall-cmd --permanent --add-port=5432/tcp\n\n# \u91cd\u542f\u9632\u706b\u5899\nsudo firewall-cmd --reload\n\n# \u5217\u51fa\u5f00\u653e\u7684\u7aef\u53e3\nsudo firewall-cmd --list-ports\n\n# \u5217\u51fa\u6dfb\u52a0\u7684\u670d\u52a1\nsudo firewall-cmd --list-services\n\n# \u5217\u51fa\u5f53\u524d\u7cfb\u7edf\u4e0a\u6253\u5f00\u7684\u6240\u6709\u7f51\u7edc\u8fde\u63a5\u548c\u76d1\u542c\u7aef\u53e3\nnetstat -tuln\n# \u540c\u65f6\u663e\u793a\u670d\u52a1\u540d\u79f0\nsudo netstat -tulnp\n"})}),"\n",(0,r.jsx)(n.h3,{id:"5\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",children:"5\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'# \u62f7\u8d1dlinux\u6587\u4ef6\uff0c\u5e76\u66f4\u540d\u4e3apostgresql\ncp /data/local/postgresql/contrib/start-scripts/linux /etc/init.d/postgresql\n\nsed -i "s/\\/usr\\/local\\/pgsql/\\/data\\/local\\/postgresql/g" /etc/init.d/postgresql\nsed -i "s/\\/usr\\/local\\/pgsql\\/data/\\/data\\/local\\/postgresql\\/data/g" /etc/init.d/postgresql\n\n# \u6dfb\u52a0\u6267\u884c\u6743\u9650 \u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nchmod a+x /etc/init.d/postgresql\nchkconfig --add postgresql\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49\u670d\u52a1\u6ce8\u518c\u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u6dfb\u52a0\u670d\u52a1\u6ce8\u518c\u6587\u4ef6\ncat > /etc/systemd/system/postgresql.service << EOF\n[Unit]\nDescription=PostgreSQL Database Server\n\n[Service]\nType=forking\nExecStart=/data/local/postgresql/bin/pg_ctl start -D /data/local/postgresql/data -l /data/local/postgresql/log/logfile.log\nExecStop=/data/local/postgresql/bin/pg_ctl stop -D /data/local/postgresql/data\nRestart=always\nRestartSec=5\nUser=postgres\nGroup=postgres\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d systemd\nsystemctl daemon-reload\n\n# \u542f\u52a8pgsql\u5e76\u67e5\u770b\u72b6\u6001\nsystemctl start postgresql\nsystemctl status postgresql\nsystemctl stop postgresql\nsystemctl restart postgresql\n\n# \u72b6\u6001\u6b63\u5e38\u5373\u53ef\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsystemctl enable postgresql\nsystemctl disable postgresql\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," \u9700\u8981\u5728",(0,r.jsx)(n.code,{children:"[Service]"}),"\u6807\u7b7e\u4e0b\u6307\u5b9a\u542f\u52a8\u7684\u7528\u6237 \u7528\u6237\u7ec4\uff0c\u5426\u5219\u4f1a\u542f\u52a8\u5931\u8d25"]}),"\n",(0,r.jsx)(n.h2,{id:"\u4e09\u5b89\u88c5influxdb-184",children:"\u4e09\u3001\u5b89\u88c5Influxdb 1.8.4"}),"\n",(0,r.jsx)(n.h3,{id:"1\u4e0b\u8f7d-rpm-\u5b89\u88c5\u5305",children:"1\u3001\u4e0b\u8f7d rpm \u5b89\u88c5\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"wget https://dl.influxdata.com/influxdb/releases/influxdb-1.8.4.x86_64.rpm\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u5b89\u88c5",children:"2\u3001\u5b89\u88c5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u5b89\u88c5rpm\u5305\nyum localinstall -y influxdb-1.8.4.x86_64.rpm\n\n# \u5f00\u673a\u81ea\u542f\nsystemctl enable influxdb\n\n# \u542f\u52a8\nsystemctl start influxdb\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\u521b\u5efa\u65b0\u7528\u6237",children:"3\u3001\u521b\u5efa\u65b0\u7528\u6237"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"influx\n# \u8fdb\u5165influx\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\uff0c\u521b\u5efa\u7528\u6237\uff1a\nCREATE USER \"yongtuoif@Pisx\" WITH PASSWORD '3Xj3W5fun3N!MjL5' WITH ALL PRIVILEGES\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u542f\u52a8\u6743\u9650\u9a8c\u8bc1",children:"4\u3001\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u542f\u52a8\u6743\u9650\u9a8c\u8bc1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"vim /etc/influxdb/influxdb.conf\n[http]\nauth-enabled = true\n\n# \u91cd\u542finfluxdb\u670d\u52a1\nsystemctl restart influxdb\n\n# \u9a8c\u8bc1\u8d26\u53f7\u5bc6\u7801\ninflux -username 'yongtuoif@Pisx' -password '3Xj3W5fun3N!MjL5'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u56db\u5b89\u88c5minio-release2023-09-16t01-01-47z",children:"\u56db\u3001\u5b89\u88c5Minio RELEASE.2023-09-16T01-01-47Z"}),"\n",(0,r.jsx)(n.h3,{id:"1\u4e0b\u8f7d-rpm-\u5b89\u88c5\u5305-1",children:"1\u3001\u4e0b\u8f7d rpm \u5b89\u88c5\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u4e0b\u8f7d\u5b89\u88c5\u5305\nwget https://dl.min.io/server/minio/release/linux-amd64/minio\n\n# \u521b\u5efa\u76ee\u5f55\nmkdir -p /data/local/minio/data\nmkdir -p /data/local/minio/conf\nmkdir -p /data/local/minio/log\nmkdir -p /data/local/minio/bin\n\n# \u79fb\u52a8minio\u6587\u4ef6 \u8d4b\u4e88\u53ef\u6267\u884c\u6743\u9650\nmv minio /data/local/minio/bin\nchmod +x /data/local/minio/bin/minio\n\n# \u521b\u5efa\u65e5\u5fd7\u6587\u4ef6\ntouch /data/local/minio/log/minio.log\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u7f16\u5199\u914d\u7f6e\u6587\u4ef6\u542f\u52a8\u811a\u672c",children:"2\u3001\u7f16\u5199\u914d\u7f6e\u6587\u4ef6\u3001\u542f\u52a8\u811a\u672c"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'# \u914d\u7f6e\u6587\u4ef6\ncat > /data/local/minio/conf/minio.conf << EOF\n# This is minio conf.\nMINIO_VOLUMES="/data/local/minio/data"\n# \u7aef\u53e3\u53f7\u8bbe\u7f6e\nMINIO_OPTS="--address \\":9000\\" --console-address \\":9001\\""\n# \u7528\u6237\u540d \u5bc6\u7801\nMINIO_ROOT_USER="yongtuomi"\nMINIO_ROOT_PASSWORD="Y2rKNdWKLsujDY"\nEOF\n\n# \u542f\u52a8\u811a\u672c\ncat > /data/local/minio/bin/start.sh << EOF\n#!/bin/bash\nexport MINIO_ROOT_USER=yongtuomi\nexport MINIO_ROOT_PASSWORD=Y2rKNdWKLsujDY\nnohup /data/local/minio/bin/minio server /data/local/minio/data --console-address ":9001" --address ":9000" > /data/local/minio/log/minio.log 2>&1 &\nEOF\n\n# \u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x /data/local/minio/bin/start.sh\n# \u542f\u52a8\nsh /data/local/minio/bin/start.sh\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",children:"3\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'# \u6dfb\u52a0\u670d\u52a1\u6ce8\u518c\u6587\u4ef6\ncat > /etc/systemd/system/minio.service << EOF\n[Unit]\nDescription=MinIO\nDocumentation=https://min.io/docs/minio/linux/index.html\nWants=network-online.target\nAfter=network-online.target\nAssertFileIsExecutable=/data/local/minio/bin/minio\n\n[Service]\nWorkingDirectory=/data/local/\n\nUser=root\nGroup=root\nProtectProc=invisible\n\nEnvironmentFile=-/data/local/minio/conf/minio.conf\nExecStartPre=/bin/bash -c "if [ -z \\"${MINIO_VOLUMES}\\" ]; then echo \\"Variable MINIO_VOLUMES not set in /data/local/minio/conf/minio.conf\\"; exit 1; fi"\nExecStart=/data/local/minio/bin/minio server $MINIO_OPTS $MINIO_VOLUMES > /data/local/minio/log/minio.log 2>&1\n\n# MinIO RELEASE.2023-05-04T21-44-30Z adds support for Type=notify (https://www.freedesktop.org/software/systemd/man/systemd.service.html#Type=)\n# This may improve systemctl setups where other services use `After=minio.server`\n# Uncomment the line to enable the functionality\n# Type=notify\n\n# Let systemd restart this service always\nRestart=always\n# Specifies the maximum file descriptor number that can be opened by this process\nLimitNOFILE=65536\n# Specifies the maximum number of threads this process can create\nTasksMax=infinity\n# Disable timeout logic and wait until process is stopped\nTimeoutStopSec=infinity\nSendSIGKILL=no\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d systemd\nsystemctl daemon-reload\n\n# \u542f\u52a8nginx\u5e76\u67e5\u770b\u72b6\u6001\nsystemctl start minio\nsystemctl status minio\nsystemctl stop minio\nsystemctl restart minio\n\n# \u72b6\u6001\u6b63\u5e38\u5373\u53ef\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsystemctl enable minio\nsystemctl disable minio\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u811a\u672c\u4e2d\u6709\u73af\u5883\u53d8\u91cf\u5f15\u7528\uff0c\u76f4\u63a5\u4f7f\u7528",(0,r.jsx)(n.code,{children:"cat"}),"\u5199\u5165\u4f1a\u4e22\u5931\u73af\u5883\u53d8\u91cf\u7684\u540d\u79f0\uff0c\u9700\u8981\u624b\u52a8\u7f16\u8f91"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"EnvironmentFile=-/data/local/minio/conf/minio.conf"}),"\u52a0\u8f7d\u6587\u4ef6\u5185\u5bb9\u4e3a\u73af\u5883\u53d8\u91cf\uff0c",(0,r.jsx)(n.code,{children:"-"}),"\u8868\u793a\u6587\u4ef6\u4e0d\u5b58\u5728\u4e0d\u62a5\u9519"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cat > filename << EOF"})," \u8868\u793a\u5199\u5165\uff0c\u4f1a\u8986\u76d6\u539f\u5185\u5bb9\uff1b ",(0,r.jsx)(n.code,{children:"cat >> filename << EOF"}),"\u8868\u793a\u8ffd\u52a0\uff0c\u4e0d\u4f1a\u8986\u76d6\u539f\u5185\u5bb9"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u4e94\u5b89\u88c5nginx-1221",children:"\u4e94\u3001\u5b89\u88c5Nginx 1.22.1"}),"\n",(0,r.jsx)(n.h3,{id:"1\u672c\u5730\u7f16\u8bd1\u6e90\u7801-1",children:"1\u3001\u672c\u5730\u7f16\u8bd1\u6e90\u7801"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://ftp.pcre.org/pub/pcre/",children:"pcre"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"http://www.zlib.net/",children:"zlib"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.openssl.org/",children:"openssl"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u5b89\u88c5\u4f9d\u8d56\u9879\nyum install -y pcre pcre-devel zlib zlib-devel openssl openssl-devel\n# apt install -y build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev openssl libssl-dev\n\n# \u521b\u5efa\u76ee\u5f55\nmkdir -p /home/light/nginx/build\n\n# \u4e0b\u8f7d\u6e90\u7801\u5305\nwget https://nginx.org/download/nginx-1.22.1.tar.gz\n\n# \u89e3\u538b\ntar -zxvf nginx-1.22.1.tar.gz -C /home/light/nginx\n\n# \u7f16\u8bd1\n./configure \\\n    --prefix=/home/light/nginx/build \\\n    --with-http_ssl_module \\\n    --with-http_realip_module \\\n    --with-http_addition_module \\\n    --with-http_gzip_static_module \\\n    --with-http_gunzip_module \\\n    --with-http_secure_link_module \\\n    --with-http_stub_status_module \\\n    --with-http_v2_module \\\n    --with-ipv6 \\\n    --with-mail \\\n    --with-mail_ssl_module\nmake\n\n# \u5b89\u88c5\nsudo make install\n\n# \u6253\u5305\ncd /home/light/nginx/build\ntar -zcvf nginx-1.22.1.tar.gz ./conf ./html ./logs ./sbin\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--prefix"}),"\uff1aNginx\u5b89\u88c5\u7684\u6839\u8def\u5f84\uff0c\u6240\u6709\u5176\u4ed6\u7684\u5b89\u88c5\u8def\u5f84\u90fd\u8981\u4f9d\u8d56\u4e8e\u8be5\u9009\u9879\u3002\u9ed8\u8ba4\u4e3a/usr/local/nginx"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_ssl_module"}),"\uff1a\u5b89\u88c5http ssl module \u4f7fNginx\u652f\u6301SSL\u534f\u8bae\uff0c\u63d0\u4f9bHTTPS\u670d\u52a1"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_realip_module"}),"\uff1a\u5b89\u88c5http realip module \u53ef\u4ee5\u5728\u8bf7\u6c42\u5934\u6dfb\u52a0 ",(0,r.jsx)(n.code,{children:"X-Real-IP"})," ",(0,r.jsx)(n.code,{children:"X-Forwarded-For"}),"\u83b7\u53d6\u5ba2\u6237\u7aef\u771f\u5b9eIP"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_addition_module"}),"\uff1a\u5b89\u88c5http addition module \u53ef\u4ee5\u5728Http\u54cd\u5e94\u5305\u5934\u90e8\u6216\u5c3e\u90e8\u589e\u52a0\u5185\u5bb9"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_gzip_static_module"}),"\uff1a\u5b89\u88c5http gzip static module \u53ef\u4ee5\u628a\u4e00\u4e9b\u6587\u6863\u8fdb\u884c\u538b\u7f29\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u5e76\u5728\u538b\u7f29\u524d\u8fdb\u884c\u68c0\u67e5\u662f\u5426\u5df2\u7ecf\u6709\u538b\u7f29\u8fc7\u7684\u5305\u8fd4\u56de"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_gunzip_module"}),"\uff1a\u5b89\u88c5http gunzip module \u5bf9\u4e8e\u4e0d\u652f\u6301gzip\u7f16\u7801\u7684\u5ba2\u6237\uff0c\u8be5\u6a21\u5757\u7528\u4e8e\u4e3a\u5ba2\u6237\u89e3\u538b\u7f29\u9884\u538b\u7f29\u5185\u5bb9"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_secure_link_module"}),"\uff1a\u5b89\u88c5http secure link module \u9a8c\u8bc1\u8bf7\u6c42\u662f\u5426\u6709\u6548\uff0c\u63d0\u4f9b\u5b89\u5168\u673a\u5236"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_stub_status_module"}),"\uff1a\u5b89\u88c5http stub status module \u8ba9Nginx\u63d0\u4f9b\u6027\u80fd\u7edf\u8ba1\u538b\u9762\uff0c\u83b7\u53d6\u76f8\u5173\u5e76\u53d1\u8fde\u63a5\u3001\u8bf7\u6c42\u4fe1\u606f"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-http_v2_module"}),"\uff1a\u5b89\u88c5http v2 module \u652f\u6301Http 2.0"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-ipv6"})," \u652f\u6301IPv6"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-mail"})," \u652f\u6301\u90ae\u4ef6\u670d\u52a1\u5668\u53cd\u5411\u4ee3\u7406\uff0c\u9ed8\u8ba4\u5b89\u88c5 imap pop3 smtp\u7b49\u6a21\u5757"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--with-mail_ssl_module"})," \u4f7f imap pop3 smtp \u652f\u6301SSL/TLS\u534f\u8bae"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--without-mail_imap_module"})," \u4e0d\u5b89\u88c5imap"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--without-mail_pop3_module"})," \u4e0d\u5b89\u88c5pop3"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--without-mail_smtp_module"})," \u4e0d\u5b89\u88c5smtp"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305-1",children:"2\u3001\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u89e3\u538bnginx-1.22.1.tar.gz\u5230/data/local\ntar -xzvf nginx-1.22.1.tar.gz -C /data/local\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\u542f\u52a8nginx",children:"3\u3001\u542f\u52a8nginx"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"/data/local/nginx/sbin/nginx\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f",children:"4\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u6dfb\u52a0\u670d\u52a1\u6ce8\u518c\u6587\u4ef6\ncat > /etc/systemd/system/nginx.service << EOF\n[Unit]\nDescription=The NGINX HTTP and reverse proxy server\nAfter=network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nPIDFile=/data/local/nginx/logs/nginx.pid\nExecStartPre=/data/local/nginx/sbin/nginx -t -q -g 'daemon on; master_process on;'\nExecStart=/data/local/nginx/sbin/nginx -g 'daemon on; master_process on;'\nExecReload=/data/local/nginx/sbin/nginx -g 'daemon on; master_process on;' -s reload\nExecStop=/data/local/nginx/sbin/nginx -g 'daemon on; master_process on;' -s quit\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d systemd\nsystemctl daemon-reload\n\n# \u542f\u52a8nginx\u5e76\u67e5\u770b\u72b6\u6001\nsystemctl start nginx\nsystemctl status nginx\nsystemctl stop nginx\nsystemctl restart nginx\n\n# \u72b6\u6001\u6b63\u5e38\u5373\u53ef\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsystemctl enable nginx\nsystemctl disable nginx\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u516d\u5b89\u88c5emqx-520",children:"\u516d\u3001\u5b89\u88c5EMQX 5.2.0"}),"\n",(0,r.jsx)(n.h3,{id:"1\u4e0b\u8f7d\u5b89\u88c5\u5305",children:"1\u3001\u4e0b\u8f7d\u5b89\u88c5\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u4e0b\u8f7d\nwget https://www.emqx.com/zh/downloads/broker/5.2.0/emqx-5.2.0-el7-amd64.tar.gz\n\n# \u5b89\u88c5\nmkdir -p /data/local/emqx\ntar -zxvf emqx-5.2.0-el7-amd64.tar.gz -C /data/local/emqx\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u8fd0\u884c",children:"2\u3001\u8fd0\u884c"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"useradd emqx\nchown -R emqx:emqx /data/local/emqx/\n\n/data/local/emqx/bin/emqx start\n/data/local/emqx/bin/emqx stop\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f-1",children:"3\u3001\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u6dfb\u52a0\u670d\u52a1\u6ce8\u518c\u6587\u4ef6\ncat > /etc/systemd/system/emqx.service << EOF\n[Unit]\nDescription=EMQ X Broker\nAfter=network.target\n\n[Service]\n# Type=simple\nType=forking\nExecStart=/data/local/emqx/bin/emqx start\nExecStop=/data/local/emqx/bin/emqx stop\nRestart=on-failure\nUser=root\nGroup=root\nLimitNOFILE=65536\nLimitNPROC=4096\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d systemd\nsystemctl daemon-reload\n\n# \u542f\u52a8emqx\u5e76\u67e5\u770b\u72b6\u6001\nsystemctl start emqx\nsystemctl status emqx\nsystemctl stop emqx\nsystemctl restart emqx\n\n# \u72b6\u6001\u6b63\u5e38\u5373\u53ef\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsystemctl enable emqx\nsystemctl disable emqx\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e03\u5b89\u88c5redis-cluster-7012",children:"\u4e03\u3001\u5b89\u88c5Redis Cluster 7.0.12"}),"\n",(0,r.jsx)(n.h3,{id:"1\u672c\u5730\u7f16\u8bd1\u6e90\u7801-2",children:"1\u3001\u672c\u5730\u7f16\u8bd1\u6e90\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u76ee\u5f55\nmkdir -p /home/light/redis/build/conf\n\n# \u4e0b\u8f7d\u6e90\u7801\u5305\nwget https://download.redis.io/releases/redis-7.0.12.tar.gz\n\n# \u89e3\u538b\ntar -xzvf redis-7.0.12.tar.gz -C /home/light/redis\n\n# \u7f16\u8bd1\ncd redis-7.0.12/\nmake\n\n# \u5b89\u88c5\nmake install PREFIX=/home/light/redis/build\n# \u590d\u5236\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\ncp redis.conf /home/light/redis/build/conf\n\n# \u6253\u5305\ntar -zcvf redis-7.0.12.tar.gz ./conf ./bin\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305-2",children:"2\u3001\u4e0a\u4f20\u89e3\u538b\u7f16\u8bd1\u540e\u7684\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# 22\u521b\u5efa\u76ee\u5f55\nmkdir -p /data/local/redis/node-6381\nmkdir -p /data/local/redis/node-6382\n\n# 21\u521b\u5efa\u76ee\u5f55\nmkdir -p /data/local/redis/node-6383\nmkdir -p /data/local/redis/node-6384\n\n# 23\u521b\u5efa\u76ee\u5f55\nmkdir -p /data/local/redis/node-6385\nmkdir -p /data/local/redis/node-6386\n\n# \u89e3\u538b\u7f29redis-7.0.12.tar.gz\ntar -xzvf redis-7.0.12.tar.gz -C /data/local/redis/node-638*/\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\u4fee\u6539\u914d\u7f6e\u6587\u4ef6",children:"3\u3001\u4fee\u6539\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(n.p,{children:"\u5c06\u5982\u4e0bredis.conf\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5206\u522b\u6309\u5404\u81eaip\u5730\u5740\u53caport\u8986\u76d6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"port ${port}\nrequirepass 5pKu5D8Lm\nmasterauth 5pKu5D8Lm\nbind 0.0.0.0 -::0\nprotected-mode no\ndaemonize no\nappendonly yes\ncluster-enabled yes \ncluster-config-file nodes-${port}.conf\ncluster-node-timeout 5000\ncluster-announce-ip  \u670d\u52a1\u5668ip\u5730\u5740\ncluster-announce-port ${port}\ncluster-announce-bus-port 1${port}\n\nvi /data/local/redis/node-638*/redis-7.0.12/redis.conf\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4\u914d\u7f6eetcsysctlconf",children:"4\u3001\u914d\u7f6e/etc/sysctl.conf"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"vi /etc/sysctl.conf\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u6700\u540e\u4e00\u884c\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"net.core.somaxconn = 10240\nvm.overcommit_memory=1\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4fdd\u5b58\u540e\u8f93\u5165\uff1a",(0,r.jsx)(n.code,{children:"sysctl -p"})," \u4f7f\u914d\u7f6e\u7acb\u5373\u751f\u6548\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"5\u542f\u52a8\u5404redis-\u8282\u70b9",children:"5\u3001\u542f\u52a8\u5404Redis \u8282\u70b9"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u8fdb\u5165/data/local/redis\u76ee\u5f55\ncd /data/local/redis\n\n# \u542f\u52a8\u5404Redis \u8282\u70b9\nnohup /data/local/redis/node-638*/redis-7.0.12/src/redis-server \\\n    /data/local/redis/node-638*/redis-7.0.12/redis.conf > /dev/null 2>&1 &\n\n# \u521b\u5efaRedis Cluster\u96c6\u7fa4\n/data/local/redis/node-6381/redis-7.0.12/src/redis-cli  -a 5pKu5D8Lm \\\n    --cluster create 192.168.56.102:6381 192.168.56.102:6382 \\\n        192.168.56.102:6383 192.168.56.102:6384 \\\n        192.168.56.102:6385 192.168.56.102:6386 \\\n    --cluster-replicas 1 \n"})}),"\n",(0,r.jsx)(n.h3,{id:"7\u5355\u8282\u70b9\u5b89\u88c5",children:"7\u3001\u5355\u8282\u70b9\u5b89\u88c5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u521b\u5efa\u76ee\u5f55\nmkdir -p /data/local/redis/single\n\n# \u89e3\u538b\u7f29redis-7.0.12.tar.gz\ntar -xzvf redis-7.0.12.tar.gz -C /data/local/redis/single\n\n# \u6dfb\u52a0\u670d\u52a1\u6ce8\u518c\u6587\u4ef6\ncat > /etc/systemd/system/redis.service << EOF\n[Unit]\nDescription=Redis Server\nAfter=network.target\n\n[Service]\nExecStart=/data/local/redis/single/redis-7.0.12/src/redis-server /data/local/redis/single/redis-7.0.12/redis.conf\nExecStop=/data/local/redis/single/redis-7.0.12/src/redis-cli shutdown\nUser=root\nGroup=root\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\n# \u91cd\u65b0\u52a0\u8f7d systemd\nsystemctl daemon-reload\n\n# \u542f\u52a8pgsql\u5e76\u67e5\u770b\u72b6\u6001\nsystemctl start redis\nsystemctl status redis\nsystemctl stop redis\nsystemctl restart redis\n\n# \u72b6\u6001\u6b63\u5e38\u5373\u53ef\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsystemctl enable redis\nsystemctl disable redis\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u516b\u670d\u52a1\u90e8\u7f72",children:"\u516b\u3001\u670d\u52a1\u90e8\u7f72"}),"\n",(0,r.jsx)(n.h3,{id:"1\u524d\u7aef\u914d\u7f6e\u6587\u4ef6",children:"1\u3001\u524d\u7aef\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nginx"}),"\u6839\u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(n.code,{children:"/data/local/nginx/nginx.conf"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'user  nginx;\nworker_processes  auto;\n\nerror_log  logs/error.log notice;\npid        logs/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n                      \'$status $body_bytes_sent "$http_referer" \'\n                      \'"$http_user_agent" "$http_x_forwarded_for"\';\n\n    access_log  logs/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    types {\n        application/vnd.ms-fontobject   eot;\n        font/ttf                        ttf;\n        font/opentype                   otf;\n        font/x-woff                     woff;\n        image/svg+xml                   svg;\n    }\n\n    # websocket\n    map $http_upgrade $connection_upgrade {\n        default upgrade;\n        \'\'      close;\n    }\n\n    # gzip config\n    gzip            on;\n    gzip_min_length 1k;\n    gzip_comp_level 6;\n    gzip_types      text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php     image/jpeg image/gif image/png font/ttf font/opentype font/x-woff;\n    gzip_vary       on;\n    gzip_disable    "MSIE [1-6]\\.";\n\n    proxy_buffer_size           1024k;\n    proxy_buffers               16  1024k;\n    proxy_busy_buffers_size     2048k;\n    proxy_temp_file_write_size  2048k;\n\n    client_header_timeout       120;\n    client_body_timeout         120;\n    send_timeout                120;\n    client_max_body_size        10m;\n\n    include /data/local/nginx/conf.d/*.conf;\n}\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["\u5e73\u53f0\u524d\u7aef\u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(n.code,{children:"/data/local/nginx/conf.d/platform.conf"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"upstream platform_oauth {  \n   server 192.168.0.21:31888;   \n}\n\nupstream platform_system {  \n   server 192.168.0.21:31112;   \n}\n\nupstream platform_thing {  \n   server 192.168.0.21:31111;   \n}\n\nupstream platform_message {  \n   server 192.168.0.21:31890;   \n}\n\nupstream platform_workflow {  \n   server 192.168.0.21:31113;   \n}\n\nupstream platform_plugin {  \n   server 192.168.0.21:31116;   \n}\n\nserver {\n    listen       9096;\n    server_name  localhost;\n\n    #charset koi8-r;\n\n    #access_log  logs/host.access.log  main;\n    location / {\n        root   html/platform;\n        index  index.html index.htm;\n        if (!-e $request_filename) {\n            rewrite ^(.*)$ /index.html?s=$1 last;\n            break;\n        }\n    }\n\n    location /monitor {\n        alias  html/monitor;\n        index  index.html index.htm;\n    }\n\n    # \u540e\u53f0\u4ee3\u7406\u914d\u7f6e \u4ee5auth\u670d\u52a1\u4e3a\u4f8b\n    location ^~ /oauth/ {\n        proxy_pass              http://platform_oauth;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    location ^~ /system/ {\n        proxy_pass              http://platform_system;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    location ^~ /thing/ {\n        proxy_pass              http://platform_thing;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    location ^~ /message/ {\n        proxy_pass              http://platform_message;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    location ^~ /workflow/ {\n        proxy_pass              http://platform_workflow;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    location ^~ /plugin/ {\n        proxy_pass              http://platform_plugin;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    location ^~ /ws/ {\n        proxy_pass              http://platform_thing;\n        client_max_body_size    100m;\n        proxy_redirect          default;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n    #error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   html;\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4e1a\u52a1\u524d\u7aef\u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(n.code,{children:"/data/local/nginx/conf.d/business.conf"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"upstream business_main {  \n   server 192.168.0.21:31222;   \n}\n\nupstream business_demo {  \n   server 192.168.0.21:31223;   \n}\n\nserver {\n    listen       80;\n    server_name  localhost;\n\n    #charset koi8-r;\n\n    #access_log  logs/host.access.log  main;\n\n    #\u89e3\u51b3Router(mode: 'history')\u6a21\u5f0f\u4e0b\uff0c\u5237\u65b0\u8def\u7531\u5730\u5740\u4e0d\u80fd\u627e\u5230\u9875\u9762\u7684\u95ee\u9898\n    location / {\n        root   html/business;\n        index  index.html index.htm;\n        if (!-e $request_filename) {\n            rewrite ^(.*)$ /index.html?s=$1 last;\n            break;\n        }\n    }\n\n    location /monitor {\n        alias  html/monitor;\n        index  index.html index.htm;\n    }\n\n    location ^~ /business/ {\n        proxy_pass              http://business_main;\n        proxy_http_version      1.1;\n        proxy_read_timeout      900s;\n        proxy_set_header        Host $http_host;\n        proxy_set_header        X-Real-IP $remote_addr;\n        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header        X-NginX-Proxy true;\n        proxy_set_header        Upgrade $http_upgrade;\n        proxy_set_header        Connection $connection_upgrade\n    }\n\n    # \u4f7f\u7528\u6355\u83b7\u7ec4 $1 \u6765\u4f20\u9012\u5269\u4f59\u8def\u5f84 /demo/123 -> /123\n    location ~ ^/demo(/.*)$ {\n        proxy_pass http://business_demo$1;\n    }\n\n    #error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   html;\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u524d\u7aef\u90e8\u7f72",children:"2\u3001\u524d\u7aef\u90e8\u7f72"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u6253\u5305\nnpm run build\n\n# \u538b\u7f29dist \u5f97\u5230 dist.zip\n# \u5c06\u6587\u4ef6\u4e0a\u4f20\u5230\u670d\u52a1\u5668\nscp D:/frontend/dist.zip root@192.168.0.21:/data/local/nginx/html/\n\n# \u89e3\u538b\nunzip dist.zip -d ./frontend\n\n# \u91cd\u542fNginx\nsystemctl restart nginx\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\u540e\u7aef\u914d\u7f6e\u6587\u4ef6",children:"3\u3001\u540e\u7aef\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u6253\u5305\u955c\u50cf\u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(n.code,{children:"Dockerfile"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-Dockerfile",children:'FROM frolvlad/alpine-oraclejdk8:slim\nVOLUME /tmp\nADD auth-service.jar /\nRUN sh -c \'touch /auth-service.jar\'\nENV JAVA_OPTS="-Duser.timezone=Asia/Shanghai -Xms1g -Xmx2g"\nENTRYPOINT [ "sh", "-c", "java ${JAVA_OPTS} -jar /auth-service.jar" ]\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["k8s\u90e8\u7f72\u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(n.code,{children:"K8s.yaml"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Service\nmetadata:\n  name: svc-auth-service\n  namespace: svc-platform\nspec:\n  type: NodePort\n  selector:\n    app: auth-service\n  ports:\n    - name: http\n      port: 31888\n      targetPort: 31888\n      nodePort: 31888\n      protocol: TCP\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dep-auth-service\n  namespace: svc-platform\nspec:\n  minReadySeconds: 5\n  revisionHistoryLimit: 3\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  replicas: 1\n  selector:\n    matchLabels:\n      app: auth-service\n      version: "1.0.0"\n  template:\n    metadata:\n      labels:\n        app: auth-service\n        version: "1.0.0"\n    spec:\n      imagePullSecrets:\n        - name: dockerimage\n      containers:\n        - name: auth-service\n          image: 192.168.0.22:5000/auth-service:1.0.0\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 31888\n          # \u542f\u52a8\u63a2\u9488\uff0c\u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u542f\u52a8\u6210\u529f\n          startupProbe:\n            httpGet:\n              path: /oauth/actuator/health/readiness\n              port: 31888\n            periodSeconds: 10 # \u63a2\u6d4b\u65f6\u95f4\u95f4\u9694\n            timeoutSeconds: 5 # \u8d85\u65f6\u65f6\u95f4\n            failureThreshold: 30 # \u91cd\u8bd5\u6b21\u6570\n          # \u5b58\u6d3b\u63a2\u9488\uff0c\u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u5b58\u6d3b\n          livenessProbe:\n            httpGet:\n              path: /oauth/actuator/health/liveness\n              port: 31888\n            initialDelaySeconds: 5\n            periodSeconds: 5\n            timeoutSeconds: 20\n            failureThreshold: 3\n          resources:\n            limits:\n              cpu: "2"\n              memory: "2048Mi"\n            requests:\n              cpu: "1"\n              memory: "1024Mi"\n'})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u90e8\u7f72\u811a\u672c ",(0,r.jsx)(n.code,{children:"deploy.sh"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'#!/bin/bash\n\n# \u5b9a\u4e49\u955c\u50cf\u540d\u79f0\u548c\u7248\u672c\u9ed8\u8ba4\u503c\nimage_name=""\nimage_version=""\nimage_registry=""\n\n# \u4f7f\u7528getopts\u6765\u89e3\u6790\u9009\u9879\u548c\u53c2\u6570\nwhile getopts "i:v:-:" opt; do\n    case "$opt" in\n        i|image)\n            image_name="$OPTARG"\n            ;;\n        v|version)\n            image_version="$OPTARG"\n            ;;\n        r|registry)\n            image_registry="$OPTARG"\n            ;;\n        -)\n            case "${OPTARG}" in\n                image=*)\n                    image_name="${OPTARG#*=}"\n                    ;;\n                version=*)\n                    image_version="${OPTARG#*=}"\n                    ;;\n                registry=*)\n                    image_registry="${OPTARG#*=}"\n                    ;;\n                *)\n                    echo "Invalid option: --$OPTARG" >&2\n                    exit 1\n                    ;;\n            esac\n            ;;\n        *)\n            echo "Invalid option: -$OPTARG" >&2\n            exit 1\n            ;;\n    esac\ndone\n\n# \u68c0\u67e5\u53c2\u6570\u662f\u5426\u5df2\u63d0\u4f9b\nif [ -z "$image_name" ] || [ -z "$image_version" ]; then\n    echo "Usage: $0 -i|--image <image_name> -v|--version <version_no> -r|--registry <registry_address>"\n    exit 1\nfi\n\n\n# \u83b7\u53d6\u5f53\u524d\u65e5\u671f\u548c\u65f6\u95f4\uff0c\u7528\u4e8e\u521b\u5efa\u5907\u4efd\u6587\u4ef6\u548c\u6807\u8bb0\ntimestamp=$(date +%Y%m%d%H%M%S)\n\n# \u5907\u4efd\u955c\u50cf\u4e3atar\u6587\u4ef6\ndocker save -o "${image_name}_${image_version}_${timestamp}.tar" "${image_name}:${image_version}" || echo "continue execute"\ndocker rmi ${image_name}:${image_version} || echo "continue execute"\n\n# \u6784\u5efa\u65b0\u7684Docker\u955c\u50cf\ndocker build -t "${image_name}:${image_version}" .\n\n# \u63a8\u9001\u65b0\u7684Docker\u955c\u50cf\u5230\u955c\u50cf\u4ed3\u5e93\nif [ "$image_registry" ]; then\n    docker rmi ${image_registry}/${image_name}:${image_version} || echo "continue execute"\n    docker tag ${image_name}:${image_version} ${image_registry}/${image_name}:${image_version}\n    docker push ${image_registry}/${image_name}:${image_version}\nfi\n\nexport KUBECONFIG="/root/.kube/config"\nexport PATH="$PATH:/var/lib/rancher/rke2/bin/"\n# \u505c\u6b62\u4e4b\u524d\u7684\u90e8\u7f72\nkubectl delete -f k8s.yaml || echo "continue execute"\n\n# \u7b49\u5f853\u79d2\nsleep 3\n\n# \u5728Kubernetes\u4e0a\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\nkubectl apply -f k8s.yaml || echo "continue execute"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"4\u540e\u7aef\u670d\u52a1\u90e8\u7f72",children:"4\u3001\u540e\u7aef\u670d\u52a1\u90e8\u7f72"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u67e5\u8be2namespace\nkubectl get namespaces\n\n# \u4e0d\u5b58\u5728\u5219\u65b0\u5efa\u4e00\u4e2a namespace\nkubectl create namespace svc-pd-service\n\n# \u6dfb\u52a0\u6267\u884c\u6743\u9650\nchmod +x ./deploy.sh\n\n# \u4e00\u952e\u90e8\u7f72\n./deploy.sh -i auth-service -v 1.0.0\n\n\n# \u67e5\u770b\u6240\u6709\u955c\u50cf\ncurl -X GET http://192.168.0.22:5000/v2/_catalog\n\n# \u67e5\u770b\u6307\u5b9a\u955c\u50cf\u7684\u6240\u6709\u7248\u672c\ncurl -X GET http://192.168.0.22:5000/v2/auth-service/tags/list\n\n# \u67e5\u770bpod\u57fa\u7840\u4fe1\u606f\nkubectl get pods -n svc-pd-service -o wide\n\n# \u67e5\u770bpod\u8be6\u7ec6\u4fe1\u606f\nkubectl describe pod -n svc-pd-service <pod-name>\n\n# \u83b7\u53d6ClusterIP\u7528\u4e8e\u53cd\u5411\u4ee3\u7406\nkubectl get svc -n svc-pd-service svc-auth-service \n\n# \u67e5\u770b\u65e5\u5fd7\nkubectl logs -n svc-pd-service dep-auth-service-6674cff5c9-29r78 \n\n# \u67e5\u770bk8s\u5e95\u5c42\u5bb9\u5668\u8fd0\u884c\u65f6\nkubectl get nodes -o custom-columns=NODE:.metadata.name,RUNTIME:.status.nodeInfo.containerRuntimeVersion\n\n# \u67e5\u770bcri\u4fe1\u606f\ncrictl info \ncrictl version \n\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# \u6253\u5305\nmvn clean package -U -Dmaven.test.skip=true\n\n# \u7f16\u8bd1Docker\u955c\u50cf\ndocker build backend:1.0.1 .\n\n# \u5907\u4efd\u955c\u50cf\ndocker save -o backend.tar backend:1.0.1\n\n# \u5c06\u6587\u4ef6\u4e0a\u4f20\u5230\u670d\u52a1\u5668\nscp D:/backend/backend.tar root@192.168.0.22:/data/local/services/\n\n# \u4fee\u6539\u65e7\u7248\u672c\u7684tag\ndocker tag backend:latest backend:1.0.0\n\n# \u52a0\u8f7d\u955c\u50cf\ndocker load -i backend.tar\n\n# \u4fee\u6539\u65b0\u7248\u672c\u7684tag\ndocker tag backend:1.0.1 backend:latest\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e5d\u5b89\u88c5\u95ee\u9898",children:"\u4e5d\u3001\u5b89\u88c5\u95ee\u9898"}),"\n",(0,r.jsx)(n.h3,{id:"1k8s\u62c9\u53d6\u955c\u50cf\u62a5\u9519",children:"1\u3001k8s\u62c9\u53d6\u955c\u50cf\u62a5\u9519"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"imagePullBackOff"}),"  ",(0,r.jsx)(n.code,{children:"http: server gave HTTP response to HTTPS client"})]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.rke2.io/zh/install/containerd_registry_configuration",children:"RKE2"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'cat > /etc/rancher/rke2/registries.yaml << EOF\nmirrors:\n  "192.168.0.22:5000":\n    endpoint:\n      - "http://192.168.0.22:5000"\n  docker.io:\n    endpoint:\n      - "http://192.168.0.22:5000"\nEOF\n\n# \u4fee\u6539\u5b8c\u6210\u540e\u91cd\u542f RKE2\nsystemctl daemon-reload && systemctl restart rke2-server\nsystemctl daemon-reload && systemctl restart rke2-agent\n'})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/containerd/containerd/issues/3847",children:"Containerd"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/containerd/cri/blob/master/docs/registry.md#configure-registry-endpoint",children:"Containerd"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'cat > /etc/containerd/config.toml  << EOF\n[plugins]\n    [plugins."io.containerd.grpc.v1.cri"]\n        [plugins."io.containerd.grpc.v1.cri".registry]\n            [plugins."io.containerd.grpc.v1.cri".registry.mirrors]\n                [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]\n                    endpoint = ["https://registry-1.docker.io"]\n                [plugins."io.containerd.grpc.v1.cri".registry.mirrors."harbor.io"]\n                    endpoint = ["https://xxx-harbor.com:7443"]\n                [plugins."io.containerd.grpc.v1.cri".registry.mirrors."192.168.0.22:5000"]\n                    endpoint = ["https://192.168.0.22:5000"]\n            [plugins."io.containerd.grpc.v1.cri".registry.configs]\n                [plugins."io.containerd.grpc.v1.cri".registry.configs."harbor.io"]\n                [plugins."io.containerd.grpc.v1.cri".registry.configs."harbor.io".tls]\n                    insecure_skip_verify = true\n                [plugins."io.containerd.grpc.v1.cri".registry.configs."harbor.io".auth]\n                    username = "admin"\n                    password = "Harbor12345"\n                [plugins."io.containerd.grpc.v1.cri".registry.configs."192.168.0.22:5000".tls]\n                    insecure_skip_verify = true\nEOF\n\n# \u4fee\u6539\u5b8c\u6210\u540e\u91cd\u542f Containerd\nsystemctl daemon-reload && systemctl restart containerd\n'})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.docker.com/registry/insecure/",children:"Docker"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'cat > /etc/docker/daemon.json << EOF\n{ \n    "insecure-registries":["192.168.0.22:5000"]\n}\nEOF\n\n# \u4fee\u6539\u5b8c\u6210\u540e\u91cd\u542f Docker\nsystemctl daemon-reload && systemctl restart docker\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.ah)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},11151:(e,n,s)=>{s.d(n,{ah:()=>i});var r=s(67294);const t=r.createContext({});function i(e){const n=r.useContext(t);return r.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}}}]);