"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[6796],{3905:(n,e,t)=>{t.d(e,{Zo:()=>u,kt:()=>h});var a=t(67294);function r(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function o(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,a)}return t}function i(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){r(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function c(n,e){if(null==n)return{};var t,a,r=function(n,e){if(null==n)return{};var t,a,r={},o=Object.keys(n);for(a=0;a<o.length;a++)t=o[a],e.indexOf(t)>=0||(r[t]=n[t]);return r}(n,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);for(a=0;a<o.length;a++)t=o[a],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(r[t]=n[t])}return r}var l=a.createContext({}),s=function(n){var e=a.useContext(l),t=e;return n&&(t="function"==typeof n?n(e):i(i({},e),n)),t},u=function(n){var e=s(n.components);return a.createElement(l.Provider,{value:e},n.children)},p="mdxType",d={inlineCode:"code",wrapper:function(n){var e=n.children;return a.createElement(a.Fragment,{},e)}},m=a.forwardRef((function(n,e){var t=n.components,r=n.mdxType,o=n.originalType,l=n.parentName,u=c(n,["components","mdxType","originalType","parentName"]),p=s(t),m=r,h=p["".concat(l,".").concat(m)]||p[m]||d[m]||o;return t?a.createElement(h,i(i({ref:e},u),{},{components:t})):a.createElement(h,i({ref:e},u))}));function h(n,e){var t=arguments,r=e&&e.mdxType;if("string"==typeof n||r){var o=t.length,i=new Array(o);i[0]=m;var c={};for(var l in e)hasOwnProperty.call(e,l)&&(c[l]=e[l]);c.originalType=n,c[p]="string"==typeof n?n:r,i[1]=c;for(var s=2;s<o;s++)i[s]=t[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},82922:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>c,toc:()=>s});var a=t(87462),r=(t(67294),t(3905));const o={},i=void 0,c={unversionedId:"zh-cn/spring-boot/Multi-Thread-Transaction",id:"zh-cn/spring-boot/Multi-Thread-Transaction",title:"Multi-Thread-Transaction",description:"- CompletableFuture\u8fdb\u9636\u7bc7-\u5916\u5356\u5546\u5bb6\u7aefAPI\u7684\u5f02\u6b65\u5316",source:"@site/docs/zh-cn/spring-boot/4-Multi-Thread-Transaction.md",sourceDirName:"zh-cn/spring-boot",slug:"/zh-cn/spring-boot/Multi-Thread-Transaction",permalink:"/light-docusaurus/docs/zh-cn/spring-boot/Multi-Thread-Transaction",draft:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/docs/zh-cn/spring-boot/4-Multi-Thread-Transaction.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"troch",previous:{title:"Common-Async-Data-Handle",permalink:"/light-docusaurus/docs/zh-cn/spring-boot/Common-Async-Data-Handle"},next:{title:"Obfuscate-Spring-Boot-Application-With-Classfinal",permalink:"/light-docusaurus/docs/zh-cn/spring-boot/Obfuscate-Spring-Boot-Application-With-Classfinal"}},l={},s=[{value:"\u95ee\u9898\u518d\u73b0",id:"\u95ee\u9898\u518d\u73b0",level:2},{value:"\u5982\u4f55\u89e3\u51b3\u5f02\u6b65\u6267\u884c",id:"\u5982\u4f55\u89e3\u51b3\u5f02\u6b65\u6267\u884c",level:2},{value:"\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u5982\u4f55\u786e\u4fdd\u4e8b\u52a1\u4e00\u81f4\u6027",id:"\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u5982\u4f55\u786e\u4fdd\u4e8b\u52a1\u4e00\u81f4\u6027",level:2},{value:"\u4e8b\u52a1\u738b\u56fd\u56de\u987e",id:"\u4e8b\u52a1\u738b\u56fd\u56de\u987e",level:2},{value:"\u4e8b\u52a1\u5b9e\u73b0\u65b9\u5f0f\u56de\u987e",id:"\u4e8b\u52a1\u5b9e\u73b0\u65b9\u5f0f\u56de\u987e",level:2},{value:"\u7f16\u7a0b\u5f0f\u4e8b\u52a1",id:"\u7f16\u7a0b\u5f0f\u4e8b\u52a1",level:2},{value:"\u5229\u7528\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u89e3\u51b3\u95ee\u9898",id:"\u5229\u7528\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u89e3\u51b3\u95ee\u9898",level:2},{value:"\u95ee\u9898\u5206\u6790\u5b8c\u4e86\uff0c\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u95ee\u9898\u5462\uff1f",id:"\u95ee\u9898\u5206\u6790\u5b8c\u4e86\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u95ee\u9898\u5462",level:2},{value:"\u8865\u5145\u8bf4\u660e",id:"\u8865\u5145\u8bf4\u660e",level:2},{value:"\u4e8b\u52a1\u521d\u6b21\u5f00\u542f\u65f6\uff1a",id:"\u4e8b\u52a1\u521d\u6b21\u5f00\u542f\u65f6",level:3},{value:"\u4e8b\u52a1\u5269\u4f59\u6267\u884c\u8fc7\u7a0b\u4e2d\u83b7\u53d6\u8fde\u63a5:",id:"\u4e8b\u52a1\u5269\u4f59\u6267\u884c\u8fc7\u7a0b\u4e2d\u83b7\u53d6\u8fde\u63a5",level:2},{value:"\u5176\u5b9e\u6211\u4eec\u672c\u6587\u7ed9\u51fa\u7684copy\u4e8b\u52a1\u8d44\u6e90\u7684\u65b9\u6848\u548c\u4e0a\u9762\u51fa\u73b0\u7684suspend\u6302\u8d77\u5f53\u524d\u4e8b\u52a1\u548cresume\u6062\u590d\u5f53\u524d\u4e8b\u52a1\u7684\u601d\u60f3\u662f\u4e00\u81f4\u7684:",id:"\u5176\u5b9e\u6211\u4eec\u672c\u6587\u7ed9\u51fa\u7684copy\u4e8b\u52a1\u8d44\u6e90\u7684\u65b9\u6848\u548c\u4e0a\u9762\u51fa\u73b0\u7684suspend\u6302\u8d77\u5f53\u524d\u4e8b\u52a1\u548cresume\u6062\u590d\u5f53\u524d\u4e8b\u52a1\u7684\u601d\u60f3\u662f\u4e00\u81f4\u7684",level:2},{value:"1. \u6302\u8d77\u5f53\u524d\u4e8b\u52a1",id:"1-\u6302\u8d77\u5f53\u524d\u4e8b\u52a1",level:3},{value:"2. \u6062\u590d\u88ab\u6302\u8d77\u7684\u4e8b\u52a1",id:"2-\u6062\u590d\u88ab\u6302\u8d77\u7684\u4e8b\u52a1",level:3},{value:"\u7591\u95ee\u89e3\u7b54",id:"\u7591\u95ee\u89e3\u7b54",level:2},{value:"newTransaction \u548c newSynchronization \u6807\u8bb0\u7684\u8054\u7cfb",id:"newtransaction-\u548c-newsynchronization-\u6807\u8bb0\u7684\u8054\u7cfb",level:2},{value:"\u8fde\u63a5\u662f\u5426\u4f1a\u88ab\u91ca\u653e\uff0c\u662f\u5426\u5f71\u54cd\u4e3b\u7ebf\u7a0b\u4e8b\u52a1\u5c5e\u6027",id:"\u8fde\u63a5\u662f\u5426\u4f1a\u88ab\u91ca\u653e\u662f\u5426\u5f71\u54cd\u4e3b\u7ebf\u7a0b\u4e8b\u52a1\u5c5e\u6027",level:2},{value:"\u7b2c\u4e00\u4e2a\u95ee\u9898: \u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u662f\u5426\u4f1a\u91ca\u653e\u8fde\u63a5",id:"\u7b2c\u4e00\u4e2a\u95ee\u9898-\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u662f\u5426\u4f1a\u91ca\u653e\u8fde\u63a5",level:3},{value:"\u95ee\u9898\u4e8c: MultiplyThreadTransactionManager\u901a\u8fc7\u5f00\u8f9f\u5b50\u7ebf\u7a0b\u4f9d\u6b21\u6267\u884c\u5404\u4e2a\u5b50\u4efb\u52a1\uff0c\u6700\u540e\u5728\u6240\u6709\u5b50\u4efb\u52a1",id:"\u95ee\u9898\u4e8c-multiplythreadtransactionmanager\u901a\u8fc7\u5f00\u8f9f\u5b50\u7ebf\u7a0b\u4f9d\u6b21\u6267\u884c\u5404\u4e2a\u5b50\u4efb\u52a1\u6700\u540e\u5728\u6240\u6709\u5b50\u4efb\u52a1",level:3},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3",level:2}],u={toc:s},p="wrapper";function d(n){let{components:e,...t}=n;return(0,r.kt)(p,(0,a.Z)({},u,t,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.csdn.net/m0_53157173/article/details/127344842"},"CompletableFuture\u8fdb\u9636\u7bc7-\u5916\u5356\u5546\u5bb6\u7aefAPI\u7684\u5f02\u6b65\u5316")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.csdn.net/m0_53157173/article/details/127423286"},"Spring \u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u5982\u4f55\u786e\u4fdd\u4e8b\u52a1\u4e00\u81f4\u6027?")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://mp.weixin.qq.com/s/7NcyE4V1kXIIwOK8t6aJLg"},"Spring \u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u5982\u4f55\u786e\u4fdd\u4e8b\u52a1\u4e00\u81f4\u6027?"))),(0,r.kt)("h2",{id:"\u95ee\u9898\u518d\u73b0"},"\u95ee\u9898\u518d\u73b0"),(0,r.kt)("p",null,"\u6211\u5148\u628a\u95ee\u9898\u629b\u51fa\u6765\uff0c\u5927\u5bb6\u5c31\u660e\u767d\u672c\u6587\u76ee\u7684\u5728\u4e8e\u89e3\u51b3\u4ec0\u4e48\u6837\u7684\u4e1a\u52a1\u75db\u70b9\u4e86:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public void removeAuthorityModuleSeq(Integer authorityModuleId, IAuthorityService iAuthorityService, IRoleAuthorityService iRoleAuthorityService) {\n    //1.\u67e5\u8be2\u51fa\u5f53\u524d\u8d44\u6e90\u6a21\u5757\u4e0b\u6240\u6709\u8d44\u6e90,\u67e5\u8be2\u51fa\u6765\u540e\u8fdb\u884c\u5220\u9664\n    deleteAuthoritiesOfCurrentAuthorityModule(authorityModuleId, iAuthorityService, iRoleAuthorityService);\n    //2.\u67e5\u8be2\u51fa\u5f53\u524d\u8d44\u6e90\u6a21\u5757\u4e0b\u6240\u6709\u5b50\u6a21\u5757,\u9012\u5f52\u67e5\u8be2,\u5f53\u5220\u9664\u5b8c\u6240\u6709\u5b50\u6a21\u5757\u4e0b\u7684\u8d44\u6e90\u540e,\u518d\u5220\u9664\u6240\u6709\u5b50\u6a21\u5757,\u6700\u7ec8\u5220\u9664\u5f53\u524d\u8d44\u6e90\u6a21\u5757\n    deleteSonAuthorityModuleUnderCurrentAuthorityModule(authorityModuleId, iAuthorityService, iRoleAuthorityService);\n    //3.\u5220\u9664\u5f53\u524d\u8d44\u6e90\u6a21\u5757\n    removeById(authorityModuleId);\n}\n")),(0,r.kt)("p",null,"\u5982\u679c\u6211\u5e0c\u671b\u5c06\u6b65\u9aa41\u548c\u6b65\u9aa42\u5e76\u884c\u6267\u884c\uff0c\u7136\u540e\u786e\u4fdd\u6b65\u9aa41\u548c\u6b65\u9aa42\u6267\u884c\u6210\u529f\u540e\uff0c\u518d\u6267\u884c\u6b65\u9aa43\uff0c\u7b49\u5230\u6b65\u9aa43\u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u518d\u63d0\u4ea4\u5168\u90e8\u4e8b\u52a1\uff0c\u8fd9\u4e2a\u9700\u6c42\u8be5\u5982\u4f55\u5b9e\u73b0\u5462\uff1f"),(0,r.kt)("h2",{id:"\u5982\u4f55\u89e3\u51b3\u5f02\u6b65\u6267\u884c"},"\u5982\u4f55\u89e3\u51b3\u5f02\u6b65\u6267\u884c"),(0,r.kt)("p",null,"\u4e0a\u9762\u9700\u6c42\u7b2c\u4e00\u70b9\u662f: \u5982\u4f55\u8ba9\u4efb\u52a1\u5f02\u6b65\u5e76\u884c\u6267\u884c,\u5982\u4f55\u5b9e\u73b0\u4e8c\u5143\u4f9d\u8d56\u5462\uff1f"),(0,r.kt)("p",null,"\u8bf4\u5230\u5f02\u6b65\u6267\u884c\uff0c\u5f88\u591a\u5c0f\u4f19\u4f34\u9996\u5148\u60f3\u5230Spring\u4e2d\u63d0\u4f9b\u7684@Async\u6ce8\u89e3\uff0c\u4f46\u662fSpring\u63d0\u4f9b\u7684\u5f02\u6b65\u6267\u884c\u4efb\u52a1\u80fd\u529b\u5e76\u4e0d\u8db3\u4ee5\u89e3\u51b3\u6211\u4eec\u5f53\u524d\u7684\u9700\u6c42\u3002\n",(0,r.kt)("a",{parentName:"p",href:"https://cjdhy.blog.csdn.net/article/details/126909860"},"Spring\u5f02\u6b65\u6838\u5fc3@Async\u6ce8\u89e3\u7684\u524d\u4e16\u4eca\u751f")),(0,r.kt)("p",null,"@Async\u6ce8\u89e3\u539f\u7406\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u626b\u63cfIOC\u4e2d\u7684bean,\u7ed9\u65b9\u6cd5\u4e0a\u6807\u6ce8\u6709@Async\u6ce8\u89e3\u7684bean\u8fdb\u884c\u4ee3\u7406\uff0c\u4ee3\u7406\u7684\u6838\u5fc3\u662f\u6dfb\u52a0\u4e00\u4e2aMethodInterceptor\u5373AsyncExecutionInterceptor\uff0c\u8be5\u65b9\u6cd5\u62e6\u622a\u5668\u8d1f\u8d23\u5c06\u65b9\u6cd5\u771f\u6b63\u7684\u6267\u884c\u5305\u88c5\u4e3a\u4efb\u52a1\uff0c\u653e\u5165\u7ebf\u7a0b\u6c60\u4e2d\u6267\u884c\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cjdhy.blog.csdn.net/article/details/127381665"},"CompletableFuture\u5165\u95e8")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.csdn.net/m0_53157173/article/details/127344842"},"CompletableFuture\u8fdb\u9636\u7bc7-\u5916\u5356\u5546\u5bb6\u7aefAPI\u7684\u5f02\u6b65\u5316")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cjdhy.blog.csdn.net/article/details/127343965"},"CompletableFuture\u5165\u95e8\u7bc7"))),(0,r.kt)("p",null,"\u4e0b\u9762\u6211\u4eec\u5148\u4f7f\u7528CompletableFuture\u6765\u5b8c\u6210\u6211\u4eec\u7b2c\u4e00\u6b65\u9700\u6c42:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public void removeAuthorityModuleSeq(Integer authorityModuleId, IAuthorityService iAuthorityService, IRoleAuthorityService iRoleAuthorityService) {\n    CompletableFuture.runAsync(()->{\n        //\u4e24\u4e2a\u5e76\u884c\u6267\u884c\u7684\u4efb\u52a1\n        CompletableFuture<Void> future1 = CompletableFuture.runAsync(() ->\n                deleteAuthoritiesOfCurrentAuthorityModule(authorityModuleId, iAuthorityService, iRoleAuthorityService),executor);\n        CompletableFuture<Void> future2 = CompletableFuture.runAsync(() ->\n                deleteSonAuthorityModuleUnderCurrentAuthorityModule(authorityModuleId, iAuthorityService, iRoleAuthorityService), executor);\n        //\u7b49\u5f85\u4e24\u4e2a\u5e76\u884c\u4efb\u52a1\u6267\u884c\u5b8c\u540e,\u518d\u6267\u884c\u6700\u540e\u4e00\u4e2a\u6b65\u9aa4\n        CompletableFuture.allOf(future1,future2).thenRun(()->removeById(authorityModuleId)); \n    },executor);\n}\n")),(0,r.kt)("h2",{id:"\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u5982\u4f55\u786e\u4fdd\u4e8b\u52a1\u4e00\u81f4\u6027"},"\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u5982\u4f55\u786e\u4fdd\u4e8b\u52a1\u4e00\u81f4\u6027"),(0,r.kt)("p",null,"\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86\u4efb\u52a1\u7684\u5f02\u6b65\u6267\u884c\u5316\uff0c\u90a3\u4e48\u53c8\u5982\u4f55\u786e\u4fdd\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u7684\u4e8b\u52a1\u4e00\u81f4\u6027\u95ee\u9898\u5462\uff1f"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public void removeAuthorityModuleSeq(Integer authorityModuleId, IAuthorityService iAuthorityService, IRoleAuthorityService iRoleAuthorityService) {\n    CompletableFuture.runAsync(()->{\n        //\u4e24\u4e2a\u5e76\u884c\u6267\u884c\u7684\u4efb\u52a1\n        CompletableFuture<Void> future1 = CompletableFuture.runAsync(() ->\n                deleteAuthoritiesOfCurrentAuthorityModule(authorityModuleId, iAuthorityService, iRoleAuthorityService),executor);\n        CompletableFuture<Void> future2 = CompletableFuture.runAsync(() ->\n                deleteSonAuthorityModuleUnderCurrentAuthorityModule(authorityModuleId, iAuthorityService, iRoleAuthorityService), executor);\n        //\u7b49\u5f85\u4e24\u4e2a\u5e76\u884c\u4efb\u52a1\u6267\u884c\u5b8c\u540e,\u518d\u6267\u884c\u6700\u540e\u4e00\u4e2a\u6b65\u9aa4\n        CompletableFuture.allOf(future1,future2).thenRun(()->removeById(authorityModuleId));\n    },executor);\n}\n")),(0,r.kt)("p",null,"\u5728Spring\u73af\u5883\u4e0b\u8bf4\u5230\u4e8b\u52a1\u63a7\u5236\uff0c\u5927\u5bb6\u7b2c\u4e00\u53cd\u5e94\u5c31\u60f3\u5230\u4f7f\u7528@Transactional\u6ce8\u89e3\u89e3\u51b3\u95ee\u9898\uff0c\u4f46\u662f\u8fd9\u91cc\u663e\u7136\u884c\u4e0d\u901a\uff0c\u4e3a\u4ec0\u4e48\u884c\u4e0d\u901a\u5462\uff1f"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.csdn.net/m0_53157173/article/details/125052623"},"\u4e8b\u52a1\u738b\u56fd\u56de\u987e")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cjdhy.blog.csdn.net/article/details/125130078"},"Spring\u4e8b\u52a1\u7ba1\u7406-\u4e0a")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cjdhy.blog.csdn.net/article/details/125196276"},"Spring\u4e8b\u52a1\u7ba1\u7406-\u4e2d")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cjdhy.blog.csdn.net/article/details/125223905"},"Spring\u4e8b\u52a1\u7ba1\u7406-\u4e0b")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cjdhy.blog.csdn.net/article/details/125232126"},"Spring\u4e8b\u52a1\u6269\u5c55\u7bc7"))),(0,r.kt)("p",null,"\u6211\u8fd8\u662f\u7b80\u5355\u7684\u5bf9Spring\u4e8b\u52a1\u5b9e\u73b0\u539f\u7406\u8fdb\u884c\u4e00\u756a\u6982\u62ec:"),(0,r.kt)("h2",{id:"\u4e8b\u52a1\u738b\u56fd\u56de\u987e"},"\u4e8b\u52a1\u738b\u56fd\u56de\u987e"),(0,r.kt)("p",null,"\u4e8b\u52a1\u7ba1\u7406\u5927\u4f53\u5206\u4e3a\u4e09\u4e2a\u6d41\u7a0b\uff1a\u4e8b\u52a1\u521b\u5efa ,\u4e8b\u52a1\u6267\u884c,\u4e8b\u52a1\u7ed3\u675f"),(0,r.kt)("p",null,"\u4e8b\u52a1\u521b\u5efa\u6d89\u53ca\u5230\u4e00\u4e9b\u5c5e\u6027\u7684\u914d\u7f6e,\u5982:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b"),(0,r.kt)("li",{parentName:"ul"},"\u4e8b\u52a1\u7684\u4f20\u64ad\u884c\u4e3a"),(0,r.kt)("li",{parentName:"ul"},"\u4e8b\u52a1\u7684\u8d85\u65f6\u65f6\u95f4"),(0,r.kt)("li",{parentName:"ul"},"\u662f\u5426\u4e3a\u53ea\u8bfb\u4e8b\u52a1"),(0,r.kt)("li",{parentName:"ul"},"\u2026")),(0,r.kt)("p",null,"\u7531\u4e8e\u6d89\u53ca\u5c5e\u6027\u9887\u591a\uff0c\u5e76\u4e14\u540e\u671f\u8fd8\u6709\u53ef\u80fd\u8fdb\u884c\u6269\u5c55\uff0c\u56e0\u6b64\u5fc5\u987b\u901a\u8fc7\u4e00\u4e2a\u7c7b\u6765\u5c01\u88c5\u8fd9\u4e9b\u5c5e\u6027\uff0c\u5728Spring\u4e2d\u5bf9\u5e94TransactionDefinition\u3002"),(0,r.kt)("p",null,"\u6709\u4e86\u4e8b\u52a1\u76f8\u5173\u5c5e\u6027\u5b9a\u4e49\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528TransactionDefinition\u6765\u521b\u5efa\u4e00\u4e2a\u4e8b\u52a1\u4e86,\u5728Spring\u4e2d\u5c40\u90e8\u4e8b\u52a1\u7531PlatformTransactionManager\u8d1f\u8d23\u7ba1\u7406\uff0c\u521b\u5efa\u4e8b\u52a1\u4e5f\u662f\u7531PlatformTransactionManager\u8d1f\u8d23\u63d0\u4f9b:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException;\n")),(0,r.kt)("p",null,"\u5982\u679c\u6211\u4eec\u5e0c\u671b\u8ffd\u8e2a\u4e8b\u52a1\u7684\u72b6\u6001\uff0c\u4f8b\u5982: \u4e8b\u52a1\u5df2\u5b8c\u6210,\u4e8b\u52a1\u56de\u6eda\u7b49\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u4e00\u4e2a\u4e8b\u52a1\u72b6\u6001\u7c7b\u8d2f\u7a7f\u5f53\u524d\u4e8b\u52a1\u7684\u6267\u884c\u6d41\u7a0b\uff0c\u5728Spring\u4e2d\u7531 ",(0,r.kt)("inlineCode",{parentName:"p"},"TransactionStatus")," \u8d1f\u8d23\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"\u5bf9\u4e8e\u5e38\u89c1\u7684\u6570\u636e\u6e90\u800c\u8a00\uff0c\u901a\u5e38\u9700\u8981\u8bb0\u5f55\u7684\u4e8b\u52a1\u72b6\u6001\u6709\u5982\u4e0b\u51e0\u70b9:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u662f\u65b0\u4e8b\u52a1"),(0,r.kt)("li",{parentName:"ul"},"\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u7ed3\u675f"),(0,r.kt)("li",{parentName:"ul"},"\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u9700\u8981\u56de\u6eda(\u901a\u8fc7\u6807\u8bb0\u6765\u5224\u65ad,\u56e0\u6b64\u6211\u4e5f\u53ef\u4ee5\u5728\u4e1a\u52a1\u6d41\u7a0b\u4e2d\u624b\u52a8\u8bbe\u7f6e\u6807\u8bb0\u4e3atrue,\u6765\u8ba9\u4e8b\u52a1\u5728\u6ca1\u6709\u53d1\u751f\u5f02\u5e38\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u56de\u6eda)"),(0,r.kt)("li",{parentName:"ul"},"\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u8bbe\u7f6e\u4e86\u56de\u6eda\u70b9(savePoint)")),(0,r.kt)("p",null,"\u4e8b\u52a1\u7684\u6267\u884c\u8fc7\u7a0b\u5c31\u662f\u5177\u4f53\u4e1a\u52a1\u4ee3\u7801\u7684\u6267\u884c\u6d41\u7a0b\uff0c\u8fd9\u91cc\u5c31\u4e0d\u591a\u8bf4\u4e86\u3002"),(0,r.kt)("p",null,"\u4e8b\u52a1\u7684\u7ed3\u675f\u5206\u4e3a\u4e24\u79cd\u60c5\u51b5: \u9700\u8981\u8fdb\u884c\u4e8b\u52a1\u56de\u6eda\u6216\u8005\u4e8b\u52a1\u6b63\u5e38\u63d0\u4ea4\uff0c\u5982\u679c\u662f\u4e8b\u52a1\u56de\u6eda\uff0c\u8fd8\u9700\u8981\u5224\u65ad ",(0,r.kt)("inlineCode",{parentName:"p"},"TransactionStatus")," \u4e2d\u7684savePoint\u662f\u5426\u88ab\u8bbe\u7f6e\u4e86\u3002"),(0,r.kt)("h2",{id:"\u4e8b\u52a1\u5b9e\u73b0\u65b9\u5f0f\u56de\u987e"},"\u4e8b\u52a1\u5b9e\u73b0\u65b9\u5f0f\u56de\u987e"),(0,r.kt)("p",null,"Spring\u4e2d\u5e38\u89c1\u7684\u4e8b\u52a1\u5b9e\u73b0\u65b9\u5f0f\u6709\u4e24\u79cd: \u7f16\u7a0b\u5f0f\u548c\u58f0\u660e\u5f0f\u3002"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u4f7f\u7528\u662f\u672c\u6587\u91cd\u70b9\uff0c\u56e0\u6b64\u8fd9\u91cc\u6309\u4e0b\u4e0d\u8868\uff0c\u6211\u4eec\u5148\u6765\u590d\u4e60\u4e00\u4e0b\u58f0\u660e\u5f0f\u4e8b\u52a1\u7684\u4f7f\u7528")),(0,r.kt)("p",null,"\u58f0\u660e\u5f0f\u4e8b\u52a1\u5c31\u662f\u4f7f\u7528\u6211\u4eec\u5e38\u89c1\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"@Transactional"),"\u6ce8\u89e3\u5b8c\u6210\u7684\uff0c\u58f0\u660e\u5f0f\u4e8b\u52a1\u4f18\u70b9\u5c31\u5728\u4e8e\u8ba9\u4e8b\u52a1\u4ee3\u7801\u4e0e\u4e1a\u52a1\u4ee3\u7801\u89e3\u8026\uff0c\u901a\u8fc7Spring\u4e2d\u63d0\u4f9b\u7684\u58f0\u660e\u5f0f\u4e8b\u52a1\u4f7f\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u53d1\u89c9\u6211\u4eec\u53ea\u9700\u8981\u7f16\u5199\u4e1a\u52a1\u4ee3\u7801\u5373\u53ef\uff0c\u800c\u4e8b\u52a1\u7684\u7ba1\u7406\u57fa\u672c\u4e0d\u9700\u8981\u6211\u4eec\u64cd\u5fc3\uff0cSpring\u5c31\u50cf\u4f7f\u7528\u4e86\u9b54\u6cd5\u4e00\u6837\uff0c\u5e2e\u6211\u4eec\u81ea\u52a8\u5b8c\u6210\u4e86\u3002"),(0,r.kt)("p",null,"\u4e4b\u6240\u4ee5\u90a3\u4e48\u795e\u5947\uff0c\u672c\u8d28\u8fd8\u662f\u4f9d\u9760Spring\u6846\u67b6\u63d0\u4f9b\u7684Bean\u751f\u547d\u5468\u671f\u76f8\u5173\u56de\u8c03\u63a5\u53e3\u548cAOP\u7ed3\u5408\u5b8c\u6210\u7684\uff0c\u7b80\u8ff0\u5982\u4e0b:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u901a\u8fc7\u81ea\u52a8\u4ee3\u7406\u521b\u5efa\u5668\u4f9d\u6b21\u5c1d\u8bd5\u4e3a\u6bcf\u4e2a\u653e\u5165\u5bb9\u5668\u4e2d\u7684bean\u5c1d\u8bd5\u8fdb\u884c\u4ee3\u7406"),(0,r.kt)("li",{parentName:"ul"},"\u5c1d\u8bd5\u8fdb\u884c\u4ee3\u7406\u7684\u8fc7\u7a0b\u5bf9\u4e8e\u4e8b\u52a1\u7ba1\u7406\u6765\u8bf4\uff0c\u5c31\u662f\u5229\u7528\u4e8b\u52a1\u7ba1\u7406\u6d89\u53ca\u5230\u7684\u589e\u5f3a\u5668advisor\uff0c\u5373TransactionAttributeSourceAdvisor"),(0,r.kt)("li",{parentName:"ul"},"\u5224\u65ad\u5f53\u524d\u589e\u5f3a\u5668\u662f\u5426\u80fd\u591f\u5e94\u7528\u4e0e\u5f53\u524dbean\u4e0a\uff0c\u600e\u4e48\u5224\u65ad\u5462\uff1f\u2014> advisor\u5185\u90e8\u7684pointCut\u55bd \uff01"),(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c\u80fd\u591f\u5e94\u7528\uff0c\u90a3\u4e48\u597d\uff0c\u4e3a\u5f53\u524dbean\u521b\u5efa\u4ee3\u7406\u5bf9\u8c61\u8fd4\u56de\uff0c\u5e76\u4e14\u5f80\u4ee3\u7406\u5bf9\u8c61\u5185\u90e8\u6dfb\u52a0\u4e00\u4e2aTransactionInterceptor\u62e6\u622a\u5668\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u6b64\u65f6\u6211\u4eec\u518d\u4ece\u5bb9\u5668\u4e2d\u83b7\u53d6\uff0c\u62ff\u5230\u7684\u5c31\u662f\u4ee3\u7406\u5bf9\u8c61\u4e86\uff0c\u5f53\u6211\u4eec\u8c03\u7528\u4ee3\u7406\u5bf9\u8c61\u7684\u65b9\u6cd5\u65f6\uff0c\u9996\u5148\u8981\u7ecf\u8fc7\u4ee3\u7406\u5bf9\u8c61\u5185\u90e8\u62e6\u622a\u5668\u94fe\u7684\u5904\u7406\uff0c\u5904\u7406\u5b8c\u540e\uff0c\u6700\u7ec8\u624d\u4f1a\u8c03\u7528\u88ab\u4ee3\u7406\u5bf9\u8c61\u7684\u65b9\u6cd5\u3002(\u8fd9\u91cc\u5176\u5b9e\u5c31\u662f\u8d23\u4efb\u94fe\u6a21\u5f0f\u7684\u5e94\u7528)")),(0,r.kt)("p",null,"\u5bf9\u4e8e\u88ab\u4e8b\u52a1\u589e\u5f3a\u5668TransactionAttributeSourceAdvisor\u4ee3\u7406\u7684bean\u800c\u8a00\uff0c\u4ee3\u7406\u5bf9\u8c61\u5185\u90e8\u4f1a\u5b58\u5728\u4e00\u4e2aTransactionInterceptor\uff0c\u8be5\u62e6\u622a\u5668\u5185\u90e8\u6784\u9020\u4e86\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u7684\u6a21\u677f\u6d41\u7a0b:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"protected Object invokeWithinTransaction(Method method, @Nullable Class<?> targetClass,\n   final InvocationCallback invocation) throws Throwable {\n  //TransactionAttributeSource\u5185\u90e8\u4fdd\u5b58\u7740\u5f53\u524d\u7c7b\u67d0\u4e2a\u65b9\u6cd5\u5bf9\u5e94\u7684TransactionAttribute---\u4e8b\u52a1\u5c5e\u6027\u6e90\n  //\u53ef\u4ee5\u770b\u505a\u662f\u4e00\u4e2a\u5b58\u653eTransactionAttribute\u4e0emethod\u65b9\u6cd5\u6620\u5c04\u7684\u6c60\u5b50\n  TransactionAttributeSource tas = getTransactionAttributeSource();\n  //\u83b7\u53d6\u5f53\u524d\u4e8b\u52a1\u65b9\u6cd5\u5bf9\u5e94\u7684TransactionAttribute\n  final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null);\n  //\u5b9a\u4f4dTransactionManager\n  final TransactionManager tm = determineTransactionManager(txAttr);\n        .....\n        //\u7c7b\u578b\u8f6c\u6362\u4e3a\u5c40\u90e8\u4e8b\u52a1\u7ba1\u7406\u5668\n  PlatformTransactionManager ptm = asPlatformTransactionManager(tm);\n  final String joinpointIdentification = methodIdentification(method, targetClass, txAttr);\n\n  if (txAttr == null || !(ptm instanceof CallbackPreferringPlatformTransactionManager)) {\n   //TransactionManager\u6839\u636eTransactionAttribute\u521b\u5efa\u4e8b\u52a1\u540e\u8fd4\u56de\n   //TransactionInfo\u5c01\u88c5\u4e86\u5f53\u524d\u4e8b\u52a1\u7684\u4fe1\u606f--\u5305\u62ecTransactionStatus\n   TransactionInfo txInfo = createTransactionIfNecessary(ptm, txAttr, joinpointIdentification);\n\n   Object retVal;\n   try {\n    //\u7ee7\u7eed\u6267\u884c\u8fc7\u6ee4\u5668\u94fe---\u8fc7\u6ee4\u94fe\u6700\u7ec8\u4f1a\u8c03\u7528\u76ee\u6807\u65b9\u6cd5\n    //\u56e0\u6b64\u53ef\u4ee5\u7406\u89e3\u4e3a\u8fd9\u91cc\u662f\u8c03\u7528\u76ee\u6807\u65b9\u6cd5\n    retVal = invocation.proceedWithInvocation();\n   }\n   catch (Throwable ex) {\n    //\u76ee\u6807\u65b9\u6cd5\u629b\u51fa\u5f02\u5e38\u5219\u8fdb\u884c\u5224\u65ad\u662f\u5426\u9700\u8981\u56de\u6eda\n    completeTransactionAfterThrowing(txInfo, ex);\n    throw ex;\n   }\n   finally {\n       //\u6e05\u9664\u5f53\u524d\u4e8b\u52a1\u4fe1\u606f\n    cleanupTransactionInfo(txInfo);\n   }\n            ...\n            //\u6b63\u5e38\u8fd4\u56de,\u90a3\u4e48\u5c31\u6b63\u5e38\u63d0\u4ea4\u4e8b\u52a1\u5457(\u5f53\u7136\u8fd8\u662f\u9700\u8981\u5224\u65adTransactionStatus\u72b6\u6001\u5148)\n   commitTransactionAfterReturning(txInfo);\n   return retVal;\n  }\n  ...\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://blog.csdn.net/m0_53157173/category_11342343.html"},"Spring\u6e90\u7801\u7814\u8bfb")),(0,r.kt)("h2",{id:"\u7f16\u7a0b\u5f0f\u4e8b\u52a1"},"\u7f16\u7a0b\u5f0f\u4e8b\u52a1"),(0,r.kt)("p",null,"\u8fd8\u8bb0\u5f97\u672c\u6587\u4e00\u5f00\u59cb\u63d0\u51fa\u7684\u4e1a\u52a1\u9700\u6c42\u5417\uff1f"),(0,r.kt)("p",null,"\u4e0d\u6e05\u695a\uff0c\u53ef\u4ee5\u56de\u770b\u4e00\u4e0b\uff0c\u5728\u4e0a\u6587\uff0c\u6211\u4eec\u5df2\u7ecf\u89e3\u51b3\u4e86\u4efb\u52a1\u5f02\u6b65\u5e76\u884c\u6267\u884c\u7684\u96be\u9898\uff0c\u4e0b\u9762\u6211\u4eec\u9700\u8981\u89e3\u51b3\u7684\u5c31\u662f\u5982\u4f55\u786e\u4fddSpring\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u4e5f\u80fd\u4fdd\u6301\u4e8b\u52a1\u4e00\u81f4\u6027\u3002"),(0,r.kt)("p",null,"\u901a\u8fc7\u4e0a\u6587\u5bf9Spring\u4e8b\u52a1\u57fa\u7840\u548c\u58f0\u660e\u5f0f\u4e8b\u52a1\u7684\u539f\u7406\u56de\u987e\uff0c\u76f8\u4fe1\u5927\u5bb6\u4e5f\u53d1\u73b0\u4e86\uff0c\u58f0\u660e\u5f0f\u4e8b\u52a1\u5e76\u4e0d\u80fd\u89e3\u51b3\u6211\u4eec\u5f53\u524d\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u5c31\u53ea\u80fd\u6c42\u52a9\u4e8e\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u4e86\u3002"),(0,r.kt)("p",null,"\u90a3\u4e48\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u662f\u4ec0\u4e48\u6837\u5b50\u5462\uff1f"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5176\u5b9e\u4e0a\u9762TransactionInterceptor\u7ed9\u51fa\u7684\u90a3\u5957\u6a21\u677f\u6d41\u7a0b\uff0c\u5c31\u662f\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u4f7f\u7528\u7684\u6a21\u8303\u6848\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5316\u4e0a\u9762\u7684\u6a21\u677f\u6d41\u7a0b\uff0c\u7b80\u5355\u4f7f\u7528\u5982\u4e0b:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public class TransactionMain {\n    public static void main(String[] args) throws ClassNotFoundException, SQLException {\n        test();\n    }\n\n    private static void test() {\n        DataSource dataSource = getDS();\n        JdbcTransactionManager jtm = new JdbcTransactionManager(dataSource);\n        //JdbcTransactionManager\u6839\u636eTransactionDefinition\u4fe1\u606f\u6765\u8fdb\u884c\u4e00\u4e9b\u8fde\u63a5\u5c5e\u6027\u7684\u8bbe\u7f6e\n        //\u5305\u62ec\u9694\u79bb\u7ea7\u522b\u548c\u4f20\u64ad\u884c\u4e3a\u7b49\n        DefaultTransactionDefinition transactionDef = new DefaultTransactionDefinition();\n        //\u5f00\u542f\u4e00\u4e2a\u65b0\u4e8b\u52a1---\u6b64\u65f6autocommit\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u4e3a\u4e86false,\u5e76\u4e14\u5f53\u524d\u6ca1\u6709\u4e8b\u52a1,\u8fd9\u91cc\u521b\u5efa\u7684\u662f\u4e00\u4e2a\u65b0\u4e8b\u52a1\n        TransactionStatus ts = jtm.getTransaction(transactionDef);\n        //\u8fdb\u884c\u4e1a\u52a1\u903b\u8f91\u64cd\u4f5c\n        try {\n            update(dataSource);\n            jtm.commit(ts);\n        }catch (Exception e){\n            jtm.rollback(ts);\n            System.out.println("\u53d1\u751f\u5f02\u5e38,\u6211\u5df2\u56de\u6eda");\n        }\n    }\n\n    private static void update(DataSource dataSource) throws Exception {\n        JdbcTemplate jt = new JdbcTemplate();\n        jt.setDataSource(dataSource);\n        jt.update("UPDATE Department SET Dname=\\"\u5927\u5ffd\u60a0\\" WHERE id=6");\n        throw new Exception("\u6211\u662f\u6765\u6363\u4e71\u7684");\n    }\n}\n')),(0,r.kt)("h2",{id:"\u5229\u7528\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u89e3\u51b3\u95ee\u9898"},"\u5229\u7528\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u89e3\u51b3\u95ee\u9898"),(0,r.kt)("p",null,"\u6211\u4eec\u660e\u767d\u4e86\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u7684\u4f7f\u7528\uff0c\u76f8\u4fe1\u5927\u5bb6\u4e5f\u90fd\u77e5\u9053\u95ee\u9898\u5982\u4f55\u89e3\u51b3\u4e86\uff0c\u4e0b\u9762\u6211\u7ed9\u51fa\u4e00\u4efd\u770b\u4f3c\u6b63\u786e\u7684\u89e3\u51b3\u65b9\u6848:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'package com.user.util;\n\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.jdbc.datasource.DataSourceTransactionManager;\nimport org.springframework.stereotype.Component;\nimport org.springframework.transaction.TransactionStatus;\nimport org.springframework.transaction.support.DefaultTransactionDefinition;\n\nimport javax.sql.DataSource;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.ExecutionException;\nimport java.util.concurrent.Executor;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\n/**\n * \u591a\u7ebf\u7a0b\u4e8b\u52a1\u4e00\u81f4\u6027\u7ba1\u7406 <br>\n * \u58f0\u660e\u5f0f\u4e8b\u52a1\u7ba1\u7406\u65e0\u6cd5\u5b8c\u6210,\u6b64\u65f6\u6211\u4eec\u53ea\u80fd\u91c7\u7528\u521d\u671f\u7684\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u7ba1\u7406\u624d\u884c\n * @author \u5927\u5ffd\u60a0\n * @create 2022/10/19 21:34\n */\n@Component\n@RequiredArgsConstructor\npublic class MultiplyThreadTransactionManager {\n    /**\n     * \u5982\u679c\u662f\u591a\u6570\u636e\u6e90\u7684\u60c5\u51b5\u4e0b,\u9700\u8981\u6307\u5b9a\u5177\u4f53\u662f\u54ea\u4e00\u4e2a\u6570\u636e\u6e90\n     */\n    private final DataSource dataSource;\n\n    /**\n     * \u6267\u884c\u7684\u662f\u65e0\u8fd4\u56de\u503c\u7684\u4efb\u52a1\n     * @param tasks \u5f02\u6b65\u6267\u884c\u7684\u4efb\u52a1\u5217\u8868\n     * @param executor \u5f02\u6b65\u6267\u884c\u4efb\u52a1\u9700\u8981\u7528\u5230\u7684\u7ebf\u7a0b\u6c60,\u8003\u8651\u5230\u7ebf\u7a0b\u6c60\u9700\u8981\u9694\u79bb,\u8fd9\u91cc\u5f3a\u5236\u8981\u6c42\u4f20\n     */\n    public void runAsyncButWaitUntilAllDown(List<Runnable> tasks, Executor executor) {\n        if(executor==null){\n            throw new IllegalArgumentException("\u7ebf\u7a0b\u6c60\u4e0d\u80fd\u4e3a\u7a7a");\n        }\n        DataSourceTransactionManager transactionManager = getTransactionManager();\n        //\u662f\u5426\u53d1\u751f\u4e86\u5f02\u5e38\n        AtomicBoolean ex=new AtomicBoolean();\n\n        List<CompletableFuture> taskFutureList=new ArrayList<>(tasks.size());\n        List<TransactionStatus> transactionStatusList=new ArrayList<>(tasks.size());\n\n        tasks.forEach(task->{\n            taskFutureList.add(CompletableFuture.runAsync(\n                    () -> {\n                        try{\n                            //1.\u5f00\u542f\u65b0\u4e8b\u52a1\n                            transactionStatusList.add(openNewTransaction(transactionManager));\n                            //2.\u5f02\u6b65\u4efb\u52a1\u6267\u884c\n                            task.run();\n                        }catch (Throwable throwable){\n                            //\u6253\u5370\u5f02\u5e38\n                            throwable.printStackTrace();\n                            //\u5176\u4e2d\u67d0\u4e2a\u5f02\u6b65\u4efb\u52a1\u6267\u884c\u51fa\u73b0\u4e86\u5f02\u5e38,\u8fdb\u884c\u6807\u8bb0\n                            ex.set(Boolean.TRUE);\n                            //\u5176\u4ed6\u4efb\u52a1\u8fd8\u6ca1\u6267\u884c\u7684\u4e0d\u9700\u8981\u6267\u884c\u4e86\n                            taskFutureList.forEach(completableFuture -> completableFuture.cancel(true));\n                        }\n                    }\n                    , executor)\n            );\n        });\n\n        try {\n            //\u963b\u585e\u76f4\u5230\u6240\u6709\u4efb\u52a1\u5168\u90e8\u6267\u884c\u7ed3\u675f---\u5982\u679c\u6709\u4efb\u52a1\u88ab\u53d6\u6d88,\u8fd9\u91cc\u4f1a\u629b\u51fa\u5f02\u5e38\u6ef4,\u9700\u8981\u6355\u83b7\n            CompletableFuture.allOf(taskFutureList.toArray(new CompletableFuture[]{})).get();\n        } catch (InterruptedException | ExecutionException e) {\n            e.printStackTrace();\n        }\n\n        //\u53d1\u751f\u4e86\u5f02\u5e38\u5219\u8fdb\u884c\u56de\u6eda\u64cd\u4f5c,\u5426\u5219\u63d0\u4ea4\n        if(ex.get()){\n            System.out.println("\u53d1\u751f\u5f02\u5e38,\u5168\u90e8\u4e8b\u52a1\u56de\u6eda");\n            transactionStatusList.forEach(transactionManager::rollback);\n        }else {\n            System.out.println("\u5168\u90e8\u4e8b\u52a1\u6b63\u5e38\u63d0\u4ea4");\n            transactionStatusList.forEach(transactionManager::commit);\n        }\n    }\n\n    private TransactionStatus openNewTransaction(DataSourceTransactionManager transactionManager) {\n        //JdbcTransactionManager\u6839\u636eTransactionDefinition\u4fe1\u606f\u6765\u8fdb\u884c\u4e00\u4e9b\u8fde\u63a5\u5c5e\u6027\u7684\u8bbe\u7f6e\n        //\u5305\u62ec\u9694\u79bb\u7ea7\u522b\u548c\u4f20\u64ad\u884c\u4e3a\u7b49\n        DefaultTransactionDefinition transactionDef = new DefaultTransactionDefinition();\n        //\u5f00\u542f\u4e00\u4e2a\u65b0\u4e8b\u52a1---\u6b64\u65f6autocommit\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u4e3a\u4e86false,\u5e76\u4e14\u5f53\u524d\u6ca1\u6709\u4e8b\u52a1,\u8fd9\u91cc\u521b\u5efa\u7684\u662f\u4e00\u4e2a\u65b0\u4e8b\u52a1\n        return transactionManager.getTransaction(transactionDef);\n    }\n\n    private DataSourceTransactionManager getTransactionManager() {\n        return new DataSourceTransactionManager(dataSource);\n    }\n}\n')),(0,r.kt)("p",null,"\u5927\u5bb6\u601d\u8003\u4e0a\u9762\u7684\u4ee3\u7801\u5b58\u5728\u95ee\u9898\u5417?"),(0,r.kt)("p",null,"\u6d4b\u8bd5:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public void test(){\n    List<Runnable> tasks=new ArrayList<>();\n\n    tasks.add(()->{\n       userMapper.deleteById(26);\n    });\n\n    tasks.add(()->{\n        signMapper.deleteById(10);\n    });\n\n    multiplyThreadTransactionManager.runAsyncButWaitUntilAllDown(tasks, Executors.newCachedThreadPool());\n}\n")),(0,r.kt)("p",null,"\u4efb\u52a1\u6b63\u5e38\u90fd\u6267\u884c\u5b8c\u6bd5\uff0c\u4e8b\u52a1\u8fdb\u884c\u63d0\u4ea4\uff0c\u4f46\u662f\u4f1a\u629b\u51fa\u5f02\u5e38\uff0c\u5bfc\u81f4\u4e8b\u52a1\u56de\u6eda:"),(0,r.kt)("p",null,"\u56fe\u7247"),(0,r.kt)("p",null,"\u56fe\u7247\n\u6293\u5173\u952e\u5b57:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"No value for key [HikariDataSource (HikariPool-1)] bound to thread [main]\n")),(0,r.kt)("p",null,"\u89e3\u91ca: \u65e0\u6cd5\u5728\u5f53\u524d\u7ebf\u7a0b\u7ed1\u5b9a\u7684threadLocal\u4e2d\u5bfb\u627e\u5230HikariDataSource\u4f5c\u4e3akey,\u5bf9\u5e94\u5173\u8054\u7684\u8d44\u6e90\u5bf9\u8c61ConnectionHolder\n\u8fd9\u91cc\u9700\u8981\u518d\u6b21\u56de\u987e\u4e00\u4e0bSpring\u4e8b\u52a1\u5b9e\u73b0\u7684\u5c0f\u7ec6\u8282:"),(0,r.kt)("p",null,"\u4e00\u6b21\u4e8b\u52a1\u7684\u5b8c\u6210\u901a\u5e38\u90fd\u662f\u9ed8\u8ba4\u5728\u5f53\u524d\u7ebf\u7a0b\u5185\u5b8c\u6210\u7684\uff0c\u53c8\u56e0\u4e3a\u4e00\u6b21\u4e8b\u52a1\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u6d89\u53ca\u5230\u5bf9\u5f53\u524d\u6570\u636e\u5e93\u8fde\u63a5Connection\u7684\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e3a\u4e86\u907f\u514d\u5c06Connection\u5728\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u6765\u56de\u4f20\u9012\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06Connextion\u7ed1\u5b9a\u5230\u5f53\u524d\u4e8b\u52a1\u6267\u884c\u7ebf\u7a0b\u5bf9\u5e94\u7684ThreadLocalMap\u5185\u90e8\uff0c\u987a\u4fbf\u8fd8\u53ef\u4ee5\u5c06\u4e00\u4e9b\u5176\u4ed6\u5c5e\u6027\u4e5f\u653e\u5165\u5176\u4e2d\u8fdb\u884c\u4fdd\u5b58\uff0c\u5728Spring\u4e2d\uff0c\u8d1f\u8d23\u4fdd\u5b58\u8fd9\u4e9bThreadLocal\u5c5e\u6027\u7684\u5b9e\u73b0\u7c7b\u7531TransactionSynchronizationManager\u627f\u62c5\u3002"),(0,r.kt)("p",null,"TransactionSynchronizationManager\u7c7b\u5185\u90e8\u9ed8\u8ba4\u63d0\u4f9b\u4e86\u4e0b\u9762\u516d\u4e2aThreadLocal\u5c5e\u6027\uff0c\u5206\u522b\u4fdd\u5b58\u5f53\u524d\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4e0d\u540c\u4e8b\u52a1\u8d44\u6e90:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'   //\u4fdd\u5b58\u5f53\u524d\u4e8b\u52a1\u5173\u8054\u7684\u8d44\u6e90--\u9ed8\u8ba4\u53ea\u4f1a\u5728\u65b0\u5efa\u4e8b\u52a1\u7684\u65f6\u5019\u4fdd\u5b58\u5f53\u524d\u83b7\u53d6\u5230\u7684DataSource\u548c\u5f53\u524d\u4e8b\u52a1\u5bf9\u5e94Connection\u7684\u6620\u5c04\u5173\u7cfb--\u5f53\u7136\u8fd9\u91ccConnection\u88ab\u5305\u88c5\u4e3a\u4e86ConnectionHolder\n private static final ThreadLocal<Map<Object, Object>> resources =\n   new NamedThreadLocal<>("Transactional resources");\n    //\u4e8b\u52a1\u76d1\u542c\u8005--\u5728\u4e8b\u52a1\u6267\u884c\u5230\u67d0\u4e2a\u9636\u6bb5\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u53bb\u56de\u8c03\u76d1\u542c\u8005\u5bf9\u5e94\u7684\u56de\u8c03\u63a5\u53e3(\u5178\u578b\u89c2\u5bdf\u8005\u6a21\u5f0f\u7684\u5e94\u7528)---\u9ed8\u8ba4\u4e3a\u7a7a\u96c6\u5408\n private static final ThreadLocal<Set<TransactionSynchronization>> synchronizations =\n   new NamedThreadLocal<>("Transaction synchronizations");\n   //\u89c1\u540d\u77e5\u610f: \u5b58\u653e\u5f53\u524d\u4e8b\u52a1\u540d\u5b57\n private static final ThreadLocal<String> currentTransactionName =\n   new NamedThreadLocal<>("Current transaction name");\n   //\u89c1\u540d\u77e5\u610f: \u5b58\u653e\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u662f\u53ea\u8bfb\u4e8b\u52a1\n private static final ThreadLocal<Boolean> currentTransactionReadOnly =\n   new NamedThreadLocal<>("Current transaction read-only status");\n   //\u89c1\u540d\u77e5\u610f: \u5b58\u653e\u5f53\u524d\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\n private static final ThreadLocal<Integer> currentTransactionIsolationLevel =\n   new NamedThreadLocal<>("Current transaction isolation level");\n   //\u89c1\u540d\u77e5\u610f: \u5b58\u653e\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u5904\u4e8e\u6fc0\u6d3b\u72b6\u6001\n private static final ThreadLocal<Boolean> actualTransactionActive =\n   new NamedThreadLocal<>("Actual transaction active");\n')),(0,r.kt)("p",null,"\u90a3\u4e48\u4e0a\u9762\u629b\u51fa\u7684\u5f02\u5e38\u7684\u539f\u56e0\u4e5f\u5c31\u5f88\u6e05\u695a\u4e86\uff0c\u65e0\u6cd5\u5728main\u7ebf\u7a0b\u627e\u5230\u5f53\u524d\u4e8b\u52a1\u5bf9\u5e94\u7684\u8d44\u6e90\uff0c\u539f\u56e0\u5982\u4e0b:"),(0,r.kt)("p",null,"\u56fe\u7247"),(0,r.kt)("p",null,"\u56fe\u7247\n\u5f00\u542f\u65b0\u4e8b\u52a1\u65f6\uff0c\u4e8b\u52a1\u76f8\u5173\u8d44\u6e90\u90fd\u88ab\u7ed1\u5b9a\u5230\u4e86thread-cache-pool-1\u7ebf\u7a0b\u5bf9\u5e94\u7684threadLocalMap\u5185\u90e8\uff0c\u800c\u5f53\u6267\u884c\u4e8b\u52a1\u63d0\u4ea4\u4ee3\u7801\u65f6\uff0ccommit\u5185\u90e8\u9700\u8981\u4eceTransactionSynchronizationManager\u4e2d\u83b7\u53d6\u5f53\u524d\u4e8b\u52a1\u7684\u8d44\u6e90\uff0c\u663e\u7136\u6211\u4eec\u65e0\u6cd5\u4ecemain\u7ebf\u7a0b\u5bf9\u5e94\u7684threadLocalMap\u4e2d\u83b7\u53d6\u5230\u5bf9\u5e94\u7684\u4e8b\u52a1\u8d44\u6e90\uff0c\u8fd9\u4e5f\u5c31\u662f\u5f02\u5e38\u629b\u51fa\u7684\u539f\u56e0\u3002"),(0,r.kt)("h2",{id:"\u95ee\u9898\u5206\u6790\u5b8c\u4e86\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u95ee\u9898\u5462"},"\u95ee\u9898\u5206\u6790\u5b8c\u4e86\uff0c\u90a3\u4e48\u5982\u4f55\u89e3\u51b3\u95ee\u9898\u5462\uff1f"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u6211\u9996\u5148\u60f3\u5230\u7684\u7b80\u5355\u7c97\u66b4\u7684\u65b9\u6cd5\u2014CopyTransactionResource\u2014\u5c06\u4e8b\u52a1\u8d44\u6e90\u5728\u4e24\u4e2a\u7ebf\u7a0b\u95f4\u6765\u56de\u590d\u5236")),(0,r.kt)("p",null,"\u8fd9\u91cc\u7ed9\u51fa\u89e3\u51b3\u540e\u95ee\u9898\u540e\u7684\u4ee3\u7801\u793a\u4f8b:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'package com.user.util;\n\nimport lombok.Builder;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.jdbc.datasource.DataSourceTransactionManager;\nimport org.springframework.stereotype.Component;\nimport org.springframework.transaction.TransactionStatus;\nimport org.springframework.transaction.support.DefaultTransactionDefinition;\nimport org.springframework.transaction.support.TransactionSynchronization;\nimport org.springframework.transaction.support.TransactionSynchronizationManager;\nimport javax.sql.DataSource;\nimport java.util.*;\nimport java.util.concurrent.CompletableFuture;\nimport java.util.concurrent.ExecutionException;\nimport java.util.concurrent.Executor;\nimport java.util.concurrent.atomic.AtomicBoolean;\n\n/**\n * \u591a\u7ebf\u7a0b\u4e8b\u52a1\u4e00\u81f4\u6027\u7ba1\u7406 <br>\n * \u58f0\u660e\u5f0f\u4e8b\u52a1\u7ba1\u7406\u65e0\u6cd5\u5b8c\u6210,\u6b64\u65f6\u6211\u4eec\u53ea\u80fd\u91c7\u7528\u521d\u671f\u7684\u7f16\u7a0b\u5f0f\u4e8b\u52a1\u7ba1\u7406\u624d\u884c\n * @author \u5927\u5ffd\u60a0\n * @create 2022/10/19 21:34\n */\n@Component\n@RequiredArgsConstructor\npublic class MultiplyThreadTransactionManager {\n    /**\n     * \u5982\u679c\u662f\u591a\u6570\u636e\u6e90\u7684\u60c5\u51b5\u4e0b,\u9700\u8981\u6307\u5b9a\u5177\u4f53\u662f\u54ea\u4e00\u4e2a\u6570\u636e\u6e90\n     */\n    private final DataSource dataSource;\n\n    /**\n     * \u6267\u884c\u7684\u662f\u65e0\u8fd4\u56de\u503c\u7684\u4efb\u52a1\n     * @param tasks \u5f02\u6b65\u6267\u884c\u7684\u4efb\u52a1\u5217\u8868\n     * @param executor \u5f02\u6b65\u6267\u884c\u4efb\u52a1\u9700\u8981\u7528\u5230\u7684\u7ebf\u7a0b\u6c60,\u8003\u8651\u5230\u7ebf\u7a0b\u6c60\u9700\u8981\u9694\u79bb,\u8fd9\u91cc\u5f3a\u5236\u8981\u6c42\u4f20\n     */\n    public void runAsyncButWaitUntilAllDown(List<Runnable> tasks, Executor executor) {\n        if(executor==null){\n            throw new IllegalArgumentException("\u7ebf\u7a0b\u6c60\u4e0d\u80fd\u4e3a\u7a7a");\n        }\n        DataSourceTransactionManager transactionManager = getTransactionManager();\n        //\u662f\u5426\u53d1\u751f\u4e86\u5f02\u5e38\n        AtomicBoolean ex=new AtomicBoolean();\n\n        List<CompletableFuture> taskFutureList=new ArrayList<>(tasks.size());\n        List<TransactionStatus> transactionStatusList=new ArrayList<>(tasks.size());\n        List<TransactionResource> transactionResources=new ArrayList<>(tasks.size());\n\n        tasks.forEach(task->{\n            taskFutureList.add(CompletableFuture.runAsync(\n                    () -> {\n                        try{\n                            //1.\u5f00\u542f\u65b0\u4e8b\u52a1\n                            transactionStatusList.add(openNewTransaction(transactionManager));\n                            //2.copy\u4e8b\u52a1\u8d44\u6e90\n                         transactionResources.add(TransactionResource.copyTransactionResource());\n                            //3.\u5f02\u6b65\u4efb\u52a1\u6267\u884c\n                            task.run();\n                        }catch (Throwable throwable){\n                            //\u6253\u5370\u5f02\u5e38\n                            throwable.printStackTrace();\n                            //\u5176\u4e2d\u67d0\u4e2a\u5f02\u6b65\u4efb\u52a1\u6267\u884c\u51fa\u73b0\u4e86\u5f02\u5e38,\u8fdb\u884c\u6807\u8bb0\n                            ex.set(Boolean.TRUE);\n                            //\u5176\u4ed6\u4efb\u52a1\u8fd8\u6ca1\u6267\u884c\u7684\u4e0d\u9700\u8981\u6267\u884c\u4e86\n                            taskFutureList.forEach(completableFuture -> completableFuture.cancel(true));\n                        }\n                    }\n                    , executor)\n            );\n        });\n\n        try {\n            //\u963b\u585e\u76f4\u5230\u6240\u6709\u4efb\u52a1\u5168\u90e8\u6267\u884c\u7ed3\u675f---\u5982\u679c\u6709\u4efb\u52a1\u88ab\u53d6\u6d88,\u8fd9\u91cc\u4f1a\u629b\u51fa\u5f02\u5e38\u6ef4,\u9700\u8981\u6355\u83b7\n            CompletableFuture.allOf(taskFutureList.toArray(new CompletableFuture[]{})).get();\n        } catch (InterruptedException | ExecutionException e) {\n            e.printStackTrace();\n        }\n\n        //\u53d1\u751f\u4e86\u5f02\u5e38\u5219\u8fdb\u884c\u56de\u6eda\u64cd\u4f5c,\u5426\u5219\u63d0\u4ea4\n        if(ex.get()){\n            System.out.println("\u53d1\u751f\u5f02\u5e38,\u5168\u90e8\u4e8b\u52a1\u56de\u6eda");\n            for (int i = 0; i < tasks.size(); i++) {\n                transactionResources.get(i).autoWiredTransactionResource();\n                transactionManager.rollback(transactionStatusList.get(i));\n                transactionResources.get(i).removeTransactionResource();\n            }\n        }else {\n            System.out.println("\u5168\u90e8\u4e8b\u52a1\u6b63\u5e38\u63d0\u4ea4");\n            for (int i = 0; i < tasks.size(); i++) {\n                transactionResources.get(i).autoWiredTransactionResource();\n                transactionManager.commit(transactionStatusList.get(i));\n                transactionResources.get(i).removeTransactionResource();\n            }\n        }\n    }\n\n    private TransactionStatus openNewTransaction(DataSourceTransactionManager transactionManager) {\n        //JdbcTransactionManager\u6839\u636eTransactionDefinition\u4fe1\u606f\u6765\u8fdb\u884c\u4e00\u4e9b\u8fde\u63a5\u5c5e\u6027\u7684\u8bbe\u7f6e\n        //\u5305\u62ec\u9694\u79bb\u7ea7\u522b\u548c\u4f20\u64ad\u884c\u4e3a\u7b49\n        DefaultTransactionDefinition transactionDef = new DefaultTransactionDefinition();\n        //\u5f00\u542f\u4e00\u4e2a\u65b0\u4e8b\u52a1---\u6b64\u65f6autocommit\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u4e3a\u4e86false,\u5e76\u4e14\u5f53\u524d\u6ca1\u6709\u4e8b\u52a1,\u8fd9\u91cc\u521b\u5efa\u7684\u662f\u4e00\u4e2a\u65b0\u4e8b\u52a1\n        return transactionManager.getTransaction(transactionDef);\n    }\n\n    private DataSourceTransactionManager getTransactionManager() {\n        return new DataSourceTransactionManager(dataSource);\n    }\n\n    /**\n     * \u4fdd\u5b58\u5f53\u524d\u4e8b\u52a1\u8d44\u6e90,\u7528\u4e8e\u7ebf\u7a0b\u95f4\u7684\u4e8b\u52a1\u8d44\u6e90COPY\u64cd\u4f5c\n     */\n    @Builder\n    private static class TransactionResource{\n        //\u4e8b\u52a1\u7ed3\u675f\u540e\u9ed8\u8ba4\u4f1a\u79fb\u9664\u96c6\u5408\u4e2d\u7684DataSource\u4f5c\u4e3akey\u5173\u8054\u7684\u8d44\u6e90\u8bb0\u5f55\n        private  Map<Object, Object> resources = new HashMap<>();\n\n        //\u4e0b\u9762\u4e94\u4e2a\u5c5e\u6027\u4f1a\u5728\u4e8b\u52a1\u7ed3\u675f\u540e\u88ab\u81ea\u52a8\u6e05\u7406,\u65e0\u9700\u6211\u4eec\u624b\u52a8\u6e05\u7406\n        private  Set<TransactionSynchronization> synchronizations =new HashSet<>();\n\n        private  String currentTransactionName;\n\n        private Boolean currentTransactionReadOnly;\n\n        private Integer currentTransactionIsolationLevel;\n\n        private Boolean actualTransactionActive;\n\n        public static TransactionResource copyTransactionResource(){\n            return TransactionResource.builder()\n                    //\u8fd4\u56de\u7684\u662f\u4e0d\u53ef\u53d8\u96c6\u5408\n                    .resources(TransactionSynchronizationManager.getResourceMap())\n                    //\u5982\u679c\u9700\u8981\u6ce8\u518c\u4e8b\u52a1\u76d1\u542c\u8005,\u8fd9\u91cc\u8bb0\u5f97\u4fee\u6539--\u6211\u4eec\u8fd9\u91cc\u4e0d\u9700\u8981,\u5c31\u91c7\u7528\u9ed8\u8ba4\u8d1f\u8d23--spring\u4e8b\u52a1\u5185\u90e8\u9ed8\u8ba4\u4e5f\u662f\u8fd9\u4e2a\u503c\n                    .synchronizations(new LinkedHashSet<>())\n                    .currentTransactionName(TransactionSynchronizationManager.getCurrentTransactionName())\n                    .currentTransactionReadOnly(TransactionSynchronizationManager.isCurrentTransactionReadOnly())\n                    .currentTransactionIsolationLevel(TransactionSynchronizationManager.getCurrentTransactionIsolationLevel())\n                    .actualTransactionActive(TransactionSynchronizationManager.isActualTransactionActive())\n                    .build();\n        }\n\n        public void autoWiredTransactionResource(){\n             resources.forEach(TransactionSynchronizationManager::bindResource);\n             //\u5982\u679c\u9700\u8981\u6ce8\u518c\u4e8b\u52a1\u76d1\u542c\u8005,\u8fd9\u91cc\u8bb0\u5f97\u4fee\u6539--\u6211\u4eec\u8fd9\u91cc\u4e0d\u9700\u8981,\u5c31\u91c7\u7528\u9ed8\u8ba4\u8d1f\u8d23--spring\u4e8b\u52a1\u5185\u90e8\u9ed8\u8ba4\u4e5f\u662f\u8fd9\u4e2a\u503c\n             TransactionSynchronizationManager.initSynchronization();\n             TransactionSynchronizationManager.setActualTransactionActive(actualTransactionActive);\n             TransactionSynchronizationManager.setCurrentTransactionName(currentTransactionName);\n             TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(currentTransactionIsolationLevel);\n             TransactionSynchronizationManager.setCurrentTransactionReadOnly(currentTransactionReadOnly);\n        }\n\n        public void removeTransactionResource() {\n            //\u4e8b\u52a1\u7ed3\u675f\u540e\u9ed8\u8ba4\u4f1a\u79fb\u9664\u96c6\u5408\u4e2d\u7684DataSource\u4f5c\u4e3akey\u5173\u8054\u7684\u8d44\u6e90\u8bb0\u5f55\n            //DataSource\u5982\u679c\u91cd\u590d\u79fb\u9664,unbindResource\u65f6\u4f1a\u56e0\u4e3a\u4e0d\u5b58\u5728\u6b64key\u5173\u8054\u7684\u4e8b\u52a1\u8d44\u6e90\u800c\u62a5\u9519\n            resources.keySet().forEach(key->{\n                if(!(key instanceof  DataSource)){\n                    TransactionSynchronizationManager.unbindResource(key);\n                }\n            });\n        }\n    }\n}\n')),(0,r.kt)("p",null,"\u589e\u52a0\u5f02\u5e38\u629b\u51fa\uff0c\u6d4b\u8bd5\u662f\u5426\u80fd\u591f\u4fdd\u8bc1\u591a\u7ebf\u7a0b\u95f4\u7684\u4e8b\u52a1\u4e00\u81f4\u6027:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@SpringBootTest(classes = UserMain.class)\npublic class Test {\n    @Resource\n    private UserMapper userMapper;\n    @Resource\n    private SignMapper signMapper;\n    @Resource\n    private MultiplyThreadTransactionManager multiplyThreadTransactionManager;\n\n    @SneakyThrows\n    @org.junit.jupiter.api.Test\n    public void test(){\n        List<Runnable> tasks=new ArrayList<>();\n\n        tasks.add(()->{\n                userMapper.deleteById(26);\n                throw new RuntimeException("\u6211\u5c31\u8981\u629b\u51fa\u5f02\u5e38!");\n        });\n\n        tasks.add(()->{\n            signMapper.deleteById(10);\n        });\n\n        multiplyThreadTransactionManager.runAsyncButWaitUntilAllDown(tasks, Executors.newCachedThreadPool());\n    }\n\n}\n')),(0,r.kt)("p",null,"\u4e8b\u52a1\u90fd\u8fdb\u884c\u4e86\u56de\u6eda\uff0c\u6570\u636e\u5e93\u6570\u636e\u6ca1\u53d8\u3002"),(0,r.kt)("h2",{id:"\u8865\u5145\u8bf4\u660e"},"\u8865\u5145\u8bf4\u660e"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u672c\u8282\u589e\u52a0\u65f6\u95f4\uff1a 2023 - 09 - 03")),(0,r.kt)("p",null,"\u6b64\u5904\u8865\u5145\u8bf4\u660e\u4e00\u4e0bSpring\u4e8b\u52a1\u4f53\u7cfb\u83b7\u53d6Connection\u8fde\u63a5\u7684\u65f6\u673a\u70b9\u8bf4\u660e\uff0c\u65b9\u4fbf\u5927\u5bb6\u9047\u5230\u95ee\u9898\u65f6\u6392\u67e5\uff1a"),(0,r.kt)("h3",{id:"\u4e8b\u52a1\u521d\u6b21\u5f00\u542f\u65f6"},"\u4e8b\u52a1\u521d\u6b21\u5f00\u542f\u65f6\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5c1d\u8bd5\u6839\u636eTransactionDefinition\u5f00\u542f\u6216\u8005\u590d\u7528\u4e00\u4e2a\u4e8b\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException {\n    TransactionDefinition def = (definition != null ? definition : TransactionDefinition.withDefaults());\n    // \u5c1d\u8bd5\u83b7\u53d6\u5df2\u7ecf\u5b58\u5728\u7684\u4e8b\u52a1\u8fde\u63a5\n    Object transaction = doGetTransaction();\n    ...\n    // \u5982\u679c\u5b58\u5728\u5df2\u7ecf\u5efa\u7acb\u597d\u7684\u4e8b\u52a1\u8fde\u63a5,\u90a3\u4e48\u6839\u636e\u4f20\u64ad\u884c\u4e3a\u51b3\u5b9a\u4e0b\u4e00\u6b65\u9700\u8981\u600e\u4e48\u505a,\u53ef\u4ee5\u662f\u590d\u7528,\u53ef\u4ee5\u662f\u6302\u8d77\u7b49\u5f85,\u7b49\u7b49...\n    if (isExistingTransaction(transaction)) {\n        // Existing transaction found -> check propagation behavior to find out how to behave.\n        return handleExistingTransaction(def, transaction, debugEnabled);\n    }\n    ...\n    // \u5982\u679c\u5f53\u524d\u4e8b\u52a1\u4f20\u64ad\u884c\u4e3a\u4e3aMANDATORY,\u5219\u8981\u6c42\u4e8b\u52a1\u5f00\u542f\u524d\u5fc5\u987b\u5b58\u5728\u4e00\u4e2a\u4e8b\u52a1\u8fde\u63a5,\u5426\u5219\u629b\u51fa\u5f02\u5e38\n    if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) {\n        throw new IllegalTransactionStateException(\"No existing transaction found for transaction marked with propagation 'mandatory'\");\n    }\n    else if (\n        // \u5f53\u524d\u5b58\u5728\u4e8b\u52a1,\u5219\u76f4\u63a5\u590d\u7528\u5f53\u524d\u4e8b\u52a1,\u5982\u679c\u4e0d\u5b58\u5728\u4e8b\u52a1,\u5219\u65b0\u5efa\u4e00\u4e2a\u4e8b\u52a1\n        def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||\n        // \u5982\u679c\u5f53\u524d\u5b58\u4e8b\u52a1,\u5219\u628a\u5f53\u524d\u4e8b\u52a1\u6302\u8d77,\u5426\u5219\u65b0\u5efa\u4e8b\u52a1\n        def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||\n        // \u5982\u679c\u5f53\u524d\u5b58\u5728\u4e8b\u52a1\uff0c\u5219\u5728\u5d4c\u5957\u4e8b\u52a1\u5185\u6267\u884c\u3002\u5982\u679c\u5f53\u524d\u6ca1\u6709\u4e8b\u52a1\uff0c\u5219\u6267\u884c\u4e0ePROPAGATION_REQUIRED\u7c7b\u4f3c\u7684\u64cd\u4f5c\n        def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {\n            // \u5c06TransactionSynchronizationManager\u5b58\u50a8\u7684\u5f53\u524d\u7ebf\u7a0b\u7684\u76f8\u5173\u4e8b\u52a1\u8d44\u6e90\u4fe1\u606f\u8fdb\u884c\u4fdd\u5b58\n            SuspendedResourcesHolder suspendedResources = suspend(null);\n            ....\n            try {\n                // \u5f00\u542f\u65b0\u7684\u4e8b\u52a1\n                return startTransaction(def, transaction, debugEnabled, suspendedResources);\n            }\n            catch (RuntimeException | Error ex) {\n            // \u6062\u590d\u4e8b\u52a1\u8d44\u6e90\u4fe1\u606f\n            resume(null, suspendedResources);\n                throw ex;\n            }\n    } else {\n        ...\n        // \u5f53\u524d\u4f20\u64ad\u884c\u4e3a\u5728\u6ca1\u6709\u4e8b\u52a1\u5b58\u5728\u65f6,\u76f4\u63a5\u8fd0\u884c\uff0c\u6b64\u5904\u4f1a\u521b\u5efa\u4e00\u4e2a\u7a7a\u4e8b\u52a1\n        boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);\n        return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null);\n    }\n}\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"\u5c1d\u8bd5\u4ece\u5f53\u524d\u7ebf\u7a0b\u4e8b\u52a1\u4e0a\u4e0b\u6587\u4e2d\u83b7\u53d6\u5df2\u7ecf\u5b58\u5728\u7684ConnectionHolder")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Override\nprotected Object doGetTransaction() {\n    DataSourceTransactionObject txObject = new DataSourceTransactionObject();\n    txObject.setSavepointAllowed(isNestedTransactionAllowed());\n    // \u5c1d\u8bd5\u6839\u636eDataSource\u4f5c\u4e3akey,\u4ece\u5f53\u524d\u7ebf\u7a0b\u7684ThreadLocal\u4e2d\u83b7\u53d6\u5bf9\u5e94\u7684connection\n    ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource());\n    // \u5982\u679c\u6b64\u65f6\u4e0d\u5b58\u5728\u4e8b\u52a1\u4e0a\u4e0b\u6587,\u5373\u4e0d\u5b58\u5728\u5df2\u7ecf\u5efa\u7acb\u7684\u4e8b\u52a1\u8fde\u63a5,\u4e0a\u9762\u8fd4\u56de\u7684conHolder\u4e3anull\n    txObject.setConnectionHolder(conHolder, false);\n    return txObject;\n}\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"\u5224\u65ad\u662f\u5426\u5b58\u5728\u5df2\u7ecf\u5efa\u7acb\u597d\u7684\u4e8b\u52a1\u8fde\u63a5")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"protected boolean isExistingTransaction(Object transaction) {\n    DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;\n    // \u5224\u65ad\u662f\u5426\u5b58\u5728\u5df2\u7ecf\u5efa\u7acb\u597d\u7684\u4e8b\u52a1\u8fde\u63a5\n    return (txObject.hasConnectionHolder() && txObject.getConnectionHolder().isTransactionActive());\n}\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"\u5f00\u542f\u4e00\u6bb5\u65b0\u7684\u4e8b\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"private TransactionStatus startTransaction(TransactionDefinition definition, Object transaction,\n        boolean debugEnabled, @Nullable SuspendedResourcesHolder suspendedResources) {\n    boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);\n    DefaultTransactionStatus status = newTransactionStatus(\n    definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);\n    // \u5f00\u542f\u4e8b\u52a1\n    doBegin(transaction, definition);\n    // \u521d\u59cb\u5316\u5f53\u524d\u7ebf\u7a0b\u4e8b\u52a1\u4e0a\u4e0b\u6587\u4fe1\u606f\n    prepareSynchronization(status, definition);\n    return status;\n}\n\n// \u521d\u59cb\u5316\u597d\u5f53\u524d\u7ebf\u7a0b\u7684\u4e8b\u52a1\u4e0a\u4e0b\u6587\u4fe1\u606f\nprotected void prepareSynchronization(DefaultTransactionStatus status, TransactionDefinition definition) {\n    if (status.isNewSynchronization()) {\n        TransactionSynchronizationManager.setActualTransactionActive(status.hasTransaction());\n        TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(\n            definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT ? \n            definition.getIsolationLevel() : null);\n        TransactionSynchronizationManager.setCurrentTransactionReadOnly(definition.isReadOnly());\n        TransactionSynchronizationManager.setCurrentTransactionName(definition.getName());\n        TransactionSynchronizationManager.initSynchronization();\n    }\n}\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"\u771f\u6b63\u5efa\u7acb\u4e8b\u52a1\u8fde\u63a5")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"protected void doBegin(Object transaction, TransactionDefinition definition) {\n    DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;\n    Connection con = null;\n    try {\n        if (!txObject.hasConnectionHolder() ||\n                txObject.getConnectionHolder().isSynchronizedWithTransaction()) {\n            // \u901a\u8fc7DataSource\u53bb\u83b7\u53d6\u4e00\u4e2a\u4e8b\u52a1\u8fde\u63a5\n            Connection newCon = obtainDataSource().getConnection();\n            ...\n            // \u8bbe\u7f6e\u5230connectionHolder\u4e2d\u53bb\n            txObject.setConnectionHolder(new ConnectionHolder(newCon), true);\n        }\n        // \u8bbe\u7f6eSynchronizedWithTransaction\u4e3atrue,\u8868\u660e\u5f53\u524d\u7ebf\u7a0b\u4e0e\u4e00\u4e2a\u4e8b\u52a1\u4e0a\u4e0b\u6587\u7ed1\u5b9a\u6210\u529f\u4e86\n        txObject.getConnectionHolder().setSynchronizedWithTransaction(true);\n        // \u5f53\u524d\u4e8b\u52a1\u8fde\u63a5\u5404\u79cd\u5c5e\u6027\u8bbe\u7f6e: \u662f\u5426\u53ea\u8bfb\uff0c\u662f\u5426\u81ea\u52a8\u63d0\u4ea4\n        ...\n        // \u5982\u679c\u662f\u65b0\u8fde\u63a5,\u5219\u4ee5DataSource\u4f5c\u4e3akey,\u6807\u8bc6\u5f53\u524d\u7ebf\u7a0b\u901a\u8fc7\u5f53\u524dDataSource\u5efa\u7acb\u7684\u4e00\u4e2a\u5efa\u7acb\n        // \u5e76\u5c06\u8fd9\u4e2a\u6620\u5c04\u5173\u7cfb\u4fdd\u5b58\u5230\u5f53\u524d\u7ebf\u7a0b\u7684\u4e8b\u52a1\u4e0a\u4e0b\u6587\u73af\u5883\u4e2d\u53bb\n        if (txObject.isNewConnectionHolder()) {\n            TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder());\n        }\n    }\n    ...\n}\n")),(0,r.kt)("h2",{id:"\u4e8b\u52a1\u5269\u4f59\u6267\u884c\u8fc7\u7a0b\u4e2d\u83b7\u53d6\u8fde\u63a5"},"\u4e8b\u52a1\u5269\u4f59\u6267\u884c\u8fc7\u7a0b\u4e2d\u83b7\u53d6\u8fde\u63a5:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u501f\u52a9DataSourceUtils\u7684getConnection\u65b9\u6cd5\u5c1d\u8bd5\u83b7\u53d6\u5f53\u524d\u7ebf\u7a0b\u5173\u8054\u7684\u5b58\u6d3b\u8fde\u63a5,\u6216\u8005\u65b0\u5efa\u4e00\u4e2a\u8fde\u63a5")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public static Connection doGetConnection(DataSource dataSource) throws SQLException {\n    ...\n    // \u4ece\u5f53\u524d\u7ebf\u7a0bthreadLocal\u4e2d\u5c1d\u8bd5\u83b7\u53d6\u901a\u8fc7\u5f53\u524d\u4f20\u5165DataSource\u5df2\u7ecf\u521b\u5efa\u51fa\u6765\u7684\u90a3\u4e2a\u4e8b\u52a1\u8fde\u63a5\n    ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);\n    // \u5982\u679c\u8fde\u63a5\u5b58\u5728\u6216\u8005\u5f53\u524d\u7ebf\u7a0b\u5df2\u7ecf\u5f00\u542f\u4e86\u4e00\u4e2a\u4e8b\u52a1\u4e0a\u4e0b\u6587,\u5219\u76f4\u63a5\u8fd4\u56de\u5df2\u6709\u7684\u4e8b\u52a1\u8fde\u63a5\n    if (conHolder != null && (conHolder.hasConnection() || conHolder.isSynchronizedWithTransaction())) {\n        conHolder.requested();\n        if (!conHolder.hasConnection()) {\n            logger.debug("Fetching resumed JDBC Connection from DataSource");\n            // \u53ef\u80fd\u56e0\u4e3a\u5f02\u5e38\u6216\u8005\u5176\u4ed6\u95ee\u9898\uff0c\u5bfc\u81f4\u8fde\u63a5\u88ab\u91ca\u653e,\u6b64\u65f6\u91cd\u65b0\u83b7\u53d6\u4e00\u4e2a\u65b0\u7684\u8fde\u63a5\n            conHolder.setConnection(fetchConnection(dataSource));\n        }\n        return conHolder.getConnection();\n    }\n    // \u91cd\u65b0\u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5\n    Connection con = fetchConnection(dataSource);\n    // \u5224\u65ad\u4e8b\u52a1\u540c\u6b65\u662f\u5426\u6d3b\u8dc3\n    if (TransactionSynchronizationManager.isSynchronizationActive()) {\n        try {\n            // Use same Connection for further JDBC actions within the transaction.\n            // Thread-bound object will get removed by synchronization at transaction completion.\n            // \u5c06\u65b0\u7684\u8fde\u63a5\u8bbe\u7f6e\u5230ConnectionHolder\u4e2d\n            ConnectionHolder holderToUse = conHolder;\n            if (holderToUse == null) {\n                holderToUse = new ConnectionHolder(con);\n            } else {\n                holderToUse.setConnection(con);\n            }\n            holderToUse.requested();\n            TransactionSynchronizationManager.registerSynchronization(\n                new ConnectionSynchronization(holderToUse, dataSource));\n            // \u91cd\u65b0\u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u4e0e\u4e00\u4e2a\u4e8b\u52a1\u4e0a\u4e0b\u6587\u5173\u8054\n            holderToUse.setSynchronizedWithTransaction(true);\n            // \u5982\u679cconnectionHolder\u4e0e\u4e00\u5f00\u59cb\u7684\u4e0d\u76f8\u7b49,\u5219\u91cd\u65b0\u8bbe\u7f6e\n            if (holderToUse != conHolder) {\n                TransactionSynchronizationManager.bindResource(dataSource, holderToUse);\n            }\n        } catch (RuntimeException ex) {\n            // Unexpected exception from external delegation call -> close Connection and rethrow.\n            releaseConnection(con, dataSource);\n            throw ex;\n        }\n    }\n    return con;\n}\n')),(0,r.kt)("h2",{id:"\u5176\u5b9e\u6211\u4eec\u672c\u6587\u7ed9\u51fa\u7684copy\u4e8b\u52a1\u8d44\u6e90\u7684\u65b9\u6848\u548c\u4e0a\u9762\u51fa\u73b0\u7684suspend\u6302\u8d77\u5f53\u524d\u4e8b\u52a1\u548cresume\u6062\u590d\u5f53\u524d\u4e8b\u52a1\u7684\u601d\u60f3\u662f\u4e00\u81f4\u7684"},"\u5176\u5b9e\u6211\u4eec\u672c\u6587\u7ed9\u51fa\u7684copy\u4e8b\u52a1\u8d44\u6e90\u7684\u65b9\u6848\u548c\u4e0a\u9762\u51fa\u73b0\u7684suspend\u6302\u8d77\u5f53\u524d\u4e8b\u52a1\u548cresume\u6062\u590d\u5f53\u524d\u4e8b\u52a1\u7684\u601d\u60f3\u662f\u4e00\u81f4\u7684:"),(0,r.kt)("h3",{id:"1-\u6302\u8d77\u5f53\u524d\u4e8b\u52a1"},"1. \u6302\u8d77\u5f53\u524d\u4e8b\u52a1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Nullable\nprotected final SuspendedResourcesHolder suspend(@Nullable Object transaction) throws TransactionException {\n    //\u88ab\u6302\u8d77\u7684\u4e8b\u52a1\u662f\u5426\u8fd8\u5904\u4e8e\u6d3b\u8dc3\u72b6\u6001\n    if (TransactionSynchronizationManager.isSynchronizationActive()) {\n        //\u9996\u5148\u6682\u505c\u4e0e\u5f53\u524d\u7ebf\u7a0b\u76f8\u5173\u7684\u6240\u6709TransactionSynchronization\n        List<TransactionSynchronization> suspendedSynchronizations = doSuspendSynchronization();\n        try {\n            Object suspendedResources = null;\n            if (transaction != null) {\n                //\u6682\u505c\u76ee\u6807\u4e8b\u52a1\n                suspendedResources = doSuspend(transaction);\n            }\n            //\u6e05\u7a7aTransactionSynchronizationManager\u5173\u4e8e\u5f53\u524d\u7ebf\u7a0b\u7684\u4e00\u4e9b\u4e8b\u52a1\u8bb0\u5f55\n            String name = TransactionSynchronizationManager.getCurrentTransactionName();\n            TransactionSynchronizationManager.setCurrentTransactionName(null);\n            boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();\n            TransactionSynchronizationManager.setCurrentTransactionReadOnly(false);\n            Integer isolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();\n            TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(null);\n            boolean wasActive = TransactionSynchronizationManager.isActualTransactionActive();\n            TransactionSynchronizationManager.setActualTransactionActive(false);\n            //SuspendedResourcesHolder\u4fdd\u5b58\u88ab\u6302\u8d77\u7684\u4e8b\u52a1\u7684\u6240\u6709\u4fe1\u606f\u72b6\u6001\uff0c\u65b9\u4fbf\u65e5\u540e\u6062\u590d\u4f7f\u7528\n            return new SuspendedResourcesHolder(\n                suspendedResources, suspendedSynchronizations, name, readOnly, isolationLevel, wasActive);\n        } catch (RuntimeException | Error ex) {\n            // doSuspend failed - original transaction is still active...\n            doResumeSynchronization(suspendedSynchronizations);\n            throw ex;\n        }\n    }\n    else if (transaction != null) {\n        // Transaction active but no synchronization active.\n        Object suspendedResources = doSuspend(transaction);\n        return new SuspendedResourcesHolder(suspendedResources);\n    } else {\n        // Neither transaction nor synchronization active.\n        return null;\n    }\n}\n\n@Override\nprotected Object doSuspend(Object transaction) {\n    //\u89e3\u9664\u5f53\u524dtransaction\u5bf9\u4e8eConnectionHolder\u7684\u7ed1\u5b9a\u5173\u7cfb\n    DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;\n    txObject.setConnectionHolder(null);\n    //\u89e3\u9664TransactionSynchronizationManager\u4e0eConnectionHolder\u8d44\u6e90\u7684\u7ed1\u5b9a\u5173\u7cfb\uff0c\u7136\u540e\u8fd4\u56de\u5bf9\u5e94\u7684ConnectionHolder\u8d44\u6e90\n    return TransactionSynchronizationManager.unbindResource(obtainDataSource());\n}\n")),(0,r.kt)("h3",{id:"2-\u6062\u590d\u88ab\u6302\u8d77\u7684\u4e8b\u52a1"},"2. \u6062\u590d\u88ab\u6302\u8d77\u7684\u4e8b\u52a1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"protected final void resume(@Nullable Object transaction, @Nullable SuspendedResourcesHolder resourcesHolder) throws TransactionException {\n    //SuspendedResourcesHolder\u4fdd\u5b58\u4e86\u4e8b\u52a1\u88ab\u6302\u8d77\u524d\u7684\u72b6\u6001\uff0c\u8fd9\u91cc\u53ea\u9700\u8981\u4ece\u4e2d\u8bfb\u53d6\u7136\u540e\u8fdb\u884c\u6062\u590d\u5373\u53ef\n    if (resourcesHolder != null) {\n        //suspendedResources\u5c31\u662f\u4e0a\u9762\u89e3\u7ed1\u7684ConnectionHolder\n        Object suspendedResources = resourcesHolder.suspendedResources;\n        if (suspendedResources != null) {\n            //\u6062\u590d\u4e8b\u52a1\uff0c\u5c31\u662f\u91cd\u65b0\u7ed1\u5b9a\u4e00\u4e0bConnectionHolder\n            doResume(transaction, suspendedResources);\n        }\n        List<TransactionSynchronization> suspendedSynchronizations = resourcesHolder.suspended\n        Synchronizations;\n        if (suspendedSynchronizations != null) {\n            //\u8bbe\u7f6eTransactionSynchronizationManager\u5173\u4e8e\u5f53\u524d\u4e8b\u52a1\u7684\u76f8\u5173\u72b6\u6001\n            TransactionSynchronizationManager.setActualTransactionActive(resourcesHolder.wasActive);\n            TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(resourcesHolder.isolationLevel);\n            TransactionSynchronizationManager.setCurrentTransactionReadOnly(resourcesHolder.readOnly);\n            TransactionSynchronizationManager.setCurrentTransactionName(resourcesHolder.name);\n            //\u6062\u590dsuspendedSynchronizations\n            doResumeSynchronization(suspendedSynchronizations);\n        }\n    }\n}\n\nprotected void doResume(@Nullable Object transaction, Object suspendedResources) {\n    //\u5c31\u662f\u518d\u7ed1\u5b9a\u4e00\u4e0bConnectionHolder\n    TransactionSynchronizationManager.bindResource(obtainDataSource(), suspendedResources);\n}\n")),(0,r.kt)("h2",{id:"\u7591\u95ee\u89e3\u7b54"},"\u7591\u95ee\u89e3\u7b54"),(0,r.kt)("h2",{id:"newtransaction-\u548c-newsynchronization-\u6807\u8bb0\u7684\u8054\u7cfb"},"newTransaction \u548c newSynchronization \u6807\u8bb0\u7684\u8054\u7cfb"),(0,r.kt)("p",null,"\u5173\u4e8e\u8fd9\u4e24\u4e2a\u6807\u8bb0\u7684\u542b\u4e49\u5728\u4e4b\u524d\u4e8b\u52a1\u6587\u7ae0\u5305\u62ec\u672c\u6587\u4e2d\u90fd\u6ca1\u6709\u7279\u522b\u8fdb\u884c\u533a\u5206\uff0c\u8fd9\u91cc\u8be6\u7ec6\u8bf4\u660e\u4e00\u4e0b\u4e8c\u8005\u4e4b\u95f4\n\u7684\u8054\u7cfb\u548c\u533a\u522b\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"transactionSynchronization \u8868\u793a\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u9700\u8981\u540c\u6b65\u652f\u6301\uff0c\u8fd9\u91cc\u540c\u6b65\u6307\u662f\u5426\u4f7f\u7528ThreadLocal\u4fdd\n\u5b58\u5f53\u524d\u4e8b\u52a1\u6267\u884c\u4e0a\u4e0b\u6587\u7684\u4e8b\u52a1\u8d44\u6e90\u4fe1\u606f , \u5305\u62ec\u5728\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u5404\u4e2a\u540c\u6b65\u901a\u77e5\u70b9\u662f\u5426\u8fdb\u884c\u56de\u8c03\u901a\u77e5\u4e5f\u533a\u57df\u4e8e\u8be5\u6807\u5fd7\u662f\u5426\u4e3a\u771f")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public abstract class TransactionSynchronizationManager {\n    private static final ThreadLocal<Map<Object, Object>> resources =\n    new NamedThreadLocal<>("Transactional resources");\n    private static final ThreadLocal<Set<TransactionSynchronization>> synchronizations =\n    new NamedThreadLocal<>("Transaction synchronizations");\n    private static final ThreadLocal<String> currentTransactionName =\n    new NamedThreadLocal<>("Current transaction name");\n    private static final ThreadLocal<Boolean> currentTransactionReadOnly =\n    new NamedThreadLocal<>("Current transaction read-only status");\n    private static final ThreadLocal<Integer> currentTransactionIsolationLevel =\n    new NamedThreadLocal<>("Current transaction isolation level");\n    private static final ThreadLocal<Boolean> actualTransactionActive =\n    new NamedThreadLocal<>("Actual transaction active");\n    ...\n}\n')),(0,r.kt)("p",null,"\u8be5\u6807\u5fd7\u5b58\u5728\u4e09\u4e2a\u53d6\u503c:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SYNCHRONIZATION_ALWAYS"),": \u4e0d\u7ba1\u662f\u6b63\u5e38\u4e8b\u52a1\u6267\u884c\uff0c\u8fd8\u662f\u65e0\u9700\u4e8b\u52a1\u6267\u884c\uff0c\u8fd8\u662f\u5d4c\u5957\u4e8b\u52a1\u6267\u884c\uff0c\u4f7f\u7528\u5f00\u542f\u4e8b\u52a1\u540c\u6b65\u529f\u80fd"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SYNCHRONIZATION_ON_ACTUAL_TRANSACTION"),": \u5bf9\u4e8e\u65e0\u9700\u4e8b\u52a1\u6267\u884c\u7684\u573a\u666f\uff0c\u5219\u4e0d\u5f00\u542f\u4e8b\u52a1\u540c\u6b65\u529f\u80fd"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SYNCHRONIZATION_NEVER"),": \u4e0d\u7ba1\u4ec0\u4e48\u573a\u666f\u90fd\u4e0d\u5f00\u542f\u4e8b\u52a1\u540c\u6b65\u529f\u80fd")),(0,r.kt)("p",null,"\u8be5\u6807\u8bb0\u4fdd\u5b58\u5728AbstractPlatformTransactionManager\u7c7b\u4e2d\uff0c\u9ed8\u8ba4\u503c\u4e3a\u59cb\u7ec8\u5f00\u542f:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"private int transactionSynchronization = SYNCHRONIZATION_ALWAYS;\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"newSynchronization\u4fdd\u5b58\u5728DefaultTransactionStatus\u4e2d\uff0c\u7528\u4e8e\u8868\u793a\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u9700\u8981\u4e8b\u52a1\u540c\u6b65\u529f\u80fd\u652f\u6301\uff0c\u8be5\u503c\u9ed8\u8ba4\u53ea\u6709true or false \uff0c \u5177\u4f53\u53d6\u503c\u53d6\u51b3\u4e8e\u5f53\u524d\u4e8b\u52a1\u4f20\u64ad\u884c\u4e3a\u3002"),(0,r.kt)("li",{parentName:"ul"},"newTransaction\u4fdd\u5b58\u5728DefaultTransactionStatus\u4e2d\uff0c\u7528\u4e8e\u8868\u793a\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u4e3a\u65b0\u4e8b\u52a1\uff0c\u53ea\u6709\u5f53\u524d\u65e0\u9700\u4e8b\u52a1\u652f\u6301\u6216\u8005\u4e3a\u5d4c\u5957\u4e8b\u52a1\u7684\u5185\u4e8b\u52a1\u65f6\uff0c\u8be5\u503c\u624d\u4f1a\u4e3afalse,\u5426\u5219\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u90fd\u4e3atrue\uff0c\u5177\u4f53\u53d6\u503c\u8fd8\u662f\u53d6\u51b3\u4e8e\u5f53\u524d\u4e8b\u52a1\u4f20\u64ad\u884c\u4e3a\u3002",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u53ea\u6709\u8be5\u503c\u4e3atrue\u65f6\uff0c\u624d\u4f1a\u6267\u884c\u8fde\u63a5\u5efa\u7acb\uff0c\u4e8b\u52a1\u63d0\u4ea4\uff0c\u4e8b\u52a1\u56de\u6eda\uff0c\u91ca\u653e\u8fde\u63a5\u8d44\u6e90\u7b49\u64cd\u4f5c"),(0,r.kt)("li",{parentName:"ul"},"\u5f53\u524d\u6ca1\u6709\u4e8b\u52a1\u7684\u60c5\u51b5\u4e0b\uff0c\u5e76\u4e14\u5f53\u524d\u4e8b\u52a1\u4f20\u64ad\u884c\u4e3a\u4e0d\u8981\u6c42\u8fd0\u884c\u5728\u4e8b\u52a1\u72b6\u6001\u4e0b\u65f6\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a\u7a7a\u4e8b\u52a1\u8fd0\u884c")))),(0,r.kt)("p",null,"\u4e0b\u9762\u7ed3\u5408\u4e8b\u52a1\u7684\u4f20\u64ad\u884c\u4e3a\u770b\u770b\u4ee5\u4e0a\u4e24\u4e2a\u6807\u8bb0\u5206\u522b\u4f1a\u53d6\u4f55\u503c:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"PROPAGATION_REQUIRED"),": \u5982\u679c\u5f53\u524d\u5b58\u5728\u4e00\u4e2a\u4e8b\u52a1,\u5219\u52a0\u5165\u5f53\u524d\u4e8b\u52a1,\u5982\u679c\u4e0d\u5b58\u5728\u4efb\u4f55\u4e8b\u52a1,\u5219\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u4e8b\u52a1\u3002\u603b\u4e4b,\u8981\u81f3\u5c11\u786e\u4fdd\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u8fd0\u884c\u3002\u5e76\u4e14\u6b64\u4f20\u64ad\u884c\u4e3a\u4e5f\u662f\u9ed8\u8ba4\u7684\u4e8b\u52a1\u4f20\u64ad\u884c\u4e3a\u3002"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = false")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"PROPAGATION_SUPPORTS"),": \u5982\u679c\u5f53\u524d\u5b58\u5728\u4e00\u4e2a\u4e8b\u52a1,\u5219\u52a0\u5165\u5f53\u524d\u4e8b\u52a1,\u5982\u679c\u4e0d\u5b58\u5728\u4e8b\u52a1\uff0c\u5219\u76f4\u63a5\u6267\u884c\u3002\u5bf9\u4e8e\u4e00\u4e9b\u67e5\u8be2\u65b9\u6cd5\u6765\u8bf4\uff0cPROPAGATION_SUPPORTS\u901a\u8fc7\u662f\u6bd4\u8f83\u5408\u9002\u7684\u4f20\u64ad\u884c\u4e3a\u9009\u62e9\u3002"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = false")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = false")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization == SYNCHRONIZATION_ALWAYS")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"PROPAGATION_MANDATORY"),": \u5f3a\u5236\u8981\u6c42\u5f53\u524d\u5b58\u5728\u4e00\u4e2a\u4e8b\u52a1,\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u629b\u51fa\u5f02\u5e38\u3002\u5982\u679c\u67d0\u4e2a\u65b9\u6cd5\u9700\u8981\u4e8b\u52a1\u652f\u6301\uff0c\u4f46\u81ea\u8eab\u53c8\u4e0d\u7ba1\u7406\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\uff0c\u90a3\u4e48\u6bd4\u8f83\u9002\u5408\nPROPAGATION_MANDATORY\u3002"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = false")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: \u629b\u51fa\u5f02\u5e38"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"PROPAGATION_REQUIRES_NEW"),": \u4e0d\u7ba1\u5f53\u524d\u662f\u5426\u5b58\u5728\u4e8b\u52a1,\u90fd\u4f1a\u521b\u5efa\u65b0\u7684\u4e8b\u52a1\u3002\u5982\u679c\u5f53\u524d\u5b58\u5728\u4e8b\u52a1\uff0c\u4f1a\u5c06\u5f53\u524d\u4e8b\u52a1\u6302\u8d77\u3002"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"PROPAGATION_NOT_SUPPORTED"),": \u4e0d\u652f\u6301\u5f53\u524d\u4e8b\u52a1\uff0c\u800c\u662f\u5728\u6ca1\u6709\u4e8b\u52a1\u7684\u60c5\u51b5\u4e0b\u624d\u4f1a\u6267\u884c,\u5982\u679c\u5f53\u524d\u5b58\u5728\u4e8b\u52a1\uff0c\u5f53\u524d\u4e8b\u52a1\u4f1a\u88ab\u6302\u8d77"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = false")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization == SYNCHRONIZATION_ALWAYS")),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization == SYNCHRONIZATION_ALWAYS")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"PROPAGATION_NEVER"),": \u6c38\u8fdc\u4e0d\u9700\u8981\u5f53\u524d\u5b58\u5728\u4e8b\u52a1,\u5982\u679c\u5b58\u5728\u4e8b\u52a1\uff0c\u5219\u629b\u51fa\u5f02\u5e38\u3002"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1: \u629b\u51fa\u5f02\u5e38"),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization == SYNCHRONIZATION_ALWAYS")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"PROPAGATION_NESTED\uff1a\u5982\u679c\u5b58\u5728\u5f53\u524d\u4e8b\u52a1\uff0c\u5219\u5728\u5f53\u524d\u4e8b\u52a1\u7684\u4e00\u4e2a\u5d4c\u5957\u4e8b\u52a1\u4e2d\u6267\u884c\uff0c\u5426\u5219\u4e0ePROPAGATION_REQUIRED\u884c\u4e3a\u7c7b\u4f3c\uff0c\u5373\u521b\u5efa\u65b0\u4e8b\u52a1\uff0c\u5728\u65b0\u521b\u5efa\u7684\u4e8b\u52a1\u4e2d\u6267\u884c\u3002"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5b58\u5728\u4e8b\u52a1:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u652f\u6301savepoint: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = false")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = false")),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u652f\u6301savepoint,\u91c7\u7528\u5d4c\u5957commit/rollback\u8c03\u7528: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER")))),(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u5b58\u5728\u4e8b\u52a1: ",(0,r.kt)("inlineCode",{parentName:"li"},"newTransaction = true")," , ",(0,r.kt)("inlineCode",{parentName:"li"},"newSynchronization = transactionSynchronization != SYNCHRONIZATION_NEVER"))))),(0,r.kt)("p",null,"\u5f53\u524d\u4e0d\u5b58\u5728\u4e8b\u52a1\u65f6\uff0c\u5bf9\u4e8e\u9700\u8981\u65e0\u4e8b\u52a1\u8fd0\u884c\u7684\u4f20\u64ad\u884c\u4e3a\uff0c\u4f1a\u5c06",(0,r.kt)("inlineCode",{parentName:"p"},"newTransaction"),"\u6807\u8bb0\u8bbe\u7f6e\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"true"),"\uff0c\u6765\u521b\u5efa\u4e00\u4e2a\u7a7a\u4e8b\u52a1\u3002"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u672c\u6587\u5305\u62ec\u6574\u4e2a\u4e8b\u52a1\u7cfb\u5217\u6587\u7ae0\u5bf9\u8fd9\u4e24\u4e2a\u6807\u8bb0\u90fd\u6ca1\u6709\u8fdb\u884c\u8be6\u7ec6\u8bf4\u660e\uff0c\u5927\u5bb6\u770b\u5b8c\u672c\u8282\u540e\uff0c\u53ef\u518d\u6b21\u9605\u8bfb\u76f8\u5173\u6587\u7ae0\u6216\u8005\u6e90\u7801\u8fdb\u884c\u56de\u770b\u3002")),(0,r.kt)("h2",{id:"\u8fde\u63a5\u662f\u5426\u4f1a\u88ab\u91ca\u653e\u662f\u5426\u5f71\u54cd\u4e3b\u7ebf\u7a0b\u4e8b\u52a1\u5c5e\u6027"},"\u8fde\u63a5\u662f\u5426\u4f1a\u88ab\u91ca\u653e\uff0c\u662f\u5426\u5f71\u54cd\u4e3b\u7ebf\u7a0b\u4e8b\u52a1\u5c5e\u6027"),(0,r.kt)("h3",{id:"\u7b2c\u4e00\u4e2a\u95ee\u9898-\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u662f\u5426\u4f1a\u91ca\u653e\u8fde\u63a5"},"\u7b2c\u4e00\u4e2a\u95ee\u9898: \u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u662f\u5426\u4f1a\u91ca\u653e\u8fde\u63a5"),(0,r.kt)("p",null,"\u7b54:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u6700\u7ec8\u90fd\u4f1a\u8c03\u7528cleanupAfterCompletion\u65b9\u6cd5\u6e05\u7406\u4e8b\u52a1\u76f8\u5173\u8d44\u6e90\u4fe1\u606f\uff0c\u8be5\u65b9\u6cd5\u4e2d\u4f1a\u5b8c\u6210\u8fde\u63a5\u7684\u91ca\u653e\u903b\u8f91")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'private void cleanupAfterCompletion(DefaultTransactionStatus status) {\n    //\u8bb0\u5f55\u4e8b\u52a1\u8fdb\u884c\u7684\u72b6\u6001\u4e3a\u5df2\u5b8c\u6210\n    status.setCompleted();\n    // \u6e05\u7406\u4e0e\u5f53\u524d\u4e8b\u52a1\u76f8\u5173\u7684TransactionSynchronization\n    if (status.isNewSynchronization()) {\n        TransactionSynchronizationManager.clear();\n    }\n    //\u91ca\u653e\u4e8b\u52a1\u8d44\u6e90,\u5e76\u89e3\u9664TransactionSynchronizationManager\u7684\u8d44\u6e90\u7ed1\u5b9a\n    //\u5bf9\u4e8eDataSourceTransactionManager\u6765\u8bf4\u662f\u5173\u95ed\u6570\u636e\u5e93\u8fde\u63a5\uff0c\u7136\u540e\u89e3\u9664Datasource\u5bf9\u8d44\u6e90\u7684\u7ed1\u5b9a\n    if (status.isNewTransaction()) {\n        doCleanupAfterCompletion(status.getTransaction());\n    }\n    //\u5982\u679c\u4e4b\u524d\u6709\u6302\u8d77\u7684\u4e8b\u52a1\uff0c\u6062\u590d\u6302\u8d77\u7684\u4e8b\u52a1\n    if (status.getSuspendedResources() != null) {\n        if (status.isDebug()) {\n            logger.debug("Resuming suspended transaction after completion of inner transaction");\n        }\n        Object transaction = (status.hasTransaction() ? status.getTransaction() : null);\n        resume(transaction, (SuspendedResourcesHolder) status.getSuspendedResources());\n    }\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u76f8\u5173\u6807\u8bb0\u5224\u65ad\u7684\u542b\u4e49\u6b64\u5904\u4e0d\u518d\u591a\u8bf4\uff0c\u5927\u5bb6\u5148\u81ea\u884c\u56de\u5fc6\uff0c\u5fd8\u8bb0\u4e86\uff0c\u518d\u56de\u770b\u4e0a\u4e2a\u95ee\u9898\u8fdb\u884c\u590d\u4e60")),(0,r.kt)("p",null,"doCleanupAfterCompletion\u51fd\u6570\u8d1f\u8d23\u5b8c\u6210\u8fde\u63a5\u76f8\u5173\u5c5e\u6027\u7684\u91cd\u7f6e\u4e0e\u8fde\u63a5\u91ca\u653e:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'protected void doCleanupAfterCompletion(Object transaction) {\n    DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;\n    // Remove the connection holder from the thread, if exposed.\n    // \u5f53\u524dConnectioHolder\u5982\u679c\u5185\u90e8\u8fd8\u6301\u6709Connection,\u5219\u8fdb\u884c\u8d44\u6e90\u89e3\u7ed1,\u63a5\u89e6<DataSource,Connection>\u6620\u5c04\u5173\u7cfb\n    if (txObject.isNewConnectionHolder()) {\n        TransactionSynchronizationManager.unbindResource(obtainDataSource());\n    }\n    // Reset connection.\n    // \u91cd\u7f6e\u94fe\u63a5\u76f8\u5173\u5c5e\u6027 -- txObject\u4e2d\u4fdd\u5b58\u4e2d\u5f00\u542f\u5f53\u524d\u4e8b\u52a1\u524d\uff0c\u8be5\u8fde\u63a5\u76f8\u5173\u5c5e\u6027\u8bbe\u7f6e\n    Connection con = txObject.getConnectionHolder().getConnection();\n    try {\n        // \u6062\u590d\u5148\u524d\u8be5\u8fde\u63a5\u7684\u76f8\u5173\u5c5e\u6027\u8bbe\u7f6e\n        if (txObject.isMustRestoreAutoCommit()) {\n            con.setAutoCommit(true);\n        }\n        DataSourceUtils.resetConnectionAfterTransaction(\n            con, txObject.getPreviousIsolationLevel(), txObject.isReadOnly());\n    } catch (Throwable ex) {\n        logger.debug("Could not reset JDBC Connection after transaction", ex);\n    }\n    // \u91ca\u653e\u8fde\u63a5\n    if (txObject.isNewConnectionHolder()) {\n        if (logger.isDebugEnabled()) {\n            logger.debug("Releasing JDBC Connection [" + con + "] after transaction");\n        }\n        DataSourceUtils.releaseConnection(con, this.dataSource);\n    }\n    // \u6e05\u7a7aConnectionHolder\u4e2d\u4fdd\u5b58\u7684\u76f8\u5173\u8fde\u63a5\u4fe1\u606f\n    txObject.getConnectionHolder().clear();\n}\n')),(0,r.kt)("p",null,"releaseConnection\u51fd\u6570\u771f\u6b63\u8d1f\u8d23\u5b8c\u6210\u8fde\u63a5\u91ca\u653e\u903b\u8f91:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public static void doReleaseConnection(@Nullable Connection con, @Nullable DataSource dataSource) throws SQLException {\n    if (con == null) {\n        return;\n    }\n    if (dataSource != null) {\n        // <datasource,connectionholder> \u6839\u636e\u6570\u636e\u6e90\u4f5c\u4e3akey,\u53d6\u51fa\u5f53\u524d\u7ebf\u7a0b\u901a\u8fc7\u8be5\u6570\u636e\u6e90\u5efa\u7acb\u7684\u8fde\u63a5\n        // \u5982\u679c\u662fnewTransaction=false\u7684\u573a\u666f,\u90a3\u4e48\u4f1a\u8df3\u8fc7doCleanupAfterCompletion\u51fd\u6570\u4e00\u5f00\u59cb\u7684\u89e3\u7ed1\u884c\u4e3a\n        // \u6b64\u65f6\u8fd8\u662f\u53ef\u4ee5\u6839\u636eDataSource\u53d6\u51fa\u5bf9\u5e94\u7684connectionHolder\u7684\n        ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getR\n        esource(dataSource);\n        if (conHolder != null && connectionEquals(conHolder, con)) {\n            // It's the transactional Connection: Don't close it.\n            // \u9012\u51cfconnectionHolder\u5185\u90e8\u7684\u5f15\u7528\u8ba1\u6570\uff0c\u5f53\u4e3a0\u7684\u65f6\u5019,\u5c06connectionHolder\u4e0econnection\u89e3\u7ed1\n            // \u4f46\u662fconnection\u8fde\u63a5\u4e0d\u4e3b\u52a8\u5173\u95ed\n            conHolder.released();\n            return;\n        }\n    }\n    // \u6b63\u5e38\u60c5\u51b5\u4e0b,newTransaction=true\u65f6\u5173\u95ed\u8fde\u63a5\n    doCloseConnection(con, dataSource);\n}\n")),(0,r.kt)("p",null,"connectionHolder\u7684\u91ca\u653e\u8fde\u63a5\u65b9\u6cd5:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public void released() {\n    // \u9012\u51cf\u5f15\u7528\u8ba1\u6570\n    super.released();\n    // \u5f15\u7528\u8ba1\u6570\u4e3a0\u5e76\u4e14\u5185\u90e8\u6301\u6709connection\u7684\u524d\u63d0\u4e0b\n    if (!isOpen() && this.currentConnection != null) {\n        if (this.connectionHandle != null) {\n            this.connectionHandle.releaseConnection(this.currentConnection);\n        }\n        // \u63a5\u89e6connectionHolder\u4e0econnection\u7684\u7ed1\u5b9a\u5173\u7cfb\n        this.currentConnection = null;\n    }\n}\n")),(0,r.kt)("p",null,"\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u4f1a\u5728\u4e8b\u52a1\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u65f6\u91ca\u653e\u8fde\u63a5:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public static void doCloseConnection(Connection con, @Nullable DataSource dataSource) throws SQLException {\n    if (!(dataSource instanceof SmartDataSource) || ((SmartDataSource) dataSource).shouldClose(con)) {\n        con.close();\n    }\n}\n")),(0,r.kt)("h3",{id:"\u95ee\u9898\u4e8c-multiplythreadtransactionmanager\u901a\u8fc7\u5f00\u8f9f\u5b50\u7ebf\u7a0b\u4f9d\u6b21\u6267\u884c\u5404\u4e2a\u5b50\u4efb\u52a1\u6700\u540e\u5728\u6240\u6709\u5b50\u4efb\u52a1"},"\u95ee\u9898\u4e8c: MultiplyThreadTransactionManager\u901a\u8fc7\u5f00\u8f9f\u5b50\u7ebf\u7a0b\u4f9d\u6b21\u6267\u884c\u5404\u4e2a\u5b50\u4efb\u52a1\uff0c\u6700\u540e\u5728\u6240\u6709\u5b50\u4efb\u52a1"),(0,r.kt)("p",null,"\u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u4f9d\u6b21\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u6bcf\u4e2a\u5b50\u4e8b\u52a1\uff0c\u63d0\u4ea4\u548c\u56de\u6eda\u8fc7\u7a0b\u4e2d\u9700\u8981\u5c06\u5b50\u7ebf\u7a0b\u4e8b\u52a1\u4fe1\u606fcopy\u5230\u4e3b\u7ebf\u7a0b\u7684threadLocal\u4e2d\uff0c\u6b64\u65f6\u5982\u679c\u4e3b\u7ebf\u7a0b\u4e5f\u9700\u8981\u4e8b\u52a1\u7ba1\u7406\uff0c\u540c\u6837\u9700\u8981\u4f7f\u7528threadlocal,\u662f\u5426\u5b58\u5728\u95ee\u9898 ?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4fdd\u9669\u8d77\u89c1\uff0c\u53ef\u4ee5\u5728\u6700\u540e\u4f9d\u6b21\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u6bcf\u4e2a\u5b50\u4e8b\u52a1\u524d\uff0c\u4fdd\u5b58\u4e3b\u7ebf\u7a0b\u7684\u76f8\u5173\u4e8b\u52a1\u4e0a\u4e0b\u6587\u4fe1\n\u606f\uff0c\u6700\u540e\u518d\u8fdb\u884c\u6062\u590d\u5373\u53ef")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"TransactionResource transactionResource = TransactionResource.copyTransactionResource();\nTransactionSynchronizationManager.clear();\nTransactionSynchronizationManager.unbindResource(dataSource);\nfor (int i = 0; i < tasks.size(); i++) {\n    transactionResources.get(i).autoWiredTransactionResource();\n    transactionManager.rollback(transactionStatusList.get(i));\n    transactionResources.get(i).removeTransactionResource();\n}\ntransactionResource.autoWiredTransactionResource();\n")),(0,r.kt)("h2",{id:"\u5c0f\u7ed3"},"\u5c0f\u7ed3"),(0,r.kt)("p",null,"\u672c\u6587\u7ed9\u51fa\u7684\u53ea\u662f\u4e00\u4e2a\u65b9\u6cd5\uff0c\u4e3a\u4e86\u5b9e\u73b0\u591a\u7ebf\u7a0b\u4e8b\u52a1\u4e00\u81f4\u6027\uff0c\u6211\u4eec\u8fd8\u6709\u5f88\u591a\u65b9\u6cd5\uff0c\u4f8b\u5982\u548c\u672c\u6587\u4e00\u6837\u7684\u601d\u60f3\uff0c\u76f4\u63a5\u5229\u7528JDBC\u63d0\u4f9b\u7684API\u6765\u624b\u52a8\u63a7\u5236\u4e8b\u52a1\u63d0\u4ea4\u548c\u56de\u6eda\uff0c\u6216\u8005\u53ef\u4ee5\u5c1d\u8bd5\u91c7\u7528\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u601d\u8def\u6765\u89e3\u51b3\u95ee\u9898\u3002"),(0,r.kt)("p",null,"\u5927\u5bb6\u4e4b\u6240\u4ee5\u4f1a\u88ab\u8fd9\u4e2a\u95ee\u9898\u96be\u4f4f\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u5bf9Spring\u6846\u67b6\u63d0\u4f9b\u7684\u4fbf\u6377\u58f0\u660e\u5f0f\u4e8b\u52a1\u652f\u6301\u4e2d\u6bd2\u592a\u6df1\uff0c\u4ee5\u81f3\u4e8e\u8111\u6d77\u4e2d\u5bf9\u4e8b\u52a1\u7684\u8ba4\u77e5\u5b8c\u5168\u505c\u7559\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"@Transactional"),"\u6ce8\u89e3\u7684\u5c42\u9762\uff0c\u591a\u4e86\u89e3\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\uff0c\u624d\u80fd\u505a\u5230\u9047\u4e8b\u4e0d\u614c\u3002"))}d.isMDXComponent=!0}}]);