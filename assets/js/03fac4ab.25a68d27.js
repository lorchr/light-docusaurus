"use strict";(self.webpackChunklight_docusaurus=self.webpackChunklight_docusaurus||[]).push([[3412],{3905:(e,n,t)=>{t.d(n,{Zo:()=>o,kt:()=>m});var l=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);n&&(l=l.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,l)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,l,a=function(e,n){if(null==e)return{};var t,l,a={},r=Object.keys(e);for(l=0;l<r.length;l++)t=r[l],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(l=0;l<r.length;l++)t=r[l],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=l.createContext({}),u=function(e){var n=l.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},o=function(e){var n=u(e.components);return l.createElement(s.Provider,{value:n},e.children)},c="mdxType",k={inlineCode:"code",wrapper:function(e){var n=e.children;return l.createElement(l.Fragment,{},n)}},d=l.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,o=p(e,["components","mdxType","originalType","parentName"]),c=u(t),d=a,m=c["".concat(s,".").concat(d)]||c[d]||k[d]||r;return t?l.createElement(m,i(i({ref:n},o),{},{components:t})):l.createElement(m,i({ref:n},o))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,i=new Array(r);i[0]=d;var p={};for(var s in n)hasOwnProperty.call(n,s)&&(p[s]=n[s]);p.originalType=e,p[c]="string"==typeof e?e:a,i[1]=p;for(var u=2;u<r;u++)i[u]=t[u];return l.createElement.apply(null,i)}return l.createElement.apply(null,t)}d.displayName="MDXCreateElement"},26406:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>k,frontMatter:()=>r,metadata:()=>p,toc:()=>u});var l=t(87462),a=(t(67294),t(3905));const r={},i=void 0,p={unversionedId:"nginx/Nginx-From-Install-to-HA",id:"nginx/Nginx-From-Install-to-HA",title:"Nginx-From-Install-to-HA",description:"Nginx \u4ece\u5b89\u88c5\u5230\u9ad8\u53ef\u7528",source:"@site/middleware/nginx/1-Nginx-From-Install-to-HA.md",sourceDirName:"nginx",slug:"/nginx/Nginx-From-Install-to-HA",permalink:"/light-docusaurus/middleware/nginx/Nginx-From-Install-to-HA",draft:!1,editUrl:"https://github.com/lorchr/light-docusaurus/tree/main/middleware/nginx/1-Nginx-From-Install-to-HA.md",tags:[],version:"current",lastUpdatedBy:"liuhui",lastUpdatedAt:1701654489,formattedLastUpdatedAt:"2023\u5e7412\u67084\u65e5",sidebarPosition:1,frontMatter:{},sidebar:"middleware",previous:{title:"Nginx",permalink:"/light-docusaurus/middleware/category/nginx"},next:{title:"Ningx-Getting-Start",permalink:"/light-docusaurus/middleware/nginx/Ningx-Getting-Start"}},s={},u=[{value:"1. Nginx\u5b89\u88c5",id:"1-nginx\u5b89\u88c5",level:2},{value:"2. \u914d\u7f6e\u53cd\u5411\u4ee3\u7406",id:"2-\u914d\u7f6e\u53cd\u5411\u4ee3\u7406",level:2},{value:"3. \u914d\u7f6e\u8d1f\u8f7d\u5747\u8861",id:"3-\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861",level:2},{value:"1\u3001\u4f7f\u7528\u52a0\u6743\u8f6e\u8be2",id:"1\u4f7f\u7528\u52a0\u6743\u8f6e\u8be2",level:3},{value:"2\u3001hash\u8d1f\u8f7d\u5747\u8861",id:"2hash\u8d1f\u8f7d\u5747\u8861",level:3},{value:"3\u3001url hash\u8d1f\u8f7d\u5747\u8861",id:"3url-hash\u8d1f\u8f7d\u5747\u8861",level:3},{value:"4\u3001\u6700\u5c0f\u8fde\u63a5\u8d1f\u8f7d\u5747\u8861",id:"4\u6700\u5c0f\u8fde\u63a5\u8d1f\u8f7d\u5747\u8861",level:3},{value:"4. upstream\u6307\u4ee4\u53c2\u6570",id:"4-upstream\u6307\u4ee4\u53c2\u6570",level:2},{value:"1\u3001keepalived",id:"1keepalived",level:3},{value:"2\u3001\u63a7\u5236\u6d4f\u89c8\u5668\u7f13\u5b58",id:"2\u63a7\u5236\u6d4f\u89c8\u5668\u7f13\u5b58",level:3},{value:"3\u3001\u53cd\u5411\u4ee3\u7406\u7f13\u5b58",id:"3\u53cd\u5411\u4ee3\u7406\u7f13\u5b58",level:3},{value:"5. \u914d\u7f6essl\u8bc1\u4e66\u63d0\u4f9bhttps\u8bbf\u95ee",id:"5-\u914d\u7f6essl\u8bc1\u4e66\u63d0\u4f9bhttps\u8bbf\u95ee",level:2},{value:"1. \u5b89\u88c5SSL\u6a21\u5757",id:"1-\u5b89\u88c5ssl\u6a21\u5757",level:3},{value:"2\u3001\u914d\u7f6eHTTPS",id:"2\u914d\u7f6ehttps",level:3},{value:"6. \u914d\u7f6eHA Nginx",id:"6-\u914d\u7f6eha-nginx",level:2},{value:"1\u3001\u5b89\u88c5keepalived",id:"1\u5b89\u88c5keepalived",level:3},{value:"2\u3001\u914d\u7f6ekeepalived \u4e3b\u673a",id:"2\u914d\u7f6ekeepalived-\u4e3b\u673a",level:3},{value:"3\u3001\u628akeepalived\u6ce8\u518c\u4e3a\u7cfb\u7edf\u670d\u52a1",id:"3\u628akeepalived\u6ce8\u518c\u4e3a\u7cfb\u7edf\u670d\u52a1",level:3},{value:"4\u3001\u5b9e\u73b0\u53cc\u673a\u4e3b\u5907\u9ad8\u53ef\u7528",id:"4\u5b9e\u73b0\u53cc\u673a\u4e3b\u5907\u9ad8\u53ef\u7528",level:2},{value:"5\u3001keepalived\u914d\u7f6enginx\u81ea\u52a8\u91cd\u542f",id:"5keepalived\u914d\u7f6enginx\u81ea\u52a8\u91cd\u542f",level:3},{value:"6\u3001keepalived\u53cc\u4e3b\u70ed\u5907",id:"6keepalived\u53cc\u4e3b\u70ed\u5907",level:3},{value:"7. LVS\uff08Linux Virtual Server\uff09\u5b9e\u73b0\u9ad8\u53ef\u7528\u8d1f\u8f7d\u5747\u8861",id:"7-lvslinux-virtual-server\u5b9e\u73b0\u9ad8\u53ef\u7528\u8d1f\u8f7d\u5747\u8861",level:2},{value:"1\u3001\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528LVS+Nginx",id:"1\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528lvsnginx",level:3},{value:"2\u3001LVS\u7684\u4e09\u79cd\u6a21\u5f0f",id:"2lvs\u7684\u4e09\u79cd\u6a21\u5f0f",level:3},{value:"3\u3001\u642d\u5efaLVS-DR\u6a21\u5f0f",id:"3\u642d\u5efalvs-dr\u6a21\u5f0f",level:3},{value:"\u9644\uff1aLVS\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5",id:"\u9644lvs\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5",level:2},{value:"(1)\u9759\u6001\u7b97\u6cd5",id:"1\u9759\u6001\u7b97\u6cd5",level:3},{value:"(2)\u52a8\u6001\u7b97\u6cd5",id:"2\u52a8\u6001\u7b97\u6cd5",level:3},{value:"8. \u642d\u5efaKeepalived+Lvs+Nginx\u9ad8\u53ef\u7528\u96c6\u7fa4\u8d1f\u8f7d\u5747\u8861",id:"8-\u642d\u5efakeepalivedlvsnginx\u9ad8\u53ef\u7528\u96c6\u7fa4\u8d1f\u8f7d\u5747\u8861",level:2},{value:"1. \u4f7f\u7528keepalived\u914d\u7f6eMaster LVS",id:"1-\u4f7f\u7528keepalived\u914d\u7f6emaster-lvs",level:3},{value:"2. \u4f7f\u7528keepalived\u914d\u7f6eBackup LVS",id:"2-\u4f7f\u7528keepalived\u914d\u7f6ebackup-lvs",level:3}],o={toc:u},c="wrapper";function k(e){let{components:n,...t}=e;return(0,a.kt)(c,(0,l.Z)({},o,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://mp.weixin.qq.com/s/3vLfd7xi8AsO3cRaEgREdQ"},"Nginx \u4ece\u5b89\u88c5\u5230\u9ad8\u53ef\u7528")),(0,a.kt)("h2",{id:"1-nginx\u5b89\u88c5"},"1. Nginx\u5b89\u88c5"),(0,a.kt)("p",null,"1\u3001\u53bb",(0,a.kt)("a",{parentName:"p",href:"http://nginx.org/"},"\u5b98\u7f51"),"\u4e0b\u8f7d\u5bf9\u5e94\u7684nginx\u5305\uff0c\u63a8\u8350\u4f7f\u7528\u7a33\u5b9a\u7248\u672c\n2\u3001\u4e0a\u4f20nginx\u5230linux\u7cfb\u7edf\n3\u3001\u5b89\u88c5\u4f9d\u8d56\u73af\u5883"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# \u5b89\u88c5gcc\u73af\u5883\nyum install gcc-c++\n\n# \u5b89\u88c5PCRE\u5e93\uff0c\u7528\u4e8e\u89e3\u6790\u6b63\u5219\u8868\u8fbe\u5f0f\nyum install -y pcre pcre-devel\n\n# zlib\u538b\u7f29\u548c\u89e3\u538b\u7f29\u4f9d\u8d56\nyum install -y zlib zlib-devel\n\n# SSL \u5b89\u5168\u7684\u52a0\u5bc6\u7684\u5957\u63a5\u5b57\u534f\u8bae\u5c42\uff0c\u7528\u4e8eHTTP\u5b89\u5168\u4f20\u8f93\uff0c\u4e5f\u5c31\u662fhttps\nyum install -y openssl openssl-devel\n")),(0,a.kt)("p",null,"4\u3001\u89e3\u538b\uff0c\u9700\u8981\u6ce8\u610f\uff0c\u89e3\u538b\u540e\u5f97\u5230\u7684\u662f\u6e90\u7801\uff0c\u6e90\u7801\u9700\u8981\u7f16\u8bd1\u540e\u624d\u80fd\u5b89\u88c5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"tar -zxvf nginx-1.16.1.tar.gz\n")),(0,a.kt)("p",null,"5\u3001\u7f16\u8bd1\u4e4b\u524d\uff0c\u5148\u521b\u5efanginx\u4e34\u65f6\u76ee\u5f55\uff0c\u5982\u679c\u4e0d\u521b\u5efa\uff0c\u5728\u542f\u52a8nginx\u7684\u8fc7\u7a0b\u4e2d\u4f1a\u62a5\u9519"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"mkdir /var/temp/nginx -p\n")),(0,a.kt)("p",null,"6\u3001\u5728nginx\u76ee\u5f55\uff0c\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u914d\u7f6e\uff0c\u76ee\u7684\u662f\u4e3a\u4e86\u521b\u5efamakefile\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-makefile"},"./configure \\   \n--prefix=/usr/local/nginx \\    \n--pid-path=/var/run/nginx/nginx.pid \\    \n--lock-path=/var/lock/nginx.lock \\    \n--error-log-path=/var/log/nginx/error.log \\    \n--http-log-path=/var/log/nginx/access.log \\    \n--with-http_gzip_static_module \\    \n--http-client-body-temp-path=/var/temp/nginx/client \\    \n--http-proxy-temp-path=/var/temp/nginx/proxy \\    \n--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \\    \n--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \\    \n--http-scgi-temp-path=/var/temp/nginx/scgi\n")),(0,a.kt)("p",null,"\u6ce8\uff1a\u4ee3\u8868\u5728\u547d\u4ee4\u884c\u4e2d\u6362\u884c\uff0c\u7528\u4e8e\u63d0\u9ad8\u53ef\u8bfb\u6027\u914d\u7f6e\u547d\u4ee4\uff1a"),(0,a.kt)("p",null,"7\u3001make\u7f16\u8bd1&\u5b89\u88c5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"make && make install\n")),(0,a.kt)("p",null,"8\u3001\u8fdb\u5165sbin\u76ee\u5f55\u542f\u52a8nginx"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# \u6821\u9a8c\u914d\u7f6e\u6587\u4ef6\n./nginx -t\n\n# \u542f\u52a8\n./nginx\n\n# \u505c\u6b62\n./nginx -s stop\n\n# \u91cd\u65b0\u52a0\u8f7d\n./nginx -s reload\n")),(0,a.kt)("h2",{id:"2-\u914d\u7f6e\u53cd\u5411\u4ee3\u7406"},"2. \u914d\u7f6e\u53cd\u5411\u4ee3\u7406"),(0,a.kt)("p",null,"1\u3001\u914d\u7f6eupstream"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"upstream [proxyName] {\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")),(0,a.kt)("p",null,"2\u3001\u914d\u7f6eserver"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n    listem  80;\n    server_name www.tomcats.com;\n\n    location / {\n        proxy_pass http://tomcats;\n    }\n}\n")),(0,a.kt)("h2",{id:"3-\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861"},"3. \u914d\u7f6e\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("p",null,"nginx\u9ed8\u8ba4\u91c7\u7528\u8f6e\u8bad\u7684\u65b9\u5f0f\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("h3",{id:"1\u4f7f\u7528\u52a0\u6743\u8f6e\u8be2"},"1\u3001\u4f7f\u7528\u52a0\u6743\u8f6e\u8be2"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"upstream [proxyName] {\n    server 192.168.1.173:8080 weight=1;\n    server 192.168.1.174:8080 weight=5;\n    server 192.168.1.175:8080 weight=2;\n}\n")),(0,a.kt)("h3",{id:"2hash\u8d1f\u8f7d\u5747\u8861"},"2\u3001hash\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"upstream [proxyName] {\n    ip_hash\n\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")),(0,a.kt)("p",null,"hash\u7b97\u6cd5\u5b9e\u9645\u4e0a\u53ea\u4f1a\u8ba1\u7b97 192.168.1\u8fd9\u6bb5\u505a\u54c8\u5e0c"),(0,a.kt)("p",null,"\u4f7f\u7528ip_hash\u7684\u6ce8\u610f\u70b9\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u4e0d\u80fd\u628a\u540e\u53f0\u670d\u52a1\u5668\u76f4\u63a5\u79fb\u9664\uff0c\u53ea\u80fd\u6807\u8bb0down.")),(0,a.kt)("h3",{id:"3url-hash\u8d1f\u8f7d\u5747\u8861"},"3\u3001url hash\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"upstream [proxyName] {\n    hash $request_url;\n\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")),(0,a.kt)("h3",{id:"4\u6700\u5c0f\u8fde\u63a5\u8d1f\u8f7d\u5747\u8861"},"4\u3001\u6700\u5c0f\u8fde\u63a5\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"upstream [proxyName] {\n    least_conn;\n\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")),(0,a.kt)("h2",{id:"4-upstream\u6307\u4ee4\u53c2\u6570"},"4. upstream\u6307\u4ee4\u53c2\u6570"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"max_conns\uff1a\u9650\u5236\u6700\u5927\u540c\u65f6\u8fde\u63a5\u6570 1.11.5\u4e4b\u524d\u53ea\u80fd\u7528\u4e8e\u5546\u4e1a\u7248"),(0,a.kt)("li",{parentName:"ul"},"slow_start\uff1a\u5355\u4f4d\u79d2\uff0c\u6743\u91cd\u5728\u6307\u5b9a\u65f6\u95f4\u5185\u4ece1\u4e0a\u5347\u5230\u6307\u5b9a\u503c\uff0c\u4e0d\u9002\u7528\u4e0ehash\u8d1f\u8f7d\u5747\u8861\u3001\u968f\u673a\u8d1f\u8f7d\u5747\u8861 \u5982\u679c\u5728 upstream \u4e2d\u53ea\u6709\u4e00\u53f0 server\uff0c\u5219\u8be5\u53c2\u6570\u5931\u6548\uff08\u5546\u4e1a\u7248\u624d\u6709\uff09"),(0,a.kt)("li",{parentName:"ul"},"down\uff1a\u7981\u6b62\u8bbf\u95ee"),(0,a.kt)("li",{parentName:"ul"},"backup\uff1a\u5907\u7528\u673a \u53ea\u6709\u5728\u5176\u4ed6\u670d\u52a1\u5668\u65e0\u6cd5\u8bbf\u95ee\u7684\u65f6\u5019\u624d\u80fd\u8bbf\u95ee\u5230 \u4e0d\u9002\u7528\u4e0ehash\u8d1f\u8f7d\u5747\u8861\u3001\u968f\u673a\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("li",{parentName:"ul"},"max_fails\uff1a\u8868\u793a\u5931\u8d25\u51e0\u6b21\uff0c\u5219\u6807\u8bb0server\u5df2\u5b95\u673a\uff0c\u5254\u51fa\u4e0a\u6e38\u670d\u52a1 \u9ed8\u8ba4\u503c1"),(0,a.kt)("li",{parentName:"ul"},"fail_timeout\uff1a\u8868\u793a\u5931\u8d25\u7684\u91cd\u8bd5\u65f6\u95f4 \u9ed8\u8ba4\u503c10")),(0,a.kt)("h3",{id:"1keepalived"},"1\u3001keepalived"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},'upstream [proxyName] {\n    server 192.168.1.173:8080 weight=1;\n    server 192.168.1.174:8080 weight=5;\n    server 192.168.1.175:8080 weight=2;\n\n    keepalive 32; #\u4fdd\u6301\u7684\u8fde\u63a5\u6570\n}\n\nserver {\n    listem  80;\n    server_name www.tomcats.com;\n\n    location / {\n        proxy_pass http://tomcats;\n        proxy_http_version 1.1; #\u8fde\u63a5\u7684\u534f\u8bae\u7248\u672c\n        proxy_set_header Connection ""; \u6e05\u7a7a\u8fde\u63a5\u8bf7\u6c42\u5934\n    }\n}\n')),(0,a.kt)("h3",{id:"2\u63a7\u5236\u6d4f\u89c8\u5668\u7f13\u5b58"},"2\u3001\u63a7\u5236\u6d4f\u89c8\u5668\u7f13\u5b58"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n    listem  80;\n    server_name www.tomcats.com;\n\n    location / {\n        proxy_pass http://tomcats;\n        expires 10s;  #\u6d4f\u89c8\u5668\u7f13\u5b5810\u79d2\u949f\n        #expires @22h30m  #\u5728\u665a\u4e0a10\u70b930\u7684\u65f6\u5019\u8fc7\u671f\n        #expires -1h  #\u7f13\u5b58\u5728\u4e00\u5c0f\u65f6\u524d\u65f6\u6548\n        #expires epoch  #\u4e0d\u8bbe\u7f6e\u7f13\u5b58\n        #expires off  #\u7f13\u5b58\u5173\u95ed\uff0c\u6d4f\u89c8\u5668\u81ea\u5df1\u63a7\u5236\u7f13\u5b58\n        #expires max  #\u6700\u5927\u8fc7\u671f\u65f6\u95f4\n    }\n}\n")),(0,a.kt)("h3",{id:"3\u53cd\u5411\u4ee3\u7406\u7f13\u5b58"},"3\u3001\u53cd\u5411\u4ee3\u7406\u7f13\u5b58"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"upstream [proxyName] {\n    server 192.168.1.173:8080 weight=1;\n    server 192.168.1.174:8080 weight=5;\n    server 192.168.1.175:8080 weight=2;\n}\n\n#proxy_cache_path \u8bbe\u7f6e\u7f13\u5b58\u4fdd\u5b58\u7684\u76ee\u5f55\u7684\u4f4d\u7f6e\n#keys_zone\u8bbe\u7f6e\u5171\u4eab\u5185\u4ee5\u53ca\u5360\u7528\u7684\u7a7a\u95f4\u5927\u5c0f\n#mas_size \u8bbe\u7f6e\u7f13\u5b58\u6700\u5927\u7a7a\u95f4\n#inactive \u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\uff0c\u9519\u8fc7\u6b64\u65f6\u95f4\u81ea\u52a8\u6e05\u7406\n#use_temp_path \u5173\u95ed\u96f6\u65f6\u76ee\u5f55\nproxy_cache_path /usr/local/nginx/upsteam_cache keys_zone=mycache:5m max_size=1g inactive=8h use_temp_path=off;\n\nserver {\n    listem  80;\n    server_name www.tomcats.com;\n    #\u5f00\u542f\u5e76\u4f7f\u7528\u7f13\u5b58\n    proxy_cache mycache;\n    #\u9488\u5bf9200\u548c304\u54cd\u5e94\u7801\u7684\u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\n    proxy_cache_valid 200 304 8h;   \n\n    location / {\n        proxy_pass http://tomcats;\n    }\n}\n")),(0,a.kt)("h2",{id:"5-\u914d\u7f6essl\u8bc1\u4e66\u63d0\u4f9bhttps\u8bbf\u95ee"},"5. \u914d\u7f6essl\u8bc1\u4e66\u63d0\u4f9bhttps\u8bbf\u95ee"),(0,a.kt)("h3",{id:"1-\u5b89\u88c5ssl\u6a21\u5757"},"1. \u5b89\u88c5SSL\u6a21\u5757"),(0,a.kt)("p",null,"\u8981\u5728nginx\u4e2d\u914d\u7f6ehttps\uff0c\u5c31\u5fc5\u987b\u5b89\u88c5ssl\u6a21\u5757\uff0c\u4e5f\u5c31\u662f: http_ssl_module\u3002"),(0,a.kt)("p",null,"\u8fdb\u5165\u5230nginx\u7684\u89e3\u538b\u76ee\u5f55\uff1a/home/software/nginx-1.16.1"),(0,a.kt)("p",null,"\u65b0\u589essl\u6a21\u5757(\u539f\u6765\u7684\u90a3\u4e9b\u6a21\u5757\u9700\u8981\u4fdd\u7559)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-makefile"},"./configure \\\n--prefix=/usr/local/nginx \\\n--pid-path=/var/run/nginx/nginx.pid \\\n--lock-path=/var/lock/nginx.lock \\\n--error-log-path=/var/log/nginx/error.log \\\n--http-log-path=/var/log/nginx/access.log \\\n--with-http_gzip_static_module \\\n--http-client-body-temp-path=/var/temp/nginx/client \\\n--http-proxy-temp-path=/var/temp/nginx/proxy \\\n--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \\\n--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \\\n--http-scgi-temp-path=/var/temp/nginx/scgi  \\\n--with-http_ssl_module\n")),(0,a.kt)("p",null,"\u7f16\u8bd1\u548c\u5b89\u88c5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"make && make install\n")),(0,a.kt)("h3",{id:"2\u914d\u7f6ehttps"},"2\u3001\u914d\u7f6eHTTPS"),(0,a.kt)("p",null,"\u628assl\u8bc1\u4e66 ",(0,a.kt)("em",{parentName:"p"},".crt \u548c \u79c1\u94a5 "),".key \u62f7\u8d1d\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/local/nginx/conf"),"\u76ee\u5f55\u4e2d\u3002"),(0,a.kt)("p",null,"\u65b0\u589e server \u76d1\u542c 443 \u7aef\u53e3\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n    listen       443;\n    server_name  www.imoocdsp.com;\n    # \u5f00\u542fssl\n    ssl     on;\n    # \u914d\u7f6essl\u8bc1\u4e66\n    ssl_certificate      1_www.imoocdsp.com_bundle.crt;\n    # \u914d\u7f6e\u8bc1\u4e66\u79d8\u94a5\n    ssl_certificate_key  2_www.imoocdsp.com.key;\n    # ssl\u4f1a\u8bddcache\n    ssl_session_cache    shared:SSL:1m;\n    # ssl\u4f1a\u8bdd\u8d85\u65f6\u65f6\u95f4\n    ssl_session_timeout  5m;\n    # \u914d\u7f6e\u52a0\u5bc6\u5957\u4ef6\uff0c\u5199\u6cd5\u9075\u5faa openssl \u6807\u51c6\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n    ssl_prefer_server_ciphers on;\n    \n    location / {\n        proxy_pass http://tomcats/;\n        index  index.html index.htm;\n    }\n}\n")),(0,a.kt)("h2",{id:"6-\u914d\u7f6eha-nginx"},"6. \u914d\u7f6eHA Nginx"),(0,a.kt)("h3",{id:"1\u5b89\u88c5keepalived"},"1\u3001\u5b89\u88c5keepalived"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# \u4e0b\u8f7d\nhttps://www.keepalived.org/download.html\n\n# \u89e3\u538b\ntar -zxvf keepalived-2.0.18.tar.gz\n\n# \u4f7f\u7528configure\u547d\u4ee4\u914d\u7f6e\u5b89\u88c5\u76ee\u5f55\u4e0e\u6838\u5fc3\u914d\u7f6e\u6587\u4ef6\u6240\u5728\u4f4d\u7f6e\uff1a\n./configure --prefix=/usr/local/keepalived --sysconf=/etc\n\n# \u5b89\u88c5keepalived\nmake && make install\n\n# \u914d\u7f6e\u6587\u4ef6 \u5728/etc/keepalived/keepalived.conf\n\n# \u5fd8\u8bb0\u5b89\u88c5\u914d\u7f6e\u7684\u76ee\u5f55\uff0c\u5219\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u627e\u5230\uff1a\nwhereis keepalived\n\n# \u542f\u52a8keepalived \u8fdb\u5165sbin\u76ee\u5f55\n./keepalived\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"prefix \uff1akeepalived\u5b89\u88c5\u7684\u4f4d\u7f6esysconf\uff1akeepalived\u6838\u5fc3\u914d\u7f6e\u6587\u4ef6\u6240\u5728\u4f4d\u7f6e\uff0c\u56fa\u5b9a\u4f4d\u7f6e\uff0c\u6539\u6210\u5176\u4ed6\u4f4d\u7f6e\u5219keepalived\u542f\u52a8\u4e0d\u4e86\uff0c/var/log/messages\u4e2d\u4f1a\u62a5\u9519"),(0,a.kt)("li",{parentName:"ul"},"sysconf \uff1akeepalived\u6838\u5fc3\u914d\u7f6e\u6587\u4ef6\u6240\u5728\u4f4d\u7f6e\uff0c\u56fa\u5b9a\u4f4d\u7f6e\uff0c\u6539\u6210\u5176\u4ed6\u4f4d\u7f6e\u5219keepalived\u542f\u52a8\u4e0d\u4e86\uff0c/var/log/messages\u4e2d\u4f1a\u62a5\u9519\n\u914d\u7f6e\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u51fa\u73b0\u8b66\u544a\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"*** WARNING - this build will not support IPVS with IPv6. Please install libnl/libnl-3 dev libraries to support IPv6 with IPVS.\n\n# \u5b89\u88c5libnl/libnl-3\u4f9d\u8d56\nyum -y install libnl libnl-devel  \n")),(0,a.kt)("h3",{id:"2\u914d\u7f6ekeepalived-\u4e3b\u673a"},"2\u3001\u914d\u7f6ekeepalived \u4e3b\u673a"),(0,a.kt)("p",null,"(1) \u901a\u8fc7\u547d\u4ee4 ",(0,a.kt)("inlineCode",{parentName:"p"},"vim keepalived.conf")," \u6253\u5f00\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"global_defs { \n    # \u8def\u7531id\uff1a\u5f53\u524d\u5b89\u88c5keepalived\u7684\u8282\u70b9\u4e3b\u673a\u6807\u8bc6\u7b26\uff0c\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00 \n    router_id keep_171 \n} \n\nvrrp_instance VI_1 { \n    # \u8868\u793a\u72b6\u6001\u662fMASTER\u4e3b\u673a\u8fd8\u662f\u5907\u7528\u673aBACKUP \n    state MASTER \n    # \u8be5\u5b9e\u4f8b\u7ed1\u5b9a\u7684\u7f51\u5361 \n    interface ens33 \n    # \u4fdd\u8bc1\u4e3b\u5907\u8282\u70b9\u4e00\u81f4\u5373\u53ef \n    virtual_router_id 51 \n    # \u6743\u91cd\uff0cmaster\u6743\u91cd\u4e00\u822c\u9ad8\u4e8ebackup\uff0c\u5982\u679c\u6709\u591a\u4e2a\uff0c\u90a3\u5c31\u662f\u9009\u4e3e\uff0c\u8c01\u7684\u6743\u91cd\u9ad8\uff0c\u8c01\u5c31\u5f53\u9009 \n    priority 100 \n    # \u4e3b\u5907\u4e4b\u95f4\u540c\u6b65\u68c0\u67e5\u65f6\u95f4\u95f4\u9694\uff0c\u5355\u4f4d\u79d2 \n    advert_int 2 \n    # \u8ba4\u8bc1\u6743\u9650\u5bc6\u7801\uff0c\u9632\u6b62\u975e\u6cd5\u8282\u70b9\u8fdb\u5165 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    # \u865a\u62df\u51fa\u6765\u7684ip\uff0c\u53ef\u4ee5\u6709\u591a\u4e2a\uff08vip\uff09 \n    virtual_ipaddress { \n        192.168.1.161 \n    }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# \u67e5\u770b\u7f51\u5361\nip addr\n\n# \u542f\u52a8keepalived\n./keepalived\n\n# \u67e5\u770b\u8fdb\u7a0b\nps -ef | grep keepalived\n\n# \u67e5\u770bvip(\u865a\u62dfip)\n# \u5728\u7f51\u5361ens33\u4e0b\uff0c\u591a\u4e86\u4e00\u4e2a192.168.1.161\uff0c\u8fd9\u4e2a\u5c31\u662f\u865a\u62dfip\n")),(0,a.kt)("h3",{id:"3\u628akeepalived\u6ce8\u518c\u4e3a\u7cfb\u7edf\u670d\u52a1"},"3\u3001\u628akeepalived\u6ce8\u518c\u4e3a\u7cfb\u7edf\u670d\u52a1"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# \u62f7\u8d1d\u914d\u7f6e\u6587\u4ef6\n# \u5c06keepalived\u76ee\u5f55\u4e0betc/init.d/keepalived\u62f7\u8d1d\u5230/etc/init.d/\u4e0b\n# \u5c06keepalived\u76ee\u5f55\u4e0betc/sysconfig/keepalived\u62f7\u8d1d\u5230/etc/sysconfig/\u4e0b\n\n# \u5237\u65b0systemctl\nsystemctl daemon-reload\n\n#\u542f\u52a8 keepalived\nsystemctl start keepalived.service\n\n#\u505c\u6b62 keepalived\nsystemctl stop keepalived.service\n\n#\u91cd\u542f keepalived\nsystemctl restart keepalived.service\n")),(0,a.kt)("h2",{id:"4\u5b9e\u73b0\u53cc\u673a\u4e3b\u5907\u9ad8\u53ef\u7528"},"4\u3001\u5b9e\u73b0\u53cc\u673a\u4e3b\u5907\u9ad8\u53ef\u7528"),(0,a.kt)("p",null,"(1) \u4fee\u6539\u5907\u673a\u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"global_defs { \n    router_id keep_172 \n} \nvrrp_instance VI_1 { \n    # \u5907\u7528\u673a\u8bbe\u7f6e\u4e3aBACKUP \n    state BACKUP \n    interface ens33 \n    virtual_router_id 51 \n    # \u6743\u91cd\u4f4e\u4e8eMASTER \n    priority 80 \n    advert_int 2 \n    authentication { \n        auth_type PASS auth_pass 1111 \n    }\n    virtual_ipaddress {\n        # \u6ce8\u610f\uff1a\u4e3b\u5907\u4e24\u53f0\u7684vip\u90fd\u662f\u4e00\u6837\u7684\uff0c\u7ed1\u5b9a\u5230\u540c\u4e00\u4e2avip \n        192.168.1.161 \n    } \n}\n")),(0,a.kt)("p",null,"(2) \u542f\u52a8 Keepalived"),(0,a.kt)("p",null,"(3) \u8bbf\u95eevip\u5373\u53ef\u8bbf\u95ee\u4e3b\u673a\uff0c\u5f53\u4e3b\u673a\u5931\u6548\u65f6\u8bbf\u95eevip\u5c31\u4f1a\u8bbf\u95ee\u5230\u5907\u673a"),(0,a.kt)("h3",{id:"5keepalived\u914d\u7f6enginx\u81ea\u52a8\u91cd\u542f"},"5\u3001keepalived\u914d\u7f6enginx\u81ea\u52a8\u91cd\u542f"),(0,a.kt)("p",null,"(1) \u7f16\u5199\u811a\u672c"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/keepalived/"),"\u4e0b\u521b\u5efa\u811a\u672c",(0,a.kt)("inlineCode",{parentName:"p"},"check_nginx_alive_or_not")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"#!/bin/bash \n\nA=`ps -C nginx --no-header |wc -l` \n# \u5224\u65adnginx\u662f\u5426\u5b95\u673a\uff0c\u5982\u679c\u5b95\u673a\u4e86\uff0c\u5c1d\u8bd5\u91cd\u542f \nif [ $A -eq 0 ];then \n    /usr/local/nginx/sbin/nginx \n    # \u7b49\u5f85\u4e00\u5c0f\u4f1a\u518d\u6b21\u68c0\u67e5nginx\uff0c\u5982\u679c\u6ca1\u6709\u542f\u52a8\u6210\u529f\uff0c\u5219\u505c\u6b62keepalived\uff0c\u4f7f\u5176\u542f\u52a8\u5907\u7528\u673a \n    sleep 3 \n        if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then \n            killall keepalived \n        fi \nfi\n")),(0,a.kt)("p",null,"(2) \u6dfb\u52a0\u8fd0\u884c\u6743\u9650"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"chmod +x /etc/keepalived/check_nginx_alive_or_not.sh\n")),(0,a.kt)("p",null,"(3) \u914d\u7f6ekeepalived\u76d1\u542cnginx\u811a\u672c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},'vrrp_script check_nginx_alive { \n    script "/etc/keepalived/check_nginx_alive_or_not.sh" \n    interval 2 # \u6bcf\u9694\u4e24\u79d2\u8fd0\u884c\u4e0a\u4e00\u884c\u811a\u672c \n    weight 10 # \u5982\u679c\u811a\u672c\u8fd0\u884c\u5931\u8d25\uff0c\u5219\u5347\u7ea7\u6743\u91cd+10 \n}\n')),(0,a.kt)("p",null,"(4) \u5728vrrp_instance\u4e2d\u65b0\u589e\u76d1\u63a7\u7684\u811a\u672c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"track_script { \n    check_nginx_alive # \u8ffd\u8e2a nginx \u811a\u672c\n}\n")),(0,a.kt)("p",null,"(5) \u91cd\u542fKeepalived\u4f7f\u5f97\u914d\u7f6e\u6587\u4ef6\u751f\u6548"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl restart keepalived\n")),(0,a.kt)("h3",{id:"6keepalived\u53cc\u4e3b\u70ed\u5907"},"6\u3001keepalived\u53cc\u4e3b\u70ed\u5907"),(0,a.kt)("p",null,"(1) \u914d\u7f6eDNS\u8f6e\u8be2"),(0,a.kt)("p",null,"\u5728\u540c\u4e00\u4e2a\u57df\u540d\u4e0b\u914d\u7f6e\u4e24\u4e2aip\uff0c\u81ea\u884c\u767e\u5ea6"),(0,a.kt)("p",null,"(2) \u914d\u7f6e\u7b2c\u4e00\u53f0\u4e3b\u673a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"global_defs {\n    router_id keep_171 \n} \nvrrp_instance VI_1 { \n    state MASTER i\n    nterface ens33 \n    virtual_router_id 51 \n    priority 100 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.161 \n    } \n} \n\nvrrp_instance VI_2  {\n    state BACKUP \n    interface ens33 \n    virtual_router_id 52 \n    priority 80 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.162 \n    }\n}\n")),(0,a.kt)("p",null,"(3) \u914d\u7f6e\u7b2c\u4e8c\u53f0\u4e3b\u673a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"global_defs {\n    router_id keep_172 \n} \nvrrp_instance VI_1 { \n    state BACKUP \n    interface ens33 \n    virtual_router_id 51 \n    priority 80 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.161\n    }\n} \n\nvrrp_instance VI_2 {\n    state MASTER \n    interface ens33 \n    virtual_router_id 52 \n    priority 100 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.162 \n    }\n}\n")),(0,a.kt)("p",null,"(4) \u91cd\u542f\u4e24\u53f0Keepalived"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl restart keepalived\n")),(0,a.kt)("h2",{id:"7-lvslinux-virtual-server\u5b9e\u73b0\u9ad8\u53ef\u7528\u8d1f\u8f7d\u5747\u8861"},"7. LVS\uff08Linux Virtual Server\uff09\u5b9e\u73b0\u9ad8\u53ef\u7528\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("h3",{id:"1\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528lvsnginx"},"1\u3001\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528LVS+Nginx"),(0,a.kt)("p",null,"lvs\u57fa\u4e8e\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\uff0c\u5de5\u4f5c\u6548\u7387\u8f83Nginx\u7684\u4e03\u5c42\u8d1f\u8f7d\u66f4\u9ad8\uff0c\u4f7f\u7528LVS\u642d\u5efaNginx\u96c6\u7fa4\uff0c\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\n\u56db\u5c42\u8d1f\u8f7d\u5747\u8861\u65e0\u6cd5\u5bf9\u4fe1\u606f\u5904\u7406\uff0c\u53ea\u80fd\u901a\u8fc7ip+\u7aef\u53e3\u7684\u5f62\u5f0f\u8f6c\u53d1\uff0c\u6240\u4ee5\u9700\u8981\u4e03\u6210\u8d1f\u8f7d\u8fdb\u884c\u6570\u636e\u7684\u5904\u7406\nNginx\u63a5\u6536\u8bf7\u6c42\u6765\u56de\uff0cLVS\u53ef\u4ee5\u53ea\u63a5\u53d7\u4e0d\u54cd\u5e94"),(0,a.kt)("h3",{id:"2lvs\u7684\u4e09\u79cd\u6a21\u5f0f"},"2\u3001LVS\u7684\u4e09\u79cd\u6a21\u5f0f"),(0,a.kt)("p",null,"(1)NAT\u6a21\u5f0f"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5ba2\u6237\u7aef\u5c06\u8bf7\u6c42\u53d1\u5f80LVS\uff0cLVS\u4f1a\u9009\u62e9\u4e00\u53f0\u670d\u52a1\u5668\u54cd\u5e94\u8bf7\u6c42\uff0c\u670d\u52a1\u5668\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9LVS\uff0cLVS\u518d\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5728NAT\u6a21\u5f0f\u4e2d\uff0c\u670d\u52a1\u5668\u7684\u7f51\u5173\u5fc5\u987b\u6307\u5411LVS\uff0c\u5426\u5219\u62a5\u6587\u65e0\u6cd5\u9001\u8fbe\u5ba2\u6237\u7aef"),(0,a.kt)("li",{parentName:"ul"},"NAT \u6280\u672f\u5c06\u8bf7\u6c42\u7684\u62a5\u6587\u548c\u54cd\u5e94\u7684\u62a5\u6587\u90fd\u9700\u8981\u901a\u8fc7LVS\u8fdb\u884c\u5730\u5740\u6539\u5199\uff0c\u56e0\u6b64\u7f51\u7ad9\u8bbf\u95ee\u91cf\u6bd4\u8f83\u5927\u7684\u65f6\u5019\u8d1f\u8f7d\u5747\u8861\u8c03\u5ea6\u5668\u6709\u6bd4\u8f83\u5927\u7684\u74f6\u9888\uff0c\u4e00\u822c\u8981\u6c42\u6700\u591a\u4e4b\u80fd 10-20 \u53f0\u8282\u70b9"),(0,a.kt)("li",{parentName:"ul"},"NAT \u6a21\u5f0f\u652f\u6301\u5bf9 IP \u5730\u5740\u548c\u7aef\u53e3\u8fdb\u884c\u8f6c\u6362\u3002\u5373\u7528\u6237\u8bf7\u6c42\u7684\u7aef\u53e3\u548c\u771f\u5b9e\u670d\u52a1\u5668\u7684\u7aef\u53e3\u53ef\u4ee5\u4e0d\u4e00\u81f4")),(0,a.kt)("p",null,"(2)TUN\u6a21\u5f0f"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5ba2\u6237\u7aef\u5c06\u8bf7\u6c42\u53d1\u5f80LVS\uff0cLVS\u4f1a\u9009\u62e9\u4e00\u53f0\u670d\u52a1\u5668\u54cd\u5e94\u8bf7\u6c42\uff0c\u5728\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u5668\u4e4b\u95f4\u5efa\u7acb\u96a7\u9053\uff0c\u8fd4\u56de\u7ed3\u679c\u7684\u65f6\u5019\u76f4\u63a5\u7531\u670d\u52a1\u5668\u8fd4\u56de\u54cd\u5e94\uff0c\u4e0d\u5728\u7ecf\u8fc7LVS\u3002"),(0,a.kt)("li",{parentName:"ul"},"TUN\u6a21\u5f0f\u5fc5\u987b\u6240\u6709\u7684\u670d\u52a1\u5668\u4e0a\u90fd\u7ed1\u5b9aVIP\u7684IP\u5730\u5740\uff0c\u6240\u6709\u7684\u670d\u52a1\u5668\u90fd\u5fc5\u987b\u6709\u7f51\u5361\u3002"),(0,a.kt)("li",{parentName:"ul"},"TUN\u6a21\u5f0f\u8d70\u96a7\u9053\u8fd0\u7ef4\u96be\u5ea6\u5927\uff0c\u5e76\u4e14\u4f1a\u76f4\u63a5\u66b4\u9732\u670d\u52a1\u5668\u5730\u5740"),(0,a.kt)("li",{parentName:"ul"},"\u670d\u52a1\u5668\u5c06\u5e94\u7b54\u5305\u76f4\u63a5\u53d1\u7ed9\u7528\u6237\u3002\u6240\u4ee5\uff0c\u51cf\u5c11\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5927\u91cf\u6570\u636e\u6d41\u52a8\uff0c\u8d1f\u8f7d\u5747\u8861\u5668\u4e0d\u518d\u662f\u7cfb\u7edf\u7684\u74f6\u9888\uff0c\u5c31\u80fd\u5904\u7406\u5f88\u5de8\u5927\u7684\u8bf7\u6c42\u91cf\uff0c\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e00\u53f0\u8d1f\u8f7d\u5747\u8861\u5668\u80fd\u591f\u4e3a\u5f88\u591a\u670d\u52a1\u5668\u8fdb\u884c\u5206\u53d1\u3002\u800c\u4e14\u8dd1\u5728\u516c\u7f51\u4e0a\u5c31\u80fd\u8fdb\u884c\u4e0d\u540c\u5730\u57df\u7684\u5206\u53d1")),(0,a.kt)("p",null,"(3)DR\u6a21\u5f0f"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5ba2\u6237\u7aef\u5c06\u8bf7\u6c42\u53d1\u5f80LVS\uff0cLVS\u4f1a\u9009\u62e9\u4e00\u53f0\u670d\u52a1\u5668\u54cd\u5e94\u8bf7\u6c42\uff0c\u8fd4\u56de\u7ed3\u679c\u7684\u65f6\u5019\u901a\u8fc7\u7edf\u4e00\u7684\u8def\u7531\u8fdb\u884c\u8fd4\u56de\uff0c\u4e0d\u5728\u7ecf\u8fc7LVS\u3002\n\u548cTUN\u6a21\u5f0f\u4e00\u6837\uff0cLVS\u53ea\u662f\u5206\u53d1\u8bf7\u6c42\uff0c\u5e94\u7b54\u5305\u901a\u8fc7\u5355\u72ec\u7684\u8def\u7531\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u4e0eTUN\u76f8\u6bd4\u8fd9\u79cd\u65b9\u5f0f\u4e0d\u9700\u8981\u96a7\u9053\u7ed3\u6784\uff0c\u53ef\u4ee5\u517c\u5bb9\u5927\u591a\u6570\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u540c\u65f6\u7edf\u4e00\u8def\u7531\u53ef\u4ee5\u9690\u85cf\u771f\u5b9e\u7684\u7269\u7406\u670d\u52a1\u5668\u3002DR\u6a21\u5f0f\u6548\u7387\u66f4\u9ad8\uff0c\u4f46\u914d\u7f6e\u66f4\u590d\u6742."),(0,a.kt)("li",{parentName:"ul"},"\u6240\u6709\u670d\u52a1\u5668\u8282\u70b9\u548cLVS\u53ea\u80fd\u5728\u4e00\u4e2a\u5c40\u57df\u7f51\u91cc\u9762\u3002")),(0,a.kt)("h3",{id:"3\u642d\u5efalvs-dr\u6a21\u5f0f"},"3\u3001\u642d\u5efaLVS-DR\u6a21\u5f0f"),(0,a.kt)("p",null,"\u5148\u5173\u95ed\u6389\u670d\u52a1\u5668\u4e0a\u7f51\u7edc\u914d\u7f6e\u7ba1\u7406\u5668\uff0c\u907f\u514d\u7f51\u7edc\u63a5\u53e3\u51b2\u7a81"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl stop NetworkManagersystemctl disable NetworkManager\n")),(0,a.kt)("p",null,"(1) \u521b\u5efa\u5b50\u63a5\u53e3\uff08\u521b\u5efaLVS\u7684\u865a\u62dfip\uff09"),(0,a.kt)("p",null,"\u8fdb\u5165\u7f51\u5361\u914d\u7f6e\u76ee\u5f55",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sysconfig/network-scripts/"),",\u627e\u5230\u7f51\u5361\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u91cc\u4ee5",(0,a.kt)("inlineCode",{parentName:"p"},"ifcfg-ens33"),"\u4e3a\u4f8b\uff0c\u62f7\u8d1d\u5e76\u521b\u5efa\u5b50\u63a5\u53e3"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"cp ifcfg-ens33 ifcfg-ens33:1\n")),(0,a.kt)("p",null,"\u4fee\u6539\u5b50\u63a5\u53e3\u914d\u7f6e\u5982\u4e0b"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u914d\u7f6e\u4e2d\u7684 192.168.1.150 \u5c31\u662fvip\uff0c\u662f\u63d0\u4f9b\u7ed9\u5916\u7f51\u7528\u6237\u8bbf\u95ee\u7684ip\u5730\u5740")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},'DEVICE="ens33:1"ONBOOT="yes"IPADDR=192.168.1.150NETMASK=255.255.255.0BOOTPROTO=static\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u91cd\u542f\u7f51\u7edc\u670d\u52a1")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"service network restart\n")),(0,a.kt)("p",null,"\u91cd\u542f\u6210\u529f\u540e\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"ip addr")," \u67e5\u770b\u4e00\u4e0b\uff0c\u4f60\u4f1a\u53d1\u73b0\u591a\u4e86\u4e00\u4e2aip\uff0c\u4e5f\u5c31\u662f\u865a\u62dfip\uff08vip\uff09"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a")," \u963f\u91cc\u4e91\u4e0d\u652f\u6301\u914d\u7f6e\u7f51\u5361\uff0c\u9700\u8981\u8d2d\u4e70\u76f8\u5e94\u7684\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\uff0c\u817e\u8baf\u4e91\u652f\u6301\u914d\u7f6e\u7f51\u5361\uff0c\u4f46\u9700\u8981\u8d2d\u4e70\u7f51\u5361\u652f\u6301\uff0c\u4e00\u4e2a\u7f51\u5361\u652f\u630110\u4e2a\u865a\u62dfip\u914d\u7f6e"),(0,a.kt)("p",null,"(2) \u5b89\u88c5ipvsadm"),(0,a.kt)("p",null,"\u5982\u4eca\u7684centos\u90fd\u96c6\u6210\u4e86LVS\uff0c\u6240\u4ee5ipvs\u662f\u81ea\u5e26\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5b89\u88c5ipvsadm\u5373\u53ef\uff08ipvsadm\u662f\u7ba1\u7406\u96c6\u7fa4\u7684\u5de5\u5177\uff0c\u901a\u8fc7ipvs\u53ef\u4ee5\u7ba1\u7406\u96c6\u7fa4\uff0c\u67e5\u770b\u96c6\u7fa4\u7b49\u64cd\u4f5c\uff09"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"yum install ipvsadm\n")),(0,a.kt)("p",null,"(3) \u914d\u7f6e\u670d\u52a1\u5668\uff08RS\uff09\u7684\u865a\u62dfip"),(0,a.kt)("p",null,"\u8fdb\u5165\u7f51\u5361\u914d\u7f6e\u76ee\u5f55",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sysconfig/network-scripts/"),",\u627e\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"ifcfg-lo"),"\uff0c\u62f7\u8d1d\u5e76\u521b\u5efa\u5b50\u63a5\u53e3"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"cp ifcfg-lo ifcfg-lo:1\n")),(0,a.kt)("p",null,"\u4fee\u6539\u5b50\u63a5\u53e3\u914d\u7f6e\u5982\u4e0b"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},'DEVICE="lo:1"\nIPADDR=192.168.1.150\nNETMASK=255.255.255.255\nNETWORK=127.0.0.0\nBROADCAST=127.255.255.255\nONBOOT="yes"\nNAME=loopback\n')),(0,a.kt)("p",null,"\u91cd\u542f\u7f51\u7edc\u670d\u52a1\u6210\u529f\u540e\uff0cip addr \u67e5\u770b\u4e00\u4e0b\uff0c\u4f60\u4f1a\u53d1\u73b0\u591a\u4e86\u4e00\u4e2aip\uff0c\u4e5f\u5c31\u662f\u865a\u62dfip\uff08vip\uff09"),(0,a.kt)("p",null,"(4) \u4e3a\u670d\u52a1\u5668\uff08RS\uff09\u914d\u7f6earp"),(0,a.kt)("p",null,"ARP\u54cd\u5e94\u7ea7\u522b\u4e0e\u901a\u544a\u884c\u4e3a\u53c2\u6570\u8bf4\u660e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"arp-ignore\uff1aARP\u54cd\u5e94\u7ea7\u522b\uff08\u5904\u7406\u8bf7\u6c42\uff09\n    0\uff1a\u53ea\u8981\u672c\u673a\u914d\u7f6e\u4e86ip\uff0c\u5c31\u80fd\u54cd\u5e94\u8bf7\u6c42\n    1\uff1a\u8bf7\u6c42\u7684\u76ee\u6807\u5730\u5740\u5230\u8fbe\u5bf9\u5e94\u7684\u7f51\u7edc\u63a5\u53e3\uff0c\u624d\u4f1a\u54cd\u5e94\u8bf7\u6c42\narp-announce\uff1aARP\u901a\u544a\u884c\u4e3a\uff08\u8fd4\u56de\u54cd\u5e94\uff09\n    0\uff1a\u672c\u673a\u4e0a\u4efb\u4f55\u7f51\u7edc\u63a5\u53e3\u90fd\u5411\u5916\u901a\u544a\uff0c\u6240\u6709\u7684\u7f51\u5361\u90fd\u80fd\u63a5\u53d7\u5230\u901a\u544a\n    1\uff1a\u5c3d\u53ef\u80fd\u907f\u514d\u672c\u7f51\u5361\u4e0e\u4e0d\u5339\u914d\u7684\u76ee\u6807\u8fdb\u884c\u901a\u544a2\uff1a\u53ea\u5728\u672c\u7f51\u5361\u901a\u544a\n")),(0,a.kt)("p",null,"\u6253\u5f00",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sysctl.conf")," ",(0,a.kt)("inlineCode",{parentName:"p"},"vim /etc/sysctl.conf")),(0,a.kt)("p",null,"\u914d\u7f6e\u6240\u6709\u7f51\u5361\u3001\u9ed8\u8ba4\u7f51\u5361\u4ee5\u53ca\u865a\u62df\u7f51\u5361\u7684arp\u54cd\u5e94\u7ea7\u522b\u548c\u901a\u544a\u884c\u4e3a\uff0c\u5206\u522b\u5bf9\u5e94\uff1aall\uff0cdefault\uff0clo"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"# configration for lvs \nnet.ipv4.conf.all.arp_ignore = 1 \nnet.ipv4.conf.default.arp_ignore = 1 \nnet.ipv4.conf.lo.arp_ignore = 1 \n\nnet.ipv4.conf.all.arp_announce = 2 \nnet.ipv4.conf.default.arp_announce = 2 \nnet.ipv4.conf.lo.arp_announce = 2\n")),(0,a.kt)("p",null,"\u5237\u65b0\u914d\u7f6e\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"sysctl -p\n")),(0,a.kt)("p",null,"\u589e\u52a0\u4e00\u4e2a\u7f51\u5173\uff0c\u7528\u4e8e\u63a5\u6536\u6570\u636e\u62a5\u6587\uff0c\u5f53\u6709\u8bf7\u6c42\u5230\u672c\u673a\u540e\uff0c\u4f1a\u4ea4\u7ed9lo\u53bb\u5904\u7406"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"route add -host 192.168.1.150 dev lo:1\n")),(0,a.kt)("p",null,"\u5c06\u7f51\u5173\u6dfb\u52a0\u81f3\u5f00\u673a\u542f\u52a8"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'echo "route add -host 192.168.1.150 dev lo:1" >> /etc/rc.local\n')),(0,a.kt)("p",null,"(5) \u4f7f\u7528ipvsadm\u914d\u7f6e\u96c6\u7fa4\u89c4\u5219"),(0,a.kt)("p",null,"\u521b\u5efaLVS\u8282\u70b9\uff0c\u7528\u6237\u8bbf\u95ee\u7684\u96c6\u7fa4\u8c03\u5ea6\u8005"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ipvsadm -A -t 192.168.1.150:80 -s rr -p 5\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"-A\uff1a\u6dfb\u52a0\u96c6\u7fa4"),(0,a.kt)("li",{parentName:"ul"},"-t\uff1atcp\u534f\u8baeip\u5730\u5740\uff1a\u8bbe\u5b9a\u96c6\u7fa4\u7684\u8bbf\u95ee"),(0,a.kt)("li",{parentName:"ul"},"ip\uff1a\u4e5f\u5c31\u662fLVS\u7684\u865a\u62dfip"),(0,a.kt)("li",{parentName:"ul"},"-s\uff1a\u8bbe\u7f6e\u8d1f\u8f7d\u5747\u8861\u7684\u7b97\u6cd5\uff0c"),(0,a.kt)("li",{parentName:"ul"},"rr\uff1a\u8868\u793a\u8f6e\u8be2"),(0,a.kt)("li",{parentName:"ul"},"-p\uff1a\u8bbe\u7f6e\u8fde\u63a5\u6301\u4e45\u5316\u7684\u65f6\u95f4,\u5728\u6307\u5b9a\u65f6\u95f4\u5185\u540c\u4e00\u4e2a\u7528\u6237\u7684\u8bf7\u6c42\u4f1a\u8bbf\u95ee\u5230\u540c\u4e00\u4e2a\u670d\u52a1\u5668\u4e2d")),(0,a.kt)("p",null,"\u521b\u5efa\u591a\u53f0RS\u771f\u5b9e\u670d\u52a1\u5668"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ipvsadm -a -t 192.168.1.150:80 -r 192.168.1.171:80 -g \nipvsadm -a -t 192.168.1.150:80 -r 192.168.1.172:80 -g\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"-a\uff1a\u6dfb\u52a0\u771f\u5b9e\u670d\u52a1\u5668"),(0,a.kt)("li",{parentName:"ul"},"-t\uff1atcp\u534f\u8bae"),(0,a.kt)("li",{parentName:"ul"},"-r\uff1a\u771f\u5b9e\u670d\u52a1\u5668\u7684ip\u5730\u5740"),(0,a.kt)("li",{parentName:"ul"},"-g\uff1a\u8bbe\u5b9aDR\u6a21\u5f0f")),(0,a.kt)("p",null,"\u4fdd\u5b58\u5230\u89c4\u5219\u5e93\uff0c\u5426\u5219\u91cd\u542f\u5931\u6548"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ipvsadm -S\n")),(0,a.kt)("p",null,"\u68c0\u67e5\u96c6\u7fa4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"#\u67e5\u770b\u96c6\u7fa4\u5217\u8868\nipvsadm -Ln\n#\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\nipvsadm -Ln --stats\n")),(0,a.kt)("p",null,"\u4e00\u4e9b\u5176\u4ed6\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# \u91cd\u542fipvsadm\uff0c\u91cd\u542f\u540e\u9700\u8981\u91cd\u65b0\u914d\u7f6e \nservice ipvsadm restart \n# \u67e5\u770b\u6301\u4e45\u5316\u8fde\u63a5 \nipvsadm -Ln --persistent-conn \n# \u67e5\u770b\u8fde\u63a5\u8bf7\u6c42\u8fc7\u671f\u65f6\u95f4\u4ee5\u53ca\u8bf7\u6c42\u6e90ip\u548c\u76ee\u6807ip \nipvsadm -Lnc \n# \u8bbe\u7f6etcp tcpfin udp \u7684\u8fc7\u671f\u65f6\u95f4\uff08\u4e00\u822c\u4fdd\u6301\u9ed8\u8ba4\uff09 \nipvsadm --set 1 1 1 \n# \u67e5\u770b\u8fc7\u671f\u65f6\u95f4 \nipvsadm -Ln --timeout\n")),(0,a.kt)("p",null,"(6) \u8bbf\u95ee\u865a\u62dfip\uff0c\u5b8c\u6210LVS\u642d\u5efa"),(0,a.kt)("h2",{id:"\u9644lvs\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5"},"\u9644\uff1aLVS\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5"),(0,a.kt)("h3",{id:"1\u9759\u6001\u7b97\u6cd5"},"(1)\u9759\u6001\u7b97\u6cd5"),(0,a.kt)("p",null,"\u9759\u6001\uff1a\u6839\u636eLVS\u672c\u8eab\u81ea\u7531\u7684\u56fa\u5b9a\u7684\u7b97\u6cd5\u5206\u53d1\u7528\u6237\u8bf7\u6c42\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u8f6e\u8be2\uff08Round Robin \u7b80\u5199\u2019rr\u2019\uff09\uff1a\u8f6e\u8be2\u7b97\u6cd5\u5047\u8bbe\u6240\u6709\u7684\u670d\u52a1\u5668\u5904\u7406\u8bf7\u6c42\u7684\u80fd\u529b\u90fd\u4e00\u6837\u7684\uff0c\u8c03\u5ea6\u5668\u4f1a\u628a\u6240\u6709\u7684\u8bf7\u6c42\u5e73\u5747\u5206\u914d\u7ed9\u6bcf\u4e2a\u771f\u5b9e\u670d\u52a1\u5668\u3002\uff08\u540cNginx\u7684\u8f6e\u8be2\uff09"),(0,a.kt)("li",{parentName:"ul"},"\u52a0\u6743\u8f6e\u8be2\uff08Weight Round Robin \u7b80\u5199\u2019wrr\u2019\uff09\uff1a\u5b89\u88c5\u6743\u91cd\u6bd4\u4f8b\u5206\u914d\u7528\u6237\u8bf7\u6c42\u3002\u6743\u91cd\u8d8a\u9ad8\uff0c\u88ab\u5206\u914d\u5230\u5904\u7406\u7684\u8bf7\u6c42\u8d8a\u591a\u3002\uff08\u540cNginx\u7684\u6743\u91cd\uff09"),(0,a.kt)("li",{parentName:"ul"},"\u6e90\u5730\u5740\u6563\u5217\uff08Source Hash \u7b80\u5199\u2019sh\u2019\uff09\uff1a\u540c\u4e00\u4e2a\u7528\u6237ip\u7684\u8bf7\u6c42\uff0c\u4f1a\u7531\u540c\u4e00\u4e2aRS\u6765\u5904\u7406\u3002\uff08\u540cNginx\u7684ip_hash\uff09"),(0,a.kt)("li",{parentName:"ul"},"\u76ee\u6807\u5730\u5740\u6563\u5217\uff08Destination Hash \u7b80\u5199\u2019dh\u2019\uff09\uff1a\u6839\u636eurl\u7684\u4e0d\u540c\uff0c\u8bf7\u6c42\u5230\u4e0d\u540c\u7684RS\u3002\uff08\u540cNginx\u7684url_hash\uff09")),(0,a.kt)("h3",{id:"2\u52a8\u6001\u7b97\u6cd5"},"(2)\u52a8\u6001\u7b97\u6cd5"),(0,a.kt)("p",null,"\u52a8\u6001\uff1a\u4f1a\u6839\u636e\u6d41\u91cf\u7684\u4e0d\u540c\uff0c\u6216\u8005\u670d\u52a1\u5668\u7684\u538b\u529b\u4e0d\u540c\u6765\u5206\u914d\u7528\u6237\u8bf7\u6c42\uff0c\u8fd9\u662f\u52a8\u6001\u8ba1\u7b97\u7684\u3002"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u6700\u5c0f\u8fde\u63a5\u6570\uff08Least Connections \u7b80\u5199\u2019lc\u2019\uff09\uff1a\u628a\u65b0\u7684\u8fde\u63a5\u8bf7\u6c42\u5206\u914d\u5230\u5f53\u524d\u8fde\u63a5\u6570\u6700\u5c0f\u7684\u670d\u52a1\u5668\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u52a0\u6743\u6700\u5c11\u8fde\u63a5\u6570\uff08Weight Least Connections \u7b80\u5199\u2019wlc\u2019\uff09\uff1a\u670d\u52a1\u5668\u7684\u5904\u7406\u6027\u80fd\u7528\u6570\u503c\u6765\u4ee3\u8868\uff0c\u6743\u91cd\u8d8a\u5927\u5904\u7406\u7684\u8bf7\u6c42\u8d8a\u591a\u3002Real Server \u6709\u53ef\u80fd\u4f1a\u5b58\u5728\u6027\u80fd\u4e0a\u7684\u5dee\u5f02\uff0cwlc\u52a8\u6001\u83b7\u53d6\u4e0d\u540c\u670d\u52a1\u5668\u7684\u8d1f\u8f7d\u72b6\u51b5\uff0c\u628a\u8bf7\u6c42\u5206\u53d1\u5230\u6027\u80fd\u597d\u5e76\u4e14\u6bd4\u8f83\u7a7a\u95f2\u7684\u670d\u52a1\u5668\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u6700\u77ed\u671f\u671b\u5ef6\u8fdf\uff08Shortest Expected Delay \u7b80\u5199\u2019sed\u2019\uff09\uff1a\u7279\u6b8a\u7684wlc\u7b97\u6cd5\u3002\u4e3e\u4f8b\u9610\u8ff0\uff0c\u5047\u8bbe\u6709ABC\u4e09\u53f0\u670d\u52a1\u5668\uff0c\u6743\u91cd\u5206\u522b\u4e3a1\u30012\u30013 \u3002\u5982\u679c\u4f7f\u7528wlc\u7b97\u6cd5\u7684\u8bdd\uff0c\u5f53\u4e00\u4e2a\u65b0\u8bf7\u6c42\u8fdb\u6765\uff0c\u5b83\u53ef\u80fd\u4f1a\u5206\u7ed9ABC\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u3002\u4f7f\u7528sed\u7b97\u6cd5\u540e\u4f1a\u8fdb\u884c\u5982\u4e0b\u8fd0\u7b97\uff1a")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"A\uff1a\uff081+1\uff09/1=2\nB\uff1a\uff081+2\uff09/2=3/2\nC\uff1a\uff081+3\uff09/3=4/3\n")),(0,a.kt)("p",null,"\u6700\u7ec8\u7ed3\u679c\uff0c\u4f1a\u628a\u8fd9\u4e2a\u8bf7\u6c42\u4ea4\u7ed9\u5f97\u51fa\u8fd0\u7b97\u7ed3\u679c\u6700\u5c0f\u7684\u670d\u52a1\u5668\u3002\u6700\u5c11\u961f\u5217\u8c03\u5ea6\uff08Never Queue \u7b80\u5199\u2019nq\u2019\uff09\uff1a\u6c38\u4e0d\u4f7f\u7528\u961f\u5217\u3002\u5982\u679c\u6709Real Server\u7684\u8fde\u63a5\u6570\u7b49\u4e8e0\uff0c\u5219\u76f4\u63a5\u628a\u8fd9\u4e2a\u8bf7\u6c42\u5206\u914d\u8fc7\u53bb\uff0c\u4e0d\u9700\u8981\u5728\u6392\u961f\u7b49\u5f85\u8fd0\u7b97\u4e86\uff08sed\u8fd0\u7b97\uff09\u3002"),(0,a.kt)("h2",{id:"8-\u642d\u5efakeepalivedlvsnginx\u9ad8\u53ef\u7528\u96c6\u7fa4\u8d1f\u8f7d\u5747\u8861"},"8. \u642d\u5efaKeepalived+Lvs+Nginx\u9ad8\u53ef\u7528\u96c6\u7fa4\u8d1f\u8f7d\u5747\u8861"),(0,a.kt)("p",null,"\u5982\u679c\u539f\u5148\u670d\u52a1\u5668\u4e0a\u914d\u7f6e\u4e86LVS+nginx\u9700\u8981\u6e05\u7a7aipvsadm\u4e2d\u7684\u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ipvsadm -C\n")),(0,a.kt)("p",null,"\u5982\u679c\u914d\u7f6e\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"Keepalived+Nginx"),"\u53cc\u4e3b\u96c6\u7fa4\u4e5f\u9700\u8981\u53bb\u9664\u6389",(0,a.kt)("inlineCode",{parentName:"p"},"Keepalived"),"\u4e2d\u539f\u5148\u7684\u914d\u7f6e\uff0c\u6309\u7167\u7684\u540e\u6587\u8fdb\u884c\u914d\u7f6e"),(0,a.kt)("h3",{id:"1-\u4f7f\u7528keepalived\u914d\u7f6emaster-lvs"},"1. \u4f7f\u7528keepalived\u914d\u7f6eMaster LVS"),(0,a.kt)("p",null,"\u5728LVS\u7684\u673a\u5668\u4e0a\u5b89\u88c5keepalived\uff0c\u5b89\u88c5\u8fc7\u7a0b\u53c2\u8003\u4e0a\u6587"),(0,a.kt)("p",null,"(1) \u4fee\u6539keepalived\u7684\u914d\u7f6e"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"global_defs {\n    router_id keep_151 \n} \nvrrp_instance VI_1 { \n    state MASTER \n    interface ens33 \n    virtual_router_id 41 \n    priority 100 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.150\n    }\n} \n\n#\u914d\u7f6e\u96c6\u7fa4\u8bbf\u95ee\u7684ip+\u7aef\u53e3\uff0c\u7aef\u53e3\u548cnginx\u4fdd\u6301\u4e00\u81f4\nvirtual_server 192.168.1.150 80{\n    #\u5065\u5eb7\u68c0\u67e5\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\uff1a\u79d2\n    delay_loop 6\n    #\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u7684\u7b97\u6cd5\uff0c\u9ed8\u8ba4\u7684\u8f6e\u8be2\n    lb_algo rr\n    #\u8bbe\u7f6eLVS\u7684\u6a21\u5f0f NAT|TUN|DR\n    lb-kind DR\n    #\u8bbe\u7f6e\u4f1a\u8bdd\u6301\u4e45\u5316\u7684\u65f6\u95f4\n    persistence_timeout 5\n    #\u534f\u8bae\n    protocol TCP\n    \n    #\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u7684\u771f\u5b9e\u670d\u52a1\u5668\uff0c\u4e5f\u5c31\u662fnginx\u8282\u70b9\u7684\u5177\u4f53\u7684ip\u5730\u5740\n    real_server 192.168.1.171 80{\n        #\u8f6e\u8be2\u6743\u91cd\u914d\u6bd4\n        weight 1\n        #\u8bbe\u7f6e\u5065\u5eb7\u68c0\u67e5\n        TCP_CHECK {\n            #\u68c0\u67e580\u7aef\u53e3\n            connect_port 80\n            #\u8d85\u65f6\u65f6\u95f4\n            connect_timeout 2\n            #\u91cd\u8bd5\u6b21\u6570\n            nb_get_retry 2\n            #\u91cd\u8bd5\u95f4\u9694\u65f6\u95f4\n            delay_before_retry 3\n        }\n    }\n    real_server 192.168.1.171 80{\n        weight 1\n        TCP_CHECK {\n            connect_port 80\n            connect_timeout 2\n            nb_get_retry 2\n            delay_before_retry 3\n        }\n    }\n}\n")),(0,a.kt)("p",null,"(2) \u542f\u52a8/\u91cd\u542fkeepalived"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"systemctl restart keepalived\n")),(0,a.kt)("h3",{id:"2-\u4f7f\u7528keepalived\u914d\u7f6ebackup-lvs"},"2. \u4f7f\u7528keepalived\u914d\u7f6eBackup LVS"),(0,a.kt)("p",null,"\u914d\u7f6e\u5728\u5907\u7528\u673a\u4e0a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"global_defs {\n    router_id keep_152 \n} \nvrrp_instance VI_1 { \n    state  BACKUP\n    interface ens33 \n    virtual_router_id 41 \n    priority 50 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.150\n    }\n} \n\n#\u914d\u7f6e\u96c6\u7fa4\u8bbf\u95ee\u7684ip+\u7aef\u53e3\uff0c\u7aef\u53e3\u548cnginx\u4fdd\u6301\u4e00\u81f4\nvirtual_server 192.168.1.150 80{\n    #\u5065\u5eb7\u68c0\u67e5\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\uff1a\u79d2\n    delay_loop 6\n    #\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u7684\u7b97\u6cd5\uff0c\u9ed8\u8ba4\u7684\u8f6e\u8be2\n    lb_algo rr\n    #\u8bbe\u7f6eLVS\u7684\u6a21\u5f0f NAT|TUN|DR\n    lb-kind DR\n    #\u8bbe\u7f6e\u4f1a\u8bdd\u6301\u4e45\u5316\u7684\u65f6\u95f4\n    persistence_timeout 5\n    #\u534f\u8bae\n    protocol TCP\n    \n    #\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u7684\u771f\u5b9e\u670d\u52a1\u5668\uff0c\u4e5f\u5c31\u662fnginx\u8282\u70b9\u7684\u5177\u4f53\u7684ip\u5730\u5740\n    real_server 192.168.1.171 80{\n        #\u8f6e\u8be2\u6743\u91cd\u914d\u6bd4\n        weight 1\n        #\u8bbe\u7f6e\u5065\u5eb7\u68c0\u67e5\n        TCP_CHECK {\n            #\u68c0\u67e580\u7aef\u53e3\n            connect_port 80\n            #\u8d85\u65f6\u65f6\u95f4\n            connect_timeout 2\n            #\u91cd\u8bd5\u6b21\u6570\n            nb_get_retry 2\n            #\u91cd\u8bd5\u95f4\u9694\u65f6\u95f4\n            delay_before_retry 3\n        }\n    }\n    real_server 192.168.1.171 80{\n        weight 1\n        TCP_CHECK {\n            connect_port 80\n            connect_timeout 2\n            nb_get_retry 2\n            delay_before_retry 3\n        }\n    }\n}\n")))}k.isMDXComponent=!0}}]);