<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">1 篇博文 含有标签「upload」 | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/light-docusaurus/blog/tags/upload/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="1 篇博文 含有标签「upload」 | Light Docusaurus"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/light-docusaurus/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/light-docusaurus/blog/tags/upload/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/blog/tags/upload/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/blog/tags/upload/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/light-docusaurus/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/light-docusaurus/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/light-docusaurus/opensearch.xml"><link rel="stylesheet" href="/light-docusaurus/assets/css/styles.609e5209.css">
<script src="/light-docusaurus/assets/js/runtime~main.79436775.js" defer="defer"></script>
<script src="/light-docusaurus/assets/js/main.af3b976d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/light-docusaurus/"><div class="navbar__logo"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/light-docusaurus/docs/category/guide/">Torch</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/light-docusaurus/blog/">Blog</a><a class="navbar__item navbar__link" href="/light-docusaurus/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/light-docusaurus/electron/">Electron</a><a class="navbar__item navbar__link" href="/light-docusaurus/postman/">Postman</a><a class="navbar__item navbar__link" href="/light-docusaurus/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/light-docusaurus/blog/tags/upload/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/light-docusaurus/blog/2023/12/22/file-slice-upload/">Spring Boot Slice Upload with Minio(S3) and LocalFileSystem</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/light-docusaurus/blog/2023/08/07/docusaurus-with-aglolia/">Docusaurus With Algolia</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/light-docusaurus/blog/welcome/">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/light-docusaurus/blog/mdx-blog-post/">MDX Blog Post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/light-docusaurus/blog/long-blog-post/">Long Blog Post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><header class="margin-bottom--xl"><h1>1 篇博文 含有标签「upload」</h1><a href="/light-docusaurus/blog/tags/">查看所有标签</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="前言"><link itemprop="image" href="https://lorchr.github.io/light-docusaurus/../img/docusaurus.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/light-docusaurus/blog/2023/12/22/file-slice-upload/">Spring Boot Slice Upload with Minio(S3) and LocalFileSystem</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-12-22T00:00:00.000Z" itemprop="datePublished">2023年12月22日</time> · <!-- -->阅读需 39 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lorchr" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lorchr.png" alt="Hui Liu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lorchr" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Hui Liu</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 id="前言">前言</h2>
<h3 id="什么是-oss">什么是 OSS?</h3>
<p>OSS（Object Storage Service），对象存储服务，对象存储服务是一种使用 HTTP API 存储和检索对象的工具。就是将系统所要用的文件上传到云硬盘上，该云硬盘提供了文件下载、上传、预览等一系列服务，具备版本，权限控制能力，具备数据生命周期管理能力这样的服务以及技术可以统称为 OSS</p>
<p>一般项目使用 OSS 对象存储服务，主要是对图片、文件、音频等对象集中式管理权限控制，管理数据生命周期等等，提供上传，下载，预览，删除等功能。</p>
<h3 id="什么是-amazons3">什么是 AmazonS3？</h3>
<p>Amazon Simple Storage Service（Amazon S3，Amazon 简便存储服务）是 AWS 最早推出的云服务之一，经过多年的发展，S3 协议在对象存储行业事实上已经成为标准。</p>
<ul>
<li>提供了统一的接口 REST/SOAP 来统一访问任何数据</li>
<li>对 S3 来说，存在里面的数据就是对象名（键），和数据（值）</li>
<li>不限量，单个文件最高可达 5TB，可动态扩容。</li>
<li>高速。每个 bucket 下每秒可达 3500 PUT/COPY/POST/DELETE 或 5500 GET/HEAD 请求。</li>
<li>具备版本，权限控制能力</li>
<li>具备数据生命周期管理能力</li>
</ul>
<p>文档地址：<a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/Welcome.html">https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/Welcome.html</a></p>
<p>作为一个对象存储服务，S3 功能真的很完备，行业的标杆，目前市面上大部分 OSS 对象存储服务都支持 AmazonS3，本文主要讲解的就是基于 AmazonS3 实现我们自己的 Spring Boot Starter。</p>
<ul>
<li>阿里云 OSS 兼容 S3</li>
<li>七牛云对象存储兼容 S3</li>
<li>腾讯云 COS 兼容 S3</li>
<li>Minio 兼容 S3</li>
</ul>
<h3 id="为什么要基于amazons3-实现-spring-boot-starter">为什么要基于AmazonS3 实现 Spring Boot Starter？</h3>
<p>原因：市面上 OSS 对象存储服务基本都支持 AmazonS3，我们封装我们的自己的 starter 那么就必须考虑适配，迁移，可扩展。比喻说我们今天使用的是阿里云 OSS 对接阿里云 OSS 的 SDK，后天我们使用的是腾讯 COS 对接是腾讯云 COS，我们何不直接对接 AmazonS3 实现呢，这样后续不需要调整代码，只需要去各个云服务商配置就好了。</p>
<h2 id="一自定义-spring-boot-starter-oss">一、自定义 spring-boot-starter-oss</h2>
<h3 id="11-maven工程定义及依赖-pomxml">1.1 Maven工程定义及依赖 pom.xml</h3>
<p>核心是引入 <code>AmazonS3</code> 依赖包</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;
    &lt;artifactId&gt;aws-java-sdk-s3&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>完整的<code>pom.xml</code>如下</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;cloud-sdk-oss&lt;/artifactId&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;

    &lt;name&gt;Cloud SDK OSS&lt;/name&gt;
    &lt;description&gt;OSS SDK Support Amazon S3, Alibaba OSS, Tencent COS, Qiniu, MinIO etc&lt;/description&gt;

    &lt;parent&gt;
        &lt;groupId&gt;com.light&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-samples&lt;/artifactId&gt;
        &lt;version&gt;2023.0.0&lt;/version&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;skipTests&gt;true&lt;/skipTests&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.light&lt;/groupId&gt;
            &lt;artifactId&gt;cloud-common-core&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;
            &lt;artifactId&gt;aws-java-sdk-s3&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--自动配置--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-autoconfigure&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-autoconfigure-processor&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;!--生成配置说明文件--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;resources&gt;
            &lt;resource&gt;
                &lt;directory&gt;src/main/resources&lt;/directory&gt;
                &lt;!--yml中引用pom信息--&gt;
                &lt;filtering&gt;true&lt;/filtering&gt;
            &lt;/resource&gt;
        &lt;/resources&gt;

        &lt;plugins&gt;
            &lt;!--跳过向maven私服推送服务jar包--&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-deploy-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;skip&gt;true&lt;/skip&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;!-- maven 打包时跳过测试 --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;skip&gt;true&lt;/skip&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;!--可依赖jar包插件--&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;encoding&gt;${project.build.sourceEncoding}&lt;/encoding&gt;
                    &lt;source&gt;${maven.compiler.source}&lt;/source&gt;
                    &lt;target&gt;${maven.compiler.target}&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;!-- 在打好的jar包中保留javadoc注释,实际会另外生成一个xxxxx-sources.jar --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;id&gt;attach-sources&lt;/id&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;jar&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
<h3 id="12-oss操作类接口定义">1.2 OSS操作类接口定义</h3>
<p>OssTemplate：OSS 模板接口，此接口主要是对 OSS 操作的方法的一个接口，定义为接口主要是满足可扩展原则，就是其他人使用了我们的 jar 包，实现此接口可以自定义相关操作。</p>
<p>如下面所示代码：定义了一些对 OSS 操作的方法。</p>
<pre><code class="language-java">package com.light.cloud.sdk.oss.service;

import java.io.InputStream;
import java.util.Date;
import java.util.List;
import java.util.Map;

import com.amazonaws.services.s3.model.Bucket;
import com.amazonaws.services.s3.model.CompleteMultipartUploadResult;
import com.amazonaws.services.s3.model.CopyObjectResult;
import com.amazonaws.services.s3.model.InitiateMultipartUploadResult;
import com.amazonaws.services.s3.model.MultipartUpload;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PartSummary;
import com.amazonaws.services.s3.model.PutObjectResult;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.S3ObjectSummary;
import com.amazonaws.services.s3.model.UploadPartResult;

/**
 * OSS操作模板
 *
 * @author Hui Liu
 * @date 2023/5/9
 */
public interface OssTemplate {

    /**
     * 创建Bucket &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @return 存储桶
     */
    Bucket createBucket(String bucketName) throws Exception;

    /**
     * 获取所有的buckets &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListBuckets.html &lt;p&gt;
     *
     * @return 存储桶列表
     */
    List&lt;Bucket&gt; listBuckets() throws Exception;

    /**
     * 通过Bucket名称删除Bucket &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucket.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     */
    void removeBucket(String bucketName) throws Exception;

    /**
     * 上传对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html &lt;p&gt;
     *
     * @param bucketName  bucket名称
     * @param objectName  文件名称
     * @param inputStream 文件输入流
     * @param contextType 文件类型
     * @return 上传结果
     */
    PutObjectResult putObject(String bucketName, String objectName, InputStream inputStream, String contextType) throws Exception;


    /**
     * 上传对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @param stream     文件流
     * @return 上传结果
     */
    PutObjectResult putObject(String bucketName, String objectName, InputStream stream) throws Exception;

    /**
     * 获取对象元信息 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetObjectMetadata.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @return 文件对象
     */
    ObjectMetadata getObjectMetadata(String bucketName, String objectName);

    /**
     * 获取对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetObject.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @return 文件对象
     */
    S3Object getObject(String bucketName, String objectName) throws Exception;

    /**
     * 复制对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_CopyObject.html &lt;p&gt;
     *
     * @param bucketName    bucket名称
     * @param objectName    文件名称
     * @param newBucketName 新bucket名称
     * @param newObjectName 新文件名称
     */
    CopyObjectResult copyObject(String bucketName, String objectName, String newBucketName, String newObjectName) throws Exception;

    /**
     * 移动对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_CopyObject.html &lt;p&gt;
     *
     * @param bucketName    bucket名称
     * @param objectName    文件名称
     * @param newBucketName 新bucket名称
     * @param newObjectName 新文件名称
     */
    void moveObject(String bucketName, String objectName, String newBucketName, String newObjectName) throws Exception;

    /**
     * 获取对象，分段获取 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetObject.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @param startByte  开始字节
     * @param endByte    结束字节
     * @return 文件对象
     */
    S3Object getObjectWithRange(String bucketName, String objectName, Long startByte, Long endByte) throws Exception;

    /**
     * 获取对象的url &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_GeneratePresignedUrl.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @param expireAt   过期时间
     * @return 对象的URL
     */
    String getPreSignViewUrl(String bucketName, String objectName, Date expireAt) throws Exception;

    /**
     * 根据前缀查询对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjects.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param recursive  是否递归查询
     * @return S3ObjectSummary 列表
     */
    List&lt;S3ObjectSummary&gt; listObjects(String bucketName, boolean recursive) throws Exception;

    /**
     * 根据前缀查询对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjects.html &lt;p&gt;
     * AmazonS3：http://docs.aws.amazon.com/AmazonS3/latest/API/RESTBucketGET.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param prefix     前缀
     * @param recursive  是否递归查询
     * @return S3ObjectSummary 列表
     */
    List&lt;S3ObjectSummary&gt; listObjectsByPrefix(String bucketName, String prefix, boolean recursive) throws Exception;

    /**
     * 删除对象 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObject.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     */
    void removeObject(String bucketName, String objectName) throws Exception;

    /**
     * 判断文件是否存在 &lt;p&gt;
     * AmazonS3：
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @throws Exception
     */
    Boolean doesObjectExist(String bucketName, String objectName) throws Exception;

    /**
     * 列出已经存在的分片 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListParts.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @param uploadId   上传id
     * @throws Exception
     */
    List&lt;PartSummary&gt; listParts(String bucketName, String objectName, String uploadId) throws Exception;

    /**
     * 列出正在进行的上传操作 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/API/API_ListMultipartUploads.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @throws Exception
     */
    List&lt;MultipartUpload&gt; listMultiUploads(String bucketName) throws Exception;

    /**
     * 初始化分片上传任务 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateMultipartUpload.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @throws Exception
     */
    InitiateMultipartUploadResult initMultiUpload(String bucketName, String objectName) throws Exception;

    /**
     * 取消分片上传任务 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_AbortMultipartUpload.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @param uploadId   上传id
     * @throws Exception
     */
    void abortMultiUpload(String bucketName, String objectName, String uploadId) throws Exception;

    /**
     * 上传分片 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_UploadPart.html &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_UploadPartCopy.html &lt;p&gt;
     *
     * @param bucketName  bucket名称
     * @param objectName  文件名称
     * @param uploadId    上传id
     * @param inputStream 文件输入流
     * @param partNumber  分片号
     * @throws Exception
     */
    UploadPartResult uploadPart(String bucketName, String objectName, String uploadId,
                                InputStream inputStream, Integer partNumber) throws Exception;

    /**
     * 获取预签名上传url &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_GeneratePresignedUrl.html &lt;p&gt;
     *
     * @param bucketName bucket名称
     * @param objectName 文件名称
     * @param expireAt   过期时间
     * @param params     签名参数
     * @return 预签名上传URL
     * @throws Exception
     */
    String getPreSignUploadUrl(String bucketName, String objectName, Date expireAt, Map&lt;String, String&gt; params) throws Exception;

    /**
     * 合并分片 &lt;p&gt;
     * AmazonS3：https://docs.aws.amazon.com/AmazonS3/latest/API/API_CompleteMultipartUpload.html &lt;p&gt;
     * &lt;p&gt;
     * Note: Minio对象存储要求的最小分片是5MB {@link com.amazonaws.services.s3.AmazonS3#completeMultipartUpload(com.amazonaws.services.s3.model.CompleteMultipartUploadRequest)}
     *
     * @param bucketName bucket名称 bucket名称
     * @param objectName 文件名称 文件名
     * @param uploadId   上传id
     * @param chunkNum   分片数量
     * @return 上传结果
     * @throws Exception
     */
    CompleteMultipartUploadResult completeMultiUpload(String bucketName, String objectName, String uploadId, Integer chunkNum) throws Exception;
}
</code></pre>
<p>基于上面定义的 <code>OssTemplate</code> 接口，扩展了 <code>S3OssTemplate</code> <code>LfsOssTemplate</code>，分别对应与S3存储和本地文件存储</p>
<h3 id="13-oss操作类s3实现">1.3 OSS操作类S3实现</h3>
<p>实现 OssTemplate 里面的方法，调用 AmazonS3 JavaSDK 的方法实现。</p>
<p>AmazonS3 提供了众多的方法，这里就不写全部的了，公司要用到那些就写那些吧，后续扩展就行。</p>
<p>AmazonS3 接口地址: <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html">https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html</a></p>
<pre><code class="language-java">package com.light.cloud.sdk.oss.service.impl;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.net.URL;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

import org.apache.commons.collections4.MapUtils;
import org.apache.commons.lang3.StringUtils;

import org.springframework.http.MediaType;
import org.springframework.http.MediaTypeFactory;

import com.amazonaws.HttpMethod;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.internal.Mimetypes;
import com.amazonaws.services.s3.model.AbortMultipartUploadRequest;
import com.amazonaws.services.s3.model.Bucket;
import com.amazonaws.services.s3.model.CompleteMultipartUploadRequest;
import com.amazonaws.services.s3.model.CompleteMultipartUploadResult;
import com.amazonaws.services.s3.model.CopyObjectRequest;
import com.amazonaws.services.s3.model.CopyObjectResult;
import com.amazonaws.services.s3.model.GeneratePresignedUrlRequest;
import com.amazonaws.services.s3.model.GetObjectRequest;
import com.amazonaws.services.s3.model.InitiateMultipartUploadRequest;
import com.amazonaws.services.s3.model.InitiateMultipartUploadResult;
import com.amazonaws.services.s3.model.ListMultipartUploadsRequest;
import com.amazonaws.services.s3.model.ListObjectsRequest;
import com.amazonaws.services.s3.model.ListPartsRequest;
import com.amazonaws.services.s3.model.MetadataDirective;
import com.amazonaws.services.s3.model.MultipartUpload;
import com.amazonaws.services.s3.model.MultipartUploadListing;
import com.amazonaws.services.s3.model.ObjectListing;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PartETag;
import com.amazonaws.services.s3.model.PartListing;
import com.amazonaws.services.s3.model.PartSummary;
import com.amazonaws.services.s3.model.PutObjectResult;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.S3ObjectSummary;
import com.amazonaws.services.s3.model.UploadPartRequest;
import com.amazonaws.services.s3.model.UploadPartResult;
import com.amazonaws.util.IOUtils;
import com.light.cloud.common.core.exception.BizException;
import com.light.cloud.sdk.oss.properties.OssProperties;
import com.light.cloud.sdk.oss.service.OssTemplate;

/**
 * OSS操作业务实现
 *
 * @author Hui Liu
 * @date 2023/5/9
 */
public class S3OssTemplate implements OssTemplate {

    private final AmazonS3 amazonS3;

    private final OssProperties ossProperties;

    public S3OssTemplate(AmazonS3 amazonS3, OssProperties ossProperties) {
        this.amazonS3 = amazonS3;
        this.ossProperties = ossProperties;
    }

    @Override
    public Bucket createBucket(String bucketName) throws Exception {
        if (!amazonS3.doesBucketExistV2(bucketName)) {
            return amazonS3.createBucket((bucketName));
        }
        return null;
    }

    @Override
    public List&lt;Bucket&gt; listBuckets() throws Exception {
        return amazonS3.listBuckets();
    }

    @Override
    public void removeBucket(String bucketName) throws Exception {
        amazonS3.deleteBucket(bucketName);
    }

    @Override
    public PutObjectResult putObject(String bucketName, String objectName, InputStream inputStream, String contextType) throws Exception {
        return putObject(bucketName, objectName, inputStream, inputStream.available(), contextType);
    }

    @Override
    public PutObjectResult putObject(String bucketName, String objectName, InputStream stream) throws Exception {
        return putObject(bucketName, objectName, stream, stream.available(), Mimetypes.MIMETYPE_OCTET_STREAM);
    }

    private PutObjectResult putObject(String bucketName, String objectName, InputStream stream, long size,
                                      String contextType) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        byte[] bytes = IOUtils.toByteArray(stream);
        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentLength(size);
        objectMetadata.setContentType(contextType);
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);
        // 上传
        return amazonS3.putObject(bucketName, objectName, byteArrayInputStream, objectMetadata);
    }

    @Override
    public ObjectMetadata getObjectMetadata(String bucketName, String objectName) {
        return amazonS3.getObjectMetadata(bucketName, objectName);
    }

    @Override
    public S3Object getObject(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        return amazonS3.getObject(bucketName, objectName);
    }

    @Override
    public CopyObjectResult copyObject(String bucketName, String objectName, String newBucketName, String newObjectName) throws Exception {
        CopyObjectRequest request = new CopyObjectRequest();
        request.setSourceBucketName(bucketName);
        request.setSourceKey(objectName);
        request.setDestinationBucketName(newBucketName);
        request.setDestinationKey(newObjectName);
        request.setMetadataDirective(MetadataDirective.COPY.name());
        return amazonS3.copyObject(request);
    }

    @Override
    public void moveObject(String bucketName, String objectName, String newBucketName, String newObjectName) throws Exception {
        CopyObjectRequest request = new CopyObjectRequest();
        request.setSourceBucketName(bucketName);
        request.setSourceKey(objectName);
        request.setDestinationBucketName(newBucketName);
        request.setDestinationKey(newObjectName);
        request.setMetadataDirective(MetadataDirective.COPY.name());
        CopyObjectResult copyObjectResult = amazonS3.copyObject(request);

        if (Objects.nonNull(copyObjectResult)) {
            amazonS3.deleteObject(bucketName, objectName);
        }
    }

    @Override
    public S3Object getObjectWithRange(String bucketName, String objectName, Long startByte, Long endByte) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        GetObjectRequest request = new GetObjectRequest(bucketName, objectName)
                .withRange(startByte, endByte);
        return amazonS3.getObject(request);
    }

    @Override
    public String getPreSignViewUrl(String bucketName, String objectName, Date expireAt) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        GeneratePresignedUrlRequest request = new GeneratePresignedUrlRequest(bucketName, objectName)
                .withExpiration(expireAt)
                .withMethod(HttpMethod.PUT);
        URL url = amazonS3.generatePresignedUrl(request);
        return url.toString();
    }

    @Override
    public List&lt;S3ObjectSummary&gt; listObjects(String bucketName, boolean recursive) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        ListObjectsRequest request = new ListObjectsRequest();
        request.setBucketName(bucketName);
        ObjectListing objectListing = amazonS3.listObjects(request);
        return objectListing.getObjectSummaries();
    }

    @Override
    public List&lt;S3ObjectSummary&gt; listObjectsByPrefix(String bucketName, String prefix, boolean recursive) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        ListObjectsRequest request = new ListObjectsRequest();
        request.setBucketName(bucketName);
        request.setPrefix(prefix);
        ObjectListing objectListing = amazonS3.listObjects(request);
        return objectListing.getObjectSummaries();
    }

    @Override
    public void removeObject(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        amazonS3.deleteObject(bucketName, objectName);
    }

    @Override
    public Boolean doesObjectExist(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        return amazonS3.doesObjectExist(bucketName, objectName);
    }

    @Override
    public List&lt;PartSummary&gt; listParts(String bucketName, String objectName, String uploadId) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        ListPartsRequest request = new ListPartsRequest(bucketName, objectName, uploadId);
        PartListing partListing = amazonS3.listParts(request);
        return partListing.getParts();
    }

    @Override
    public List&lt;MultipartUpload&gt; listMultiUploads(String bucketName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        ListMultipartUploadsRequest request = new ListMultipartUploadsRequest(bucketName);
        MultipartUploadListing result = amazonS3.listMultipartUploads(request);
        return result.getMultipartUploads();
    }

    @Override
    public InitiateMultipartUploadResult initMultiUpload(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        String contentType = MediaTypeFactory.getMediaType(objectName)
                .orElse(MediaType.APPLICATION_OCTET_STREAM).toString();
        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentType(contentType);
        InitiateMultipartUploadRequest request = new InitiateMultipartUploadRequest(bucketName, objectName)
                .withObjectMetadata(objectMetadata);
        return amazonS3.initiateMultipartUpload(request);
    }

    @Override
    public void abortMultiUpload(String bucketName, String objectName, String uploadId) throws Exception {
        AbortMultipartUploadRequest request = new AbortMultipartUploadRequest(bucketName, objectName, uploadId);
        amazonS3.abortMultipartUpload(request);
    }

    @Override
    public UploadPartResult uploadPart(String bucketName, String objectName, String uploadId,
                                       InputStream inputStream, Integer partNumber) throws Exception {
        byte[] bytes = IOUtils.toByteArray(inputStream);
        UploadPartRequest request = new UploadPartRequest()
                .withBucketName(bucketName)
                .withKey(objectName)
                .withUploadId(uploadId)
                .withPartNumber(partNumber)
                .withInputStream(new ByteArrayInputStream(bytes))
                .withPartSize(bytes.length);
        return amazonS3.uploadPart(request);
    }

    @Override
    public String getPreSignUploadUrl(String bucketName, String objectName, Date expireAt, Map&lt;String, String&gt; params) throws Exception {
        GeneratePresignedUrlRequest request = new GeneratePresignedUrlRequest(bucketName, objectName)
                .withExpiration(expireAt)
                .withMethod(HttpMethod.PUT);
        if (MapUtils.isNotEmpty(params)) {
            params.forEach(request::addRequestParameter);
        }
        return amazonS3.generatePresignedUrl(request).toString();
    }

    @Override
    public CompleteMultipartUploadResult completeMultiUpload(String bucketName, String objectName, String uploadId, Integer chunkNum) throws Exception {
        List&lt;PartSummary&gt; parts = listParts(bucketName, objectName, uploadId);
        if (!chunkNum.equals(parts.size())) {
            // 已上传分块数量与记录中的数量不对应，不能合并分块
            throw BizException.throwException(&quot;分片缺失，请重新上传&quot;);
        }
        List&lt;PartETag&gt; partETagList = parts.stream()
                .map(partSummary -&gt; new PartETag(partSummary.getPartNumber(), partSummary.getETag()))
                .collect(Collectors.toList());
        CompleteMultipartUploadRequest request = new CompleteMultipartUploadRequest()
                .withBucketName(bucketName)
                .withKey(objectName)
                .withUploadId(uploadId)
                .withPartETags(partETagList);
        return amazonS3.completeMultipartUpload(request);
    }

}
</code></pre>
<h3 id="14-oss操作类localfilesystem实现">1.4 OSS操作类LocalFileSystem实现</h3>
<p>实现 OssTemplate 里面的方法，基于本地文件系统实现。 主要是用于本地的演示，以及加深对文件系统的理解，不适用于生产环境。</p>
<pre><code class="language-java">package com.light.cloud.sdk.oss.service.impl;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FilenameFilter;
import java.io.InputStream;
import java.net.URI;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.UUID;

import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;

import org.springframework.http.MediaType;
import org.springframework.http.MediaTypeFactory;

import com.amazonaws.services.s3.internal.Mimetypes;
import com.amazonaws.services.s3.model.Bucket;
import com.amazonaws.services.s3.model.CompleteMultipartUploadResult;
import com.amazonaws.services.s3.model.CopyObjectResult;
import com.amazonaws.services.s3.model.InitiateMultipartUploadResult;
import com.amazonaws.services.s3.model.MultipartUpload;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PartSummary;
import com.amazonaws.services.s3.model.PutObjectResult;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.S3ObjectSummary;
import com.amazonaws.services.s3.model.UploadPartResult;
import com.light.cloud.common.core.constant.BaseConstant;
import com.light.cloud.common.core.crypto.AESTool;
import com.light.cloud.common.core.exception.BizException;
import com.light.cloud.common.core.tool.DateTool;
import com.light.cloud.common.core.tool.JsonTool;
import com.light.cloud.sdk.oss.properties.OssProperties;
import com.light.cloud.sdk.oss.service.OssTemplate;

/**
 * 本地文件存储实现 LocalFileSystemTemplate
 *
 * @author Hui Liu
 * @date 2023/5/9
 */
public class LfsOssTemplate implements OssTemplate {

    public static final String DEFAULT_PART_BUCKET = &quot;partUpload&quot;;
    private final OssProperties ossProperties;

    public LfsOssTemplate(OssProperties ossProperties) {
        this.ossProperties = ossProperties;
        URI endpoint = ossProperties.getEndpoint();
        File rootFolder = new File(endpoint);
        if (!rootFolder.exists()) {
            rootFolder.mkdirs();
        }
    }

    public File getRootFolder() {
        URI endpoint = ossProperties.getEndpoint();
        return new File(endpoint);
    }

    public File getBucketFolder(String bucketName) {
        URI endpoint = ossProperties.getEndpoint();
        return new File(endpoint.getPath(), bucketName);
    }

    public File getFile(String bucketName, String objectName) {
        URI endpoint = ossProperties.getEndpoint();
        File bucketFolder = new File(endpoint.getPath(), bucketName);
        return new File(bucketFolder, objectName);
    }

    public File getPartBucketFolder(String bucketName) {
        URI endpoint = ossProperties.getEndpoint();
        File partBucketFolder = new File(endpoint.getPath(), DEFAULT_PART_BUCKET);
        return new File(partBucketFolder, bucketName);
    }

    public File getPartFolder(String bucketName, String objectName, String uploadId) {
        URI endpoint = ossProperties.getEndpoint();
        File partBucketFolder = new File(endpoint.getPath(), DEFAULT_PART_BUCKET);
        File bucketFolder = new File(partBucketFolder, bucketName);
        return new File(bucketFolder, objectName + BaseConstant.UNDERSCORE + uploadId);
    }

    public String getPartFilename(String filename, Integer partNumber) {
        return filename + BaseConstant.DOT + partNumber;
    }

    public Integer getPartNumber(String partFilename) {
        String partNum = partFilename.substring(partFilename.lastIndexOf(BaseConstant.DOT) + 1);
        return Integer.parseInt(partNum);
    }

    public String getETag(String bucketName, String objectName) {
        return AESTool.encryptBase64(objectName, bucketName);
    }

    public static File[] listFiles(File file, String prefix, Boolean recursion) {
        if (Objects.isNull(file)) {
            return new File[0];
        }
        if (file.isFile()) {
            return new File[]{file};
        }
        FilenameFilter filenameFilter = (dir, name) -&gt; {
            if (dir.isDirectory()) {
                return recursion;
            }
            if (StringUtils.isNotBlank(prefix)) {
                return name.startsWith(prefix);
            }
            return true;
        };
        return file.listFiles(filenameFilter);
    }

    @Override
    public Bucket createBucket(String bucketName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File bucketFolder = getBucketFolder(bucketName);
        if (!bucketFolder.exists()) {
            bucketFolder.mkdirs();
        }
        Bucket bucket = new Bucket();
        bucket.setName(bucketName);
        bucket.setCreationDate(DateTool.now());
        return bucket;
    }

    @Override
    public List&lt;Bucket&gt; listBuckets() throws Exception {
        File rootFolder = getRootFolder();
        int idx = rootFolder.getPath().length() + 1;
        File[] folders = rootFolder.listFiles();
        if (ArrayUtils.isEmpty(folders)) {
            return Collections.emptyList();
        }

        List&lt;Bucket&gt; buckets = new ArrayList&lt;&gt;();
        Date now = DateTool.now();
        for (File folder : folders) {
            String path = folder.getPath();
            Bucket bucket = new Bucket();
            bucket.setName(path.substring(idx));
            bucket.setCreationDate(now);

            buckets.add(bucket);
        }
        return buckets;
    }

    @Override
    public void removeBucket(String bucketName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File bucketFolder = getBucketFolder(bucketName);
        bucketFolder.delete();
    }

    @Override
    public PutObjectResult putObject(String bucketName, String objectName, InputStream inputStream, String contextType) throws Exception {
        return putObject(bucketName, objectName, inputStream, inputStream.available(), contextType);
    }

    @Override
    public PutObjectResult putObject(String bucketName, String objectName, InputStream stream) throws Exception {
        return putObject(bucketName, objectName, stream, stream.available(), Mimetypes.MIMETYPE_OCTET_STREAM);
    }

    private PutObjectResult putObject(String bucketName, String objectName, InputStream stream, long size,
                                      String contextType) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentLength(size);
        objectMetadata.setContentType(contextType);
        // 上传
        File file = getFile(bucketName, objectName);
        FileUtils.copyInputStreamToFile(stream, file);

        PutObjectResult result = new PutObjectResult();
        result.setETag(getETag(bucketName, objectName));
        result.setMetadata(objectMetadata);
        return result;
    }

    @Override
    public ObjectMetadata getObjectMetadata(String bucketName, String objectName) {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }

        File file = getFile(bucketName, objectName);
        String contentType = MediaTypeFactory.getMediaType(objectName)
                .orElse(MediaType.APPLICATION_OCTET_STREAM).toString();

        ObjectMetadata result = new ObjectMetadata();
        result.setLastModified(new Date(file.lastModified()));
        result.setContentLength(file.length());
        result.setContentType(contentType);
        return result;
    }

    @Override
    public S3Object getObject(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }

        File file = getFile(bucketName, objectName);
        // 下载文件
        S3Object result = new S3Object();
        result.setBucketName(bucketName);
        result.setKey(objectName);
        result.setObjectContent(new FileInputStream(file));
        return result;
    }

    @Override
    public CopyObjectResult copyObject(String bucketName, String objectName, String newBucketName, String newObjectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }

        File file = getFile(bucketName, objectName);
        // 复制文件
        File newBucketFolder = getBucketFolder(newBucketName);
        if (!newBucketFolder.exists()) {
            newBucketFolder.mkdirs();
        }
        File newFile = getFile(newBucketName, newObjectName);
        FileUtils.copyFile(file, newFile);

        CopyObjectResult result = new CopyObjectResult();
        result.setETag(getETag(newBucketName, newObjectName));
        result.setLastModifiedDate(DateTool.now());
        return result;
    }

    @Override
    public void moveObject(String bucketName, String objectName, String newBucketName, String newObjectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }

        File file = getFile(bucketName, objectName);
        // 复制文件
        File newBucketFolder = getBucketFolder(newBucketName);
        if (!newBucketFolder.exists()) {
            newBucketFolder.mkdirs();
        }
        File newFile = getFile(newBucketName, newObjectName);
        FileUtils.copyFile(file, newFile);
        // 删除文件
        file.delete();
    }

    @Override
    public S3Object getObjectWithRange(String bucketName, String objectName, Long startByte, Long endByte) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File file = getFile(bucketName, objectName);
        FileInputStream inputStream = new FileInputStream(file);

        // 获取指定范围的字节
        byte[] buffer = new byte[(int) (endByte - startByte + 1)];
        inputStream.skip(startByte);
        int byteRead = inputStream.read(buffer);
        if (byteRead &lt;= 0) {
            return null;
        }
        // 下载文件
        S3Object result = new S3Object();
        result.setBucketName(bucketName);
        result.setKey(objectName);
        result.setObjectContent(new ByteArrayInputStream(buffer, 0, byteRead));
        return result;
    }

    @Override
    public String getPreSignViewUrl(String bucketName, String objectName, Date expireAt) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        Map&lt;String, Object&gt; urlParam = new HashMap&lt;&gt;();
        urlParam.put(&quot;bucketName&quot;, bucketName);
        urlParam.put(&quot;objectName&quot;, objectName);
        urlParam.put(&quot;expireAt&quot;, DateTool.format(expireAt, DateTool.PATTERN_YYYYMMDDHHMMSS));
        URI uri = URI.create(ossProperties.getPreSignUrl() + BaseConstant.SLASH + AESTool.encryptBase64(JsonTool.beanToJson(urlParam)));
        return uri.toString();
    }

    @Override
    public List&lt;S3ObjectSummary&gt; listObjects(String bucketName, boolean recursive) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File bucketFolder = getBucketFolder(bucketName);
        if (!bucketFolder.exists()) {
            return Collections.emptyList();
        }

        File[] subFiles = listFiles(bucketFolder, null, recursive);

        List&lt;S3ObjectSummary&gt; summaryList = new ArrayList&lt;&gt;();
        for (File subFile : subFiles) {
            if (subFile.isDirectory()) {
                continue;
            }
            S3ObjectSummary s3ObjectSummary = new S3ObjectSummary();
            s3ObjectSummary.setBucketName(bucketName);
            s3ObjectSummary.setKey(subFile.getName());
            s3ObjectSummary.setLastModified(new Date(subFile.lastModified()));
            s3ObjectSummary.setSize(subFile.length());
            s3ObjectSummary.setETag(getETag(bucketName, subFile.getName()));

            summaryList.add(s3ObjectSummary);
        }
        return summaryList;
    }

    @Override
    public List&lt;S3ObjectSummary&gt; listObjectsByPrefix(String bucketName, String prefix, boolean recursive) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File bucketFolder = getBucketFolder(bucketName);
        if (!bucketFolder.exists()) {
            return Collections.emptyList();
        }
        File[] subFiles = listFiles(bucketFolder, prefix, recursive);

        List&lt;S3ObjectSummary&gt; summaryList = new ArrayList&lt;&gt;();
        for (File subFile : subFiles) {
            if (subFile.isDirectory()) {
                continue;
            }
            S3ObjectSummary s3ObjectSummary = new S3ObjectSummary();
            s3ObjectSummary.setBucketName(bucketName);
            s3ObjectSummary.setKey(subFile.getName());
            s3ObjectSummary.setLastModified(new Date(subFile.lastModified()));
            s3ObjectSummary.setSize(subFile.length());
            s3ObjectSummary.setETag(getETag(bucketName, subFile.getName()));

            summaryList.add(s3ObjectSummary);
        }
        return summaryList;
    }

    @Override
    public void removeObject(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File file = getFile(bucketName, objectName);
        file.delete();
    }

    @Override
    public Boolean doesObjectExist(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File file = getFile(bucketName, objectName);
        return file.exists();
    }

    @Override
    public List&lt;PartSummary&gt; listParts(String bucketName, String objectName, String uploadId) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File partFolder = getPartFolder(bucketName, objectName, uploadId);
        File[] partFiles = partFolder.listFiles();
        if (ArrayUtils.isEmpty(partFiles)) {
            return Collections.emptyList();
        }

        List&lt;PartSummary&gt; parts = new ArrayList&lt;&gt;();
        for (File partFile : partFiles) {
            String partFilename = partFile.getName();
            Integer partNumber = getPartNumber(partFilename);
            PartSummary partSummary = new PartSummary();
            partSummary.setPartNumber(partNumber);
            partSummary.setSize(partFile.length());
            partSummary.setETag(getETag(bucketName, partFilename));
            partSummary.setLastModified(new Date(partFile.lastModified()));

            parts.add(partSummary);
        }
        return parts;
    }

    @Override
    public List&lt;MultipartUpload&gt; listMultiUploads(String bucketName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File partBucketFolder = getPartBucketFolder(bucketName);
        File[] partFolders = partBucketFolder.listFiles();
        if (ArrayUtils.isEmpty(partFolders)) {
            return Collections.emptyList();
        }

        List&lt;MultipartUpload&gt; uploads = new ArrayList&lt;&gt;();
        for (File partFolder : partFolders) {
            String partFolderName = partFolder.getName();
            String[] split = partFolderName.split(&quot;_&quot;);
            MultipartUpload multipartUpload = new MultipartUpload();
            multipartUpload.setUploadId(split[1]);
            multipartUpload.setKey(split[0]);

            uploads.add(multipartUpload);
        }
        return uploads;
    }

    @Override
    public InitiateMultipartUploadResult initMultiUpload(String bucketName, String objectName) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        String uploadId = UUID.randomUUID().toString().replace(BaseConstant.DASH, BaseConstant.EMPTY);

        File partFolder = getPartFolder(bucketName, objectName, uploadId);
        if (!partFolder.exists()) {
            partFolder.mkdirs();
        }

        InitiateMultipartUploadResult result = new InitiateMultipartUploadResult();
        result.setBucketName(bucketName);
        result.setKey(objectName);
        result.setUploadId(uploadId);
        return result;
    }

    @Override
    public void abortMultiUpload(String bucketName, String objectName, String uploadId) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File partFolder = getPartFolder(bucketName, objectName, uploadId);
        partFolder.delete();
    }

    @Override
    public UploadPartResult uploadPart(String bucketName, String objectName, String uploadId,
                                       InputStream inputStream, Integer partNumber) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        File partFolder = getPartFolder(bucketName, objectName, uploadId);
        // 上传分片
        File partFile = new File(partFolder, getPartFilename(objectName, partNumber));
        FileUtils.copyInputStreamToFile(inputStream, partFile);

        UploadPartResult result = new UploadPartResult();
        result.setETag(getETag(bucketName, partFile.getName()));
        result.setPartNumber(partNumber);
        return result;
    }

    @Override
    public String getPreSignUploadUrl(String bucketName, String objectName, Date expireAt, Map&lt;String, String&gt; params) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        Map&lt;String, Object&gt; urlParam = new HashMap&lt;&gt;(8);
        urlParam.put(&quot;bucketName&quot;, bucketName);
        urlParam.put(&quot;objectName&quot;, objectName);
        urlParam.put(&quot;expireAt&quot;, DateTool.format(expireAt, DateTool.PATTERN_YYYYMMDDHHMMSS));
        urlParam.putAll(params);
        URI uri = URI.create(ossProperties.getPreSignUrl() + BaseConstant.SLASH + AESTool.encryptBase64(JsonTool.beanToJson(urlParam)));
        return uri.toString();
    }

    @Override
    public CompleteMultipartUploadResult completeMultiUpload(String bucketName, String objectName, String uploadId, Integer chunkNum) throws Exception {
        if (StringUtils.isBlank(bucketName)) {
            bucketName = ossProperties.getDefaultBucket();
        }
        // 合并前的分片文件夹
        File partFolder = getPartFolder(bucketName, objectName, uploadId);
        File[] parts = partFolder.listFiles();
        if (ArrayUtils.isEmpty(parts) || !chunkNum.equals(parts.length)) {
            // 已上传分块数量与记录中的数量不对应，不能合并分块
            throw BizException.throwException(&quot;分片缺失，请重新上传&quot;);
        }

        // 合并后的文件
        File mergeFile = getFile(bucketName, objectName);
        // 执行合并
        try (BufferedOutputStream outputStream = new BufferedOutputStream(Files.newOutputStream(mergeFile.toPath()))) {
            List&lt;File&gt; partList = Arrays.stream(parts).sorted(Comparator.comparing(File::getName)).toList();

            int len;
            byte[] bytes = new byte[1024];
            for (File part : partList) {
                BufferedInputStream inputStream = new BufferedInputStream(Files.newInputStream(part.toPath()));

                while ((len = inputStream.read(bytes)) != -1) {
                    outputStream.write(bytes, 0, len);
                }
                inputStream.close();
            }
        }
        CompleteMultipartUploadResult result = new CompleteMultipartUploadResult();
        result.setBucketName(bucketName);
        result.setKey(objectName);
        result.setETag(getETag(bucketName, mergeFile.getName()));
        return result;
    }

}
</code></pre>
<h3 id="15-oss配置属性类-ossproperties">1.5 OSS配置属性类 OssProperties</h3>
<p>OssTemplate 相关的配置属性，方便客户端进行定制化配置，可以根据需求进行属性增删</p>
<pre><code class="language-java">package com.light.cloud.sdk.oss.properties;

import java.net.URI;

import org.springframework.boot.context.properties.ConfigurationProperties;

import lombok.Data;

/**
 * OSS属性配置
 *
 * @author Hui Liu
 * @date 2023/5/9
 */
@Data
@ConfigurationProperties(prefix = OssProperties.PREFIX)
public class OssProperties {

    public static final String PREFIX = &quot;light.cloud.oss&quot;;

    /**
     * 对象存储服务的URL
     */
    private URI endpoint;

    /**
     * 区域
     */
    private String region;

    /**
     * true path-style nginx 反向代理和S3默认支持 pathStyle模式 {http://endpoint/bucketname}
     * false supports virtual-hosted-style 阿里云等需要配置为 virtual-hosted-style 模式{http://bucketname.endpoint}
     * 只是url的显示不一样
     */
    private Boolean pathStyleAccess = true;

    /**
     * Access key
     */
    private String accessKey;

    /**
     * Secret key
     */
    private String secretKey;

    /**
     * 默认的读写 Bucket
     */
    private String defaultBucket;

    /**
     * 预签名地址
     */
    private String preSignUrl;

    /**
     * 最大线程数，默认：100
     */
    private Integer maxConnections = 100;

    /**
     * 使用本地文件系统 use Local FileSystem
     */
    public Boolean local = false;

}
</code></pre>
<h3 id="16-oss自动配置类-ossautoconfiguration">1.6 OSS自动配置类 OssAutoConfiguration</h3>
<p>自动装配类，将 OssTemplate 实现注入到Spring 容器中，开箱即用。</p>
<pre><code class="language-java">package com.light.cloud.sdk.oss.configuration;

import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.amazonaws.ClientConfiguration;
import com.amazonaws.auth.AWSCredentials;
import com.amazonaws.auth.AWSCredentialsProvider;
import com.amazonaws.auth.AWSStaticCredentialsProvider;
import com.amazonaws.auth.BasicAWSCredentials;
import com.amazonaws.client.builder.AwsClientBuilder;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.AmazonS3Client;
import com.light.cloud.sdk.oss.properties.OssProperties;
import com.light.cloud.sdk.oss.service.OssTemplate;
import com.light.cloud.sdk.oss.service.impl.LfsOssTemplate;
import com.light.cloud.sdk.oss.service.impl.S3OssTemplate;
import lombok.RequiredArgsConstructor;

/**
 * OSS配置类
 *
 * @author Hui Liu
 * @date 2023/5/9
 */
@Configuration
@RequiredArgsConstructor
@EnableConfigurationProperties(OssProperties.class)
public class OssAutoConfiguration {

    @Bean
    @ConditionalOnMissingBean
    @ConditionalOnProperty(prefix = OssProperties.PREFIX, name = &quot;local&quot;, havingValue = &quot;false&quot;, matchIfMissing = true)
    public AmazonS3 ossClient(OssProperties ossProperties) {
        // 客户端配置，主要是全局的配置信息
        ClientConfiguration clientConfiguration = new ClientConfiguration();
        clientConfiguration.setMaxConnections(ossProperties.getMaxConnections());
        // url以及region配置
        AwsClientBuilder.EndpointConfiguration endpointConfiguration = new AwsClientBuilder.EndpointConfiguration(
                ossProperties.getEndpoint().toString(), ossProperties.getRegion());
        // 凭证配置
        AWSCredentials awsCredentials = new BasicAWSCredentials(ossProperties.getAccessKey(),
                ossProperties.getSecretKey());
        AWSCredentialsProvider awsCredentialsProvider = new AWSStaticCredentialsProvider(awsCredentials);
        // build amazonS3Client客户端
        return AmazonS3Client.builder().withEndpointConfiguration(endpointConfiguration)
                .withClientConfiguration(clientConfiguration).withCredentials(awsCredentialsProvider)
                .disableChunkedEncoding().withPathStyleAccessEnabled(ossProperties.getPathStyleAccess()).build();
    }

    @Bean
    @ConditionalOnBean(AmazonS3.class)
    public OssTemplate ossTemplate(AmazonS3 amazonS3, OssProperties ossProperties) {
        return new S3OssTemplate(amazonS3, ossProperties);
    }

    @Bean
    @ConditionalOnProperty(prefix = OssProperties.PREFIX, name = &quot;local&quot;, havingValue = &quot;true&quot;)
    public OssTemplate lfsOssTemplate(OssProperties ossProperties) {
        return new LfsOssTemplate(ossProperties);
    }

}
</code></pre>
<h3 id="17-springboot自动装配配置文件">1.7 SpringBoot自动装配配置文件</h3>
<h4 id="171-spring-boot-2x">1.7.1 Spring Boot 2.x</h4>
<p>Spring Boot 2.x的自动装配文件 <code>resouces/META-INF/spring.factories</code></p>
<pre><code class="language-factories"># Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.light.cloud.sdk.oss.configuration.OssAutoConfiguration
</code></pre>
<h4 id="172-spring-boot-3x">1.7.2 Spring Boot 3.x</h4>
<p>Spring Boot 2.x的自动装配文件 <code>resouces/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code></p>
<pre><code class="language-imports">com.light.cloud.sdk.oss.configuration.OssAutoConfiguration
</code></pre>
<h3 id="18-applicationyaml配置示例">1.8 application.yaml配置示例</h3>
<pre><code class="language-yaml"># 使用MinIO S3 Aliyun Tencent登OSS存储
light:
  cloud:
    oss:
      endpoint: http://127.0.0.1:9000
      access-key: admin
      secret-key: secret
      default-bucket: light
      pre-sign-url: http://127.0.0.1:9001
      region: cn-wuhan
      max-connections: 100
      path-style-access: true
      local: false

---

# 使用本地文件系统 LocalFileSystem
light:
  cloud:
    oss:
      endpoint: file:///d:/storage/
      default-bucket: light
      pre-sign-url: http://127.0.0.1:80/file
      local: true

</code></pre>
<h2 id="二环境准备">二、环境准备</h2>
<h3 id="21-搭建minio-server">2.1 搭建MinIO Server</h3>
<pre><code class="language-shell">docker run -d \
  --publish 9000:9000 \
  --publish 9001:9001 \
  --volume //d/docker/minio/data:/data \
  --env MINIO_ROOT_USER=minioaccess \
  --env MINIO_ROOT_PASSWORD=miniosecret \
  --env MINIO_SERVER_URL=http://minio.example.net:9000 \
  --net dev \
  --restart=on-failure:3 \
  --name minio \
  minio/minio:RELEASE.2023-05-18T00-05-36Z server /data --console-address &quot;:9001&quot;
</code></pre>
<h3 id="22-初始化数据库">2.2 初始化数据库</h3>
<p>以下为pgsql数据库脚  本示例</p>
<pre><code class="language-sql">-- ----------------------------
-- Table structure for slice_upload
-- ----------------------------
DROP TABLE IF EXISTS &quot;public&quot;.&quot;slice_upload&quot;;
CREATE TABLE &quot;public&quot;.&quot;slice_upload&quot;
(
    &quot;id&quot;                int8                                        NOT NULL,
    &quot;file_identifier&quot;   varchar(64) COLLATE &quot;pg_catalog&quot;.&quot;default&quot;  NOT NULL,
    &quot;filename&quot;          varchar(255) COLLATE &quot;pg_catalog&quot;.&quot;default&quot; NOT NULL,
    &quot;bucket_name&quot;       varchar(64) COLLATE &quot;pg_catalog&quot;.&quot;default&quot;  NOT NULL,
    &quot;object_name&quot;       varchar(255) COLLATE &quot;pg_catalog&quot;.&quot;default&quot; NOT NULL,
    &quot;upload_id&quot;         varchar(255) COLLATE &quot;pg_catalog&quot;.&quot;default&quot; NOT NULL,
    &quot;total_size&quot;        int8                                        NOT NULL,
    &quot;chunk_size&quot;        int8                                        NOT NULL,
    &quot;chunk_num&quot;         int4                                        NOT NULL,
    &quot;deleted&quot;           int4                                        NOT NULL,
    &quot;data_dept_id&quot;      int8                                        NOT NULL,
    &quot;remark&quot;            varchar(255) COLLATE &quot;pg_catalog&quot;.&quot;default&quot;,
    &quot;created_user&quot;      int8                                        NOT NULL,
    &quot;created_user_name&quot; varchar(32) COLLATE &quot;pg_catalog&quot;.&quot;default&quot;  NOT NULL,
    &quot;created_time&quot;      timestamp(6)                                NOT NULL,
    &quot;updated_user&quot;      int8                                        NOT NULL,
    &quot;updated_user_name&quot; varchar(32) COLLATE &quot;pg_catalog&quot;.&quot;default&quot;  NOT NULL,
    &quot;updated_time&quot;      timestamp(6)                                NOT NULL,
    &quot;revision&quot;          int4                                        NOT NULL,
    &quot;tenant_id&quot;         int8                                        NOT NULL
);

COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;id&quot; IS &#x27;主键&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;file_identifier&quot; IS &#x27;文件唯一标识 MD5&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;filename&quot; IS &#x27;文件名&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;bucket_name&quot; IS &#x27;S3存储桶&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;object_name&quot; IS &#x27;S3文件的key&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;upload_id&quot; IS &#x27;S3分片上传的 uploadId&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;total_size&quot; IS &#x27;文件大小 bytes&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;chunk_size&quot; IS &#x27;每个分片大小 bytes&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;chunk_num&quot; IS &#x27;分片数量&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;deleted&quot; IS &#x27;是否删除;0-否；1-是&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;data_dept_id&quot; IS &#x27;数据所属部门id&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;remark&quot; IS &#x27;备注&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;created_user&quot; IS &#x27;创建人Id&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;created_user_name&quot; IS &#x27;创建人&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;created_time&quot; IS &#x27;创建时间&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;updated_user&quot; IS &#x27;更新人Id&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;updated_user_name&quot; IS &#x27;更新人&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;updated_time&quot; IS &#x27;更新时间&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;revision&quot; IS &#x27;乐观锁&#x27;;
COMMENT ON COLUMN &quot;public&quot;.&quot;slice_upload&quot;.&quot;tenant_id&quot; IS &#x27;租户号&#x27;;
COMMENT ON TABLE &quot;public&quot;.&quot;slice_upload&quot; IS &#x27;分片上传表&#x27;;

-- ----------------------------
-- Primary Key structure for table slice_upload
-- ----------------------------
ALTER TABLE &quot;public&quot;.&quot;slice_upload&quot;
    ADD CONSTRAINT &quot;slice_upload_pkey&quot; PRIMARY KEY (&quot;id&quot;);

</code></pre>
<h2 id="三使用示例">三、使用示例</h2>
<p>对于文件的简单操作接口示例，包括</p>
<ul>
<li>添加存储桶</li>
<li>删除存储桶</li>
<li>获取存储桶列表</li>
<li>获取文件列表</li>
<li>上传文件</li>
<li>下载文件</li>
<li>获取文件的预览url</li>
</ul>
<h3 id="31-接口定义">3.1 接口定义</h3>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;/oss&quot;)
@Tags(value = {
        @Tag(name = &quot;【1.0.0】-【OSS】&quot;)
})
public class OssController {

    @Autowired(required = false)
    private FileService fileService;

    @PostMapping(&quot;bucket/create&quot;)
    @Operation(summary = &quot;【新建存储桶】&quot;, description = &quot;Hui Liu&quot;)
    @Parameters(value = {
            @Parameter(name = &quot;bucketName&quot;, description = &quot;bucket&quot;, in = ParameterIn.QUERY)
    })
    public Result&lt;Bucket&gt; createBucket(@RequestParam String bucketName) throws Exception {
        Bucket result = fileService.createBucket(bucketName);
        return Result.success(result);
    }

    @GetMapping(&quot;bucket/list&quot;)
    @Operation(summary = &quot;【存储桶列表】&quot;, description = &quot;Hui Liu&quot;)
    public Result&lt;List&lt;Bucket&gt;&gt; listBucket() throws Exception {
        List&lt;Bucket&gt; results = fileService.listBuckets();
        return Result.success(results);
    }

    @DeleteMapping(&quot;bucket/delete&quot;)
    @Operation(summary = &quot;【删除存储桶】&quot;, description = &quot;Hui Liu&quot;)
    @Parameters(value = {
            @Parameter(name = &quot;bucketName&quot;, description = &quot;bucket&quot;, in = ParameterIn.QUERY)
    })
    public Result&lt;Boolean&gt; removeBucket(@RequestParam String bucketName) throws Exception {
        fileService.removeBucket(bucketName);
        return Result.success(true);
    }

    @GetMapping(&quot;list&quot;)
    @Operation(summary = &quot;【文件列表】&quot;, description = &quot;Hui Liu&quot;)
    @Parameters(value = {
            @Parameter(name = &quot;bucketName&quot;, description = &quot;bucket&quot;, in = ParameterIn.QUERY)
    })
    public Result&lt;List&lt;S3ObjectSummary&gt;&gt; list(String bucketName) throws Exception {
        List&lt;S3ObjectSummary&gt; results = fileService.listObjects(bucketName, true);
        return Result.success(results);
    }

    @PostMapping(&quot;upload&quot;)
    @Operation(summary = &quot;【上传文件】&quot;, description = &quot;Hui Liu&quot;)
    @Parameters(value = {
            @Parameter(name = &quot;file&quot;, description = &quot;文件&quot;, in = ParameterIn.QUERY)
    })
    public Result&lt;PutObjectResult&gt; upload(MultipartFile file) throws Exception {
        PutObjectResult result = fileService.putObject(null, file.getOriginalFilename(), file.getInputStream(), file.getContentType());
        return Result.success(result);
    }

    @PostMapping(&quot;preview&quot;)
    @Operation(summary = &quot;【获取预览url】&quot;, description = &quot;Hui Liu&quot;)
    @Parameters(value = {
            @Parameter(name = &quot;filename&quot;, description = &quot;文件名&quot;, in = ParameterIn.QUERY)
    })
    public Result&lt;String&gt; preview(@RequestParam String filename) throws Exception {
        String result = fileService.getPreSignViewUrl(null, filename, DateTool.fromNow(Duration.ofHours(1L)));
        return Result.success(result);
    }

    @GetMapping(&quot;download&quot;)
    @Operation(summary = &quot;【下载文件】&quot;, description = &quot;Hui Liu&quot;)
    @Parameters(value = {
            @Parameter(name = &quot;filename&quot;, description = &quot;文件名&quot;, in = ParameterIn.QUERY)
    })
    public void download(@RequestParam String filename, HttpServletResponse response) throws Exception {
        S3Object object = fileService.getObject(null, filename);
        byte[] results = object.getObjectContent().readAllBytes();
        download(response, filename, results);
    }

    public void download(HttpServletResponse response, String filename, byte[] bytes) throws IOException {
        try {
            // 防止中文乱码
            String encodedFilename = URLEncoder.encode(filename, StandardCharsets.UTF_8.name())
                    .replaceAll(&quot;\\+&quot;, &quot;%20&quot;);

            MediaType mediaType = MediaTypeFactory.getMediaType(filename)
                    .orElse(MediaType.APPLICATION_OCTET_STREAM);

            HttpHeaders headers = new HttpHeaders();
            headers.setContentLength(bytes.length);
            headers.setContentType(mediaType);
            headers.setAccessControlAllowOrigin(&quot;*&quot;);
            headers.setContentDisposition(ContentDisposition.attachment().filename(encodedFilename).build());

            for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : headers.entrySet()) {
                response.setHeader(entry.getKey(), entry.getValue().getFirst());
            }
            ServletOutputStream outputStream = response.getOutputStream();
            outputStream.write(bytes);
            outputStream.flush();
        } catch (Exception e) {
            throw BizException.throwException(ResponseEnum.EXCEL_EXPORT_ERROR.getDesc(), e);
        }
    }
}
</code></pre>
<h3 id="32-业务接口定义">3.2 业务接口定义</h3>
<pre><code class="language-java">public interface FileService {

    Bucket createBucket(String bucketName) throws Exception;

    List&lt;Bucket&gt; listBuckets() throws Exception;

    void removeBucket(String bucketName) throws Exception;

    List&lt;S3ObjectSummary&gt; listObjects(String bucketName, boolean recursive) throws Exception;

    PutObjectResult putObject(String bucketName, String objectName, InputStream inputStream, String contentType) throws Exception;

    String getPreSignViewUrl(String bucketName, String filename, Date expireAt) throws Exception;

    S3Object getObject(String bucketName, String filename) throws Exception;

}
</code></pre>
<h3 id="33-业务实现类">3.3 业务实现类</h3>
<pre><code class="language-java">@Slf4j
@Service
public class FileServiceImpl implements FileService {

    @Resource
    private OssTemplate ossTemplate;

    @Override
    public Bucket createBucket(String bucketName) throws Exception {
        return ossTemplate.createBucket(bucketName);
    }

    @Override
    public List&lt;Bucket&gt; listBuckets() throws Exception {
        return ossTemplate.listBuckets();
    }

    @Override
    public void removeBucket(String bucketName) throws Exception {
        ossTemplate.removeBucket(bucketName);
    }

    @Override
    public List&lt;S3ObjectSummary&gt; listObjects(String bucketName, boolean recursive) throws Exception {
        return ossTemplate.listObjects(bucketName, recursive);
    }

    @Override
    public PutObjectResult putObject(String bucketName, String objectName, InputStream inputStream, String contentType) throws Exception {
        return ossTemplate.putObject(bucketName, objectName, inputStream, contentType);
    }

    @Override
    public String getPreSignViewUrl(String bucketName, String filename, Date expireAt) throws Exception {
        return ossTemplate.getPreSignViewUrl(bucketName, filename, expireAt);
    }

    @Override
    public S3Object getObject(String bucketName, String filename) throws Exception {
        return ossTemplate.getObject(bucketName, filename);
    }

}
</code></pre>
<h3 id="34-接口调用示例">3.4 接口调用示例</h3>
<pre><code class="language-shell"># 创建bucket
curl -X POST &#x27;http://localhost:10030/demo/oss/bucket/create?bucketName=test&#x27;

# 获取bucket列表
curl -X GET &#x27;http://localhost:10030/demo/oss/bucket/list&#x27;

# 删除bucket
curl -X DELETE &#x27;http://localhost:10030/demo/oss/bucket/delete?bucketName=test&#x27;

# 获取文件列表
curl -X GET &#x27;http://localhost:10030/demo/oss/list?bucketName=test&#x27;

# 上传文件
curl -X POST &#x27;http://localhost:10030/demo/oss/upload?bucketName=test&#x27;  -H &quot;Content-Type: multipart/form-data&quot; --form &#x27;file=@C:/Users/light/Desktop/temp.yaml&#x27;

# 获取文件预览url
curl -X POST &#x27;http://localhost:10030/demo/oss/preview?filename=temp&#x27;

# 下载文件
curl -X GET &#x27;http://localhost:10030/demo/oss/download?filename=temp.yaml&#x27; -o temp.yaml
</code></pre>
<h2 id="四分片下载">四、分片下载</h2>
<p>支持将文件分片下载，可由客户端指定每个分片的大小</p>
<h3 id="41-接口定义">4.1 接口定义</h3>
<pre><code class="language-java">/**
 * 断点下载 &lt;p&gt;
 * https://mp.weixin.qq.com/s/HMIMpbDvuMmPU-ax43BzuA &lt;p&gt;
 * https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html &lt;p&gt;
 * https://help.aliyun.com/document_detail/39571.html &lt;p&gt;
 */
@GetMapping(&quot;downloadChunk&quot;)
@Operation(summary = &quot;【下载文件(支持分片)】&quot;, description = &quot;Hui Liu&quot;)
@Parameters(value = {
        @Parameter(name = &quot;bucketName&quot;, description = &quot;bucket&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;objectName&quot;, description = &quot;文件名&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;range&quot;, description = &quot;下载的范围 bytes=0-, bytes=1024-2048, bytes=-4096&quot;, in = ParameterIn.QUERY),
})
public void downloadChunk(@RequestParam String bucketName, @RequestParam String objectName, @RequestParam(required = false) String range, HttpServletResponse response) throws Exception {
    ChunkDownload chunkDownload = fileService.downloadFile(bucketName, objectName, range);
    byte[] bytes = chunkDownload.getS3Object().getObjectContent().readAllBytes();
    download(response, bytes, chunkDownload.getStartByte(), chunkDownload.getEndByte());
}

public void download(HttpServletResponse response, byte[] bytes, Long startByte, Long endByte) throws IOException {
    // 设置HTTP响应头
    HttpHeaders headers = new HttpHeaders();
    headers.setContentLength(bytes.length);
    headers.set(HttpHeaders.CONTENT_RANGE, String.format(&quot;bytes %d-%d/%d&quot;, startByte, endByte, bytes.length));
    for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : headers.entrySet()) {
        response.setHeader(entry.getKey(), entry.getValue().getFirst());
    }
    // 设置响应状态码
    response.setStatus(HttpStatus.PARTIAL_CONTENT.value());
    // 设置响应字节
    ServletOutputStream outputStream = response.getOutputStream();
    outputStream.write(bytes);
    outputStream.flush();
}
</code></pre>
<h3 id="42-业务接口定义">4.2 业务接口定义</h3>
<pre><code class="language-java">/**
     * 下载文件 &lt;p&gt;
     * Tips： 支持断点下载
     *
     * @param bucketName 文件标识MD5
     * @param objectName 文件标识MD5
     * @param range      范围
     */
    ChunkDownload downloadFile(String bucketName, String objectName, String range) throws Exception;
</code></pre>
<h3 id="43-业务实现类">4.3 业务实现类</h3>
<pre><code class="language-java">@Override
public ChunkDownload downloadFile(String bucketName, String objectName, String range) throws Exception {
    ObjectMetadata objectMetadata = ossTemplate.getObjectMetadata(bucketName, objectName);
    Long totalSize = objectMetadata.getContentLength();
    // 处理字节信息
    ChunkDownload chunkDownload = executeRangeInfo(range, totalSize);

    // rangeInfo = null，直接下载整个文件
    S3Object s3Object = null;
    if (Objects.isNull(chunkDownload)) {
        chunkDownload = new ChunkDownload();
        s3Object = ossTemplate.getObject(bucketName, objectName);
    } else {
        // 下载部分文件
        s3Object = ossTemplate.getObjectWithRange(bucketName, objectName,
                chunkDownload.getStartByte(), chunkDownload.getEndByte());
    }

    chunkDownload.setTotalSize(totalSize);
    chunkDownload.setS3Object(s3Object);
    chunkDownload.setPartSize(s3Object.getObjectMetadata().getContentLength());
    return chunkDownload;
}

private ChunkDownload executeRangeInfo(String range, Long fileSize) {
    if (StringUtils.isEmpty(range) || !range.contains(&quot;bytes=&quot;) || !range.contains(&quot;-&quot;)) {
        return null;
    }

    long startByte = 0;
    long endByte = fileSize - 1;
    range = range.substring(range.lastIndexOf(&quot;=&quot;) + 1).trim();
    String[] ranges = range.split(&quot;-&quot;);
    if (ranges.length &lt;= 0 || ranges.length &gt; 2) {
        return null;
    }

    try {
        if (ranges.length == 1) {
            if (range.startsWith(&quot;-&quot;)) {
                // 1. 如：bytes=-1024  从开始字节到第1024个字节的数据
                endByte = Long.parseLong(ranges[0]);
            } else if (range.endsWith(&quot;-&quot;)) {
                // 2. 如：bytes=1024-  第1024个字节到最后字节的数据
                startByte = Long.parseLong(ranges[0]);
            }
        } else {
            // 3. 如：bytes=1024-2048  第1024个字节到2048个字节的数据
            startByte = Long.parseLong(ranges[0]);
            endByte = Long.parseLong(ranges[1]);
        }
    } catch (NumberFormatException e) {
        startByte = 0;
        endByte = fileSize - 1;
    }

    if (startByte &gt;= fileSize) {
        log.error(&quot;range error, startByte &gt;= fileSize. startByte: {}, fileSize: {}&quot;, startByte, fileSize);
        return null;
    }

    return BuilderTool.of(ChunkDownload.class)
            .with(ChunkDownload::setStartByte, startByte)
            .with(ChunkDownload::setEndByte, endByte)
            .build();
}
</code></pre>
<h3 id="44-接口调用示例">4.4 接口调用示例</h3>
<pre><code class="language-shell"># 下载分片1
curl -X GET &#x27;http://localhost:10030/demo/oss/downloadChunk?bucketName=light&amp;objectName=temp.yaml&amp;range=bytes=0-102400&#x27; -o temp.yaml.1

# 下载分片2
curl -X GET &#x27;http://localhost:10030/demo/oss/downloadChunk?bucketName=light&amp;objectName=temp.yaml&amp;range=bytes=102401-204800&#x27; -o temp.yaml.2

# 下载分片3
curl -X GET &#x27;http://localhost:10030/demo/oss/downloadChunk?bucketName=light&amp;objectName=temp.yaml&amp;range=bytes=204801-&#x27; -o temp.yaml.3
</code></pre>
<h2 id="五分片上传">五、分片上传</h2>
<p>对于超大文件的上传，可以在前端对文件惊醒切分，分片上传</p>
<ul>
<li>校验当前文件是否存在</li>
<li>初始化上传任务</li>
<li>获取预签名的上传URL，前端直传到S3</li>
<li>上传分片</li>
<li>获取所有分片</li>
<li>合并分片</li>
</ul>
<h3 id="51-接口定义">5.1 接口定义</h3>
<pre><code class="language-java">@GetMapping(&quot;chunkUpload/validate/{identifier}&quot;)
@Operation(summary = &quot;【断点续传：上传前的校验】&quot;, description = &quot;Hui Liu&quot;)
@Parameters(value = {
        @Parameter(name = &quot;identifier&quot;, description = &quot;待上传文件的MD5&quot;, in = ParameterIn.PATH)
})
public Result&lt;TaskInfo&gt; validate(@PathVariable(&quot;identifier&quot;) String identifier) throws Exception {
    TaskInfo result = fileService.getTaskInfo(identifier);
    return Result.success(result);
}

@PostMapping(&quot;chunkUpload/initTask&quot;)
@Operation(summary = &quot;【断点续传：初始化上传任务】&quot;, description = &quot;Hui Liu&quot;)
public Result&lt;TaskInfo&gt; initTask(@RequestBody InitTaskParam param) throws Exception {
    TaskInfo result = fileService.initTask(param);
    return Result.success(result);
}

@GetMapping(&quot;chunkUpload/{identifier}/{partNumber}&quot;)
@Operation(summary = &quot;【断点续传：获取分片的预签名上传地址】&quot;, description = &quot;Hui Liu&quot;)
@Parameters(value = {
        @Parameter(name = &quot;identifier&quot;, description = &quot;待上传文件的MD5&quot;, in = ParameterIn.PATH),
        @Parameter(name = &quot;partNumber&quot;, description = &quot;分片号&quot;, in = ParameterIn.PATH)
})
public Result&lt;String&gt; preSignUploadUrl(@PathVariable(&quot;identifier&quot;) String identifier,
                                        @PathVariable(&quot;partNumber&quot;) Integer partNumber) throws Exception {
    TaskInfo taskInfo = fileService.getTaskInfo(identifier);
    if (Objects.isNull(taskInfo)) {
        Result.failure(400, &quot;分片任务不存在&quot;);
    }
    Map&lt;String, String&gt; params = new HashMap&lt;&gt;(16);
    params.put(&quot;partNumber&quot;, partNumber.toString());
    params.put(&quot;uploadId&quot;, taskInfo.getUploadId());
    String result = fileService.getPreSignUploadUrl(taskInfo.getBucketName(), taskInfo.getObjectName(),
            DateTool.fromNow(Duration.ofHours(1L)), params);
    return Result.success(result);
}

@PostMapping(&quot;chunkUpload/uploadPart&quot;)
@Operation(summary = &quot;【断点续传：上传分片】&quot;, description = &quot;Hui Liu&quot;)
@Parameters(value = {
        @Parameter(name = &quot;bucketName&quot;, description = &quot;bucket&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;objectName&quot;, description = &quot;文件名&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;uploadId&quot;, description = &quot;上传id&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;partNumber&quot;, description = &quot;分片号&quot;, in = ParameterIn.QUERY),
})
public Result&lt;UploadPartResult&gt; uploadPart(@RequestParam String bucketName, @RequestParam String objectName,
                                            @RequestParam String uploadId, @RequestParam Integer partNumber,
                                            MultipartFile file) throws Exception {
    UploadPartResult result = fileService.uploadPart(bucketName, objectName, uploadId, file.getInputStream(), partNumber);
    return Result.success(result);
}

@GetMapping(&quot;chunkUpload/listParts&quot;)
@Operation(summary = &quot;【断点续传：分片列表】&quot;, description = &quot;Hui Liu&quot;)
@Parameters(value = {
        @Parameter(name = &quot;bucketName&quot;, description = &quot;bucket&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;objectName&quot;, description = &quot;文件名&quot;, in = ParameterIn.QUERY),
        @Parameter(name = &quot;uploadId&quot;, description = &quot;上传id&quot;, in = ParameterIn.QUERY),
})
public Result&lt;List&lt;PartSummary&gt;&gt; listParts(@RequestParam String bucketName, @RequestParam String objectName,
                                            @RequestParam String uploadId) throws Exception {
    List&lt;PartSummary&gt; results = fileService.listParts(bucketName, objectName, uploadId);
    return Result.success(results);
}

/**
 * 断点续传：合并分片
 */
@GetMapping(&quot;chunkUpload/merge/{identifier}&quot;)
@Operation(summary = &quot;【断点续传：合并分片】&quot;, description = &quot;Hui Liu&quot;)
@Parameters(value = {
        @Parameter(name = &quot;identifier&quot;, description = &quot;待上传文件的MD5&quot;, in = ParameterIn.PATH)
})
public Result&lt;CompleteMultipartUploadResult&gt; mergeParts(@PathVariable(&quot;identifier&quot;) String identifier) throws Exception {
    TaskInfo taskInfo = fileService.getTaskInfo(identifier);
    if (Objects.isNull(taskInfo)) {
        Result.failure(400, &quot;分片任务不存在&quot;);
    }
    if (YesNoEnum.NO.eqValue(taskInfo.getFinish())) {
        CompleteMultipartUploadResult result = fileService.completeMultiUpload(taskInfo.getBucketName(), taskInfo.getObjectName(),
                taskInfo.getUploadId(), taskInfo.getChunkNum());

        return Result.success(result);
    }
    return Result.success(null);
}
</code></pre>
<h3 id="52-业务接口定义">5.2 业务接口定义</h3>
<pre><code class="language-java">/**
 * 根据文件的唯一标识获取文件信息
 */
TaskInfo getTaskInfo(String identifier) throws Exception;

/**
 * 初始化一个任务
 */
TaskInfo initTask(InitTaskParam param) throws Exception;

String getPreSignUploadUrl(String bucketName, String objectName, Date expireAt, Map&lt;String, String&gt; params) throws Exception;

UploadPartResult uploadPart(String bucketName, String objectName, String uploadId, InputStream inputStream, Integer partNumber) throws Exception;

List&lt;PartSummary&gt; listParts(String bucketName, String objectName, String uploadId) throws Exception;

CompleteMultipartUploadResult completeMultiUpload(String bucketName, String objectName, String uploadId, Integer chunkNum) throws Exception;
</code></pre>
<h3 id="53-业务实现类">5.3 业务实现类</h3>
<pre><code class="language-java">@Override
public TaskInfo getTaskInfo(String identifier) throws Exception {
    // 从DB查询分片信息
    SliceUpload sliceUpload = sliceUploadService.queryByIdentifier(identifier);

    // 没有分片信息，表示还未初始化分片上传任务
    if (Objects.isNull(sliceUpload)) {
        return null;
    }

    // 文件是否存在，存在表示上传完成，不存在表示未完成
    Boolean exists = ossTemplate.doesObjectExist(sliceUpload.getBucketName(), sliceUpload.getObjectName());
    if (exists) {
        return BuilderTool.of(TaskInfo.class)
                .with(TaskInfo::setFilename, sliceUpload.getFilename())
                .with(TaskInfo::setFileIdentifier, sliceUpload.getFileIdentifier())
                .with(TaskInfo::setBucketName, sliceUpload.getBucketName())
                .with(TaskInfo::setObjectName, sliceUpload.getObjectName())
                .with(TaskInfo::setUploadId, sliceUpload.getUploadId())
                .with(TaskInfo::setTotalSize, sliceUpload.getTotalSize())
                .with(TaskInfo::setChunkSize, sliceUpload.getChunkSize())
                .with(TaskInfo::setChunkNum, sliceUpload.getChunkNum())
                .with(TaskInfo::setFinish, YesNoEnum.YES.getValue())
                .build();
    }
    // 查询已完成的分片
    List&lt;PartSummary&gt; parts = ossTemplate.listParts(sliceUpload.getBucketName(),
            sliceUpload.getObjectName(), sliceUpload.getUploadId());
    return BuilderTool.of(TaskInfo.class)
            .with(TaskInfo::setFilename, sliceUpload.getFilename())
            .with(TaskInfo::setFileIdentifier, sliceUpload.getFileIdentifier())
            .with(TaskInfo::setBucketName, sliceUpload.getBucketName())
            .with(TaskInfo::setObjectName, sliceUpload.getObjectName())
            .with(TaskInfo::setUploadId, sliceUpload.getUploadId())
            .with(TaskInfo::setTotalSize, sliceUpload.getTotalSize())
            .with(TaskInfo::setChunkSize, sliceUpload.getChunkSize())
            .with(TaskInfo::setChunkNum, sliceUpload.getChunkNum())
            .with(TaskInfo::setExistsParts, parts)
            .with(TaskInfo::setFinish, YesNoEnum.NO.getValue())
            .build();
}

@Override
public TaskInfo initTask(InitTaskParam param) throws Exception {
    String filename = param.getFilename();
    String bucketName = ossProperties.getDefaultBucket();
    String suffix = filename.substring(filename.lastIndexOf(&quot;.&quot;) + 1);
    String objectName = StrUtil.format(&quot;{}.{}&quot;, IdUtil.randomUUID(), suffix);

    // 从S3获取上传id
    InitiateMultipartUploadResult initiateMultipartUploadResult = ossTemplate.initMultiUpload(bucketName, objectName);
    String uploadId = initiateMultipartUploadResult.getUploadId();

    // 持久化到数据库
    int chunkNum = (int) Math.ceil(param.getTotalSize() * 1.0 / param.getChunkSize());
    SliceUpload sliceUpload = BuilderTool.of(SliceUpload.class)
            .with(SliceUpload::setFilename, param.getFilename())
            .with(SliceUpload::setFileIdentifier, param.getFileIdentifier())
            .with(SliceUpload::setBucketName, bucketName)
            .with(SliceUpload::setObjectName, objectName)
            .with(SliceUpload::setUploadId, uploadId)
            .with(SliceUpload::setTotalSize, param.getTotalSize())
            .with(SliceUpload::setChunkSize, param.getChunkSize())
            .with(SliceUpload::setChunkNum, chunkNum)
            .build();
    sliceUploadService.save(sliceUpload);

    // 返回结果
    return BuilderTool.of(TaskInfo.class)
            .with(TaskInfo::setUploadId, sliceUpload.getUploadId())
            .with(TaskInfo::setBucketName, sliceUpload.getBucketName())
            .with(TaskInfo::setObjectName, sliceUpload.getObjectName())
            .with(TaskInfo::setFinish, YesNoEnum.NO.getValue())
            .build();
}

@Override
public String getPreSignUploadUrl(String bucketName, String objectName, Date expireAt, Map&lt;String, String&gt; params) throws Exception {
    return ossTemplate.getPreSignUploadUrl(bucketName, objectName, expireAt, params);
}

@Override
public UploadPartResult uploadPart(String bucketName, String objectName, String uploadId, InputStream inputStream, Integer partNumber) throws Exception {
    SliceUpload sliceUpload = sliceUploadService.querySliceUpload(bucketName, objectName, uploadId);
    if (Objects.isNull(sliceUpload)) {
        throw BizException.throwException(&quot;未找到上传信息! bucketName: %s, bucketName: %s, bucketName: %s&quot;,
                bucketName, objectName, uploadId);
    }
    return ossTemplate.uploadPart(bucketName, objectName, uploadId, inputStream, partNumber);
}

@Override
public List&lt;PartSummary&gt; listParts(String bucketName, String objectName, String uploadId) throws Exception {
    return ossTemplate.listParts(bucketName, objectName, uploadId);
}

@Override
public CompleteMultipartUploadResult completeMultiUpload(String bucketName, String objectName, String uploadId, Integer chunkNum) throws Exception {
    return ossTemplate.completeMultiUpload(bucketName, objectName, uploadId, chunkNum);
}
</code></pre>
<h3 id="54-接口调用示例">5.4 接口调用示例</h3>
<p><strong>注意：</strong> MinIO S3 等对文件分片大小有要求(&gt; 5MB)，太小的文件不支持合并</p>
<pre><code class="language-shell"># 上传前的校验
curl -X GET &#x27;http://localhost:10030/demo/oss/chunkUpload/validate/file-md5&#x27;

# 初始化上传任务
curl -X POST &#x27;http://localhost:10030/demo/oss/chunkUpload/initTask&#x27; \
--header &#x27;MockSeed: 1&#x27; \
--header &#x27;Content-Type: application/json&#x27; \
--data-raw &#x27;{
    &quot;fileIdentifier&quot;: &quot;file-md5&quot;,
    &quot;filename&quot;: &quot;temp.yaml&quot;,
    &quot;totalSize&quot;: 265135,
    &quot;chunkSize&quot;: 102400,
    &quot;chunkNum&quot;: 3
}&#x27;

# 上传分片
curl -X POST &#x27;http://localhost:10030/demo/oss/chunkUpload/uploadPart&#x27; \
--header &#x27;MockSeed: 1&#x27; \
--form &#x27;bucketName=&quot;light&quot;&#x27; \
--form &#x27;objectName=&quot;b16f23a1-fcd5-4bc1-a4b6-2d9034f58f87.yaml&quot;&#x27; \
--form &#x27;uploadId=&quot;YjIxYmUxZDgtMGFiYS00NGU3LWJlNTUtM2JiZTU2MWI2ZmJmLjc1YmVmODBiLWY4MDgtNDZiMi05ODQ3LWE1OTU1NjNlYWE0Mg&quot;&#x27; \
--form &#x27;partNumber=&quot;1&quot;&#x27; \
--form &#x27;file=@C:/Users/light/Desktop/temp.yaml.1&#x27;

curl -X POST &#x27;http://localhost:10030/demo/oss/chunkUpload/uploadPart&#x27; \
--header &#x27;MockSeed: 1&#x27; \
--form &#x27;bucketName=&quot;light&quot;&#x27; \
--form &#x27;objectName=&quot;b16f23a1-fcd5-4bc1-a4b6-2d9034f58f87.yaml&quot;&#x27; \
--form &#x27;uploadId=&quot;YjIxYmUxZDgtMGFiYS00NGU3LWJlNTUtM2JiZTU2MWI2ZmJmLjc1YmVmODBiLWY4MDgtNDZiMi05ODQ3LWE1OTU1NjNlYWE0Mg&quot;&#x27; \
--form &#x27;partNumber=&quot;2&quot;&#x27; \
--form &#x27;file=@C:/Users/light/Desktop/temp.yaml.2&#x27;

curl -X POST &#x27;http://localhost:10030/demo/oss/chunkUpload/uploadPart&#x27; \
--header &#x27;MockSeed: 1&#x27; \
--form &#x27;bucketName=&quot;light&quot;&#x27; \
--form &#x27;objectName=&quot;b16f23a1-fcd5-4bc1-a4b6-2d9034f58f87.yaml&quot;&#x27; \
--form &#x27;uploadId=&quot;YjIxYmUxZDgtMGFiYS00NGU3LWJlNTUtM2JiZTU2MWI2ZmJmLjc1YmVmODBiLWY4MDgtNDZiMi05ODQ3LWE1OTU1NjNlYWE0Mg&quot;&#x27; \
--form &#x27;partNumber=&quot;3&quot;&#x27; \
--form &#x27;file=@C:/Users/light/Desktop/temp.yaml.3&#x27;

# 分片列表
curl -X GET &#x27;http://localhost:10030/demo/oss/chunkUpload/listParts?bucketName=light&amp;objectName=b16f23a1-fcd5-4bc1-a4b6-2d9034f58f87.yaml&amp;uploadId=YjIxYmUxZDgtMGFiYS00NGU3LWJlNTUtM2JiZTU2MWI2ZmJmLjc1YmVmODBiLWY4MDgtNDZiMi05ODQ3LWE1OTU1NjNlYWE0Mg&#x27;

# 获取预签名上传地址
curl -X GET &#x27;http://localhost:10030/demo/oss/chunkUpload/file-md5/1&#x27; --header &#x27;MockSeed: 1&#x27;

# 合并分片
curl -X GET &#x27;http://localhost:10030/demo/oss/chunkUpload/merge/file-md5&#x27;
</code></pre></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/light-docusaurus/blog/tags/upload/">upload</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/light-docusaurus/blog/tags/minio/">minio</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/light-docusaurus/blog/tags/s-3/">s3</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/light-docusaurus/blog/tags/oss/">oss</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/light-docusaurus/blog/tags/local-file-system/">localFileSystem</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>