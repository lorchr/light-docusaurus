[J4125四口i226软路由allinone历程及全过程教程（附截图及注意事项）](https://www.right.com.cn/forum/thread-8277970-1-8.html)

## 前言
[J4125](https://www.intel.cn/content/www/cn/zh/products/sku/197305/intel-celeron-processor-j4125-4m-cache-up-to-2-70-ghz/specifications.html)是Intel 19Q4年推出的的低功耗平台CPU，采用14nm制程4C4T设计，TDP功耗为10W，整体发热及性能平衡表现良好，仅依靠被动散热放进弱电箱也不会过热死机（[N5105](https://www.intel.cn/content/www/cn/zh/products/sku/212328/intel-celeron-processor-n5105-4m-cache-up-to-2-90-ghz/specifications.html)则需要依靠散热风扇），以下为[恩山无线论坛](https://www.right.com.cn)网友分享的J4125使用记录

## 开始
### 2023-2-26 发贴
计划是继续用`PVE 7.2-3`，虚拟机装`ROS（7.7）`+ `OpenWrt（iStoreOS）`+ `NAS（arpl硬盘二合一自动编译引导，装3622xs+，因为不需要存电影及视频硬解转码）`。

首次发贴，记录一下，同时请教一些疑问。
这方面我的确是很不懂，主要是过年时花了些时间看网上的保姆式教程和帖子，内容很多，但仍觉得逻辑被隐性化或复杂化了（从浅知到应用过程来说）。
不过的确很感谢这些教程，否则我完全是摸不着头脑的…后续也打算分享整个处理、应用、使用及相关资源内容给像我这样的入门小白，便于相对快速地上手使用。

开始是用单网口的老笔记本折腾PVE，`i3-3110m`的CPU，240G SSD + 500G HDD，内存加了条4G后8G完全够用，虚拟机装了`OpenWrt`和`NAS`，3代cpu没有`vt-d`无法做任何直通……温度常年在55-65度。
后来看到有关于`ROS`自动分流国内外ip，不用指定设备的网关至`OpenWrt`来进行魔法，就打算弄软路由`all in one`了...
有低功耗cpu笔记本、有些时间的，建议先这样玩玩，如果和我需求类似的，建议直接买多网口设备弄（需要有显示器或电视等显示设备）。

#### 言归正传，
如图，今天刚到的货，在pdd倍控家买的G48那款`J4125（4口i226网卡）`，金cc的256G的msata盘，三星8G的DDR4 3200（msata盘和内存还没到货）；


#### （以下疑问已相对清楚）
对于这种工控机软路由，散热的综合考虑要怎么做？想要请教一下大家，主要有这些疑问：
1. 老电脑500G的2.5寸的机械硬盘，装在底盖内部（不用改装即可装上），对散热影响大不？还是说装外部？；
2. 原来老电脑加装的DDR3内存，不能用在这上面，144新买了条8G的DDR4 3200三星的内存（还没到货），应该也能向下兼容DDR4 2400吧？
3. 毕竟2.5G网口，不知道散热会很高不，看了些网友散热的做法，不知道怎样做简单好用？
   1. 顶盖外加12x12的usb风扇，对着里面吹（就是对着CPU往里吹）；
   2. 只是换CPU的散热硅脂（利民的）；
   3. CPU换硅脂+CPU接主板的背面贴散热硅胶片；
   4. 去外面改底盖、切割出风口，买风扇装在底盖内部外吹（不过我不知道风扇电源线接哪个口）；

买回来后觉得是不是应该买G30那款（两边有散热孔），G48这款只有底部四边有开孔.....会成闷罐子吗？

#### 后得知：
风扇4pin电源口得拆下主板，才看得到；
另问店家是否要换cpu硅脂，店客服表示说不需要，用得比较好的5.8W的（不知是不是需要换11w的呢？）

## 更新
### 2023-2-27 晚上更新
1. 先装好虚拟机运行下，看看温度再决定是否要换cpu硅脂和加风扇（风扇4pin插口在主板背部）；
2. 目前了解到`PVE 7.2、7.3`没法直通`i226`网卡，`PVE 7.1`和 `ESXI 7.0.3`可以，有了解的帮忙告诉一下，感谢了（不过才8G内存，担心装ESXI不够用）；
3. 虽然NAS不用来看电影实时转码，但直通核显还是有利于上传的heic图片和视频的缩略图处理的吧？直通核显后，如果后续装Windows或桌面版Linux，是不是就显示不了啊？

## QA
### 基础Q&A：
0. 为什么选软路由来组一体机，而不是弄个NAS机箱 + 多网口主板
    1. 一开始觉得弄机箱麻烦，后来发现，的确更爽，但软路由买都买了，主要用于路由就好，后续需求明确了再弄也好；而且路由和NAS、服务器等分开还是稳定可靠些的；
    2. 用硬路由的时候网络出问题了处理、reset，容易也方便；但软路由承担主路由，一旦出情况，没处理好的话登录、处理都成问题。。。所以稳定很关键；
    3. 在没明确需求前，功耗还是需要考虑的，j4125这种TDP 10w的软路由，压力很小；
    4. 我目前主要是用于上网，NAS需求仅是方便本地传一些图片视频、然后自动备份至网盘，仅此而且（看电影什么的不需要它，AppleTV + Infuse + Alist + Emby这些够了，除非稀有或很经典必存的），所以对NAS有观影等需求的，还是考虑单独弄个吧

1. 为什么装PVE而不是ESXI？
    1. 我都有实操，也纠结过，但一开始只弄了8G内存，就装PVE了，装了也不想再重新折腾；
    2. intel i226，好像只有ESXI 8.0版本才带驱动，其它版本要自己打包社区的网卡驱动或下别人弄好的，但我都是选择官网的安装包，必要的插件、方便安装NAS的，我都是用github上的；PVE 7.1就能正常使用i226（虽然虚拟机选择直能网卡那里不显示i226的网卡描述）；dsm的自动引导arpl的安装也是基于PVE的。。。
    3. 如果没有1和2的问题和顾虑，以及没有硬件兼容问题的（ESXI 7开始兼容性开始收缩，PVE 大概是7开始越来越稳定、配置简单，兼容性也保持得很好），使用ESXI还是稳+方便的（不过我用一老服务器安装iStoreOS不成功）

2. 为什么要弄这个软路由？
    1. 一开始是想给买的AppleTV能实现它的愿望，"世界那么大，它想去看看"；就用老笔记本PVE装了个OpenWrt做旁路由（用ssr plus+），后来发现用AppleTV其实正常上网就足够用了（买了Infuse pro，加了个Emby公益服，这个内容要讲清楚细节还得开一篇，就不在此展开了）；
    2. 后来了解到可以用ROS基于ip进行直接分流（只把需要出去的ip才经过旁路由），方便随时用ChatGPT之类的，还用老笔记本就不行了（原来家里主路由是红米AX6）

3. 为什么用ROS做主路由？为什么不物理机装ROS？体验怎么样？
    1. 稳定、可以实现我想要的分流方案、`ROS7.8`完美支持i226网卡；不需要实现ip直接分流+OpenWrt旁路由挂了也不影响家里正常上网的话，用爱快方便快捷上手易（当然有更好的方法，例如直接Linux当主路由，大佬们有更好办法的帮忙留言讲解下，感谢了）
    2. 物理机ROS很好，不用的原因：一是直接买2.5G或万兆的ROS硬路由要上k，软路由物理机直装略麻烦还浪费了j4125性能；二是把ROS和OP装一起，用虚拟交换机可以省个物理交换机（虽然我目前是用AX6当AP和交换机）；三是在极致稳定与省钱找了个平衡；（注：虚拟机安装ros，邮箱注册后，就可以邮箱+密码登录试用60天了，看好些人说虚拟机的过期了也可以继续使用，只是不能升级罢了，后续我再补充）
    3. 体验，使用半个多月了，500m宽带iPhone11 Wifi测速前中段可以跑6-700M的样子，后段掉到350M的样子，不知道是不是Wifi的原因还是测速软件的原因，总之满足我使用了；魔法速度稳定也快了很多，日常上网无感、丝滑
    4. 波折：一开始发现网速只有一半，排查后才发现是光猫的问题，联系联通（挺负责的），一开始联通工程师发现我这网络光衰严重，师傅先上门检查没发现线路问题，然后发现是光猫的光纤接口给污染了，但观察3天后还是这样，再次上门测试、检查后决定给我换个维护光猫（免费，旧的拿走），问题解决（之前用AX6时也是下降了不少的，才能排查出问题不是在我的软路由上）

4. ROS配置要学习、纯手动很麻烦吧？
    1. 我跟着b站一个up主的方法配置的ROS，步骤清楚、详细，跟着来也就1小时内的事情（先按他前一期视频完成了基础配置，再按这个设置就行了） `https://www.bilibili.com/video/BV1i44y1U7hW`
         
    **注意：**
    1. 要会在PVE或ESXI安装ROS和iStoreOS；网口直不直通CPU占用差别只有3%的样子（PVE上ROS7.8用vitio虚拟网卡做的对比）;
    2. PVE和ESXI直通都简单，自行搜索就行；PVE也可以通过shell安装个github的PVETools来一键处理各种基础设置（换源、直通、cpu温度显示等）`https://github.com/ivanhao/pvetools`
    3. 如果直通网口，设置直通后，虚拟机添加pci设备前，要先搞清楚pci设备id（添加时可以看到）对应的是哪个物理网口哦，倍控G48这款，靠近电源插口的是第0个口；添加pci设备时，只勾选了“所有功能”，这样后续ros上一些功能受影响的可能小


5. 为什么用iStoreOS或其它OpenWrt当旁路由？怎么配置？
    1. iStoreOS安装配置很方便，目前当旁路由也很稳定，当主路由应该也是可以的，不过我没实操过，有弄过的欢迎留言讲解下（当时我用ROS当主路由，其中一个重要原因就是稳定性）；
    2. 我一开始是论坛里下的一个，用的是ssr plus+；后来发现iStoreOS，就果断装它了，装了Alist（这个商店安装，配置按官方文档就行 `https://alist.nn.ci/zh/guide/drivers/aliyundrive.html` ，还有Hallo World
    
    **注意：**
    1. Hallo World也是基于ssr的，不过界面友好很多、分流设置也更强；`ssr plus+`(别名酸酸乳）、`passwall`、`Hallo world`、`openclash`这些我大概了解了下，发现hallo world对我来说就足够且稳定了（有更强大但性能要求也不是很高的，大佬们帮忙讲解下，谢谢了）；
    2. 不过iStoreOS上安装无法通过商店，要去软件包 - 筛选器那搜索vssr安装的（需要配置源）；我是去下了个ipk安装文件上传安装的（附件太大就没上传了，可以自行搜索`luci-app-vssr`）；也可以自己找到相关的源配置（见截图设置），配置好后点更新，再搜索vssr

    ```shell
    # 源：
    # customfeeds：

    src/gz openwrt_kiddin9 https://op.supes.top/packages/x86_64

    # distfeeds的源用的openwrt官方源
    ```

6. 简单直通核显和把核显“多通"（vGPU）给多个虚拟机有什么区别？PVE上怎么直通核显？DSM 7.1直通核显怎么弄？
    1. 我的软路由不需要用于接显示器（例如windows系统接电视显示用），而且我尝试了也实现不了（应该是在bios里显存分配不足导致？），所以没有用论坛里说的方法实现GVT-g这类功能，就通过PVETools处理的；
           需要详细了解的请看这两个教程：`https://post.smzdm.com/p/all5nm7e/`  `https://www.right.com.cn/forum/thread-5616283-1-1.html`
    2. 我不打算在这软路由上安装windows（远程桌面登录也需要核显的吧？这个有人懂的话帮忙说明下，谢谢了）
    3. PVE装dsm请参考这个详细教程（我PVE7.1-7安装没有问题） `https://www.cnblogs.com/mokou/p/17042705.html` ；因为是10代CPU，所以在arpl配置引导时，去ADDON中添加了i915（DSM的10代CPU的核显驱动）；

（下面的内容是之前摸索时发的，当时我已经实操过在老笔记本上安装PVE 7.2，在老服务器机器上安装ESXI 6.7）

## 验证
### 上次的疑问验证
1. 降温买个12cm风扇（5v）放在顶部（带鳍片的顶部）就行，对着机子吹风扇的鼓风声小些，旁边还放了光猫的话顺便降不少温
   1. PDD 9RMB买了个USB风扇（插在排插的USB口上），温度从55左右降到37的样子，然后加了个利民的TF8硅脂，降到34的样子。
   2. 没用4pin口的PWM风扇是担心影响电流和转不起来（4pin的12cm一般要12v起转，而4pin好像只有5v，虽然可以手动启动）
   3. USB插在机器USB口也是可以的（毕竟机器电源是12V4A的）
2. 还是装的7.1的PVE
   1. 买三星内存记得不要1Rx16的（只有正面有4颗颗粒），单条插哪个DDR4口都点不亮（我一开始pdd三星官店买的三星8G的是1Rx8的（正反面各4颗颗粒），正常使用）
   2. `ROS7.8 1G` + `iStoreOS 1G` + `DSM 7.1.1 4G`，8G内在是够用的了，8G 3200完全正常使用，cpu日常占用不超过10%；加到16G是还想弄个linux服务器
3. 我还是直通了核显，确认是可用于DSM的人脸识别
   1. 怎么开启人脸识别自行搜索吧

## 完结
小结一下最近实操遇的小坑和如何处理过程，以帮助到和我一样的小白用户，可以先看完 基础Q&A 再决定怎么弄吧～
整个过程中找了很多教程和资源，也试验过不少，其实挺简单的，就是我瞎搞太多了。
目前已经正常稳定使用半个多月，能换到可用的内存后再考虑加虚拟机弄别的，到时再更新
