<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-middleware docs-version-current docs-doc-page docs-doc-id-redis/Make-Redis-Message-Queue" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Make-Redis-Message-Queue | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/middleware/redis/Make-Redis-Message-Queue/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" property="og:title" content="Make-Redis-Message-Queue | Light Docusaurus"><meta data-rh="true" name="description" content="- 把Redis当作队列来用，真的合适吗？"><meta data-rh="true" property="og:description" content="- 把Redis当作队列来用，真的合适吗？"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/middleware/redis/Make-Redis-Message-Queue/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/middleware/redis/Make-Redis-Message-Queue/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/middleware/redis/Make-Redis-Message-Queue/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Light Docusaurus Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e8086d6f.css">
<script src="/assets/js/runtime~main.6257abc0.js" defer="defer"></script>
<script src="/assets/js/main.34b50ab8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/electron/">Electron</a><a class="navbar__item navbar__link" href="/postman/">Postman</a><a class="navbar__item navbar__link" href="/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/middleware/redis/Make-Redis-Message-Queue/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/middleware/">MiddleWare</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/compare/">Compare</a><button aria-label="展开侧边栏分类 &#x27;Compare&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/mysql/">Mysql</a><button aria-label="展开侧边栏分类 &#x27;Mysql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/postgresql/">Postgresql</a><button aria-label="展开侧边栏分类 &#x27;Postgresql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/middleware/category/redis/">Redis</a><button aria-label="折叠侧边栏分类 &#x27;Redis&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Build-Redis-Cluster-With-Docker-Compose/">Build-Redis-Cluster-With-Docker-Compose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Spring-Boot-RateLimit/">Spring-Boot-RateLimit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Spring-Boot-Redis-BitMap/">Spring-Boot-Redis-BitMap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Bigkey-Analysis/">Redis-Bigkey-Analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Memory-Usage/">Redis-Memory-Usage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Data-Persistence/">Redis-Data-Persistence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Feed-Stream-System/">Feed-Stream-System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Use-Situation/">Redis-Use-Situation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Risk-Control/">Risk-Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Lua-In-Redis/">Lua-In-Redis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Lettuce-RedisCommandTimeoutException/">Lettuce-RedisCommandTimeoutException</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Lettuce-pipeline-1/">Lettuce-pipeline-1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Lettuce-pipeline-2/">Lettuce-pipeline-2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Login-Max-Times-Limit/">Login-Max-Times-Limit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Best-Practice/">Redis-Best-Practice</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redisson-Lock/">Redisson-Lock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Data-Type/">Redis-Data-Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/Redis-Memory-Fragment-Clear/">Redis-Memory-Fragment-Clear</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/middleware/redis/Make-Redis-Message-Queue/">Make-Redis-Message-Queue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/redis/RedisConfigBean/">RedisConfigBean</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/nginx/">Nginx</a><button aria-label="展开侧边栏分类 &#x27;Nginx&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/netty/">Netty</a><button aria-label="展开侧边栏分类 &#x27;Netty&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/mqtt/">MQTT</a><button aria-label="展开侧边栏分类 &#x27;MQTT&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/influxdb/">InfluxDB</a><button aria-label="展开侧边栏分类 &#x27;InfluxDB&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/kafka/">Kafka</a><button aria-label="展开侧边栏分类 &#x27;Kafka&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/rabbitmq/">RabbitMQ</a><button aria-label="展开侧边栏分类 &#x27;RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/rocketmq/">RocketMQ</a><button aria-label="展开侧边栏分类 &#x27;RocketMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/workflow/">Workflow</a><button aria-label="展开侧边栏分类 &#x27;Workflow&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/plusar/">Plusar</a><button aria-label="展开侧边栏分类 &#x27;Plusar&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/shardingsphere/">ShardingSphere</a><button aria-label="展开侧边栏分类 &#x27;ShardingSphere&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/middleware/category/redis/"><span itemprop="name">Redis</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Make-Redis-Message-Queue</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Make-Redis-Message-Queue</h1></header><ul>
<li><a href="https://mp.weixin.qq.com/s/n-VnDzVAm5TlFSciH-zwVg" target="_blank" rel="noopener noreferrer">把Redis当作  队列来用，真的合适吗？</a></li>
</ul>
<p>我经常听到很多人讨论，关于「把 <code>Redis</code> 当作队列来用是否合适」的问题。</p>
<p>有些人表示赞成，他们认为 <code>Redis</code> 很轻量，用作队列很方便。</p>
<p>也些人则反对，认为 <code>Redis</code> 会「丢」数据，最好还是用「专业」的队列中间件更稳妥。</p>
<p>究竟哪种方案更好呢？</p>
<p>这篇文章，我就和你聊一聊把 <code>Redis</code> 当作队列，究竟是否合适这个问题。</p>
<p>我会从简单到复杂，一步步带你梳理其中的细节，把这个问题真正的讲清楚。</p>
<p>看完这篇文章后，我希望你对这个问题你会有全新的认识。</p>
<p>在文章的最后，我还会告诉你关于「技术选型」的思路，文章有点长，希望你可以耐心读完。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-1-8002711619208928ada11a74af814a20.png" width="826" height="346" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="从最简单的开始list-队列">从最简单的开始：List 队列<a href="#从最简单的开始list-队列" class="hash-link" aria-label="从最简单的开始：List 队列的直接链接" title="从最简单的开始：List 队列的直接链接">​</a></h2>
<p>首先，我们先从最简单的场景开始讲起。</p>
<p>如果你的业务需求足够简单，想把 <code>Redis</code> 当作队列来使用，肯定最先想到的就是使用 <code>List</code> 这个数据类型。</p>
<p>因为 <code>List</code> 底层的实现就是一个「链表」，在头部和尾部操作元素，时间复杂度都是 <code>O(1)</code>，这意味着它非常符合消息队列的模型。</p>
<p>如果把 <code>List</code> 当作队列，你可以这么来用。</p>
<p>生产者使用 <code>LPUSH</code> 发布消息：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; LPUSH queue msg1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; LPUSH queue msg2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>消费者这一侧，使用 <code>RPOP</code> 拉取消息：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; RPOP queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;msg1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; RPOP queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;msg2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个模型非常简单，也很容易理解。</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/jpeg;base64,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" width="681" height="201" class="img_ev3q"></p>
<p>但这里有个小问题，当队列中已经没有消息了，消费者在执行 <code>RPOP</code> 时，会返回 <code>NULL</code>。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; RPOP queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(nil)   // 没消息了</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而我们在编写消费者逻辑时，一般是一个「死循环」，这个逻辑需要不断地从队列中拉取消息进行处理，伪代码一般会这么写：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rpop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 没有消息，继续循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果此时队列为空，那消费者依旧会频繁拉取消息，这会造成「CPU 空转」，不仅浪费 CPU 资源，还会对 <code>Redis</code> 造成压力。</p>
<p>怎么解决这个问题呢？</p>
<p>也很简单，当队列为空时，我们可以「休眠」一会，再去尝试拉取消息。代码可以修改成这样：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rpop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 没有消息，休眠2s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理消息        </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这就解决了 CPU 空转问题。</p>
<p>这个问题虽然解决了，但又带来另外一个问题：当消费者在休眠等待时，有新消息来了，那消费者处理新消息就会存在「延迟」。</p>
<p>假设设置的休眠时间是 2s，那新消息最多存在 2s 的延迟。</p>
<p>要想缩短这个延迟，只能减小休眠的时间。但休眠时间越小，又有可能引发 CPU 空转问题。</p>
<p>鱼和熊掌不可兼得。</p>
<p>那如何做，既能及时处理新消息，还能避免 CPU 空转呢？</p>
<p><code>Redis</code> 是否存在这样一种机制：如果队列为空，消费者在拉取消息时就「阻塞等待」，一旦有新消息过来，就通知我的消费者立即处理新消息呢？</p>
<p>幸运的是，<code>Redis</code> 确实提供了「阻塞式」拉取消息的命令：<code>BRPOP / BLPOP</code>，这里的 <code>B</code> 指的是阻塞（<code>Block</code>）。</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/jpeg;base64,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" width="681" height="161" class="img_ev3q"></p>
<p>现在，你可以这样来拉取消息了：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 没消息阻塞等待，0表示不设置超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">brpop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> msg </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 <code>BRPOP</code> 这种阻塞式方式拉取消息时，还支持传入一个「超时时间」，如果设置为 0，则表示不设置超时，直到有新消息才返回，否则会在指定的超时时间后返回 <code>NULL</code>。</p>
<p>这个方案不错，既兼顾了效率，还避免了 CPU 空转问题，一举两得。</p>
<blockquote>
<p>注意：如果设置的超时时间太长，这个连接太久没有活跃过，可能会被 <code>Redis Server</code> 判定为无效连接，之后 <code>Redis Server</code> 会强制把这个客户端踢下线。所以，采用这种方案，客户端要有重连机制。</p>
</blockquote>
<p>解  决了消息处理不及时的问题，你可以再思考一下，这种队列模型，有什么缺点？</p>
<p>我们一起来分析一下：</p>
<ol>
<li><strong>不支持重复消费</strong>：消费者拉取消息后，这条消息就从 <code>List</code> 中删除了，无法被其它消费者再次消费，即不支持多个消费者消费同一批数据</li>
<li><strong>消息丢失</strong>：消费者拉取到消息后，如果发生异常宕机，那这条消息就丢失了</li>
</ol>
<p>第一个问题是功能上的，使用 <code>List</code> 做消息队列，它仅仅支持最简单的，一组生产者对应一组消费者，不能满足多组生产者和消费者的业务场景。</p>
<p>第二个问题就比较棘手了，因为从 <code>List</code> 中 <code>POP</code> 一条消息出来后，这条消息就会立即从链表中删除了。也就是说，无论消费者是否处理成功，这条消息都没办法再次消费了。</p>
<p>这也意味着，如果消费者在处理消息时异常宕机，那这条消息就相当于丢失了。</p>
<p>针对这 2 个问题怎么解决呢？我们一个个来看。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="发布订阅模型pubsub">发布/订阅模型：Pub/Sub<a href="#发布订阅模型pubsub" class="hash-link" aria-label="发布/订阅模型：Pub/Sub的直接链接" title="发布/订阅模型：Pub/Sub的直接链接">​</a></h2>
<p>从名字就能看出来，这个模块是 <code>Redis</code> 专门是针对「发布/订阅」这种队列模型设计的。</p>
<p>它正好可以解决前面提到的第一个问题：重复消费。</p>
<p>即多组生产者、消费者的场景，我们来看它是如何做的。</p>
<p><code>Redis</code> 提供了 <code>PUBLISH / SUBSCRIBE</code> 命令，来完成发布、订阅的操作。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-4-5a0a2ac9e450106f7ff9a3797302c9c9.jpg" width="721" height="291" class="img_ev3q"></p>
<p>假设你想开启 2 个消费者， 同时消费同一批数据，就可以按照以下方式来实现。</p>
<p>首先，使用 <code>SUBSCRIBE</code> 命令，启动 2 个消费者，并「订阅」同一个队列。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 2个消费者 都订阅一个队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; SUBSCRIBE queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading messages... (press Ctrl-C to quit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) &quot;subscribe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;queue&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) (integer) 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此时，2 个消费者都会被阻塞住，等待新消息的到来。</p>
<p>之后，再启动一个生产者，发布一条消息。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; PUBLISH queue msg1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这时，2 个消费者就会解除阻塞，收到生产者发来的新消息。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; SUBSCRIBE queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 收到新消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) &quot;message&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;queue&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) &quot;msg1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看到了么，使用 <code>Pub/Sub</code> 这种方案，既支持阻塞式拉取消息，还很好地满足了多组消费者，消费同一批数据的业务需求。</p>
<p>除此之外，<code>Pub/Sub</code> 还提供了「匹配订阅」模式，允许消费者根据一定规则，订阅「多个」自己感兴趣的队列。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 订阅符合规则的队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; PSUBSCRIBE queue.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading messages... (press Ctrl-C to quit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) &quot;psubscribe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;queue.*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) (integer) 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的消费者，订阅了 <code>queue.*</code> 相关的队列消息。</p>
<p>之后，生产者分别向 <code>queue.p1</code> 和 <code>queue.p2</code> 发布消息。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; PUBLISH queue.p1 msg1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; PUBLISH queue.p2 msg2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(integer) 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这时再看消费者，它就可以接收到这 2 个生产者的消息了。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; PSUBSCRIBE queue.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading messages... (press Ctrl-C to quit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 来自queue.p1的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) &quot;pmessage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;queue.*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) &quot;queue.p1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4) &quot;msg1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 来自queue.p2的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) &quot;pmessage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) &quot;queue.*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) &quot;queue.p2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4) &quot;msg2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-5-7bb92e70d6d6d9dd4ff0cf41fe7267b8.jpg" width="741" height="281" class="img_ev3q"></p>
<p>我们可以看到，<code>Pub/Sub</code> 最大的优势就是，支持多组生产者、消费者处理消息。</p>
<p>讲完了它的优点，那它有什么缺点呢？</p>
<p>其实，<code>Pub/Sub</code> 最大问题是：<strong>丢数据</strong>。</p>
<p>如果发生以下场景，就有可能导致数据丢失：</p>
<ul>
<li>消费者下线</li>
<li>Redis 宕机</li>
<li>消息堆积</li>
</ul>
<p>究竟是怎么回事？</p>
<p>这其实与 <code>Pub/Sub</code> 的实现方式有很大关系。</p>
<p><code>Pub/Sub</code> 在实现时非常简单，它没有基于任何数据类型，也没有做任何的数据存储，它只是单纯地为生产者、消费者建立「数据转发通道」，把符合规则的数据，从一端转发到另一端。</p>
<p>一个完整的发布、订阅消息处理流程是这样的：</p>
<ol>
<li>消费者订阅指定队列，<code>Redis</code> 就会记录一个映射关系：队列-&gt;消费者</li>
<li>生产者向这个队列发布消息，那 <code>Redis</code> 就从映射关系中找出对应的消费者，把消息转发给它</li>
</ol>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-6-7e0f32850a4b4ab7438f8496e0a6ff1f.jpg" width="691" height="241" class="img_ev3q"></p>
<p>看到了么，整个过程中，没有任何的数据存储，一切都是实时转发的。</p>
<p>这种设计方案，就导致了上面提到的那些问题。</p>
<p>例如，如果一个消费者异常挂掉了，它再重新上线后，只能接收新的消息，在下线期间生产者发布的消息，因为找不到消费者，都会被丢弃掉。</p>
<p>如果所有消费者都下线了，那生产者发布的消息，因为找不到任何一个消费者，也会全部「丢弃」。</p>
<p>所以，当你在使用 <code>Pub/Sub</code> 时，一定要注意：<strong>消费者必须先订阅队列，生产者才能发布消息，否则消息会丢失</strong>。</p>
<p>这也是前面讲例子时，我们让消费者先订阅队列，之后才让生产者发布消息的原因。</p>
<p>另外，因为 <code>Pub/Sub</code> 没有基于任何数据类型实现，所以它也不具备「数据持久化」的能力。</p>
<p>也就是说，<code>Pub/Sub</code> 的相关操作，不会写入到 <code>RDB</code> 和 <code>AOF</code> 中，当 <code>Redis</code> 宕机重启，<code>Pub/Sub</code> 的数据也会全部丢失。</p>
<p>最后，我们来看 <code>Pub/Sub</code> 在处理「消息积压」时，为什么也会丢数据？</p>
<p>当消费者的速度，跟不上生产者时，就会导致数据积压的情况发生。</p>
<p>如果采用 <code>List</code> 当作队列，消息积压时，会导致这个链表很长，最直接的影响就是，<code>Redis</code> 内存会持续增长，直到消费者把所有数据都从链表中取出。</p>
<p>但 <code>Pub/Sub</code> 的处理方式却不一样，<strong>当消息积压时，有可能会导致消费失败和消息丢失！</strong></p>
<p>这是怎么回事？</p>
<p>还是回到 <code>Pub/Sub</code> 的实现细节上来说。</p>
<p>每个消费者订阅一个队列时，<code>Redis</code> 都会在 <code>Server</code> 上给这个消费者在分配一个「缓冲区」，这个缓冲区其实就是一块内存。</p>
<p>当生产者发布消息时，<code>Redis</code> 先把消息写到对应消费者的缓冲区中。</p>
<p>之后，消费者不断地从缓冲区读取消息，处理消息。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-7-0e6098a6ed5f0416a327f7cdaf56b537.jpg" width="691" height="241" class="img_ev3q"></p>
<p>但是，问题就出在这个缓冲区上。</p>
<p>因为这个缓冲区其实是有「上限」的（可配置），如果消费者拉取消息很慢，就会造成生产者发布到缓冲区的消息开始积压，缓冲区内存持续增长。</p>
<p>如果超过了缓冲区配置的上限，此时，<code>Redis</code> 就会「强制」把这个消费者踢下线。</p>
<p>这时消费者就会消费失败，也会丢失数据。</p>
<p>如果你有看过 <code>Redis</code> 的配置文件，可以看到这个缓冲区的默认配置：<code>client-output-buffer-limit pubsub 32mb 8mb 60</code>。</p>
<p>它的参数含义如下：</p>
<ul>
<li><code>32mb</code>：缓冲区一旦超过 <code>32MB</code>，<code>Redis</code> 直接强制把消费者踢下线</li>
<li><code>8mb + 60</code>：缓冲区超过 <code>8MB</code>，并且持续 60 秒，<code>Redis</code> 也会把消费者踢下线</li>
</ul>
<p><code>Pub/Sub</code> 的这一点特点，是与 <code>List</code> 作队列差异比较大的。</p>
<p>从这里你应该可以看出，<strong>List 其实是属于「拉」模型，而 Pub/Sub 其实属于「推」模型</strong>。</p>
<p><code>List</code> 中的数据可以一直积压在内存中，消费者什么时候来「拉」都可以。</p>
<p>但 <code>Pub/Sub</code> 是把消息先「推」到消费者在 <code>Redis Server</code> 上的缓冲区中，然后等消费者再来取。</p>
<p>当生产、消费速度不匹配时，就会导致缓冲区的内存开始膨胀，<code>Redis</code> 为了控制缓冲区的上限，所以就有了上面 讲到的，强制把消费者踢下线的机制。</p>
<p>好了，现在我们总结一下 <code>Pub/Sub</code> 的优缺点：</p>
<ul>
<li>支持发布 / 订阅，支持多组生产者、消费者处理消息</li>
<li>消费者下线，数据会丢失</li>
<li>不支持数据持久化，<code>Redis</code> 宕机，数据也会丢失</li>
<li>消息堆积，缓冲区溢出，消费者会被强制踢下线，数据也会丢失</li>
</ul>
<p>有没有发现，除了第一个是优点之外，剩下的都是缺点。</p>
<p>所以，很多人看到 <code>Pub/Sub</code> 的特点后，觉得这个功能很「鸡肋」。</p>
<p>也正是以上原因，<code>Pub/Sub</code> 在实际的应用场景中用得并不多。</p>
<blockquote>
<p>目前只有哨兵集群和 Redis 实例通信时，采用了 <code>Pub/Sub</code> 的方案，因为哨兵正好符合即时通讯的业务场景。</p>
</blockquote>
<p>我们再来看一下，<code>Pub/Sub</code> 有没有解决，消息处理时异常宕机，无法再次消费的问题呢？</p>
<p>其实也不行，<code>Pub/Sub</code> 从缓冲区取走数据之后，数据就从 <code>Redis</code> 缓冲区删除了，消费者发生异常，自然也无法再次重新消费。</p>
<p>好，现在我们重新梳理一下，我们在使用消息队列时的需求。</p>
<p>当我们在使用一个消息队列时，希望它的功能如下：</p>
<ul>
<li>支持阻塞等待拉取消息</li>
<li>支持发布 / 订阅模式</li>
<li>消费失败，可重新消费，消息不丢失</li>
<li>实例宕机，消息不丢失，数据可持久化</li>
<li>消息可堆积</li>
</ul>
<p><code>Redis</code> 除了 <code>List</code> 和 <code>Pub/Sub</code> 之外，还有符合这些要求的数据类型吗？</p>
<p>其实，<code>Redis</code> 的作者也看到了以上这些问题，也一直在朝着这些方向努力着。</p>
<p><code>Redis</code> 作者在开发 <code>Redis</code> 期间，还另外开发了一个开源项目 <code>disque</code>。</p>
<p>这个项目的定位， 就是一个基于内存的分布式消息队列中间件。</p>
<p>但由于种种原因，这个项目一直不温不火。</p>
<p>终于，在 <code>Redis 5.0</code> 版本，作者把 <code>disque</code> 功能移植到了 <code>Redis</code> 中，并给它定义了一个新的数据类型：<code>Stream</code>。</p>
<p>下面我们就来看看，它能符合上面提到的这些要求吗？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="趋于成熟的队列stream">趋于成熟的队列：Stream<a href="#趋于成熟的队列stream" class="hash-link" aria-label="趋于成熟的队列：Stream的直接链接" title="趋于成熟的队列：Stream的直接链接">​</a></h2>
<p>我们来看 <code>Stream</code> 是如何解决上面这些问题的。</p>
<p>我们依旧从简单到复杂，依次来看 <code>Stream</code> 在做消息队列时，是如何处理的？</p>
<p>首先，<code>Stream</code> 通过 <code>XADD</code> 和 <code>XREAD</code> 完成最简单的生产、消费模型：</p>
<ul>
<li><code>XADD</code>：发布消息</li>
<li><code>XREAD</code>：读取消息</li>
</ul>
<p>生产者发布 2 条消息：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// *表示让Redis自动生成消息ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XADD queue * name zhangsan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1618469123380-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XADD queue * name lisi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1618469127777-0&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 <code>XADD</code> 命令发布消息，其中的<code>「*」</code>表示让 <code>Redis</code> 自动生成唯一的消息 ID。</p>
<p>这个消息 ID 的格式是「时间戳-自增序号」。</p>
<p>消费者拉取消息：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 从开头读取5条消息，0-0表示从开头读取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREAD COUNT 5 STREAMS queue 0-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;queue&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1) 1) 1) &quot;1618469123380-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         1) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            1) &quot;zhangsan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1) 1) &quot;1618469127777-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         1) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            1) &quot;lisi&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果想继续拉取消息，需要传入上一条消息的 ID：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREAD COUNT 5 STREAMS queue 1618469127777-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(nil)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>没有消息，<code>Redis</code> 会返回 NULL。</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/jpeg;base64,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" width="681" height="161" class="img_ev3q"></p>
<p>以上就是 Stream 最简单的生产、消费。</p>
<blockquote>
<p>这里不再重点介绍 <code>Stream</code> 命令的各种参数，我在例子中演示时，凡是大写的单词都是「固定」参数，凡是小写的单词，都是可以自己定义的，例如队列名、消息长度等等，下面的例子规则也是一样，为了方便你理解，这里有必要提醒一下。</p>
</blockquote>
<p>下面我们来看，针对前面提到的消息队列要求，<code>Stream</code> 都是如何解决的？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-stream-是否支持阻塞式拉取消息">1) Stream 是否支持「阻塞式」拉取消息？<a href="#1-stream-是否支持阻塞式拉取消息" class="hash-link" aria-label="1) Stream 是否支持「阻塞式」拉取消息？的直接链接" title="1) Stream 是否支持「阻塞式」拉取消息？的直接链接">​</a></h3>
<p>可以的，在读取消息时，只需要增加 BLOCK 参数即可。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// BLOCK 0 表示阻塞等待，不设置超时时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREAD COUNT 5 BLOCK 0 STREAMS queue 1618469127777-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这时，消费者就会阻塞等待，直到生产者发布新的消息才会返回。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-stream-是否支持发布--订阅模式">2) Stream 是否支持发布 / 订阅模式？<a href="#2-stream-是否支持发布--订阅模式" class="hash-link" aria-label="2) Stream 是否支持发布 / 订阅模式？的直接链接" title="2) Stream 是否支持发布 / 订阅模式？的直接链接">​</a></h3>
<p>也没问题，<code>Stream</code> 通过以下命令完成发布订阅：</p>
<ul>
<li><code>XGROUP</code>：创建消费者组</li>
<li><code>XREADGROUP</code>：在指定消费组下，开启消费者拉取消息</li>
</ul>
<p>下面我们来看具体如何做？</p>
<p>首先，生产者依旧发布 2 条消息：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XADD queue * name zhangsan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1618470740565-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XADD queue * name lisi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1618470743793-0&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>之后，我们想要开启 2 组消费者处理同一批数据，就需要创建 2 个消费者组：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 创建消费者组1，0-0表示从头拉取消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XGROUP CREATE queue group1 0-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 创建消费者组2，0-0表示从头拉取消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XGROUP CREATE queue group2 0-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>消费者组创建好之后，我们可以给每个「消费者组」下面挂一个「消费者」，让它们分别处理同一批数据。</p>
<p>第一个消费组开始消费：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// group1的consumer开始消费，&gt;表示拉取最新数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREADGROUP GROUP group1 consumer COUNT 5 STREAMS queue &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;queue&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2) 1) 1) &quot;1618470740565-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2) &quot;zhangsan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2) 1) &quot;1618470743793-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2) &quot;lisi&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同样地，第二个消费组开始消费：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// group2的consumer开始消费，&gt;表示拉取最新数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREADGROUP GROUP group2 consumer COUNT 5 STREAMS queue &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;queue&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2) 1) 1) &quot;1618470740565-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2) &quot;zhangsan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2) 1) &quot;1618470743793-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2) &quot;lisi&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以看到，这 2 组消费者，都可以获取同一批数据进行处理了。</p>
<p>这样一来，就达到了多组消费者「订阅」消费的目的。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-9-4691dda21c52e1a6e80dddeeeaba0c52.jpg" width="701" height="281" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-消息处理时异常stream-能否保证消息不丢失重新消费">3) 消息处理时异常，Stream 能否保证消息不丢失，重新消费？<a href="#3-消息处理时异常stream-能否保证消息不丢失重新消费" class="hash-link" aria-label="3) 消息处理时异常，Stream 能否保证消息不丢失，重新消费？的直接链接" title="3) 消息处理时异常，Stream 能否保证消息不丢失，重新消费？的直接链接">​</a></h3>
<p>除了上面拉取消息时用到了消息 ID，这里为了保证重新消费，也要用到这个消息 ID。</p>
<p>当一组消费者处理完消息后，需要执行 <code>XACK</code> 命令告知 <code>Redis</code>，这时 <code>Redis</code> 就会把这条消息标记为「处理完成」。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// group1下的 1618472043089-0 消息已处理完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XACK queue group1 1618472043089-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-10-f93ffd3544737b2b14679823d2c0e6a6.jpg" width="701" height="297" class="img_ev3q"></p>
<p>如果消费者异常宕机，肯定不会发送<code> XACK</code>，那么 <code>Redis</code> 就会依旧保留这条消息。</p>
<p>待这组消费者重新上线后，<code>Redis</code> 就会把之前没有处理成功的数据，重新发给这个消费者。这样一来，即使消费者异常，也不会丢失数据了。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 消费者重新上线，0-0表示重新拉取未ACK的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XREADGROUP GROUP group1 consumer1 COUNT 5 STREAMS queue 0-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 之前没消费成功的数据，依旧可以重新消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1) 1) &quot;queue&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2) 1) 1) &quot;1618472043089-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2) &quot;zhangsan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2) 1) &quot;1618472045158-0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2) 1) &quot;name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2) &quot;lisi&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-stream-数据会写入到-rdb-和-aof-做持久化吗">4) Stream 数据会写入到 RDB 和 AOF 做持久化吗？<a href="#4-stream-数据会写入到-rdb-和-aof-做持久化吗" class="hash-link" aria-label="4) Stream 数据会写入到 RDB 和 AOF 做持久化吗？的直接链接" title="4) Stream 数据会写入到 RDB 和 AOF 做持久化吗？的直接链接">​</a></h3>
<p><code>Stream</code> 是新增加的数据类型，它与其它数据类型一样，每个写操作，也都会写入到 <code>RDB</code> 和 <code>AOF</code> 中。</p>
<p>我们只需要配置好持久化策略，这样的话，就算 <code>Redis</code> 宕机重启，<code>Stream</code> 中的数据也可以从 <code>RDB</code> 或 <code>AOF</code> 中恢复回来。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-消息堆积时stream-是怎么处理的">5) 消息堆积时，Stream 是怎么处理的？<a href="#5-消息堆积时stream-是怎么处理的" class="hash-link" aria-label="5) 消息堆积时，Stream 是怎么处理的？的直接链接" title="5) 消息堆积时，Stream 是怎么处理的？的直接链接">​</a></h3>
<p>其实，当消息队列发生消息堆积时，一般只有 2 个解决方案：</p>
<ul>
<li>生产者限流：避免消费者处理不及时，导致持续积压</li>
<li>丢弃消息：中间件丢弃旧消息，只保留固定长度的新消息</li>
</ul>
<p>而 <code>Redis</code> 在实现 <code>Stream</code> 时，采用了第 2 个方案。</p>
<p>在发布消息时，你可以指定队列的最大长度，防止队列积压导致内存爆炸。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 队列长度最大10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:6379&gt; XADD queue MAXLEN 10000 * name zhangsan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;1618473015018-0&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当队列长度超过上限后，旧消息会被删除，只保留固定长度的新消息。</p>
<p>这么来看，<code>Stream</code> 在消息积压时，如果指定了最大长度，还是有可能丢失消息的。</p>
<blockquote>
<p>除了以上介绍到的命令，<code>Stream</code> 还支持查看消息长度（<code>XLEN</code>）、查看消费者状态（<code>XINFO</code>）等命令，使用也比较简单，你可以查询官方文档了解一下，这里就不过多介绍了。</p>
</blockquote>
<p>好了，通过以上介绍，我们可以看到，<code>Redis</code> 的 <code>Stream</code> 几乎覆盖到了消息队列的各种场景，是不是觉得很完美？</p>
<p><strong>既然它的功能这么强大，这是不是意味着，Redis 真的可以作为专业的消息队列中间件来使用呢？</strong></p>
<p>但是还「差一点」，就算 <code>Redis</code> 能做到以上这些，也只是「趋近于」专业的消息队列。</p>
<p>原因在于 <code>Redis</code> 本身的一些问题，如果把其定位成消息队列，还是有些欠缺的。</p>
<p>到这里，就不得不把 <code>Redis</code> 与专业的队列中间件做对比了。</p>
<p>下面我们就来看一下，<code>Redis</code> 在作队列时，到底还有哪些欠缺？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="与专业的消息队列对比">与专业的消息队列对比<a href="#与专业的消息队列对比" class="hash-link" aria-label=" 与专业的消息队列对比的直接链接" title="与专业的消息队列对比的直接链接">​</a></h2>
<p>其实，一个专业的消息队列，必须要做到两大块：</p>
<ul>
<li>消息不丢</li>
<li>消息可堆积</li>
</ul>
<p>前面我们讨论的重点，很大篇幅围绕的是第一点展开的。</p>
<p>这里我们换个角度，从一个消息队列的「使用模型」来分析一下，怎么做，才能保证数据不丢？</p>
<p>使用一个消息队列，其实就分为三大块：生产者、队列中间件、消费者。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-11-becb06929fd4d5f0bd42af48dd56f250.jpg" width="731" height="192" class="img_ev3q"></p>
<p>消息是否会发生丢失，其重点也就在于以下 3 个环节：</p>
<ul>
<li>生产者会不会丢消息？</li>
<li>消费者会不会丢消息？</li>
<li>队列中间件会不会丢消息？</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-生产者会不会丢消息">1) 生产者会不会丢消息？<a href="#1-生产者会不会丢消息" class="hash-link" aria-label="1) 生产者会不会丢消息？的直接链接" title="1) 生产者会不会丢消息？的直接链接">​</a></h3>
<p>当生产者在发布消息时，可能发生以下异常情况：</p>
<ul>
<li>消息没发出去：网络故障或其它问题导致发布失败，中间件直接返回失败</li>
<li>不确定是否发布成功：网络问题导致发布超时，可能数据已发送成功，但读取响应结果超时了</li>
</ul>
<p>如果是情况 1，消息根本没发出去，那么重新发一次就好了。</p>
<p>如果是情况 2，生产者没办法知道消息到底有没有发成功？所以，为了避免消息丢失，它也只能继续重试，直到发布成功为止。</p>
<blockquote>
<p>生产者一般会设定一个最大重试次数，超过上限依旧失败，需要记录日志报警处理。</p>
</blockquote>
<p>也就是说，生产者为了避免消息丢失，只能采用失败重试的方式来处理。</p>
<p>但发现没有？这也意味着消息可能会重复发送。</p>
<p>是的，在使用消息队列时，要保证消息不丢，宁可重发，也不能丢弃。</p>
<p>那消费者这边，就需要多做一些逻辑了。</p>
<p>对于敏感业务，当消费者收到重复数据数据时，要设计幂等逻辑，保证业务的正确性。</p>
<p>从这个角度来看，生产者会不会丢消息，取决于生产者对于异常情况的处理是否合理。</p>
<p>所以，无论是 <code>Redis</code> 还是专业的队列中间件，生产者在这一点上都是可以保证消息不丢的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-消费者会不会丢消息">2) 消费者会不会丢消息？<a href="#2-消费者会不会丢消息" class="hash-link" aria-label="2) 消费者会不会丢消息？的直接链接" title="2) 消费者会不会丢消息？的直接链接">​</a></h3>
<p>这种情况就是我们前面提到的，消费者拿到消息后，还没处理完成，就异常宕机了，那消费者还能否重新消费失败的消息？</p>
<p>要解决这个问题，消费者在处理完消息后，必须「告知」队列中间件，队列中间件才会把标记已处理，否则仍旧把这些数据发给消费者。</p>
<p>这种方案需要消费者和中间件互相配合，才能保证消费者这一侧的消息不丢。</p>
<p>无论是 <code>Redis</code> 的 <code>Stream</code>，还是专业的队列中间件，例如 <code>RabbitMQ</code>、<code>Kafka</code>，其实都是这么做的。</p>
<p>所以，从这个角度来看，<code>Redis</code> 也是合格的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-队列中间件会不会丢消息">3) 队列中间件会不会丢消息？<a href="#3-队列中间件会不会丢消息" class="hash-link" aria-label="3) 队列中间件会不会丢消息？的直接链接" title="3) 队列中间件会不会丢消息？的直接链接">​</a></h3>
<p>前面 2 个问题都比较好处理，只要客户端和服务端配合好，就能保证生产端、消费端都不丢消息。</p>
<p>但是，如果队列中间件本身就不可靠呢？</p>
<p>毕竟生产者和消费这都依赖它，如果它不可靠，那么生产者和消费者无论怎么做，都无法保证数据不丢。</p>
<p>在这个方面，<code>Redis</code> 其实没有达到要求。</p>
<p><code>Redis</code> 在以下 2 个场景下，都会导致数据丢失。</p>
<ul>
<li>AOF 持久化配置为每秒写盘，但这个写盘过程是异步的，<code>Redis</code> 宕机时会存在数据丢失的可能</li>
<li>主从复制也是异步的，主从切换时，也存在丢失数据的可能（从库还未同步完成主库发来的数据，就被提成主库）</li>
</ul>
<p>基于以上原因我们可以看到，<strong>Redis 本身的无法保证严格的数据完整性</strong>。</p>
<p>所以，如果把 <code>Redis</code> 当做消息队列，在这方面是有可能导致数据丢失的。</p>
<p>再来看那些专业的消息队列中间件是如何解决这个问题的？</p>
<p>像 <code>RabbitMQ</code> 或 <code>Kafka</code> 这类专业的队列中间件，在使用时，一般是部署一个集群，生产者在发布消息时，队列中间件通常会写「多个节点」，以此保证消息的完整性。这样一来，即便其中一个节点挂了，也能保证集群的数据不丢失。</p>
<p>也正因为如此，<code>RabbitMQ</code>、<code>Kafka</code>在设计时也更复杂。毕竟，它们是专门针对队列场景设计的。</p>
<p>但 <code>Redis</code> 的定位则不同，它的定位更多是当作缓存来用，它们两者在这个方面肯定是存在差异的。</p>
<p>最后，我们来看消息积压怎么办？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-消息积压怎么办">4) 消息积压怎么办？<a href="#4-消息积压怎么办" class="hash-link" aria-label="4) 消息积压怎么办？的直接链接" title="4) 消息积压怎么办？的直接链  接">​</a></h3>
<p>因为 <code>Redis</code> 的数据都存储在内存中，这就意味着一旦发生消息积压，则会导致 <code>Redis</code> 的内存持续增长，如果超过机器内存上限，就会面临被 OOM 的风险。</p>
<p>所以，<code>Redis</code> 的 <code>Stream</code> 提供了可以指定队列最大长度的功能，就是为了避免这种情况发生。</p>
<p>但 <code>Kafka</code>、<code>RabbitMQ</code> 这类消息队列就不一样了，它们的数据都会存储在磁盘上，磁盘的成本要比内存小得多，当消息积压时，无非就是多占用一些磁盘空间，相比于内存，在面对积压时也会更加「坦然」。</p>
<p>综上，我们可以看到，把 <code>Redis</code> 当作队列来使用时，始终面临的 2 个问题：</p>
<ul>
<li><code>Redis</code> 本身可能会丢数据</li>
<li>面对消息积压，<code>Redis</code> 内存资源紧张</li>
</ul>
<p>到这里，<code>Redis</code> 是否可以用作队列，我想这个答案你应该会比较清晰了。</p>
<p>如果你的业务场景足够简单，对于数据丢失不敏感，而且消息积压概率比较小的情况下，把 <code>Redis</code> 当作队列是完全可以的。</p>
<p>而且，<code>Redis</code> 相比于 <code>Kafka</code>、<code>RabbitMQ</code>，部署和运维也更加轻量。</p>
<p>如果你的业务场景对于数据丢失非常敏感，而且写入量非常大，消息积压时会占用很多的机器资源，那么我建议你使用专业的消息队列中间件。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>好了，总结一下。这篇文章我们从「Redis 能否用作队列」这个角度出发，介绍了 <code>List</code>、<code>Pub/Sub</code>、<code>Stream</code> 在做队列的使用方式，以及它们各自的优劣。</p>
<p>之后又把 <code>Redis</code> 和专业的消息队列中间件  做对比，发现 <code>Redis</code> 的不足之处。</p>
<p>最后，我们得出 <code>Redis</code> 做队列的合适场景。</p>
<p>这里我也列了一个表格，总结了它们各自的优缺点。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/19-12-18b7eb6e203984b1416997434842f9e9.jpg" width="741" height="356" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="后记">后记<a href="#后记" class="hash-link" aria-label="后记的直接链接" title="后记的直接链接">​</a></h2>
<p>最后，我想和你再聊一聊关于「技术方案选型」的问题。</p>
<p>你应该也看到了，这篇文章虽然始于 <code>Redis</code>，但并不止于 <code>Redis</code>。</p>
<p>我们在分析 <code>Redis</code> 细节时，一直在提出问题，然后寻找更好的解决方案，在文章最后，又聊到一个专业的消息队列应该怎么做。</p>
<p>其实，我们在讨论技术选型时，就是一个关于如何取舍的问题。</p>
<p>而这里我想传达给你的信息是，<strong>在面对技术选型时，不要不经过思考就觉得哪个方案好，哪个方案不好</strong>。</p>
<p>你需要根据具体场景具体分析，这里我把这个分析过程分为 2 个层面：</p>
<ul>
<li>业务功能角度</li>
<li>技术资源角度</li>
</ul>
<p>这篇文章所讲到的内容，都是以业务功能角度出发做决策的。</p>
<p>但这里的第二点，从技术资源角度出发，其实也很重要。</p>
<p>技术资源的角度是说，<strong>你所处的公司环境、技术资源能否匹配这些技术方案</strong>。</p>
<p>这个怎么解释呢？</p>
<p>简单来讲，就是你所在的公司、团队，是否有匹配的资源能 hold 住这些技术方案。</p>
<p>我们都知道 <code>Kafka</code>、<code>RabbitMQ</code> 是非常专业的消息中间件，但它们的部署和运维，相比于 <code>Redis</code> 来说，也会更复杂一些。</p>
<p>如果你在一个大公司，公司本 身就有优秀的运维团队，那么使用这些中间件肯定没问题，因为有足够优秀的人能 hold 住这些中间件，公司也会投入人力和时间在这个方向上。</p>
<p>但如果你是在一个初创公司，业务正处在快速发展期，暂时没有能 hold 住这些中间件的团队和人，如果贸然使用这些组件，当发生故障时，排查问题也会变得很困难，甚至会阻碍业务的发展。</p>
<p>而这种情形下，如果公司的技术人员对于 <code>Redis</code> 都很熟，综合评估来看，<code>Redis</code> 也基本可以满足业务 90% 的需求，那当下选择 <code>Redis</code> 未必不是一个好的决策。</p>
<p>所以，<strong>做技术选型不只是技术问题，还与人、团队、管理、组织结构有关</strong>。</p>
<p>也正是因为这些原因，当你在和别人讨论技术选型问题时，你会发现每个公司的做法都不相同。</p>
<p>毕竟每个公司所处的环境和文化不一样，做出的决策当然就会各有差异。</p>
<p>如果你不了解这其中的逻辑，那在做技术选型时，只会趋于表面现象，无法深入到问题根源。</p>
<p>而一旦你理解了这个逻辑，那么你在看待这个问题时，不仅对于技术会有更加深刻认识，对技术资源和人的把握，也会更加清晰。</p>
<p>希望你以后在做技术选型时，能够把这些因素也考虑在内，这对你的技术成长之路也是非常有帮助的。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/middleware/redis/19-Make-Redis-Message-Queue.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>Lorchr</b> <!-- -->于 <b><time datetime="2025-06-07T06:55:55.000Z" itemprop="dateModified">2025年6月7日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/middleware/redis/Redis-Memory-Fragment-Clear/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Redis-Memory-Fragment-Clear</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/middleware/redis/RedisConfigBean/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">RedisConfigBean</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#从最简单的开始list-队列" class="table-of-contents__link toc-highlight">从最简单的开始：List 队列</a></li><li><a href="#发布订阅模型pubsub" class="table-of-contents__link toc-highlight">发布/订阅模型：Pub/Sub</a></li><li><a href="#趋于成熟的队列stream" class="table-of-contents__link toc-highlight">趋于成熟的队列：Stream</a><ul><li><a href="#1-stream-是否支持阻塞式拉取消息" class="table-of-contents__link toc-highlight">1) Stream 是否支持「阻塞式」拉取消息？</a></li><li><a href="#2-stream-是否支持发布--订阅模式" class="table-of-contents__link toc-highlight">2) Stream 是否支持发布 / 订阅模式？</a></li><li><a href="#3-消息处理时异常stream-能否保证消息不丢失重新消费" class="table-of-contents__link toc-highlight">3) 消息处理时异常，Stream 能否保证消息不丢失，重新消费？</a></li><li><a href="#4-stream-数据会写入到-rdb-和-aof-做持久化吗" class="table-of-contents__link toc-highlight">4) Stream 数据会写入到 RDB 和 AOF 做持久化吗？</a></li><li><a href="#5-消息堆积时stream-是怎么处理的" class="table-of-contents__link toc-highlight">5) 消息堆积时，Stream 是怎么处理的？</a></li></ul></li><li><a href="#与专业的消息队列对比" class="table-of-contents__link toc-highlight">与专业的消息队列对比</a><ul><li><a href="#1-生产者会不会丢消息" class="table-of-contents__link toc-highlight">1) 生产者会不会丢消息？</a></li><li><a href="#2-消费者会不会丢消息" class="table-of-contents__link toc-highlight">2) 消费者会不会丢消息？</a></li><li><a href="#3-队列中间件会不会丢消息" class="table-of-contents__link toc-highlight">3) 队列中间件会不会丢消息？</a></li><li><a href="#4-消息积压怎么办" class="table-of-contents__link toc-highlight">4) 消息积压怎么办？</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#后记" class="table-of-contents__link toc-highlight">后记</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>