<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-middleware docs-doc-id-redis/Lettuce_pipeline2" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Lettuce_pipeline2 | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/light-docusaurus/middleware/redis/Lettuce_pipeline2/"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" property="og:title" content="Lettuce_pipeline2 | Light Docusaurus"><meta data-rh="true" name="description" content="- lettuce 在spring-data-redis包装后关于pipeline的坑，你知道吗？"><meta data-rh="true" property="og:description" content="- lettuce 在spring-data-redis包装后关于pipeline的坑，你知道吗？"><link data-rh="true" rel="icon" href="/light-docusaurus/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/light-docusaurus/middleware/redis/Lettuce_pipeline2/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/middleware/redis/Lettuce_pipeline2/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/middleware/redis/Lettuce_pipeline2/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/light-docusaurus/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/light-docusaurus/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/light-docusaurus/opensearch.xml"><link rel="stylesheet" href="/light-docusaurus/assets/css/styles.418b352b.css">
<link rel="preload" href="/light-docusaurus/assets/js/runtime~main.bed3725d.js" as="script">
<link rel="preload" href="/light-docusaurus/assets/js/main.25e90a47.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/light-docusaurus/"><div class="navbar__logo"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/light-docusaurus/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/light-docusaurus/blog/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/light-docusaurus/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/light-docusaurus/electron/">Electron</a><a class="navbar__item navbar__link" href="/light-docusaurus/postman/">Postman</a><a class="navbar__item navbar__link" href="/light-docusaurus/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/light-docusaurus/middleware/redis/Lettuce_pipeline2/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/light-docusaurus/middleware/">MiddleWare</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/mysql/">Mysql</a><button aria-label="打开/收起侧边栏菜单「Mysql」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/postgresql/">Postgresql</a><button aria-label="打开/收起侧边栏菜单「Postgresql」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/light-docusaurus/middleware/category/redis/">Redis</a><button aria-label="打开/收起侧边栏菜单「Redis」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Build-Redis-Cluster-With-Docker-Compose/">Build-Redis-Cluster-With-Docker-Compose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Distrubute-Cache-Middleware-Hazelcast-Redis-Compare/">Distrubute-Cache-Middleware-Hazelcast-Redis-Compare</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Feed-Stream-System/">Feed-Stream-System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Lettuce-RedisCommandTimeoutException/">Lettuce-RedisCommandTimeoutException</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Lettuce_pipeline1/">Lettuce_pipeline1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/light-docusaurus/middleware/redis/Lettuce_pipeline2/">Lettuce_pipeline2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Lua-In-Redis/">Lua-In-Redis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Redis-Memory-Usage/">Redis-Memory-Usage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Redis-Use-Situation/">Redis-Use-Situation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Redis-data-persistence/">Redis-data-persistence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/RedisConfigBean/">RedisConfigBean</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Risk-Control/">Risk-Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Spring-Boot-RateLimit/">Spring-Boot-RateLimit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/redis/Spring-Boot-Redis-BitMap/">Spring-Boot-Redis-BitMap</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/nginx/">Nginx</a><button aria-label="打开/收起侧边栏菜单「Nginx」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/mqtt/">MQTT</a><button aria-label="打开/收起侧边栏菜单「MQTT」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/influxdb/">InfluxDB</a><button aria-label="打开/收起侧边栏菜单「InfluxDB」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/plusar/">Plusar</a><button aria-label="打开/收起侧边栏菜单「Plusar」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/light-docusaurus/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/light-docusaurus/middleware/category/redis/"><span itemprop="name">Redis</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lettuce_pipeline2</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Lettuce_pipeline2</h1></header><ul><li><a href="https://cloud.tencent.com/developer/article/1661743" target="_blank" rel="noopener noreferrer">lettuce 在spring-data-redis包装后关于pipeline的坑，你知道吗？</a></li><li><a href="https://cloud.tencent.com/developer/article/1661745" target="_blank" rel="noopener noreferrer">spring-data-redis中lettuce pipeline的坑之解决篇</a></li></ul><blockquote><p>在上一篇中我们知道了几种常用的redis client，分别分析了lettuce原生的pipeline处理方式和在使用spring data redis包装后的lettuce处理pipeline时源码细节，并知道了后者直接使用时并不是真正的pipeline操作。那么如果我既想要使用spring-data-redis来操作lettuce的pipeline，又想要真正做到pipeline该怎么处理呢？本节我们就来聊一聊这个问题。与此同时，我们会来进一步地分析下redis connection和pool的内容。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>我们先来了解下在spring-data-redis中是如何包装lettuce的连接的，然后会根据这些信息得到上一篇文章中留下的那个问题的解。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="连接处理">连接处理<a href="#连接处理" class="hash-link" aria-label="连接处理的直接链接" title="连接处理的直接链接">​</a></h2><p>会先后对r连接池、redisTemplate模式下的连接和shareNativeConnection模式下的连接处理方式进行分析。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="连接池">连接池<a href="#连接池" class="hash-link" aria-label="连接池的直接链接" title="连接池的直接链接">​</a></h2><p>如果想了解连接池的内容，就需要了解下LettuceConnectionFactory。我们来看一下它的属性：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private final LettuceClientConfiguration clientConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable AbstractRedisClient client;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable LettuceConnectionProvider connectionProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable LettuceConnectionProvider reactiveConnectionProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private boolean validateConnection = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private boolean shareNativeConnection = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable SharedConnection&lt;byte[]&gt; connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable SharedConnection&lt;ByteBuffer&gt; reactiveConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable LettucePool pool;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** Synchronization monitor for the shared Connection */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private final Object connectionMonitor = new Object();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private boolean convertPipelineAndTxResults = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private RedisStandaloneConfiguration standaloneConfig = new RedisStandaloneConfiguration(&quot;localhost&quot;, 6379);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable RedisConfiguration configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable ClusterCommandExecutor clusterCommandExecutor;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要属性">主要属性:<a href="#主要属性" class="hash-link" aria-label="主要属性:的直接链接" title="主要属性:的直接链接">​</a></h3><ul><li>LettuceClientConfiguration：client的配置，基于commons pool的连接池目前也是基于它；</li><li>AbstractRedisClient client：内部维持的redis client对象;</li><li>LettuceConnectionProvider connectionProvider: 连接提供者，连接池就是由它来提供</li><li>LettuceConnectionProvider reactiveConnectionProvider: reactive模式下的连接提供者</li><li>validateConnection：是否校验连接•shareNativeConnection：是否共享本地连接</li><li>SharedConnection&lt;byte[]&gt; connection：用于共享的连接，如果shareNativeConnection为false则此处为null</li><li>SharedConnection reactiveConnection：用于reactive模式下的共享连接</li><li>LettucePool pool：旧版本的lettuce连接池，目前由commons pool替代了</li><li>Object connectionMonitor: 共享的连接之间用于同步的monitor</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要方法">主要方法:<a href="#主要方法" class="hash-link" aria-label="主要方法:的直接链接" title="主要方法:的直接链接">​</a></h3><ol><li>连接池</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param pool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @deprecated since 2.0, use pooling via {@link LettucePoolingClientConfiguration}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Deprecated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public LettuceConnectionFactory(LettucePool pool) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this(new MutableLettuceClientConfiguration());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.pool = pool;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>旧的连接工厂，目前不再使用了，目前使用的是根据<code>LettucePoolingClientConfiguration</code>的配置初始化的连接池。</p><p><code>LettuceConnectionFactory</code>的创建部分见<code>org.springframework.boot.autoconfigure.data.redis.LettuceConnectionConfiguration#redisConnectionFactory</code>方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnMissingBean(RedisConnectionFactory.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public LettuceConnectionFactory redisConnectionFactory(ClientResources clientResources)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws UnknownHostException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LettuceClientConfiguration clientConfig = getLettuceClientConfiguration(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientResources, this.properties.getLettuce().getPool());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return createLettuceConnectionFactory(clientConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过clientResources和配置信息来初始化<code>LettuceClientConfiguration</code>。</p><ol start="2"><li><code>LettuceConnectionConfiguration#getLettuceClientConfiguration</code>方法：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private LettuceClientConfiguration getLettuceClientConfiguration(ClientResources clientResources, Pool pool) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LettuceClientConfigurationBuilder builder = createBuilder(pool);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applyProperties(builder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.hasText(this.properties.getUrl())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        customizeConfigurationFromUrl(builder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.clientResources(clientResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    customize(builder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return builder.build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里通过<code>LettuceClientConfigurationBuilder</code>来构建<code>LettuceClientConfiguration</code>对象的，来看下它的实现：</p><p>那么这里会创建<code>LettuceClientConfigurationBuilder</code>对象还是<code>LettucePoolingClientConfigurationBuilder</code>对象呢？需要来看下createBuilder方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private LettuceClientConfigurationBuilder createBuilder(Pool pool) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (pool == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return LettuceClientConfiguration.builder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new PoolBuilderFactory().createBuilder(pool);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出如果配置了<code>spring.redis.lettuce.pool</code>的相关信息，这里就会生成<code>LettucePoolingClientConfigurationBuilder</code>对象。我们来看下<code>LettucePoolingClientConfigurationBuilder</code>的<code>build</code>方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public LettucePoolingClientConfiguration build() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DefaultLettucePoolingClientConfiguration(super.build(), poolConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里最后生成的是<code>DefaultLettucePoolingClientConfiguration</code>对象，内部使用的连接池配置为<code>commons-pool</code>提供的<code>GenericObjectPoolConfig</code>。</p><ol start="3"><li>我们来看下<code>LettuceConnectionFactory</code>的初始化部分，<code>LettuceConnectionFactory#afterPropertiesSet</code>：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void afterPropertiesSet() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.client = createClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.connectionProvider = createConnectionProvider(client, LettuceConnection.CODEC);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //--------省略集群模式下的---------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里省略掉集群模式下的初始化方式的分析，因为单机和集群版的流程大致相同，只是一些配置不太一样。</p><ol start="4"><li>createConnectionProvider方法：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private LettuceConnectionProvider createConnectionProvider(AbstractRedisClient client, RedisCodec&lt;?, ?&gt; codec) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LettuceConnectionProvider connectionProvider = doCreateConnectionProvider(client, codec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.clientConfiguration instanceof LettucePoolingClientConfiguration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new LettucePoolingConnectionProvider(connectionProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (LettucePoolingClientConfiguration) this.clientConfiguration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return connectionProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于上面生成的是<code>DefaultLettucePoolingClientConfiguration</code>，这里最后生成的就是<code>LettucePoolingConnectionProvider</code>对象。也就是一个池化的对象。</p><p>接下来我们来看一看从它里面获取连接的方法<code>org.springframework.data.redis.connection.lettuce.LettucePoolingConnectionProvider#getConnection</code>：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private final Map&lt;Class&lt;?&gt;, GenericObjectPool&lt;StatefulConnection&lt;?, ?&gt;&gt;&gt; pools = new ConcurrentHashMap&lt;&gt;(32);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T extends StatefulConnection&lt;?, ?&gt;&gt; T getConnection(Class&lt;T&gt; connectionType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GenericObjectPool&lt;StatefulConnection&lt;?, ?&gt;&gt; pool = pools.computeIfAbsent(connectionType, poolType -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ConnectionPoolSupport.createGenericObjectPool(() -&gt; connectionProvider.getConnection(connectionType),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                poolConfig, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StatefulConnection&lt;?, ?&gt; connection = pool.borrowObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolRef.put(connection, pool);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return connectionType.cast(connection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new PoolException(&quot;Could not get a resource from the pool&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>pools是用来维护Connection类型与<code>GenericObjectPool</code>连接池之间关系的一个map，每次获取连接时会根据连接类型获取到对应的连接池，然后从连接池中获取连接。在LettucePoolingConnectionProvider内部包装着一个<code>StandaloneConnectionProvider</code>类型的provider，它才是最终提供connection对象的provider，代码部分为：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionPoolSupport.createGenericObjectPool(() -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connectionProvider.getConnection(connectionType), poolConfig, false)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory#getConnection</code></p><p>该方法的代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private @Nullable LettucePool pool;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public RedisConnection getConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isClusterAware()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getClusterConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LettuceConnection connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (pool != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connection = new LettuceConnection(getSharedConnection(), getTimeout(), null, pool, getDatabase());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connection = new LettuceConnection(getSharedConnection(), connectionProvider, getTimeout(), getDatabase());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection.setConvertPipelineAndTxResults(convertPipelineAndTxResults);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里需要注意一点，这个pool是<code>LettucePool</code>对象，在上文中已经分析过，它是比较老的api中的使用的pool，在新的中使用<code>commons-pool</code>代替了。所以这里在新的配置环境中会走pool==null这个分支。<code>LettuceConnection</code>的第一个入参是<code>StatefulConnection&lt;byte[], byte[]&gt; asyncSharedConn</code>对象，也就是说<code>getSharedConnection</code>方法返回的结果是<code>asyncSharedConn</code>。这个会对<code>LettuceConnection</code>的<code>getAsyncConnection</code>方法产生影响，该方法代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RedisClusterAsyncCommands&lt;byte[], byte[]&gt; getAsyncConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isQueueing()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getAsyncDedicatedConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (asyncSharedConn != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (asyncSharedConn instanceof StatefulRedisConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果asyncSharedConn不为空，则会通过它的async方法来创建RedisClusterAsyncCommands对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ((StatefulRedisConnection&lt;byte[], byte[]&gt;) asyncSharedConn).async();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果asyncSharedConn为空，则走getAsyncDedicatedConnection方法来创建RedisClusterAsyncCommands</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getAsyncDedicatedConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>如果<code>asyncSharedConn</code>不为空，这里会通过<code>asyncSharedConn</code>的<code>async()</code>方法来生成<code>RedisClusterAsyncCommands</code>对象。</p></li><li><p>如果<code>asyncSharedConn</code>为空，则会调用getAsyncDedicatedConnection方法来生成RedisClusterAsyncCommands对象:</p></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected RedisClusterAsyncCommands&lt;byte[], byte[]&gt; getAsyncDedicatedConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (asyncDedicatedConn == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncDedicatedConn = doGetAsyncDedicatedConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (asyncDedicatedConn instanceof StatefulRedisConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((StatefulRedisConnection&lt;byte[], byte[]&gt;) asyncDedicatedConn).sync().select(dbIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (asyncDedicatedConn instanceof StatefulRedisConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((StatefulRedisConnection&lt;byte[], byte[]&gt;) asyncDedicatedConn).async();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (asyncDedicatedConn instanceof StatefulRedisClusterConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((StatefulRedisClusterConnection&lt;byte[], byte[]&gt;) asyncDedicatedConn).async();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ------------省略部分代码----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.data.redis.connection.lettuce.LettuceConnection#doGetAsyncDedicatedConnection：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected StatefulConnection&lt;byte[], byte[]&gt; doGetAsyncDedicatedConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return connectionProvider.getConnection(StatefulConnection.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出最终<code>doGetAsyncDedicatedConnection</code>方法也是通过<code>connectionProvider</code>对象来获取<code>StatefulConnection</code>类型的连接对象的。</p><p>那么，调用哪个方法会返回<code>RedisClusterAsyncCommands</code>对象呢?</p><p>在<code>LettuceConnection</code>中只有一个public的方法返回<code>RedisClusterAsyncCommands</code>对象的：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public RedisClusterAsyncCommands&lt;byte[], byte[]&gt; getNativeConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LettuceSubscription subscription = this.subscription;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (subscription != null ? subscription.getNativeConnection().async() : getAsyncConnection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出，它调用的实际上也是<code>getAsyncConnection()</code>方法。</p><p>shareNativeConnection 参数</p><p>来看一下<code>org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory#getSharedConnection</code>方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected StatefulRedisConnection&lt;byte[], byte[]&gt; getSharedConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return shareNativeConnection ? (StatefulRedisConnection) getOrCreateSharedConnection().getConnection() : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里有一个很重要的参数——<code>shareNativeConnection</code>，如果<code>shareNativeConnection</code>为true，会使用<code>getOrCreateSharedConnection().getConnection()</code>来操作，它的第一步返回的是<code>SharedConnection</code>对象，然后通过<code>getConnection()</code>来获取native连接。我们来看下它们的方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory#getOrCreateSharedConnection:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private SharedConnection&lt;byte[]&gt; getOrCreateSharedConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (this.connectionMonitor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.connection == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果为空，则创建 SharedConnection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.connection = new SharedConnection&lt;&gt;(connectionProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果不为空，则使用相同连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory.SharedConnection#getConnection:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StatefulConnection&lt;E, E&gt; getConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (this.connectionMonitor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.connection == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 如果connectin为空则调用getNativeConnection方法获取连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.connection = getNativeConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (getValidateConnection()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 校验连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            validateConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果内部连接已经存在，则返回相同的连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory.SharedConnection#getNativeConnection:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Obtain a connection from the associated {@link LettuceConnectionProvider}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* @return the connection.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private StatefulConnection&lt;E, E&gt; getNativeConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 从provider中获取连接，这里也是从连接池中去获取连接的，返回的也是StatefulConnection类型的连接对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return connectionProvider.getConnection(StatefulConnection.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (RedisException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new RedisConnectionFailureException(&quot;Unable to connect to Redis&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里主要是获取<code>SharedConnection</code>的步骤，最终会从<code>connectionProvider</code>中获取shared连接，连接为<code>StatefulConnection</code>类型。可以看出通过<code>LettuceConnectionFactory#getSharedConnection</code>方法最终获取到的连接为<code>StatefulRedisConnection</code>对象。</p><p><code>shareNativeConnection</code>为true和false的区别</p><p>上面我们知道，当<code>shareNativeConnection</code>为true时会通过<code>getOrCreateSharedConnection().getConnection()</code>来初始化<code>LettuceConnection</code>的<code>asyncSharedConn</code>属性。它生成的是<code>SharedConnection</code>对象，然后通过它的<code>getConnection</code>方法获取具体连接的。在它们里面都有一个共同点，会先判断当连接对象为空时会创建新的连接，如果已经初始化过了，则使用已有的连接，即共享连接。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="redistemplate模式下的连接">redisTemplate模式下的连接<a href="#redistemplate模式下的连接" class="hash-link" aria-label="redisTemplate模式下的连接的直接链接" title="redisTemplate模式下的连接的直接链接">​</a></h2><p>咱们以<code>this.redisTemplate.opsForValue().get(cacheKey)</code>方法为切入点往下来看。</p><p>首先是<code>org.springframework.data.redis.core.DefaultValueOperations#get(java.lang.Object)</code>方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public V get(Object key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(new ValueDeserializingRedisCallback(key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected byte[] inRedis(byte[] rawKey, RedisConnection connection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return connection.get(rawKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着往下走，继续往下看<code>org.springframework.data.redis.core.AbstractOperations#execute</code>方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;T&gt; T execute(RedisCallback&lt;T&gt; callback, boolean b) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return template.execute(callback, b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.data.redis.core.RedisTemplate#execute(org.springframework.data.redis.core.RedisCallback&lt;T&gt;, boolean):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T execute(RedisCallback&lt;T&gt; action, boolean exposeConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(action, exposeConnection, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// org.springframework.data.redis.core.RedisTemplate#execute(org.springframework.data.redis.core.RedisCallback&lt;T&gt;, boolean, boolean):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T execute(RedisCallback&lt;T&gt; action, boolean exposeConnection, boolean pipeline) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.isTrue(initialized, &quot;template not initialized; call afterPropertiesSet() before using it&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(action, &quot;Callback object must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisConnectionFactory factory = getRequiredConnectionFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisConnection conn = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (enableTransactionSupport) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 开启事务时获取连接的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // only bind resources in case of potential transaction synchronization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn = RedisConnectionUtils.bindConnection(factory, enableTransactionSupport);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取连接的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn = RedisConnectionUtils.getConnection(factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean existingConnection = TransactionSynchronizationManager.hasResource(factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RedisConnection connToUse = preProcessConnection(conn, existingConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean pipelineStatus = connToUse.isPipelined();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pipeline &amp;&amp; !pipelineStatus) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connToUse.openPipeline();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RedisConnection connToExpose = (exposeConnection ? connToUse : createRedisConnectionProxy(connToUse));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行的部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T result = action.doInRedis(connToExpose);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // close pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pipeline &amp;&amp; !pipelineStatus) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connToUse.closePipeline();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO: any other connection processing?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return postProcessResult(result, connToUse, existingConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 释放连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RedisConnectionUtils.releaseConnection(conn, factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>主要有三步操作:</p><ol><li>通过RedisConnectionUtils.getConnection(factory)来获取连接，底层是通过connectionFactory.getConnection()来获取连接的；</li><li>action.doInRedis：执行操作;</li><li>使用<code>RedisConnectionUtils.releaseConnection</code>方法释放连接</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-data-redis使用lettuce中假的pipeline的方法">spring-data-redis使用lettuce中假的pipeline的方法<a href="#spring-data-redis使用lettuce中假的pipeline的方法" class="hash-link" aria-label="spring-data-redis使用lettuce中假的pipeline的方法的直接链接" title="spring-data-redis使用lettuce中假的pipeline的方法的直接链接">​</a></h2><p>看完了上面的内容，就能知道其实解决办法很简单：获取原生的lettuce连接、获取<code>RedisClusterAsyncCommands</code>对象，然后用原生的操作pipeline的方法来处理，继而释放连接即可。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RedisConnectionFactory connectionFactory = redisTemplate.getConnectionFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LettuceConnection connection = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection = (LettuceConnection) RedisConnectionUtils.getConnection(connectionFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //LettuceConnection connection = (LettuceConnection)redisTemplate.getConnectionFactory().getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisClusterAsyncCommands&lt;byte[], byte[]&gt; commands = connection.getNativeConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commands.setAutoFlushCommands(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;RedisFuture&lt;?&gt;&gt; futures = Lists.newArrayList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 50; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        futures.add(commands.set((&quot;aaa-&quot; + i).getBytes(), (&quot;value-&quot; + i).getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        futures.add(commands.expire((&quot;key-&quot; + i).getBytes(), 3600));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write all commands to the transport layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commands.flushCommands();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // synchronization example: Wait until all futures complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean result = LettuceFutures.awaitAll(5, TimeUnit.SECONDS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            futures.toArray(new RedisFuture[futures.size()]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (connection != null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RedisConnectionUtils.releaseConnection(connection,connectionFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的代码中主要包括四步：</p><ul><li>获取LettuceConnection对象，不管是否共享连接，底层实际上也都是从连接池中获取连接的，只是连接之间是否可以共享而已</li><li>获取RedisClusterAsyncCommands，通过connection.getNativeConnection()方法获取</li><li>操作部分：先关掉autoflush，然后将所有的操作加到commands列表中，最后直接flush出去</li><li>释放连接</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="后记">后记<a href="#后记" class="hash-link" aria-label="后记的直接链接" title="后记的直接链接">​</a></h2><p>这里只是略显仓促地对上一篇的文章进行一个补充，如果能给你带来一些帮助，不甚荣幸！</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/middleware/redis/Lettuce_pipeline2.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>liuhui</b> <!-- -->于 <b><time datetime="2023-11-14T14:49:43.000Z">2023年11月14日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/light-docusaurus/middleware/redis/Lettuce_pipeline1/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Lettuce_pipeline1</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/light-docusaurus/middleware/redis/Lua-In-Redis/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Lua-In-Redis</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#连接处理" class="table-of-contents__link toc-highlight">连接处理</a></li><li><a href="#连接池" class="table-of-contents__link toc-highlight">连接池</a><ul><li><a href="#主要属性" class="table-of-contents__link toc-highlight">主要属性:</a></li><li><a href="#主要方法" class="table-of-contents__link toc-highlight">主要方法:</a></li></ul></li><li><a href="#redistemplate模式下的连接" class="table-of-contents__link toc-highlight">redisTemplate模式下的连接</a></li><li><a href="#spring-data-redis使用lettuce中假的pipeline的方法" class="table-of-contents__link toc-highlight">spring-data-redis使用lettuce中假的pipeline的方法</a></li><li><a href="#后记" class="table-of-contents__link toc-highlight">后记</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/docs/zh-cn/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/light-docusaurus/assets/js/runtime~main.bed3725d.js"></script>
<script src="/light-docusaurus/assets/js/main.25e90a47.js"></script>
</body>
</html>