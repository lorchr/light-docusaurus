<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-middleware docs-version-current docs-doc-page docs-doc-id-compare/Different-Between-Kafka-RabbitMQ-RocketMQ" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Different-Between-Kafka-RabbitMQ-RocketMQ | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" property="og:title" content="Different-Between-Kafka-RabbitMQ-RocketMQ | Light Docusaurus"><meta data-rh="true" name="description" content="- 横贯八方揭秘RabbitMQ、RocketMQ、Kafka 的核心原理"><meta data-rh="true" property="og:description" content="- 横贯八方揭秘RabbitMQ、RocketMQ、Kafka 的核心原理"><link data-rh="true" rel="icon" href="/light-docusaurus/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/light-docusaurus/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/light-docusaurus/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/light-docusaurus/opensearch.xml"><link rel="stylesheet" href="/light-docusaurus/assets/css/styles.609e5209.css">
<script src="/light-docusaurus/assets/js/runtime~main.e1ee5690.js" defer="defer"></script>
<script src="/light-docusaurus/assets/js/main.689ca179.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/light-docusaurus/"><div class="navbar__logo"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/light-docusaurus/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/light-docusaurus/blog/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/light-docusaurus/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/light-docusaurus/electron/">Electron</a><a class="navbar__item navbar__link" href="/light-docusaurus/postman/">Postman</a><a class="navbar__item navbar__link" href="/light-docusaurus/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/light-docusaurus/middleware/">MiddleWare</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/light-docusaurus/middleware/category/compare/">Compare</a><button aria-label="折叠侧边栏分类 &#x27;Compare&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ/">Different-Between-Kafka-RabbitMQ-RocketMQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/compare/Different-Between-Hazelcast-Redis/">Different-Between-Hazelcast-Redis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/compare/Different-Between-ES-Clickhouse/">Different-Between-ES-Clickhouse</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/compare/Different-Between-Kafka-RabbitMQ-RocketMQ-Pulasr/">Different-Between-Kafka-RabbitMQ-RocketMQ-Pulasr</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/light-docusaurus/middleware/compare/Different-Between-LVS-Nginx/">Different-Between-LVS-Nginx</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/mysql/">Mysql</a><button aria-label="展开侧边栏分类 &#x27;Mysql&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/postgresql/">Postgresql</a><button aria-label="展开侧边栏分类 &#x27;Postgresql&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/redis/">Redis</a><button aria-label="展开侧边栏分类 &#x27;Redis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/nginx/">Nginx</a><button aria-label="展开侧边栏分类 &#x27;Nginx&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/mqtt/">MQTT</a><button aria-label="展开侧边栏分类 &#x27;MQTT&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/influxdb/">InfluxDB</a><button aria-label="展开侧边栏分类 &#x27;InfluxDB&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/kafka/">Kafka</a><button aria-label="展开侧边栏分类 &#x27;Kafka&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/rocketmq/">RocketMQ</a><button aria-label="展开侧边栏分类 &#x27;RocketMQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/workflow/">Workflow</a><button aria-label="展开侧边栏分类 &#x27;Workflow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/plusar/">Plusar</a><button aria-label="展开侧边栏分类 &#x27;Plusar&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/light-docusaurus/middleware/category/shardingsphere/">ShardingSphere</a><button aria-label="展开侧边栏分类 &#x27;ShardingSphere&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/light-docusaurus/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/light-docusaurus/middleware/category/compare/"><span itemprop="name">Compare</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Different-Between-Kafka-RabbitMQ-RocketMQ</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><ul>
<li><a href="https://mp.weixin.qq.com/s/Pn_D6mv47zd7KxSr1Fs6cQ">横贯八方揭秘RabbitMQ、RocketMQ、Kafka 的核心原理</a></li>
</ul>
<p>今天我们通过一篇文章来认识一下常见消息队列RabbitMQ、RocketMQ、Kafka。</p>
<h1 id="rabbitmq">RabbitMQ</h1>
<h2 id="rabbitmq各组件的功能">RabbitMQ各组件的功能</h2>
<ul>
<li>Broker ：一个RabbitMQ实例就是一个Broker</li>
<li>Virtual Host ：虚拟主机。<code>相当于MySQL的DataBase</code>，一个Broker上可以存在多个vhost，vhost之间相互隔离。每个vhost都拥有自己的队列、交换机、绑定和权限机制。vhost必须在连接时指定，默认的vhost是/。</li>
<li>Exchange ：交换机，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。</li>
<li>Queue ：消息队列，用来保存消息直到发送给消费者。它是消息的容器。一个消息可投入一个或多个队列。</li>
<li>Banding ：绑定关系，用于<code>消息队列和交换机之间的关联</code>。通过路由键（<code>Routing Key</code>）将交换机和消息队列关联起来。</li>
<li>Channel ：管道，一条双向数据流通道。不管是发布消息、订阅队列还是接收消息，这些动作都是通过管道完成。因为对于操作系统来说，建立和销毁TCP都是非常昂贵的开销，所以引入了管道的概念，以复用一条TCP连接。</li>
<li>Connection ：生产者/消费者 与broker之间的TCP连接。</li>
<li>Publisher ：消息的生产者。</li>
<li>Consumer ：消息的消费者。</li>
<li>Message ：消息，它是由消息头和消息体组成。消息头则包括<code>Routing-Key</code>、<code>Priority</code>（优先级）等。</li>
</ul>
<p><img alt="img" src="/light-docusaurus/assets/images/rabbitmq-1-c8b08e5e294d0e340415dabd8c39ba00.jpg" width="640" height="169"></p>
<h2 id="rabbitmq的多种交换机类型">RabbitMQ的多种交换机类型</h2>
<p>Exchange 分发消息给 Queue 时， Exchange 的类型对应不同的分发策略，有3种类型的 Exchange ：<code>Direct</code>、<code>Fanout</code>、<code>Topic</code>。</p>
<ul>
<li>Direct：消息中的 Routing Key 如果和 Binding 中的 Routing Key 完全一致， Exchange 就会将消息分发到对应的队列中。</li>
<li>Fanout：每个发到 Fanout 类型交换机的消息都会分发到所有绑定的队列上去。Fanout交换机没有 Routing Key 。<code>它在三种类型的交换机中转发消息是最快的</code>。</li>
<li>Topic：Topic交换机通过模式匹配分配消息，将 Routing Key 和某个模式进行匹配。它只能识别两个<code>通配符</code>：&quot;#&quot;和&quot;*&quot;。# 匹配0个或多个单词， * 匹配1个单词。</li>
</ul>
<h2 id="ttl">TTL</h2>
<p>TTL（Time To Live）：生存时间。RabbitMQ支持消息的过期时间，一共2种。</p>
<ul>
<li><code>在消息发送时进行指定</code>。通过配置消息体的 Properties ，可以指定当前消息的过期时间。</li>
<li><code>在创建Exchange时指定</code>。从进入消息队列开始计算，只要超过了队列的超时时间配置，那么消息会自动清除。</li>
</ul>
<h2 id="生产者的消息确认机制">生产者的消息确认机制</h2>
<p>Confirm机制：</p>
<ul>
<li>消息的确认，是指生产者投递消息后，如果Broker收到消息，则会给我们生产者一个应答。</li>
<li>生产者进行接受应答，用来确认这条消息是否正常的发送到了Broker，这种方式也  是消息的<code>可靠性投递的核心保障</code>！</li>
</ul>
<p>如何实现Confirm确认消息？</p>
<p><img alt="img" src="/light-docusaurus/assets/images/rabbitmq-2-1528636495556be56ae3cc31b0421f49.jpg" width="640" height="334"></p>
<ul>
<li><code>在channel上开启确认模式</code>：<code>channel.confirmSelect()</code></li>
<li><code>在channel上开启监听</code>：<code>addConfirmListener</code> ，监听成功和失败的处理结果，根据具体的结果对消息进行重新发送或记录日志处理等后续操作。</li>
</ul>
<h2 id="return消息机制">Return消息机制：</h2>
<p>Return Listener用于<code>处理一些不可路由的消息</code>。</p>
<p>我们的消息生产者，通过指定一个<code>Exchange</code>和<code>Routing</code>，把消息送达到某一个队列中去，然后我们的消费者监听队列进行消息的消费处理操作。</p>
<p>但是在某些情况下，如果我们在发送消息的时候，当前的exchange不存在或者指定的路由key路由不到，这个时候我们需要监听这种不可达消息，就需要使用到Returrn Listener。</p>
<p>基础API中有个关键的配置项 Mandatory ：如果为true，监听器会收到路由不可达的消息，然后进行处理。如果为false，broker端会自动删除该消息。</p>
<p>同样，通过监听的方式， <code>chennel.addReturnListener(ReturnListener rl)</code> 传入已经重写过<code>handleReturn</code>方法的<code>ReturnListener</code>。</p>
<h2 id="消费端ack与nack">消费端ACK与NACK</h2>
<p>消费端进行消费的时候，如果由于业务异常可以进行日志的记录，然后进行补偿。但是对于服务器宕机等严重问题，我们需要<code>手动ACK</code>保障消费端消费成功。</p>
<pre><code class="language-java">// deliveryTag：消息在mq中的唯一标识

// multiple：是否批量(和qos设置类似的参数)

// requeue：是否需要重回队列。或者丢弃或者重回队首再次消费。

public void basicNack(long deliveryTag, boolean multiple, boolean requeue) 
</code></pre>
<p>如上代码，消息在<code>消费端重回队列</code>是为了对没有成功处理消息，把消息重新返回到Broker。一般来说，实际应用中都会关闭重回队列（<code>避免进入死循环</code>），也就是设置为false。</p>
<h2 id="死信队列dlx">死信队列DLX</h2>
<p>死信队列（DLX Dead-Letter-Exchange）：当消息在一个队列中变成死信之后，它会被重新推送到另一个队列，这个队列就是死信队列。</p>
<p>DLX也是一个正常的Exchange，和一般的Exchange没有区别，它能在任何的队列上被指定，实际上就是设置某个队列的属性。</p>
<p>当这个队列中有死信时，RabbitMQ就会自动的将这个消息重新发布到设置的Exchange上去，进而被路由到另一个队列。</p>
<h1 id="rocketmq">RocketMQ</h1>
<p>阿里巴巴双十一官方指定消息产品，支撑阿里巴巴集团所有的消息服务，历经十余年高可用与高可靠的严苛考验，是阿里巴巴交易链路的核心产品。</p>
<p>Rocket：火箭的意思。</p>
<p><img alt="img" src="/light-docusaurus/assets/images/rocketmq-1-32a80f83a7d496a36d0e28e6a25a0895.png" width="1080" height="620"></p>
<h2 id="rocketmq的核心概念">RocketMQ的核心概念</h2>
<p>他有以下核心概念：<code>Broker</code> 、 <code>Topic</code> 、 <code>Tag</code> 、 <code>MessageQueue</code> 、 <code>NameServer</code> 、 <code>Group</code> 、 <code>Offset</code> 、 <code>Producer</code> 以及 <code>Consumer</code> 。</p>
<p>下面来详细介绍。</p>
<ol>
<li>Broker：消息中转角色，负责<strong>存储消息</strong>，转发消息。</li>
</ol>
<p>Broker是具体提供业务的服务器，单个Broker节点与所有的NameServer节点保持长连接及心跳，并会定时将Topic信息注册到NameServer，顺带一提底层的通信和连接都是<strong>基于Netty实现</strong>的。
Broker负责消息存储，以Topic为纬度支持轻量级的队列，单机可以支撑上万队列规模，支持消息推拉模型。官网上有数据显示：具有<strong>上亿级消息堆积能力</strong>，同时可<strong>严格保证消息的有序性</strong>。</p>
<ol start="2">
<li>Topic：主题！它是消息的第一级类型。</li>
</ol>
<p>比如一个电商系统可以分为：交易消息、物流消息等，一条消息必须有一个 Topic 。Topic与生产者和消费者的关系非常松散，一个 Topic 可以有0个、1个、多个生产者向其发送消息，一个生产者也可以同时向不同的 Topic 发送消息。一个 Topic 也可以被 0个、1个、多个消费者订阅。</p>
<ol start="3">
<li>Tag：标签！可以看作子主题，它是消息的第二级类型，用于为用户提供额外的灵活性。</li>
</ol>
<p>使用标签，同一业务模块不同目的的消息就可以用相同Topic而不同的Tag来标识。比如交易消息又可以分为：交易创建消息、交易完成消息等，一条消息可以没有Tag。标签有助于保持您的代码干净和连贯，并且还可以为RabbitMQ提供的查询系统提供帮助。</p>
<ol start="4">
<li>
<p>MessageQueue：一个Topic下可以设置多个消息队列，发送消息时执行该消息的Topic，RocketMQ会轮询该Topic下的所有队列将消息发出去。消息的物理管理单位。一个Topic下可以有多个Queue，Queue的引入使得消息的存储可以分布式集群化，具有了水平扩展能力。</p>
</li>
<li>
<p>NameServer：类似Kafka中的ZooKeeper，但NameServer<strong>集群之间是没有通信</strong>的，相对ZK来说更加<strong>轻量</strong>。</p>
</li>
</ol>
<p>它主要负责对于源数据的管理，包括了对于Topic和路由信息的管理。每个Broker在启动的时候会到NameServer注册，Producer在发送消息前会根据Topic去NameServer<strong>获取对应Broker的路由信息</strong>，Consumer也会定时获取 Topic 的路由信息。</p>
<ol start="6">
<li>Producer：生产者，支持三种方 式发送消息：同步、异步和单向。</li>
</ol>
<ul>
<li>单向发送 ：消息发出去后，可以继续发送下一条消息或执行业务代码，不等待服务器回应，且<strong>没有回调函数</strong>。</li>
<li>异步发送 ：消息发出去后，可以继续发送下一条消息或执行业务代码，不等待服务器回应，有<strong>回调函数</strong>。</li>
<li>同步发送 ：消息发出去后，等待服务器响应成功或失败，才能继续后面的操作。</li>
</ul>
<ol start="7">
<li>Consumer：消费者，支持 PUSH 和 PULL 两种消费模式，支持集群消费和广播消费</li>
</ol>
<ul>
<li>集群消费 ：该模式下一个消费者集群共同消费一个主题的多个队列，一个队列只会被一个消费者消费，如果某个消费者挂掉，分组内其它消费者会接替挂掉的消费者继续消费。</li>
<li>广播消费 ：会发给消费者组中的每一个消费者进行消费。相当于RabbitMQ的发布订阅模式。</li>
</ul>
<ol start="8">
<li>Group：分组，一个组可以订阅多个Topic。</li>
</ol>
<p>分为ProducerGroup，ConsumerGroup，代表某一类的生产者和消费者，一般来说同一个服务可以作为Group，同一个Group一般来说发送和消费的消息都是一样的</p>
<ol start="9">
<li>Offset：在RocketMQ中，所有消息队列都是持久化，长度无限的数据结构，所谓长度无限是指队列中的每个存储单元都是定长，访问其中的存储单元使用Offset来访问，Offset为Java Long类型，64位，理论上在 100年内不会溢出，所以认为是长度无限。也可以认为Message Queue是一个长度无限的数组，Offset就是下标。</li>
</ol>
<h2 id="延时消息">延时消息</h2>
<p>开源版的RocketMQ不支持任意时间精度，仅支持特定的level，例如定时5s，10s，1min等。其中，level=0级表示不延时，level=1表示1级延时，level=2表示2级延时，以此类推。</p>
<p>延时等级如下：</p>
<pre><code class="language-java">messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
</code></pre>
<h2 id="顺序消息">顺序消息</h2>
<p>消息有序指的是可以按照消息的发送顺序来消费（FIFO）。RocketMQ可以严格的保证消息有序，可以分为 <code>分区有序</code> 或者 <code>全局有序</code> 。</p>
<h2 id="事务消息">事务消息</h2>
<p><img alt="img" src="/light-docusaurus/assets/images/rocketmq-2-826afd255d2538852624b4f8d3f124b8.png" width="1080" height="449"></p>
<p>消息队列MQ提供类似X/Open XA的分布式事务功能，通过消息队列MQ事务消息能达到分布式事务的最终一致。上图说明了事务消息的大致流程：正常事务消息的发送和提交、事务消息的补偿流程。</p>
<p>事务消息发送及提交：</p>
<ul>
<li>发送half消息</li>
<li>服务端响应消息写入结果</li>
<li>根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）；</li>
<li>根据本地事务状态执行Commit或Rollback（Commit操作生成消息索引，消息对消费者可见）。</li>
</ul>
<p>事务消息的补偿流程：</p>
<ul>
<li>对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次“回查”；</li>
<li>Producer收到回查消息，检查回查消息对应的本地事务的状态。</li>
<li>根据本地事务状态，重新Commit或RollBack</li>
</ul>
<p>其中，补偿阶段用于解决消息Commit或Rollback发生超时或者失败的情况。</p>
<p>事务消息状态：</p>
<p>事务消息共有三种状态：<code>提交状态</code>、<code>回滚状态</code>、<code>中间状态</code>：</p>
<ul>
<li>TransactionStatus.CommitTransaction：提交事务，它允许消费者消费此消息。</li>
<li>TransactionStatus.RollbackTransaction：回滚事务，它代表该消息将被删除，不允许被消费。</li>
<li>TransactionStatus.Unkonwn：中间状态，它代表需要检查消息队列来确定消  息状态。</li>
</ul>
<h2 id="rocketmq的高可用机制">RocketMQ的高可用机制</h2>
<p>‍RocketMQ是天生支持分布式的，可以配置主从以及水平扩展。</p>
<p>Master角色的Broker支持读和写，Slave角色的Broker仅支持读，也就是 Producer只能和Master角色的Broker连接写入消息；Consumer可以连接 Master角色的Broker，也可以连接Slave角色的Broker来读取消息。</p>
<h3 id="消息消费的高可用主从">消息消费的高可用（主从）：</h3>
<p>在Consumer的配置文件中，并不需要设置是从Master读还是从Slave读，当Master不可用或者繁忙的时候，Consumer会被自动切换到从Slave读。有了自动切换Consumer这种机制，当一个Master角色的机器出现故障后，Consumer仍然可以从Slave读取消息，不影响Consumer程序。</p>
<blockquote>
<p>在4.5版本之前如果Master节点挂了，Slave节点是不能自动切换成master节点的这个时候需要手动停止Slave角色的Broker，更改配置文件，用新的配置文件启动Broker。但是在4.5之后，RocketMQ引入了Dledger同步机制，这个时候如果Master节点挂了，Dledger会通过Raft协议选举出新的master节点，不需要手动修改配置。</p>
</blockquote>
<h3 id="消息发送高可用配置多个主节点">消息发送高可用（配置多个主节点）：</h3>
<p>在创建Topic的时候，把Topic的多个Message Queue创建在多个Broker组上（相同Broker名称，不同 brokerId的机器组成一个Broker组），这样当一个Broker组的Master不可用后，其他组的Master仍然可用，Producer仍然可以发送消息。</p>
<h3 id="主从复制">主从复制：</h3>
<p>如果一个Broker组有Master和Slave，消息需要从Master复制到Slave 上，有同步和异步两种复制方式。</p>
<ul>
<li>同步复制：同步复制方式是等Master和Slave均写成功后才反馈给客户端写成功状态。如果Master出故障， Slave上有全部的备份数据，容易恢复同步复制会增大数据写入延迟，降低系统吞吐量。</li>
<li>异步复制：异步复制方式是只要Master写成功 即可反馈给客户端写成功状态。在异步复制方式下，系统拥有较低的延迟和较高的吞吐量，但是如果Master出了故障，有些数据因为没有被写 入Slave，有可能会丢失</li>
</ul>
<p>通常情况下，应该把Master和Slave配置成同步刷盘方式，主从之间配置成异步的复制方式，这样即使有一台机器出故障，仍然能保证数据不丢，是个不错的选择。</p>
<h2 id="负载均衡">负载均衡</h2>
<h3 id="producer负载均衡">Producer负载均衡：</h3>
<p>Producer端，每个实例在发消息的时候，默认会<strong>轮询所有的Message Queue发送</strong>，以达到让消息平均落在不同的Queue上。而由于Queue可以散落在不同的Broker，所以消息就发送到不同的Broker下，如下图：</p>
<p><img alt="img" src="/light-docusaurus/assets/images/rocketmq-3-ec227041a49697b3752a7d28d6fe001e.jpg" width="640" height="296"></p>
<h3 id="consumer负载均衡">Consumer负载均衡：</h3>
<p>如果Consumer实例的数量比Message Queue的总数量还多的话，<strong>多出来的Consumer实例将无法分到Queue</strong>，也就无法消费到消息，也就无法起到分摊负载的作用了。所以需要控制让Queue的总数量大于等于Consumer的数量。</p>
<ul>
<li>消费者的集群模式：启动多个消费者就可以保证消费者的负载均衡（均摊队列）</li>
<li><strong>默认使用的是均摊队列</strong>：会按照Queue的数量和实例的数量平均分配Queue给每个实例，这样每个消费者可以均摊消费的队列，如下图所示6个队列和三个生产者。</li>
<li>另外一种平均的算法<strong>环状轮流分Queue</strong>的形式，每个消费者，均摊不同主节点的一个消息队列，如下图所示：</li>
</ul>
<p>对于广播模式并不是负载均衡的，要求一条消息需要投递到一个消费组下面所有的消费者实例，所以也就没有消息被分摊消费的说法。</p>
<h2 id="死信队列">死信队列</h2>
<p>当一条消息消费失败，RocketMQ就会自动进行消息重试。而如果消息超过最大重试次数，RocketMQ就会认为这个消息有问题。但是此时，RocketMQ不会立刻将这个有问题的消息丢弃，而会将其发送到这个消费者组对应的一种特殊队列：死信队列。死信队列的名称是 <code>%DLQ%+ConsumGroup</code> 。</p>
<p>死信队列具有以下特性：</p>
<ul>
<li>一个死信队列对应一个Group ID， 而不是对应单个消费者实例。</li>
<li>如果一个Group ID未产生死信消息，消息队列RocketMQ不会为其创建相应的死信队列。</li>
<li>一个死信队列包含了对应Group ID产生的所有死信消息，不论该消息属于哪个Topic。</li>
</ul>
<h1 id="kafka">Kafka</h1>
<p>Kafka是一个分布式、支持分区的、多副本的，<strong>基于ZooKeeper协调</strong>的分布式消息系统。</p>
<blockquote>
<p>新版Kafka已经不再需要ZooKeeper。</p>
</blockquote>
<p>它最大的特性就是可以实时的处理大量数据以满足各种需求场景：比如基于Hadoop的批处理系统、低延迟的实时系统、Storm/Spark流式处理引擎，Web/Nginx日志、访问日志，消息服务等等，用<strong>Scala语言编写</strong>。属于Apache基金会的顶级开源项目。</p>
<p>先看一下Kafka的架构图 ：</p>
<p><img alt="img" src="/light-docusaurus/assets/images/kafka-1-560407c03bb3e7c20bbfc0a64b19b8b0.png" width="1080" height="589"></p>
<h2 id="kafka的核心概念">Kafka的核心概念</h2>
<p>在Kafka中有几个核心概念：</p>
<ul>
<li>Broker：消息中间件处理节点，一个Kafka节点就是一个Broker，一个或者多个Broker可以组成一个Kafka集群</li>
<li>Topic：Kafka根据topic对消息进行归类，发布到Kafka集群的每条消息都需要指定一个topic</li>
<li>Producer：消息生产者，向Broker发送消息的客户端</li>
<li>Consumer：消息消费者，从Broker读取消息的客户端</li>
<li>ConsumerGroup：每个Consumer属于一个特定的ConsumerGroup，一条消息可以被多个不同的ConsumerGroup消费，但是一个ConsumerGroup中只能有一个- Consumer能够消费该消息</li>
<li>Partition：物理上的概念，一个topic可以分为多个partition，每个partition内部消息是有序的</li>
<li>Leader：每个Partition有多个副本，其中有且仅有一个作为Leader，Leader是负责数据读写的Partition。</li>
<li>Follower：Follower跟随Leader，所有写请求都通过Leader路由，数据变更会广播给所有Follower，Follower与Leader保持数据同步。如果Leader失效，则从Follower中选举出一个新的Leader。当Follower与Leader挂掉、卡住或者同步太慢，Leader会把这个Follower从 ISR列表 中删除，重新创建一个Follower。</li>
<li>Offset：偏移量。Kafka的存储文件都是按照offset.kafka来命名，用Offset做名字的好处是方便查找。例如你想找位于2049的位置，只要找到2048.kafka的文件即可。</li>
</ul>
<p>可以这么来理解Topic，Partition和Broker：</p>
<p>一个Topic，代表逻辑上的一个业务数据集，比如订单相关操作消息放入订单Topic，用户相关操作消息放入用户Topic，对于大型网站来说，后端数据都是海量的，订单消息很可能是非常巨量的，比如有几百个G甚至达到TB级别，如果把这么多数据都放在一台机器上可定会有容量限制问题，那么就可以在Topic内部划分多个Partition来分片存储数据，不同的Partition可以位于不同的机器上，<strong>相当于分布式存储</strong>。每台机器上都运行一个Kafka的进程Broker。</p>
<h2 id="kafka核心总控制器controller">Kafka核心总控制器Controller</h2>
<p>在Kafka集群中会有一个或者多个Broker，其中有一个Broker会被选举为控制器（Kafka Controller），可以理解为 Broker-Leader ，它负责管理整个 集群中  所有分区和副本的状态。</p>
<pre><code>Partition-Leader
</code></pre>
<h3 id="controller选举机制">Controller选举机制</h3>
<p>在Kafka集群启动的时候，选举的过程是集群中每个Broker都会尝试在ZooKeeper上创建一个 /controller临时节点，ZooKeeper会保证有且仅有一个Broker能创建成功，这个Broker就会成为集群的总控器Controller。</p>
<p>当这个Controller角色的Broker宕机了，此时ZooKeeper临时节点会消失，集群里其他Broker会一直监听这个临时节 点，发现临时节点消失了，就竞争再次创建临时节点，就是我们上面说的选举机制，ZooKeeper又会保证有一个Broker成为新的Controller。具备控制器身份的Broker需要比其他普通的Broker多一份职责，具体细节如下：</p>
<ul>
<li><strong>监听Broker相关的变化</strong>。为ZooKeeper中的/brokers/ids/节点添加BrokerChangeListener，用来处理Broker增减的变化。</li>
<li><strong>监听Topic相关的变化</strong>。为ZooKeeper中的/brokers/topics节点添加TopicChangeListener，用来处理Topic增减的变化；为ZooKeeper中的/admin/delete_topics节点添加TopicDeletionListener，用来处理删除Topic的动作。</li>
<li>从ZooKeeper中读取获取当前所有与Topic、Partition以及Broker有关的信息并进行相应的管理 。对于所有Topic所对应的ZooKeeper中的/brokers/topics/节点添加PartitionModificationsListener，用来监听Topic中的分区分配变化。</li>
<li><strong>更新集群的元数据信息，同步到其他普通的Broker节点中</strong></li>
</ul>
<h3 id="partition副本选举leader机制">Partition副本选举Leader机制</h3>
<p>Controller感知到分区Leader所在的Broker挂了，Controller会从<strong>ISR列表</strong>（参数<code>unclean.leader.election.enable=false</code>的前提下）里挑第一个Broker作为Leader（第一个Broker最先放进ISR列表，可能是同步数据最多的副本），如果参数<code>unclean.leader.election.enable</code>为true，代表在ISR列表里所有副本都挂了的时候可以在ISR列表以外的副本中选Leader，这种设置，可以提高可用性，但是选出的新Leader有可能数据少很多。副本进入ISR列表有两个条件：</p>
<ul>
<li>副本节点不能产生分区，必须能与ZooKeeper保持会话以及跟Leader副本网络连通</li>
<li>副本能复制Leader上的所有写操作，并且不能落后太多。（与Leader副本同步滞后的副本，是由replica.lag.time.max.ms配置决定的，超过这个时间都没有跟Leader同步过的一次的副本会被移出ISR列表）</li>
</ul>
<h3 id="消费者消费消息的offset记录机制">消费者消费消息的Offset记录机制</h3>
<p>每个Consumer会定期将自己消费分区的Offset提交给Kafka内部Topic：consumer_offsets，提交过去的时候，key是consumerGroupId+topic+分区号，value就是当前Offset的值，Kafka会定期清理Topic里的消息，最后就保留最新的那条数据。</p>
<p>因为__consumer_offsets可能会接收高并发的请求，Kafka默认给其分配50个分区（可以通过offsets.topic.num.partitions设置），这样可以通过加机器的方式抗大并发。</p>
<h2 id="消费者rebalance机制">消费者Rebalance机制</h2>
<p>Rebalance就是说 如果消费组里的消费者数量有变化或消费的分区数有变化，Kafka会重新分配消费者与消费分区的关系 。比如consumer group中某个消费者挂了，此时会自动把分配给他的分区交给其他的消费者，如果他又重启了，那么又会把一些分区重新交还给他。</p>
<p>注意：Rebalance只针对subscribe这种不指定分区消费的情况，如果通过assign这种消费方式指定了分区，Kafka不会进行Rebalance。</p>
<p>如下情况可能会触发消费者Rebalance：</p>
<ul>
<li>消费组里的Consumer增加或减少了</li>
<li>动态给Topic增加了分区</li>
<li>消费组订阅了更多的Topic</li>
</ul>
<p>Rebalance过程中，消费者无法从Kafka消费消息，这对Kafka的TPS会有影响，如果Kafka集群内节点较多，比如数百 个，那重平衡可能会耗时极多，所以应尽量避免在系统高峰期的重平衡发生。</p>
<h3 id="rebalance过程如下">Rebalance过程如下</h3>
<p>当有消费者加入消费组时，消费者、消费组及组协调器之间会经历以下几个阶段：</p>
<p><img alt="img" src="/light-docusaurus/assets/images/kafka-2-e55e1eb4bd986dec50bda6294879b2e6.png" width="1080" height="482"></p>
<h4 id="第一阶段选择组协调器">第一阶段：选择组协调器</h4>
<ul>
<li>组协调器<code>GroupCoordinator</code>：每个<code>consumer group</code>都会选择一个Broker作为自己的组协调器<code>coordinator</code>，负责监控这个消费组里的所有消费者的心跳，以及判断是否宕机，然后开启消费者Rebalance。<code>consumer group</code>中的每个<code>consumer</code>启动时会向Kafka集群中的某个节点发送<code>FindCoordinatorRequest</code>请求来查找对应的组协调器<code>GroupCoordinator</code>，并跟其建立网络连接。</li>
<li>组协调器选择方式：通过如下公式可以选出consumer消费的Offset要提交到<code>__consumer_offsets</code>的哪个分区，这个分区Leader对应的Broker就是这个consumer group的coordinator公式：</li>
</ul>
<pre><code class="language-shell">hash(consumer group id) % 对应主题的分区数
</code></pre>
<h4 id="第二阶段加入消费组join-group">第二阶段：加入消费组JOIN GROUP</h4>
<p>在成功找到消费组所对应的<code>GroupCoordinator</code>之后就进入加入消费组的阶段，在此阶段的消费者会向<code>GroupCoordinator</code>发送<code>JoinGroupRequest</code>请求，并处理响应。</p>
<p>然后<code>GroupCoordinator</code>从一个<code>consumer group</code>中选择第一个加入group的consumer作为Leader（消费组协调器），把<code>consumer group</code>情况发送给这个Leader，接着这个Leader会负责制定分区方案。</p>
<h4 id="第三阶段sync-group">第三阶段（SYNC GROUP）</h4>
<p>consumer leader通过给<code>GroupCoordinator</code>发送<code>SyncGroupRequest</code>，接着<code>GroupCoordinator</code>就把分区方案下发给各个consumer，他们会根据指定分区的Leader Broker进行网络连接以及消息消费。</p>
<h3 id="消费者rebalance分区分配策略">消费者Rebalance分区分配策略</h3>
<p>主要有三种Rebalance的策略：<code>range</code> 、 <code>round-robin</code> 、 <code>sticky</code> 。默认情况为<code>range</code>分配策略。</p>
<p>假设一个主题有10个分区（0-9），现在有三个consumer消费：</p>
<ul>
<li>
<p>range策略：按照分区序号排序分配 ，假设<code>n＝分区数／消费者数量 = 3</code>， <code>m＝分区数%消费者数量 = 1</code>，那么前 m 个消 费者每个分配 n+1 个分区，后面的（消费者数量－m ）个消费者每个分配 n 个分区。比如分区0~ 3给一个consumer，分区4~ 6给一个consumer，分区7~9给一个consumer。</p>
</li>
<li>
<p>round-robin策略：轮询分配 ，比如分区0、3、6、9给一个consumer，分区1、4、7给一个consumer，分区2、5、 8给一个consumer</p>
</li>
<li>
<p>sticky策略：初始时分配策略与round-robin类似，但是在rebalance的时候，需要保证如下两个原则：</p>
</li>
<li>
<p>分区的分配要尽可能均匀 。</p>
</li>
<li>
<p>分区的分配尽可能与上次分配的保持相同。</p>
</li>
</ul>
<p>当两者发生冲突时，第一个目标优先于第二个目标 。这样可以最大程度维持原来的分区分配的策略。</p>
<p>比如对于第一种range情况的分配，如果第三个consumer挂了，那么重新用sticky策略分配的结果如下：consumer1除了原有的0~ 3，会再分配一个7 consumer2除了原有的4~ 6，会再分配8和9。</p>
<h2 id="producer发布消息机制剖析">Producer发布消息机制剖析</h2>
<h3 id="1写入方式">1、写入方式</h3>
<p>producer采用push模式将消 息发布到broker，每条消息都被append到patition中，属于顺序写磁盘（<strong>顺序写磁盘 比 随机写 效率要高，保障 kafka 吞吐率</strong>）。</p>
<h3 id="2消息路由">2、消息路由</h3>
<p>producer发送消息到broker时，会根据分区算法选择将其存储到哪一个partition。其路由机制为：</p>
<pre><code class="language-shell">hash(key)%分区数
</code></pre>
<h3 id="3写入流程">3、写入流程</h3>
<p><img alt="img" src="/light-docusaurus/assets/images/kafka-3-c198b3b1572aebe4edda1f91b0a2d1b1.png" width="1080" height="889"></p>
<ul>
<li>producer先从ZooKeeper的 <code>/brokers/…/state</code> 节点找到该partition的leader</li>
<li>producer将消息发送给该leader</li>
<li>leader将消息写入本地log</li>
<li>followers从leader pull消息，写入本地log后向leader发送ACK</li>
<li>leader收到所有ISR中的replica的ACK后，增加HW（high watermark，最后commit的offset）并向producer发送ACK</li>
</ul>
<h2 id="hw与leo">HW与LEO</h2>
<p>HW俗称高水位 ，<code>HighWatermark</code>的缩写，取一个partition对应的ISR中最小的<code>LEO（log-end-offset）</code>作为HW， consumer最多只能消费到HW所在的位置。另外每个replica都有HW，leader和follower各自负责更新自己的HW的状态。</p>
<p>对于leader新写入的消息，consumer不能立刻消费，leader会等待该消息被所有ISR中的replicas同步后更新HW，此时消息才能被consumer消费。这样就保证了如果leader所在的broker失效，该消息仍然可以从新选举的leader中获取。对于来自内部broker的读取请求，没有HW的限制。</p>
<h2 id="日志分段存储">日志分段存储</h2>
<p>Kafka一个分区的消息数据对应存储在一个文件夹下，以<code>topic名称+分区号</code>命名，消息在分区内是分段存储的， 每个段的消息都存储在不一样的log文件里，Kafka规定了一个段位的log文件<strong>最大为1G</strong>，做这个限制目的是为了方便把log文件加载到内存去操作：</p>
<pre><code class="language-shell">1 ### 部分消息的offset索引文件，kafka每次往分区发4K(可配置)消息就会记录一条当前消息的offset到index文件， 

2 ### 如果要定位消息的offset会先在这个文件里快速定位，再去log文件里找具体消息 

3 00000000000000000000.index 

4 ### 消息存储文件，主要存offset和消息体 

5 00000000000000000000.log 

6 ### 消息的发送时间索引文件，kafka每次往分区发4K(可配置)消息就会记录一条当前消息的发送时间戳与对应的offset到timeindex文件， 

7 ### 如果需要按照时间来定位消息的offset，会先在这个文件里查找 

8 00000000000000000000.timeindex 

9 

10 00000000000005367851.index 

11 00000000000005367851.log 

12 00000000000005367851.timeindex 

13 

14 00000000000009936472.index 

15 00000000000009936472.log 

16 00000000000009936472.timeindex
</code></pre>
<p>这个9936472之类的数字，就是代表了这个日志段文件里包含的起始 Offset，也就说明这个分区里至少都写入了接近1000万条数据了。Kafka Broker有一个参数，<code>log.segment.bytes</code>，限定了每个日志段文件的大小，最大就是1GB。</p>
<p>一个日志段文件满了，就自动开一个新的日志段文件来写入，避免单个文件过大，影响文件的读写性能，这个过程叫做<code>log rolling</code>，正在被写入的那个日志段文件，叫做<code>active log segment</code>。</p>
<p>最后附一张ZooKeeper节点数据图</p>
<p><img alt="img" src="/light-docusaurus/assets/images/kafka-4-1564c2e88877267aca76ee909c673680.jpg" width="640" height="364"></p>
<h1 id="mq带来的一些问题及解决方案">MQ带来的一些问题、及解决方案</h1>
<h2 id="如何保证顺序消费">如何保证顺序消费？</h2>
<h3 id="rabbitmq一个queue对应一个consumer即可解决">RabbitMQ：一个Queue对应一个Consumer即可解决。</h3>
<h3 id="rocketmqhashkey队列数">RocketMQ ：hash(key)%队列数</h3>
<h3 id="kafkahashkey分区数">Kafka：hash(key)%分区数</h3>
<h2 id="如何实现延迟消费">如何实现延迟消费？</h2>
<h3 id="rabbitmq两种方案死信队列--ttl引入rabbitmq的延迟插件">RabbitMQ：两种方案死信队列 + TTL引入RabbitMQ的延迟插件</h3>
<h3 id="rocketmq天生支持延时消息">RocketMQ：天生支持延时消息。</h3>
<h3 id="kafka步骤如下">Kafka：步骤如下</h3>
<p>专门为要延迟的消息创建一个Topic新建一个消费者去消费这个Topic消息持久化再开一个线程定时去拉取持久化的消息，放入实际要消费的Topic实际消费的消费者从实际要消费的Topic拉取消息。</p>
<p><img alt="img" src="/light-docusaurus/assets/images/kafka-5-35379db40b7ee53eca32ec0f88d52752.png" width="1080" height="334"></p>
<h2 id="如何保证消息的可靠性投递">如何保证消息的可靠性投递</h2>
<h3 id="rabbitmq-1">RabbitMQ：</h3>
<ul>
<li>Broker --&gt; 消费者：手动ACK</li>
<li>生产者 --&gt; Broker：两种方案</li>
</ul>
<ol>
<li>数据库持久化：</li>
</ol>
<pre><code class="language-shell">1. 将业务订单数据和生成的Message进行持久化操作（一般情况下插入数据库，这里如果分库的话可能涉及到分布式事务）

2. 将Message发送到Broker服务器中

3. 通过RabbitMQ的Confirm机制，在producer端，监听服务器是否ACK。

4. 如果ACK了，就将Message这条数据状态更新为已发送。如果失败，修改为失败状态。

5. 分布式定时任务查询数据库3分钟（这个具体时间应该根据的时效性来定）之前的发送失败的消息

6. 重新发送消息，记录发送次数

7. 如果发送次数过多仍然失败，那么就需要人工排查之类的操作。
</code></pre>
<p><img alt="img" src="/light-docusaurus/assets/images/rabbitmq-3-48b10ea5889239c23fc46ec315e2eddb.png" width="1080" height="769"></p>
<ul>
<li>优点：能够保证消息百分百不丢失。</li>
<li>缺点：第一步会涉及  到分布式事务问题。</li>
</ul>
<ol start="2">
<li>消息的延迟投递：</li>
</ol>
<p>流程图中，颜色不同的代表不同的message</p>
<pre><code class="language-shell">1.将业务订单持久化

2.发送一条Message到broker(称之为主Message)，再发送相同的一条到不同的队列或者交换机(这条称为确认Message)中。

3.主Message由实际业务处理端消费后，生成一条响应Message。之前的确认Message由Message Service应用处理入库。

4~6.实际业务处理端发送的确认Message由Message Service接收后，将原Message状态修改。

7.如果该条Message没有被确认，则通过rpc调用重新由producer进行全过程。
</code></pre>
<p><img alt="img" src="data:image/jpeg;base64,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" width="640" height="212"></p>
<ul>
<li>优点：相对于持久化方案来说响应速度有所提升</li>
<li>缺点：系统复杂性有点高，万一两条消息都失败了，消息存在丢失情况，仍需Confirm机制做补偿。</li>
</ul>
<h3 id="rocketmq-1">RocketMQ</h3>
<ol>
<li>生产者弄丢数据：</li>
</ol>
<p>Producer在把Message发送Broker的过程中，因为网络问题等发生丢失，或者Message到了Broker，但是出了问题，没有保存下来。针对这个问题，RocketMQ对Producer发送消息设置了3种方式：</p>
<ul>
<li>同步发送</li>
<li>异步发送</li>
<li>单向发送</li>
</ul>
<ol start="2">
<li>Broker弄丢数据：</li>
</ol>
<p>Broker接收到Message暂存到内存，Consumer还没来得及消费，Broker挂掉了。</p>
<p>可以通过 持久化 设置去解决：</p>
<ul>
<li>创建Queue的时候设置持久化，保证Broker持久化Queue的元数据，但是不会持久化Queue里面的消息</li>
<li>将Message的deliveryMode设置为2，可以将消息持久化到磁盘，这样只有Message支持化到磁盘之后才会发送通知Producer ack</li>
</ul>
<p>这两步过后，即使Broker挂了，Producer肯定收不到ack的，就可以进行重发。</p>
<ol start="3">
<li>消费者弄丢数据：</li>
</ol>
<p>Consumer有消费到Message，但是内部出现问题，Message还没处理，Broker以为Consumer处理完了，只会把后续的消息发送。这时候，就要 关闭autoack，消息处理过后，进行手动ack , 多次消费失败的消息，会进入 死信队列 ，这时候需要人工干预。</p>
<h3 id="kafka-1">Kafka</h3>
<ol>
<li>生产者弄丢数据</li>
</ol>
<p>设置了 <code>acks=all</code> ，一定不会丢，要求是，你的 leader 接收到消息，所有的 follower 都同步到了消息之后，才认为本次写成功了。如果没满足这个条件，生产者会自动不断的重试，重试无限次。</p>
<ol start="2">
<li>Broker弄丢数据</li>
</ol>
<p>Kafka 某个 broker 宕机，然后重新 选举 <code>partition</code> 的 leader。大家想想，要是此时其他的 follower 刚好还有些数据没有同步，结果此时 leader 挂了，然后选举某个 follower 成 leader 之后，不就少了一些数据？这就丢了一些数据啊。</p>
<p>此时一般是要求起码设置如下 4 个参数：</p>
<pre><code class="language-shell">replication.factor
min.insync.replicas
acks=all
retries=MAX
</code></pre>
<p>我们生产环境就是按照上述要求配置的，这样配置之后，至少在 Kafka broker 端就可以保证在 leader 所在 broker 发生故障，进行 leader 切换时，数据不会丢失。</p>
<ol start="3">
<li>消费者弄丢数据</li>
</ol>
<p>你消费到了这个消息，然后消费者那边自动提交了 offset，让 Kafka 以为你已经消费好了这个消息，但其实你才刚准备处理这个消息，你还没处理，你自己就挂了，此时这条消息就丢咯。</p>
<p>这不是跟 RabbitMQ 差不多吗，大家都知道 Kafka 会自动提交 offset，那么只要 关闭自动提交 offset，在处理完之后自己手动提交 offset，就可以保证数据不会丢。但是此时确实还是可能会有重复消费，比如你刚处理完，还没提交 offset，结果自己挂了，此时肯定会重复消费一次，自己保证幂等性就好了。</p>
<h2 id="如何保证消息的幂等">如何保证消息的幂等？</h2>
<p>以 RocketMQ 为例，下面列出了消息重复的场景：</p>
<ol>
<li>发送时消息重复</li>
</ol>
<p>当一条消息已被成功发送到服务端并完成持久化，此时出现了网络闪断或者客户端宕机，导致服务端对客户端应答失败。如果此时生产者意识到消息发送失败并尝试再次发送消息，消费者后续会收到两条内容相同并且Message ID也相同的消息。</p>
<ol start="2">
<li>投递时消息重复</li>
</ol>
<p>消息消费的场景下，消息已投递到消费者并完成业务处理，当客户端给服务端反馈应答的时候网络闪断。 为了保证消息至少被消费一次，消息队列RocketMQ版的服务端将在网络恢复后再次尝试投递之前已被处理过的消息，消费者后续会收到两条内容相同并且Message ID也相同的消息。</p>
<ol start="3">
<li>负载均衡时消息重复（包括但不限于网络抖动、Broker重启以及消费者应用重启）</li>
</ol>
<p>当消息队列RocketMQ版的Broker或客户端重启、扩容或缩容时，会触发Rebalance，此时消费者可能会收到重复消息。</p>
<p>那么，有什么解决方案呢？直接上图。</p>
<p><img alt="img" src="/light-docusaurus/assets/images/repeat-message-a77d0cf9d7a87c06fc852826391d2a1f.jpg" width="640" height="716"></p>
<h2 id="如何解决消息积压的问题">如何解决消息积压的问题？</h2>
<p>关于这个问题，有几个点需要考虑：</p>
<ol>
<li>如何快速让积压的消息被消费掉？</li>
</ol>
<p>临时写一个消息分发的消费者，把积压队列里的消息均匀分发到N个队列中，同时一个队列对应一个消费者，相当于消费速度提高了N倍。</p>
<p>修改前：</p>
<p><img alt="img" src="/light-docusaurus/assets/images/message-consume-1-84f12dd961e4943af9fba539122e98ca.jpg" width="640" height="363">
修改后：</p>
<p><img alt="img" src="/light-docusaurus/assets/images/message-consume-2-0f110c666ae5c653f36047c326f223fb.jpg" width="640" height="435"></p>
<ol start="2">
<li>积压时间太久，导致部分消息过期，怎么处理？</li>
</ol>
<p>批量重导。在业务不繁忙的时候，比如凌晨，提前准备好程序，把丢失的那批消息查出来，重新导入到MQ中。</p>
<p>消息大量积压，MQ磁盘被写满了，导致新消息进不来了，丢掉了大量消息，怎么处理？</p>
<p>这个没办法。谁让【消息分发的消费者】写的太慢了，你临时写程序，接入数据来消费，消费一个丢弃一个，都不要了，快速消费掉所有的消息。然后走第二个方案，到了晚上再补数据吧。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/middleware/compare/1-Different-Between-Kafka-RabbitMQ-RocketMQ.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>Lorchr</b> <!-- -->于 <b><time datetime="2024-02-23T07:27:41.000Z">2024年2月23日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/light-docusaurus/middleware/category/compare/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Compare</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/light-docusaurus/middleware/compare/Different-Between-Hazelcast-Redis/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Different-Between-Hazelcast-Redis</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#rabbitmq各组件的功能" class="table-of-contents__link toc-highlight">RabbitMQ各组件的功能</a></li><li><a href="#rabbitmq的多种交换机类型" class="table-of-contents__link toc-highlight">RabbitMQ的多种交换机类型</a></li><li><a href="#ttl" class="table-of-contents__link toc-highlight">TTL</a></li><li><a href="#生产者的消息确认机制" class="table-of-contents__link toc-highlight">生产者的消息确认机制</a></li><li><a href="#return消息机制" class="table-of-contents__link toc-highlight">Return消息机制：</a></li><li><a href="#消费端ack与nack" class="table-of-contents__link toc-highlight">消费端ACK与NACK</a></li><li><a href="#死信队列dlx" class="table-of-contents__link toc-highlight">死信队列DLX</a></li><li><a href="#rocketmq的核心概念" class="table-of-contents__link toc-highlight">RocketMQ的核心概念</a></li><li><a href="#延时消息" class="table-of-contents__link toc-highlight">延时消息</a></li><li><a href="#顺序消息" class="table-of-contents__link toc-highlight">顺序消息</a></li><li><a href="#事务消息" class="table-of-contents__link toc-highlight">事务消息</a></li><li><a href="#rocketmq的高可用机制" class="table-of-contents__link toc-highlight">RocketMQ的高可用机制</a><ul><li><a href="#消息消费的高可用主从" class="table-of-contents__link toc-highlight">消息消费的高可用（主从）：</a></li><li><a href="#消息发送高可用配置多个主节点" class="table-of-contents__link toc-highlight">消息发送高可用（配置多个主节点）：</a></li><li><a href="#主从复制" class="table-of-contents__link toc-highlight">主从复制：</a></li></ul></li><li><a href="#负载均衡" class="table-of-contents__link toc-highlight">负载均衡</a><ul><li><a href="#producer负载均衡" class="table-of-contents__link toc-highlight">Producer负载均衡：</a></li><li><a href="#consumer负载均衡" class="table-of-contents__link toc-highlight">Consumer负载均衡：</a></li></ul></li><li><a href="#死信队列" class="table-of-contents__link toc-highlight">死信队列</a></li><li><a href="#kafka的核心概念" class="table-of-contents__link toc-highlight">Kafka的核心概念</a></li><li><a href="#kafka核心总控制器controller" class="table-of-contents__link toc-highlight">Kafka核心总控制器Controller</a><ul><li><a href="#controller选举机制" class="table-of-contents__link toc-highlight">Controller选举机制</a></li><li><a href="#partition副本选举leader机制" class="table-of-contents__link toc-highlight">Partition副本选举Leader机制</a></li><li><a href="#消费者消费消息的offset记录机制" class="table-of-contents__link toc-highlight">消费者消费消息的Offset记录机制</a></li></ul></li><li><a href="#消费者rebalance机制" class="table-of-contents__link toc-highlight">消费者Rebalance机制</a><ul><li><a href="#rebalance过程如下" class="table-of-contents__link toc-highlight">Rebalance过程如下</a></li><li><a href="#消费者rebalance分区分配策略" class="table-of-contents__link toc-highlight">消费者Rebalance分区分配策略</a></li></ul></li><li><a href="#producer发布消息机制剖析" class="table-of-contents__link toc-highlight">Producer发布消息机制剖析</a><ul><li><a href="#1写入方式" class="table-of-contents__link toc-highlight">1、写入方式</a></li><li><a href="#2消息路由" class="table-of-contents__link toc-highlight">2、消息路由</a></li><li><a href="#3写入流程" class="table-of-contents__link toc-highlight">3、写入流程</a></li></ul></li><li><a href="#hw与leo" class="table-of-contents__link toc-highlight">HW与LEO</a></li><li><a href="#日志分段存储" class="table-of-contents__link toc-highlight">日志分段存储</a></li><li><a href="#如何保证顺序消费" class="table-of-contents__link toc-highlight">如何保证顺序消费？</a><ul><li><a href="#rabbitmq一个queue对应一个consumer即可解决" class="table-of-contents__link toc-highlight">RabbitMQ：一个Queue对应一个Consumer即可解决。</a></li><li><a href="#rocketmqhashkey队列数" class="table-of-contents__link toc-highlight">RocketMQ：hash(key)%队列数</a></li><li><a href="#kafkahashkey分区数" class="table-of-contents__link toc-highlight">Kafka：hash(key)%分区数</a></li></ul></li><li><a href="#如何实现延迟消费" class="table-of-contents__link toc-highlight">如何实现延迟消费？</a><ul><li><a href="#rabbitmq两种方案死信队列--ttl引入rabbitmq的延迟插件" class="table-of-contents__link toc-highlight">RabbitMQ：两种方案死信队列 + TTL引入RabbitMQ的延迟插件</a></li><li><a href="#rocketmq天生支持延时消息" class="table-of-contents__link toc-highlight">RocketMQ：天生支持延时消息。</a></li><li><a href="#kafka步骤如下" class="table-of-contents__link toc-highlight">Kafka：步骤如下</a></li></ul></li><li><a href="#如何保证消息的可靠性投递" class="table-of-contents__link toc-highlight">如何保证消息的可靠性投递</a><ul><li><a href="#rabbitmq-1" class="table-of-contents__link toc-highlight">RabbitMQ：</a></li><li><a href="#rocketmq-1" class="table-of-contents__link toc-highlight">RocketMQ</a></li><li><a href="#kafka-1" class="table-of-contents__link toc-highlight">Kafka</a></li></ul></li><li><a href="#如何保证消息的幂等" class="table-of-contents__link toc-highlight">如何保证消息的幂等？</a></li><li><a href="#如何解决消息积压的问题" class="table-of-contents__link toc-highlight">如何解决消息积压的问题？</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>