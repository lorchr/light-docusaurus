<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-middleware docs-version-current docs-doc-page docs-doc-id-elastic/ES-Usage-Advice" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">ES-Usage-Advice | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/light-docusaurus/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/light-docusaurus/middleware/elastic/ES-Usage-Advice/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" property="og:title" content="ES-Usage-Advice | Light Docusaurus"><meta data-rh="true" name="description" content="- 一口气看完43个关于 ElasticSearch 的使用建议"><meta data-rh="true" property="og:description" content="- 一口气看完43个关于 ElasticSearch 的使用建议"><link data-rh="true" rel="icon" href="/light-docusaurus/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/light-docusaurus/middleware/elastic/ES-Usage-Advice/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/middleware/elastic/ES-Usage-Advice/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/light-docusaurus/middleware/elastic/ES-Usage-Advice/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/light-docusaurus/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/light-docusaurus/blog/atom.xml" title="Light Docusaurus Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/light-docusaurus/opensearch.xml"><link rel="stylesheet" href="/light-docusaurus/assets/css/styles.10a62360.css">
<script src="/light-docusaurus/assets/js/runtime~main.018e30f2.js" defer="defer"></script>
<script src="/light-docusaurus/assets/js/main.4b4e5c80.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/light-docusaurus/"><div class="navbar__logo"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/light-docusaurus/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/light-docusaurus/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/light-docusaurus/blog/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/light-docusaurus/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/light-docusaurus/electron/">Electron</a><a class="navbar__item navbar__link" href="/light-docusaurus/postman/">Postman</a><a class="navbar__item navbar__link" href="/light-docusaurus/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/light-docusaurus/middleware/elastic/ES-Usage-Advice/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>ES-Usage-Advice</h1></header><ul>
<li><a href="https://mp.weixin.qq.com/s/7H8kjUcJNoQJRqwJTyfXOw" target="_blank" rel="noopener noreferrer">一口气看完43个关于 ElasticSearch 的使用建议</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一前言">一、前言<a href="#一前言" class="hash-link" aria-label="一、前言的直接链接" title="一、前言的直接链接">​</a></h2>
<p>本文分享了在工作中关于 ElasticSearch 的一些使用建议。和其他更偏向手册化更注重结论的文章不同，本文将一定程度上阐述部分建议背后的原理及使用姿势参考，避免流于表面，只知其然而不知其所以然。如有不当的地方，欢迎指正！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二查询相关">二、查询相关<a href="#二查询相关" class="hash-link" aria-label="二、查询相关的直接链接" title="二、查询相关的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-充分利用缓存">1. 充分利用缓存<a href="#1-充分利用缓存" class="hash-link" aria-label="1. 充分利用缓存的直接链接" title="1. 充分利用缓存的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="分片查询缓存shard-request-cache">分片查询缓存（Shard Request Cache）<a href="#分片查询缓存shard-request-cache" class="hash-link" aria-label="分片查询缓存（Shard Request Cache）的直接链接" title="分片查询缓存（Shard Request Cache）的直接链接">​</a></h4>
<p>ES 层面的缓存实现，封装在 <code>IndicesRequestCache</code> 类中。缓存的 Key 是整个客户端请求，缓存内容为单个分片的查询结果。主要作用是对聚合的缓存，查询结果中被缓存的内容主要包括：<code>Aggregations</code>（聚合结果）、<code>Hits.total</code>、以及 <code>Suggestions</code> 等。</p>
<p>并非所有的分片级查询都会被缓存。只有客户端查询请求中 <code>size=0</code> 的情况下才会被缓存。其他不被缓存的条件还包括 <code>Scroll</code> 、设置了 <code>Profile</code> 属性，查询类型不是 <code>QUERY_THEN_FETCH</code>，以及设置了 <code>requestCache=false</code> 等。另外一些存在不确定性的查询例如：范围查询带有 <code>Now</code>，由于它是毫秒级别的，缓存下来没有意义，类似的还有在脚本查询中使用了 <code>Math.random()</code> 等函数的查询也不会进行缓存。</p>
<p>当有新的 <code>Segment</code> 写入到分片后，缓存会失效，因为之前的缓存结果已经无法代表整个分片的查询结果。所以分片每次 <code>Refresh</code> 之后，缓存会被清除。</p>
<p>节点查询缓存/过滤器缓存 (<code>Node Query Cache /Filter Cache</code>)</p>
<p>Lucene 层面的缓存实现，封装在 <code>LRUQueryCache</code> 类中，默认开启。缓存的是某个 <code>Filter</code> 子查询语句在一个 Segment 上的查询结果。</p>
<p>并非所有的 <code>Filter</code> 查询都会被缓存。对于体积较小的 Segment 不会建立 <code>Query Cache</code>，因为他们很快会被合并。<code>Segment</code> 的 <code>Doc</code> 数量需要大于 <code>10000</code>，并且占整个分片的 3% 以上才会走 <code>Cache</code> 策略（参考：缓存）。</p>
<p>当 <code>Segment</code> 合并的时候，被删除的 <code>Segment</code> 其关联 <code>Cache</code> 会失效。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-使用过滤器上下文filter替代查询上下文query">1. 使用过滤器上下文（<code>Filter</code>）替代查询上下文（<code>Query</code>）。<a href="#1-使用过滤器上下文filter替代查询上下文query" class="hash-link" aria-label="1-使用过滤器上下文filter替代查询上下文query的直接链接" title="1-使用过滤器上下文filter替代查询上下文query的直接链接">​</a></h4>
<ul>
<li>
<p><code>Filter</code> 不会进行打分操作，而 <code>Must</code> 会。</p>
</li>
<li>
<p><code>Filter</code> 查询可以被缓存，从而提高查询性能。</p>
</li>
</ul>
<p>正例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  // 创建BoolQueryBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建过滤器上下文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolQuery.filter(QueryBuilders.termQuery(&quot;field&quot;, &quot;value&quot;));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  // 创建BoolQueryBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建查询上下文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolQuery.must(QueryBuilders.termQuery(&quot;field1&quot;, &quot;value1&quot;));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-只关注聚合结果而不关注文档细节时size-设置为-0-利用分片查询缓存">2. 只关注聚合结果而不关注文档细节时，<code>Size</code> 设置为 0 利用分片查询缓存。<a href="#2-只关注聚合结果而不关注文档细节时size-设置为-0-利用分片查询缓存" class="hash-link" aria-label="2-只关注聚合结果而不关注文档细节时size-设置为-0-利用分片查询缓存的直接链接" title="2-只关注聚合结果而不关注文档细节时size-设置为-0-利用分片查询缓存的直接链接">​</a></h4>
<p>参考示例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 添加聚合查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sourceBuilder.aggregation(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AggregationBuilders.terms(&quot;term_agg&quot;).field(&quot;field&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .subAggregation(AggregationBuilders.sum(&quot;sum_agg&quot;).field(&quot;field&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置size为0，只返回聚合结果而不返回文档</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sourceBuilder.size(0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-日期范围查询使用绝对时间值">3. 日期范围查询使用绝对时间值。<a href="#3-日期范围查询使用绝对时间值" class="hash-link" aria-label="3. 日期范围查询使用绝对时间值。的直接链接" title="3. 日期范围查询使用绝对时间值。的直接链接">​</a></h4>
<p>日期字段上使用 <code>Now</code>，一般来说不会被缓存，因为匹配到的时间一直在变化。因此， 可以从业务的角度来考虑是否一定要用 <code>Now</code>，尽量使用绝对时间值，不需要解析相对时间表达式且利用 <code>Query Cache</code> 能够提高查询效率。例如时间范围查询中使用 <code>Now/h</code>，使用小时级别的单位，可以让缓存在 1 小时内都可能被访问到。</p>
<p>正例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取当前日期并格式化为绝对时间值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDateTime now = LocalDateTime.now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DateTimeFormatter formatter = DateTimeFormatter.ISO_DATE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String currentDate = now.format(formatter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建日期范围查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.query(QueryBuilders.rangeQuery(&quot;date_field&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .gte(&quot;2022-01-01&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .lte(currentDate));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建日期范围查询，使用相对时间值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.query(QueryBuilders.rangeQuery(&quot;date_field&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .gte(&quot;now-7d&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .lte(&quot;now&quot;));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-聚合查询">2. 聚合查询<a href="#2-聚合查询" class="hash-link" aria-label="2. 聚合查询的直接链接" title="2. 聚合查询的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-避免多层聚合嵌套查询">4. 避免多层聚合嵌套查询。<a href="#4-避免多层聚合嵌套查询" class="hash-link" aria-label="4. 避免多层聚合嵌套查询。的直接链接" title="4. 避免多层聚合嵌套查询。的直接链接">​</a></h4>
<p>聚合查询的中间结果和最终结果都会在内存中进行，嵌套过多，会导致内存耗尽。</p>
<p>如：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建主要查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建第一层聚合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TermsAggregationBuilder termAggBuilder1 = AggregationBuilders.terms(&quot;term_agg1&quot;).field(&quot;field_name1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建第二层聚合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TermsAggregationBuilder termAggBuilder2 = AggregationBuilders.terms(&quot;term_agg2&quot;).field(&quot;field_name2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        termAggBuilder1.subAggregation(termAggBuilder2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建第三层聚合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TermsAggregationBuilder termAggBuilder3 = AggregationBuilders.terms(&quot;term_agg3&quot;).field(&quot;field_name3&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        termAggBuilder2.subAggregation(termAggBuilder3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.aggregation(termAggBuilder1);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-嵌套查询建议使用-composite-聚合查询方式">5. 嵌套查询建议使用 Composite 聚合查询方式。<a href="#5-嵌套查询建议使用-composite-聚合查询方式" class="hash-link" aria-label="5. 嵌套查询建议使用 Composite 聚合查询方式。的直接链接" title="5. 嵌套查询建议使用 Composite 聚合查询方式。的直接链接">​</a></h4>
<p>对于常见的 <code>Group by A,B,C</code> 这种多维度 <code>Group by</code> 查询，嵌套聚合的性能很差，嵌套聚合被设计为在每个桶内进行指标计算，对于平铺的 Group by 来说有存在很多冗余计算，另外在 Meta 字段上的序列化反序列化代价也非常大，这类 <code>Group by</code> 替换为 <code>Composite</code> 可以将查询速度提升 2 倍左右。</p>
<p>正例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> // 创建Composite Aggregation构建器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompositeAggregationBuilder compositeAggregationBuilder = AggregationBuilders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .composite(&quot;group_by_A_B_C&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sources(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        AggregationBuilders.terms(&quot;group_by_A&quot;).field(&quot;fieldA.keyword&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        AggregationBuilders.terms(&quot;group_by_B&quot;).field(&quot;fieldB.keyword&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        AggregationBuilders.terms(&quot;group_by_C&quot;).field(&quot;fieldC.keyword&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建查询条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .query(QueryBuilders.matchAllQuery())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .aggregation(compositeAggregationBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .size(0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> // 创建Terms Aggregation构建器，按照字段A分组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TermsAggregationBuilder termsAggregationA = AggregationBuilders.terms(&quot;group_by_A&quot;).field(&quot;fieldA.keyword&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在字段A的基础上创建Terms Aggregation构建器，按照字段B分组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TermsAggregationBuilder termsAggregationB = AggregationBuilders.terms(&quot;group_by_B&quot;).field(&quot;fieldB.keyword&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在字段B的基础上创建Terms Aggregation构建器，按照字段C分组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TermsAggregationBuilder termsAggregationC = AggregationBuilders.terms(&quot;group_by_C&quot;).field(&quot;fieldC.keyword&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将字段C的聚合添加到字段B的聚合中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        termsAggregationB.subAggregation(termsAggregationC);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将字段B的聚合添加到字段A的聚合中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        termsAggregationA.subAggregation(termsAggregationB);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建查询条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .query(QueryBuilders.matchAllQuery())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .aggregation(termsAggregationA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .size(0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-避免大聚合查询">6. 避免大聚合查询。<a href="#6-避免大聚合查询" class="hash-link" aria-label="6. 避免大聚合查询。的直接链接" title="6. 避免大聚合查询。的直接链接">​</a></h4>
<p>聚合查询的中间结果和最终结果都会在内存中进行，数据量太大会导致内存耗尽。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-高基数场景嵌套聚合查询建议使用-bfs-搜索">7. 高基数场景嵌套聚合查询建议使用 BFS 搜索。<a href="#7-高基数场景嵌套聚合查询建议使用-bfs-搜索" class="hash-link" aria-label="7. 高基数场景嵌套聚合查询建议使用 BFS 搜索。的直接链接" title="7. 高基数场景嵌套聚合查询建议使用 BFS 搜索。的直接链接">​</a></h4>
<p>聚合是在 ES 内存完成的。当一个聚合操作包含了嵌套的聚合操作时，每个嵌套的聚合操作都会使用上一级聚合操作中构建出的桶作为输入，然后根据自己的聚合条件再进行桶的进一步分组。这样对于每一层嵌套，都会再  次动态构建一组新的聚合桶。在高基数场景，嵌套聚合操作会导致聚合桶数量随着嵌套层数的增加指数级增长，最终结果就是占用 ES 大量内存，从而导致 OOM 的情况发生。</p>
<p>默认情况下，ES 使用 DFS（深度优先）搜索。深度优先先构建完整的树，然后修剪无用节点。BFS（广度优先）先执行第一层聚合，再继续下一层聚合之前会先做修剪。</p>
<p>在聚合查询中，使用广度优先算法需要在每个桶级别上缓存文档数据，然后在剪枝阶段后向子聚合重放这些文档。因此，广度优先算法的内存消耗取决于每个桶中的文档数量。对于许多聚合查询，每个桶中的文档数量都非常大，聚合可能会有数千或数十万个文档。</p>
<p>但是，有大量桶但每个桶中文档数量相对较少的情况下，使用广度优先算法能更加高效地利用内存资源，而且可以让我们构建更加复杂的聚合查询。虽然可能会产生大量的桶，但每个桶中只有相对较少的文档，因此使用广度优先搜索算法可以更加节约内存。</p>
<p>参考示例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">searchSourceBuilder.aggregation(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AggregationBuilders.terms(&quot;brandIds&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collectMode(Aggregator.SubAggCollectionMode.BREADTH_FIRST)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .field(&quot;brandId&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .size(2000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .order(BucketOrder.key(true))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="8-避免对-text-字段类型使用聚合查询">8. 避免对 text 字段类型使用聚合查询。<a href="#8-避免对-text-字段类型使用聚合查询" class="hash-link" aria-label="8. 避免对 text 字段类型使用聚合查询。的直接链接" title="8. 避免对 text 字段类型使用聚合查询。的直接链接">​</a></h4>
<ul>
<li>text 的 <code>Fielddata</code> 会加大对内存的占用，如有需求使用，建议使用 Keyword。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="9-不建议使用-bucket_sort-进行聚合深分页查询">9. 不建议使用 bucket_sort 进行聚合深分页查询。<a href="#9-不建议使用-bucket_sort-进行聚合深分页查询" class="hash-link" aria-label="9. 不建议使用 bucket_sort 进行聚合深分页查询。的直接链接" title="9. 不建议使用 bucket_sort 进行聚合深分页查询。的直接链接">​</a></h4>
<p>ES 的高 <code>Cardinality</code> 聚合查询非常消耗内存，超过百万基数的聚合很容易导致节点内存不够用以至 OOM。</p>
<p><code>bucket_sort</code> 使用桶排序算法，性能问题主要是由于它需要在内存中缓存所有的文档和聚合桶，然后才能进行排序和分页，随着文档数量增多和分页深度增加，性能会逐渐变差，有深分页问题。因为桶排序需要对所有文档进行整体排序，所以它的时间复杂度是 <code>O(NlogN)</code>，其中 N 是文档总数。</p>
<p>目前Elasticsearch支持聚合分页（滚动聚合）的目前只有复合聚合(<code>Composite Aggregation</code>)一种。滚动的方式类似于<code>SearchAfter</code>。聚合时指定一个复合键，然后每个分片都按照这个复合键进行排序和聚合，不需要在内存中缓存所有文档和桶，而是可以每次返回一页的数据。</p>
<p>反例：使用 <code>bucket_sort</code> 深分页 RT 达到 <code>5000ms+</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  boolQuery.filter(QueryBuilders.termQuery(EsNewApplyDocumentFields.IS_DEL, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TermsAggregationBuilder termsAggregationBuilder = AggregationBuilders.terms(&quot;spuIdAgg&quot;).field(&quot;spuId&quot;).order(BucketOrder.key(false)).size(pageNum*pageSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  termsAggregationBuilder.subAggregation(new BucketSortPipelineAggregationBuilder(&quot;spuBucket&quot;,null).from((pageNum-1)*pageSize).size(pageSize));  searchSourceBuilder.query(boolQuery).aggregation(termsAggregationBuilder).size(0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>正例：使用 <code>Composite Aggregation</code> 优化后深分页查询：423ms</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolQuery.filter(QueryBuilders.termQuery(EsNewApplyDocumentFields.IS_DEL, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompositeAggregationBuilder compositeBuilder = new CompositeAggregationBuilder(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;spuIdAgg&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(new TermsValuesSourceBuilder(&quot;spuId&quot;).field(&quot;spuId&quot;).order(&quot;desc&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ).aggregateAfter(ImmutableMap.of(&quot;spuId&quot;, &quot;603030&quot;)).size(20);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        searchSourceBuilder.query(boolQuery).aggregation(compositeBuilder).aggregation(totalAgg).size(0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-分页">3. 分页<a href="#3-分页" class="hash-link" aria-label="3. 分页的直接链接" title="3. 分页的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10-避免使用-fromsize-方式">10. 避免使用 <code>from+size</code> 方式。<a href="#10-避免使用-fromsize-方式" class="hash-link" aria-label="10-避免使用-fromsize-方式的直接链接" title="10-避免使用-fromsize-方式的直接链接">​</a></h4>
<p>ES 中深度翻页排序的花费会随着分页的深度而成倍增长，分页搜索不会单独 <code>Cache</code>。每次分页的请求都是一次重新搜索的过程，而不是从第一次搜索的结果中获取。如果数据特别大对 CPU 和内存的消耗会非常巨大甚至会导致 OOM。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="11-避免高实时性大结果集场景使用-scroll-方式">11. 避免高实时性&amp;大结果集场景使用 <code>Scroll</code> 方式。<a href="#11-避免高实时性大结果集场景使用-scroll-方式" class="hash-link" aria-label="11-避免高实时性大结果集场景使用-scroll-方式的直接链接" title="11-避免高实时性大结果集场景使用-scroll-方式的直接链接">​</a></h4>
<p>基于快照的上下文。实时性高的业务场景不建议使用。大结果集场景将生成大量Scroll 上下文，可能导致内存消耗过大，建议使用 <code>SearcheAfter</code> 方式。</p>
<p>思考：对于 <code>Scroll</code> 和 <code>SearchAfter</code> 的选用怎么看？两者分别适用于哪种场景？<code>SearchAfter</code> 可以完全替代 <code>Scroll</code> 吗？</p>
<p><code>Scroll</code> 维护一份当前索引段的快照，适用于非实时滚动遍历全量数据查询，但大量<code>Contexts</code> 占用堆内存的代价较高；7.10 引入的新特性 <code>Search After + PIT</code>，查询本质是利用前向页面的一组排序之检索匹配下一页，从而保证数据一致性；8.10 官方文档明确指出不再建议使用 <code>Scroll API</code> 进行深分页。如果分页检索超过 <code>Top10000+</code> 推荐使用 <code>PIT + Search After</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="12-searchafter-分页scroll-id-遍历索引中的数据指定-sort-字段要保证唯一性否则会造成分页遍历数据不完整或重复">12. <code>SearchAfter</code> 分页<code>/Scroll ID/</code> 遍历索引中的数据指定 <code>Sort</code> 字段要保证唯一性，否则会造成分页/遍历数据不完整或重复。<a href="#12-searchafter-分页scroll-id-遍历索引中的数据指定-sort-字段要保证唯一性否则会造成分页遍历数据不完整或重复" class="hash-link" aria-label="12-searchafter-分页scroll-id-遍历索引中的数据指定-sort-字段要保证唯一性否则会造成分页遍历数据不完整或重复的直接链接" title="12-searchafter-分页scroll-id-遍历索引中的数据指定-sort-字段要保证唯一性否则会造成分页遍历数据不完整或重复的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="13-建议指定业务字段排序不要采用默认打分排序">13. 建议指定业务字段排序，不要采用默认打分排序。<a href="#13-建议指定业务字段排序不要采用默认打分排序" class="hash-link" aria-label="13. 建议指定业务字段排序，不要采用默认打分排序。的直接链接" title="13. 建议指定业务字段排序，不要采用默认打分排序。的直接链接">​</a></h4>
<p>ES 默认使用<code>_score</code>字段按评分排序。如在使用 <code>Scroll API</code> 获取数据时，如果没有特殊的排序需求，推荐使用<code>&quot;sort&quot;:&quot;_doc&quot;</code>让 ES 按索引顺序返回命中文档，可以节省排序开销。原因如下：</p>
<ul>
<li>使用非文档 ID 排序，会导致每次查询 ES 需要在每个分片记住上次返回的最后一个文档，然后下次查询中会对之前已经返回的文档进行忽略过滤，同时在协调节点进行排序操作。文档 ID 排序则不需要上述操作。</li>
</ul>
<blockquote>
<p>The way sorted scroll works s that elasticsearch remembers the last returned document on everyshard. Then when you ask for the next page, all documents that match your query and comparebetter than this last returned document are ignored.
This explains why sorted scroll is less efficient than scan scroll, since scan can just go back towhere it had stopped before, collect $(page_size) documents and return. ln contrast, sorted scrollneeds to visit all matching documents for every page.</p>
</blockquote>
<p>对于文档 ID 排序，ES 内部进行了特殊优化，性能表现更优。</p>
<blockquote>
<p>Scroll requests have optimizations that make them faster when the sort order is_doc , lf you wantto iterate over all documents regardless of the order, this is the most efficient option:</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /_search?scroll=1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;sort&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;_doc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="14-scroll-查询确保显式调用-clearscroll-方法清除-scroll-id">14. <code>Scroll</code> 查询确保显式调用 <code>clearScroll()</code> 方法清除 <code>Scroll ID</code>。<a href="#14-scroll-查询确保显式调用-clearscroll-方法清除-scroll-id" class="hash-link" aria-label="14-scroll-查询确保显式调用-clearscroll-方法清除-scroll-id的直接链接" title="14-scroll-查询确保显式调用-clearscroll-方法清除-scroll-id的直接链接">​</a></h4>
<p>否则会导致 ES 在过期时间前无法释放 <code>Scroll</code> 结果集占用的内存资源，同时也会占用默认 3000 个 <code>Scroll</code> 查询的容量，导致 <code>too many scroll ID</code> 的查询拒绝报错，影响业务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-其他">4. 其他<a href="#4-其他" class="hash-link" aria-label="4. 其他的直接链接" title="4. 其他的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="15-注意-must-和-should-同时出现在语句里的时候should-会失效注意-must-和-should-同时出现在同一层级的-bool-查询时should-查询会失效">15. 注意 <code>Must</code> 和 <code>Should</code> 同时出现在语句里的时候，<code>Should</code> 会失效；注意 <code>Must</code> 和 <code>Should</code> 同时出现在同一层级的 <code>bool</code> <code>查询时，Should</code> 查询会失效。<a href="#15-注意-must-和-should-同时出现在语句里的时候should-会失效注意-must-和-should-同时出现在同一层级的-bool-查询时should-查询会失效" class="hash-link" aria-label="15-注意-must-和-should-同时出现在语句里的时候should-会失效注意-must-和-should-同时出现在同一层级的-bool-查询时should-查询会失效的直接链接" title="15-注意-must-和-should-同时出现在语句里的时候should-会失效注意-must-和-should-同时出现在同一层级的-bool-查询时should-查询会失效的直接链接">​</a></h4>
<p>正例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;query&quot;:{ &quot;bool&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;must&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {&quot;bool&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;must&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;term&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    &quot;status.keyword&quot;:&quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           } }]}},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {&quot;bool&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;should&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            {&quot;term&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    &quot;tag.keyword&quot;:&quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } } ] }}]}}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;query&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;bool&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;must&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;term&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;status.keyword&quot;:&quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }}],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;should&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;term&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;tag.keyword&quot;:&quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }]}}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="16-避免查询-indexname-">16. 避免查询 <code>indexName-*</code>。<a href="#16-避免查询-indexname-" class="hash-link" aria-label="16-避免查询-indexname-的直接链接" title="16-避免查询-indexname-的直接链接">​</a></h4>
<p>因为 Elasticsearch 中的索引名称是全局可见的，可以通过查询所有索引的方式来枚举某个集群中的所有索引名称。可以通过在 Elasticsearch 配置文件中设置 <code>action.destructive_requires_name</code> 参数来禁止查询 <code>indexName-*</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="17-脚本使用-stored-方式避免使用-inline-方式">17. 脚本使用 <code>Stored</code> 方式，避免使用 <code>Inline</code> 方式。<a href="#17-脚本使用-stored-方式避免使用-inline-方式" class="hash-link" aria-label="17-脚本使用-stored-方式避免使用-inline-方式的直接链接" title="17-脚本使用-stored-方式避免使用-inline-方式的直接链接">​</a></h4>
<p>对于固定结构的 <code>Script</code>，使用 <code>Stored</code> 方式，把脚本通过 Kibana 存入 ES 集群，降低重复编译脚本带来的性能损耗。</p>
<p>正例：</p>
<p>第1步：通过<code>stored</code>方式，建script模版：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST _script/activity_discount_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;script&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;lang&quot;:&quot;painless&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;:&quot;doc.xxx.value * params.discount&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>第2步：调用script脚本模版：<code>cal_activity_discount</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET index/_search</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;script_fields&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;discount_price&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;script&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &quot;id&quot;: &quot;activity_discount_price&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &quot;params&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               &quot;discount&quot;: 0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}}}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>反例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//直接inline方式，请求中传入脚本：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET index/_search</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;script_fields&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;activity_discount_price&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;script&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &quot;source&quot;:&quot;doc.xxx.value * 0.8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="18-避免使用-_all-字段">18. 避免使用 <code>_all</code> 字段。<a href="#18-避免使用-_all-字段" class="hash-link" aria-label="18-避免使用-_all-字段的直接链接" title="18-避免使用-_all-字段的直接链接">​</a></h4>
<p><code>_all</code> 字段包含了所有的索引字段，如果没有获取原始文档数据的需求，可通过设置<code>Includes</code>、<code>Excludes</code> 属性来定义放入<code> _source</code> 的字段。<code>_all</code> 默认将写入的字段拼接成一个大的字符串，并对该字段进行分词，用于支持整个 Doc 的全文检索，<code>_all</code>字段在查询时占用更多的 CPU，同时占用更多的磁盘存储空间，默认为 <code>false</code>，不建议开启该字段和使用。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="19-建议用-get-查询替换-search-查询">19. 建议用 Get 查询替换 Search 查询。<a href="#19-建议用-get-查询替换-search-查询" class="hash-link" aria-label="19. 建议用 Get 查询替换 Search 查询。的直接链接" title="19. 建议用 Get 查询替换 Search 查询。的直接链接">​</a></h4>
<p><code>GET/MGET</code> 直接根据文档 <code>ID</code> 从正排索引中获取内容。<code>Search</code> 不指定<code>_id</code>，根据关键词从倒排索引中获取内容。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="20-避免进行多索引查询">20. 避免进行多索引查询。<a href="#20-避免进行多索引查询" class="hash-link" aria-label="20. 避免进行多索引查询。的直接链接" title="20. 避免进行多索引查询。的直接链接">​</a></h4>
<p>反例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /index1,index2,index3/_search</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;query&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;match_all&quot;: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="21-避免单次召回大量数据建议使用-_source_includes-和-_source_excludes-参数来包含或排除字段">21. 避免单次召回大量数据，建议使用 <code>_source_includes</code> 和 <code>_source_excludes</code> 参数来包含或排除字段。<a href="#21-避免单次召回大量数据建议使用-_source_includes-和-_source_excludes-参数来包含或排除字段" class="hash-link" aria-label="21-避免单次召回大量数据建议使用-_source_includes-和-_source_excludes-参数来包含或排除字段的直接链接" title="21-避免单次召回大量数据建 议使用-_source_includes-和-_source_excludes-参数来包含或排除字段的直接链接">​</a></h4>
<p>大型文档尤其有用，部分字段检索可以节省网络开销。</p>
<p>参考示例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 创建SearchSourceBuilder，并设置查询条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置要包含的字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] includes = {&quot;field1&quot;, &quot;field2&quot;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.fetchSource(includes, Strings.EMPTY_ARRAY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置要排除的字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] excludes = {&quot;field3&quot;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceBuilder.fetchSource(Strings.EMPTY_ARRAY, excludes);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="22-避免使用-wildcard-进行中缀模糊查询">22. 避免使用 <code>Wildcard</code> 进行中缀模糊查询。<a href="#22-避免使用-wildcard-进行中缀模糊查询" class="hash-link" aria-label="22-避免使用-wildcard-进行中缀模糊查询的直接链接" title="22-避免使用-wildcard-进行中缀模糊查询的直接链接">​</a></h4>
<p>ES 官方文档并不推荐使用 <code>Wildcard</code> 来进行中缀模糊的查询，原因在于 ES 内部为了加速这种带有通配符查询，会将输入的字符串 <code>Pattern</code> 构建成一个 DFA (<code>Deterministic Finite Automaton</code>)，而带有通配符的 <code>Pattern</code> 构造出来的 DFA 可能会很复杂，开销很大。</p>
<blockquote>
<p><code>wildcard</code> 和 <code>regexp</code> 查询的工作方式与 <code>prefix</code> 查询完全一样，它们也需要扫描倒排索引中的词列表才能找到所有匹配的词，然后依次获取每个词相关的文档ID，与 <code>prefx</code> 查询的唯一不同是:它们能支持更为复杂的匹配模式</p>
<p>这也意味着需要同样注意前缀查询存在性能问题，对有很多唯一词的字段执行这些查询可能会消耗非常多的资源，所以要避免使用左通配这样的模式匹配 (如: <code>*foo</code>或 <code>*foo</code> 这样的正则式)。</p>
<p>数据在索引时的预处理有助于提高前缀匹配的效率，而通配符和正则表达式查询只能在查询时完成，尽管这些查询有其应用场景，但使用仍需谨慎。</p>
</blockquote>
<p>建议使用 ES 官方在 7.9 推出的一种专门用来解决模糊查询慢的 <code>Wildcard</code> 字段类型。与 <code>Text</code> 字段相比，它不会将文本看作是标点符号分割的单词集合；与 <code>Keyword</code> 字段比，它在中缀搜索场景下具有无与伦比的查询速度，且对输入没有大小限制，这是 <code>Keyword</code> 类型无法相比的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="23-避免使用-scripting">23. 避免使用 <code>Scripting</code>。<a href="#23-避免使用-scripting" class="hash-link" aria-label="23-避免使用-scripting的直接链接" title="23-避免使用-scripting的直接链接">​</a></h4>
<p>Painless 脚本语言语法相对简单，灵活度高，安全性高，性能高（相对于其他脚本，但是其性能比 DSL 要低）。不适用于非复杂业务，一般 DSL 能解决大部分的问题，解决不了的用类似 Painless 等脚本语言。主要性能影响如下：单次查询或更新耗时增加，脚本的执行时间相比于其他查询和更新操作可能会更长，因为在执行脚本之前需要对其进行词法分析、语法分析和代码编译等预处理工作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="24-避免使用脚本查询script-query计算动态字段建议在索引时计算并在文档中添加该字段">24. 避免使用脚本查询（<code>Script Query</code>）计算动态字段，建议在索引时计算并在文档中添加该字段。<a href="#24-避免使用脚本查询script-query计算动态字段建议在索引时计算并在文档中添加该字段" class="hash-link" aria-label="24-避免使用脚本查询script-query计算动态字段建议在索引时计算并在文档中添加该字段的直接链接" title="24-避免使用脚本查询script-query计算动态字段建议在索引时计算并在文档中添加该字段的直接链接">​</a></h4>
<p>例如，我们有一个包含大量用户信息的索引，我们需要查询以<code>&quot;1234&quot;</code>开头的所有用户。运行一个脚本查询如<code>&quot;source&quot;: &quot;doc[&#x27;num&#x27;].value.startsWith(&#x27;1234&#x27;)&quot;</code>。这个查询非常耗费资源，索引时考虑添加<code>num_prefix</code>的<code>keyword</code>字段，然后查询<code>&quot;name_prefix&quot;: &quot;1234&quot;</code>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三写入相关">三、写入相关<a href="#三写入相关" class="hash-link" aria-label="三、写入相关的直接链接" title="三、写入相关的直接链接">​</a></h2>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="25-避免代码中或手工直接-refresh-操作">25. 避免代码中或手工直接 <code>Refresh</code> 操作。<a href="#25-避免代码中或手工直接-refresh-操作" class="hash-link" aria-label="25-避免代码中或手工直接-refresh-操作的直接链接" title="25-避免代码中或手工直接-refresh-操作的直接链接">​</a></h4>
<p>合理设置索引 <code>Settings/Refresh_Interval</code> 时间，通过系统完成 <code>Refresh</code> 动作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="26-避免单个文档过大">26. 避免单个文档过大。<a href="#26-避免单个文档过大" class="hash-link" aria-label="26. 避免单个文档过大。的直接链接" title="26. 避免单个文档过大。的直接链接">​</a></h4>
<p>鉴于默认 <code>http.max_content_length</code> 设置为 <code>100MB</code>，Elasticsearch 将拒绝索引任何大于该值的文档。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="27-写入数据不指定-doc_id让-es-自动生成">27. 写入数据不指定 Doc_ID，让 ES 自动生成。<a href="#27-写入数据不指定-doc_id让-es-自动生成" class="hash-link" aria-label="27. 写入数据不指定 Doc_ID，让 ES 自动生成。的直接链接" title="27. 写入数据不指定 Doc_ID，让 ES 自动生成。的直接链接">​</a></h4>
<p>索引具有显式 ID 的文档时 ES 在写入过程中会多一步判断的过程，即检查具有相同ID 的文档是否已经存在于相同的分片中，随着索引增长而变得更加昂贵。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="28-合理使用-bulk-api-批量写">28. 合理使用 <code>Bulk API</code> 批量写。<a href="#28-合理使用-bulk-api-批量写" class="hash-link" aria-label="28-合理使用-bulk-api-批量写的直接链接" title="28-合理使用-bulk-api-批量写的直接链接">​</a></h4>
<p>大数据量写入时可以使用 <code>Bulk</code>，但是请求响应的耗时会增加，即使连接断开，ES 集群内部也仍然在执行。高速大批量数据写入时，可能造成集群短时间内响应缓慢甚至假死的的情况。</p>
<ul>
<li>
<p>可以通过性能测试确定最佳数量，官方建议大约 <code>5-15mb</code>。</p>
</li>
<li>
<p>超时时间需要足够长，建议 <code>60s</code> 以上。</p>
</li>
<li>
<p>写入端尽量将数据轮询打到不同节点上。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="29-脚本刷大量数据写入前调大-refresh-interval不建议将副本分片为-0待写入完成后再调回来">29. 脚本刷大量数据，写入前调大 <code>Refresh Interval</code>，不建议将副本分片为 0，待写入完成后再调回来。<a href="#29-脚本刷大量数据写入前调大-refresh-interval不建议将副本分片为-0待写入完成后再调回来" class="hash-link" aria-label="29-脚本刷大量数据写入前调大-refresh-interval不建议将副本分片为-0待写入完成后再调回来的直接链接" title="29-脚本刷大量数据写入前调大-refresh-interval不建议将副本分片为-0待写入完成后再调回来的直接链接">​</a></h4>
<p>副本分片重新加入节点会触  发副分片恢复 <code>Recovery</code> 流程，如果是大分片会影响集群性能。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四索引创建">四、索引创建<a href="#四索引创建" class="hash-link" aria-label="四、索引创建的直接链接" title="四、索引创建的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-分片">1. 分片<a href="#1-分片" class="hash-link" aria-label="1. 分片的直接链接" title="1. 分片的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="30-副本分片数大于等于-1">30. 副本分片数大于等于 1。<a href="#30-副本分片数大于等于-1" class="hash-link" aria-label="30. 副本分片数大于等于 1。的直接链接" title="30. 副本分片数大于等于 1。的直接链接">​</a></h4>
<p>高可用性保证。增加副本数可以一定程度上提高搜索性能；但会降低写入性能，建议每个主分片对应 1-2 个副本分片即可。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="31-官方建议单分片限制最大数据条数不超过-232---1">31. 官方建议单分片限制最大数据条数不超过 2^32 - 1。<a href="#31-官方建议单分片限制最大数据条数不超过-232---1" class="hash-link" aria-label="31. 官方建议单分片限制最大数据条数不超过 2^32 - 1。的直接链接" title="31. 官方建议单分片限制最大数据条数不超过 2^32 - 1。的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="32-索引主分片数量不要设置过大">32. 索引主分片数量不要设置过大。<a href="#32-索引主分片数量不要设置过大" class="hash-link" aria-label="32. 索引主分片数量不要设置过大。的直接链接" title="32. 索引主分片数量不要设置过大。的直接链接">​</a></h4>
<p>ES 创建好索引后，一般情况下不再动态调整主分片数量。</p>
<p>每个分片本质上就是一个 Lucene 索引，因此会消耗相应的文件句柄、 内存和 CPU 资源。</p>
<p>ES 使用词频统计来计算相关性，当然这些统计也会分配到各个分片上，如果在大量分片上只维护了很少的数据，则将导致最终的文档相关性较差。</p>
<p>一般来说，我们遵循一些原则：</p>
<ol>
<li>
<p>读场景较多则可以设置少一点，写场景则可以设置多一些。</p>
</li>
<li>
<p>控制每个分片占用的硬盘容量不超过ES的最大 JVM 的堆空间设置（32G），因此，如果索引的总容量在 200G 左右，那分片大小在 7-8 个左右即可。</p>
</li>
<li>
<p>考虑一下 Node 数量，一般一个节点对应一台物理机，如果分片数远大于节点数，则一个节点上存在多个分片，一旦该节点故障，即使保持了1个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以， 一般都设置分片数不超过节点数的 3 倍。</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="33-单个分片数据量不要超过-50gb">33. 单个分片数据量不要超过 50GB。<a href="#33-单个分片数据量不要超过-50gb" class="hash-link" aria-label="33. 单个分片数据量不要超过 50GB。的直接链接" title="33. 单个分片数据量不要超过 50GB。的直接链接">​</a></h4>
<p>单个索引的规模控制在 1TB 以内，单个分片大小控制在 30 ~ 50GB ，Docs 数控制在 10 亿内，如果超过建议滚动。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-mapping设计">2. Mapping设计<a href="#2-mapping设计" class="hash-link" aria-label="2. Mapping设计的直接链接" title="2. Mapping设计的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="34-避免使用字段动态映射功能指定具体字段类型子类型若需要分词器特别有场景需要">34. 避免使用字段动态映射功能，指定具体字段类型，子类型（若需要），分词器（特别有场景需要）。<a href="#34-避免使用字段动态映射功能指定具体字  段类型子类型若需要分词器特别有场景需要" class="hash-link" aria-label="34. 避免使用字段动态映射功能，指定具体字段类型，子类型（若需要），分词器（特别有场景需要）。的直接链接" title="34. 避免使用字段动态映射功能，指定具体字段类型，子类型（若需要），分词器（特别有场景需要）。的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="35-对于不需要分词的字符串字段使用-keyword-类型而不是-text-类型">35. 对于不需要分词的字符串字段，使用 <code>Keyword</code> 类型而不是 <code>Text</code> 类型。<a href="#35-对于不需要分词的字符串字段使用-keyword-类型而不是-text-类型" class="hash-link" aria-label="35-对于不需要分词的字符串字段使用-keyword-类型而不是-text-类型的直接链接" title="35-对于不需要分词的字符串字段使用-keyword-类型而不是-text-类型的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="36-es-默认字段个数最大-1000建议不要超过-100">36. ES 默认字段个数最大 1000，建议不要超过 100。<a href="#36-es-默认字段个数最大-1000建议不要超过-100" class="hash-link" aria-label="36. ES 默认字段个数最大 1000，建议不要超过 100。的直接链接" title="36. ES 默认字段个数最大 1000，建议不要超过 100。的直接链接">​</a></h4>
<p>单个 Doc 在建立索引时的运算复杂度，最大的因素不在于 Doc 的字节数或者说某个字段 <code>Value</code> 的长度，而是字段的数量。例如在满负载的写入压力测试中，<code>Mapping</code> 相同的情况下，一个有 10 个字段，200 字节的 Doc， 通过增加某些字段 <code>Value</code> 的长度到 500 字节，写入 ES 时速度下降很少，而如果字段数增加到 20，即使整个 Doc 字节数没增加多少，写入速度也会降低一倍。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="37-对于不索引字段index-属性设置为-false">37. 对于不索引字段，<code>Index</code> 属性设置为 <code>False</code>。<a href="#37-对于不索引字段index-属性设置为-false" class="hash-link" aria-label="37-对于不索引字段index-属性设置为-false的直接链接" title="37-对于不索引字段index-属性设置为-false的直接链接">​</a></h4>
<p>在下面的例子中，<code>Title</code> 字段的 <code>Index</code> 属性被设置为 <code>False</code>，表示该字段不会被包含在索引中。而 <code>Content</code> 字段的 <code>Index</code> 属性默认为 <code>True</code>，表示该字段会被包含在索引中。需要注意的是，即使 <code>Index</code> 属性被设置为 <code>False</code>，该字段仍然会被保存在文档中，可以被查询和聚合。</p>
<p>参考示例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mappings&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;title&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;text&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;index&quot;: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;content&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: &quot;text&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="38-避免使用-nested-或-parentchild">38. 避免使用 <code>Nested</code> 或 <code>Parent/Child</code>。<a href="#38-避免使用-nested-或-parentchild" class="hash-link" aria-label="38-避免使用-nested-或-parentchild的直接链接" title="38-避免使用-nested-或-parentchild的直接链接">​</a></h4>
<p><code>Nested Query</code>慢，<code>Parent/Child Query</code> 更慢，针对 1 个 Document，每一个 <code>Nested Field</code> 都会生成一个独立的 <code>Document</code>，这将使 Doc 数量剧增，影响查询效率尤其是 JOIN 的效率。因此能在 <code>Mapping</code> 设计阶段搞定的（大宽表设计或采用比较 Smart 的数据结构），就不要用父子关系的 Mapping。如果一定要使用 <code>Nested Fields</code>，保证 <code>Nested Fields</code>字段不能过多，目前ES默认限制是<code>Index.mapping.nested_fields.limit=50</code>。不建议使用 <code>Nested</code>，那有什么方式来解决 ES 无法 JOIN 的问题？主要有几种实现方式：</p>
<ul>
<li>
<p>在文档建模上尽可能在设计时将业务转化有关联关系的文档形式，使用扁平的文档模型。</p>
</li>
<li>
<p>独立索引存储，实际业务层分多次请求实现。</p>
</li>
<li>
<p>通过宽表冗余存储避免关联。</p>
</li>
<li>
<p>否则 <code>Nested</code> 和 <code>Parent/Child</code> 存储对性能均有一定影响，由于 <code>Nested</code> 更新子文档时需要 Reindex 整个文档，所以对写入性能影响较大，适用于 1 对 n（n 较小）场景；<code>Parent/Child</code> 存储在相同 <code>Type</code> 中，写入相比 <code>Nested</code> 性能高，用于 1 对 n（n 较大）场景，但比 <code>Nested</code> 查询更慢，官网说是 5-10 倍左右。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="39-避免使用-norms">39. 避免使用 Norms。<a href="#39-避免使用-norms" class="hash-link" aria-label="39. 避免使用 Norms。的直接链接" title="39. 避免使用 Norms。的直接链接">​</a></h4>
<p>Norm 是索引评分因子，如果不用按评分对文档进行排序，设置为<code>False</code>。</p>
<p>参考示例：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;title&quot;: {&quot;type&quot;: &quot;string&quot;,&quot;norms&quot;: {&quot;enabled&quot;: false}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于 Text 类型的字段而言，默认开启了 <code>Norms</code>，而 <code>Keyword</code> 类型的字段则默认关闭了 <code>Norms</code>。</p>
<p>开启 <code>Norms</code> 之后，每篇文档的每个字段需要一个字节存储 <code>Norms</code>。对于 <code>Text</code> 类型的字段而言是默认开启 <code>Norms</code> 的，因此对于不需要评分的 Text 类型的字段，可以禁用 <code>Norms</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="40-对不需要进行聚合排序的字段禁用列存-doc_values">40. 对不需要进行聚合/排序的字段禁用列存 <code>Doc_Values</code>。<a href="#40-对不需要进行聚合排序的字段禁用列存-doc_values" class="hash-link" aria-label="40-对不需要进行聚合排序的字段禁用列存-doc_values的直接链接" title="40-对不需要进行聚合排序的字段禁用列存-doc_values的直接链接">​</a></h4>
<p>面向列的方式存储，主要用户排序、聚合和访问脚本中字段值等数据访问场景。几乎所有字段类型都支持 <code>Doc_Values</code>，值得注意的是，需要分析的字符串字段除外。默认情况下，所有支持 <code>Doc_Values</code> 的字段都启用了这个功能。如果确定不需要对字段进行排序或聚合，或从脚本访问字段值，则可以禁用此功能以减少冗余存储成本。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-keyword和numeric的选择">3. Keyword和Numeric的选择<a href="#3-keyword和numeric的选择" class="hash-link" aria-label="3. Keyword和Numeric的选择的直接链接" title="3. Keyword和Numeric的选择的直接链接">​</a></h3>
<p><code>Keyword</code> 类型的主要缺点是在聚合的时候需要构建全局序数，而数值类型则不用。但低基数字段通常会命中大量结果集，例如性别，使用 <code>Numeric</code> 则会在构建 <code>Bitset</code> 上产生很高的代价。
综上所述，在类型选择上可以参考下面的原则：</p>
<ol>
<li>
<p>在仅查询的情况下，如果有 Range 查询需求，使用 <code>Numeric</code>，否则使用 <code>KeyWord</code>。</p>
</li>
<li>
<p>在仅聚合的情况下，如果明确字段是低基数的，使用 <code>Keyword</code> 配合 <code>Execution_hint:map</code>，其他情况使用 <code>Numeric</code>。</p>
</li>
<li>
<p>剩下 Term 查询+聚合的场景，需要综合考虑 <code>Numeric</code> 类型 <code>Term</code> 查询构建 <code>BitSet</code> 和 <code>Keyword</code> 类型构建全局序数哪个代价更大，需要看实际场景，但是目前所知的最坏情况下，构建 <code>Bitset</code> 会导致 CPU 跑满，构建全局序数的主要问题是带来的查询延迟，也会给 JVM 带来一些压力。</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="41-对于极少使用-range-查询的数字值使用-keyword-类型">41. 对于极少使用 Range 查询的数字值，使用 <code>Keyword</code> 类型。<a href="#41-对于极少使用-range-查询的数字值使用-keyword-类型" class="hash-link" aria-label="41-对于极少使用-range-查询的数字值使用-keyword-类型的直接链接" title="41-对于极少使用-range-查询的数字值使用-keyword-类型的直接链接">​</a></h4>
<p>并非所有数值数据都应映射为数值字段数据类型。Elasticsearch 为查询优化数字字段，例如 <code>Integer or long</code>。如果不需要范围查找，对于 Term 查询而言，Keyword 比 <code>Integer</code> 性能更好。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="42-对于有频繁且较为固定的-range-查询字段增加-keyword-类型-pre-indexing字段">42. 对于有频繁且较为固定的 Range 查询字段，增加 <code>Keyword</code> 类型 <code>Pre-Indexing</code>字段。<a href="#42-对于有频繁且较为固定的-range-查询字段增加-keyword-类型-pre-indexing字段" class="hash-link" aria-label="42-对于有频繁且较为固定的-range-查询字段增加-keyword-类型-pre-indexing字段的直接链接" title="42-对于有频繁且较为固定的-range-查询字段增加-keyword-类型-pre-indexing字段的直接链接">​</a></h4>
<p>如果对字段的大多数查询在一个固定的范围上运行 <code>Range</code> 聚合，那么可以增加一个 <code>Keyword</code> 类型的字段，通过将范围<code>Pre-Indexing</code>到索引中并使用 Terms 聚合来加快聚合速度。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="43-对需要聚合查询的高基数-keyword-字段启用-eager_global_ordinals">43. 对需要聚合查询的高基数 <code>Keyword</code> 字段启用 <code>Eager_Global_Ordinals</code>。<a href="#43-对需要聚合查询的高基数-keyword-字段启用-eager_global_ordinals" class="hash-link" aria-label="43-对需要聚合查询的高基数-keyword-字段启用-eager_global_ordinals的直接链接" title="43-对需要聚合查询的高基数-keyword-字段启用-eager_global_ordinals的直接链接">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">参考：eager_global_ordinals</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>序号（<code>Ordinals</code>）用于在 <code>Keyword</code> 字段上运行 <code>Terms</code> 聚合。序号用一个自增数值表示，ES 维护这个自增数字与实际值的映射关系，并为每一数值分配一个 <code>Bucket</code>，映射关系是 <code>Segment</code> 级别的。</p>
<p>但是做聚合操作时往往需要结合多个 <code>Segment</code> 的结果，而每个 <code>Segment</code> 的 <code>Ordinals</code> 映射关系是不一致的，所以 ES 会在每个分片上创建全局序号（<code>Global Ordinals</code>）结构 ，一个全局统一的映射，维护全局的 <code>Ordinal</code> 与每个 <code>Segment</code> 的 <code>Ordinal</code> 的映射关系。</p>
<p>默认情况下，<code>Global Ordinals</code> 默认是延时构建，在第一次查询如 Term Aggregation 使用到时才会构建。因为 ES 不知道哪些字段将用于 Terms 聚合，哪些字段不会。对于基数大的字段，构建成本较大。</p>
<p>启用 <code>eager_global_ordinals</code> 后，Elasticsearch 会在分片构建时预先计算出全局词项表，以便在查询时能够更快地加载和使用。但启用 <code>eager_global_ordinals</code> 后，每次执行 <code>Refresh</code> 操作都会构建 <code>Global Ordinals</code>，相当于把搜索时候花费的构建成本转移到写入时，所以会对写入效率有一定的影响，可以配合增大索引的 <code>Refresh Interval</code> 来使用。</p>
<p>参考示例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;mappings&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;: { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;foo&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;type&quot;: &quot;keyword&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;eager_global_ordinals&quot; : true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="五总结">五、总结<a href="#五总结" class="hash-link" aria-label="五、总结的直接链接" title="五、总结的直接链接">​</a></h2>
<p>最近十年，Elasticsearch 已经成为了最受欢迎的开源检索引擎，并沉淀了大量的实践案例及优化总结。在本文中，我们尽可能全面地总结了 Elasticsearch 日常开发中的一些重要实践&amp;避坑指南，希望能为大家提供 Elasticsearch 使用上的一些借鉴点，欢迎讨论！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="六参考文章">六、参考文章：<a href="#六参考文章" class="hash-link" aria-label="六、参考文章：的直接链接" title="六、参考文章：的直接链接">​</a></h2>
<ol>
<li>《Elasticsearch 源码解析与优化实战》</li>
<li>《Elasticsearch权威指南》</li>
<li><a href="https://www.easyice.cn/archives/367" target="_blank" rel="noopener noreferrer">https://www.easyice.cn/archives/367</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/filter-caching.html#_independent_query_caching" target="_blank" rel="noopener noreferrer">https://www.elastic.co/guide/en/elasticsearch/guide/current/filter-caching.html#_independent_query_caching</a></li>
<li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_preventing_combinatorial_explosions.html" target="_blank" rel="noopener noreferrer">https://www.elastic.co/guide/cn/elasticsearch/guide/current/_preventing_combinatorial_explosions.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/eager-global-ordinals.html" target="_blank" rel="noopener noreferrer">https://www.elastic.co/guide/en/elasticsearch/reference/current/eager-global-ordinals.html</a></li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/middleware/elastic/2-ES-Usage-Advice.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>Lorchr</b> <!-- -->于 <b><time datetime="2024-04-27T04:57:55.000Z" itemprop="dateModified">2024年4月27日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一前言" class="table-of-contents__link toc-highlight">一、前言</a></li><li><a href="#二查询相关" class="table-of-contents__link toc-highlight">二、查询相关</a><ul><li><a href="#1-充分利用缓存" class="table-of-contents__link toc-highlight">1. 充分利用缓存</a></li><li><a href="#2-聚合查询" class="table-of-contents__link toc-highlight">2. 聚合查询</a></li><li><a href="#3-分页" class="table-of-contents__link toc-highlight">3. 分页</a></li><li><a href="#4-其他" class="table-of-contents__link toc-highlight">4. 其他</a></li></ul></li><li><a href="#三写入相关" class="table-of-contents__link toc-highlight">三、写入相关</a></li><li><a href="#四索引创建" class="table-of-contents__link toc-highlight">四、索引创建</a><ul><li><a href="#1-分片" class="table-of-contents__link toc-highlight">1. 分片</a></li><li><a href="#2-mapping设计" class="table-of-contents__link toc-highlight">2. Mapping设计</a></li><li><a href="#3-keyword和numeric的选择" class="table-of-contents__link toc-highlight">3. Keyword和Numeric的选择</a></li></ul></li><li><a href="#五总结" class="table-of-contents__link toc-highlight">五、总结</a></li><li><a href="#六参考文章" class="table-of-contents__link toc-highlight">六、参考文章：</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/light-docusaurus/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>