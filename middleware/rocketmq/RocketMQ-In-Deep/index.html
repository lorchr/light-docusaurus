<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-middleware docs-version-current docs-doc-page docs-doc-id-rocketmq/RocketMQ-In-Deep" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">RocketMQ-In-Deep | Light Docusaurus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://lorchr.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://lorchr.github.io/middleware/rocketmq/RocketMQ-In-Deep/"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-middleware-current"><meta data-rh="true" property="og:title" content="RocketMQ-In-Deep | Light Docusaurus"><meta data-rh="true" name="description" content="- RocketMQ为什么这么快？我从源码中扒出了10大原因！"><meta data-rh="true" property="og:description" content="- RocketMQ为什么这么快？我从源码中扒出了10大原因！"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lorchr.github.io/middleware/rocketmq/RocketMQ-In-Deep/"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/middleware/rocketmq/RocketMQ-In-Deep/" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://lorchr.github.io/middleware/rocketmq/RocketMQ-In-Deep/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TLGHDZ3Y2I-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Light Docusaurus RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Light Docusaurus Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="Light Docusaurus" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e8086d6f.css">
<script src="/assets/js/runtime~main.2519630d.js" defer="defer"></script>
<script src="/assets/js/main.a410c441.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Torch Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Torch</b></a><a class="navbar__item navbar__link" href="/docs/category/guide/">Torch</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/middleware/">Middleware</a><a class="navbar__item navbar__link" href="/electron/">Electron</a><a class="navbar__item navbar__link" href="/postman/">Postman</a><a class="navbar__item navbar__link" href="/diy/">DIY</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/middleware/rocketmq/RocketMQ-In-Deep/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/middleware/">MiddleWare</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/compare/">Compare</a><button aria-label="展开侧边栏分类 &#x27;Compare&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/mysql/">Mysql</a><button aria-label="展开侧边栏分类 &#x27;Mysql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/postgresql/">Postgresql</a><button aria-label="展开侧边栏分类 &#x27;Postgresql&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/redis/">Redis</a><button aria-label="展开侧边栏分类 &#x27;Redis&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/nginx/">Nginx</a><button aria-label="展开侧边栏分类 &#x27;Nginx&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/netty/">Netty</a><button aria-label="展开侧边栏分类 &#x27;Netty&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/mqtt/">MQTT</a><button aria-label="展开侧边栏分类 &#x27;MQTT&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/influxdb/">InfluxDB</a><button aria-label="展开侧边栏分类 &#x27;InfluxDB&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/kafka/">Kafka</a><button aria-label="展开侧边栏分类 &#x27;Kafka&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/rabbitmq/">RabbitMQ</a><button aria-label="展开侧边栏分类 &#x27;RabbitMQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/middleware/category/rocketmq/">RocketMQ</a><button aria-label="折叠侧边栏分类 &#x27;RocketMQ&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/rocketmq/RocketMQ-Message-Lifecycle/">RocketMQ-Message-Lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/rocketmq/RocketMQ-Message-Type-Analysis/">RocketMQ-Message-Type-Analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/rocketmq/Rocketmq-Timer-Task/">Rocketmq-Timer-Task</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware/rocketmq/RocketMQ/">RocketMQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/middleware/rocketmq/RocketMQ-In-Deep/">RocketMQ-In-Deep</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/workflow/">Workflow</a><button aria-label="展开侧边栏分类 &#x27;Workflow&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/plusar/">Plusar</a><button aria-label="展开侧边栏分类 &#x27;Plusar&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/middleware/category/shardingsphere/">ShardingSphere</a><button aria-label="展开侧边栏分类 &#x27;ShardingSphere&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/middleware/category/rocketmq/"><span itemprop="name">RocketMQ</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RocketMQ-In-Deep</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>RocketMQ-In-Deep</h1></header><ul>
<li><a href="https://mp.weixin.qq.com/s/y1-A-SHAkGdg9IOTeUtPxg" target="_blank" rel="noopener noreferrer">RocketMQ为什么这么快？我从源码中扒出了10大原因！</a></li>
</ul>
<p>RocketMQ作为阿里开源的消息中间件，深受广大开发者的喜爱</p>
<p>而这其中一个很重要原因就是，它处理消息和拉取消息的速度非常快</p>
<p>那么，问题来了，RocketMQ为什么这么快呢？</p>
<p>接下来，我将从以下10个方面来探讨一下RocketMQ这么快的背后原因</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-1-e7677e5ab00c6b37a6df68dfcc56a42c.png" width="905" height="364" class="img_ev3q"></p>
<p>如果你对RocketMQ还不了解，可以从公众号后台菜单栏中查看我之前写的关于RocketMQ的几篇文章</p>
<p>如果你对RocketMQ源码也感兴趣，可以从下面这个仓库fork一下源码，我在源码中加了中文注释，并且后面我还会持续更新注释</p>
<blockquote>
<p><a href="https://github.com/sanyou3/rocketmq.git" target="_blank" rel="noopener noreferrer">https://github.com/sanyou3/rocketmq.git</a></p>
</blockquote>
<p>本文是基于RocketMQ 4.9.x版本讲解</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="批量发送消息">批量发送消息<a href="#批量发送消息" class="hash-link" aria-label="批量发送消息的直接链接" title="批量发送消息的直接链接">​</a></h2>
<p>RocketMQ在发送消息的时候支持一次性批量发送多条消息，如下代码所示：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Producer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建一个生产者，指定生产者组为 sanyouProducer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQProducer producer = new DefaultMQProducer(&quot;sanyouProducer&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 指定NameServer的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setNamesrvAddr(&quot;192.168.200.143:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 启动生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //用以及集合保存多个消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Message&gt; messages = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messages.add(new Message(&quot;sanyouTopic&quot;, &quot;三友的java日记 0&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messages.add(new Message(&quot;sanyouTopic&quot;, &quot;三友的java日记 1&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messages.add(new Message(&quot;sanyouTopic&quot;, &quot;三友的java日记 2&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发送消息并得到消息的发送结果，然后打印</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SendResult sendResult = producer.send(messages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;%s%n&quot;, sendResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过批量发送消息，减少了RocketMQ客户端与服务端，也就是Broker之间的网络通信次数，提高传输效率</p>
<p>不过在使用批量消息的时候，需要注意以下三点：</p>
<ol>
<li>每条消息的Topic必须都得是一样的</li>
<li>不支持延迟消息和事务消息</li>
<li>不论是普通消息还是批量消息，总大小默认不能超过4m</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="消息压缩">消息压缩<a href="#消息压缩" class="hash-link" aria-label="消息压缩的直接链接" title="消息压缩的直接链接">​</a></h2>
<p>RocketMQ在发送消息的时候，当发现消息的大小超过4k的时候，就会对消息进行压缩</p>
<p>这是因为如果消息过大，会对网络带宽造成压力</p>
<p>不过需要注意的是，如果是批量消息的话，就不会进行压缩，如下所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-2-b3d3aa6e658cfd958774851460cd4a75.png" width="1080" height="395" class="img_ev3q"></p>
<p>压缩消息除了能够减少网络带宽造成压力之外，还能够节省消息存储空间</p>
<p>RocketMQ在往磁盘存消息的时候，并不会去解压消息，而是直接将压缩后的消息存到磁盘</p>
<p>消费者拉取到的消息其实也是压缩后的消息</p>
<p>不过消费者在拿到消息之后会对消息进行解压缩</p>
<p>当我们的业务系统拿到消息的时候，其实就是解压缩后的消息</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-3-fb3abb3ab4c446e95048e62fc0fe17f5.png" width="661" height="241" class="img_ev3q"></p>
<p>虽然压缩消息能够减少带宽压力和磁盘存储压力</p>
<p>但是由于压缩和解压缩的过程都是在客户端（生产者、消费者）完成的</p>
<p>所以就会导致客户端消耗更多的CPU资源，对CPU造成一定的压力</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="高性能网络通信模型">高性能网络通信模型<a href="#高性能网络通信模型" class="hash-link" aria-label="高性能网络通信模型的直接链接" title="高性能网络通信模型的直接链接">​</a></h2>
<p>当生产者处理好消息之后，就会将消息通过网络通信发送给服务端</p>
<p>而RocketMQ之所以快的一个非常重要原因就是它拥有高性能网络通信模型</p>
<p>RocketMQ网络通信这块底层是基于Netty来实现的</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-4-ecd4a57bc39f1801709ac9bd3157f910.png" width="1080" height="405" class="img_ev3q"></p>
<p>Netty是一款非常强大、非常优秀的网络应用程序框架，主要有以下几个优点：</p>
<ul>
<li>异步和事件驱动：Netty基于事件驱动的架构，使用了异步I/O操作，避免了阻塞式I/O调用的缺陷，能够更有效地利用系统资源，提高并发处理能力。</li>
<li>高性能：Netty针对性能进行了优化，比如使用直接内存进行缓冲，减少垃圾回收的压力和内存拷贝的开销，提供了高吞吐量、低延迟的网络通讯能力。</li>
<li>可扩展性：Netty的设计允许用户自定义各种Handler来处理协议编码、协议解码和业务逻辑等。并且，它的模块可插拔性设计使得用户可以根据需要轻松地添加或更换组件。</li>
<li>简化API：与Java原生NIO库相比，Netty提供了更加简洁易用的API，大大降低了网络编程的复杂度。</li>
<li>安全：Netty内置了对SSL/TLS协议的支持，使得构  建安全通信应用变得容易。</li>
<li>丰富的协议支持：Netty提供了HTTP、HTTP/2、WebSocket、Google Protocol Buffers等多种协议的编解码支持，满足不同网络应用需求。</li>
<li>...</li>
</ul>
<p>就是因为Netty如此的强大，所以不仅仅RocketMQ是基于Netty实现网络通信的</p>
<p>几乎绝大多数只要涉及到网络通信的Java类框架，底层都离不开Netty的身影</p>
<p>比如知名RPC框架Dubbo、Java gRPC实现、Redis的亲儿子Redisson、分布式任务调度平台xxl-job等等</p>
<p>它们底层在实现网络通信时，都是基于Netty框架</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="零拷贝技术">零拷贝技术<a href="#零拷贝技术" class="hash-link" aria-label="零拷贝技术的直接链接" title="零拷贝技术的直接链接">​</a></h2>
<p>当消息达到RocketMQ服务端之后，为了能够保证服务端重启之后消息也不丢失，此时就需要将消息持久化到磁盘</p>
<p>由于涉及到消息持久化操作，就涉及到磁盘文件的读写操作</p>
<p>RocketMQ为了保证磁盘文件的高性能读写，使用到了一个叫零拷贝的技术</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1传统io读写方式">1、传统IO读写方式<a href="#1传统io读写方式" class="hash-link" aria-label="1、传统IO读写方式的直接链接" title="1、传统IO读写方式的直接链接">​</a></h3>
<p>说零拷贝之前，先说一下传统的IO读写方式。</p>
<p>比如现在有一个需求，将磁盘文件通过网络传输出去</p>
<p>那么整个传统的IO读写模型如下图所示</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-5-3e71c0c1d6b3b73a83003dd45ac7972c.png" width="516" height="311" class="img_ev3q"></p>
<p>传统的IO读写其实就是read + write的操作，整个过程会分为如下几步</p>
<ol>
<li>用户调用read()方法，开始读取数据，此时发生一次上下文从用户态到内核态的切换，也就是图示的切换1</li>
<li>将磁盘数据通过DMA拷贝到内核缓存区</li>
<li>将内核缓存区的数据拷贝到用户缓冲区，这样用户，也就是我们写的代码就能拿到文件的数据</li>
<li>read()方法返回，此时就会从内核态切换到用户态，也就是图示的切换2</li>
<li>当我们拿到数据之后，就可以调用write()方法，此时上下文会从用户态切换到内核态，即图示切换3</li>
<li>CPU将用户缓冲区的数据拷贝到Socket缓冲区</li>
<li>将Socket缓冲区数据拷贝至网卡</li>
<li>write()方法返回，上下文重新从内核态切换到用户态，即图示切换4</li>
</ol>
<p>整个过程发生了4次上下文切换和4次数据的拷贝，这在高并发场景下肯定会严重影响读写性能。</p>
<p>所以为了减少上下文切换次数和数据拷贝次数，就引入了零拷贝技术。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2零拷贝">2、零拷贝<a href="#2零拷贝" class="hash-link" aria-label="2、零拷贝的直接链接" title="2、零拷贝的直接链接">​</a></h3>
<p>零拷贝技术是一个思想，指的是指计算机执行操作时，CPU不需要先将数据从某处内存复制到另一个特定区域。</p>
<p>实现零拷贝的有以下两种方式：</p>
<ul>
<li>mmap()</li>
<li>sendfile()</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="mmap">mmap()<a href="#mmap" class="hash-link" aria-label="mmap()的直接链接" title="mmap()的直接链接">​</a></h4>
<p>mmap（memory map）是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。</p>
<p>简单地说就是内核缓冲区和应用缓冲区进行映射</p>
<p>用户在操作应用缓冲区时就好像在操作内核缓冲区</p>
<p>比如你往应用缓冲区写数据，就好像直接往内核缓冲区写数据，这个过程不涉及到CPU拷贝</p>
<p>而传统IO就需要  将在写完应用缓冲区之后需要将数据通过CPU拷贝到内核缓冲区</p>
<p>同样地上述文件传输功能，如果使用mmap的话，由于我们可以直接操作内核缓冲区</p>
<p>此时我们就可以将内核缓冲区的数据直接CPU拷贝到Socket缓冲区</p>
<p>整个IO模型就会如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-6-85a4a0fa59eeeeef848c0deb8e9e8241.png" width="516" height="311" class="img_ev3q"></p>
<p>基于mmap IO读写其实就变成mmap + write的操作，也就是用mmap替代传统IO中的read操作</p>
<ul>
<li>当用户发起mmap调用的时候会发生上下文切换1，进行内存映射，然后数据被拷贝到内核缓冲区，mmap返回，发生上下文切换2</li>
<li>随后用户调用write，发生上下文切换3，将内核缓冲区的数据拷贝到Socket缓冲区，write返回，发生上下文切换4。</li>
</ul>
<p>上下文切换的次数仍然是4次，但是拷贝次数只有3次，少了一次CPU拷贝。</p>
<p>所以总的来说，使用mmap就可以直接少一次CPU拷贝。</p>
<p>说了这么多，那么在Java中，如何去实现mmap，也就是内核缓冲区和应用缓冲区映射呢？</p>
<p>其实在Java NIO类库中就提供了相应的API，当然底层也还是调用Linux系统的mmap()实现的，代码如下所示</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FileChannel fileChannel = new RandomAccessFile(&quot;test.txt&quot;, &quot;rw&quot;).getChannel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MappedByteBuffer mappedByteBuffer = fileChannel.map(FileChannel.MapMode.READ_WRITE, 0, fileChannel.size());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>MappedByteBuffer，你可以认为操作这个对象就好像直接操作内核缓冲区</p>
<p>比如可以通过MappedByteBuffer读写磁盘文件，此时就好像直接从内核缓冲区读写数据</p>
<p>当然也可以直接通过MappedByteBuffer将文件的数据拷贝到Socket缓冲区，实现上述文件传输的模型</p>
<p>这里我就不贴相应的代码了</p>
<p>RocketMQ在存储文件时，就是通过mmap技术来实现高效的文件读写</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-7-9100de5cba7b79f63a2ff80bfd5ded64.png" width="1080" height="285" class="img_ev3q">
RocketMQ中使用mmap代码</p>
<blockquote>
<p>虽然前面一直说mmap不涉及CPU拷贝，但在某些特定场景下，尤其是在写操作或特定的系统优化策略下，还是可能涉及CPU拷贝。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sendfile">sendfile()<a href="#sendfile" class="hash-link" aria-label="sendfile()的直接链接" title="sendfile()的直接链接">​</a></h4>
<p>sendfile()跟mmap()一样，也会减少一次CPU拷贝，但是它同时也会减少两次上下文切换。</p>
<p>sendfile()主要是用于文件传输，比如将文件传输到另一个文件，又或者是网络</p>
<p>当基于sendfile()时，一次文件传输的过程就如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-8-56aefcf0c06a7f4c74e470cf0c6f054a.png" width="516" height="311" class="img_ev3q"></p>
<p>用户发起sendfile()调用时会发生切换1，之后数据通过DMA拷贝到内核缓冲区，之后再将内核缓冲区的数据CPU拷贝到Socket缓冲区，最后拷贝到网卡，sendfile()返回，发生切换2。</p>
<p>同样地，Java NIO类库中也提供了相应的API实现sendfile</p>
<p>当然底层还是操作系统的sendfile()</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FileChannel channel = FileChannel.open(Paths.get(&quot;./test.txt&quot;), StandardOpenOption.WRITE, StandardOpenOption.CREATE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//调用transferTo方法向目标数据传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.transferTo(position, len, target);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>FileChannel的transferTo方法底层就是基于sendfile来的</p>
<p>在如上代码中，并没有文件的读写操作，而是直接将文  件的数据传输到target目标缓冲区</p>
<p>也就是说，sendfile传输文件时是无法知道文件的具体的数据的</p>
<p>但是mmap不一样，mmap可以来直接修改内核缓冲区的数据</p>
<p>假设如果需要对文件的内容进行修改之后再传输，mmap可以满足</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小总结">小总结<a href="#小总结" class="hash-link" aria-label="小总结的直接链接" title="小总结的直接链接">​</a></h3>
<p>在传统IO中，如果想将用户缓存区的数据放到内核缓冲区，需要经过CPU拷贝</p>
<p>而基于零拷贝技术可以减少CPU拷贝次数，常见的有两种：</p>
<ul>
<li>mmap()</li>
<li>sendfile()</li>
</ul>
<p>mmap()是将用户缓冲区和内核缓冲区共享，操作用户缓冲区就好像直接操作内核缓冲区，读写数据时不需要CPU拷贝</p>
<p>Java中可以使用MappedByteBuffer这个API来达到操作内核缓冲区的效果</p>
<p>sendfile()主要是用于文件传输，可以通过sendfile()将一个文件内容传输到另一个文件中或者是网络中</p>
<p>sendfile()在整个过程中是无法对文件内容进行修改的，如果想修改之后再传输，可以通过mmap来修改内容之后再传输</p>
<p>上面出现的API都是Java NIO标准类库中的</p>
<p>如果你看的还是很迷糊，那直接记住一个结论</p>
<blockquote>
<p>之所以基于零拷贝技术能够高效的实现文件的读写操作，主要因为是减少了CPU拷贝次数和上下文切换次数</p>
</blockquote>
<p>在RocketMQ中，底层是基于mmap()来实现文件的高效读写的</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="顺序写">顺序写<a href="#顺序写" class="hash-link" aria-label="顺序写的直接链接" title="顺序写的直接链接">​</a></h2>
<p>RocketMQ在存储消息时，除了使用零拷贝技术来实现文件的高效读写之外</p>
<p>还使用顺序写的方式提高数据写入的速度</p>
<p>RocketMQ会将消息按照顺序一条一条地写入文件中</p>
<p>这种顺序写的方式由于减少了磁头的移动和寻道时间，在大规模数据写入的场景下，使得数据写入的速度更快</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="高效的数据存储结构">高效的数据存储结构<a href="#高效的数据存储结构" class="hash-link" aria-label="高效的数据存储结构的直接链接" title="高效的数据存储结构的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="topic和队列的关系">Topic和队列的关系<a href="#topic和队列的关系" class="hash-link" aria-label="Topic和队列的关系的直接链接" title="Topic和队列的关系的直接链接">​</a></h3>
<p>在RocketMQ中，默认会为每个Topic在每个服务端Broker实例上创建4个队列</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-9-e8684a386bce0a7ca56a688ba6e329e9.png" width="161" height="211" class="img_ev3q">
如果有两个Broker，那么默认就会有8个队列</p>
<p>每个Broker上的队列上的编号（queueId）都是从0开始</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="commitlog">CommitLog<a href="#commitlog" class="hash-link" aria-label="CommitLog的直接链接" title="CommitLog的直接链接">​</a></h4>
<p>前面一直说，当消息到达RocektMQ服务端时，需要将消息存到磁盘文件</p>
<p>RocketMQ给这个存消息的文件起了一个高大上的名字：CommitLog</p>
<blockquote>
<p>由于消息会很多，所以为了防止文件过大，CommitLog在物理磁盘文件上被分为多个磁盘文件，每个文件默认的固定大小是1G</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-10-65dff0dbeba0a7966c361205dc99acc8.png" width="401" height="101" class="img_ev3q"></p>
<p>消息在写入到文件时，除了包含消息本身的内容数据，也还会包含其它信息，比如</p>
<ul>
<li>消息的Topic</li>
<li>消息所在队列的id，生产者发送消息时会 携带这个队列id</li>
<li>消息生产者的ip和端口</li>
<li>...</li>
</ul>
<p>这些数据会和消息本身按照一定的顺序同时写到CommitLog文件中</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-11-cb4d861be8a3df3f01cbd5276213eea7.png" width="488" height="156" class="img_ev3q"></p>
<p>上图中黄色排列顺序和实际的存的内容并非实际情况，我只是举个例子</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="consumequeue">ConsumeQueue<a href="#consumequeue" class="hash-link" aria-label="ConsumeQueue的直接链接" title="ConsumeQueue的直接链接">​</a></h4>
<p>除了CommitLog文件之外，RocketMQ还会为每个队列创建一个磁盘文件</p>
<p>RocketMQ给这个文件也起了一个高大上的名字：ConsumeQueue</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-12-9aa89c3ce044eaa1f2ea8685738f9687.png" width="344" height="221" class="img_ev3q"></p>
<blockquote>
<p>当消息被存到CommitLog之后，其实还会往这条消息所在队列的ConsumeQueue文件中插一条数据</p>
</blockquote>
<p>每个队列的ConsumeQueue也是由多个文件组成，每个文件默认是存30万条数据</p>
<p>插入ConsumeQueue中的每条数据由20个字节组成，包含3部分信息</p>
<ul>
<li>消息在CommitLog的起始位置（8个字节），也被称为偏移量</li>
<li>消息在CommitLog存储的长度（4个字节）</li>
<li>消息tag的hashCode（8个字节）</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-13-979ffebb52a68f5c470dc0ef8f182838.png" width="488" height="336" class="img_ev3q"></p>
<p>每条数据也有自己的编号（offset），默认从0开始，依次递增</p>
<p>所以，通过ConsumeQueue中存的数据可以从CommitLog中找到对应的消息</p>
<p>那么这个ConsumeQueue有什么作用呢？</p>
<p>其实通过名字也能猜到，这其实跟消息消费有关</p>
<p>当消费者拉取消息的时候，会告诉服务端四个比较重要的信息</p>
<ul>
<li>自己需要拉取哪个Topic的消息</li>
<li>从Topic中的哪个队列（queueId）拉取</li>
<li>从队列的哪个位置（offset）拉取消息</li>
<li>拉取多少条消息(默认32条)</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-14-3c5216e4c621b91f3f4ec8b8b527e7ca.png" width="1080" height="1000" class="img_ev3q"></p>
<p>服务端接收到消息之后，总共分为四步处理：</p>
<ul>
<li>
<p>首先会找到对应的Topic</p>
</li>
<li>
<p>之后根据queueId找到对应的ConsumeQueue文件</p>
</li>
<li>
<p>然后根据offset位置，从ConsumeQueue中读取跟拉取消息条数一样条数的数据</p>
<blockquote>
<p>由于ConsumeQueue每条数据都是20个字节，所以根据offset的位置可以很快定位到应该从文件的哪个位置开始读取数据</p>
</blockquote>
</li>
<li>
<p>最后解析每条数据，根据偏移量和消息的长度到CommitLog文件查找真正的消息内容</p>
</li>
</ul>
<p>整个过程如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-15-da89f05c832b06413ac0d73dbef4febd.png" width="771" height="251" class="img_ev3q"></p>
<p>所以，从这可以看出，当消费者在拉取消息时，ConsumeQueue其实就相当于是一个索引文件，方便快速查找在CommitLog中的消息</p>
<p>并且无论CommitLog存多少消息，整个查找消息的时间复杂度都是O(1)</p>
<p>由于ConsumeQueue每条数据都是20个字节，所以如果需要找第n条数据，只需要从第n * 20个字节的位置开始读20个字节的数据即可，这个过程是O(1)的</p>
<p>当从ConsumeQueue找到数据之后，解析出消息在CommitLog存储的起始位置和大小，之后就直接根据这两个信息就可以从CommitLog中找到这条消息了，这个过程也是O(1)的</p>
<p>所以整个查找消息的过程就是O(1)的</p>
<p>所以从这就可以看出，ConsumeQueue和CommitLog相互配合，就能保证快速查找到消息，消费者从而就可以快速拉取消息</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="异步处理">异步处理<a href="#异步处理" class="hash-link" aria-label="异步处理的直接链接" title="异步处理的直接链接">​</a></h2>
<p>RocketMQ在处理消息时，有很多异步操作，这里我举两个例子：</p>
<ul>
<li>异步刷盘</li>
<li>异步主从复制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="异步刷盘">异步刷盘<a href="#异步刷盘" class="hash-link" aria-label="异步刷盘的直接链接" title="异步刷盘的直接链接">​</a></h3>
<p>前面说到，文件的内容都是先写到内核缓冲区，也可以说是PageCache</p>
<p>而写到PageCache并不能保证消息一定不丢失</p>
<p>因为如果服务器挂了，这部分数据还是可能会丢失的</p>
<p>所以为了解决这个问题，RocketMQ会开启一个后台线程</p>
<p>这个后台线程默认每隔0.5s会将消息从PageCache刷到磁盘中</p>
<p>这样就能保证消息真正的持久化到磁盘中</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-16-fc384fa57c1399b4b47e9b46c33e0cd7.png" width="1080" height="603" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="异步主从复制">异步主从复制<a href="#异步主从复制" class="hash-link" aria-label="异步主从复制的直接链接" title="异步主从复制的直接链接">​</a></h3>
<p>在RocketMQ中，支持主从复制的集群模式</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-17-ea03bfb16110fc2a5a4634610425250b.png" width="121" height="171" class="img_ev3q"></p>
<p>这种模式下，写消息都是写入到主节点，读消息一般也是从主节点读，但是有些情况下可能会从从节点读</p>
<p>从节点在启动的时候会跟主节点建立网络连接</p>
<p>当主节点将消息存储的CommitLog文件之后，会通过后台一个异步线程，不停地将消息发送给从节点</p>
<p>从节点接收 到消息之后，就直接将消息存到CommitLog文件</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-18-4d0ec2e9d192ac7d11f5eeefd9ce08f6.png" width="451" height="211" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小总结-1">小总结<a href="#小总结-1" class="hash-link" aria-label="小总结的直接链接" title="小总结的直接链接">​</a></h3>
<p>就是因为有这些异步操作，大大提高了消息存储的效率</p>
<p>不过值得注意的，尽管异步可以提高效率，但是也增加了不确定性，比如丢消息等等</p>
<p>当然RocketMQ也支持同步等待消息刷盘和主从复制成功，但这肯定会导致性能降低</p>
<p>所以在项目中可以根据自己的业务需要选择对应的刷盘和主从复制的策略</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="批量处理">批量处理<a href="#批量处理" class="hash-link" aria-label="批量处理的直接链接" title="批量处理的直接链接">​</a></h2>
<p>除了异步之外，RocketMQ还大量使用了批量处理机制</p>
<p>比如前面说过，消费者拉取消息的时候，可以指定拉取拉取消息的条数，批量拉取消息</p>
<p>这种批量拉取机制可以减少消费者跟RocketMQ服务端的网络通信次数，提高效率</p>
<p>除了批量拉取消息之外，RocketMQ在提交消费进度的时候也使用了批量处理机制</p>
<p>所谓的提交消费进度就是指</p>
<p>当消费者在成功消费消息之后，需要将所消费消息的offset（ConsumeQueue中的offset）提交给RocketMQ服务端</p>
<p>告诉RocketMQ，这个Queue的消息我已经消费到了这个位置了</p>
<p>这样一旦消费者重启了或者其它啥的要从这个Queue重新开始拉取消息的时候</p>
<p>此时他只需要问问RocketMQ服务端上次这个Queue消息消费到哪个位置了</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/png;base64,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" width="174" height="142" class="img_ev3q"></p>
<p>之后消费者只需要从这个位置开始消费消息就行了，这样就解决了接着消费的问题</p>
<p>RocketMQ在提交消费进度的时候并不是说每消费一条消息就提交一下这条消息对应的offset</p>
<p>而是默认每隔5s定时去批量提交一次这5s钟消费消息的offset</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="锁优化">锁优化<a href="#锁优化" class="hash-link" aria-label="锁优化的直接链接" title="锁优化的直接链接">​</a></h2>
<p>由于RocketMQ内部采用了很多线程异步处理机制</p>
<p>这就一定会产生并发情况下的线程安全问题</p>
<p>在这种情况下，RocketMQ进行了多方面的锁优化以提高性能和并发能力</p>
<p>就比如拿消息存储来说</p>
<p>为了保证消息是按照顺序一条一条地写入到CommitLog文件中，就需要对这个写消息的操作进行加锁</p>
<p>而RocketMQ默认使用ReentrantLock来加锁，并不是synchronized</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-20-522dfe2eed0116001f25b52fd1c21db9.png" width="1080" height="489" class="img_ev3q"></p>
<p>当然除了默认情况外，RocketMQ还提供了一种基于CAS加锁的实现</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-21-bc8d7db1b59625a76a2f74187a0f9a8b.png" width="1080" height="472" class="img_ev3q"></p>
<p>这种实现可以在写消息压力较低的情况下使用</p>
<p>当然除了写消息之外，在一些其它的地方，RocketMQ也使用了基于CAS的原子操作来代替传统的锁机制</p>
<p>例如使用大量使用了AtomicInteger、AtomicLong等原子类来实现并发控制，避免了显式的锁竞争，提高了性能</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="线程池隔离">线程池隔离<a href="#线程池隔离" class="hash-link" aria-label="线程池隔离的直接链接" title="线程池隔离的直接链接">​</a></h2>
<p>RocketMQ在处理请求的时候，会为不同的请求分配不同的线程池进行处理</p>
<p>比如对于消息存储请求和拉取消息请求来说</p>
<p>Broker会有专门为它们分配两个不同的线程池去分别处理这些请求</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/5-22-b9c6159b110e8c4e884f83538a87b580.png" width="631" height="181" class="img_ev3q"></p>
<p>这种让不同的业务由不同的线程池去处理的方式，能够有效地隔离不同业务逻辑之间的线程资源的影响</p>
<p>比如消息存储请求处理过慢并不会影响处理拉取消息请求</p>
<p>所以RocketMQ通过线程隔离及时可以有效地提高系统的并发性能和稳定性</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>到这我就从10个方面讲完了RocketMQ为什么这么快背后的原因</p>
<p>不知道你读完文章之后有什么感受</p>
<p>其实实际上RocketMQ快的原因远远不止我上面说的这几点</p>
<p>RocketMQ本身还做了很多其它的优化，比如拉取消息的长轮询机制、文件预热机制等等</p>
<p>正是因为有各种各样设计细节上的优化，才最终决定了RocketMQ出色的性能表现</p>
<p>好了，本文就讲到这里，如果觉得本文对你有点帮助，欢迎点赞、在看、收藏、转发分享给其他需要的人</p>
<p>你的支持就是我更新的最大动力，感谢感谢！</p>
<p>让我们下期再见，拜拜！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考：<a href="#参考" class="hash-link" aria-label="参考：的直接链接" title="参考：的直接链接">​</a></h2>
<p>1、<a href="https://mp.weixin.qq.com/s/mOD9Z6pxSxBQuNx3YaUw3A" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/mOD9Z6pxSxBQuNx3YaUw3A</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/lorchr/light-docusaurus/tree/main/middleware/rocketmq/5-RocketMQ-In-Deep.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>Lorchr</b> <!-- -->于 <b><time datetime="2025-06-12T10:19:26.000Z" itemprop="dateModified">2025年6月12日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/middleware/rocketmq/RocketMQ/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">RocketMQ</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/middleware/category/workflow/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Workflow</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#批量发送消息" class="table-of-contents__link toc-highlight">批量发送消息</a></li><li><a href="#消息压缩" class="table-of-contents__link toc-highlight">消息压缩</a></li><li><a href="#高性能网络通信模型" class="table-of-contents__link toc-highlight">高性能网络通信模型</a></li><li><a href="#零拷贝技术" class="table-of-contents__link toc-highlight">零拷贝技术</a><ul><li><a href="#1传统io读写方式" class="table-of-contents__link toc-highlight">1、传统IO读写方式</a></li><li><a href="#2零拷贝" class="table-of-contents__link toc-highlight">2、零拷贝</a></li><li><a href="#小总结" class="table-of-contents__link toc-highlight">小总结</a></li></ul></li><li><a href="#顺序写" class="table-of-contents__link toc-highlight">顺序写</a></li><li><a href="#高效的数据存储结构" class="table-of-contents__link toc-highlight">高效的数据存储结构</a><ul><li><a href="#topic和队列的关系" class="table-of-contents__link toc-highlight">Topic和队列的关系</a></li></ul></li><li><a href="#异步处理" class="table-of-contents__link toc-highlight">异步处理</a><ul><li><a href="#异步刷盘" class="table-of-contents__link toc-highlight">异步刷盘</a></li><li><a href="#异步主从复制" class="table-of-contents__link toc-highlight">异步主从复制</a></li><li><a href="#小总结-1" class="table-of-contents__link toc-highlight">小总结</a></li></ul></li><li><a href="#批量处理" class="table-of-contents__link toc-highlight">批量处理</a></li><li><a href="#锁优化" class="table-of-contents__link toc-highlight">锁优化</a></li><li><a href="#线程池隔离" class="table-of-contents__link toc-highlight">线程池隔离</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考：</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/guide/">Torch</a></li><li class="footer__item"><a class="footer__link-item" href="/middleware/">Middleware</a></li><li class="footer__item"><a class="footer__link-item" href="/electron/">Electron</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lorchr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/diy/">DIY</a></li><li class="footer__item"><a href="https://github.com/lorchr/light-docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Offical</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docusaurus.io/docs/playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Light-Docusaurus, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>